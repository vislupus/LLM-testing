<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaotic Solar System with Spacecraft Mission</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #ccc;
            font-family: 'Segoe UI', sans-serif;
        }
        #container {
            position: relative;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            font-size: 13px;
            max-width: 220px;
            line-height: 1.6;
        }
        #info h3 {
            color: #ffcc00;
            margin-bottom: 8px;
        }
        #info .key {
            background: #444;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        #status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 14px;
        }
        #status .phase {
            color: #00ff88;
            font-weight: bold;
        }
        #legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <div id="info">
            <h3>ðŸš€ Spacecraft Mission</h3>
            <p>Press <span class="key">SPACE</span> to launch</p>
            <p>Press <span class="key">T</span> for thrust boost</p>
            <p>Click canvas to add thrust toward cursor</p>
            <p>Press <span class="key">R</span> to reset</p>
        </div>
        <div id="status">
            Phase: <span class="phase" id="phaseText">Docked on Earth</span>
        </div>
        <div id="legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: #ffdd44;"></div>
                <span>Sun</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #4488ff;"></div>
                <span>Earth</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #dd9955;"></div>
                <span>Jupiter</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #ff4466;"></div>
                <span>Spacecraft</span>
            </div>
        </div>
    </div>

    <script>
        let sun, earth, jupiter, spacecraft;
        let bodies = [];
        let trailLayer;
        let G = 800;
        let launched = false;
        let missionPhase = 0;
        let sunLoopComplete = false;
        let reachedJupiter = false;
        let minSunDist = Infinity;
        let centerX, centerY;
        let time = 0;

        class CelestialBody {
            constructor(x, y, vx, vy, mass, radius, col, name) {
                this.pos = createVector(x, y);
                this.vel = createVector(vx, vy);
                this.acc = createVector(0, 0);
                this.mass = mass;
                this.radius = radius;
                this.col = col;
                this.name = name;
                this.prevPos = createVector(x, y);
            }

            applyForce(force) {
                let f = p5.Vector.div(force, this.mass);
                this.acc.add(f);
            }

            gravitationalForce(other, softening = 20) {
                let force = p5.Vector.sub(this.pos, other.pos);
                let distSq = force.magSq();
                distSq = max(distSq, softening * softening);
                let strength = (G * this.mass * other.mass) / distSq;
                force.setMag(-strength);
                return force;
            }

            update(dt) {
                this.prevPos = this.pos.copy();
                
                // Velocity Verlet integration for better energy conservation
                let halfVel = p5.Vector.add(this.vel, p5.Vector.mult(this.acc, dt * 0.5));
                this.pos.add(p5.Vector.mult(halfVel, dt));
                this.vel.add(p5.Vector.mult(this.acc, dt));
                this.acc.mult(0);
            }

            drawTrail(layer) {
                layer.stroke(red(this.col), green(this.col), blue(this.col), 200);
                layer.strokeWeight(this.name === "Spacecraft" ? 1.5 : 2.5);
                layer.line(this.prevPos.x, this.prevPos.y, this.pos.x, this.pos.y);
            }

            draw() {
                noStroke();
                fill(this.col);
                ellipse(this.pos.x, this.pos.y, this.radius * 2, this.radius * 2);
            }
        }

        function setup() {
            let canvas = createCanvas(900, 900);
            canvas.parent('container');
            canvas.id('canvas');
            
            centerX = width / 2;
            centerY = height / 2;
            
            trailLayer = createGraphics(width, height);
            trailLayer.background(220);
            
            initializeSystem();
        }

        function initializeSystem() {
            // Reset state
            launched = false;
            missionPhase = 0;
            sunLoopComplete = false;
            reachedJupiter = false;
            minSunDist = Infinity;
            time = 0;
            
            trailLayer.background(220);
            
            // Sun - massive, slightly off-center for asymmetry
            sun = new CelestialBody(
                centerX, centerY,
                0, 0,
                5000, 28,
                color(255, 221, 68),
                "Sun"
            );

            // Earth - inner orbit with some eccentricity
            // Orbital velocity for roughly circular orbit: v = sqrt(G * M / r)
            let earthDist = 160;
            let earthOrbitalSpeed = sqrt(G * sun.mass / earthDist);
            // Add perturbation for chaotic behavior
            earth = new CelestialBody(
                centerX + earthDist, centerY + 15,
                0.8, -earthOrbitalSpeed * 0.92,
                80, 14,
                color(68, 136, 255),
                "Earth"
            );

            // Jupiter - outer orbit, significant mass for 3-body chaos
            let jupiterDist = 340;
            let jupiterAngle = PI * 0.7;
            let jupiterOrbitalSpeed = sqrt(G * sun.mass / jupiterDist);
            jupiter = new CelestialBody(
                centerX + cos(jupiterAngle) * jupiterDist,
                centerY + sin(jupiterAngle) * jupiterDist,
                sin(jupiterAngle) * jupiterOrbitalSpeed * 0.88,
                -cos(jupiterAngle) * jupiterOrbitalSpeed * 0.88,
                800, 24,
                color(221, 153, 85),
                "Jupiter"
            );

            bodies = [sun, earth, jupiter];

            // Calculate center of mass velocity and adjust to keep system bounded
            let totalMass = sun.mass + earth.mass + jupiter.mass;
            let comVel = createVector(0, 0);
            for (let body of bodies) {
                comVel.add(p5.Vector.mult(body.vel, body.mass));
            }
            comVel.div(totalMass);
            
            // Subtract COM velocity to keep system centered
            for (let body of bodies) {
                body.vel.sub(comVel);
            }

            // Spacecraft starts docked with Earth
            spacecraft = new CelestialBody(
                earth.pos.x + earth.radius + 8,
                earth.pos.y,
                earth.vel.x,
                earth.vel.y,
                0.5, 5,
                color(255, 68, 102),
                "Spacecraft"
            );
            
            updatePhaseText();
        }

        function updatePhaseText() {
            let text = "Docked on Earth";
            if (launched) {
                if (reachedJupiter) {
                    text = "âœ“ Jupiter Reached!";
                } else if (sunLoopComplete) {
                    text = "En Route to Jupiter";
                } else {
                    text = "Solar Loop Maneuver";
                }
            }
            document.getElementById('phaseText').textContent = text;
        }

        function draw() {
            let dt = 0.012;
            let substeps = 8;
            
            for (let step = 0; step < substeps; step++) {
                // Calculate forces between all celestial bodies
                for (let i = 0; i < bodies.length; i++) {
                    for (let j = i + 1; j < bodies.length; j++) {
                        let force = bodies[i].gravitationalForce(bodies[j], 25);
                        bodies[i].applyForce(force);
                        bodies[j].applyForce(p5.Vector.mult(force, -1));
                    }
                }

                // Update celestial bodies
                for (let body of bodies) {
                    body.update(dt);
                }

                // Spacecraft physics
                if (launched) {
                    // Gravity from all bodies affects spacecraft
                    for (let body of bodies) {
                        let force = spacecraft.gravitationalForce(body, 15);
                        spacecraft.applyForce(force);
                    }
                    spacecraft.update(dt);
                    
                    // Track mission progress
                    let sunDist = p5.Vector.dist(spacecraft.pos, sun.pos);
                    if (sunDist < minSunDist) {
                        minSunDist = sunDist;
                    }
                    
                    // Check if sun loop complete (perihelion passed and moving away)
                    if (!sunLoopComplete && minSunDist < 100 && sunDist > minSunDist + 30) {
                        sunLoopComplete = true;
                        updatePhaseText();
                    }
                    
                    // Check if reached Jupiter
                    let jupiterDist = p5.Vector.dist(spacecraft.pos, jupiter.pos);
                    if (!reachedJupiter && sunLoopComplete && jupiterDist < jupiter.radius + 20) {
                        reachedJupiter = true;
                        updatePhaseText();
                    }
                    
                } else {
                    // Spacecraft docked to Earth
                    let offset = p5.Vector.sub(spacecraft.pos, earth.prevPos);
                    offset.normalize().mult(earth.radius + 8);
                    spacecraft.pos = p5.Vector.add(earth.pos, offset);
                    spacecraft.vel = earth.vel.copy();
                    spacecraft.prevPos = p5.Vector.add(earth.prevPos, offset);
                }

                // Keep center of mass roughly centered
                let com = createVector(0, 0);
                let totalMass = 0;
                for (let body of bodies) {
                    com.add(p5.Vector.mult(body.pos, body.mass));
                    totalMass += body.mass;
                }
                com.div(totalMass);
                
                let correction = p5.Vector.sub(createVector(centerX, centerY), com);
                correction.mult(0.001);
                for (let body of bodies) {
                    body.pos.add(correction);
                }
                if (launched) {
                    spacecraft.pos.add(correction);
                }
            }

            // Draw trails to persistent layer
            trailLayer.noStroke();
            trailLayer.fill(220, 3);
            trailLayer.rect(0, 0, width, height);
            
            for (let body of bodies) {
                body.drawTrail(trailLayer);
            }
            if (launched) {
                spacecraft.drawTrail(trailLayer);
            }

            // Render scene
            image(trailLayer, 0, 0);

            // Draw Sun with glow effect
            noStroke();
            for (let i = 6; i > 0; i--) {
                fill(255, 200, 50, 30);
                ellipse(sun.pos.x, sun.pos.y, sun.radius * 2 + i * 18, sun.radius * 2 + i * 18);
            }
            
            // Draw all bodies
            for (let body of bodies) {
                body.draw();
            }

            // Draw spacecraft with engine glow when thrusting
            noStroke();
            if (launched) {
                // Engine glow
                for (let i = 3; i > 0; i--) {
                    fill(255, 100, 50, 40);
                    ellipse(spacecraft.pos.x, spacecraft.pos.y, spacecraft.radius * 2 + i * 6);
                }
            }
            fill(spacecraft.col);
            ellipse(spacecraft.pos.x, spacecraft.pos.y, spacecraft.radius * 2);

            // Draw velocity vectors (small indicators)
            if (launched) {
                stroke(255, 100, 100, 150);
                strokeWeight(2);
                let velScale = 3;
                line(
                    spacecraft.pos.x, spacecraft.pos.y,
                    spacecraft.pos.x + spacecraft.vel.x * velScale,
                    spacecraft.pos.y + spacecraft.vel.y * velScale
                );
            }

            // Mission guidance arrows
            if (launched && !reachedJupiter) {
                let target = sunLoopComplete ? jupiter : sun;
                let toTarget = p5.Vector.sub(target.pos, spacecraft.pos);
                let dist = toTarget.mag();
                toTarget.normalize();
                
                // Draw guidance indicator
                noFill();
                stroke(sunLoopComplete ? color(221, 153, 85, 150) : color(255, 221, 68, 150));
                strokeWeight(2);
                let arrowStart = p5.Vector.add(spacecraft.pos, p5.Vector.mult(toTarget, 20));
                let arrowEnd = p5.Vector.add(spacecraft.pos, p5.Vector.mult(toTarget, 40));
                line(arrowStart.x, arrowStart.y, arrowEnd.x, arrowEnd.y);
            }

            time += dt * substeps;
        }

        function launchSpacecraft() {
            if (launched) return;
            
            launched = true;
            missionPhase = 1;
            minSunDist = Infinity;
            
            // Calculate launch velocity for sun-grazing trajectory
            let toSun = p5.Vector.sub(sun.pos, spacecraft.pos);
            toSun.normalize();
            
            // Add velocity component toward sun
            let launchBoost = createVector(toSun.x, toSun.y);
            launchBoost.mult(12);
            
            // Add perpendicular component for angular momentum (to avoid direct collision)
            let perpendicular = createVector(-toSun.y, toSun.x);
            perpendicular.mult(6);
            
            spacecraft.vel.add(launchBoost);
            spacecraft.vel.add(perpendicular);
            
            updatePhaseText();
        }

        function applyThrust(direction, amount) {
            if (!launched) return;
            direction.normalize();
            direction.mult(amount);
            spacecraft.vel.add(direction);
        }

        function keyPressed() {
            if (key === ' ' || key === ' ') {
                launchSpacecraft();
            } else if (key === 'r' || key === 'R') {
                initializeSystem();
            } else if (key === 't' || key === 'T') {
                if (launched) {
                    // Thrust toward current mission target
                    let target = sunLoopComplete ? jupiter : sun;
                    let toTarget = p5.Vector.sub(target.pos, spacecraft.pos);
                    applyThrust(toTarget, 2);
                }
            }
            return false;
        }

        function mousePressed() {
            if (launched) {
                let toMouse = createVector(mouseX - spacecraft.pos.x, mouseY - spacecraft.pos.y);
                applyThrust(toMouse, 1.5);
            }
        }

        function windowResized() {
            // Keep canvas size fixed for consistent physics
        }
    </script>
</body>
</html>