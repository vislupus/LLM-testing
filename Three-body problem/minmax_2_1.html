<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Body Gravitational System Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #1a1a2e;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #simulation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        #canvas-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.75);
            padding: 15px 20px;
            border-radius: 12px;
            color: #fff;
            font-size: 0.85rem;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 280px;
        }

        .info-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #f7b731;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(247, 183, 49, 0.3);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 4px 0;
        }

        .info-label {
            color: #aaa;
        }

        .info-value {
            font-weight: bold;
        }

        .sun-value { color: #f7b731; }
        .earth-value { color: #4ecdc4; }
        .jupiter-value { color: #e94560; }
        .craft-value { color: #9b59b6; }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            padding: 12px 25px;
            border-radius: 30px;
            color: #fff;
            font-size: 0.8rem;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-label {
            color: #aaa;
        }

        .speed-slider {
            width: 100px;
            cursor: pointer;
        }

        .legend {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.75);
            padding: 15px 20px;
            border-radius: 12px;
            color: #fff;
            font-size: 0.85rem;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legend-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4ecdc4;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .mission-phase {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 20px 40px;
            border-radius: 15px;
            color: #fff;
            font-size: 1.3rem;
            font-weight: bold;
            z-index: 200;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease;
            border: 2px solid #f7b731;
        }

        .mission-phase.show {
            opacity: 1;
        }

        .phase-subtitle {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 8px;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div id="simulation-container">
        <div id="canvas-container"></div>
    </div>

    <!-- Info Panel -->
    <div class="info-panel">
        <div class="info-title">ðŸš€ Gravitational System</div>
        <div class="info-item">
            <span class="info-label">Sun Mass</span>
            <span class="info-value sun-value" id="sun-mass">1000</span>
        </div>
        <div class="info-item">
            <span class="info-label">Earth Mass</span>
            <span class="info-value earth-value" id="earth-mass">50</span>
        </div>
        <div class="info-item">
            <span class="info-label">Jupiter Mass</span>
            <span class="info-value jupiter-value" id="jupiter-mass">300</span>
        </div>
        <div class="info-item">
            <span class="info-label">Craft Phase</span>
            <span class="info-value craft-value" id="craft-phase">Earth Orbit</span>
        </div>
        <div class="info-item">
            <span class="info-label">Time Scale</span>
            <span class="info-value" id="time-scale">1.0x</span>
        </div>
        <div class="info-item">
            <span class="info-label">Total Energy</span>
            <span class="info-value" id="total-energy">-</span>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-title">Celestial Bodies</div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f7b731;"></div>
            <span>Sun</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #4ecdc4;"></div>
            <span>Earth</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #e94560;"></div>
            <span>Jupiter</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #9b59b6;"></div>
            <span>Spacecraft</span>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="control-group">
            <span class="control-label">Speed:</span>
            <input type="range" class="speed-slider" id="speedSlider" min="0.1" max="3" step="0.1" value="1">
            <span id="speedValue">1.0x</span>
        </div>
        <div class="control-group">
            <span class="control-label">Trails:</span>
            <input type="range" class="speed-slider" id="trailSlider" min="50" max="500" step="50" value="200">
            <span id="trailValue">200</span>
        </div>
        <button onclick="resetSimulation()" style="padding: 8px 16px; border: none; border-radius: 8px; background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; cursor: pointer; font-weight: bold;">Reset</button>
    </div>

    <!-- Mission Phase Display -->
    <div class="mission-phase" id="missionPhase">
        <span id="phaseTitle">Mission Phase</span>
        <div class="phase-subtitle" id="phaseSubtitle"></div>
    </div>

    <!-- p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            canvas: {
                width: 1000,
                height: 800,
                bg: 220
            },
            gravitationalConstant: 0.5,
            softening: 5, // Softening parameter to prevent singularities
            timeStep: 0.5,
            trailLength: 200,
            spacecraft: {
                thrustPower: 0.008,
                maneuverThreshold: 0.3 // Distance from Earth to depart
            }
        };

        // ==================== CELESTIAL BODY CLASS ====================
        class CelestialBody {
            constructor(x, y, vx, vy, mass, radius, color, name, isFixed = false) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.mass = mass;
                this.radius = radius;
                this.color = color;
                this.name = name;
                this.isFixed = isFixed;
                this.trail = [];
                this.ax = 0;
                this.ay = 0;
            }

            applyForce(fx, fy) {
                if (this.isFixed) return;
                this.ax += fx / this.mass;
                this.ay += fy / this.mass;
            }

            update(dt) {
                if (this.isFixed) return;
                this.vx += this.ax * dt;
                this.vy += this.ay * dt;
                this.x += this.vx * dt;
                this.y += this.vy * dt;
                this.ax = 0;
                this.ay = 0;

                // Store trail
                this.trail.push({ x: this.x, y: this.y });
                if (this.trail.length > CONFIG.trailLength) {
                    this.trail.shift();
                }
            }

            draw() {
                noStroke();

                // Draw trail
                for (let i = 0; i < this.trail.length - 1; i++) {
                    const alpha = map(i, 0, this.trail.length - 1, 0, 150);
                    const size = map(i, 0, this.trail.length - 1, 1, this.radius * 0.8);
                    fill(red(this.color), green(this.color), blue(this.color), alpha);
                    ellipse(this.trail[i].x, this.trail[i].y, size, size);
                }

                // Draw body with glow
                for (let r = this.radius * 3; r > this.radius; r -= 2) {
                    const alpha = map(r, this.radius, this.radius * 3, 100, 0);
                    fill(red(this.color), green(this.color), blue(this.color), alpha);
                    ellipse(this.x, this.y, r * 2, r * 2);
                }

                // Draw body
                fill(this.color);
                ellipse(this.x, this.y, this.radius * 2, this.radius * 2);

                // Draw highlight
                fill(255, 255, 255, 80);
                ellipse(this.x - this.radius * 0.3, this.y - this.radius * 0.3, this.radius * 0.6, this.radius * 0.6);
            }

            calculateGravitationalForce(other) {
                const dx = other.x - this.x;
                const dy = other.y - this.y;
                const distSq = dx * dx + dy * dy + CONFIG.softening * CONFIG.softening;
                const dist = Math.sqrt(distSq);
                const force = (CONFIG.gravitationalConstant * this.mass * other.mass) / distSq;

                const fx = force * (dx / dist);
                const fy = force * (dy / dist);

                return { fx, fy, dist };
            }

            keepInBounds() {
                const margin = 50;
                const centerX = CONFIG.canvas.width / 2;
                const centerY = CONFIG.canvas.height / 2;
                const maxDist = Math.min(CONFIG.canvas.width, CONFIG.canvas.height) / 2 - margin;

                const dx = this.x - centerX;
                const dy = this.y - centerY;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist > maxDist) {
                    const angle = Math.atan2(dy, dx);
                    this.x = centerX + Math.cos(angle) * maxDist;
                    this.y = centerY + Math.sin(angle) * maxDist;
                    // Reverse velocity component
                    const dot = this.vx * Math.cos(angle) + this.vy * Math.sin(angle);
                    if (dot > 0) {
                        this.vx -= 2 * dot * Math.cos(angle);
                        this.vy -= 2 * dot * Math.sin(angle);
                    }
                }
            }
        }

        // ==================== SPACECRAFT CLASS ====================
        class Spacecraft extends CelestialBody {
            constructor(x, y, vx, vy, mass, radius, color, name) {
                super(x, y, vx, vy, mass, radius, color, name);
                this.phase = 'earth_orbit';
                this.thrustDirection = 0;
                this.thrustActive = false;
                this.targetPlanet = null;
                this.departureTime = 0;
                this.cruiseTime = 0;
                this.arrivalTime = 0;
            }

            draw() {
                noStroke();

                // Draw trail with different style
                for (let i = 0; i < this.trail.length - 1; i++) {
                    const alpha = map(i, 0, this.trail.length - 1, 20, 180);
                    const size = map(i, 0, this.trail.length - 1, 1, 4);
                    fill(155, 89, 182, alpha);
                    ellipse(this.trail[i].x, this.trail[i].y, size, size);
                }

                // Draw thrust flame if active
                if (this.thrustActive) {
                    for (let r = this.radius * 4; r > this.radius; r -= 3) {
                        const alpha = map(r, this.radius, this.radius * 4, 150, 0);
                        fill(255, 150, 50, alpha);
                        const flameAngle = this.thrustDirection + Math.PI;
                        const fx = this.x + Math.cos(flameAngle) * this.radius;
                        const fy = this.y + Math.sin(flameAngle) * this.radius;
                        ellipse(fx, fy, r, r);
                    }
                }

                // Draw body
                fill(this.color);
                ellipse(this.x, this.y, this.radius * 2, this.radius * 2);

                // Draw direction indicator
                stroke(255, 255, 255, 150);
                strokeWeight(2);
                const dirLen = this.radius * 2.5;
                line(
                    this.x,
                    this.y,
                    this.x + Math.cos(this.thrustDirection) * dirLen,
                    this.y + Math.sin(this.thrustDirection) * dirLen
                );
                noStroke();

                // Draw mission phase indicator
                const phaseColors = {
                    'earth_orbit': color(78, 205, 196),
                    'sun_loop': color(247, 183, 49),
                    'cruise': color(233, 69, 96),
                    'jupiter_approach': color(155, 89, 182),
                    'arrived': color(46, 204, 113)
                };
                fill(phaseColors[this.phase] || color(255));
                ellipse(this.x + this.radius * 1.5, this.y - this.radius * 1.5, 8, 8);
            }

            calculateMissionControl(bodies) {
                const earth = bodies.find(b => b.name === 'Earth');
                const jupiter = bodies.find(b => b.name === 'Jupiter');
                const sun = bodies.find(b => b.name === 'Sun');

                if (!earth || !jupiter || !sun) return;

                const distToEarth = Math.sqrt(
                    Math.pow(this.x - earth.x, 2) + Math.pow(this.y - earth.y, 2)
                );
                const distToJupiter = Math.sqrt(
                    Math.pow(this.x - jupiter.x, 2) + Math.pow(this.y - jupiter.y, 2)
                );
                const distToSun = Math.sqrt(
                    Math.pow(this.x - sun.x, 2) + Math.pow(this.y - sun.y, 2)
                );

                // Mission state machine
                switch (this.phase) {
                    case 'earth_orbit':
                        this.thrustActive = false;

                        // Depart when aligned properly
                        if (distToEarth < CONFIG.spacecraft.maneuverThreshold * 20) {
                            this.phase = 'sun_loop';
                            showMissionPhase('Solar Loop', 'Departing Earth orbit...');
                            this.departureTime = frameCount;
                        }
                        break;

                    case 'sun_loop':
                        // Complete one loop around the Sun
                        const angleFromSun = Math.atan2(this.y - sun.y, this.x - sun.x);
                        const prevAngle = this.trail.length > 1 ?
                            Math.atan2(this.trail[this.trail.length - 2].y - sun.y, this.trail[this.trail.length - 2].x - sun.x) :
                            angleFromSun;

                        // Check if we've completed roughly half an orbit
                        if (frameCount - this.departureTime > 150) {
                            this.phase = 'cruise';
                            showMissionPhase('Cruise Phase', 'Heading to Jupiter...');
                            this.cruiseTime = frameCount;
                        }

                        // Apply thrust to stay in controlled loop
                        this.thrustActive = false;
                        break;

                    case 'cruise':
                        // Aim for Jupiter
                        const dx = jupiter.x - this.x;
                        const dy = jupiter.y - this.y;
                        const targetAngle = Math.atan2(dy, dx);

                        // Calculate interception point
                        const timeToJupiter = distToJupiter / 5;
                        const predX = jupiter.x + jupiter.vx * timeToJupiter * 10;
                        const predY = jupiter.y + jupiter.vy * timeToJupiter * 10;

                        const interceptAngle = Math.atan2(predY - this.y, predX - this.x);

                        // Apply gentle thrust towards intercept
                        if (distToJupiter > 100) {
                            this.thrustDirection = interceptAngle;
                            this.thrustActive = frameCount % 10 < 5; // Pulsed thrust
                        }

                        if (distToJupiter < 80) {
                            this.phase = 'jupiter_approach';
                            showMissionPhase('Jupiter Approach', 'Final approach to Jupiter...');
                        }
                        break;

                    case 'jupiter_approach':
                        // Match Jupiter's velocity and enter orbit
                        const jupiterVx = jupiter.vx;
                        const jupiterVy = jupiter.vy;

                        // Gradually match velocity
                        if (distToJupiter < 40) {
                            // Slow down to match Jupiter
                            this.thrustDirection = Math.atan2(jupiterVy - this.vy, jupiterVx - this.vx);
                            this.thrustActive = true;

                            if (distToJupiter < 25 && Math.abs(this.vx - jupiterVx) < 0.3 && Math.abs(this.vy - jupiterVy) < 0.3) {
                                this.phase = 'arrived';
                                showMissionPhase('Arrived!', 'Successfully reached Jupiter orbit');
                            }
                        } else {
                            this.thrustDirection = Math.atan2(jupiter.y - this.y, jupiter.x - this.x);
                            this.thrustActive = false;
                        }
                        break;

                    case 'arrived':
                        this.thrustActive = false;
                        // Enter Jupiter orbit
                        this.targetPlanet = jupiter;
                        break;
                }

                // Apply thrust if active
                if (this.thrustActive) {
                    this.vx += Math.cos(this.thrustDirection) * CONFIG.spacecraft.thrustPower;
                    this.vy += Math.sin(this.thrustDirection) * CONFIG.spacecraft.thrustPower;
                }
            }
        }

        // ==================== SIMULATION STATE ====================
        let bodies = [];
        let spacecraft;
        let speedMultiplier = 1;
        let trailLength = 200;

        // ==================== P5.JS SETUP ====================
        function setup() {
            const canvas = createCanvas(CONFIG.canvas.width, CONFIG.canvas.height);
            canvas.parent('canvas-container');

            initializeSimulation();
            setupControls();
        }

        function initializeSimulation() {
            bodies = [];
            const centerX = CONFIG.canvas.width / 2;
            const centerY = CONFIG.canvas.height / 2;

            // Sun - massive and relatively fixed
            const sun = new CelestialBody(
                centerX,
                centerY,
                0,
                0,
                1000, // Mass
                35,
                color(247, 183, 49),
                'Sun',
                true
            );
            bodies.push(sun);

            // Earth - chaotic orbit
            const earth = new CelestialBody(
                centerX + 180,
                centerY,
                0,
                1.8, // Initial velocity for elliptical orbit
                50,
                12,
                color(78, 205, 196),
                'Earth'
            );
            bodies.push(earth);

            // Jupiter - large mass, elliptical orbit
            const jupiter = new CelestialBody(
                centerX + 320,
                centerY + 80,
                0,
                1.2,
                300,
                22,
                color(233, 69, 96),
                'Jupiter'
            );
            bodies.push(jupiter);

            // Spacecraft - starts on Earth
            spacecraft = new Spacecraft(
                earth.x + 25,
                earth.y,
                earth.vx + 0.5,
                earth.vy,
                1,
                6,
                color(155, 89, 182),
                'Spacecraft'
            );
            bodies.push(spacecraft);

            updateInfoPanel();
        }

        function setupControls() {
            document.getElementById('speedSlider').addEventListener('input', (e) => {
                speedMultiplier = parseFloat(e.target.value);
                document.getElementById('speedValue').textContent = speedMultiplier.toFixed(1) + 'x';
                document.getElementById('time-scale').textContent = speedMultiplier.toFixed(1) + 'x';
            });

            document.getElementById('trailSlider').addEventListener('input', (e) => {
                trailLength = parseInt(e.target.value);
                document.getElementById('trailValue').textContent = trailLength;
            });
        }

        // ==================== P5.JS DRAW ====================
        function draw() {
            background(220);

            // Physics simulation
            for (let step = 0; step < speedMultiplier; step++) {
                // Calculate gravitational forces
                for (let i = 0; i < bodies.length; i++) {
                    for (let j = i + 1; j < bodies.length; j++) {
                        const force = bodies[i].calculateGravitationalForce(bodies[j]);
                        bodies[i].applyForce(-force.fx, -force.fy);
                        bodies[j].applyForce(force.fx, force.fy);
                    }
                }

                // Update spacecraft mission control
                spacecraft.calculateMissionControl(bodies);

                // Update positions
                for (const body of bodies) {
                    body.update(CONFIG.timeStep);
                    body.keepInBounds();
                }
            }

            // Draw everything
            for (const body of bodies) {
                body.draw();
            }

            // Draw velocity vectors for major bodies
            drawVelocityVectors();

            // Update info panel
            updateInfoPanel();
        }

        function drawVelocityVectors() {
            for (const body of bodies) {
                if (body.name === 'Sun') continue;

                const vx = body.vx * 20;
                const vy = body.vy * 20;

                stroke(100, 100, 100, 100);
                strokeWeight(1);
                line(body.x, body.y, body.x + vx, body.y + vy);

                // Arrowhead
                const angle = Math.atan2(vy, vx);
                const arrowSize = 5;
                line(body.x + vx, body.y + vy,
                     body.x + vx - arrowSize * Math.cos(angle - 0.5),
                     body.y + vy - arrowSize * Math.sin(angle - 0.5));
                line(body.x + vx, body.y + vy,
                     body.x + vx - arrowSize * Math.cos(angle + 0.5),
                     body.y + vy - arrowSize * Math.sin(angle + 0.5));
            }
        }

        function updateInfoPanel() {
            document.getElementById('sun-mass').textContent = bodies.find(b => b.name === 'Sun')?.mass.toFixed(0) || '-';
            document.getElementById('earth-mass').textContent = bodies.find(b => b.name === 'Earth')?.mass.toFixed(0) || '-';
            document.getElementById('jupiter-mass').textContent = bodies.find(b => b.name === 'Jupiter')?.mass.toFixed(0) || '-';
            document.getElementById('craft-phase').textContent = formatPhase(spacecraft?.phase || 'earth_orbit');

            // Calculate total energy
            let totalEnergy = 0;
            for (const body of bodies) {
                if (body.name === 'Sun') continue;
                // Kinetic energy
                const KE = 0.5 * body.mass * (body.vx * body.vx + body.vy * body.vy);
                // Potential energy
                const sun = bodies.find(b => b.name === 'Sun');
                if (sun) {
                    const dist = Math.sqrt(Math.pow(body.x - sun.x, 2) + Math.pow(body.y - sun.y, 2));
                    const PE = -CONFIG.gravitationalConstant * body.mass * sun.mass / dist;
                    totalEnergy += KE + PE;
                }
            }
            document.getElementById('total-energy').textContent = totalEnergy.toFixed(1);
        }

        function formatPhase(phase) {
            const phases = {
                'earth_orbit': 'Earth Orbit',
                'sun_loop': 'Solar Loop',
                'cruise': 'Cruise',
                'jupiter_approach': 'Jupiter Approach',
                'arrived': 'Jupiter Orbit'
            };
            return phases[phase] || phase;
        }

        let phaseTimeout;
        function showMissionPhase(title, subtitle) {
            const phaseEl = document.getElementById('missionPhase');
            document.getElementById('phaseTitle').textContent = title;
            document.getElementById('phaseSubtitle').textContent = subtitle;
            phaseEl.classList.add('show');

            clearTimeout(phaseTimeout);
            phaseTimeout = setTimeout(() => {
                phaseEl.classList.remove('show');
            }, 3000);
        }

        function resetSimulation() {
            initializeSimulation();
            showMissionPhase('Simulation Reset', 'Starting new simulation...');
        }

        // Keyboard controls
        function keyPressed() {
            if (key === 'r' || key === 'R') {
                resetSimulation();
            }
            if (key === ' ') {
                noLoop();
            }
        }

        function keyReleased() {
            if (key === ' ') {
                loop();
            }
        }
    </script>
</body>
</html>
