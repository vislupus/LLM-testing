<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaotic Multi-Body Gravitational System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #dcdcdc;
        }
        canvas { display: block; }
    </style>
</head>
<body>
<script>
// Gravitational Bodies
let sun, earth, jupiter, spacecraft;
let bodies = [];

// Physics constants (scaled for visualization)
const G = 0.8;
const SOFTENING = 15;
const SUBSTEPS = 4;

// Simulation state
let time = 0;
let missionPhase = 0;

class Body {
    constructor(x, y, vx, vy, mass, radius, color, name) {
        this.pos = createVector(x, y);
        this.vel = createVector(vx, vy);
        this.acc = createVector(0, 0);
        this.mass = mass;
        this.radius = radius;
        this.color = color;
        this.name = name;
        this.trail = [];
        this.maxTrailLength = name === "Spacecraft" ? 2000 : 1200;
    }

    applyForce(force) {
        let f = p5.Vector.div(force, this.mass);
        this.acc.add(f);
    }

    update(dt) {
        this.vel.add(p5.Vector.mult(this.acc, dt));
        this.pos.add(p5.Vector.mult(this.vel, dt));
        this.acc.mult(0);

        // Record trail positions (less frequently for performance)
        if (frameCount % 2 === 0) {
            this.trail.push(this.pos.copy());
            if (this.trail.length > this.maxTrailLength) {
                this.trail.shift();
            }
        }
    }

    display() {
        noStroke();
        
        // Draw orbital trail
        for (let i = 0; i < this.trail.length - 1; i++) {
            let alpha = map(i, 0, this.trail.length - 1, 0, 120);
            fill(this.color[0], this.color[1], this.color[2], alpha);
            let size = map(i, 0, this.trail.length - 1, 0.8, 2);
            circle(this.trail[i].x, this.trail[i].y, size);
        }

        // Draw glow effect
        fill(this.color[0], this.color[1], this.color[2], 60);
        circle(this.pos.x, this.pos.y, this.radius * 3);
        
        fill(this.color[0], this.color[1], this.color[2], 120);
        circle(this.pos.x, this.pos.y, this.radius * 2.2);

        // Draw main body
        fill(this.color);
        circle(this.pos.x, this.pos.y, this.radius * 2);
    }

    attractTo(other) {
        let force = p5.Vector.sub(other.pos, this.pos);
        let distance = force.mag();
        
        // Apply softening to prevent singularities
        distance = constrain(distance, SOFTENING, 10000);
        
        let strength = (G * this.mass * other.mass) / (distance * distance);
        force.setMag(strength);
        
        return force;
    }
}

function setup() {
    createCanvas(windowWidth, windowHeight);
    
    let cx = width / 2;
    let cy = height / 2;

    // Sun - not at perfect center, allowing chaotic dynamics
    sun = new Body(
        cx + 20, 
        cy - 10, 
        0.05, 
        -0.08, 
        800, 
        28, 
        [255, 235, 130], 
        "Sun"
    );

    // Earth - massive compared to reality, eccentric orbit
    let earthDist = 200;
    let earthAngle = PI * 0.2;
    let earthSpeed = 2.6; // Not perfectly circular
    earth = new Body(
        cx + cos(earthAngle) * earthDist,
        cy + sin(earthAngle) * earthDist,
        cos(earthAngle + PI/2) * earthSpeed * 0.9,
        sin(earthAngle + PI/2) * earthSpeed * 1.1, // Eccentric
        35, // Very massive for chaotic interactions
        12,
        [90, 150, 255],
        "Earth"
    );

    // Jupiter - very massive, positioned for perturbations
    let jupiterDist = 340;
    let jupiterAngle = PI * 1.4;
    let jupiterSpeed = 1.5;
    jupiter = new Body(
        cx + cos(jupiterAngle) * jupiterDist,
        cy + sin(jupiterAngle) * jupiterDist,
        cos(jupiterAngle + PI/2) * jupiterSpeed * 1.15,
        sin(jupiterAngle + PI/2) * jupiterSpeed * 0.85, // Eccentric
        95, // Extremely massive for chaotic dynamics
        20,
        [245, 200, 160],
        "Jupiter"
    );

    // Spacecraft starts at Earth's position with Earth's velocity
    spacecraft = new Body(
        earth.pos.x,
        earth.pos.y,
        earth.vel.x,
        earth.vel.y,
        0.05, // Negligible mass
        5,
        [255, 90, 90],
        "Spacecraft"
    );

    bodies = [sun, earth, jupiter, spacecraft];
    background(220);
}

function draw() {
    // Persistent trail effect with semi-transparent overlay
    fill(220, 220, 220, 28);
    noStroke();
    rect(0, 0, width, height);

    time++;

    // Spacecraft mission sequence
    executeSpacecraftManeuvers();

    // Physics simulation with sub-stepping for stability
    for (let step = 0; step < SUBSTEPS; step++) {
        let dt = 1.0 / SUBSTEPS;
        
        // Calculate gravitational forces between all bodies
        for (let i = 0; i < bodies.length; i++) {
            for (let j = i + 1; j < bodies.length; j++) {
                let force = bodies[i].attractTo(bodies[j]);
                bodies[i].applyForce(force);
                bodies[j].applyForce(p5.Vector.mult(force, -1));
            }
        }

        // Update all positions and velocities
        for (let body of bodies) {
            body.update(dt);
        }
    }

    // Keep system centered on canvas (prevent drift)
    maintainSystemBounds();

    // Render all celestial bodies
    for (let body of bodies) {
        body.display();
    }

    // Draw labels
    drawLabels();

    // Display simulation info
    displayInfo();
}

function executeSpacecraftManeuvers() {
    // Phase 1: Depart Earth and loop around Sun
    if (time === 180 && missionPhase === 0) {
        let toSun = p5.Vector.sub(sun.pos, spacecraft.pos);
        toSun.normalize();
        
        // Add retrograde component for inner orbit
        let perpendicular = createVector(-toSun.y, toSun.x);
        let deltaV = p5.Vector.add(p5.Vector.mult(toSun, 1.8), p5.Vector.mult(perpendicular, -0.5));
        
        spacecraft.vel.add(deltaV);
        missionPhase = 1;
        
        console.log("Mission Phase 1: Sun flyby initiated");
    }

    // Phase 2: After sun loop, trajectory correction
    if (time === 420 && missionPhase === 1) {
        // Correct trajectory after sun flyby
        let currentVel = spacecraft.vel.copy();
        currentVel.mult(0.95); // Slight slow down
        
        let toJupiter = p5.Vector.sub(jupiter.pos, spacecraft.pos);
        toJupiter.normalize();
        toJupiter.mult(0.4);
        
        spacecraft.vel = p5.Vector.add(currentVel, toJupiter);
        missionPhase = 2;
        
        console.log("Mission Phase 2: Trajectory correction");
    }

    // Phase 3: Jupiter approach burn
    if (time === 700 && missionPhase === 2) {
        // Predict Jupiter's future position
        let futureTime = 200;
        let futureJupiter = p5.Vector.add(
            jupiter.pos.copy(),
            p5.Vector.mult(jupiter.vel, futureTime)
        );

        // Calculate intercept vector
        let toIntercept = p5.Vector.sub(futureJupiter, spacecraft.pos);
        toIntercept.setMag(1.3);
        
        spacecraft.vel.add(toIntercept);
        missionPhase = 3;
        
        console.log("Mission Phase 3: Jupiter transfer initiated");
    }
}

function maintainSystemBounds() {
    // Calculate center of mass (excluding spacecraft)
    let centerOfMass = createVector(0, 0);
    let totalMass = 0;
    
    for (let body of bodies) {
        if (body !== spacecraft) {
            centerOfMass.add(p5.Vector.mult(body.pos, body.mass));
            totalMass += body.mass;
        }
    }
    
    centerOfMass.div(totalMass);
    
    // Gently nudge system back toward canvas center
    let canvasCenter = createVector(width / 2, height / 2);
    let correction = p5.Vector.sub(canvasCenter, centerOfMass);
    correction.mult(0.003); // Very gentle correction
    
    // Apply correction to all bodies and their trails
    for (let body of bodies) {
        body.pos.add(correction);
        for (let i = 0; i < body.trail.length; i++) {
            body.trail[i].add(correction);
        }
    }
}

function drawLabels() {
    noStroke();
    textSize(11);
    textAlign(CENTER, CENTER);
    
    // Sun label
    fill(180, 140, 0);
    text(sun.name, sun.pos.x, sun.pos.y - sun.radius - 15);
    
    // Earth label
    fill(40, 80, 180);
    text(earth.name, earth.pos.x, earth.pos.y - earth.radius - 15);
    
    // Jupiter label
    fill(160, 120, 80);
    text(jupiter.name, jupiter.pos.x, jupiter.pos.y - jupiter.radius - 15);
    
    // Spacecraft label
    fill(200, 50, 50);
    text(spacecraft.name, spacecraft.pos.x, spacecraft.pos.y - 18);
}

function displayInfo() {
    noStroke();
    fill(60);
    textAlign(LEFT, TOP);
    textSize(14);
    
    text(`Simulation Time: ${(time / 60).toFixed(1)}s`, 20, 20);
    text(`Mission Phase: ${missionPhase} / 3`, 20, 42);
    text(`FPS: ${floor(frameRate())}`, 20, 64);
    
    // Mission status
    textSize(12);
    fill(80);
    let status = "";
    if (missionPhase === 0) status = "Orbiting Earth";
    else if (missionPhase === 1) status = "Sun Flyby in Progress";
    else if (missionPhase === 2) status = "Mid-Course Correction";
    else if (missionPhase === 3) status = "En Route to Jupiter";
    
    text(`Status: ${status}`, 20, 88);
    
    // Distance to Jupiter
    let distToJupiter = p5.Vector.dist(spacecraft.pos, jupiter.pos);
    text(`Distance to Jupiter: ${floor(distToJupiter)} units`, 20, 110);
    
    // System info
    textSize(11);
    fill(100);
    text(`Bodies: ${bodies.length} | Chaotic N-Body Simulation`, 20, height - 30);
    
    // Physics note
    fill(120);
    textSize(10);
    text(`Non-stable chaotic orbits with gravitational perturbations`, 20, height - 12);
}

function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
    background(220);
}

// Optional: Reset simulation with SPACE key
function keyPressed() {
    if (key === ' ') {
        setup();
        time = 0;
        missionPhase = 0;
        console.log("Simulation reset");
    }
}
</script>
</body>
</html>