<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrokSheet â€“ Full-Featured Excel Clone</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@2.2.9/dist/luckysheet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.2.9/dist/luckysheet.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        html, body { height:100vh; margin:0; padding:0; overflow:hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; }
        #extra-toolbar { height:44px; background:#fff; border-bottom:1px solid #ccc; padding:8px 12px; box-sizing:border-box; display:flex; align-items:center; gap:12px; }
        #luckysheet-container { width:100%; height:calc(100vh - 44px); }
    </style>
</head>
<body>
    <div id="extra-toolbar">
        <button onclick="downloadCSV()">Download Active Sheet as CSV</button>
        <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none" onchange="uploadCSV(this.files[0])">
        <label for="csvFile" style="cursor:pointer; padding:4px 8px; background:#eee; border:1px solid #ccc; border-radius:3px;">Upload CSV to Active Sheet (replaces contents)</label>
    </div>

    <div id="luckysheet-container"></div>

    <script>
        luckysheet.create({
            container: 'luckysheet-container',
            title: 'GrokSheet',
            lang: 'en',
            allowUpdate: true,
            forceCalculation: true,
            showtoolbar: true,
            showsheetbar: true,
            showsheetbarConfig: {
                add: true,           // add sheet
                sheet: true,         // sheet name tabs
                delete: true,        // delete sheet
                rename: true         // rename sheet (double-click tab)
            },
            sheetFormulaBar: true,
            enableAddRow: true,
            enableAddCol: true,
            row: 100,
            col: 60,
            showstatisticBar: false
        });

        function downloadCSV() {
            const flowdata = Store.flowdata; // 2d array of current sheet
            const sheet = luckysheet.getSheet();
            const csvArray = flowdata.map(row =>
                row.map(cell => (cell && cell.v !== undefined && cell.v !== null) ? cell.v : '')
            );
            const csv = Papa.unparse(csvArray);

            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (sheet.name || 'Sheet') + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function uploadCSV(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                Papa.parse(csv, {
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const data = results.data;
                        const newFlowdata = data.map(row =>
                            row.map(cell => (cell === '' || cell === null) ? null : { v: cell })
                        );
                        Store.flowdata = newFlowdata;
                        luckysheet.refresh();
                    }
                });
            };
            reader.readAsText(file, 'UTF-8');
        }
    </script>
</body>
</html>