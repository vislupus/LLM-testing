<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Clone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f3f3;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background-color: #217346;
            color: white;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .toolbar {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 8px;
            border-right: 1px solid #e0e0e0;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
            color: #333;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background-color: #f0f0f0;
            border-color: #ddd;
        }

        .toolbar-btn svg {
            width: 16px;
            height: 16px;
        }

        .formula-bar {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 6px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .formula-bar-label {
            background-color: #f5f5f5;
            padding: 4px 12px;
            border: 1px solid #ddd;
            border-right: none;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .formula-bar-input {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #ddd;
            font-size: 13px;
            font-family: 'Consolas', 'Monaco', monospace;
            outline: none;
        }

        .formula-bar-input:focus {
            border-color: #217346;
            box-shadow: 0 0 0 2px rgba(33, 115, 70, 0.1);
        }

        .sheet-bar {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 4px 0;
        }

        .sheet-tabs {
            display: flex;
            gap: 2px;
            overflow-x: auto;
            flex: 1;
            padding: 0 8px;
        }

        .sheet-tab {
            padding: 6px 16px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 12px;
            color: #333;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .sheet-tab:hover {
            background: #e8e8e8;
        }

        .sheet-tab.active {
            background: #fff;
            border-bottom: 2px solid #fff;
            margin-bottom: -1px;
            color: #217346;
            font-weight: 500;
        }

        .sheet-actions {
            display: flex;
            gap: 4px;
            padding: 0 8px;
        }

        .sheet-action-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }

        .sheet-action-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .spreadsheet-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .spreadsheet {
            position: relative;
            min-width: 100%;
            min-height: 100%;
        }

        .column-headers {
            display: flex;
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f5f5f5;
        }

        .corner-header {
            width: 50px;
            min-width: 50px;
            height: 28px;
            background-color: #f5f5f5;
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #666;
            position: sticky;
            left: 0;
            z-index: 20;
        }

        .column-header {
            height: 28px;
            min-width: 100px;
            background-color: #f5f5f5;
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #666;
            font-weight: 500;
            cursor: col-resize;
            user-select: none;
        }

        .column-header:hover {
            background-color: #e8e8e8;
        }

        .column-header.selected {
            background-color: #217346;
            color: white;
        }

        .row-numbers {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: #f5f5f5;
        }

        .row-number {
            height: 25px;
            width: 50px;
            min-width: 50px;
            background-color: #f5f5f5;
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #666;
            cursor: row-resize;
            user-select: none;
        }

        .row-number:hover {
            background-color: #e8e8e8;
        }

        .row-number.selected {
            background-color: #217346;
            color: white;
        }

        .cells-grid {
            display: flex;
        }

        .cells-row {
            display: flex;
        }

        .cell {
            width: 100px;
            height: 25px;
            min-width: 100px;
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            padding: 2px 6px;
            font-size: 12px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: cell;
            background-color: #fff;
            display: flex;
            align-items: center;
        }

        .cell:hover {
            outline: 1px solid #217346;
            outline-offset: -1px;
        }

        .cell.selected {
            outline: 2px solid #217346;
            outline-offset: -2px;
            background-color: #e6f4ea;
        }

        .cell.selected.focused {
            background-color: #fff;
        }

        .cell.editing {
            padding: 1px 5px;
        }

        .cell input {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            font-size: 12px;
            background: transparent;
            font-family: inherit;
        }

        .cell.range-selected {
            background-color: #c6e0d4;
        }

        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 100;
        }

        .resize-handle.col-resize {
            top: 0;
            width: 6px;
            height: 100%;
            cursor: col-resize;
        }

        .resize-handle.col-resize:hover {
            background-color: #217346;
        }

        .resize-handle.row-resize {
            left: 0;
            height: 6px;
            width: 100%;
            cursor: row-resize;
        }

        .resize-handle.row-resize:hover {
            background-color: #217346;
        }

        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            min-width: 180px;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        .context-menu-item svg {
            width: 16px;
            height: 16px;
            color: #666;
        }

        .context-menu-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 4px 0;
        }

        .color-picker-container {
            position: relative;
        }

        .color-picker-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 1000;
            display: none;
        }

        .color-picker-dropdown.show {
            display: block;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }

        .color-swatch {
            width: 24px;
            height: 24px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #333;
        }

        .status-bar {
            background-color: #217346;
            color: white;
            padding: 4px 16px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-bar-left {
            display: flex;
            gap: 16px;
        }

        .status-bar-right {
            display: flex;
            gap: 8px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            min-width: 400px;
            max-width: 90vw;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            border: none;
        }

        .modal-btn-primary {
            background: #217346;
            color: white;
        }

        .modal-btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
        }

        .input-field {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .input-field:focus {
            outline: none;
            border-color: #217346;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .hidden-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <span class="header-title">Excel Clone</span>
        <div class="header-actions">
            <button class="header-btn" onclick="spreadsheet.newWorkbook()">New</button>
            <button class="header-btn" onclick="document.getElementById('fileInput').click()">Open</button>
            <button class="header-btn" onclick="spreadsheet.saveWorkbook()">Save</button>
            <input type="file" id="fileInput" class="hidden-input" accept=".json" onchange="spreadsheet.loadWorkbook(event)">
        </div>
    </div>

    <div class="toolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="spreadsheet.toggleBold()" title="Bold (Ctrl+B)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
                    <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
                </svg>
            </button>
            <button class="toolbar-btn" onclick="spreadsheet.toggleItalic()" title="Italic (Ctrl+I)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="4" x2="10" y2="4"></line>
                    <line x1="14" y1="20" x2="5" y2="20"></line>
                    <line x1="15" y1="4" x2="9" y2="20"></line>
                </svg>
            </button>
        </div>

        <div class="toolbar-group">
            <div class="color-picker-container">
                <button class="toolbar-btn" onclick="spreadsheet.toggleBgColorPicker()" title="Fill Color">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <path d="M3 9h18"></path>
                        <path d="M9 21V9"></path>
                    </svg>
                    <span style="width: 12px; height: 12px; background: currentColor; border-radius: 2px; border: 1px solid #666;"></span>
                </button>
                <div class="color-picker-dropdown" id="bgColorPicker">
                    <div class="color-grid" id="bgColorGrid"></div>
                </div>
            </div>
            <div class="color-picker-container">
                <button class="toolbar-btn" onclick="spreadsheet.toggleTextColorPicker()" title="Text Color">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.93 0 1.8-.13 2.6-.36l3.3 3.3a1 1 0 0 0 1.41-1.41l-3.29-3.29A9.96 9.96 0 0 0 22 12c0-5.5-4.5-10-10-10z"></path>
                    </svg>
                    <span style="width: 12px; height: 12px; background: currentColor; border-radius: 2px; border: 1px solid #666;"></span>
                </button>
                <div class="color-picker-dropdown" id="textColorPicker">
                    <div class="color-grid" id="textColorGrid"></div>
                </div>
            </div>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="spreadsheet.alignLeft()" title="Align Left">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="15" y2="12"></line>
                    <line x1="3" y1="18" x2="18" y2="18"></line>
                </svg>
            </button>
            <button class="toolbar-btn" onclick="spreadsheet.alignCenter()" title="Align Center">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="6" y1="12" x2="18" y2="12"></line>
                    <line x1="4" y1="18" x2="20" y2="18"></line>
                </svg>
            </button>
            <button class="toolbar-btn" onclick="spreadsheet.alignRight()" title="Align Right">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="9" y1="12" x2="21" y2="12"></line>
                    <line x1="6" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="spreadsheet.clearContents()" title="Clear Contents">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Clear
            </button>
        </div>

        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="spreadsheet.downloadCSV()" title="Download as CSV">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export CSV
            </button>
            <button class="toolbar-btn" onclick="document.getElementById('csvInput').click()" title="Upload CSV">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Import CSV
            </button>
            <input type="file" id="csvInput" class="hidden-input" accept=".csv" onchange="spreadsheet.uploadCSV(event)">
        </div>
    </div>

    <div class="formula-bar">
        <span class="formula-bar-label" id="selectedCellLabel">A1</span>
        <span style="color: #666;">fx</span>
        <input type="text" class="formula-bar-input" id="formulaInput" placeholder="Enter value or formula" onkeydown="spreadsheet.handleFormulaKeydown(event)" oninput="spreadsheet.handleFormulaInput()">
    </div>

    <div class="sheet-bar">
        <div class="sheet-tabs" id="sheetTabs"></div>
        <div class="sheet-actions">
            <button class="sheet-action-btn" onclick="spreadsheet.addSheet()" title="Add Sheet">+</button>
            <button class="sheet-action-btn" onclick="spreadsheet.deleteSheet()" title="Delete Sheet">×</button>
        </div>
    </div>

    <div class="spreadsheet-container" id="spreadsheetContainer">
        <div class="spreadsheet" id="spreadsheet"></div>
    </div>

    <div class="status-bar">
        <div class="status-bar-left">
            <span id="statusReady">Ready</span>
        </div>
        <div class="status-bar-right">
            <span id="statusCellCount">0 cells</span>
        </div>
    </div>

    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="spreadsheet.contextMenuAction('cut')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 2L6 22M18 2L18 22M4 6L4 8M20 6L20 8M4 10L4 14M20 10L20 14"></path>
            </svg>
            Cut
        </div>
        <div class="context-menu-item" onclick="spreadsheet.contextMenuAction('copy')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copy
        </div>
        <div class="context-menu-item" onclick="spreadsheet.contextMenuAction('paste')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
            </svg>
            Paste
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="spreadsheet.contextMenuAction('clear')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"></path>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Clear Contents
        </div>
    </div>

    <div class="modal-overlay" id="renameSheetModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Rename Sheet</span>
                <button class="modal-close" onclick="spreadsheet.closeRenameModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Sheet Name</label>
                    <input type="text" class="input-field" id="sheetNameInput" placeholder="Enter sheet name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="spreadsheet.closeRenameModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="spreadsheet.confirmRenameSheet()">Rename</button>
            </div>
        </div>
    </div>

    <script>
        const COLORS = [
            '#FFFFFF', '#000000', '#EEECE1', '#1F497D', '#4F81BD', '#C0504D', '#9BBB59', '#8064A2',
            '#4BACC6', '#F79646', '#F2F2F2', '#D9D9D9', '#FFF2CC', '#F2DCDB', '#DBE5F1', '#D8E4D8',
            '#E7E6E6', '#CCC0DA', '#DA9694', '#C4D9B8', '#A5A5A5', '#8775A7', '#DA8A67', '#9ABC9C',
            '#B2A2C7', '#DFCFBE', '#D9D9D9', '#FFFFFF', '#FFFFFF', '#FFFFFF', '#FFFFFF', '#FFFFFF'
        ];

        class Spreadsheet {
            constructor() {
                this.columns = 26;
                this.rows = 100;
                this.columnWidth = 100;
                this.rowHeight = 25;
                this.sheets = [];
                this.activeSheetIndex = 0;
                this.selectedCell = null;
                this.selectedRange = null;
                this.isEditing = false;
                this.clipboard = null;
                this.dependentCells = new Map();
                this.formulaMode = false;

                this.init();
            }

            init() {
                this.initColorPickers();
                this.addSheet('Sheet1');
                this.render();
                this.setupEventListeners();
                this.updateStatusBar();
            }

            initColorPickers() {
                const bgGrid = document.getElementById('bgColorGrid');
                const textGrid = document.getElementById('textColorGrid');

                COLORS.forEach(color => {
                    const bgSwatch = document.createElement('div');
                    bgSwatch.className = 'color-swatch';
                    bgSwatch.style.backgroundColor = color;
                    bgSwatch.onclick = () => {
                        this.setBgColor(color);
                        this.toggleBgColorPicker();
                    };
                    bgGrid.appendChild(bgSwatch);

                    const textSwatch = document.createElement('div');
                    textSwatch.className = 'color-swatch';
                    textSwatch.style.backgroundColor = color;
                    textSwatch.onclick = () => {
                        this.setTextColor(color);
                        this.toggleTextColorPicker();
                    };
                    textGrid.appendChild(textSwatch);
                });
            }

            addSheet(name = null) {
                const sheetName = name || `Sheet${this.sheets.length + 1}`;
                const sheet = {
                    name: sheetName,
                    data: {},
                    id: Date.now() + Math.random()
                };
                this.sheets.push(sheet);
                this.renderSheetTabs();
                this.selectSheet(this.sheets.length - 1);
                this.updateStatusBar();
                return sheet;
            }

            deleteSheet() {
                if (this.sheets.length <= 1) {
                    alert('Cannot delete the last sheet');
                    return;
                }
                this.sheets.splice(this.activeSheetIndex, 1);
                if (this.activeSheetIndex >= this.sheets.length) {
                    this.activeSheetIndex = this.sheets.length - 1;
                }
                this.renderSheetTabs();
                this.render();
                this.updateStatusBar();
            }

            renameSheet() {
                const sheet = this.getActiveSheet();
                document.getElementById('sheetNameInput').value = sheet.name;
                document.getElementById('renameSheetModal').classList.add('show');
                document.getElementById('sheetNameInput').focus();
            }

            closeRenameModal() {
                document.getElementById('renameSheetModal').classList.remove('show');
            }

            confirmRenameSheet() {
                const newName = document.getElementById('sheetNameInput').value.trim();
                if (newName && !this.sheets.find((s, i) => i !== this.activeSheetIndex && s.name === newName)) {
                    this.sheets[this.activeSheetIndex].name = newName;
                    this.renderSheetTabs();
                    this.updateStatusBar();
                }
                this.closeRenameModal();
            }

            selectSheet(index) {
                this.activeSheetIndex = index;
                this.selectedCell = null;
                this.selectedRange = null;
                this.renderSheetTabs();
                this.render();
                this.updateFormulaBar();
            }

            getActiveSheet() {
                return this.sheets[this.activeSheetIndex];
            }

            getCellId(col, row) {
                return String.fromCharCode(65 + col) + (row + 1);
            }

            parseCellId(cellId) {
                const col = cellId.charCodeAt(0) - 65;
                const row = parseInt(cellId.substring(1)) - 1;
                return { col, row };
            }

            getCellData(cellId) {
                const sheet = this.getActiveSheet();
                return sheet.data[cellId] || { value: '', formula: '', style: {} };
            }

            setCellData(cellId, data) {
                const sheet = this.getActiveSheet();
                const oldData = sheet.data[cellId] || { value: '', formula: '', style: {} };
                sheet.data[cellId] = { ...oldData, ...data };

                if (this.dependentCells.has(cellId)) {
                    this.recalculateDependents(cellId);
                }
            }

            getCellValue(cellId) {
                const data = this.getCellData(cellId);
                if (data.formula && data.formula.startsWith('=')) {
                    return this.evaluateFormula(data.formula.substring(1), cellId);
                }
                return data.value;
            }

            recalculateDependents(cellId) {
                if (this.dependentCells.has(cellId)) {
                    const dependents = this.dependentCells.get(cellId);
                    dependents.forEach(depCellId => {
                        const data = this.getCellData(depCellId);
                        if (data.formula) {
                            this.setCellData(depCellId, { formula: data.formula });
                        }
                    });
                }
            }

            evaluateFormula(formula, currentCellId) {
                try {
                    const upperFormula = formula.toUpperCase();

                    if (upperFormula.startsWith('SUM(')) {
                        const range = this.parseRange(upperFormula.substring(4, upperFormula.length - 1));
                        const values = this.getRangeValues(range);
                        const sum = values.reduce((a, b) => a + (parseFloat(b) || 0), 0);
                        return isNaN(sum) ? '#VALUE!' : sum.toString();
                    }

                    if (upperFormula.startsWith('AVERAGE(')) {
                        const range = this.parseRange(upperFormula.substring(8, upperFormula.length - 1));
                        const values = this.getRangeValues(range);
                        const nums = values.filter(v => !isNaN(parseFloat(v)));
                        if (nums.length === 0) return '#DIV/0!';
                        const avg = nums.reduce((a, b) => a + parseFloat(b), 0) / nums.length;
                        return avg.toString();
                    }

                    if (upperFormula.startsWith('MIN(')) {
                        const range = this.parseRange(upperFormula.substring(4, upperFormula.length - 1));
                        const values = this.getRangeValues(range);
                        const nums = values.filter(v => !isNaN(parseFloat(v)));
                        if (nums.length === 0) return '0';
                        return Math.min(...nums.map(v => parseFloat(v))).toString();
                    }

                    if (upperFormula.startsWith('MAX(')) {
                        const range = this.parseRange(upperFormula.substring(4, upperFormula.length - 1));
                        const values = this.getRangeValues(range);
                        const nums = values.filter(v => !isNaN(parseFloat(v)));
                        if (nums.length === 0) return '0';
                        return Math.max(...nums.map(v => parseFloat(v))).toString();
                    }

                    let evaluatedFormula = formula.toUpperCase().replace(/([A-Z]+)(\d+)/g, (match, col, row) => {
                        const cellId = col + row;
                        const value = this.getCellValue(cellId);
                        return isNaN(parseFloat(value)) ? '0' : value;
                    });

                    evaluatedFormula = evaluatedFormula.replace(/([A-Z]+)(\d+):([A-Z]+)(\d+)/g, (match, col1, row1, col2, row2) => {
                        const range = this.parseRange(`${col1}${row1}:${col2}${row2}`);
                        const values = this.getRangeValues(range);
                        return values.join(',');
                    });

                    const result = this.safeEval(evaluatedFormula);
                    return isNaN(result) ? '#VALUE!' : result.toString();
                } catch (e) {
                    return '#ERROR!';
                }
            }

            parseRange(rangeStr) {
                const parts = rangeStr.split(':');
                if (parts.length === 1) {
                    const cell = this.parseCellId(parts[0]);
                    return [[cell.col, cell.row]];
                }
                const start = this.parseCellId(parts[0]);
                const end = this.parseCellId(parts[1]);
                const cells = [];
                for (let col = Math.min(start.col, end.col); col <= Math.max(start.col, end.col); col++) {
                    for (let row = Math.min(start.row, end.row); row <= Math.max(start.row, end.row); row++) {
                        cells.push([col, row]);
                    }
                }
                return cells;
            }

            getRangeValues(cells) {
                return cells.map(([col, row]) => {
                    const cellId = this.getCellId(col, row);
                    return this.getCellValue(cellId);
                });
            }

            safeEval(expr) {
                const sanitized = expr.replace(/[^0-9+\-*/().\s]/g, '');
                try {
                    return new Function('return ' + sanitized)();
                } catch (e) {
                    return NaN;
                }
            }

            buildDependencies() {
                this.dependentCells.clear();
                const sheet = this.getActiveSheet();

                Object.keys(sheet.data).forEach(cellId => {
                    const data = sheet.data[cellId];
                    if (data.formula && data.formula.startsWith('=')) {
                        const matches = data.formula.match(/([A-Z]+\d+)/g);
                        if (matches) {
                            matches.forEach(refId => {
                                if (!this.dependentCells.has(refId)) {
                                    this.dependentCells.set(refId, new Set());
                                }
                                this.dependentCells.get(refId).add(cellId);
                            });
                        }
                    }
                });
            }

            render() {
                this.buildDependencies();
                this.renderGrid();
            }

            renderSheetTabs() {
                const container = document.getElementById('sheetTabs');
                container.innerHTML = '';

                this.sheets.forEach((sheet, index) => {
                    const tab = document.createElement('div');
                    tab.className = `sheet-tab${index === this.activeSheetIndex ? ' active' : ''}`;
                    tab.textContent = sheet.name;
                    tab.ondblclick = () => this.renameSheet();
                    tab.onclick = (e) => {
                        e.stopPropagation();
                        this.selectSheet(index);
                    };
                    container.appendChild(tab);
                });
            }

            renderGrid() {
                const container = document.getElementById('spreadsheet');
                let html = '';

                html += '<div class="column-headers">';
                html += '<div class="corner-header"></div>';
                for (let c = 0; c < this.columns; c++) {
                    const colLetter = String.fromCharCode(65 + c);
                    const isSelected = this.selectedRange &&
                                       this.selectedRange.startCol <= c &&
                                       this.selectedRange.endCol >= c;
                    html += `<div class="column-header${isSelected ? ' selected' : ''}" data-col="${c}">${colLetter}</div>`;
                }
                html += '</div>';

                html += '<div class="cells-grid">';
                html += '<div class="row-numbers">';
                for (let r = 0; r < this.rows; r++) {
                    const isSelected = this.selectedRange &&
                                       this.selectedRange.startRow <= r &&
                                       this.selectedRange.endRow >= r;
                    html += `<div class="row-number${isSelected ? ' selected' : ''}" data-row="${r}">${r + 1}</div>`;
                }
                html += '</div>';
                html += '<div class="cells-container">';

                for (let r = 0; r < this.rows; r++) {
                    html += '<div class="cells-row">';
                    for (let c = 0; c < this.columns; c++) {
                        const cellId = this.getCellId(c, r);
                        const data = this.getCellData(cellId);
                        const displayValue = data.formula ? (data.formula.startsWith('=') ? this.getCellValue(cellId) : data.formula) : data.value;

                        let cellClass = 'cell';
                        if (this.selectedCell === cellId) cellClass += ' selected focused';
                        if (this.selectedRange) {
                            const inRange = c >= this.selectedRange.startCol && c <= this.selectedRange.endCol &&
                                           r >= this.selectedRange.startRow && r <= this.selectedRange.endRow;
                            if (inRange) cellClass += ' range-selected';
                        }

                        const style = data.style || {};
                        const cellStyle = `
                            font-weight: ${style.bold ? 'bold' : 'normal'};
                            font-style: ${style.italic ? 'italic' : 'normal'};
                            background-color: ${style.bgColor || 'transparent'};
                            color: ${style.textColor || 'inherit'};
                            text-align: ${style.align || 'left'};
                        `;

                        html += `<div class="${cellClass}"
                            data-cell-id="${cellId}"
                            data-col="${c}"
                            data-row="${r}"
                            style="${cellStyle}">${this.escapeHtml(displayValue)}</div>`;
                    }
                    html += '</div>';
                }
                html += '</div></div>';

                container.innerHTML = html;
                this.setupGridEventListeners();
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            setupGridEventListeners() {
                const cells = document.querySelectorAll('.cell');
                const columnHeaders = document.querySelectorAll('.column-header');
                const rowNumbers = document.querySelectorAll('.row-number');

                cells.forEach(cell => {
                    cell.onclick = (e) => {
                        e.stopPropagation();
                        if (!this.isEditing) {
                            this.selectCell(cell.dataset.cellId, e.shiftKey);
                        }
                    };

                    cell.ondblclick = () => {
                        this.startEdit(cell.dataset.cellId);
                    };
                });

                columnHeaders.forEach(header => {
                    header.onclick = (e) => {
                        e.stopPropagation();
                        const col = parseInt(header.dataset.col);
                        this.selectRange(col, 0, col, this.rows - 1);
                    };
                });

                rowNumbers.forEach(rowNum => {
                    rowNum.onclick = (e) => {
                        e.stopPropagation();
                        const row = parseInt(rowNum.dataset.row);
                        this.selectRange(0, row, this.columns - 1, row);
                    };
                });

                columnHeaders.forEach(header => {
                    this.makeResizable(header, 'col');
                });

                rowNumbers.forEach(rowNum => {
                    this.makeResizable(rowNum, 'row');
                });

                container.oncontextmenu = (e) => {
                    e.preventDefault();
                    const menu = document.getElementById('contextMenu');
                    menu.style.left = e.pageX + 'px';
                    menu.style.top = e.pageY + 'px';
                    menu.classList.add('show');
                };

                document.onclick = () => {
                    document.getElementById('contextMenu').classList.remove('show');
                };
            }

            makeResizable(element, type) {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${type}-resize`;

                handle.onmousedown = (e) => {
                    e.preventDefault();
                    const startPos = type === 'col' ? e.pageX : e.pageY;
                    const startSize = type === 'col' ? element.offsetWidth : element.offsetHeight;

                    const onMouseMove = (e) => {
                        const currentPos = type === 'col' ? e.pageX : e.pageY;
                        const diff = currentPos - startPos;
                        const newSize = Math.max(30, startSize + diff);

                        if (type === 'col') {
                            element.style.width = newSize + 'px';
                            document.querySelectorAll('.cell').forEach(cell => {
                                if (cell.dataset.col == element.dataset.col) {
                                    cell.style.width = newSize + 'px';
                                }
                            });
                        } else {
                            element.style.height = newSize + 'px';
                            const row = element.dataset.row;
                            document.querySelectorAll(`.cells-row`).forEach((rowEl, index) => {
                                if (index == row) {
                                    rowEl.querySelectorAll('.cell').forEach(cell => {
                                        cell.style.height = newSize + 'px';
                                    });
                                }
                            });
                        }
                    };

                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                };

                element.appendChild(handle);
            }

            setupEventListeners() {
                document.onkeydown = (e) => {
                    if (this.isEditing) return;

                    if (e.ctrlKey && e.key === 'b') {
                        e.preventDefault();
                        this.toggleBold();
                    } else if (e.ctrlKey && e.key === 'i') {
                        e.preventDefault();
                        this.toggleItalic();
                    } else if (e.key === 'F2') {
                        e.preventDefault();
                        if (this.selectedCell) {
                            this.startEdit(this.selectedCell);
                        }
                    } else if (e.key === 'Delete' || e.key === 'Backspace') {
                        e.preventDefault();
                        this.clearContents();
                    } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown' ||
                               e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        if (!e.shiftKey && !e.ctrlKey) {
                            e.preventDefault();
                            this.navigateWithArrows(e.key);
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (this.selectedCell) {
                            this.startEdit(this.selectedCell);
                        }
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        this.navigateWithArrows('Tab');
                    }
                };

                document.getElementById('spreadsheetContainer').onclick = (e) => {
                    if (e.target.classList.contains('spreadsheet') ||
                        e.target.classList.contains('spreadsheet-container')) {
                        this.selectedCell = null;
                        this.selectedRange = null;
                        this.render();
                        this.updateFormulaBar();
                    }
                };

                let isDragging = false;
                let dragStartCell = null;

                document.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('cell') && !this.isEditing) {
                        isDragging = true;
                        dragStartCell = e.target;
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging && e.target.classList.contains('cell')) {
                        const start = this.parseCellId(dragStartCell.dataset.cellId);
                        const end = this.parseCellId(e.target.dataset.cellId);
                        this.selectRange(
                            Math.min(start.col, end.col),
                            Math.min(start.row, end.row),
                            Math.max(start.col, end.col),
                            Math.max(start.row, end.row)
                        );
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                document.getElementById('formulaInput').onfocus = () => {
                    this.formulaMode = true;
                };

                document.getElementById('formulaInput').onblur = () => {
                    this.formulaMode = false;
                };
            }

            selectCell(cellId, extend = false) {
                this.selectedCell = cellId;
                if (!extend) {
                    this.selectedRange = null;
                }
                this.render();
                this.updateFormulaBar();
            }

            selectRange(startCol, startRow, endCol, endRow) {
                this.selectedRange = { startCol, startRow, endCol, endRow };
                this.selectedCell = this.getCellId(startCol, startRow);
                this.render();
                this.updateFormulaBar();
            }

            navigateWithArrows(key) {
                if (!this.selectedCell) {
                    this.selectCell('A1');
                    return;
                }

                const { col, row } = this.parseCellId(this.selectedCell);
                let newCol = col, newRow = row;

                switch (key) {
                    case 'ArrowUp': newRow = Math.max(0, row - 1); break;
                    case 'ArrowDown': newRow = Math.min(this.rows - 1, row + 1); break;
                    case 'ArrowLeft': newCol = Math.max(0, col - 1); break;
                    case 'ArrowRight': newCol = Math.min(this.columns - 1, col + 1); break;
                    case 'Tab': newCol = Math.min(this.columns - 1, col + 1); break;
                }

                if (newCol !== col || newRow !== row) {
                    this.selectCell(this.getCellId(newCol, newRow));
                }
            }

            startEdit(cellId) {
                const data = this.getCellData(cellId);
                const cellElement = document.querySelector(`[data-cell-id="${cellId}"]`);
                if (!cellElement) return;

                this.isEditing = true;
                this.selectedCell = cellId;

                const displayValue = data.formula ? data.formula : data.value;
                cellElement.innerHTML = `<input type="text" value="${this.escapeHtml(displayValue)}" autofocus>`;
                cellElement.classList.add('editing');

                const input = cellElement.querySelector('input');
                input.focus();
                input.select();

                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.finishEdit(cellId, input.value);
                    } else if (e.key === 'Escape') {
                        this.cancelEdit(cellId);
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        this.finishEdit(cellId, input.value);
                        this.navigateWithArrows('Tab');
                    }
                };

                input.onblur = () => {
                    this.finishEdit(cellId, input.value);
                };
            }

            finishEdit(cellId, value) {
                this.isEditing = false;
                const data = this.getCellData(cellId);

                if (value.startsWith('=')) {
                    this.setCellData(cellId, { formula: value, value: '' });
                } else {
                    if (data.formula) {
                        this.setCellData(cellId, { formula: '', value: value });
                    } else {
                        this.setCellData(cellId, { value: value });
                    }
                }

                this.render();
                this.updateFormulaBar();
                this.updateStatusBar();
            }

            cancelEdit(cellId) {
                this.isEditing = false;
                this.render();
            }

            updateFormulaBar() {
                const label = document.getElementById('selectedCellLabel');
                const input = document.getElementById('formulaInput');

                if (this.selectedCell) {
                    label.textContent = this.selectedCell;
                    const data = this.getCellData(this.selectedCell);
                    input.value = data.formula || data.value || '';
                } else {
                    label.textContent = '';
                    input.value = '';
                }
            }

            handleFormulaKeydown(event) {
                if (event.key === 'Enter') {
                    if (this.selectedCell) {
                        const value = event.target.value;
                        if (value.startsWith('=')) {
                            this.setCellData(this.selectedCell, { formula: value, value: '' });
                        } else {
                            this.setCellData(this.selectedCell, { formula: '', value: value });
                        }
                        this.render();
                        this.updateStatusBar();
                    }
                }
            }

            handleFormulaInput() {
                if (this.formulaMode && this.selectedRange) {
                }
            }

            toggleBold() {
                if (!this.selectedCell && !this.selectedRange) return;
                const style = this.getActiveSheet().data[this.selectedCell]?.style || {};
                style.bold = !style.bold;
                this.applyStyleToSelection(style);
            }

            toggleItalic() {
                if (!this.selectedCell && !this.selectedRange) return;
                const style = this.getActiveSheet().data[this.selectedCell]?.style || {};
                style.italic = !style.italic;
                this.applyStyleToSelection(style);
            }

            setBgColor(color) {
                if (!this.selectedCell && !this.selectedRange) return;
                const style = this.getActiveSheet().data[this.selectedCell]?.style || {};
                style.bgColor = color;
                this.applyStyleToSelection(style);
            }

            setTextColor(color) {
                if (!this.selectedCell && !this.selectedRange) return;
                const style = this.getActiveSheet().data[this.selectedCell]?.style || {};
                style.textColor = color;
                this.applyStyleToSelection(style);
            }

            applyStyleToSelection(style) {
                if (this.selectedRange) {
                    for (let c = this.selectedRange.startCol; c <= this.selectedRange.endCol; c++) {
                        for (let r = this.selectedRange.startRow; r <= this.selectedRange.endRow; r++) {
                            const cellId = this.getCellId(c, r);
                            const data = this.getCellData(cellId);
                            this.setCellData(cellId, { style: { ...data.style, ...style } });
                        }
                    }
                } else if (this.selectedCell) {
                    const data = this.getCellData(this.selectedCell);
                    this.setCellData(this.selectedCell, { style: { ...data.style, ...style } });
                }
                this.render();
            }

            alignLeft() {
                this.setAlignment('left');
            }

            alignCenter() {
                this.setAlignment('center');
            }

            alignRight() {
                this.setAlignment('right');
            }

            setAlignment(align) {
                if (!this.selectedCell && !this.selectedRange) return;
                const style = this.getActiveSheet().data[this.selectedCell]?.style || {};
                style.align = align;
                this.applyStyleToSelection(style);
            }

            clearContents() {
                if (this.selectedRange) {
                    for (let c = this.selectedRange.startCol; c <= this.selectedRange.endCol; c++) {
                        for (let r = this.selectedRange.startRow; r <= this.selectedRange.endRow; r++) {
                            const cellId = this.getCellId(c, r);
                            delete this.getActiveSheet().data[cellId];
                        }
                    }
                } else if (this.selectedCell) {
                    delete this.getActiveSheet().data[this.selectedCell];
                }
                this.render();
                this.updateFormulaBar();
                this.updateStatusBar();
            }

            downloadCSV() {
                const sheet = this.getActiveSheet();
                let csv = '';

                for (let r = 0; r < this.rows; r++) {
                    const row = [];
                    for (let c = 0; c < this.columns; c++) {
                        const cellId = this.getCellId(c, r);
                        const data = sheet.data[cellId];
                        let value = data?.value || '';
                        if (data?.formula) {
                            value = data.formula.startsWith('=') ? this.getCellValue(cellId) : data.formula;
                        }
                        if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                            value = '"' + value.replace(/"/g, '""') + '"';
                        }
                        row.push(value);
                    }
                    csv += row.join(',') + '\n';
                }

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.getActiveSheet().name}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }

            uploadCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const sheet = this.getActiveSheet();

                    lines.forEach((line, rowIndex) => {
                        if (rowIndex >= this.rows) return;
                        const cells = line.split(',');
                        cells.forEach((value, colIndex) => {
                            if (colIndex >= this.columns) return;
                            const cellId = this.getCellId(colIndex, rowIndex);
                            let cleanValue = value.trim();
                            if (cleanValue.startsWith('"') && cleanValue.endsWith('"')) {
                                cleanValue = cleanValue.slice(1, -1).replace(/""/g, '"');
                            }
                            sheet.data[cellId] = { value: cleanValue };
                        });
                    });

                    this.render();
                    this.updateStatusBar();
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            saveWorkbook() {
                const workbookData = {
                    sheets: this.sheets,
                    activeSheetIndex: this.activeSheetIndex
                };
                const blob = new Blob([JSON.stringify(workbookData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'workbook.json';
                a.click();
                URL.revokeObjectURL(url);
            }

            loadWorkbook(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbookData = JSON.parse(e.target.result);
                        this.sheets = workbookData.sheets;
                        this.activeSheetIndex = workbookData.activeSheetIndex || 0;
                        this.renderSheetTabs();
                        this.render();
                        this.updateStatusBar();
                    } catch (err) {
                        alert('Error loading file: Invalid format');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            newWorkbook() {
                if (confirm('Create new workbook? Unsaved changes will be lost.')) {
                    this.sheets = [];
                    this.addSheet('Sheet1');
                    this.render();
                    this.updateStatusBar();
                }
            }

            contextMenuAction(action) {
                switch (action) {
                    case 'cut':
                    case 'copy':
                        this.clipboard = { action, range: this.selectedRange ? { ...this.selectedRange } : null };
                        break;
                    case 'paste':
                        if (this.clipboard && this.clipboard.range && this.selectedRange) {
                            const sheet = this.getActiveSheet();
                            const srcStart = this.clipboard.range;
                            const dstStart = this.selectedRange;

                            for (let c = 0; c <= srcStart.endCol - srcStart.startCol; c++) {
                                for (let r = 0; r <= srcStart.endRow - srcStart.startRow; r++) {
                                    const srcCellId = this.getCellId(srcStart.startCol + c, srcStart.startRow + r);
                                    const dstCellId = this.getCellId(dstStart.startCol + c, dstStart.startRow + r);
                                    const data = this.getCellData(srcCellId);
                                    this.setCellData(dstCellId, { value: data.value, formula: data.formula, style: data.style });
                                }
                            }
                            this.render();
                        }
                        break;
                    case 'clear':
                        this.clearContents();
                        break;
                }
            }

            toggleBgColorPicker() {
                document.getElementById('bgColorPicker').classList.toggle('show');
            }

            toggleTextColorPicker() {
                document.getElementById('textColorPicker').classList.toggle('show');
            }

            updateStatusBar() {
                const sheet = this.getActiveSheet();
                const cellCount = Object.keys(sheet.data).length;
                document.getElementById('statusCellCount').textContent = `${cellCount} cells`;
                document.getElementById('statusReady').textContent = 'Ready';
            }
        }

        let spreadsheet;
        document.addEventListener('DOMContentLoaded', () => {
            spreadsheet = new Spreadsheet();
        });
    </script>
</body>
</html>
