<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EcoVoyagers Trail ‚Äì SVG.js Board Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SVG.js from CDN (required for drawing/animation) -->
  <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.2/dist/svg.min.js"></script>

  <style>
    :root {
      --green-dark: #1b5e20;
      --green-main: #43a047;
      --green-light: #c8e6c9;
      --yellow-soft: #fffde7;
      --blue-soft: #e3f2fd;
      --pink-soft: #fce4ec;
      --card-bg: #ffffff;
      --shadow-soft: 0 6px 18px rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
      color: var(--green-dark);
    }

    h1, h2, h3 {
      margin: 0 0 0.4em;
    }

    #page-header {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 16px 0;
    }

    #page-header h1 {
      font-size: 1.9rem;
    }

    #page-header p {
      margin: 0.2em 0 0.6em;
      font-size: 0.95rem;
    }

    #game-wrapper {
      max-width: 1100px;
      margin: 0 auto;
      padding: 8px 16px 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    #board-container {
      flex: 2 1 600px;
      min-width: 320px;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow-soft);
      padding: 8px;
    }

    #board-svg {
      width: 100%;
      height: 100%;
      min-height: 420px;
    }

    #side-panel {
      flex: 1 1 260px;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: var(--shadow-soft);
    }

    #controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
    }

    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .control-row label {
      font-weight: 600;
    }

    .pill-group {
      display: inline-flex;
      gap: 4px;
      border-radius: 999px;
      padding: 2px;
      background: #e0f2f1;
    }

    .pill-button {
      border: none;
      padding: 4px 10px;
      border-radius: 999px;
      background: transparent;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--green-dark);
    }

    .pill-button.active {
      background: var(--green-main);
      color: #ffffff;
    }

    #roll-zone {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    button.primary {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--green-main);
      color: #ffffff;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.08s ease;
      box-shadow: 0 4px 12px rgba(67, 160, 71, 0.4);
    }

    button.primary:disabled {
      cursor: default;
      opacity: 0.55;
      box-shadow: none;
      transform: none;
    }

    button.primary:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(67, 160, 71, 0.5);
      background: #388e3c;
    }

    button.secondary {
      border-radius: 999px;
      border: 1px solid #a5d6a7;
      background: #f9fff9;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--green-dark);
    }

    #dice-display {
      min-width: 48px;
      height: 48px;
      border-radius: 12px;
      background: #f9fff9;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--green-dark);
      border: 2px solid #a5d6a7;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.04);
    }

    #dice-display.shake {
      animation: dice-shake 0.5s ease;
    }

    @keyframes dice-shake {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(-2px, 1px) rotate(-5deg); }
      50% { transform: translate(2px, -1px) rotate(5deg); }
      75% { transform: translate(-1px, 0px) rotate(-3deg); }
      100% { transform: translate(0, 0) rotate(0deg); }
    }

    #current-status {
      font-size: 0.9rem;
      padding-top: 4px;
    }

    #tile-hint {
      font-size: 0.8rem;
      padding-top: 4px;
      color: #33691e;
    }

    #question-panel h3 {
      font-size: 1rem;
      margin-bottom: 0.3em;
    }

    #question-panel p {
      margin: 0.2em 0 0.5em;
      font-size: 0.9rem;
    }

    .options-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .option-btn {
      border-radius: 999px;
      border: 1px solid #c5e1a5;
      padding: 6px 10px;
      font-size: 0.9rem;
      text-align: left;
      background: #f9fff9;
      cursor: pointer;
      transition: background 0.1s ease, transform 0.06s ease,
        box-shadow 0.06s ease;
    }

    .option-btn:hover:not(:disabled) {
      background: #e8f5e9;
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .option-btn:disabled {
      cursor: default;
      opacity: 0.7;
      box-shadow: none;
      transform: none;
    }

    .feedback {
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #f1f8e9;
      border: 1px solid #c5e1a5;
      font-size: 0.85rem;
    }

    .next-turn-btn {
      margin-top: 8px;
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      background: #00796b;
      color: #ffffff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
    }

    #scoreboard h3 {
      font-size: 1rem;
      margin-bottom: 0.3em;
    }

    #score-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    #score-table th,
    #score-table td {
      padding: 4px 6px;
      text-align: left;
    }

    #score-table thead {
      border-bottom: 1px solid #c5e1a5;
    }

    #score-table tbody tr:nth-child(odd) {
      background: #f9fff9;
    }

    #score-table tbody tr.active-player {
      background: #e8f5e9;
      font-weight: 600;
    }

    #score-legend {
      font-size: 0.78rem;
      margin-top: 4px;
      color: #33691e;
    }

    #help-box h3 {
      font-size: 1rem;
      margin-bottom: 0.25em;
    }

    #help-box p,
    #help-box li {
      font-size: 0.83rem;
    }

    #help-box ol {
      margin: 0.3em 0 0;
      padding-left: 1.1em;
    }

    #help-box li + li {
      margin-top: 0.15em;
    }

    #log {
      max-width: 1100px;
      margin: 0 auto 20px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: var(--shadow-soft);
      font-size: 0.78rem;
      max-height: 160px;
      overflow-y: auto;
    }

    .log-entry {
      padding: 2px 0;
    }

    .log-entry:first-child {
      font-weight: 600;
    }

    @media (max-width: 800px) {
      #game-wrapper {
        flex-direction: column;
      }
      #board-container {
        order: 1;
      }
      #side-panel {
        order: 2;
      }
    }
  </style>
</head>
<body>
  <div id="page-header">
    <h1>EcoVoyagers Trail</h1>
    <p>
      A cooperative‚Äìcompetitive board game about climate, energy, water, waste,
      and wildlife. Roll, travel, and learn on your way to the Green City!
    </p>
  </div>

  <div id="game-wrapper">
    <div id="board-container">
      <div id="board-svg" aria-label="EcoVoyagers SVG board"></div>
    </div>

    <div id="side-panel">
      <div id="controls" class="card">
        <div class="control-row">
          <label>Players</label>
          <div class="pill-group">
            <button class="pill-button active" data-player-count="1">
              Solo
            </button>
            <button class="pill-button" data-player-count="2">2 Players</button>
          </div>
        </div>

        <div id="roll-zone" class="control-row">
          <button id="roll-button" class="primary">Roll</button>
          <div id="dice-display" aria-label="Dice result">‚Äì</div>
          <button id="restart-button" class="secondary">Restart</button>
        </div>

        <div id="current-status">Current turn: ‚Äì</div>
        <div id="tile-hint" class="hint">
          Hover over tiles to see what they do.
        </div>
      </div>

      <div id="question-panel" class="card" aria-live="polite">
        <h3>No question yet</h3>
        <p>Land on a yellow quiz tile to answer a question and earn Eco Points.</p>
      </div>

      <div id="scoreboard" class="card">
        <h3>Scoreboard</h3>
        <table id="score-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Tile</th>
              <th>Knowledge</th>
              <th>Eco Stars</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="score-legend">
          Knowledge points come from correct answers and helpful actions. Eco
          Stars show how often you made especially green choices.
        </div>
      </div>

      <div id="help-box" class="card">
        <h3>How to Play</h3>
        <ol>
          <li>Choose Solo or 2 Players.</li>
          <li>On your turn, click <strong>Roll</strong> (1‚Äì4 steps).</li>
          <li>
            Move along the trail to different tiles:
            <ul>
              <li><strong>‚ùì Quiz</strong>: answer to gain knowledge and stars.</li>
              <li><strong>‚ö° Action</strong>: instant events (good or bad).</li>
              <li><strong>‚Üª Jump</strong>: move extra spaces forward or back.</li>
              <li><strong>üåø Finish</strong>: reach the Green City!</li>
            </ul>
          </li>
          <li>
            Highest Knowledge and Eco Stars when someone reaches
            <strong>Green City</strong> is the Eco Champion.
          </li>
          <li>Click <strong>Restart</strong> anytime to begin a fresh journey.</li>
        </ol>
      </div>
    </div>
  </div>

  <div id="log" aria-label="Game log"></div>

  <script>
    (function () {
      "use strict";

      let draw;
      const tilePositions = [];
      const boardTiles = [];
      let players = [];
      let currentPlayerIndex = 0;
      let lockInput = false;
      let awaitingAnswer = false;
      let currentQuestion = null;
      let lastQuestionId = null;
      let extraRollThisTurn = false;
      let gameOver = false;

      // --- Board tiles definition (24 tiles) ---
      const tiles = [
        {
          type: "start",
          shortLabel: "Home",
          description: "Your hometown: the start of your eco journey.",
        },
        {
          type: "quiz",
          topic: "energy",
          shortLabel: "Energy",
        },
        {
          type: "action",
          shortLabel: "Recycle",
          effect: "gainPoints",
          points: 2,
          stars: 1,
          message: "You set up a recycling station at school.",
        },
        {
          type: "quiz",
          topic: "waste",
          shortLabel: "Waste",
        },
        {
          type: "quiz",
          topic: "water",
          shortLabel: "Water",
        },
        {
          type: "jump",
          shortLabel: "+2 Path",
          jump: 2,
          message: "You carpool to school. Move 2 extra spaces!",
        },
        {
          type: "quiz",
          topic: "biodiversity",
          shortLabel: "Wildlife",
        },
        {
          type: "action",
          shortLabel: "Smog",
          effect: "losePoints",
          points: 2,
          message:
            "A smoggy day reminds you why clean air matters. Lose some knowledge.",
        },
        {
          type: "quiz",
          topic: "climate",
          shortLabel: "Climate",
        },
        {
          type: "quiz",
          topic: "energy",
          shortLabel: "Energy",
        },
        {
          type: "action",
          shortLabel: "Bike Day",
          effect: "extraRoll",
          message:
            "You organize a bike-to-school day. After resolving this tile, roll again!",
        },
        {
          type: "quiz",
          topic: "water",
          shortLabel: "Water",
        },
        {
          type: "jump",
          shortLabel: "-2 Detour",
          jump: -2,
          message: "A flooded road forces a detour. Move back 2 tiles.",
        },
        {
          type: "quiz",
          topic: "waste",
          shortLabel: "Waste",
        },
        {
          type: "action",
          shortLabel: "Trees",
          effect: "gainStars",
          stars: 2,
          points: 1,
          message: "You plant trees in the park.",
        },
        {
          type: "quiz",
          topic: "biodiversity",
          shortLabel: "Wildlife",
        },
        {
          type: "quiz",
          topic: "climate",
          shortLabel: "Climate",
        },
        {
          type: "action",
          shortLabel: "Heatwave",
          effect: "loseStars",
          stars: 1,
          message:
            "A heatwave raises energy use. You lose 1 Eco Star but learn from it.",
        },
        {
          type: "quiz",
          topic: "energy",
          shortLabel: "Energy",
        },
        {
          type: "jump",
          shortLabel: "+3 Express",
          jump: 3,
          message: "You catch an Eco-Express bus. Jump ahead 3 tiles.",
        },
        {
          type: "quiz",
          topic: "water",
          shortLabel: "Water",
        },
        {
          type: "quiz",
          topic: null,
          shortLabel: "Mixed",
          description: "A surprise topic from any eco category.",
        },
        {
          type: "action",
          shortLabel: "Spill",
          effect: "quizPenalty",
          message:
            "A waste spill! Answer a quick question. Wrong answers cost knowledge.",
        },
        {
          type: "finish",
          shortLabel: "Green City",
          description: "You reached the Green City! Time to tally your impact.",
        },
      ];

      // --- Question Bank ---
      const QUESTIONS = [
        {
          id: 1,
          category: "energy",
          text: "Which of these is a renewable source of energy?",
          options: ["Coal", "Wind", "Oil"],
          correctIndex: 1,
          explanation:
            "Wind keeps blowing and can be used again and again without running out.",
        },
        {
          id: 2,
          category: "energy",
          text: "Which device uses the least electricity?",
          options: ["LED lamp", "Old-style light bulb", "Electric heater"],
          correctIndex: 0,
          explanation:
            "LED lamps are designed to use far less electricity than traditional bulbs.",
        },
        {
          id: 3,
          category: "energy",
          text: "What is the cleanest way to travel a short distance?",
          options: ["Driving alone", "Cycling", "Taking a taxi"],
          correctIndex: 1,
          explanation:
            "Cycling produces no emissions and is healthy exercise too.",
        },
        {
          id: 4,
          category: "waste",
          text: "Which item is usually recyclable in many cities?",
          options: ["Plastic bottle", "Used tissue", "Food scraps"],
          correctIndex: 0,
          explanation:
            "Clean plastic bottles are commonly accepted in recycling bins.",
        },
        {
          id: 5,
          category: "waste",
          text: "What is the best first step in 'Reduce, Reuse, Recycle'?",
          options: ["Recycle", "Reuse", "Reduce"],
          correctIndex: 2,
          explanation:
            "Reducing waste in the first place has the biggest impact.",
        },
        {
          id: 6,
          category: "waste",
          text: "Which habit cuts plastic waste the most?",
          options: [
            "Using a reusable bottle",
            "Buying more plastic bags",
            "Throwing plastic in the trash",
          ],
          correctIndex: 0,
          explanation:
            "A reusable bottle replaces many single-use plastic bottles.",
        },
        {
          id: 7,
          category: "water",
          text: "Which action saves the most water?",
          options: [
            "Turning off the tap while brushing",
            "Taking extra-long showers",
            "Letting a tap drip all day",
          ],
          correctIndex: 0,
          explanation:
            "Turning off the tap while brushing can save many liters of water every day.",
        },
        {
          id: 8,
          category: "water",
          text: "Where should you never throw litter?",
          options: ["In a river", "In a bin", "In a recycling center"],
          correctIndex: 0,
          explanation:
            "Litter in rivers can harm wildlife and pollute drinking water.",
        },
        {
          id: 9,
          category: "water",
          text: "Which drink usually has the lowest water footprint?",
          options: ["Tap water", "Sugary soda", "Bottled water"],
          correctIndex: 0,
          explanation:
            "Tap water uses less packaging and transport than bottled drinks.",
        },
        {
          id: 10,
          category: "biodiversity",
          text: "What is 'biodiversity'?",
          options: [
            "The variety of living things",
            "The amount of wind",
            "A type of fertilizer",
          ],
          correctIndex: 0,
          explanation:
            "Biodiversity means the variety of plants, animals, and other living things.",
        },
        {
          id: 11,
          category: "biodiversity",
          text: "Why are pollinators like bees important?",
          options: [
            "They decorate gardens",
            "They help plants make seeds and fruit",
            "They only make honey for people",
          ],
          correctIndex: 1,
          explanation:
            "Bees move pollen between flowers, helping many plants grow fruits and seeds.",
        },
        {
          id: 12,
          category: "biodiversity",
          text: "Which garden helps wildlife the most?",
          options: [
            "A garden with many native plants",
            "A plastic grass garden",
            "A garden with only pavement",
          ],
          correctIndex: 0,
          explanation:
            "Native plants provide food and shelter for local animals and insects.",
        },
        {
          id: 13,
          category: "climate",
          text: "Which gas is a major cause of climate change?",
          options: ["Carbon dioxide (CO‚ÇÇ)", "Oxygen", "Helium"],
          correctIndex: 0,
          explanation:
            "Carbon dioxide traps heat in the atmosphere and is a main greenhouse gas.",
        },
        {
          id: 14,
          category: "climate",
          text: "What is one effect of global warming?",
          options: [
            "More stable weather everywhere",
            "Melting ice and rising seas",
            "Shorter days and longer nights",
          ],
          correctIndex: 1,
          explanation:
            "As the planet warms, glaciers and ice sheets melt, raising sea levels.",
        },
        {
          id: 15,
          category: "climate",
          text: "Which action helps reduce your climate impact?",
          options: [
            "Wasting food",
            "Eating some plant-based meals",
            "Leaving lights on all day",
          ],
          correctIndex: 1,
          explanation:
            "Plant-based meals usually create less greenhouse gas pollution than meat-heavy meals.",
        },
        {
          id: 16,
          category: "mixed",
          text: "Which habit is the most eco-friendly?",
          options: [
            "Printing every email",
            "Using reusable shopping bags",
            "Throwing batteries in the trash",
          ],
          correctIndex: 1,
          explanation:
            "Reusable bags cut down on single-use plastic and save resources.",
        },
        {
          id: 17,
          category: "mixed",
          text: "What is composting?",
          options: [
            "Turning organic scraps into soil",
            "Burning trash for light",
            "Mixing plastic with food",
          ],
          correctIndex: 0,
          explanation:
            "Composting lets food and plant scraps break down into nutrient-rich soil.",
        },
        {
          id: 18,
          category: "mixed",
          text: "Which is the best bin for old batteries?",
          options: [
            "Special battery recycling point",
            "Regular trash bin",
            "Compost bin",
          ],
          correctIndex: 0,
          explanation:
            "Batteries contain chemicals and should go to special collection points, not regular bins.",
        },
        {
          id: 19,
          category: "mixed",
          text: "What is an easy energy-saving tip at home?",
          options: [
            "Turn off lights when leaving a room",
            "Leave windows open with heating on",
            "Keep devices on standby all night",
          ],
          correctIndex: 0,
          explanation:
            "Switching off lights and devices when not needed saves energy and money.",
        },
        {
          id: 20,
          category: "mixed",
          text: "Which symbol usually means 'recycling'?",
          options: [
            "Three chasing arrows",
            "A lightning bolt",
            "A red cross",
          ],
          correctIndex: 0,
          explanation:
            "Three chasing arrows in a triangle is widely used for recycling.",
        },
      ];

      document.addEventListener("DOMContentLoaded", init);

      function init() {
        if (typeof SVG === "undefined") {
          console.error(
            "SVG.js not loaded. Check your internet connection and script tag."
          );
          return;
        }
        setupSVG();
        buildBoard();
        setupControls();
        initPlayers(1);
      }

      function setupSVG() {
        const container = document.getElementById("board-svg");
        draw = SVG()
          .addTo(container)
          .viewbox(0, 0, 900, 520);

        // Background
        draw
          .rect(900, 520)
          .fill("#f0fdf4")
          .stroke({ width: 0 });

        // Soft hills / decor
        const hill = draw
          .path("M0 420 Q 200 360 400 400 T 900 410 L 900 520 L 0 520 Z")
          .fill("#e0f2f1");
        hill.back();

        // Title banner
        const banner = draw
          .rect(340, 52)
          .radius(24)
          .center(450, 34)
          .fill("#a5d6a7")
          .stroke({ width: 0 });
        const titleText = draw
          .text("EcoVoyagers Trail")
          .font({
            size: 20,
            weight: "700",
            family: "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI'",
          })
          .center(450, 34)
          .fill("#1b5e20");
        banner.before(titleText);
      }

      function buildBoard() {
        const rows = 4;
        const cols = 6;
        const startX = 90;
        const startY = 110;
        const stepX = 120;
        const stepY = 90;

        // First: compute positions
        let idx = 0;
        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const effectiveCol = row % 2 === 0 ? col : cols - 1 - col;
            const x = startX + effectiveCol * stepX;
            const y = startY + row * stepY;
            tilePositions[idx] = { x, y };
            idx++;
          }
        }

        // Draw path connecting positions
        let pathString = "";
        tilePositions.forEach((p, i) => {
          pathString += (i === 0 ? "M" : "L") + p.x + " " + p.y + " ";
        });
        draw
          .path(pathString)
          .fill("none")
          .stroke({
            width: 6,
            color: "#c8e6c9",
            linecap: "round",
            linejoin: "round",
          });

        // Draw tiles
        for (let i = 0; i < tiles.length; i++) {
          const tileDef = tiles[i];
          const pos = tilePositions[i];
          const g = draw.group().addClass("tile");
          const baseColor = tileBaseColor(tileDef.type);

          const rect = g
            .rect(100, 70)
            .radius(18)
            .center(pos.x, pos.y)
            .fill(baseColor)
            .stroke({ width: 2, color: "#388e3c" });

          // Tile number
          g.text(String(i + 1))
            .font({ size: 12, weight: "700" })
            .fill("#1b5e20")
            .move(pos.x - 46, pos.y - 32);

          // Icon
          let iconChar = "";
          switch (tileDef.type) {
            case "start":
              iconChar = "üè°";
              break;
            case "finish":
              iconChar = "üåø";
              break;
            case "quiz":
              iconChar = "‚ùì";
              break;
            case "action":
              iconChar = "‚ö°";
              break;
            case "jump":
              iconChar = "‚Üª";
              break;
          }
          if (iconChar) {
            g.text(iconChar)
              .font({ size: 24 })
              .center(pos.x, pos.y - 5);
          }

          // Short label
          if (tileDef.shortLabel) {
            g.text(tileDef.shortLabel)
              .font({ size: 10 })
              .fill("#2e7d32")
              .center(pos.x, pos.y + 18);
          }

          g.data("index", i);

          g.on("mouseover", function () {
            rect.stroke({ width: 3, color: "#1b5e20" });
            showTileHint(i);
          });
          g.on("mouseout", function () {
            rect.stroke({ width: 2, color: "#388e3c" });
            hideTileHint();
          });

          boardTiles[i] = { group: g, rect, x: pos.x, y: pos.y };
        }
      }

      function tileBaseColor(type) {
        switch (type) {
          case "start":
            return "#e8f5e9";
          case "finish":
            return "#c8e6c9";
          case "quiz":
            return "#fffde7";
          case "action":
            return "#e3f2fd";
          case "jump":
            return "#fce4ec";
          default:
            return "#ffffff";
        }
      }

      // --- UI & Controls ---
      function setupControls() {
        const playerButtons = document.querySelectorAll(
          ".pill-button[data-player-count]"
        );
        playerButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const count = parseInt(btn.dataset.playerCount, 10) || 1;
            playerButtons.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            initPlayers(count);
          });
        });

        const rollButton = document.getElementById("roll-button");
        rollButton.addEventListener("click", onRollClicked);

        const restartButton = document.getElementById("restart-button");
        restartButton.addEventListener("click", () => {
          initPlayers(players.length || 1);
        });
      }

      function initPlayers(numPlayers) {
        numPlayers = Math.min(Math.max(numPlayers, 1), 2);

        // Remove old tokens
        if (players && players.length) {
          players.forEach((p) => {
            if (p.token && typeof p.token.remove === "function") {
              p.token.remove();
            }
          });
        }

        players = [];
        currentPlayerIndex = 0;
        extraRollThisTurn = false;
        gameOver = false;
        lockInput = false;
        awaitingAnswer = false;
        currentQuestion = null;
        lastQuestionId = null;

        const colors = ["#43a047", "#fb8c00"];
        const startPos = tilePositions[0] || { x: 90, y: 110 };
        const tokenOffsetForCount = (i, count) => {
          if (count === 1) return { x: 0, y: 0 };
          if (count === 2) return { x: i === 0 ? -10 : 10, y: 0 };
          return { x: 0, y: 0 };
        };

        for (let i = 0; i < numPlayers; i++) {
          const player = {
            id: i,
            name: `Player ${i + 1}`,
            position: 0,
            score: 0,
            stars: 0,
            token: null,
          };

          const off = tokenOffsetForCount(i, numPlayers);
          const g = draw.group().addClass("token");
          const cx = startPos.x + off.x;
          const cy = startPos.y + off.y;

          g.circle(26).fill(colors[i]).center(cx, cy);
          g.text(String(i + 1))
            .font({ size: 14, weight: "700" })
            .fill("#ffffff")
            .center(cx, cy);

          player.token = g;
          players.push(player);
        }

        document.getElementById("question-panel").innerHTML =
          "<h3>No question yet</h3><p>Land on a yellow quiz tile to answer a question and earn Eco Points.</p>";

        const diceDisplay = document.getElementById("dice-display");
        diceDisplay.textContent = "‚Äì";

        const logEl = document.getElementById("log");
        logEl.innerHTML = "";

        updateScoreboard();
        updateStatusText();
        logMessage(
          `New game started with ${numPlayers} player${
            numPlayers > 1 ? "s" : ""
          }.`
        );
      }

      function getTokenOffset(player) {
        const count = players.length;
        if (count === 1) return { x: 0, y: 0 };
        if (count === 2) {
          return player.id === 0 ? { x: -10, y: 0 } : { x: 10, y: 0 };
        }
        return { x: 0, y: 0 };
      }

      function updateScoreboard() {
        const tbody = document.querySelector("#score-table tbody");
        tbody.innerHTML = "";

        players.forEach((p, idx) => {
          const tr = document.createElement("tr");
          if (idx === currentPlayerIndex && !gameOver) {
            tr.classList.add("active-player");
          }
          const tileLabel =
            p.position === tiles.length - 1 ? "Finish" : p.position + 1;

          tr.innerHTML = `
            <td>${p.name}</td>
            <td>${tileLabel}</td>
            <td>${p.score}</td>
            <td>${p.stars}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function updateStatusText() {
        const statusEl = document.getElementById("current-status");
        if (gameOver) {
          statusEl.textContent =
            "Game over. Click Restart to begin a new journey.";
          return;
        }
        if (!players.length) {
          statusEl.textContent = "No players yet.";
          return;
        }
        const current = players[currentPlayerIndex];
        statusEl.textContent = `Current turn: ${current.name}. Click ‚ÄúRoll‚Äù to move (1‚Äì4 steps).`;
      }

      function logMessage(message) {
        const logEl = document.getElementById("log");
        if (!logEl) return;
        const entry = document.createElement("div");
        entry.className = "log-entry";
        const time = new Date().toLocaleTimeString();
        entry.textContent = `[${time}] ${message}`;
        if (logEl.firstChild) {
          logEl.insertBefore(entry, logEl.firstChild);
        } else {
          logEl.appendChild(entry);
        }
      }

      function showTileHint(idx) {
        const hintEl = document.getElementById("tile-hint");
        const tileDef = tiles[idx];
        if (!hintEl || !tileDef) return;

        let text = `Tile ${idx + 1}: `;
        if (tileDef.description) {
          text += tileDef.description;
        } else {
          switch (tileDef.type) {
            case "start":
              text += "Starting point of your eco journey.";
              break;
            case "finish":
              text += "Final tile. Reach here to win!";
              break;
            case "quiz":
              text +=
                "Quiz tile. Answer a question correctly to gain knowledge and stars.";
              break;
            case "action":
              text +=
                "Action tile. A special event happens immediately when you land here.";
              break;
            case "jump":
              text +=
                "Jump tile. Move extra spaces forward or backward along the trail.";
              break;
            default:
              text += "A mysterious tile...";
          }
        }
        hintEl.textContent = text;
      }

      function hideTileHint() {
        const hintEl = document.getElementById("tile-hint");
        if (!hintEl) return;
        hintEl.textContent = "Hover over tiles to see what they do.";
      }

      // --- Dice & Movement ---
      function onRollClicked() {
        if (lockInput || awaitingAnswer || gameOver) return;
        if (!players.length) return;

        lockInput = true;

        const current = players[currentPlayerIndex];
        const diceDisplay = document.getElementById("dice-display");
        const roll = Math.floor(Math.random() * 4) + 1;

        animateDice();
        diceDisplay.textContent = String(roll);

        const lastIndex = tiles.length - 1;
        const targetIndex =
          current.position + roll > lastIndex
            ? lastIndex
            : current.position + roll;

        logMessage(
          `${current.name} rolled a ${roll} and moves to tile ${targetIndex + 1}.`
        );

        moveTokenTo(current, targetIndex, function () {
          handleTileEffect(current.position);
        });
      }

      function animateDice() {
        const diceDisplay = document.getElementById("dice-display");
        diceDisplay.classList.remove("shake");
        void diceDisplay.offsetWidth; // force reflow
        diceDisplay.classList.add("shake");
      }

      function moveTokenTo(player, targetIndex, callback) {
        const lastIndex = tiles.length - 1;
        if (targetIndex < 0) targetIndex = 0;
        if (targetIndex > lastIndex) targetIndex = lastIndex;

        const step = targetIndex > player.position ? 1 : -1;

        function stepMove() {
          if (player.position === targetIndex) {
            if (typeof callback === "function") callback();
            return;
          }
          player.position += step;
          const pos = tilePositions[player.position];
          const off = getTokenOffset(player);
          player.token
            .animate(300)
            .center(pos.x + off.x, pos.y + off.y)
            .ease("<>")
            .after(stepMove);
        }

        stepMove();
      }

      // --- Tile Effects ---
      function handleTileEffect(tileIndex) {
        const tileDef = tiles[tileIndex];
        const current = players[currentPlayerIndex];

        if (!tileDef || !current) {
          lockInput = false;
          endTileResolution();
          return;
        }

        switch (tileDef.type) {
          case "start":
            logMessage(`${current.name} begins from Home.`);
            lockInput = false;
            endTileResolution();
            break;
          case "finish":
            handleFinish(current);
            break;
          case "quiz":
            startQuestion(tileDef.topic || "mixed", { mode: "normal" });
            break;
          case "action":
            resolveAction(tileDef, current);
            break;
          case "jump":
            resolveJump(tileDef, current);
            break;
          default:
            lockInput = false;
            endTileResolution();
        }
      }

      function handleFinish(player) {
        gameOver = true;
        lockInput = true;
        awaitingAnswer = false;
        currentQuestion = null;

        const tileIndex = tiles.length - 1;
        if (boardTiles[tileIndex] && boardTiles[tileIndex].rect) {
          boardTiles[tileIndex].rect.fill("#b2dfdb");
        }

        logMessage(`${player.name} reached the Green City!`);

        // Determine simple rating
        const totalScore = player.score + player.stars * 2;
        let rating;
        if (totalScore >= 25) {
          rating = "Eco Hero";
        } else if (totalScore >= 15) {
          rating = "Green Guardian";
        } else {
          rating = "Eco Explorer";
        }

        const panel = document.getElementById("question-panel");
        panel.innerHTML = "";

        const h = document.createElement("h3");
        h.textContent = "Green City Reached!";
        panel.appendChild(h);

        const p1 = document.createElement("p");
        p1.textContent = `${player.name} arrived at the Green City with ${player.score} Knowledge and ${player.stars} Eco Stars.`;
        panel.appendChild(p1);

        const p2 = document.createElement("p");
        p2.textContent = `Eco Title: ${rating}. Try again to see if you can improve your score or help another player win.`;
        panel.appendChild(p2);

        updateScoreboard();
        updateStatusText();
      }

      function resolveAction(tileDef, player) {
        let message = tileDef.message || "An action tile triggers!";
        switch (tileDef.effect) {
          case "gainPoints": {
            const pts = tileDef.points || 1;
            const stars = tileDef.stars || 0;
            player.score += pts;
            player.stars += stars;
            message += ` (+${pts} Knowledge, +${stars} Eco Stars)`;
            logMessage(message);
            break;
          }
          case "losePoints": {
            const loss = tileDef.points || 1;
            player.score = Math.max(0, player.score - loss);
            message += ` (‚àí${loss} Knowledge)`;
            logMessage(message);
            break;
          }
          case "extraRoll": {
            extraRollThisTurn = true;
            logMessage(message);
            break;
          }
          case "gainStars": {
            const starsGain = tileDef.stars || 1;
            const ptsGain = tileDef.points || 0;
            player.stars += starsGain;
            player.score += ptsGain;
            message += ` (+${ptsGain} Knowledge, +${starsGain} Eco Stars)`;
            logMessage(message);
            break;
          }
          case "loseStars": {
            const starsLoss = tileDef.stars || 1;
            player.stars = Math.max(0, player.stars - starsLoss);
            message += ` (‚àí${starsLoss} Eco Star)`;
            logMessage(message);
            break;
          }
          case "quizPenalty": {
            logMessage(message);
            startQuestion("mixed", { mode: "spill" });
            return; // endTileResolution handled after question
          }
          default:
            logMessage(message);
        }

        updateScoreboard();
        lockInput = false;
        endTileResolution();
      }

      function resolveJump(tileDef, player) {
        const jump = tileDef.jump || 0;
        if (jump === 0) {
          logMessage(tileDef.message || "This jump tile is calm today.");
          lockInput = false;
          endTileResolution();
          return;
        }

        const lastIndex = tiles.length - 1;
        let targetIndex = player.position + jump;
        if (targetIndex < 0) targetIndex = 0;
        if (targetIndex > lastIndex) targetIndex = lastIndex;

        logMessage(tileDef.message || "You move along the trail!");

        lockInput = true;
        moveTokenTo(player, targetIndex, function () {
          handleTileEffect(player.position);
        });
      }

      // --- Questions ---
      function startQuestion(topic, options) {
        awaitingAnswer = true;
        lockInput = true;
        const mode = (options && options.mode) || "normal";

        const question = getRandomQuestion(topic);
        currentQuestion = { data: question, mode };

        const panel = document.getElementById("question-panel");
        panel.innerHTML = "";

        const heading = document.createElement("h3");
        if (mode === "spill") {
          heading.textContent = "Spill Challenge!";
        } else {
          heading.textContent = "Eco Question";
        }
        panel.appendChild(heading);

        const textP = document.createElement("p");
        textP.textContent = question.text;
        panel.appendChild(textP);

        const optionsRow = document.createElement("div");
        optionsRow.className = "options-row";

        question.options.forEach((opt, idx) => {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.textContent = opt;
          btn.addEventListener("click", function () {
            handleAnswer(idx);
          });
          optionsRow.appendChild(btn);
        });

        panel.appendChild(optionsRow);

        if (mode === "spill") {
          const info = document.createElement("p");
          info.style.fontSize = "0.8rem";
          info.textContent =
            "If you answer correctly, you gain 2 Knowledge. If not, you lose 2 Knowledge.";
          panel.appendChild(info);
        }
      }

      function getRandomQuestion(topic) {
        let pool = QUESTIONS;
        if (topic && topic !== "mixed") {
          const filtered = QUESTIONS.filter((q) => q.category === topic);
          if (filtered.length > 0) pool = filtered;
        }

        let q = pool[Math.floor(Math.random() * pool.length)];
        if (lastQuestionId && pool.length > 1) {
          let guard = 0;
          while (q.id === lastQuestionId && guard < 10) {
            q = pool[Math.floor(Math.random() * pool.length)];
            guard++;
          }
        }
        lastQuestionId = q.id;
        return q;
      }

      function handleAnswer(chosenIndex) {
        if (!awaitingAnswer || !currentQuestion) return;
        awaitingAnswer = false;

        const question = currentQuestion.data;
        const mode = currentQuestion.mode || "normal";
        const panel = document.getElementById("question-panel");
        const buttons = panel.querySelectorAll(".option-btn");
        buttons.forEach((btn) => (btn.disabled = true));

        const current = players[currentPlayerIndex];
        const isCorrect = chosenIndex === question.correctIndex;

        let feedbackExtra = "";
        if (mode === "normal") {
          if (isCorrect) {
            current.score += 3;
            current.stars += 1;
            feedbackExtra =
              "You earn 3 Knowledge points and 1 Eco Star for that answer.";
          } else {
            current.score = Math.max(0, current.score - 1);
            feedbackExtra = "You lose 1 Knowledge point, but you learned something new.";
          }
        } else if (mode === "spill") {
          if (isCorrect) {
            current.score += 2;
            feedbackExtra =
              "You contained the spill and gain 2 Knowledge points.";
          } else {
            current.score = Math.max(0, current.score - 2);
            feedbackExtra =
              "The spill spreads. You lose 2 Knowledge points this time.";
          }
        }

        updateScoreboard();

        const fb = document.createElement("div");
        fb.className = "feedback";
        fb.innerHTML =
          "<p><strong>" +
          (isCorrect ? "Correct!" : "Incorrect.") +
          "</strong> " +
          question.explanation +
          "</p>" +
          "<p>" +
          feedbackExtra +
          "</p>";
        panel.appendChild(fb);

        logMessage(
          (isCorrect ? "Correct answer: " : "Incorrect answer: ") +
            question.text
        );

        const nextBtn = document.createElement("button");
        nextBtn.className = "next-turn-btn";
        nextBtn.textContent = "Finish Turn";
        nextBtn.addEventListener("click", function () {
          panel.innerHTML = "";
          currentQuestion = null;
          lockInput = false;
          endTileResolution();
        });
        panel.appendChild(nextBtn);
      }

      function endTileResolution() {
        if (gameOver) {
          updateStatusText();
          return;
        }

        if (extraRollThisTurn) {
          logMessage(
            `${players[currentPlayerIndex].name} keeps the turn and may roll again!`
          );
          extraRollThisTurn = false;
          lockInput = false;
          updateStatusText();
          updateScoreboard();
          return;
        }

        // Next player's turn
        if (players.length > 1) {
          currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
        }

        lockInput = false;
        updateStatusText();
        updateScoreboard();
      }
    })();
  </script>
</body>
</html>
