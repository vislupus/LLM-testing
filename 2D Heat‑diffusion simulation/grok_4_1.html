<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Heat Diffusion Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0f0f1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        #container {
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            border-radius: 16px;
            overflow: hidden;
        }
        .ui {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(15,15,30,0.9);
            padding: 18px;
            border-radius: 12px;
            color: #e0e0ff;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(100,150,255,0.3);
            width: 320px;
            transition: all 0.3s ease;
        }
        .ui.hidden { transform: translateX(-340px); }
        h2 {
            margin: 0 0 15px 0;
            color: #64b5f6;
            font-size: 20px;
            text-shadow: 0 0 10px rgba(100,180,255,0.5);
        }
        .control {
            margin-bottom: 14px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #b0c4ff;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #64b5f6;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(100,180,255,0.6);
        }
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            padding: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }
        .material-btn {
            background: #333 !important;
            border: 2px solid #555 !important;
        }
        .material-btn.active {
            border-color: #64b5f6 !important;
            background: #64b5f6 !important;
            color: black;
        }
        .info {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(15,15,30,0.9);
            padding: 15px;
            border-radius: 12px;
            color: #e0e0ff;
            font-size: 12px;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(100,150,255,0.3);
        }
        .toggle {
            position: absolute;
            top: 15px;
            left: 335px;
            background: rgba(15,15,30,0.9);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 0 12px 12px 0;
            cursor: pointer;
            font-size: 18px;
        }
        .toggle.shifted { left: 15px; }
    </style>
</head>
<body>
    <div id="container">
        <div class="ui" id="ui">
            <h2>Heat Diffusion Lab</h2>
            
            <div class="control">
                <label>Thermal Diffusivity α: <span id="alphaVal">0.8</span></label>
                <input type="range" id="alpha" min="0.1" max="2.0" step="0.05" value="0.8">
            </div>
            
            <div class="control">
                <label>Simulation Speed: <span id="speedVal">1.0</span>x</label>
                <input type="range" id="speed" min="0.1" max="3.0" step="0.1" value="1.0">
            </div>
            
            <div class="control">
                <label>Brush Size: <span id="brushVal">3</span></label>
                <input type="range" id="brush" min="1" max="10" step="1" value="3">
            </div>
            
            <div class="control">
                <label>Brush Temperature: <span id="tempVal">800</span>°C</label>
                <input type="range" id="temp" min="100" max="1200" step="50" value="800">
            </div>
            
            <div class="control">
                <label>Boundary Condition:</label>
                <select id="boundary" style="width:100%; padding:8px; border-radius:6px; background:#333; color:white; border:none;">
                    <option value="insulated">Insulated (No heat loss)</option>
                    <option value="cold">Cold Edges (0°C)</option>
                    <option value="room">Room Temp (20°C)</option>
                </select>
            </div>
            
            <div class="control">
                <label>Material Preset:</label>
                <div class="btn-grid">
                    <button class="material-btn active" data-alpha="0.8">Metal</button>
                    <button class="material-btn" data-alpha="0.4">Glass</button>
                    <button class="material-btn" data-alpha="0.2">Wood</button>
                    <button class="material-btn" data-alpha="0.05">Insulator</button>
                </div>
            </div>
            
            <div class="btn-grid">
                <button onclick="heatSim.clear()">Clear</button>
                <button onclick="heatSim.randomHeat()">Random Heat</button>
            </div>
        </div>
        
        <button class="toggle" id="toggleBtn" onclick="toggleUI()">◀</button>
        
        <div class="info">
            <strong>Controls:</strong><br>
            • Left Click → Add Hot Spot<br>
            • Right Click / Ctrl+Click → Add Cold Spot<br>
            • Scroll → Change Brush Size<br>
            • Space → Pause/Resume<br>
            • R → Reset to Room Temp
        </div>
    </div>

    <script>
        class HeatDiffusion {
            constructor() {
                this.gridSize = 256;
                this.grid = [];
                this.nextGrid = [];
                this.alpha = 0.8;           // Thermal diffusivity
                this.speed = 1.0;
                this.brushSize = 3;
                this.brushTemp = 800;
                this.paused = false;
                
                this.initGrid();
            }
            
            initGrid() {
                for (let i = 0; i < this.gridSize; i++) {
                    this.grid[i] = [];
                    this.nextGrid[i] = [];
                    for (let j = 0; j < this.gridSize; j++) {
                        this.grid[i][j] = 20;  // Room temperature
                        this.nextGrid[i][j] = 20;
                    }
                }
            }
            
            update() {
                if (this.paused) return;
                
                const a = this.alpha * this.speed * 0.18;  // Stability-tuned constant
                
                for (let i = 1; i < this.gridSize - 1; i++) {
                    for (let j = 1; j < this.gridSize - 1; j++) {
                        const center = this.grid[i][j];
                        const laplacian = 
                            this.grid[i+1][j] + 
                            this.grid[i-1][j] + 
                            this.grid[i][j+1] + 
                            this.grid[i][j-1] - 
                            4 * center;
                        
                        this.nextGrid[i][j] = center + a * laplacian;
                    }
                }
                
                // Apply boundary conditions
                this.applyBoundaries();
                
                // Swap grids
                [this.grid, this.nextGrid] = [this.nextGrid, this.grid];
            }
            
            applyBoundaries() {
                const mode = document.getElementById('boundary').value;
                const edgeTemp = mode === 'cold' ? 0 : (mode === 'room' ? 20 : null);
                
                for (let i = 0; i < this.gridSize; i++) {
                    // Top and bottom edges
                    if (edgeTemp !== null) {
                        this.nextGrid[i][0] = edgeTemp;
                        this.nextGrid[i][this.gridSize-1] = edgeTemp;
                    } else {
                        this.nextGrid[i][0] = this.nextGrid[i][1];
                        this.nextGrid[i][this.gridSize-1] = this.nextGrid[i][this.gridSize-2];
                    }
                    
                    // Left and right edges
                    if (edgeTemp !== null) {
                        this.nextGrid[0][i] = edgeTemp;
                        this.nextGrid[this.gridSize-1][i] = edgeTemp;
                    } else {
                        this.nextGrid[0][i] = this.nextGrid[1][i];
                        this.nextGrid[this.gridSize-1][i] = this.nextGrid[this.gridSize-2][i];
                    }
                }
                
                // Corners
                if (edgeTemp !== null) {
                    this.nextGrid[0][0] = edgeTemp;
                    this.nextGrid[0][this.gridSize-1] = edgeTemp;
                    this.nextGrid[this.gridSize-1][0] = edgeTemp;
                    this.nextGrid[this.gridSize-1][this.gridSize-1] = edgeTemp;
                }
            }
            
            addHeat(x, y, temp) {
                const i = Math.floor(x / width * this.gridSize);
                const j = Math.floor(y / height * this.gridSize);
                const r = this.brushSize;
                
                for (let di = -r; di <= r; di++) {
                    for (let dj = -r; dj <= r; dj++) {
                        const ii = i + di;
                        const jj = j + dj;
                        if (ii >= 0 && ii < this.gridSize && jj >= 0 && jj < this.gridSize) {
                            const dist = Math.sqrt(di*di + dj*dj);
                            if (dist <= r) {
                                const falloff = Math.exp(-dist*dist / (r*r/2));
                                this.grid[ii][jj] += (temp - this.grid[ii][jj]) * falloff * 0.8;
                            }
                        }
                    }
                }
            }
            
            render() {
                const cellW = width / this.gridSize;
                const cellH = height / this.gridSize;
                
                noStroke();
                for (let i = 0; i < this.gridSize; i++) {
                    for (let j = 0; j < this.gridSize; j++) {
                        let t = this.grid[i][j];
                        t = constrain(t, 0, 1000);
                        
                        // Beautiful plasma-like colormap
                        let r, g, b;
                        if (t < 200) {
                            // Blue to cyan
                            r = 0;
                            g = map(t, 0, 200, 50, 255);
                            b = map(t, 0, 200, 200, 255);
                        } else if (t < 400) {
                            // Cyan to yellow
                            r = map(t, 200, 400, 0, 255);
                            g = 255;
                            b = map(t, 200, 400, 255, 100);
                        } else if (t < 700) {
                            // Yellow to red
                            r = 255;
                            g = map(t, 400, 700, 255, 100);
                            b = 0;
                        } else {
                            // Red to white-hot
                            r = 255;
                            g = map(t, 700, 1000, 100, 255);
                            b = map(t, 700, 1000, 0, 255);
                        }
                        
                        fill(r, g, b, 240);
                        rect(i * cellW, j * cellH, cellW + 1, cellH + 1);
                    }
                }
                
                // Optional glow effect for very hot areas
                for (let i = 0; i < this.gridSize; i += 4) {
                    for (let j = 0; j < this.gridSize; j += 4) {
                        if (this.grid[i][j] > 600) {
                            fill(255, 255, 255, 30);
                            ellipse(i * cellW, j * cellH, cellW * 8);
                        }
                    }
                }
            }
            
            clear() {
                this.initGrid();
            }
            
            randomHeat() {
                for (let n = 0; n < 20; n++) {
                    const x = random(width);
                    const y = random(height);
                    const temp = random(300, 1000);
                    this.addHeat(x, y, temp);
                }
            }
        }

        let heatSim;
        let canvas;

        function setup() {
            canvas = createCanvas(900, 900);
            canvas.parent('container');
            heatSim = new HeatDiffusion();
            
            // UI Controls
            document.getElementById('alpha').addEventListener('input', (e) => {
                heatSim.alpha = parseFloat(e.target.value);
                document.getElementById('alphaVal').textContent = e.target.value;
            });
            
            document.getElementById('speed').addEventListener('input', (e) => {
                heatSim.speed = parseFloat(e.target.value);
                document.getElementById('speedVal').textContent = e.target.value;
            });
            
            document.getElementById('brush').addEventListener('input', (e) => {
                heatSim.brushSize = parseInt(e.target.value);
                document.getElementById('brushVal').textContent = e.target.value;
            });
            
            document.getElementById('temp').addEventListener('input', (e) => {
                heatSim.brushTemp = parseFloat(e.target.value);
                document.getElementById('tempVal').textContent = e.target.value;
            });
            
            // Material presets
            document.querySelectorAll('.material-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.material-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const alpha = parseFloat(btn.dataset.alpha);
                    heatSim.alpha = alpha;
                    document.getElementById('alpha').value = alpha;
                    document.getElementById('alphaVal').textContent = alpha.toFixed(2);
                });
            });
        }

        function draw() {
            heatSim.update();
            heatSim.render();
        }

        function mouseDragged() {
            if (mouseIsPressed) {
                const temp = mouseButton === RIGHT || keyIsDown(CONTROL) ? 0 : heatSim.brushTemp;
                heatSim.addHeat(mouseX, mouseY, temp);
            }
        }

        function mousePressed() {
            const temp = mouseButton === RIGHT || keyIsDown(CONTROL) ? 0 : heatSim.brushTemp;
            heatSim.addHeat(mouseX, mouseY, temp);
        }

        function keyPressed() {
            if (key === ' ') heatSim.paused = !heatSim.paused;
            if (key === 'r' || key === 'R') heatSim.clear();
        }

        function wheel(event) {
            heatSim.brushSize = constrain(heatSim.brushSize + (event.deltaY > 0 ? 1 : -1), 1, 15);
            document.getElementById('brush').value = heatSim.brushSize;
            document.getElementById('brushVal').textContent = heatSim.brushSize;
            return false;
        }

        function toggleUI() {
            document.getElementById('ui').classList.toggle('hidden');
            document.getElementById('toggleBtn').classList.toggle('shifted');
            document.getElementById('toggleBtn').textContent = 
                document.getElementById('ui').classList.contains('hidden') ? '▶' : '◀';
        }
    </script>
</body>
</html>