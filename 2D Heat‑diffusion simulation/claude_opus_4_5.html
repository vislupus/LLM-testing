<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Heat Diffusion Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            padding: 20px;
        }
        
        #container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        #canvas-wrapper {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        
        #controls {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 16px;
            color: #fff;
            min-width: 320px;
            max-width: 350px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        #controls h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b6b;
            font-weight: 600;
            font-size: 22px;
            text-shadow: 0 0 20px rgba(255,107,107,0.3);
        }
        
        .control-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .control-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .control-section h3 {
            color: #4ecdc4;
            font-size: 14px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .control-row {
            margin-bottom: 12px;
        }
        
        .control-row label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 13px;
            color: #ccc;
        }
        
        .control-row label span {
            color: #ff6b6b;
            font-weight: 600;
            font-family: 'Consolas', monospace;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.1);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255,107,107,0.4);
            transition: transform 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }
        
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            outline: none;
        }
        
        select:focus {
            border-color: #4ecdc4;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: 80px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4ecdc4, #3dbdb5);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78,205,196,0.4);
        }
        
        .btn-cool {
            background: linear-gradient(135deg, #667eea, #5a6fd6);
            color: white;
        }
        
        .btn-cool:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }
        
        .key {
            display: inline-block;
            background: rgba(0,0,0,0.4);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 11px;
            border: 1px solid rgba(255,255,255,0.2);
            margin: 0 2px;
        }
        
        .help-text {
            font-size: 12px;
            color: #999;
            line-height: 1.6;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-box {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 18px;
            font-weight: 700;
            color: #ff6b6b;
            font-family: 'Consolas', monospace;
        }
        
        .stat-box .label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            margin-top: 4px;
        }
        
        .material-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .material-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .gradient-bar {
            height: 20px;
            border-radius: 4px;
            background: linear-gradient(to right, 
                #0000ff, #0066ff, #00ccff, #00ffcc, 
                #00ff66, #66ff00, #ccff00, #ffcc00, 
                #ff6600, #ff0000);
            margin-top: 10px;
            position: relative;
        }
        
        .gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #888;
            margin-top: 4px;
        }
        
        #legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            color: white;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="canvas-wrapper">
            <div id="legend"></div>
        </div>
        
        <div id="controls">
            <h2>ðŸ”¥ Heat Diffusion</h2>
            
            <div class="control-section">
                <h3>Thermal Properties</h3>
                <div class="control-row">
                    <label>Diffusivity (Î±): <span id="alphaVal">0.25</span></label>
                    <input type="range" id="alpha" min="0.01" max="1" step="0.01" value="0.25">
                </div>
                <div class="control-row">
                    <label>Time Step (dt): <span id="dtVal">0.5</span></label>
                    <input type="range" id="dt" min="0.1" max="2" step="0.1" value="0.5">
                </div>
                <div class="control-row">
                    <label>Convection: <span id="convVal">0</span></label>
                    <input type="range" id="convection" min="0" max="0.5" step="0.01" value="0">
                </div>
            </div>
            
            <div class="control-section">
                <h3>Heat Source</h3>
                <div class="control-row">
                    <label>Temperature: <span id="heatVal">100</span>Â°</label>
                    <input type="range" id="heatTemp" min="10" max="200" step="5" value="100">
                </div>
                <div class="control-row">
                    <label>Brush Size: <span id="brushVal">5</span></label>
                    <input type="range" id="brushSize" min="1" max="20" step="1" value="5">
                </div>
                <div class="control-row">
                    <label>Mode:</label>
                    <select id="brushMode">
                        <option value="heat">Add Heat</option>
                        <option value="cool">Cool Down</option>
                        <option value="material">Paint Material</option>
                        <option value="source">Persistent Source</option>
                        <option value="sink">Heat Sink</option>
                    </select>
                </div>
            </div>
            
            <div class="control-section">
                <h3>Materials</h3>
                <div class="control-row">
                    <select id="materialSelect">
                        <option value="copper">Copper (High Î±)</option>
                        <option value="aluminum">Aluminum (Medium-High Î±)</option>
                        <option value="steel">Steel (Medium Î±)</option>
                        <option value="glass">Glass (Low Î±)</option>
                        <option value="insulator">Insulator (Very Low Î±)</option>
                    </select>
                </div>
                <div class="material-indicator">
                    <div class="material-color" id="materialColor"></div>
                    <span id="materialInfo">Copper - Î±: 1.0</span>
                </div>
            </div>
            
            <div class="control-section">
                <h3>Boundary Conditions</h3>
                <div class="control-row">
                    <select id="boundary">
                        <option value="insulated">Insulated (No flux)</option>
                        <option value="fixed-cold">Fixed Cold (0Â°)</option>
                        <option value="fixed-ambient">Fixed Ambient (20Â°)</option>
                        <option value="periodic">Periodic (Wrap)</option>
                    </select>
                </div>
            </div>
            
            <div class="control-section">
                <h3>Actions</h3>
                <div class="button-row">
                    <button class="btn-primary" onclick="resetSimulation()">Reset</button>
                    <button class="btn-secondary" onclick="clearSources()">Clear Sources</button>
                    <button class="btn-cool" onclick="togglePause()">Pause</button>
                </div>
                <div class="button-row" style="margin-top: 10px;">
                    <button class="btn-secondary" onclick="addRandomSources()">Random Sources</button>
                    <button class="btn-cool" onclick="addGradient()">Add Gradient</button>
                </div>
            </div>
            
            <div class="control-section">
                <h3>Statistics</h3>
                <div class="stats">
                    <div class="stat-box">
                        <div class="value" id="maxTemp">0</div>
                        <div class="label">Max Temp</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="avgTemp">0</div>
                        <div class="label">Avg Temp</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="fpsDisplay">60</div>
                        <div class="label">FPS</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="stabilityVal">OK</div>
                        <div class="label">Stability</div>
                    </div>
                </div>
                <div class="gradient-bar"></div>
                <div class="gradient-labels">
                    <span>Cold (0Â°)</span>
                    <span>Hot (100Â°+)</span>
                </div>
            </div>
            
            <div class="control-section">
                <h3>Controls</h3>
                <div class="help-text">
                    <span class="key">Click</span> Add heat/cool<br>
                    <span class="key">Shift+Click</span> Persistent source<br>
                    <span class="key">C</span> Clear all<br>
                    <span class="key">Space</span> Pause<br>
                    <span class="key">1-5</span> Select material<br>
                    <span class="key">+/-</span> Adjust brush size
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simulation parameters
        let gridWidth, gridHeight;
        const CELL_SIZE = 4;
        let canvasWidth, canvasHeight;
        
        // Temperature grids (double buffering)
        let temperature, tempNext;
        
        // Material properties grid
        let materials;
        
        // Heat sources and sinks
        let sources = [];
        let sinks = [];
        
        // Simulation settings
        let alpha = 0.25;           // Thermal diffusivity
        let dt = 0.5;               // Time step
        let dx = 1.0;               // Spatial step
        let convectionStrength = 0;
        let ambientTemp = 0;
        let paused = false;
        
        // Interaction
        let brushSize = 5;
        let heatTemp = 100;
        let brushMode = 'heat';
        let currentMaterial = 'copper';
        
        // Boundary condition
        let boundaryCondition = 'insulated';
        
        // Material definitions
        const materialProps = {
            copper:     { alpha: 1.0,  color: [184, 115, 51],  name: 'Copper' },
            aluminum:   { alpha: 0.8,  color: [192, 192, 192], name: 'Aluminum' },
            steel:      { alpha: 0.4,  color: [113, 121, 126], name: 'Steel' },
            glass:      { alpha: 0.15, color: [200, 230, 255], name: 'Glass' },
            insulator:  { alpha: 0.02, color: [60, 60, 60],    name: 'Insulator' }
        };
        
        // Color palette for temperature visualization
        const heatmapColors = [
            [0, 0, 50],       // 0 - Deep blue
            [0, 0, 150],      // 10
            [0, 100, 255],    // 20
            [0, 200, 255],    // 30
            [0, 255, 200],    // 40
            [0, 255, 100],    // 50
            [100, 255, 0],    // 60
            [200, 255, 0],    // 70
            [255, 200, 0],    // 80
            [255, 100, 0],    // 90
            [255, 0, 0],      // 100
            [255, 50, 50],    // 110+
            [255, 150, 150],  // 120+
            [255, 200, 200],  // 130+
            [255, 255, 255]   // 140+ White hot
        ];
        
        let bufferGraphics;
        
        function setup() {
            // Calculate canvas size
            canvasWidth = min(700, windowWidth - 400);
            canvasHeight = min(700, windowHeight - 80);
            canvasWidth = max(400, canvasWidth);
            canvasHeight = max(400, canvasHeight);
            
            const canvas = createCanvas(canvasWidth, canvasHeight);
            canvas.parent('canvas-wrapper');
            
            gridWidth = floor(canvasWidth / CELL_SIZE);
            gridHeight = floor(canvasHeight / CELL_SIZE);
            
            // Initialize grids
            initializeGrids();
            
            // Create buffer for efficient rendering
            bufferGraphics = createGraphics(gridWidth, gridHeight);
            bufferGraphics.pixelDensity(1);
            
            // Setup UI event listeners
            setupControls();
            
            updateMaterialIndicator();
        }
        
        function initializeGrids() {
            const size = gridWidth * gridHeight;
            temperature = new Float32Array(size);
            tempNext = new Float32Array(size);
            materials = new Float32Array(size).fill(1.0); // Default to copper conductivity
            
            // Initialize to ambient temperature
            temperature.fill(ambientTemp);
            
            sources = [];
            sinks = [];
        }
        
        function setupControls() {
            // Alpha (diffusivity)
            document.getElementById('alpha').addEventListener('input', function() {
                alpha = parseFloat(this.value);
                document.getElementById('alphaVal').textContent = alpha.toFixed(2);
            });
            
            // Time step
            document.getElementById('dt').addEventListener('input', function() {
                dt = parseFloat(this.value);
                document.getElementById('dtVal').textContent = dt.toFixed(1);
            });
            
            // Convection
            document.getElementById('convection').addEventListener('input', function() {
                convectionStrength = parseFloat(this.value);
                document.getElementById('convVal').textContent = convectionStrength.toFixed(2);
            });
            
            // Heat temperature
            document.getElementById('heatTemp').addEventListener('input', function() {
                heatTemp = parseFloat(this.value);
                document.getElementById('heatVal').textContent = heatTemp;
            });
            
            // Brush size
            document.getElementById('brushSize').addEventListener('input', function() {
                brushSize = parseInt(this.value);
                document.getElementById('brushVal').textContent = brushSize;
            });
            
            // Brush mode
            document.getElementById('brushMode').addEventListener('change', function() {
                brushMode = this.value;
            });
            
            // Material selection
            document.getElementById('materialSelect').addEventListener('change', function() {
                currentMaterial = this.value;
                updateMaterialIndicator();
            });
            
            // Boundary condition
            document.getElementById('boundary').addEventListener('change', function() {
                boundaryCondition = this.value;
            });
        }
        
        function updateMaterialIndicator() {
            const mat = materialProps[currentMaterial];
            document.getElementById('materialColor').style.backgroundColor = 
                `rgb(${mat.color[0]}, ${mat.color[1]}, ${mat.color[2]})`;
            document.getElementById('materialInfo').textContent = 
                `${mat.name} - Î±: ${mat.alpha.toFixed(2)}`;
        }
        
        function idx(x, y) {
            return x + y * gridWidth;
        }
        
        function getTemperature(x, y) {
            // Handle boundary conditions
            if (x < 0 || x >= gridWidth || y < 0 || y >= gridHeight) {
                switch(boundaryCondition) {
                    case 'insulated':
                        // Neumann: reflect at boundary
                        x = constrain(x, 0, gridWidth - 1);
                        y = constrain(y, 0, gridHeight - 1);
                        return temperature[idx(x, y)];
                    case 'fixed-cold':
                        return 0;
                    case 'fixed-ambient':
                        return 20;
                    case 'periodic':
                        x = (x + gridWidth) % gridWidth;
                        y = (y + gridHeight) % gridHeight;
                        return temperature[idx(x, y)];
                    default:
                        return 0;
                }
            }
            return temperature[idx(x, y)];
        }
        
        function heatDiffusionStep() {
            // Stability condition: Î± * dt / dxÂ² <= 0.25 for 2D explicit method
            const maxAlpha = alpha;
            const stabilityFactor = maxAlpha * dt / (dx * dx);
            const isStable = stabilityFactor <= 0.25;
            
            document.getElementById('stabilityVal').textContent = isStable ? 'OK' : 'UNSTABLE';
            document.getElementById('stabilityVal').style.color = isStable ? '#4ecdc4' : '#ff6b6b';
            
            // Apply heat equation: âˆ‚T/âˆ‚t = Î±âˆ‡Â²T
            for (let y = 0; y < gridHeight; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    const i = idx(x, y);
                    const materialAlpha = alpha * materials[i];
                    
                    // Get neighboring temperatures
                    const T_center = temperature[i];
                    const T_left = getTemperature(x - 1, y);
                    const T_right = getTemperature(x + 1, y);
                    const T_up = getTemperature(x, y - 1);
                    const T_down = getTemperature(x, y + 1);
                    
                    // Laplacian using 5-point stencil
                    const laplacian = (T_left + T_right + T_up + T_down - 4 * T_center) / (dx * dx);
                    
                    // Heat equation update
                    let newTemp = T_center + materialAlpha * dt * laplacian;
                    
                    // Add convection (upward heat flow)
                    if (convectionStrength > 0) {
                        const T_below = getTemperature(x, y + 1);
                        newTemp += convectionStrength * (T_below - T_center) * dt;
                    }
                    
                    // Clamp temperature
                    tempNext[i] = max(0, newTemp);
                }
            }
            
            // Apply heat sources
            for (const source of sources) {
                const i = idx(source.x, source.y);
                tempNext[i] = source.temp;
            }
            
            // Apply heat sinks
            for (const sink of sinks) {
                const i = idx(sink.x, sink.y);
                tempNext[i] = max(0, tempNext[i] - sink.strength);
            }
            
            // Swap buffers
            [temperature, tempNext] = [tempNext, temperature];
        }
        
        function getHeatmapColor(temp) {
            // Map temperature to color palette
            const normalizedTemp = constrain(temp / 10, 0, heatmapColors.length - 1.01);
            const colorIdx = floor(normalizedTemp);
            const t = normalizedTemp - colorIdx;
            
            const c1 = heatmapColors[colorIdx];
            const c2 = heatmapColors[min(colorIdx + 1, heatmapColors.length - 1)];
            
            return [
                lerp(c1[0], c2[0], t),
                lerp(c1[1], c2[1], t),
                lerp(c1[2], c2[2], t)
            ];
        }
        
        function renderHeatmap() {
            bufferGraphics.loadPixels();
            
            let maxT = 0;
            let sumT = 0;
            
            for (let y = 0; y < gridHeight; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    const i = idx(x, y);
                    const temp = temperature[i];
                    const materialAlpha = materials[i];
                    
                    maxT = max(maxT, temp);
                    sumT += temp;
                    
                    let [r, g, b] = getHeatmapColor(temp);
                    
                    // Blend with material color for low temperatures
                    if (temp < 5 && materialAlpha !== 1.0) {
                        const matKey = Object.keys(materialProps).find(k => 
                            abs(materialProps[k].alpha - materialAlpha) < 0.01
                        );
                        if (matKey) {
                            const matColor = materialProps[matKey].color;
                            const blend = 0.5;
                            r = lerp(r, matColor[0], blend);
                            g = lerp(g, matColor[1], blend);
                            b = lerp(b, matColor[2], blend);
                        }
                    }
                    
                    const pixelIdx = (x + y * gridWidth) * 4;
                    bufferGraphics.pixels[pixelIdx] = r;
                    bufferGraphics.pixels[pixelIdx + 1] = g;
                    bufferGraphics.pixels[pixelIdx + 2] = b;
                    bufferGraphics.pixels[pixelIdx + 3] = 255;
                }
            }
            
            bufferGraphics.updatePixels();
            
            // Draw scaled up with smoothing
            push();
            noSmooth();
            image(bufferGraphics, 0, 0, width, height);
            pop();
            
            // Draw heat sources and sinks indicators
            noFill();
            strokeWeight(2);
            
            for (const source of sources) {
                stroke(255, 255, 0, 200);
                const sx = source.x * CELL_SIZE + CELL_SIZE / 2;
                const sy = source.y * CELL_SIZE + CELL_SIZE / 2;
                ellipse(sx, sy, 12, 12);
            }
            
            for (const sink of sinks) {
                stroke(0, 200, 255, 200);
                const sx = sink.x * CELL_SIZE + CELL_SIZE / 2;
                const sy = sink.y * CELL_SIZE + CELL_SIZE / 2;
                rect(sx - 5, sy - 5, 10, 10);
            }
            
            // Update stats
            document.getElementById('maxTemp').textContent = maxT.toFixed(1);
            document.getElementById('avgTemp').textContent = (sumT / (gridWidth * gridHeight)).toFixed(1);
        }
        
        function draw() {
            if (!paused) {
                // Multiple simulation steps per frame for speed
                const stepsPerFrame = 3;
                for (let i = 0; i < stepsPerFrame; i++) {
                    heatDiffusionStep();
                }
            }
            
            renderHeatmap();
            
            // Handle continuous mouse input
            if (mouseIsPressed && mouseInCanvas()) {
                applyBrush(mouseX, mouseY);
            }
            
            // Update FPS
            if (frameCount % 10 === 0) {
                document.getElementById('fpsDisplay').textContent = floor(frameRate());
            }
        }
        
        function mouseInCanvas() {
            return mouseX >= 0 && mouseX < width && mouseY >= 0 && mouseY < height;
        }
        
        function applyBrush(mx, my) {
            const gx = floor(mx / CELL_SIZE);
            const gy = floor(my / CELL_SIZE);
            
            for (let dy = -brushSize; dy <= brushSize; dy++) {
                for (let dx = -brushSize; dx <= brushSize; dx++) {
                    const dist = sqrt(dx * dx + dy * dy);
                    if (dist <= brushSize) {
                        const x = gx + dx;
                        const y = gy + dy;
                        
                        if (x >= 0 && x < gridWidth && y >= 0 && y < gridHeight) {
                            const i = idx(x, y);
                            const falloff = 1 - dist / (brushSize + 1);
                            
                            switch(brushMode) {
                                case 'heat':
                                    temperature[i] = max(temperature[i], heatTemp * falloff);
                                    break;
                                case 'cool':
                                    temperature[i] = max(0, temperature[i] - heatTemp * falloff * 0.5);
                                    break;
                                case 'material':
                                    materials[i] = materialProps[currentMaterial].alpha;
                                    break;
                                case 'source':
                                    if (!sources.find(s => s.x === x && s.y === y)) {
                                        sources.push({ x, y, temp: heatTemp });
                                    }
                                    break;
                                case 'sink':
                                    if (!sinks.find(s => s.x === x && s.y === y)) {
                                        sinks.push({ x, y, strength: 5 });
                                    }
                                    break;
                            }
                        }
                    }
                }
            }
        }
        
        function mousePressed() {
            if (mouseInCanvas() && keyIsDown(SHIFT)) {
                // Add persistent source with shift-click
                const gx = floor(mouseX / CELL_SIZE);
                const gy = floor(mouseY / CELL_SIZE);
                if (gx >= 0 && gx < gridWidth && gy >= 0 && gy < gridHeight) {
                    if (!sources.find(s => s.x === gx && s.y === gy)) {
                        sources.push({ x: gx, y: gy, temp: heatTemp });
                    }
                }
            }
        }
        
        function keyPressed() {
            switch(key) {
                case ' ':
                    togglePause();
                    return false;
                case 'c':
                case 'C':
                    resetSimulation();
                    break;
                case '1':
                    currentMaterial = 'copper';
                    document.getElementById('materialSelect').value = 'copper';
                    updateMaterialIndicator();
                    break;
                case '2':
                    currentMaterial = 'aluminum';
                    document.getElementById('materialSelect').value = 'aluminum';
                    updateMaterialIndicator();
                    break;
                case '3':
                    currentMaterial = 'steel';
                    document.getElementById('materialSelect').value = 'steel';
                    updateMaterialIndicator();
                    break;
                case '4':
                    currentMaterial = 'glass';
                    document.getElementById('materialSelect').value = 'glass';
                    updateMaterialIndicator();
                    break;
                case '5':
                    currentMaterial = 'insulator';
                    document.getElementById('materialSelect').value = 'insulator';
                    updateMaterialIndicator();
                    break;
                case '+':
                case '=':
                    brushSize = min(20, brushSize + 1);
                    document.getElementById('brushSize').value = brushSize;
                    document.getElementById('brushVal').textContent = brushSize;
                    break;
                case '-':
                case '_':
                    brushSize = max(1, brushSize - 1);
                    document.getElementById('brushSize').value = brushSize;
                    document.getElementById('brushVal').textContent = brushSize;
                    break;
            }
        }
        
        function resetSimulation() {
            temperature.fill(ambientTemp);
            tempNext.fill(ambientTemp);
            materials.fill(1.0);
            sources = [];
            sinks = [];
        }
        
        function clearSources() {
            sources = [];
            sinks = [];
        }
        
        function togglePause() {
            paused = !paused;
            document.querySelector('.btn-cool').textContent = paused ? 'Resume' : 'Pause';
        }
        
        function addRandomSources() {
            const numSources = floor(random(3, 8));
            for (let i = 0; i < numSources; i++) {
                const x = floor(random(10, gridWidth - 10));
                const y = floor(random(10, gridHeight - 10));
                const temp = random(50, 150);
                sources.push({ x, y, temp });
            }
        }
        
        function addGradient() {
            // Add a horizontal temperature gradient
            for (let y = 0; y < gridHeight; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    temperature[idx(x, y)] = map(x, 0, gridWidth, 0, 100);
                }
            }
        }
        
        function windowResized() {
            // Don't resize dynamically to maintain simulation state
        }
    </script>
</body>
</html>