<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoJS - Web Image Editor</title>
    <style>
        :root {
            --bg-dark: #2b2b2b;
            --bg-panel: #535353;
            --bg-tool: #404040;
            --text-main: #e0e0e0;
            --accent: #3498db;
            --accent-hover: #5dade2;
            --border: #1a1a1a;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Top Bar --- */
        header {
            height: 40px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
        }

        .logo { font-weight: bold; color: #fff; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--accent); }

        .menu-bar { display: flex; gap: 15px; font-size: 13px; }
        .menu-item { cursor: pointer; padding: 5px 10px; border-radius: 4px; }
        .menu-item:hover { background: var(--bg-tool); }

        /* --- Main Layout --- */
        .workspace {
            display: flex;
            flex: 1;
            height: calc(100vh - 40px);
        }

        /* --- Toolbar (Left) --- */
        .toolbar {
            width: 50px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            gap: 8px;
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        
        .tool-btn:hover { background: var(--bg-tool); }
        .tool-btn.active { background: var(--accent); }
        .tool-btn svg { width: 20px; height: 20px; fill: #ccc; }
        .tool-btn.active svg { fill: white; }
        
        /* Tool options (Color, Size) under tools */
        .tool-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
            width: 100%;
        }

        input[type="color"] {
            width: 30px; height: 30px; border: none; padding: 0; background: none; cursor: pointer;
        }

        input[type="range"] { width: 40px; margin-top: 5px; }

        /* --- Canvas Area (Center) --- */
        .viewport {
            flex: 1;
            background: #1e1e1e;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            position: relative;
            background-image: 
                linear-gradient(45deg, #2b2b2b 25%, transparent 25%), 
                linear-gradient(-45deg, #2b2b2b 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #2b2b2b 75%), 
                linear-gradient(-45deg, transparent 75%, #2b2b2b 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        #canvas-container {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background: white; /* Base for canvas */
            line-height: 0;
        }

        /* --- Panels (Right) --- */
        .panels {
            width: 250px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .panel {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid var(--border);
        }

        .panel-header {
            background: var(--bg-tool);
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            padding: 10px;
            flex: 1;
            overflow-y: auto;
            max-height: 40vh;
        }

        /* Layers Panel */
        .layer-list { display: flex; flex-direction: column; gap: 2px; }
        
        .layer-item {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .layer-item.active { border-color: var(--accent); background: #444; }
        
        .layer-vis { cursor: pointer; font-size: 16px; color: #888; width: 20px; text-align: center; }
        .layer-vis.hidden { color: #444; text-shadow: 0 0 2px #888; } /* Simulated slash */

        .layer-thumb {
            width: 30px; height: 30px; background: white; border: 1px solid #777;
        }
        
        .layer-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .layer-controls {
            display: flex; flex-direction: column; gap: 5px; padding: 10px; border-top: 1px solid #444; background: #444;
        }
        
        .control-row { display: flex; align-items: center; justify-content: space-between; gap: 5px; font-size: 12px; }
        
        select, input[type="number"] {
            background: #333; border: 1px solid #555; color: white; padding: 3px; border-radius: 3px; width: 100%;
        }

        button.btn-small {
            background: #444; border: 1px solid #666; color: white; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;
        }
        button.btn-small:hover { background: #555; }

        /* History Panel */
        .history-item {
            padding: 6px; font-size: 12px; color: #ccc; cursor: pointer;
            border-bottom: 1px solid #444;
        }
        .history-item:hover { background: #444; }
        .history-item.current { color: var(--accent); font-weight: bold; }

        /* --- Utilities --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: var(--bg-panel); padding: 20px; border-radius: 5px; width: 300px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal h3 { margin-top: 0; color: white; }
        .modal input { background: #333; border: 1px solid #555; color: white; padding: 5px; width: 100%; margin-bottom: 10px;}
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 6px 12px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-cancel { background: #555; color: white; }

    </style>
</head>
<body>

    <header>
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--accent)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            <span>PhotoJS</span>
        </div>
        <div class="menu-bar">
            <div class="menu-item" onclick="newFile()">New</div>
            <div class="menu-item" onclick="downloadImage()">Export</div>
            <div class="menu-item" onclick="openUpload()">Upload</div>
            <input type="file" id="file-upload" style="display:none" accept="image/*" onchange="handleUpload(this)">
        </div>
    </header>

    <div class="workspace">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="tool-btn active" onclick="setTool('brush')" title="Brush (B)">
                <svg viewBox="0 0 24 24"><path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34c-.39-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.02 0-1.41z"/></svg>
            </div>
            <div class="tool-btn" onclick="setTool('eraser')" title="Eraser (E)">
                <svg viewBox="0 0 24 24"><path d="M15.14 3c-.51 0-1.02.2-1.41.59L2.59 14.73c-.78.77-.78 2.04 0 2.83L5.17 20.17c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l2.28-2.28 4.25-4.25c.78-.78.78-2.05 0-2.83l-2.58-2.58c-.39-.39-.9-.59-1.41-.59zM13 17l-2-2 1.41-1.41 2 2L13 17z"/></svg>
            </div>
            <div class="tool-btn" onclick="setTool('fill')" title="Fill Bucket (G)">
                <svg viewBox="0 0 24 24"><path d="M16.56 8.94L7.62 0 6.21 1.41l2.38 2.38-5.15 5.15a1.5 1.5 0 0 0 0 2.12l5.5 5.5c.29.29.68.44 1.06.44s.77-.15 1.06-.44l5.5-5.5c.59-.58.59-1.53 0-2.12zM5.21 10l5.51-5.51 5.51 5.51-5.51 5.51L5.21 10zM19 11.5s-2 2.17-2 3.5c0 1.1.9 2 2 2s2-.9 2-2c0-1.33-2-3.5-2-3.5z"/></svg>
            </div>
            
            <div class="tool-options">
                <input type="color" id="color-picker" value="#000000" title="Color">
                <input type="range" id="size-slider" min="1" max="50" value="5" title="Size">
            </div>
        </div>

        <!-- Canvas Viewport -->
        <div class="viewport">
            <div id="canvas-container">
                <canvas id="main-canvas" width="800" height="600"></canvas>
            </div>
        </div>

        <!-- Panels -->
        <div class="panels">
            <!-- Layers Panel -->
            <div class="panel" style="flex: 2;">
                <div class="panel-header">
                    <span>Layers</span>
                    <div style="display:flex; gap:5px">
                        <span style="cursor:pointer" onclick="addLayer()" title="New Layer">+</span>
                        <span style="cursor:pointer" onclick="deleteLayer()" title="Delete Layer">ðŸ—‘</span>
                    </div>
                </div>
                <div class="layer-list" id="layer-list">
                    <!-- Layers injected here -->
                </div>
                <div class="layer-controls">
                    <div class="control-row">
                        <span>Blend</span>
                        <select id="blend-mode" onchange="updateActiveLayerProps()">
                            <option value="source-over">Normal</option>
                            <option value="multiply">Multiply</option>
                            <option value="screen">Screen</option>
                            <option value="overlay">Overlay</option>
                            <option value="darken">Darken</option>
                            <option value="lighten">Lighten</option>
                            <option value="color-dodge">Color Dodge</option>
                            <option value="color-burn">Color Burn</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <span>Opacity</span>
                        <input type="range" min="0" max="100" value="100" oninput="updateActiveLayerProps()">
                    </div>
                </div>
            </div>

            <!-- Filters Panel -->
            <div class="panel">
                <div class="panel-header">Filters</div>
                <div class="panel-content" style="display:flex; flex-direction:column; gap:5px;">
                    <button class="btn-small" onclick="applyFilter('grayscale')">Grayscale</button>
                    <button class="btn-small" onclick="applyFilter('invert')">Invert</button>
                    <button class="btn-small" onclick="applyFilter('sepia')">Sepia</button>
                    <button class="btn-small" onclick="applyFilter('blur')">Blur (Simple)</button>
                    <button class="btn-small" onclick="applyFilter('noise')">Noise</button>
                    <button class="btn-small" onclick="applyFilter('brightness')">Brightness +</button>
                </div>
            </div>

             <!-- History Panel -->
             <div class="panel" style="flex: 1;">
                <div class="panel-header">History</div>
                <div class="panel-content" id="history-list">
                    <!-- History items -->
                </div>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div class="modal-overlay" id="new-file-modal">
        <div class="modal">
            <h3>New Image</h3>
            <label>Width</label>
            <input type="number" id="new-width" value="800">
            <label>Height</label>
            <input type="number" id="new-height" value="600">
            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmNewFile()">Create</button>
            </div>
        </div>
    </div>

<script>
    /**
     * PhotoJS Core
     * Implements Layer system, History, Tools, and Compositing
     */

    // Config
    const MAX_HISTORY = 20;

    // State
    let layers = [];
    let activeLayerId = null;
    let historyStack = [];
    let historyIndex = -1;
    let currentTool = 'brush';
    let isDrawing = false;
    let lastX = 0, lastY = 0;

    // DOM Elements
    const mainCanvas = document.getElementById('main-canvas');
    const ctx = mainCanvas.getContext('2d');
    const layerListEl = document.getElementById('layer-list');
    const historyListEl = document.getElementById('history-list');
    const colorPicker = document.getElementById('color-picker');
    const sizeSlider = document.getElementById('size-slider');
    const blendSelect = document.getElementById('blend-mode');
    const opacitySlider = document.querySelector('.layer-controls input[type="range"]');

    // Initialization
    function init(width, height) {
        mainCanvas.width = width;
        mainCanvas.height = height;
        layers = [];
        historyStack = [];
        historyIndex = -1;
        
        // Create Background Layer
        addLayer('Background', true);
        
        // Fill Background with white
        const bgLayer = layers[0];
        bgLayer.ctx.fillStyle = '#ffffff';
        bgLayer.ctx.fillRect(0, 0, width, height);
        bgLayer.thumbCtx.fillStyle = '#ffffff';
        bgLayer.thumbCtx.fillRect(0, 0, 60, 40); // Thumb size

        render();
        saveHistory('New Document');
    }

    /* --- Layer System --- */

    class Layer {
        constructor(id, width, height, name = 'Layer') {
            this.id = id;
            this.name = name;
            this.visible = true;
            this.opacity = 1;
            this.blendMode = 'source-over';
            
            // The actual canvas for this layer
            this.canvas = document.createElement('canvas');
            this.canvas.width = width;
            this.canvas.height = height;
            this.ctx = this.canvas.getContext('2d');

            // Thumbnail canvas (scaled down)
            this.thumbCanvas = document.createElement('canvas');
            this.thumbCanvas.width = 60;
            this.thumbCanvas.height = 40;
            this.thumbCtx = this.thumbCanvas.getContext('2d');
        }
    }

    function addLayer(name = null, isBg = false) {
        const id = Date.now() + Math.random();
        const w = mainCanvas.width;
        const h = mainCanvas.height;
        const layerName = name || `Layer ${layers.length + 1}`;
        
        const newLayer = new Layer(id, w, h, layerName);
        
        if (isBg) {
            layers.unshift(newLayer); // Background at bottom
        } else {
            layers.push(newLayer);
        }
        
        setActiveLayer(id);
        updateLayerUI();
        if(!isBg) saveHistory('New Layer');
    }

    function deleteLayer() {
        if (layers.length <= 1) return alert("Cannot delete the last layer.");
        const idx = layers.findIndex(l => l.id === activeLayerId);
        if (idx > -1) {
            layers.splice(idx, 1);
            setActiveLayer(layers[Math.max(0, idx - 1)].id);
            updateLayerUI();
            saveHistory('Delete Layer');
        }
    }

    function setActiveLayer(id) {
        activeLayerId = id;
        render(); // Re-render UI selection
        updateLayerUI();
    }

    function toggleVisibility(id, e) {
        e.stopPropagation();
        const layer = layers.find(l => l.id === id);
        if(layer) {
            layer.visible = !layer.visible;
            render();
            updateLayerUI();
        }
    }

    function updateActiveLayerProps() {
        const layer = layers.find(l => l.id === activeLayerId);
        if(layer) {
            layer.blendMode = blendSelect.value;
            layer.opacity = opacitySlider.value / 100;
            render();
        }
    }

    function updateLayerUI() {
        layerListEl.innerHTML = '';
        // Render top to bottom (reverse array)
        [...layers].reverse().forEach(layer => {
            const div = document.createElement('div');
            div.className = `layer-item ${layer.id === activeLayerId ? 'active' : ''}`;
            div.onclick = () => setActiveLayer(layer.id);
            
            const visIcon = document.createElement('div');
            visIcon.className = `layer-vis ${!layer.visible ? 'hidden' : ''}`;
            visIcon.innerText = 'ðŸ‘';
            visIcon.onclick = (e) => toggleVisibility(layer.id, e);

            const thumb = document.createElement('div');
            thumb.className = 'layer-thumb';
            // Draw thumb
            thumb.style.backgroundImage = `url(${layer.thumbCanvas.toDataURL()})`;
            thumb.style.backgroundSize = 'cover';

            const name = document.createElement('div');
            name.className = 'layer-name';
            name.innerText = layer.name;

            div.appendChild(visIcon);
            div.appendChild(thumb);
            div.appendChild(name);
            layerListEl.appendChild(div);
        });

        // Update controls to match active layer
        const active = layers.find(l => l.id === activeLayerId);
        if(active) {
            blendSelect.value = active.blendMode;
            opacitySlider.value = active.opacity * 100;
        }
    }

    /* --- Compositing Engine --- */
    function render() {
        // Clear main canvas
        ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
        
        // Draw layers bottom to top
        layers.forEach(layer => {
            if (!layer.visible) return;
            
            ctx.save();
            ctx.globalAlpha = layer.opacity;
            ctx.globalCompositeOperation = layer.blendMode;
            ctx.drawImage(layer.canvas, 0, 0);
            ctx.restore();
        });
    }

    function updateThumbnail(layer) {
        // Redraw thumbnail from main layer canvas
        layer.thumbCtx.clearRect(0,0,60,40);
        layer.thumbCtx.drawImage(layer.canvas, 0, 0, 60, 40);
        updateLayerUI();
    }

    /* --- Tools & Drawing --- */
    function setTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active'); // Needs 'event' passed or logic adjusted
    }

    function getPointerPos(e) {
        const rect = mainCanvas.getBoundingClientRect();
        return {
            x: (e.clientX - rect.left) * (mainCanvas.width / rect.width),
            y: (e.clientY - rect.top) * (mainCanvas.height / rect.height)
        };
    }

    mainCanvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const pos = getPointerPos(e);
        lastX = pos.x;
        lastY = pos.y;
        
        const layer = layers.find(l => l.id === activeLayerId);
        if(!layer || !layer.visible) return;

        if (currentTool === 'fill') {
            bucketFill(layer, Math.floor(lastX), Math.floor(lastY));
            saveHistory('Fill');
            isDrawing = false;
        } else {
            // Draw dot
            drawOnLayer(layer, pos.x, pos.y, false);
        }
    });

    mainCanvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const pos = getPointerPos(e);
        const layer = layers.find(l => l.id === activeLayerId);
        if(layer && layer.visible) {
            drawOnLayer(layer, pos.x, pos.y, true);
            lastX = pos.x;
            lastY = pos.y;
        }
    });

    window.addEventListener('mouseup', () => {
        if (isDrawing) {
            isDrawing = false;
            saveHistory('Draw Stroke');
        }
    });

    function drawOnLayer(layer, x, y, isDragging) {
        const ctx = layer.ctx;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = sizeSlider.value;
        
        if (currentTool === 'eraser') {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.strokeStyle = 'rgba(0,0,0,1)';
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = colorPicker.value;
        }

        if (isDragging) {
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
        } else {
            // Dot
            ctx.beginPath();
            ctx.arc(x, y, sizeSlider.value / 2, 0, Math.PI * 2);
            ctx.fill();
        }
        
        render();
        // Optimize: Don't update thumb on every mousemove
        if(!isDrawing) updateThumbnail(layer); 
    }

    /* --- Flood Fill (Simplified) --- */
    function bucketFill(layer, x, y) {
        const ctx = layer.ctx;
        const w = layer.canvas.width;
        const h = layer.canvas.height;
        const imageData = ctx.getImageData(0, 0, w, h);
        const data = imageData.data;
        
        // Get target color
        const targetColor = getPixel(data, x, y, w);
        const fillColor = hexToRgb(colorPicker.value);
        
        if (colorsMatch(targetColor, fillColor)) return;

        const stack = [[x, y]];
        
        while(stack.length) {
            const [cx, cy] = stack.pop();
            const idx = (cy * w + cx) * 4;
            
            if(cx < 0 || cx >= w || cy < 0 || cy >= h) continue;
            if(!colorsMatch(getPixel(data, cx, cy, w), targetColor)) continue;
            
            setPixel(data, idx, fillColor);
            
            stack.push([cx+1, cy]);
            stack.push([cx-1, cy]);
            stack.push([cx, cy+1]);
            stack.push([cx, cy-1]);
        }
        
        ctx.putImageData(imageData, 0, 0);
        render();
        updateThumbnail(layer);
    }

    function getPixel(data, x, y, w) {
        const i = (y * w + x) * 4;
        return [data[i], data[i+1], data[i+2], data[i+3]];
    }

    function setPixel(data, i, color) {
        data[i] = color.r;
        data[i+1] = color.g;
        data[i+2] = color.b;
        data[i+3] = 255; // Alpha
    }

    function colorsMatch(c1, c2) {
        return c1[0] === c2.r && c1[1] === c2.g && c1[2] === c2.b;
    }

    function hexToRgb(hex) {
        const bigint = parseInt(hex.slice(1), 16);
        return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
    }

    /* --- History System --- */
    function saveHistory(actionName) {
        // Remove redo history if we diverge
        if (historyIndex < historyStack.length - 1) {
            historyStack = historyStack.slice(0, historyIndex + 1);
        }
        
        // Save state (Deep copy of layer ImageDatas)
        const state = layers.map(l => {
            return {
                id: l.id,
                name: l.name,
                visible: l.visible,
                opacity: l.opacity,
                blendMode: l.blendMode,
                imageData: l.ctx.getImageData(0, 0, l.canvas.width, l.canvas.height)
            };
        });
        
        historyStack.push({ name: actionName, state: state });
        
        if (historyStack.length > MAX_HISTORY) historyStack.shift();
        else historyIndex++;
        
        updateHistoryUI();
    }

    function undo() {
        if (historyIndex > 0) {
            historyIndex--;
            restoreState(historyStack[historyIndex].state);
        }
    }

    function redo() {
        if (historyIndex < historyStack.length - 1) {
            historyIndex++;
            restoreState(historyStack[historyIndex].state);
        }
    }

    function restoreState(state) {
        // Reconstruct layers from saved data
        // Note: For simplicity, we assume layer order/count remains somewhat consistent or we rebuild
        // A robust system would serialize full layer data. Here we assume layer structure is static
        
        state.forEach(savedLayer => {
            const layer = layers.find(l => l.id === savedLayer.id);
            if(layer) {
                layer.visible = savedLayer.visible;
                layer.opacity = savedLayer.opacity;
                layer.blendMode = savedLayer.blendMode;
                layer.ctx.putImageData(savedLayer.imageData, 0, 0);
                updateThumbnail(layer);
            }
        });
        render();
        updateLayerUI();
        updateHistoryUI();
    }

    function updateHistoryUI() {
        historyListEl.innerHTML = '';
        historyStack.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `history-item ${idx === historyIndex ? 'current' : ''}`;
            div.innerText = item.name;
            div.onclick = () => {
                historyIndex = idx;
                restoreState(item.state);
            };
            historyListEl.appendChild(div);
        });
        historyListEl.scrollTop = historyListEl.scrollHeight;
    }

    /* --- Filters --- */
    function applyFilter(type) {
        const layer = layers.find(l => l.id === activeLayerId);
        if(!layer) return;
        
        const ctx = layer.ctx;
        const w = layer.canvas.width;
        const h = layer.canvas.height;
        const imageData = ctx.getImageData(0, 0, w, h);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i+1], b = data[i+2];
            
            if (type === 'grayscale') {
                const v = 0.3*r + 0.59*g + 0.11*b;
                data[i] = data[i+1] = data[i+2] = v;
            } 
            else if (type === 'invert') {
                data[i] = 255 - r;
                data[i+1] = 255 - g;
                data[i+2] = 255 - b;
            }
            else if (type === 'sepia') {
                data[i] = r*0.393 + g*0.769 + b*0.189;
                data[i+1] = r*0.349 + g*0.686 + b*0.168;
                data[i+2] = r*0.272 + g*0.534 + b*0.131;
            }
            else if (type === 'noise') {
                const rand = (0.5 - Math.random()) * 50;
                data[i] += rand;
                data[i+1] += rand;
                data[i+2] += rand;
            }
            else if (type === 'brightness') {
                data[i] += 40;
                data[i+1] += 40;
                data[i+2] += 40;
            }
        }

        // Blur requires a convolution (simplified box blur)
        if (type === 'blur') {
            // A bit expensive, doing a simple 3x3 box blur manually
            const copy = new Uint8ClampedArray(data);
            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    let r=0, g=0, b=0;
                    for(let ky=-1; ky<=1; ky++){
                        for(let kx=-1; kx<=1; kx++){
                            const idx = ((y+ky)*w + (x+kx))*4;
                            r+=copy[idx];
                            g+=copy[idx+1];
                            b+=copy[idx+2];
                        }
                    }
                    const idx = (y*w + x)*4;
                    data[idx] = r/9;
                    data[idx+1] = g/9;
                    data[idx+2] = b/9;
                }
            }
        }

        ctx.putImageData(imageData, 0, 0);
        render();
        updateThumbnail(layer);
        saveHistory('Filter: ' + type);
    }

    /* --- File I/O --- */
    function newFile() {
        document.getElementById('new-file-modal').style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('new-file-modal').style.display = 'none';
    }

    function confirmNewFile() {
        const w = parseInt(document.getElementById('new-width').value) || 800;
        const h = parseInt(document.getElementById('new-height').value) || 600;
        closeModal();
        init(w, h);
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = 'photojs-art.png';
        link.href = mainCanvas.toDataURL();
        link.click();
    }

    function openUpload() {
        document.getElementById('file-upload').click();
    }

    function handleUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    addLayer('Uploaded Image');
                    const layer = layers[layers.length-1];
                    // Resize canvas to fit image if desired, or draw image to fit
                    // For now, draw image centered
                    layer.ctx.drawImage(img, 0, 0, layer.canvas.width, layer.canvas.height);
                    render();
                    updateThumbnail(layer);
                    saveHistory('Upload Image');
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Hotkeys
    window.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'z') {
                e.preventDefault();
                if (e.shiftKey) redo(); else undo();
            }
        } else {
            if (e.key === 'b') setTool('brush');
            if (e.key === 'e') setTool('eraser');
            if (e.key === 'g') setTool('fill');
        }
    });

    // Start
    init(800, 600);

</script>
</body>
</html>