<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoEdit Pro - Image Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        /* Menu Bar */
        .menu-bar {
            height: 28px;
            background: #2d2d2d;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-bottom: 1px solid #3d3d3d;
        }

        .menu-item {
            padding: 4px 12px;
            cursor: pointer;
            font-size: 12px;
            position: relative;
        }

        .menu-item:hover {
            background: #3d3d3d;
        }

        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            min-width: 180px;
            z-index: 1000;
        }

        .menu-item:hover .dropdown {
            display: block;
        }

        .dropdown-item {
            padding: 8px 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        .dropdown-item:hover {
            background: #094771;
        }

        .dropdown-item .shortcut {
            color: #888;
            margin-left: 20px;
        }

        .separator {
            height: 1px;
            background: #3d3d3d;
            margin: 4px 0;
        }

        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 28px);
        }

        /* Tool Panel */
        .tool-panel {
            width: 48px;
            background: #2d2d2d;
            border-right: 1px solid #3d3d3d;
            display: flex;
            flex-direction: column;
            padding: 8px 4px;
            gap: 2px;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 18px;
            position: relative;
        }

        .tool-btn:hover {
            background: #3d3d3d;
        }

        .tool-btn.active {
            background: #094771;
            color: #fff;
        }

        .tool-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .color-picker-container {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
        }

        .color-squares {
            position: relative;
            width: 36px;
            height: 36px;
        }

        .foreground-color {
            position: absolute;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            background: #000;
            border: 2px solid #666;
            cursor: pointer;
        }

        .background-color {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 24px;
            height: 24px;
            background: #fff;
            border: 2px solid #666;
            cursor: pointer;
        }

        .swap-colors {
            position: absolute;
            top: -2px;
            right: -2px;
            font-size: 10px;
            cursor: pointer;
        }

        /* Options Bar */
        .options-bar {
            height: 40px;
            background: #2d2d2d;
            border-bottom: 1px solid #3d3d3d;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 15px;
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-group label {
            font-size: 11px;
            color: #aaa;
        }

        .option-group input[type="range"] {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            background: #555;
            border-radius: 2px;
        }

        .option-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        .option-group select {
            background: #3d3d3d;
            border: 1px solid #555;
            color: #fff;
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 3px;
        }

        .option-group input[type="number"] {
            width: 50px;
            background: #3d3d3d;
            border: 1px solid #555;
            color: #fff;
            padding: 4px;
            font-size: 11px;
            border-radius: 3px;
        }

        /* Workspace */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .canvas-container {
            flex: 1;
            overflow: auto;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .canvas-wrapper {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #mainCanvas {
            display: block;
            cursor: crosshair;
        }

        /* Right Panels */
        .right-panels {
            width: 280px;
            background: #2d2d2d;
            border-left: 1px solid #3d3d3d;
            display: flex;
            flex-direction: column;
        }

        .panel {
            border-bottom: 1px solid #3d3d3d;
        }

        .panel-header {
            padding: 10px 12px;
            background: #333;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .panel-header:hover {
            background: #3a3a3a;
        }

        .panel-content {
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Navigator Panel */
        .navigator-preview {
            width: 100%;
            height: 120px;
            background: #1a1a1a;
            border: 1px solid #444;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .navigator-preview canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-controls input[type="range"] {
            flex: 1;
        }

        .zoom-value {
            font-size: 11px;
            width: 45px;
            text-align: center;
        }

        /* Layers Panel */
        .layers-panel .panel-content {
            padding: 0;
        }

        .layer-controls {
            display: flex;
            padding: 8px;
            gap: 5px;
            border-bottom: 1px solid #3d3d3d;
        }

        .layer-control-btn {
            width: 28px;
            height: 28px;
            background: #3d3d3d;
            border: none;
            color: #ccc;
            cursor: pointer;
            border-radius: 3px;
            font-size: 14px;
        }

        .layer-control-btn:hover {
            background: #4d4d4d;
        }

        .blend-mode-select {
            flex: 1;
            background: #3d3d3d;
            border: 1px solid #555;
            color: #fff;
            padding: 4px;
            font-size: 11px;
        }

        .layer-opacity {
            display: flex;
            align-items: center;
            padding: 8px;
            gap: 8px;
            border-bottom: 1px solid #3d3d3d;
        }

        .layer-opacity label {
            font-size: 11px;
            color: #aaa;
        }

        .layer-opacity input {
            flex: 1;
        }

        .layer-opacity span {
            font-size: 11px;
            width: 35px;
            text-align: right;
        }

        .layers-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px;
            gap: 8px;
            cursor: pointer;
            border-bottom: 1px solid #3d3d3d;
        }

        .layer-item:hover {
            background: #3a3a3a;
        }

        .layer-item.active {
            background: #094771;
        }

        .layer-visibility {
            font-size: 14px;
            cursor: pointer;
        }

        .layer-thumbnail {
            width: 36px;
            height: 36px;
            background: #fff;
            border: 1px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .layer-thumbnail canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .layer-info {
            flex: 1;
        }

        .layer-name {
            font-size: 12px;
        }

        .layer-type {
            font-size: 10px;
            color: #888;
        }

        /* History Panel */
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            padding: 6px 10px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-item:hover {
            background: #3a3a3a;
        }

        .history-item.active {
            background: #094771;
        }

        .history-item.future {
            opacity: 0.5;
        }

        /* Color Panel */
        .color-sliders {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .color-slider-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-slider-row label {
            width: 15px;
            font-size: 11px;
        }

        .color-slider-row input[type="range"] {
            flex: 1;
        }

        .color-slider-row input[type="number"] {
            width: 45px;
            background: #3d3d3d;
            border: 1px solid #555;
            color: #fff;
            padding: 2px 4px;
            font-size: 11px;
        }

        .hex-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .hex-input input {
            flex: 1;
            background: #3d3d3d;
            border: 1px solid #555;
            color: #fff;
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Adjustments Panel */
        .adjustment-btns {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .adjustment-btn {
            width: 100%;
            aspect-ratio: 1;
            background: #3d3d3d;
            border: none;
            color: #ccc;
            cursor: pointer;
            border-radius: 3px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .adjustment-btn:hover {
            background: #4d4d4d;
        }

        /* Filters Dialog */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .dialog-overlay.active {
            display: flex;
        }

        .dialog {
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 5px;
            min-width: 400px;
            max-width: 600px;
        }

        .dialog-header {
            padding: 12px 15px;
            background: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
        }

        .dialog-header h3 {
            font-size: 14px;
            font-weight: 500;
        }

        .dialog-close {
            background: none;
            border: none;
            color: #ccc;
            font-size: 18px;
            cursor: pointer;
        }

        .dialog-body {
            padding: 20px;
        }

        .dialog-preview {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .dialog-preview canvas {
            max-width: 150px;
            max-height: 150px;
            border: 1px solid #555;
        }

        .dialog-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .dialog-slider {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dialog-slider label {
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .dialog-slider input[type="range"] {
            width: 100%;
        }

        .dialog-footer {
            padding: 12px 15px;
            border-top: 1px solid #555;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .dialog-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .dialog-btn.primary {
            background: #094771;
            color: #fff;
        }

        .dialog-btn.secondary {
            background: #3d3d3d;
            color: #fff;
        }

        /* Status Bar */
        .status-bar {
            height: 24px;
            background: #2d2d2d;
            border-top: 1px solid #3d3d3d;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 11px;
            color: #888;
            gap: 20px;
        }

        /* Brush Presets */
        .brush-presets {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }

        .brush-preset {
            aspect-ratio: 1;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brush-preset:hover {
            border-color: #666;
        }

        .brush-preset.active {
            border-color: #094771;
        }

        .brush-preview {
            width: 80%;
            height: 80%;
            background: #fff;
            border-radius: 50%;
        }

        /* Swatches */
        .swatches {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 3px;
        }

        .swatch {
            aspect-ratio: 1;
            border: 1px solid #444;
            cursor: pointer;
        }

        .swatch:hover {
            border-color: #fff;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Hidden inputs */
        .hidden-input {
            display: none;
        }

        /* Tool tooltips */
        .tool-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #1a1a1a;
            padding: 5px 10px;
            font-size: 11px;
            white-space: nowrap;
            border-radius: 3px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-left: 8px;
            z-index: 100;
        }

        .tool-btn:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Menu Bar -->
    <div class="menu-bar">
        <div class="menu-item">
            File
            <div class="dropdown">
                <div class="dropdown-item" onclick="newDocument()">New <span class="shortcut">Ctrl+N</span></div>
                <div class="dropdown-item" onclick="document.getElementById('fileInput').click()">Open <span class="shortcut">Ctrl+O</span></div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="saveImage('png')">Save as PNG <span class="shortcut">Ctrl+S</span></div>
                <div class="dropdown-item" onclick="saveImage('jpeg')">Save as JPEG</div>
                <div class="dropdown-item" onclick="saveImage('webp')">Save as WebP</div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="exportLayers()">Export Layers</div>
            </div>
        </div>
        <div class="menu-item">
            Edit
            <div class="dropdown">
                <div class="dropdown-item" onclick="undo()">Undo <span class="shortcut">Ctrl+Z</span></div>
                <div class="dropdown-item" onclick="redo()">Redo <span class="shortcut">Ctrl+Y</span></div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="cutSelection()">Cut <span class="shortcut">Ctrl+X</span></div>
                <div class="dropdown-item" onclick="copySelection()">Copy <span class="shortcut">Ctrl+C</span></div>
                <div class="dropdown-item" onclick="pasteClipboard()">Paste <span class="shortcut">Ctrl+V</span></div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="fillSelection()">Fill <span class="shortcut">Shift+F5</span></div>
                <div class="dropdown-item" onclick="strokeSelection()">Stroke</div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="selectAll()">Select All <span class="shortcut">Ctrl+A</span></div>
                <div class="dropdown-item" onclick="deselectAll()">Deselect <span class="shortcut">Ctrl+D</span></div>
                <div class="dropdown-item" onclick="invertSelection()">Invert Selection</div>
            </div>
        </div>
        <div class="menu-item">
            Image
            <div class="dropdown">
                <div class="dropdown-item" onclick="showResizeDialog()">Image Size</div>
                <div class="dropdown-item" onclick="showCanvasSizeDialog()">Canvas Size</div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="rotateCanvas(90)">Rotate 90Â° CW</div>
                <div class="dropdown-item" onclick="rotateCanvas(-90)">Rotate 90Â° CCW</div>
                <div class="dropdown-item" onclick="rotateCanvas(180)">Rotate 180Â°</div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="flipCanvas('horizontal')">Flip Horizontal</div>
                <div class="dropdown-item" onclick="flipCanvas('vertical')">Flip Vertical</div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="cropToSelection()">Crop</div>
                <div class="dropdown-item" onclick="trimCanvas()">Trim</div>
            </div>
        </div>
        <div class="menu-item">
            Layer
            <div class="dropdown">
                <div class="dropdown-item" onclick="addLayer()">New Layer <span class="shortcut">Ctrl+Shift+N</span></div>
                <div class="dropdown-item" onclick="duplicateLayer()">Duplicate Layer</div>
                <div class="dropdown-item" onclick="deleteLayer()">Delete Layer</div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="mergeDown()">Merge Down <span class="shortcut">Ctrl+E</span></div>
                <div class="dropdown-item" onclick="mergeVisible()">Merge Visible</div>
                <div class="dropdown-item" onclick="flattenImage()">Flatten Image</div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="moveLayerUp()">Move Up</div>
                <div class="dropdown-item" onclick="moveLayerDown()">Move Down</div>
            </div>
        </div>
        <div class="menu-item">
            Filter
            <div class="dropdown">
                <div class="dropdown-item" onclick="showFilterDialog('blur')">Blur</div>
                <div class="dropdown-item" onclick="showFilterDialog('sharpen')">Sharpen</div>
                <div class="dropdown-item" onclick="showFilterDialog('noise')">Add Noise</div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="applyFilter('grayscale')">Grayscale</div>
                <div class="dropdown-item" onclick="applyFilter('sepia')">Sepia</div>
                <div class="dropdown-item" onclick="applyFilter('invert')">Invert Colors</div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="showFilterDialog('brightness')">Brightness/Contrast</div>
                <div class="dropdown-item" onclick="showFilterDialog('hue')">Hue/Saturation</div>
                <div class="dropdown-item" onclick="showFilterDialog('levels')">Levels</div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="applyFilter('emboss')">Emboss</div>
                <div class="dropdown-item" onclick="applyFilter('edge')">Edge Detection</div>
                <div class="dropdown-item" onclick="showFilterDialog('pixelate')">Pixelate</div>
            </div>
        </div>
        <div class="menu-item">
            View
            <div class="dropdown">
                <div class="dropdown-item" onclick="setZoom(100)">Actual Pixels <span class="shortcut">Ctrl+1</span></div>
                <div class="dropdown-item" onclick="fitToScreen()">Fit on Screen <span class="shortcut">Ctrl+0</span></div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="zoomIn()">Zoom In <span class="shortcut">Ctrl++</span></div>
                <div class="dropdown-item" onclick="zoomOut()">Zoom Out <span class="shortcut">Ctrl+-</span></div>
                <div class="separator"></div>
                <div class="dropdown-item" onclick="toggleGrid()">Show Grid</div>
                <div class="dropdown-item" onclick="toggleGuides()">Show Guides</div>
            </div>
        </div>
        <div class="menu-item">
            Help
            <div class="dropdown">
                <div class="dropdown-item" onclick="showShortcuts()">Keyboard Shortcuts</div>
                <div class="dropdown-item" onclick="showAbout()">About</div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Tool Panel -->
        <div class="tool-panel">
            <button class="tool-btn active" data-tool="move" data-tooltip="Move Tool (V)" onclick="selectTool('move')">
                <svg viewBox="0 0 24 24"><path d="M13 6v5h5V7.75L22.25 12 18 16.25V13h-5v5h3.25L12 22.25 7.75 18H11v-5H6v3.25L1.75 12 6 7.75V11h5V6H7.75L12 1.75 16.25 6H13z"/></svg>
            </button>
            <button class="tool-btn" data-tool="select" data-tooltip="Rectangular Marquee (M)" onclick="selectTool('select')">
                <svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm2 2v14h14V5H5z" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="4 2"/></svg>
            </button>
            <button class="tool-btn" data-tool="lasso" data-tooltip="Lasso Tool (L)" onclick="selectTool('lasso')">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c1.85 0 3.58-.5 5.07-1.37l-1.5-1.5C14.46 19.69 13.27 20 12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8c0 1.27-.31 2.46-.87 3.53l1.5 1.5C21.5 15.54 22 13.81 22 12c0-5.52-4.48-10-10-10zm6.5 16.5l-2.12-2.12 1.41-1.41L20 17.17V21h-3.83l2.21-2.21 1.41 1.41-2.29 2.3z"/></svg>
            </button>
            <button class="tool-btn" data-tool="crop" data-tooltip="Crop Tool (C)" onclick="selectTool('crop')">
                <svg viewBox="0 0 24 24"><path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/></svg>
            </button>
            <button class="tool-btn" data-tool="eyedropper" data-tooltip="Eyedropper (I)" onclick="selectTool('eyedropper')">
                <svg viewBox="0 0 24 24"><path d="M20.71 5.63l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-3.12 3.12-1.93-1.91-1.41 1.41 1.42 1.42L3 16.25V21h4.75l8.92-8.92 1.42 1.42 1.41-1.41-1.92-1.92 3.12-3.12c.4-.4.4-1.03.01-1.42zM6.92 19L5 17.08l8.06-8.06 1.92 1.92L6.92 19z"/></svg>
            </button>
            <button class="tool-btn" data-tool="brush" data-tooltip="Brush Tool (B)" onclick="selectTool('brush')">
                <svg viewBox="0 0 24 24"><path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34c-.39-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.02 0-1.41z"/></svg>
            </button>
            <button class="tool-btn" data-tool="eraser" data-tooltip="Eraser Tool (E)" onclick="selectTool('eraser')">
                <svg viewBox="0 0 24 24"><path d="M15.14 3c-.51 0-1.02.2-1.41.59L2.59 14.73c-.78.78-.78 2.05 0 2.83l3.85 3.85c.39.39.9.59 1.41.59h9.9l5.66-5.66c.78-.78.78-2.05 0-2.83L15.14 3zM6.39 19L4 16.61l8.73-8.73 2.39 2.39L6.39 19z"/></svg>
            </button>
            <button class="tool-btn" data-tool="fill" data-tooltip="Paint Bucket (G)" onclick="selectTool('fill')">
                <svg viewBox="0 0 24 24"><path d="M16.56 8.94L7.62 0 6.21 1.41l2.38 2.38-5.15 5.15c-.59.59-.59 1.54 0 2.12l5.5 5.5c.29.29.68.44 1.06.44s.77-.15 1.06-.44l5.5-5.5c.59-.58.59-1.53 0-2.12zM5.21 10L10 5.21 14.79 10H5.21zM19 11.5s-2 2.17-2 3.5c0 1.1.9 2 2 2s2-.9 2-2c0-1.33-2-3.5-2-3.5z"/></svg>
            </button>
            <button class="tool-btn" data-tool="gradient" data-tooltip="Gradient Tool" onclick="selectTool('gradient')">
                <svg viewBox="0 0 24 24"><defs><linearGradient id="grad"><stop offset="0%" stop-color="#000"/><stop offset="100%" stop-color="#fff"/></linearGradient></defs><rect x="3" y="3" width="18" height="18" rx="2" fill="url(#grad)"/></svg>
            </button>
            <button class="tool-btn" data-tool="text" data-tooltip="Text Tool (T)" onclick="selectTool('text')">
                <svg viewBox="0 0 24 24"><path d="M5 4v3h5.5v12h3V7H19V4H5z"/></svg>
            </button>
            <button class="tool-btn" data-tool="line" data-tooltip="Line Tool" onclick="selectTool('line')">
                <svg viewBox="0 0 24 24"><line x1="4" y1="20" x2="20" y2="4" stroke="currentColor" stroke-width="2"/></svg>
            </button>
            <button class="tool-btn" data-tool="rectangle" data-tooltip="Rectangle Tool (U)" onclick="selectTool('rectangle')">
                <svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="14" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            </button>
            <button class="tool-btn" data-tool="ellipse" data-tooltip="Ellipse Tool" onclick="selectTool('ellipse')">
                <svg viewBox="0 0 24 24"><ellipse cx="12" cy="12" rx="9" ry="6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            </button>
            <button class="tool-btn" data-tool="zoom" data-tooltip="Zoom Tool (Z)" onclick="selectTool('zoom')">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z"/></svg>
            </button>
            <button class="tool-btn" data-tool="hand" data-tooltip="Hand Tool (H)" onclick="selectTool('hand')">
                <svg viewBox="0 0 24 24"><path d="M18 11V6.83c0-.89-.54-1.68-1.36-2.01L12 3 7.36 4.82C6.54 5.15 6 5.94 6 6.83V11l-2 2v7h16v-7l-2-2zm-6-5.5l4 1.5V11H8V7l4-1.5zM18 18H6v-3.17l2-2V16h8v-3.17l2 2V18z"/></svg>
            </button>

            <div class="color-picker-container">
                <div class="color-squares">
                    <div class="swap-colors" onclick="swapColors()">â‡„</div>
                    <div class="foreground-color" id="foregroundColor" onclick="openColorPicker('foreground')"></div>
                    <div class="background-color" id="backgroundColor" onclick="openColorPicker('background')"></div>
                </div>
            </div>
        </div>

        <!-- Workspace -->
        <div class="workspace">
            <div class="options-bar" id="optionsBar">
                <div class="option-group">
                    <label>Size:</label>
                    <input type="range" id="brushSize" min="1" max="200" value="10" oninput="updateBrushSize(this.value)">
                    <input type="number" id="brushSizeNum" min="1" max="200" value="10" style="width:45px" onchange="updateBrushSize(this.value)">
                </div>
                <div class="option-group">
                    <label>Opacity:</label>
                    <input type="range" id="brushOpacity" min="0" max="100" value="100" oninput="updateBrushOpacity(this.value)">
                    <span id="brushOpacityVal">100%</span>
                </div>
                <div class="option-group">
                    <label>Hardness:</label>
                    <input type="range" id="brushHardness" min="0" max="100" value="100" oninput="updateBrushHardness(this.value)">
                    <span id="brushHardnessVal">100%</span>
                </div>
                <div class="option-group">
                    <label>Mode:</label>
                    <select id="brushMode" onchange="updateBrushMode(this.value)">
                        <option value="source-over">Normal</option>
                        <option value="multiply">Multiply</option>
                        <option value="screen">Screen</option>
                        <option value="overlay">Overlay</option>
                        <option value="darken">Darken</option>
                        <option value="lighten">Lighten</option>
                        <option value="color-dodge">Color Dodge</option>
                        <option value="color-burn">Color Burn</option>
                        <option value="hard-light">Hard Light</option>
                        <option value="soft-light">Soft Light</option>
                        <option value="difference">Difference</option>
                        <option value="exclusion">Exclusion</option>
                        <option value="hue">Hue</option>
                        <option value="saturation">Saturation</option>
                        <option value="color">Color</option>
                        <option value="luminosity">Luminosity</option>
                    </select>
                </div>
            </div>

            <div class="canvas-container" id="canvasContainer">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <canvas id="mainCanvas" width="800" height="600"></canvas>
                </div>
            </div>

            <div class="status-bar">
                <span id="docSize">800 Ã— 600 px</span>
                <span id="zoomLevel">100%</span>
                <span id="cursorPos">X: 0 Y: 0</span>
                <span id="colorInfo">RGB: 0, 0, 0</span>
            </div>
        </div>

        <!-- Right Panels -->
        <div class="right-panels">
            <!-- Navigator Panel -->
            <div class="panel">
                <div class="panel-header">Navigator</div>
                <div class="panel-content">
                    <div class="navigator-preview">
                        <canvas id="navigatorCanvas"></canvas>
                    </div>
                    <div class="zoom-controls">
                        <span style="font-size:10px">âˆ’</span>
                        <input type="range" id="zoomSlider" min="10" max="500" value="100" oninput="setZoom(this.value)">
                        <span style="font-size:10px">+</span>
                        <span class="zoom-value" id="zoomValue">100%</span>
                    </div>
                </div>
            </div>

            <!-- Color Panel -->
            <div class="panel">
                <div class="panel-header">Color</div>
                <div class="panel-content">
                    <div class="color-sliders">
                        <div class="color-slider-row">
                            <label>R</label>
                            <input type="range" id="colorR" min="0" max="255" value="0" oninput="updateColorFromSliders()">
                            <input type="number" min="0" max="255" value="0" id="colorRNum" onchange="updateColorFromSliders()">
                        </div>
                        <div class="color-slider-row">
                            <label>G</label>
                            <input type="range" id="colorG" min="0" max="255" value="0" oninput="updateColorFromSliders()">
                            <input type="number" min="0" max="255" value="0" id="colorGNum" onchange="updateColorFromSliders()">
                        </div>
                        <div class="color-slider-row">
                            <label>B</label>
                            <input type="range" id="colorB" min="0" max="255" value="0" oninput="updateColorFromSliders()">
                            <input type="number" min="0" max="255" value="0" id="colorBNum" onchange="updateColorFromSliders()">
                        </div>
                    </div>
                    <div class="hex-input">
                        <label>#</label>
                        <input type="text" id="hexColor" value="000000" maxlength="6" onchange="updateColorFromHex()">
                    </div>
                    <div style="margin-top:15px">
                        <div style="font-size:11px;margin-bottom:8px;color:#aaa">Swatches</div>
                        <div class="swatches" id="swatches"></div>
                    </div>
                </div>
            </div>

            <!-- Layers Panel -->
            <div class="panel layers-panel">
                <div class="panel-header">
                    Layers
                    <span style="font-size:10px;color:#888" id="layerCount">1 Layer</span>
                </div>
                <div class="panel-content">
                    <div class="layer-controls">
                        <select class="blend-mode-select" id="layerBlendMode" onchange="updateLayerBlendMode(this.value)">
                            <option value="source-over">Normal</option>
                            <option value="multiply">Multiply</option>
                            <option value="screen">Screen</option>
                            <option value="overlay">Overlay</option>
                            <option value="darken">Darken</option>
                            <option value="lighten">Lighten</option>
                            <option value="color-dodge">Color Dodge</option>
                            <option value="color-burn">Color Burn</option>
                            <option value="hard-light">Hard Light</option>
                            <option value="soft-light">Soft Light</option>
                            <option value="difference">Difference</option>
                            <option value="exclusion">Exclusion</option>
                        </select>
                    </div>
                    <div class="layer-opacity">
                        <label>Opacity:</label>
                        <input type="range" id="layerOpacity" min="0" max="100" value="100" oninput="updateLayerOpacity(this.value)">
                        <span id="layerOpacityVal">100%</span>
                    </div>
                    <div class="layers-list" id="layersList"></div>
                    <div class="layer-controls" style="border-top:1px solid #3d3d3d;border-bottom:none">
                        <button class="layer-control-btn" onclick="addLayer()" title="New Layer">+</button>
                        <button class="layer-control-btn" onclick="duplicateLayer()" title="Duplicate Layer">â§‰</button>
                        <button class="layer-control-btn" onclick="deleteLayer()" title="Delete Layer">ðŸ—‘</button>
                        <button class="layer-control-btn" onclick="mergeDown()" title="Merge Down">â¤“</button>
                    </div>
                </div>
            </div>

            <!-- History Panel -->
            <div class="panel">
                <div class="panel-header">
                    History
                    <span style="font-size:10px;color:#888" id="historyCount">0 states</span>
                </div>
                <div class="panel-content" style="padding:0">
                    <div class="history-list" id="historyList"></div>
                </div>
            </div>

            <!-- Brush Presets Panel -->
            <div class="panel">
                <div class="panel-header">Brush Presets</div>
                <div class="panel-content">
                    <div class="brush-presets" id="brushPresets"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Dialog -->
    <div class="dialog-overlay" id="filterDialog">
        <div class="dialog">
            <div class="dialog-header">
                <h3 id="filterDialogTitle">Filter</h3>
                <button class="dialog-close" onclick="closeFilterDialog()">Ã—</button>
            </div>
            <div class="dialog-body">
                <div class="dialog-preview">
                    <div>
                        <div style="font-size:11px;margin-bottom:5px;color:#aaa">Before</div>
                        <canvas id="filterPreviewBefore" width="150" height="150"></canvas>
                    </div>
                    <div>
                        <div style="font-size:11px;margin-bottom:5px;color:#aaa">After</div>
                        <canvas id="filterPreviewAfter" width="150" height="150"></canvas>
                    </div>
                </div>
                <div class="dialog-controls" id="filterControls"></div>
            </div>
            <div class="dialog-footer">
                <button class="dialog-btn secondary" onclick="closeFilterDialog()">Cancel</button>
                <button class="dialog-btn primary" onclick="applyFilterFromDialog()">Apply</button>
            </div>
        </div>
    </div>

    <!-- New Document Dialog -->
    <div class="dialog-overlay" id="newDocDialog">
        <div class="dialog">
            <div class="dialog-header">
                <h3>New Document</h3>
                <button class="dialog-close" onclick="closeNewDocDialog()">Ã—</button>
            </div>
            <div class="dialog-body">
                <div class="dialog-controls">
                    <div class="dialog-slider">
                        <label>Width: <span id="newWidthVal">800</span> px</label>
                        <input type="range" id="newWidth" min="100" max="4000" value="800" oninput="document.getElementById('newWidthVal').textContent=this.value">
                    </div>
                    <div class="dialog-slider">
                        <label>Height: <span id="newHeightVal">600</span> px</label>
                        <input type="range" id="newHeight" min="100" max="4000" value="600" oninput="document.getElementById('newHeightVal').textContent=this.value">
                    </div>
                    <div style="display:flex;gap:10px;align-items:center">
                        <label style="font-size:12px">Background:</label>
                        <select id="newBackground" style="flex:1;padding:5px;background:#3d3d3d;border:1px solid #555;color:#fff">
                            <option value="white">White</option>
                            <option value="black">Black</option>
                            <option value="transparent">Transparent</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="dialog-btn secondary" onclick="closeNewDocDialog()">Cancel</button>
                <button class="dialog-btn primary" onclick="createNewDocument()">Create</button>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="fileInput" class="hidden-input" accept="image/*" onchange="loadImage(event)">
    <input type="color" id="colorPickerInput" class="hidden-input" onchange="handleColorPick(event)">

    <script>
        // ==================== CORE VARIABLES ====================
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        
        let layers = [];
        let activeLayerIndex = 0;
        let history = [];
        let historyIndex = -1;
        let maxHistory = 50;
        
        let currentTool = 'brush';
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        let foregroundColor = '#000000';
        let backgroundColor = '#ffffff';
        
        let brushSize = 10;
        let brushOpacity = 100;
        let brushHardness = 100;
        let brushMode = 'source-over';
        
        let zoom = 100;
        let panX = 0;
        let panY = 0;
        
        let selection = null;
        let selectionStart = null;
        
        let currentFilter = null;
        let filterValues = {};

        // ==================== INITIALIZATION ====================
        function init() {
            createLayer('Background', true);
            fillLayer(0, '#ffffff');
            saveState('New Document');
            updateLayersPanel();
            updateHistoryPanel();
            initSwatches();
            initBrushPresets();
            updateNavigator();
            render();
        }

        // ==================== LAYER MANAGEMENT ====================
        class Layer {
            constructor(name, width, height) {
                this.name = name;
                this.canvas = document.createElement('canvas');
                this.canvas.width = width;
                this.canvas.height = height;
                this.ctx = this.canvas.getContext('2d');
                this.visible = true;
                this.opacity = 100;
                this.blendMode = 'source-over';
                this.locked = false;
            }
        }

        function createLayer(name, isBackground = false) {
            const layer = new Layer(name || `Layer ${layers.length + 1}`, canvas.width, canvas.height);
            if (isBackground) {
                layers.unshift(layer);
                activeLayerIndex = 0;
            } else {
                layers.splice(activeLayerIndex + 1, 0, layer);
                activeLayerIndex++;
            }
            updateLayersPanel();
            return layer;
        }

        function addLayer() {
            createLayer();
            saveState('New Layer');
            render();
        }

        function deleteLayer() {
            if (layers.length <= 1) return;
            layers.splice(activeLayerIndex, 1);
            activeLayerIndex = Math.min(activeLayerIndex, layers.length - 1);
            saveState('Delete Layer');
            updateLayersPanel();
            render();
        }

        function duplicateLayer() {
            const source = layers[activeLayerIndex];
            const newLayer = new Layer(source.name + ' Copy', canvas.width, canvas.height);
            newLayer.ctx.drawImage(source.canvas, 0, 0);
            newLayer.opacity = source.opacity;
            newLayer.blendMode = source.blendMode;
            layers.splice(activeLayerIndex + 1, 0, newLayer);
            activeLayerIndex++;
            saveState('Duplicate Layer');
            updateLayersPanel();
            render();
        }

        function selectLayer(index) {
            activeLayerIndex = index;
            updateLayersPanel();
            document.getElementById('layerOpacity').value = layers[index].opacity;
            document.getElementById('layerOpacityVal').textContent = layers[index].opacity + '%';
            document.getElementById('layerBlendMode').value = layers[index].blendMode;
        }

        function toggleLayerVisibility(index) {
            layers[index].visible = !layers[index].visible;
            updateLayersPanel();
            render();
        }

        function moveLayerUp() {
            if (activeLayerIndex >= layers.length - 1) return;
            [layers[activeLayerIndex], layers[activeLayerIndex + 1]] = [layers[activeLayerIndex + 1], layers[activeLayerIndex]];
            activeLayerIndex++;
            saveState('Move Layer');
            updateLayersPanel();
            render();
        }

        function moveLayerDown() {
            if (activeLayerIndex <= 0) return;
            [layers[activeLayerIndex], layers[activeLayerIndex - 1]] = [layers[activeLayerIndex - 1], layers[activeLayerIndex]];
            activeLayerIndex--;
            saveState('Move Layer');
            updateLayersPanel();
            render();
        }

        function mergeDown() {
            if (activeLayerIndex <= 0) return;
            const upper = layers[activeLayerIndex];
            const lower = layers[activeLayerIndex - 1];
            lower.ctx.globalAlpha = upper.opacity / 100;
            lower.ctx.globalCompositeOperation = upper.blendMode;
            lower.ctx.drawImage(upper.canvas, 0, 0);
            lower.ctx.globalAlpha = 1;
            lower.ctx.globalCompositeOperation = 'source-over';
            layers.splice(activeLayerIndex, 1);
            activeLayerIndex--;
            saveState('Merge Down');
            updateLayersPanel();
            render();
        }

        function mergeVisible() {
            const merged = new Layer('Merged', canvas.width, canvas.height);
            layers.forEach(layer => {
                if (layer.visible) {
                    merged.ctx.globalAlpha = layer.opacity / 100;
                    merged.ctx.globalCompositeOperation = layer.blendMode;
                    merged.ctx.drawImage(layer.canvas, 0, 0);
                }
            });
            merged.ctx.globalAlpha = 1;
            merged.ctx.globalCompositeOperation = 'source-over';
            layers = [merged];
            activeLayerIndex = 0;
            saveState('Merge Visible');
            updateLayersPanel();
            render();
        }

        function flattenImage() {
            const flattened = new Layer('Background', canvas.width, canvas.height);
            flattened.ctx.fillStyle = '#ffffff';
            flattened.ctx.fillRect(0, 0, canvas.width, canvas.height);
            layers.forEach(layer => {
                if (layer.visible) {
                    flattened.ctx.globalAlpha = layer.opacity / 100;
                    flattened.ctx.globalCompositeOperation = layer.blendMode;
                    flattened.ctx.drawImage(layer.canvas, 0, 0);
                }
            });
            flattened.ctx.globalAlpha = 1;
            flattened.ctx.globalCompositeOperation = 'source-over';
            layers = [flattened];
            activeLayerIndex = 0;
            saveState('Flatten Image');
            updateLayersPanel();
            render();
        }

        function fillLayer(index, color) {
            layers[index].ctx.fillStyle = color;
            layers[index].ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function updateLayerOpacity(value) {
            layers[activeLayerIndex].opacity = parseInt(value);
            document.getElementById('layerOpacityVal').textContent = value + '%';
            render();
        }

        function updateLayerBlendMode(value) {
            layers[activeLayerIndex].blendMode = value;
            render();
        }

        function updateLayersPanel() {
            const list = document.getElementById('layersList');
            list.innerHTML = '';
            
            for (let i = layers.length - 1; i >= 0; i--) {
                const layer = layers[i];
                const item = document.createElement('div');
                item.className = `layer-item ${i === activeLayerIndex ? 'active' : ''}`;
                item.onclick = () => selectLayer(i);
                
                const thumb = document.createElement('canvas');
                thumb.width = 36;
                thumb.height = 36;
                const thumbCtx = thumb.getContext('2d');
                
                // Checkerboard for transparency
                for (let x = 0; x < 36; x += 6) {
                    for (let y = 0; y < 36; y += 6) {
                        thumbCtx.fillStyle = (x + y) % 12 === 0 ? '#999' : '#666';
                        thumbCtx.fillRect(x, y, 6, 6);
                    }
                }
                
                const scale = Math.min(36 / layer.canvas.width, 36 / layer.canvas.height);
                const w = layer.canvas.width * scale;
                const h = layer.canvas.height * scale;
                thumbCtx.drawImage(layer.canvas, (36 - w) / 2, (36 - h) / 2, w, h);
                
                item.innerHTML = `
                    <span class="layer-visibility" onclick="event.stopPropagation(); toggleLayerVisibility(${i})">${layer.visible ? 'ðŸ‘' : 'â—¯'}</span>
                    <div class="layer-thumbnail"></div>
                    <div class="layer-info">
                        <div class="layer-name">${layer.name}</div>
                        <div class="layer-type">${layer.blendMode === 'source-over' ? 'Normal' : layer.blendMode}</div>
                    </div>
                `;
                item.querySelector('.layer-thumbnail').appendChild(thumb);
                list.appendChild(item);
            }
            
            document.getElementById('layerCount').textContent = `${layers.length} Layer${layers.length !== 1 ? 's' : ''}`;
        }

        // ==================== HISTORY MANAGEMENT ====================
        function saveState(action) {
            // Remove future states
            history = history.slice(0, historyIndex + 1);
            
            // Save current state
            const state = {
                action: action,
                layers: layers.map(layer => {
                    const copy = document.createElement('canvas');
                    copy.width = layer.canvas.width;
                    copy.height = layer.canvas.height;
                    copy.getContext('2d').drawImage(layer.canvas, 0, 0);
                    return {
                        name: layer.name,
                        canvas: copy,
                        visible: layer.visible,
                        opacity: layer.opacity,
                        blendMode: layer.blendMode
                    };
                }),
                activeLayerIndex: activeLayerIndex,
                canvasWidth: canvas.width,
                canvasHeight: canvas.height
            };
            
            history.push(state);
            if (history.length > maxHistory) {
                history.shift();
            }
            historyIndex = history.length - 1;
            updateHistoryPanel();
        }

        function undo() {
            if (historyIndex <= 0) return;
            historyIndex--;
            restoreState(history[historyIndex]);
        }

        function redo() {
            if (historyIndex >= history.length - 1) return;
            historyIndex++;
            restoreState(history[historyIndex]);
        }

        function restoreState(state) {
            canvas.width = state.canvasWidth;
            canvas.height = state.canvasHeight;
            
            layers = state.layers.map(layerData => {
                const layer = new Layer(layerData.name, layerData.canvas.width, layerData.canvas.height);
                layer.ctx.drawImage(layerData.canvas, 0, 0);
                layer.visible = layerData.visible;
                layer.opacity = layerData.opacity;
                layer.blendMode = layerData.blendMode;
                return layer;
            });
            
            activeLayerIndex = state.activeLayerIndex;
            updateLayersPanel();
            updateHistoryPanel();
            updateDocInfo();
            render();
        }

        function goToHistoryState(index) {
            if (index === historyIndex) return;
            historyIndex = index;
            restoreState(history[index]);
        }

        function updateHistoryPanel() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            history.forEach((state, i) => {
                const item = document.createElement('div');
                item.className = `history-item ${i === historyIndex ? 'active' : ''} ${i > historyIndex ? 'future' : ''}`;
                item.onclick = () => goToHistoryState(i);
                item.innerHTML = `<span>ðŸ“</span> ${state.action}`;
                list.appendChild(item);
            });
            
            document.getElementById('historyCount').textContent = `${history.length} states`;
            list.scrollTop = list.scrollHeight;
        }

        // ==================== TOOLS ====================
        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tool === tool);
            });
            
            // Update cursor
            const cursorMap = {
                'brush': 'crosshair',
                'eraser': 'crosshair',
                'eyedropper': 'crosshair',
                'move': 'move',
                'hand': 'grab',
                'zoom': 'zoom-in',
                'text': 'text',
                'fill': 'crosshair',
                'select': 'crosshair',
                'crop': 'crosshair'
            };
            canvas.style.cursor = cursorMap[tool] || 'crosshair';
        }

        function updateBrushSize(value) {
            brushSize = parseInt(value);
            document.getElementById('brushSize').value = value;
            document.getElementById('brushSizeNum').value = value;
        }

        function updateBrushOpacity(value) {
            brushOpacity = parseInt(value);
            document.getElementById('brushOpacityVal').textContent = value + '%';
        }

        function updateBrushHardness(value) {
            brushHardness = parseInt(value);
            document.getElementById('brushHardnessVal').textContent = value + '%';
        }

        function updateBrushMode(value) {
            brushMode = value;
        }

        // ==================== DRAWING ====================
        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            const coords = getCanvasCoords(e);
            lastX = coords.x;
            lastY = coords.y;
            
            switch (currentTool) {
                case 'brush':
                case 'eraser':
                    isDrawing = true;
                    draw(coords.x, coords.y);
                    break;
                case 'eyedropper':
                    pickColor(coords.x, coords.y);
                    break;
                case 'fill':
                    floodFill(Math.floor(coords.x), Math.floor(coords.y));
                    break;
                case 'select':
                    startSelection(coords.x, coords.y);
                    break;
                case 'zoom':
                    if (e.altKey) {
                        zoomOut();
                    } else {
                        zoomIn();
                    }
                    break;
                case 'line':
                case 'rectangle':
                case 'ellipse':
                    isDrawing = true;
                    selectionStart = coords;
                    break;
                case 'text':
                    addText(coords.x, coords.y);
                    break;
                case 'gradient':
                    isDrawing = true;
                    selectionStart = coords;
                    break;
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const coords = getCanvasCoords(e);
            
            document.getElementById('cursorPos').textContent = `X: ${Math.floor(coords.x)} Y: ${Math.floor(coords.y)}`;
            
            if (isDrawing) {
                switch (currentTool) {
                    case 'brush':
                    case 'eraser':
                        draw(coords.x, coords.y);
                        break;
                    case 'select':
                        updateSelection(coords.x, coords.y);
                        break;
                    case 'line':
                    case 'rectangle':
                    case 'ellipse':
                    case 'gradient':
                        previewShape(coords.x, coords.y);
                        break;
                }
            }
            
            lastX = coords.x;
            lastY = coords.y;
        });

        canvas.addEventListener('mouseup', (e) => {
            if (isDrawing) {
                const coords = getCanvasCoords(e);
                
                switch (currentTool) {
                    case 'brush':
                    case 'eraser':
                        saveState(currentTool === 'brush' ? 'Brush Stroke' : 'Eraser');
                        break;
                    case 'line':
                        drawLine(selectionStart.x, selectionStart.y, coords.x, coords.y);
                        saveState('Line');
                        break;
                    case 'rectangle':
                        drawRectangle(selectionStart.x, selectionStart.y, coords.x, coords.y);
                        saveState('Rectangle');
                        break;
                    case 'ellipse':
                        drawEllipse(selectionStart.x, selectionStart.y, coords.x, coords.y);
                        saveState('Ellipse');
                        break;
                    case 'gradient':
                        drawGradient(selectionStart.x, selectionStart.y, coords.x, coords.y);
                        saveState('Gradient');
                        break;
                    case 'select':
                        finalizeSelection();
                        break;
                }
            }
            isDrawing = false;
            render();
            updateNavigator();
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });

        function draw(x, y) {
            const layer = layers[activeLayerIndex];
            const lctx = layer.ctx;
            
            lctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : brushMode;
            lctx.globalAlpha = brushOpacity / 100;
            lctx.lineWidth = brushSize;
            lctx.lineCap = 'round';
            lctx.lineJoin = 'round';
            lctx.strokeStyle = foregroundColor;
            
            // Brush hardness effect
            if (brushHardness < 100) {
                lctx.shadowBlur = (100 - brushHardness) / 5;
                lctx.shadowColor = foregroundColor;
            } else {
                lctx.shadowBlur = 0;
            }
            
            lctx.beginPath();
            lctx.moveTo(lastX, lastY);
            lctx.lineTo(x, y);
            lctx.stroke();
            
            lctx.globalAlpha = 1;
            lctx.globalCompositeOperation = 'source-over';
            lctx.shadowBlur = 0;
            
            render();
        }

        function drawLine(x1, y1, x2, y2) {
            const layer = layers[activeLayerIndex];
            const lctx = layer.ctx;
            
            lctx.globalAlpha = brushOpacity / 100;
            lctx.strokeStyle = foregroundColor;
            lctx.lineWidth = brushSize;
            lctx.lineCap = 'round';
            
            lctx.beginPath();
            lctx.moveTo(x1, y1);
            lctx.lineTo(x2, y2);
            lctx.stroke();
            
            lctx.globalAlpha = 1;
        }

        function drawRectangle(x1, y1, x2, y2) {
            const layer = layers[activeLayerIndex];
            const lctx = layer.ctx;
            
            lctx.globalAlpha = brushOpacity / 100;
            lctx.strokeStyle = foregroundColor;
            lctx.lineWidth = brushSize;
            
            lctx.strokeRect(
                Math.min(x1, x2),
                Math.min(y1, y2),
                Math.abs(x2 - x1),
                Math.abs(y2 - y1)
            );
            
            lctx.globalAlpha = 1;
        }

        function drawEllipse(x1, y1, x2, y2) {
            const layer = layers[activeLayerIndex];
            const lctx = layer.ctx;
            
            const cx = (x1 + x2) / 2;
            const cy = (y1 + y2) / 2;
            const rx = Math.abs(x2 - x1) / 2;
            const ry = Math.abs(y2 - y1) / 2;
            
            lctx.globalAlpha = brushOpacity / 100;
            lctx.strokeStyle = foregroundColor;
            lctx.lineWidth = brushSize;
            
            lctx.beginPath();
            lctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
            lctx.stroke();
            
            lctx.globalAlpha = 1;
        }

        function drawGradient(x1, y1, x2, y2) {
            const layer = layers[activeLayerIndex];
            const lctx = layer.ctx;
            
            const gradient = lctx.createLinearGradient(x1, y1, x2, y2);
            gradient.addColorStop(0, foregroundColor);
            gradient.addColorStop(1, backgroundColor);
            
            lctx.globalAlpha = brushOpacity / 100;
            lctx.fillStyle = gradient;
            lctx.fillRect(0, 0, canvas.width, canvas.height);
            
            lctx.globalAlpha = 1;
        }

        function previewShape(x, y) {
            render();
            
            ctx.globalAlpha = 0.5;
            ctx.strokeStyle = foregroundColor;
            ctx.lineWidth = brushSize * zoom / 100;
            ctx.setLineDash([5, 5]);
            
            const sx = selectionStart.x * zoom / 100;
            const sy = selectionStart.y * zoom / 100;
            const ex = x * zoom / 100;
            const ey = y * zoom / 100;
            
            ctx.beginPath();
            
            switch (currentTool) {
                case 'line':
                    ctx.moveTo(sx, sy);
                    ctx.lineTo(ex, ey);
                    break;
                case 'rectangle':
                    ctx.rect(Math.min(sx, ex), Math.min(sy, ey), Math.abs(ex - sx), Math.abs(ey - sy));
                    break;
                case 'ellipse':
                    ctx.ellipse((sx + ex) / 2, (sy + ey) / 2, Math.abs(ex - sx) / 2, Math.abs(ey - sy) / 2, 0, 0, Math.PI * 2);
                    break;
                case 'gradient':
                    ctx.moveTo(sx, sy);
                    ctx.lineTo(ex, ey);
                    break;
            }
            
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.globalAlpha = 1;
        }

        // ==================== SELECTION ====================
        function startSelection(x, y) {
            isDrawing = true;
            selectionStart = { x, y };
            selection = { x, y, width: 0, height: 0 };
        }

        function updateSelection(x, y) {
            if (!selectionStart) return;
            
            selection = {
                x: Math.min(selectionStart.x, x),
                y: Math.min(selectionStart.y, y),
                width: Math.abs(x - selectionStart.x),
                height: Math.abs(y - selectionStart.y)
            };
            
            render();
            drawSelectionRect();
        }

        function finalizeSelection() {
            if (selection && selection.width > 0 && selection.height > 0) {
                drawSelectionRect();
            } else {
                selection = null;
            }
        }

        function drawSelectionRect() {
            if (!selection) return;
            
            ctx.save();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.strokeRect(
                selection.x * zoom / 100,
                selection.y * zoom / 100,
                selection.width * zoom / 100,
                selection.height * zoom / 100
            );
            ctx.strokeStyle = '#000';
            ctx.lineDashOffset = 4;
            ctx.strokeRect(
                selection.x * zoom / 100,
                selection.y * zoom / 100,
                selection.width * zoom / 100,
                selection.height * zoom / 100
            );
            ctx.restore();
        }

        function selectAll() {
            selection = { x: 0, y: 0, width: canvas.width, height: canvas.height };
            render();
            drawSelectionRect();
        }

        function deselectAll() {
            selection = null;
            render();
        }

        function invertSelection() {
            // Simplified - just deselect for now
            deselectAll();
        }

        // ==================== COLOR TOOLS ====================
        function pickColor(x, y) {
            const pixel = layers[activeLayerIndex].ctx.getImageData(Math.floor(x), Math.floor(y), 1, 1).data;
            foregroundColor = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;
            updateColorDisplay();
            document.getElementById('colorInfo').textContent = `RGB: ${pixel[0]}, ${pixel[1]}, ${pixel[2]}`;
        }

        function floodFill(startX, startY) {
            const layer = layers[activeLayerIndex];
            const imageData = layer.ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const startPos = (startY * canvas.width + startX) * 4;
            const startR = data[startPos];
            const startG = data[startPos + 1];
            const startB = data[startPos + 2];
            const startA = data[startPos + 3];
            
            // Parse fill color
            const fillColor = hexToRgb(foregroundColor);
            
            // Don't fill if same color
            if (startR === fillColor.r && startG === fillColor.g && startB === fillColor.b) return;
            
            const stack = [[startX, startY]];
            const tolerance = 32;
            
            function matchesStart(pos) {
                return Math.abs(data[pos] - startR) <= tolerance &&
                       Math.abs(data[pos + 1] - startG) <= tolerance &&
                       Math.abs(data[pos + 2] - startB) <= tolerance &&
                       Math.abs(data[pos + 3] - startA) <= tolerance;
            }
            
            while (stack.length > 0) {
                const [x, y] = stack.pop();
                                const pos = (y * canvas.width + x) * 4;
                
                if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
                if (!matchesStart(pos)) continue;
                
                data[pos] = fillColor.r;
                data[pos + 1] = fillColor.g;
                data[pos + 2] = fillColor.b;
                data[pos + 3] = 255;
                
                stack.push([x + 1, y]);
                stack.push([x - 1, y]);
                stack.push([x, y + 1]);
                stack.push([x, y - 1]);
            }
            
            layer.ctx.putImageData(imageData, 0, 0);
            saveState('Fill');
            render();
            updateNavigator();
        }

        function hexToRgb(color) {
            let hex = color;
            if (color.startsWith('rgb')) {
                const match = color.match(/\d+/g);
                return { r: parseInt(match[0]), g: parseInt(match[1]), b: parseInt(match[2]) };
            }
            if (hex.startsWith('#')) hex = hex.slice(1);
            if (hex.length === 3) {
                hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            }
            return {
                r: parseInt(hex.substr(0, 2), 16),
                g: parseInt(hex.substr(2, 2), 16),
                b: parseInt(hex.substr(4, 2), 16)
            };
        }

        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function updateColorDisplay() {
            const rgb = hexToRgb(foregroundColor);
            document.getElementById('foregroundColor').style.background = foregroundColor;
            document.getElementById('backgroundColor').style.background = backgroundColor;
            
            document.getElementById('colorR').value = rgb.r;
            document.getElementById('colorRNum').value = rgb.r;
            document.getElementById('colorG').value = rgb.g;
            document.getElementById('colorGNum').value = rgb.g;
            document.getElementById('colorB').value = rgb.b;
            document.getElementById('colorBNum').value = rgb.b;
            
            let hex = foregroundColor;
            if (hex.startsWith('rgb')) {
                hex = rgbToHex(rgb.r, rgb.g, rgb.b);
            }
            document.getElementById('hexColor').value = hex.replace('#', '');
        }

        function updateColorFromSliders() {
            const r = parseInt(document.getElementById('colorR').value);
            const g = parseInt(document.getElementById('colorG').value);
            const b = parseInt(document.getElementById('colorB').value);
            
            document.getElementById('colorRNum').value = r;
            document.getElementById('colorGNum').value = g;
            document.getElementById('colorBNum').value = b;
            
            foregroundColor = rgbToHex(r, g, b);
            document.getElementById('hexColor').value = foregroundColor.replace('#', '');
            document.getElementById('foregroundColor').style.background = foregroundColor;
        }

        function updateColorFromHex() {
            let hex = document.getElementById('hexColor').value;
            if (!/^[0-9A-Fa-f]{6}$/.test(hex)) return;
            
            foregroundColor = '#' + hex;
            const rgb = hexToRgb(foregroundColor);
            
            document.getElementById('colorR').value = rgb.r;
            document.getElementById('colorRNum').value = rgb.r;
            document.getElementById('colorG').value = rgb.g;
            document.getElementById('colorGNum').value = rgb.g;
            document.getElementById('colorB').value = rgb.b;
            document.getElementById('colorBNum').value = rgb.b;
            document.getElementById('foregroundColor').style.background = foregroundColor;
        }

        function swapColors() {
            [foregroundColor, backgroundColor] = [backgroundColor, foregroundColor];
            updateColorDisplay();
        }

        let colorPickerTarget = 'foreground';
        
        function openColorPicker(target) {
            colorPickerTarget = target;
            const input = document.getElementById('colorPickerInput');
            input.value = target === 'foreground' ? foregroundColor : backgroundColor;
            input.click();
        }

        function handleColorPick(e) {
            if (colorPickerTarget === 'foreground') {
                foregroundColor = e.target.value;
            } else {
                backgroundColor = e.target.value;
            }
            updateColorDisplay();
        }

        function initSwatches() {
            const swatches = document.getElementById('swatches');
            const colors = [
                '#000000', '#434343', '#666666', '#999999', '#b7b7b7', '#cccccc', '#d9d9d9', '#efefef', '#f3f3f3', '#ffffff',
                '#980000', '#ff0000', '#ff9900', '#ffff00', '#00ff00', '#00ffff', '#4a86e8', '#0000ff', '#9900ff', '#ff00ff',
                '#e6b8af', '#f4cccc', '#fce5cd', '#fff2cc', '#d9ead3', '#d0e0e3', '#c9daf8', '#cfe2f3', '#d9d2e9', '#ead1dc',
                '#dd7e6b', '#ea9999', '#f9cb9c', '#ffe599', '#b6d7a8', '#a2c4c9', '#a4c2f4', '#9fc5e8', '#b4a7d6', '#d5a6bd',
                '#cc4125', '#e06666', '#f6b26b', '#ffd966', '#93c47d', '#76a5af', '#6d9eeb', '#6fa8dc', '#8e7cc3', '#c27ba0',
                '#a61c00', '#cc0000', '#e69138', '#f1c232', '#6aa84f', '#45818e', '#3c78d8', '#3d85c6', '#674ea7', '#a64d79',
                '#85200c', '#990000', '#b45f06', '#bf9000', '#38761d', '#134f5c', '#1155cc', '#0b5394', '#351c75', '#741b47',
                '#5b0f00', '#660000', '#783f04', '#7f6000', '#274e13', '#0c343d', '#1c4587', '#073763', '#20124d', '#4c1130'
            ];
            
            colors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'swatch';
                swatch.style.background = color;
                swatch.onclick = () => {
                    foregroundColor = color;
                    updateColorDisplay();
                };
                swatch.oncontextmenu = (e) => {
                    e.preventDefault();
                    backgroundColor = color;
                    updateColorDisplay();
                };
                swatches.appendChild(swatch);
            });
        }

        // ==================== BRUSH PRESETS ====================
        function initBrushPresets() {
            const presets = document.getElementById('brushPresets');
            const sizes = [2, 5, 10, 20, 35, 50, 75, 100, 150, 200];
            
            sizes.forEach((size, i) => {
                const preset = document.createElement('div');
                preset.className = 'brush-preset' + (size === 10 ? ' active' : '');
                preset.onclick = () => {
                    document.querySelectorAll('.brush-preset').forEach(p => p.classList.remove('active'));
                    preset.classList.add('active');
                    updateBrushSize(size);
                };
                
                const preview = document.createElement('div');
                preview.className = 'brush-preview';
                preview.style.width = Math.min(size / 2, 35) + 'px';
                preview.style.height = Math.min(size / 2, 35) + 'px';
                preset.appendChild(preview);
                presets.appendChild(preset);
            });
        }

        // ==================== TEXT TOOL ====================
        function addText(x, y) {
            const text = prompt('Enter text:', 'Sample Text');
            if (!text) return;
            
            const fontSize = prompt('Font size:', '24');
            if (!fontSize) return;
            
            const layer = layers[activeLayerIndex];
            layer.ctx.font = `${fontSize}px Arial`;
            layer.ctx.fillStyle = foregroundColor;
            layer.ctx.globalAlpha = brushOpacity / 100;
            layer.ctx.fillText(text, x, y);
            layer.ctx.globalAlpha = 1;
            
            saveState('Add Text');
            render();
            updateNavigator();
        }

        // ==================== RENDERING ====================
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw checkerboard for transparency
            const checkSize = 10;
            for (let x = 0; x < canvas.width; x += checkSize) {
                for (let y = 0; y < canvas.height; y += checkSize) {
                    ctx.fillStyle = ((x + y) / checkSize) % 2 === 0 ? '#ffffff' : '#cccccc';
                    ctx.fillRect(x, y, checkSize, checkSize);
                }
            }
            
            // Draw layers
            layers.forEach(layer => {
                if (!layer.visible) return;
                ctx.globalAlpha = layer.opacity / 100;
                ctx.globalCompositeOperation = layer.blendMode;
                ctx.drawImage(layer.canvas, 0, 0);
            });
            
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = 'source-over';
            
            // Draw selection
            if (selection) {
                drawSelectionRect();
            }
        }

        function updateNavigator() {
            const navCanvas = document.getElementById('navigatorCanvas');
            const navCtx = navCanvas.getContext('2d');
            
            const maxSize = 240;
            const scale = Math.min(maxSize / canvas.width, maxSize / canvas.height);
            navCanvas.width = canvas.width * scale;
            navCanvas.height = canvas.height * scale;
            
            navCtx.drawImage(canvas, 0, 0, navCanvas.width, navCanvas.height);
        }

        // ==================== ZOOM ====================
        function setZoom(value) {
            zoom = parseInt(value);
            document.getElementById('zoomSlider').value = zoom;
            document.getElementById('zoomValue').textContent = zoom + '%';
            document.getElementById('zoomLevel').textContent = zoom + '%';
            
            const wrapper = document.getElementById('canvasWrapper');
            wrapper.style.transform = `scale(${zoom / 100})`;
            wrapper.style.transformOrigin = 'center center';
        }

        function zoomIn() {
            setZoom(Math.min(zoom + 25, 500));
        }

        function zoomOut() {
            setZoom(Math.max(zoom - 25, 10));
        }

        function fitToScreen() {
            const container = document.getElementById('canvasContainer');
            const scaleX = (container.clientWidth - 40) / canvas.width;
            const scaleY = (container.clientHeight - 40) / canvas.height;
            const scale = Math.min(scaleX, scaleY, 1) * 100;
            setZoom(Math.floor(scale));
        }

        // ==================== FILE OPERATIONS ====================
        function newDocument() {
            document.getElementById('newDocDialog').classList.add('active');
        }

        function closeNewDocDialog() {
            document.getElementById('newDocDialog').classList.remove('active');
        }

        function createNewDocument() {
            const width = parseInt(document.getElementById('newWidth').value);
            const height = parseInt(document.getElementById('newHeight').value);
            const bg = document.getElementById('newBackground').value;
            
            canvas.width = width;
            canvas.height = height;
            
            layers = [];
            history = [];
            historyIndex = -1;
            activeLayerIndex = 0;
            
            createLayer('Background', true);
            
            if (bg === 'white') {
                fillLayer(0, '#ffffff');
            } else if (bg === 'black') {
                fillLayer(0, '#000000');
            }
            
            saveState('New Document');
            updateLayersPanel();
            updateHistoryPanel();
            updateDocInfo();
            render();
            updateNavigator();
            fitToScreen();
            closeNewDocDialog();
        }

        function loadImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    layers = [];
                    history = [];
                    historyIndex = -1;
                    
                    createLayer('Background', true);
                    layers[0].ctx.drawImage(img, 0, 0);
                    
                    saveState('Open Image');
                    updateLayersPanel();
                    updateHistoryPanel();
                    updateDocInfo();
                    render();
                    updateNavigator();
                    fitToScreen();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function saveImage(format) {
            // Flatten for export
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = canvas.width;
            exportCanvas.height = canvas.height;
            const exportCtx = exportCanvas.getContext('2d');
            
            if (format !== 'png') {
                exportCtx.fillStyle = '#ffffff';
                exportCtx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            layers.forEach(layer => {
                if (!layer.visible) return;
                exportCtx.globalAlpha = layer.opacity / 100;
                exportCtx.globalCompositeOperation = layer.blendMode;
                exportCtx.drawImage(layer.canvas, 0, 0);
            });
            
            const mimeType = format === 'jpeg' ? 'image/jpeg' : format === 'webp' ? 'image/webp' : 'image/png';
            const link = document.createElement('a');
            link.download = `image.${format}`;
            link.href = exportCanvas.toDataURL(mimeType, 0.9);
            link.click();
        }

        function exportLayers() {
            layers.forEach((layer, i) => {
                const link = document.createElement('a');
                link.download = `${layer.name}.png`;
                link.href = layer.canvas.toDataURL('image/png');
                link.click();
            });
        }

        function updateDocInfo() {
            document.getElementById('docSize').textContent = `${canvas.width} Ã— ${canvas.height} px`;
        }

        // ==================== IMAGE TRANSFORMATIONS ====================
        function rotateCanvas(degrees) {
            const radians = degrees * Math.PI / 180;
            
            layers.forEach(layer => {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                if (Math.abs(degrees) === 90) {
                    tempCanvas.width = layer.canvas.height;
                    tempCanvas.height = layer.canvas.width;
                } else {
                    tempCanvas.width = layer.canvas.width;
                    tempCanvas.height = layer.canvas.height;
                }
                
                tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
                tempCtx.rotate(radians);
                tempCtx.drawImage(layer.canvas, -layer.canvas.width / 2, -layer.canvas.height / 2);
                
                layer.canvas.width = tempCanvas.width;
                layer.canvas.height = tempCanvas.height;
                layer.ctx.drawImage(tempCanvas, 0, 0);
            });
            
            if (Math.abs(degrees) === 90) {
                const temp = canvas.width;
                canvas.width = canvas.height;
                canvas.height = temp;
            }
            
            saveState(`Rotate ${degrees}Â°`);
            updateDocInfo();
            render();
            updateNavigator();
        }

        function flipCanvas(direction) {
            layers.forEach(layer => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = layer.canvas.width;
                tempCanvas.height = layer.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                if (direction === 'horizontal') {
                    tempCtx.translate(tempCanvas.width, 0);
                    tempCtx.scale(-1, 1);
                } else {
                    tempCtx.translate(0, tempCanvas.height);
                    tempCtx.scale(1, -1);
                }
                
                tempCtx.drawImage(layer.canvas, 0, 0);
                layer.ctx.clearRect(0, 0, layer.canvas.width, layer.canvas.height);
                layer.ctx.drawImage(tempCanvas, 0, 0);
            });
            
            saveState(`Flip ${direction}`);
            render();
            updateNavigator();
        }

        function showResizeDialog() {
            const newWidth = prompt('New width:', canvas.width);
            if (!newWidth) return;
            const newHeight = prompt('New height:', canvas.height);
            if (!newHeight) return;
            
            resizeImage(parseInt(newWidth), parseInt(newHeight));
        }

        function resizeImage(newWidth, newHeight) {
            layers.forEach(layer => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = newWidth;
                tempCanvas.height = newHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(layer.canvas, 0, 0, newWidth, newHeight);
                
                layer.canvas.width = newWidth;
                layer.canvas.height = newHeight;
                layer.ctx.drawImage(tempCanvas, 0, 0);
            });
            
            canvas.width = newWidth;
            canvas.height = newHeight;
            
            saveState('Resize Image');
            updateDocInfo();
            render();
            updateNavigator();
        }

        function showCanvasSizeDialog() {
            const newWidth = prompt('New canvas width:', canvas.width);
            if (!newWidth) return;
            const newHeight = prompt('New canvas height:', canvas.height);
            if (!newHeight) return;
            
            resizeCanvas(parseInt(newWidth), parseInt(newHeight));
        }

        function resizeCanvas(newWidth, newHeight) {
            layers.forEach(layer => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = layer.canvas.width;
                tempCanvas.height = layer.canvas.height;
                tempCanvas.getContext('2d').drawImage(layer.canvas, 0, 0);
                
                layer.canvas.width = newWidth;
                layer.canvas.height = newHeight;
                layer.ctx.drawImage(tempCanvas, 0, 0);
            });
            
            canvas.width = newWidth;
            canvas.height = newHeight;
            
            saveState('Canvas Size');
            updateDocInfo();
            render();
            updateNavigator();
        }

        function cropToSelection() {
            if (!selection) {
                alert('No selection to crop to');
                return;
            }
            
            layers.forEach(layer => {
                const imageData = layer.ctx.getImageData(selection.x, selection.y, selection.width, selection.height);
                layer.canvas.width = selection.width;
                layer.canvas.height = selection.height;
                layer.ctx.putImageData(imageData, 0, 0);
            });
            
            canvas.width = selection.width;
            canvas.height = selection.height;
            selection = null;
            
            saveState('Crop');
            updateDocInfo();
            render();
            updateNavigator();
        }

        function trimCanvas() {
            // Find bounds of non-transparent pixels
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
            
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const alpha = data[(y * canvas.width + x) * 4 + 3];
                    if (alpha > 0) {
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    }
                }
            }
            
            if (maxX < minX || maxY < minY) return;
            
            selection = { x: minX, y: minY, width: maxX - minX + 1, height: maxY - minY + 1 };
            cropToSelection();
        }

        // ==================== EDIT OPERATIONS ====================
        function fillSelection() {
            const layer = layers[activeLayerIndex];
            layer.ctx.fillStyle = foregroundColor;
            layer.ctx.globalAlpha = brushOpacity / 100;
            
            if (selection) {
                layer.ctx.fillRect(selection.x, selection.y, selection.width, selection.height);
            } else {
                layer.ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            layer.ctx.globalAlpha = 1;
            saveState('Fill');
            render();
            updateNavigator();
        }

        function strokeSelection() {
            if (!selection) return;
            
            const layer = layers[activeLayerIndex];
            layer.ctx.strokeStyle = foregroundColor;
            layer.ctx.lineWidth = brushSize;
            layer.ctx.globalAlpha = brushOpacity / 100;
            layer.ctx.strokeRect(selection.x, selection.y, selection.width, selection.height);
            layer.ctx.globalAlpha = 1;
            
            saveState('Stroke');
            render();
            updateNavigator();
        }

        let clipboardData = null;

        function copySelection() {
            if (!selection) {
                selection = { x: 0, y: 0, width: canvas.width, height: canvas.height };
            }
            
            clipboardData = layers[activeLayerIndex].ctx.getImageData(
                selection.x, selection.y, selection.width, selection.height
            );
        }

        function cutSelection() {
            copySelection();
            
            const layer = layers[activeLayerIndex];
            layer.ctx.clearRect(selection.x, selection.y, selection.width, selection.height);
            
            saveState('Cut');
            render();
            updateNavigator();
        }

        function pasteClipboard() {
            if (!clipboardData) return;
            
            addLayer();
            layers[activeLayerIndex].ctx.putImageData(clipboardData, 0, 0);
            layers[activeLayerIndex].name = 'Pasted Layer';
            
            saveState('Paste');
            updateLayersPanel();
            render();
            updateNavigator();
        }

        // ==================== FILTERS ====================
        function showFilterDialog(filterType) {
            currentFilter = filterType;
            filterValues = {};
            
            const dialog = document.getElementById('filterDialog');
            const title = document.getElementById('filterDialogTitle');
            const controls = document.getElementById('filterControls');
            
            controls.innerHTML = '';
            
            switch (filterType) {
                case 'blur':
                    title.textContent = 'Gaussian Blur';
                    filterValues.radius = 5;
                    controls.innerHTML = `
                        <div class="dialog-slider">
                            <label>Radius: <span id="blurRadiusVal">5</span></label>
                            <input type="range" id="blurRadius" min="1" max="50" value="5" 
                                oninput="filterValues.radius=this.value; document.getElementById('blurRadiusVal').textContent=this.value; updateFilterPreview()">
                        </div>
                    `;
                    break;
                    
                case 'sharpen':
                    title.textContent = 'Sharpen';
                    filterValues.amount = 50;
                    controls.innerHTML = `
                        <div class="dialog-slider">
                            <label>Amount: <span id="sharpenAmountVal">50</span>%</label>
                            <input type="range" id="sharpenAmount" min="1" max="100" value="50"
                                oninput="filterValues.amount=this.value; document.getElementById('sharpenAmountVal').textContent=this.value; updateFilterPreview()">
                        </div>
                    `;
                    break;
                    
                case 'noise':
                    title.textContent = 'Add Noise';
                    filterValues.amount = 25;
                    controls.innerHTML = `
                        <div class="dialog-slider">
                            <label>Amount: <span id="noiseAmountVal">25</span>%</label>
                            <input type="range" id="noiseAmount" min="1" max="100" value="25"
                                oninput="filterValues.amount=this.value; document.getElementById('noiseAmountVal').textContent=this.value; updateFilterPreview()">
                        </div>
                    `;
                    break;
                    
                case 'brightness':
                    title.textContent = 'Brightness/Contrast';
                    filterValues.brightness = 0;
                    filterValues.contrast = 0;
                    controls.innerHTML = `
                        <div class="dialog-slider">
                            <label>Brightness: <span id="brightnessVal">0</span></label>
                            <input type="range" id="brightnessSlider" min="-100" max="100" value="0"
                                oninput="filterValues.brightness=this.value; document.getElementById('brightnessVal').textContent=this.value; updateFilterPreview()">
                        </div>
                        <div class="dialog-slider">
                            <label>Contrast: <span id="contrastVal">0</span></label>
                            <input type="range" id="contrastSlider" min="-100" max="100" value="0"
                                oninput="filterValues.contrast=this.value; document.getElementById('contrastVal').textContent=this.value; updateFilterPreview()">
                        </div>
                    `;
                    break;
                    
                case 'hue':
                    title.textContent = 'Hue/Saturation';
                    filterValues.hue = 0;
                    filterValues.saturation = 0;
                    filterValues.lightness = 0;
                    controls.innerHTML = `
                        <div class="dialog-slider">
                            <label>Hue: <span id="hueVal">0</span>Â°</label>
                            <input type="range" id="hueSlider" min="-180" max="180" value="0"
                                oninput="filterValues.hue=this.value; document.getElementById('hueVal').textContent=this.value; updateFilterPreview()">
                        </div>
                        <div class="dialog-slider">
                            <label>Saturation: <span id="satVal">0</span></label>
                            <input type="range" id="satSlider" min="-100" max="100" value="0"
                                oninput="filterValues.saturation=this.value; document.getElementById('satVal').textContent=this.value; updateFilterPreview()">
                        </div>
                        <div class="dialog-slider">
                            <label>Lightness: <span id="lightVal">0</span></label>
                            <input type="range" id="lightSlider" min="-100" max="100" value="0"
                                oninput="filterValues.lightness=this.value; document.getElementById('lightVal').textContent=this.value; updateFilterPreview()">
                        </div>
                    `;
                    break;
                    
                case 'levels':
                    title.textContent = 'Levels';
                    filterValues.black = 0;
                    filterValues.white = 255;
                    filterValues.gamma = 1;
                    controls.innerHTML = `
                        <div class="dialog-slider">
                            <label>Black Point: <span id="blackVal">0</span></label>
                            <input type="range" id="blackSlider" min="0" max="255" value="0"
                                oninput="filterValues.black=this.value; document.getElementById('blackVal').textContent=this.value; updateFilterPreview()">
                        </div>
                        <div class="dialog-slider">
                            <label>White Point: <span id="whiteVal">255</span></label>
                            <input type="range" id="whiteSlider" min="0" max="255" value="255"
                                oninput="filterValues.white=this.value; document.getElementById('whiteVal').textContent=this.value; updateFilterPreview()">
                        </div>
                        <div class="dialog-slider">
                            <label>Gamma: <span id="gammaVal">1.0</span></label>
                            <input type="range" id="gammaSlider" min="10" max="300" value="100"
                                oninput="filterValues.gamma=this.value/100; document.getElementById('gammaVal').textContent=(this.value/100).toFixed(1); updateFilterPreview()">
                        </div>
                    `;
                    break;
                    
                case 'pixelate':
                    title.textContent = 'Pixelate';
                    filterValues.size = 10;
                    controls.innerHTML = `
                        <div class="dialog-slider">
                            <label>Pixel Size: <span id="pixelSizeVal">10</span></label>
                            <input type="range" id="pixelSize" min="2" max="50" value="10"
                                oninput="filterValues.size=this.value; document.getElementById('pixelSizeVal').textContent=this.value; updateFilterPreview()">
                        </div>
                    `;
                    break;
            }
            
            dialog.classList.add('active');
            updateFilterPreview();
        }

        function closeFilterDialog() {
            document.getElementById('filterDialog').classList.remove('active');
            currentFilter = null;
        }

        function updateFilterPreview() {
            const beforeCanvas = document.getElementById('filterPreviewBefore');
            const afterCanvas = document.getElementById('filterPreviewAfter');
            const beforeCtx = beforeCanvas.getContext('2d');
            const afterCtx = afterCanvas.getContext('2d');
            
            const layer = layers[activeLayerIndex];
            
            // Draw before
            beforeCtx.clearRect(0, 0, 150, 150);
            const scale = Math.min(150 / layer.canvas.width, 150 / layer.canvas.height);
            const w = layer.canvas.width * scale;
            const h = layer.canvas.height * scale;
            beforeCtx.drawImage(layer.canvas, (150 - w) / 2, (150 - h) / 2, w, h);
            
            // Create temp canvas for preview
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = layer.canvas.width;
            tempCanvas.height = layer.canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(layer.canvas, 0, 0);
            
            // Apply filter to temp
            applyFilterToContext(tempCtx, tempCanvas.width, tempCanvas.height);
            
            // Draw after
            afterCtx.clearRect(0, 0, 150, 150);
            afterCtx.drawImage(tempCanvas, (150 - w) / 2, (150 - h) / 2, w, h);
        }

        function applyFilterToContext(context, width, height) {
            const imageData = context.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            switch (currentFilter) {
                case 'blur':
                    boxBlur(data, width, height, parseInt(filterValues.radius));
                    break;
                    
                case 'sharpen':
                    sharpenFilter(data, width, height, filterValues.amount / 100);
                    break;
                    
                case 'noise':
                    noiseFilter(data, filterValues.amount);
                    break;
                    
                case 'brightness':
                    brightnessContrastFilter(data, parseInt(filterValues.brightness), parseInt(filterValues.contrast));
                    break;
                    
                case 'hue':
                    hueSaturationFilter(data, parseInt(filterValues.hue), parseInt(filterValues.saturation), parseInt(filterValues.lightness));
                    break;
                    
                case 'levels':
                    levelsFilter(data, parseInt(filterValues.black), parseInt(filterValues.white), parseFloat(filterValues.gamma));
                    break;
                    
                case 'pixelate':
                    pixelateFilter(context, width, height, parseInt(filterValues.size));
                    return; // pixelate handles its own putImageData
            }
            
            context.putImageData(imageData, 0, 0);
        }

        function applyFilterFromDialog() {
            const layer = layers[activeLayerIndex];
            applyFilterToContext(layer.ctx, layer.canvas.width, layer.canvas.height);
            
            const filterNames = {
                blur: 'Blur',
                sharpen: 'Sharpen',
                noise: 'Add Noise',
                brightness: 'Brightness/Contrast',
                hue: 'Hue/Saturation',
                levels: 'Levels',
                pixelate: 'Pixelate'
            };
            
            saveState(filterNames[currentFilter] || 'Filter');
            closeFilterDialog();
            render();
            updateNavigator();
            updateLayersPanel();
        }

        function applyFilter(filterType) {
            const layer = layers[activeLayerIndex];
            const imageData = layer.ctx.getImageData(0, 0, layer.canvas.width, layer.canvas.height);
            const data = imageData.data;
            
            switch (filterType) {
                case 'grayscale':
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                        data[i] = data[i + 1] = data[i + 2] = gray;
                    }
                    break;
                    
                case 'sepia':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i + 1], b = data[i + 2];
                        data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                        data[i + 1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                        data[i + 2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
                    }
                    break;
                    
                case 'invert':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];
                        data[i + 1] = 255 - data[i + 1];
                        data[i + 2] = 255 - data[i + 2];
                    }
                    break;
                    
                case 'emboss':
                    convolve(data, layer.canvas.width, layer.canvas.height, [
                        -2, -1, 0,
                        -1,  1, 1,
                         0,  1, 2
                    ]);
                    break;
                    
                case 'edge':
                    convolve(data, layer.canvas.width, layer.canvas.height, [
                        -1, -1, -1,
                        -1,  8, -1,
                        -1, -1, -1
                    ]);
                    break;
            }
            
            layer.ctx.putImageData(imageData, 0, 0);
            saveState(filterType.charAt(0).toUpperCase() + filterType.slice(1));
            render();
            updateNavigator();
            updateLayersPanel();
        }

        // Filter implementations
        function boxBlur(data, width, height, radius) {
            const tempData = new Uint8ClampedArray(data);
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let r = 0, g = 0, b = 0, count = 0;
                    
                    for (let dy = -radius; dy <= radius; dy++) {
                        for (let dx = -radius; dx <= radius; dx++) {
                            const nx = x + dx;
                            const ny = y + dy;
                            
                            if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                const i = (ny * width + nx) * 4;
                                r += tempData[i];
                                g += tempData[i + 1];
                                b += tempData[i + 2];
                                count++;
                            }
                        }
                    }
                    
                    const i = (y * width + x) * 4;
                    data[i] = r / count;
                    data[i + 1] = g / count;
                    data[i + 2] = b / count;
                }
            }
        }

        function sharpenFilter(data, width, height, amount) {
            const kernel = [
                 0, -1,  0,
                -1,  5, -1,
                 0, -1,  0
            ];
            
            // Blend with original based on amount
            const tempData = new Uint8ClampedArray(data);
            convolve(data, width, height, kernel);
            
            for (let i = 0; i < data.length; i++) {
                data[i] = tempData[i] * (1 - amount) + data[i] * amount;
            }
        }

        function noiseFilter(data, amount) {
            for (let i = 0; i < data.length; i += 4) {
                const noise = (Math.random() - 0.5) * amount * 2.55;
                data[i] = Math.max(0, Math.min(255, data[i] + noise));
                data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noise));
                data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noise));
            }
        }

        function brightnessContrastFilter(data, brightness, contrast) {
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.max(0, Math.min(255, factor * (data[i] + brightness - 128) + 128));
                data[i + 1] = Math.max(0, Math.min(255, factor * (data[i + 1] + brightness - 128) + 128));
                data[i + 2] = Math.max(0, Math.min(255, factor * (data[i + 2] + brightness - 128) + 128));
            }
        }

        function hueSaturationFilter(data, hue, saturation, lightness) {
            for (let i = 0; i < data.length; i += 4) {
                let [h, s, l] = rgbToHsl(data[i], data[i + 1], data[i + 2]);
                
                h = (h + hue / 360 + 1) % 1;
                s = Math.max(0, Math.min(1, s + saturation / 100));
                l = Math.max(0, Math.min(1, l + lightness / 100));
                
                const [r, g, b] = hslToRgb(h, s, l);
                data[i] = r;
                data[i + 1] = g;
                data[i + 2] = b;
            }
        }

        function levelsFilter(data, black, white, gamma) {
            const range = white - black;
            
            for (let i = 0; i < data.length; i += 4) {
                for (let c = 0; c < 3; c++) {
                    let value = data[i + c];
                    value = (value - black) / range;
                    value = Math.max(0, Math.min(1, value));
                    value = Math.pow(value, 1 / gamma);
                    data[i + c] = Math.round(value * 255);
                }
            }
        }

        function pixelateFilter(context, width, height, size) {
            const imageData = context.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let y = 0; y < height; y += size) {
                for (let x = 0; x < width; x += size) {
                    const i = (y * width + x) * 4;
                    const r = data[i], g = data[i + 1], b = data[i + 2];
                    
                    for (let dy = 0; dy < size && y + dy < height; dy++) {
                        for (let dx = 0; dx < size && x + dx < width; dx++) {
                            const j = ((y + dy) * width + (x + dx)) * 4;
                            data[j] = r;
                            data[j + 1] = g;
                            data[j + 2] = b;
                        }
                    }
                }
            }
            
            context.putImageData(imageData, 0, 0);
        }

        function convolve(data, width, height, kernel) {
            const tempData = new Uint8ClampedArray(data);
            const kSize = Math.sqrt(kernel.length);
            const half = Math.floor(kSize / 2);
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let r = 0, g = 0, b = 0;
                    
                    for (let ky = 0; ky < kSize; ky++) {
                        for (let kx = 0; kx < kSize; kx++) {
                            const px = Math.min(width - 1, Math.max(0, x + kx - half));
                            const py = Math.min(height - 1, Math.max(0, y + ky - half));
                            const i = (py * width + px) * 4;
                            const k = kernel[ky * kSize + kx];
                            
                            r += tempData[i] * k;
                            g += tempData[i + 1] * k;
                            b += tempData[i + 2] * k;
                        }
                    }
                    
                    const i = (y * width + x) * 4;
                    data[i] = Math.max(0, Math.min(255, r));
                    data[i + 1] = Math.max(0, Math.min(255, g));
                    data[i + 2] = Math.max(0, Math.min(255, b));
                }
            }
        }

        // Color conversion helpers
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            
            return [h, s, l];
        }

        function hslToRgb(h, s, l) {
            let r, g, b;
            
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            const ctrl = e.ctrlKey || e.metaKey;
            const shift = e.shiftKey;
            
            switch (e.key.toLowerCase()) {
                case 'z':
                    if (ctrl && shift) { redo(); e.preventDefault(); }
                    else if (ctrl) { undo(); e.preventDefault(); }
                    else selectTool('zoom');
                    break;
                case 'y':
                    if (ctrl) { redo(); e.preventDefault(); }
                    break;
                case 's':
                    if (ctrl) { saveImage('png'); e.preventDefault(); }
                    break;
                case 'o':
                    if (ctrl) { document.getElementById('fileInput').click(); e.preventDefault(); }
                    break;
                case 'n':
                    if (ctrl && shift) { addLayer(); e.preventDefault(); }
                    else if (ctrl) { newDocument(); e.preventDefault(); }
                    break;
                case 'a':
                    if (ctrl) { selectAll(); e.preventDefault(); }
                    break;
                case 'd':
                    if (ctrl) { deselectAll(); e.preventDefault(); }
                    break;
                case 'e':
                    if (ctrl) { mergeDown(); e.preventDefault(); }
                    else selectTool('eraser');
                    break;
                case 'b':
                    selectTool('brush');
                    break;
                case 'v':
                    selectTool('move');
                    break;
                case 'm':
                    selectTool('select');
                    break;
                case 'l':
                    selectTool('lasso');
                    break;
                case 'c':
                    if (ctrl) { copySelection(); e.preventDefault(); }
                    else selectTool('crop');
                    break;
                case 'x':
                    if (ctrl) { cutSelection(); e.preventDefault(); }
                    else swapColors();
                    break;
                case 'g':
                    selectTool('fill');
                    break;
                case 't':
                    selectTool('text');
                    break;
                case 'u':
                    selectTool('rectangle');
                    break;
                case 'i':
                    selectTool('eyedropper');
                    break;
                case 'h':
                    selectTool('hand');
                    break;
                case '[':
                    updateBrushSize(Math.max(1, brushSize - 5));
                    break;
                case ']':
                    updateBrushSize(Math.min(200, brushSize + 5));
                    break;
                case '0':
                    if (ctrl) { fitToScreen(); e.preventDefault(); }
                    break;
                case '1':
                    if (ctrl) { setZoom(100); e.preventDefault(); }
                    break;
                case '+':
                case '=':
                    if (ctrl) { zoomIn(); e.preventDefault(); }
                    break;
                case '-':
                    if (ctrl) { zoomOut(); e.preventDefault(); }
                    break;
                case 'delete':
                case 'backspace':
                    if (selection) {
                        const layer = layers[activeLayerIndex];
                        layer.ctx.clearRect(selection.x, selection.y, selection.width, selection.height);
                        saveState('Delete');
                        render();
                        updateNavigator();
                        e.preventDefault();
                    }
                    break;
            }
        });

        // ==================== MISC FUNCTIONS ====================
        function toggleGrid() {
            // Toggle grid visibility - simplified implementation
            alert('Grid toggled (visual grid not implemented in this demo)');
        }

        function toggleGuides() {
            alert('Guides toggled (visual guides not implemented in this demo)');
        }

        function showShortcuts() {
            alert(`Keyboard Shortcuts:

Tools:
B - Brush
E - Eraser
V - Move
M - Marquee Select
L - Lasso
C - Crop
G - Paint Bucket
T - Text
I - Eyedropper
Z - Zoom
H - Hand
U - Rectangle
X - Swap Colors
[ ] - Decrease/Increase Brush Size

Edit:
Ctrl+Z - Undo
Ctrl+Y / Ctrl+Shift+Z - Redo
Ctrl+C - Copy
Ctrl+X - Cut
Ctrl+V - Paste
Ctrl+A - Select All
Ctrl+D - Deselect
Delete - Clear Selection

File:
Ctrl+N - New Document
Ctrl+O - Open
Ctrl+S - Save
Ctrl+Shift+N - New Layer
Ctrl+E - Merge Down

View:
Ctrl+0 - Fit to Screen
Ctrl+1 - 100% Zoom
Ctrl++ - Zoom In
Ctrl+- - Zoom Out`);
        }

        function showAbout() {
            alert('PhotoEdit Pro\nVersion 1.0\n\nA web-based image editor with layers, filters, and more.\n\nBuilt with HTML5 Canvas and JavaScript.');
        }

        // ==================== INITIALIZE ====================
        init();
        updateColorDisplay();
    </script>
</body>
</html>