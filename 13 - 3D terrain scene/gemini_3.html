<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Osogovo 3D Terrain Diorama</title>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a; /* Dark background for the app */
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
            outline: none;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 20px;
            pointer-events: none;
            z-index: 10;
        }
    </style>
    
    <!-- Load Babylon.js and GUI from CDN -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
</head>
<body>

    <div id="loading">Loading Terrain...</div>
    <canvas id="renderCanvas"></canvas>

    <script>
        window.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('renderCanvas');
            const engine = new BABYLON.Engine(canvas, true);

            // --- Configuration ---
            const heightMapFile = "Osogovo Height Map (Merged).png";
            const textureFile   = "Osogovo_map.jpg";
            
            // Terrain Dimensions
            const mapWidth = 100;
            const mapHeight = 100;
            const terrainMaxHeight = 25; // How high the peaks go
            const terrainMinHeight = 0;  
            const pedestalDepth = 5;     // How thick the box base is below the terrain

            const createScene = function() {
                const scene = new BABYLON.Scene(engine);
                scene.clearColor = new BABYLON.Color3(0.1, 0.1, 0.15); // Nice dark blue-grey background
                
                // --- Camera ---
                // Orbit camera (ArcRotateCamera)
                const camera = new BABYLON.ArcRotateCamera("Camera", -Math.PI / 4, Math.PI / 3, 150, BABYLON.Vector3.Zero(), scene);
                camera.attachControl(canvas, true);
                camera.lowerRadiusLimit = 50;
                camera.upperRadiusLimit = 300;
                
                // --- Lighting ---
                // Hemispheric light for ambient illumination
                const hemiLight = new BABYLON.HemisphericLight("hemiLight", new BABYLON.Vector3(0, 1, 0), scene);
                hemiLight.intensity = 0.6;
                hemiLight.groundColor = new BABYLON.Color3(0.2, 0.2, 0.2);

                // Directional light (Sun) to create shadows and definition
                const dirLight = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(-1, -2, -1), scene);
                dirLight.position = new BABYLON.Vector3(50, 100, 50);
                dirLight.intensity = 0.8;

                // --- 1. The Terrain (Lid) ---
                // Create ground from height map
                const ground = BABYLON.MeshBuilder.CreateGroundFromHeightMap("ground", heightMapFile, {
                    width: mapWidth,
                    height: mapHeight,
                    subdivisions: 250, // High resolution for detail
                    minHeight: terrainMinHeight,
                    maxHeight: terrainMaxHeight,
                    colorFilter: new BABYLON.Color3(0.3, 0.3, 0.3), // Neutral filter
                    onReady: function(mesh) {
                        // Callback when terrain geometry is computed
                        document.getElementById("loading").style.display = "none";
                        onTerrainReady(mesh);
                    }
                }, scene);

                // Terrain Material
                const groundMat = new BABYLON.StandardMaterial("groundMat", scene);
                groundMat.diffuseTexture = new BABYLON.Texture(textureFile, scene);
                groundMat.specularColor = new BABYLON.Color3(0.1, 0.1, 0.1); // Reduce plastic shine
                ground.material = groundMat;

                // --- 2. The Pedestal (Box Walls & Bottom) ---
                // We create a box positioned underneath the terrain.
                // The top of the box sits at y = terrainMinHeight.
                
                const boxHeight = pedestalDepth;
                const pedestal = BABYLON.MeshBuilder.CreateBox("pedestal", {
                    width: mapWidth,
                    depth: mapHeight,
                    height: boxHeight
                }, scene);

                // Position: Center is (0,0,0). 
                // If box is 5 units tall, its center needs to be at -2.5 so its top is at 0.
                pedestal.position.y = terrainMinHeight - (boxHeight / 2) + 0.1; // +0.1 to ensure slight overlap/seal
                
                // Material for the Pedestal (Sides/Bottom)
                const pedestalMat = new BABYLON.StandardMaterial("pedestalMat", scene);
                pedestalMat.diffuseColor = new BABYLON.Color3(0.15, 0.12, 0.1); // Dark soil/rock color
                pedestalMat.specularColor = BABYLON.Color3.Black(); // Matte finish
                pedestal.material = pedestalMat;

                // GUI Layer for Labels
                const advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

                // --- Helper: Find Peaks and Place Markers ---
                function onTerrainReady(groundMesh) {
                    // We will analyze the vertex data to find 3 distinct peaks
                    const positions = groundMesh.getVerticesData(BABYLON.VertexBuffer.PositionKind);
                    let peaks = []; // Stores {x, y, z}

                    // scan vertices
                    for (let i = 0; i < positions.length; i += 3) {
                        const x = positions[i];
                        const y = positions[i + 1];
                        const z = positions[i + 2];
                        
                        peaks.push({x, y, z});
                    }

                    // Sort by Height (Y) descending
                    peaks.sort((a, b) => b.y - a.y);

                    // Filter peaks to ensure they are physically far apart 
                    // (so we don't mark the same mountain top 3 times)
                    const finalPeaks = [];
                    const minDistance = 20; // Minimum distance between markers

                    for(let p of peaks) {
                        if(finalPeaks.length >= 3) break;
                        
                        let tooClose = false;
                        for(let fp of finalPeaks) {
                            const dist = Math.sqrt(Math.pow(p.x - fp.x, 2) + Math.pow(p.z - fp.z, 2));
                            if(dist < minDistance) {
                                tooClose = true;
                                break;
                            }
                        }

                        if(!tooClose) {
                            finalPeaks.push(p);
                        }
                    }

                    // Create Markers
                    finalPeaks.forEach((peak, index) => {
                        createMarker(peak, `Peak 0${index + 1}\nAlt: ${Math.floor(peak.y * 100)}m`);
                    });
                }

                function createMarker(position, labelText) {
                    // 1. The Visual Marker (Pin/Sphere)
                    const marker = BABYLON.MeshBuilder.CreateSphere("marker", {diameter: 1.5}, scene);
                    marker.position = new BABYLON.Vector3(position.x, position.y, position.z);
                    
                    const markerMat = new BABYLON.StandardMaterial("markerMat", scene);
                    markerMat.emissiveColor = new BABYLON.Color3(1, 0, 0); // Glowing Red
                    markerMat.disableLighting = true;
                    marker.material = markerMat;

                    // 2. The Line (Stem)
                    const line = BABYLON.MeshBuilder.CreateLines("line", {
                        points: [
                            new BABYLON.Vector3(position.x, position.y, position.z),
                            new BABYLON.Vector3(position.x, position.y + 5, position.z)
                        ]
                    }, scene);
                    line.color = BABYLON.Color3.White();

                    // 3. The GUI Label
                    const rect = new BABYLON.GUI.Rectangle();
                    rect.width = "120px";
                    rect.height = "40px";
                    rect.cornerRadius = 5;
                    rect.color = "white";
                    rect.thickness = 2;
                    rect.background = "rgba(0, 0, 0, 0.7)";
                    
                    // This links the UI element to the 3D mesh
                    advancedTexture.addControl(rect);
                    rect.linkWithMesh(marker);
                    rect.linkOffsetY = -60; // Move label up above the mesh

                    const label = new BABYLON.GUI.TextBlock();
                    label.text = labelText;
                    label.color = "white";
                    label.fontSize = 14;
                    label.fontWeight = "bold";
                    rect.addControl(label);
                }

                return scene;
            };

            const scene = createScene();

            engine.runRenderLoop(function() {
                scene.render();
            });

            window.addEventListener('resize', function() {
                engine.resize();
            });
        });
    </script>
</body>
</html>