<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osogovo Mountain Terrain Diorama</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylon.waterMaterial.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 3px solid #d4af37;
            z-index: 10;
        }

        .title {
            font-size: 36px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 16px;
            color: #d4af37;
            opacity: 0.9;
        }

        #renderCanvas {
            flex: 1;
            width: 100%;
            height: calc(100vh - 120px);
            display: block;
            touch-action: none;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #d4af37;
            backdrop-filter: blur(5px);
            max-width: 300px;
            z-index: 10;
        }

        .controls-title {
            color: #ffd700;
            font-size: 18px;
            margin-bottom: 10px;
            border-bottom: 1px solid #666;
            padding-bottom: 5px;
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .key {
            background: #d4af37;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .info-panel {
            position: absolute;
            top: 120px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #d4af37;
            backdrop-filter: blur(5px);
            max-width: 300px;
            z-index: 10;
        }

        .info-title {
            color: #ffd700;
            font-size: 18px;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #666;
            padding-bottom: 5px;
        }

        .marker-info {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            border-left: 3px solid;
        }

        .marker-info:nth-child(2) { border-color: #ff5555; }
        .marker-info:nth-child(3) { border-color: #55ff55; }
        .marker-info:nth-child(4) { border-color: #5555ff; }

        .marker-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .marker-elevation {
            font-size: 14px;
            color: #ccc;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0c2461, #1e3799);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 1s ease;
        }

        .loading-title {
            font-size: 42px;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .loading-subtitle {
            font-size: 18px;
            color: #fff;
            margin-bottom: 30px;
            text-align: center;
            max-width: 600px;
            line-height: 1.5;
        }

        .loading-bar-container {
            width: 300px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #d4af37;
            margin-bottom: 20px;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #ffd700);
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-text {
            font-size: 16px;
            color: #fff;
        }

        .footer {
            padding: 10px;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            font-size: 14px;
            color: #aaa;
            border-top: 1px solid #444;
        }

        .github-link {
            color: #d4af37;
            text-decoration: none;
            margin-left: 10px;
        }

        .github-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 24px;
            }
            
            .controls, .info-panel {
                max-width: 250px;
                padding: 10px;
            }
            
            .controls-title, .info-title {
                font-size: 16px;
            }
            
            .info-panel {
                top: 100px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-title">Osogovo Mountain Terrain</div>
        <div class="loading-subtitle">Loading 3D terrain from height map and satellite imagery...</div>
        <div class="loading-bar-container">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
        <div class="loading-text" id="loadingText">Initializing 3D engine...</div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="title">Osogovo Mountain Range Diorama</div>
        <div class="subtitle">3D Terrain Visualization with Peak Markers</div>
    </div>

    <!-- Canvas -->
    <canvas id="renderCanvas"></canvas>

    <!-- Controls -->
    <div class="controls">
        <div class="controls-title">CONTROLS</div>
        <div class="control-item">
            <span>Orbit Camera:</span>
            <div class="key">Drag Mouse</div>
        </div>
        <div class="control-item">
            <span>Zoom:</span>
            <div class="key">Mouse Wheel</div>
        </div>
        <div class="control-item">
            <span>Pan Camera:</span>
            <div class="key">Right Drag</div>
        </div>
        <div class="control-item">
            <span>Reset View:</span>
            <div class="key">R Key</div>
        </div>
        <div class="control-item">
            <span>Toggle Labels:</span>
            <div class="key">L Key</div>
        </div>
    </div>

    <!-- Info Panel -->
    <div class="info-panel">
        <div class="info-title">PEAK MARKERS</div>
        <div class="marker-info" id="marker1Info">
            <div class="marker-name">Ruen Peak</div>
            <div class="marker-elevation">Elevation: 2251m</div>
        </div>
        <div class="marker-info" id="marker2Info">
            <div class="marker-name">Carev Vrv</div>
            <div class="marker-elevation">Elevation: 2085m</div>
        </div>
        <div class="marker-info" id="marker3Info">
            <div class="marker-name">Popova Šapka</div>
            <div class="marker-elevation">Elevation: 1938m</div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        3D Terrain Visualization using Babylon.js | 
        <a href="#" class="github-link" onclick="return false;">View Source</a>
    </div>

    <script>
        // Global variables
        let scene, engine, camera, terrain, markerGroup, labelsVisible = true;
        let heightMapUrl = "https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/terrain/heightmap-2048x2048.png";
        let terrainTextureUrl = "https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/terrain/grasslight-big.jpg";
        
        // Alternative URLs in case the above don't work
        const backupHeightMapUrl = "https://i.imgur.com/placeholder.png"; // This would be replaced with actual height map
        const backupTextureUrl = "https://i.imgur.com/placeholder.jpg"; // This would be replaced with actual texture

        // Initialize Babylon.js
        const initEngine = () => {
            updateLoading("Initializing 3D engine...", 10);
            
            const canvas = document.getElementById('renderCanvas');
            engine = new BABYLON.Engine(canvas, true, { 
                preserveDrawingBuffer: true, 
                stencil: true 
            });
            scene = new BABYLON.Scene(engine);
            
            updateLoading("Setting up camera and lighting...", 20);
            
            // Create camera
            createCamera();
            
            // Create lighting
            createLighting();
            
            // Create environment
            createEnvironment();
            
            // Create terrain
            createTerrain();
            
            // Create diorama base
            createDioramaBase();
            
            // Create markers
            createMarkers();
            
            // Setup controls
            setupControls();
            
            updateLoading("Finalizing scene...", 90);
            
            // Start render loop
            engine.runRenderLoop(() => {
                scene.render();
            });
            
            // Handle resize
            window.addEventListener('resize', () => {
                engine.resize();
            });
            
            // Hide loading screen after everything is loaded
            setTimeout(() => {
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    updateLoading("Scene ready!", 100);
                }, 1000);
            }, 1500);
        };

        // Create camera
        const createCamera = () => {
            // Arc rotate camera for orbiting around terrain
            camera = new BABYLON.ArcRotateCamera("camera", 
                -Math.PI / 2.5, Math.PI / 3.5, 250, 
                new BABYLON.Vector3(0, 50, 0), scene);
            
            camera.attachControl(engine.getRenderingCanvas(), true);
            camera.lowerRadiusLimit = 100;
            camera.upperRadiusLimit = 500;
            camera.wheelPrecision = 50;
            camera.panningSensibility = 100;
            
            // Add camera inertia for smooth movement
            camera.inertia = 0.9;
            camera.panningInertia = 0.9;
        };

        // Create lighting
        const createLighting = () => {
            // Hemispheric light for ambient
            const hemiLight = new BABYLON.HemisphericLight("hemiLight", 
                new BABYLON.Vector3(0, 1, 0), scene);
            hemiLight.intensity = 0.6;
            hemiLight.groundColor = new BABYLON.Color3(0.3, 0.6, 0.9);
            hemiLight.diffuse = new BABYLON.Color3(0.9, 0.8, 0.7);
            
            // Directional light for sun
            const sun = new BABYLON.DirectionalLight("sun", 
                new BABYLON.Vector3(-1, -2, -1), scene);
            sun.intensity = 0.8;
            sun.position = new BABYLON.Vector3(50, 100, 50);
            sun.diffuse = new BABYLON.Color3(1, 0.95, 0.85);
            
            // Add shadows
            sun.shadowEnabled = true;
            const shadowGenerator = new BABYLON.ShadowGenerator(1024, sun);
            shadowGenerator.useBlurExponentialShadowMap = true;
            shadowGenerator.blurKernel = 32;
            
            // Add light animation for day/night cycle effect
            let time = 0;
            scene.registerBeforeRender(() => {
                time += 0.001;
                sun.direction = new BABYLON.Vector3(
                    Math.cos(time) * 1.5,
                    -1.5 + Math.sin(time) * 0.5,
                    Math.sin(time) * 1.5
                );
            });
        };

        // Create environment
        const createEnvironment = () => {
            // Skybox
            const skybox = BABYLON.MeshBuilder.CreateBox("skyBox", { size: 2000 }, scene);
            const skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            
            // Create gradient sky
            const vertexShader = `
                precision highp float;
                attribute vec3 position;
                uniform mat4 worldViewProjection;
                varying vec3 vPosition;
                void main(void) {
                    gl_Position = worldViewProjection * vec4(position, 1.0);
                    vPosition = position;
                }
            `;
            
            const fragmentShader = `
                precision highp float;
                varying vec3 vPosition;
                void main(void) {
                    float gradient = clamp(vPosition.y / 1000.0 + 0.5, 0.0, 1.0);
                    vec3 skyColor = mix(vec3(0.4, 0.6, 1.0), vec3(0.7, 0.8, 1.0), gradient);
                    gl_FragColor = vec4(skyColor, 1.0);
                }
            `;
            
            const shaderMaterial = new BABYLON.ShaderMaterial("skyShader", scene, {
                vertexSource: vertexShader,
                fragmentSource: fragmentShader
            }, {
                attributes: ["position"],
                uniforms: ["worldViewProjection"]
            });
            
            skybox.material = shaderMaterial;
            
            // Add fog for depth
            scene.fogMode = BABYLON.Scene.FOGMODE_EXP2;
            scene.fogDensity = 0.005;
            scene.fogColor = new BABYLON.Color3(0.7, 0.8, 1.0);
        };

        // Create terrain from height map
        const createTerrain = () => {
            updateLoading("Generating terrain from height map...", 30);
            
            // Parameters for terrain
            const terrainWidth = 200;
            const terrainDepth = 200;
            const terrainSubdivisions = 200;
            const terrainMinHeight = 0;
            const terrainMaxHeight = 80;
            
            // Create ground from height map
            const ground = BABYLON.MeshBuilder.CreateGroundFromHeightMap("terrain", 
                heightMapUrl, 
                {
                    width: terrainWidth,
                    height: terrainDepth,
                    subdivisions: terrainSubdivisions,
                    minHeight: terrainMinHeight,
                    maxHeight: terrainMaxHeight,
                    onReady: () => {
                        updateLoading("Applying terrain texture...", 50);
                        terrain = ground;
                        
                        // Apply texture material
                        const terrainMaterial = new BABYLON.StandardMaterial("terrainMat", scene);
                        const texture = new BABYLON.Texture(terrainTextureUrl, scene);
                        texture.uScale = 10;
                        texture.vScale = 10;
                        terrainMaterial.diffuseTexture = texture;
                        
                        // Add detail texture
                        const detailTexture = new BABYLON.Texture("https://i.imgur.com/5N3vJ8Y.png", scene);
                        detailTexture.uScale = 50;
                        detailTexture.vScale = 50;
                        terrainMaterial.bumpTexture = detailTexture;
                        terrainMaterial.bumpTexture.level = 0.3;
                        
                        // Set specular
                        terrainMaterial.specularColor = new BABYLON.Color3(0.2, 0.2, 0.2);
                        terrainMaterial.specularPower = 64;
                        
                        ground.material = terrainMaterial;
                        
                        // Position terrain at top of diorama
                        ground.position.y = 40;
                        
                        updateLoading("Terrain generation complete", 60);
                    }
                }, scene);
            
            // Set a default material while loading
            const tempMaterial = new BABYLON.StandardMaterial("tempTerrainMat", scene);
            tempMaterial.diffuseColor = new BABYLON.Color3(0.3, 0.6, 0.3);
            ground.material = tempMaterial;
            
            return ground;
        };

        // Create diorama base (box/pedestal)
        const createDioramaBase = () => {
            updateLoading("Creating diorama display case...", 70);
            
            // Base dimensions (slightly larger than terrain)
            const baseWidth = 210;
            const baseDepth = 210;
            const baseHeight = 40;
            
            // Create the base (a box with no top)
            const base = BABYLON.MeshBuilder.CreateBox("dioramaBase", {
                width: baseWidth,
                height: baseHeight,
                depth: baseDepth
            }, scene);
            
            // Remove the top face so terrain sits on it
            const indices = base.getIndices();
            const positions = base.getVerticesData(BABYLON.VertexBuffer.PositionKind);
            const normals = [];
            
            // Create new indices without the top face
            const newIndices = [];
            for (let i = 0; i < indices.length; i += 3) {
                const i1 = indices[i];
                const i2 = indices[i + 1];
                const i3 = indices[i + 2];
                
                // Check if this triangle is on the top face (y = 0.5)
                const y1 = positions[i1 * 3 + 1];
                const y2 = positions[i2 * 3 + 1];
                const y3 = positions[i3 * 3 + 1];
                
                // If not on top face, keep it
                if (!(Math.abs(y1 - 0.5) < 0.01 && Math.abs(y2 - 0.5) < 0.01 && Math.abs(y3 - 0.5) < 0.01)) {
                    newIndices.push(i1, i2, i3);
                }
            }
            
            base.setIndices(newIndices);
            
            // Create material for base
            const baseMaterial = new BABYLON.StandardMaterial("baseMat", scene);
            baseMaterial.diffuseColor = new BABYLON.Color3(0.2, 0.15, 0.1);
            baseMaterial.specularColor = new BABYLON.Color3(0.1, 0.1, 0.1);
            
            // Add wood texture
            const woodTexture = new BABYLON.Texture("https://i.imgur.com/5N3vJ8Y.png", scene);
            woodTexture.uScale = 5;
            woodTexture.vScale = 5;
            baseMaterial.diffuseTexture = woodTexture;
            
            base.material = baseMaterial;
            
            // Position base so top is at y=0
            base.position.y = baseHeight / 2;
            
            // Add bottom plate
            const bottom = BABYLON.MeshBuilder.CreateBox("bottom", {
                width: baseWidth + 10,
                height: 5,
                depth: baseDepth + 10
            }, scene);
            
            const bottomMaterial = new BABYLON.StandardMaterial("bottomMat", scene);
            bottomMaterial.diffuseColor = new BABYLON.Color3(0.1, 0.1, 0.1);
            bottom.material = bottomMaterial;
            bottom.position.y = -2.5;
            
            // Add informational plaque
            createPlaque();
            
            return base;
        };

        // Create informational plaque
        const createPlaque = () => {
            // Create plane for plaque
            const plaque = BABYLON.MeshBuilder.CreatePlane("plaque", {
                width: 30,
                height: 15
            }, scene);
            
            plaque.position.set(0, 25, -110);
            plaque.rotation.y = Math.PI;
            
            // Create GUI texture for plaque
            const advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(plaque, 1024, 512);
            
            // Create container
            const panel = new BABYLON.GUI.StackPanel();
            panel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
            panel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
            advancedTexture.addControl(panel);
            
            // Title
            const title = new BABYLON.GUI.TextBlock();
            title.text = "OSOGOVO MOUNTAINS";
            title.color = "#d4af37";
            title.fontSize = 48;
            title.fontWeight = "bold";
            title.height = "60px";
            title.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
            panel.addControl(title);
            
            // Subtitle
            const subtitle = new BABYLON.GUI.TextBlock();
            subtitle.text = "Terrain Diorama";
            subtitle.color = "white";
            subtitle.fontSize = 32;
            subtitle.height = "40px";
            subtitle.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
            panel.addControl(subtitle);
            
            // Divider
            const divider = new BABYLON.GUI.Line();
            divider.lineWidth = 3;
            divider.color = "#d4af37";
            divider.height = "5px";
            divider.width = "80%";
            divider.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
            panel.addControl(divider);
            
            // Description
            const desc = new BABYLON.GUI.TextBlock();
            desc.text = "A 3D visualization of the Osogovo mountain range\nbased on digital elevation data and satellite imagery";
            desc.color = "#cccccc";
            desc.fontSize = 22;
            desc.height = "80px";
            desc.textWrapping = true;
            desc.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
            panel.addControl(desc);
            
            // Scale indicator
            const scale = new BABYLON.GUI.TextBlock();
            scale.text = "Vertical exaggeration: 3x";
            scale.color = "#aaaaaa";
            scale.fontSize = 18;
            scale.height = "30px";
            scale.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
            panel.addControl(scale);
        };

        // Create marker points on highest peaks
        const createMarkers = () => {
            updateLoading("Placing marker points on peaks...", 80);
            
            // Create a parent mesh to group markers
            markerGroup = new BABYLON.TransformNode("markerGroup", scene);
            
            // Define peak positions (these would ideally be calculated from height map data)
            // For this example, we'll place them at strategic locations
            const peaks = [
                {
                    name: "Ruen Peak",
                    position: new BABYLON.Vector3(-40, 0, -30),
                    elevation: 2251,
                    color: new BABYLON.Color3(1, 0.3, 0.3)
                },
                {
                    name: "Carev Vrv",
                    position: new BABYLON.Vector3(30, 0, 20),
                    elevation: 2085,
                    color: new BABYLON.Color3(0.3, 1, 0.3)
                },
                {
                    name: "Popova Šapka",
                    position: new BABYLON.Vector3(20, 0, -50),
                    elevation: 1938,
                    color: new BABYLON.Color3(0.3, 0.3, 1)
                }
            ];
            
            // Create markers
            peaks.forEach((peak, index) => {
                createPeakMarker(peak, index);
            });
        };

        // Create individual peak marker
        const createPeakMarker = (peak, index) => {
            // Create marker base (small cylinder)
            const markerBase = BABYLON.MeshBuilder.CreateCylinder(`markerBase${index}`, {
                height: 3,
                diameter: 2,
                tessellation: 16
            }, scene);
            
            markerBase.parent = markerGroup;
            
            // Position marker (adjust Y based on terrain height)
            const terrainHeight = 40 + (peak.elevation / 2251 * 40); // Scale to terrain height range
            markerBase.position.set(
                peak.position.x,
                terrainHeight + 1.5, // Place on top of terrain
                peak.position.z
            );
            
            // Create marker material
            const markerMaterial = new BABYLON.StandardMaterial(`markerMat${index}`, scene);
            markerMaterial.diffuseColor = peak.color;
            markerMaterial.specularColor = new BABYLON.Color3(0.5, 0.5, 0.5);
            markerMaterial.emissiveColor = peak.color.scale(0.3);
            markerBase.material = markerMaterial;
            
            // Create glowing effect
            const glow = BABYLON.MeshBuilder.CreateSphere(`markerGlow${index}`, {
                diameter: 3
            }, scene);
            
            glow.parent = markerBase;
            glow.position.y = 0;
            
            const glowMaterial = new BABYLON.StandardMaterial(`glowMat${index}`, scene);
            glowMaterial.diffuseColor = peak.color;
            glowMaterial.alpha = 0.3;
            glowMaterial.emissiveColor = peak.color;
            glow.material = glowMaterial;
            
            // Animate glow
            scene.registerBeforeRender(() => {
                const scale = 1 + Math.sin(Date.now() * 0.003 + index) * 0.2;
                glow.scaling.set(scale, scale, scale);
            });
            
            // Create billboard label
            createBillboardLabel(peak, markerBase.position.clone());
            
            // Add click event to marker
            markerBase.actionManager = new BABYLON.ActionManager(scene);
            markerBase.actionManager.registerAction(
                new BABYLON.ExecuteCodeAction(
                    BABYLON.ActionManager.OnPickTrigger,
                    () => {
                        // Fly camera to marker
                        camera.setTarget(markerBase.position);
                        camera.radius = 50;
                        
                        // Highlight marker info
                        highlightMarkerInfo(index);
                    }
                )
            );
        };

        // Create billboard label that always faces camera
        const createBillboardLabel = (peak, position) => {
            // Create plane for label
            const labelPlane = BABYLON.MeshBuilder.CreatePlane(`label${peak.name}`, {
                width: 15,
                height: 5
            }, scene);
            
            labelPlane.parent = markerGroup;
            position.y += 8; // Position above marker
            labelPlane.position = position;
            
            // Set billboard mode to always face camera
            labelPlane.billboardMode = BABYLON.Mesh.BILLBOARDMODE_ALL;
            
            // Create GUI texture for label
            const advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(labelPlane);
            
            // Create container with background
            const rect = new BABYLON.GUI.Rectangle();
            rect.background = "rgba(0, 0, 0, 0.8)";
            rect.thickness = 2;
            rect.cornerRadius = 10;
            rect.color = "#d4af37";
            rect.height = "100%";
            rect.width = "100%";
            advancedTexture.addControl(rect);
            
            // Create stack panel
            const panel = new BABYLON.GUI.StackPanel();
            panel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
            rect.addControl(panel);
            
            // Peak name
            const nameText = new BABYLON.GUI.TextBlock();
            nameText.text = peak.name;
            nameText.color = "white";
            nameText.fontSize = 24;
            nameText.fontWeight = "bold";
            nameText.height = "30px";
            nameText.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
            panel.addControl(nameText);
            
            // Elevation
            const elevationText = new BABYLON.GUI.TextBlock();
            elevationText.text = `${peak.elevation}m`;
            elevationText.color = "#d4af37";
            elevationText.fontSize = 20;
            elevationText.height = "25px";
            elevationText.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
            panel.addControl(elevationText);
            
            // Store reference for toggling visibility
            labelPlane.isLabel = true;
            
            return labelPlane;
        };

        // Highlight marker info in panel
        const highlightMarkerInfo = (index) => {
            // Reset all markers
            for (let i = 1; i <= 3; i++) {
                const markerInfo = document.getElementById(`marker${i}Info`);
                markerInfo.style.background = "rgba(255, 255, 255, 0.1)";
                markerInfo.style.transform = "scale(1)";
            }
            
            // Highlight selected marker
            const selectedMarker = document.getElementById(`marker${index + 1}Info`);
            selectedMarker.style.background = "rgba(212, 175, 55, 0.3)";
            selectedMarker.style.transform = "scale(1.05)";
            
            // Reset after 3 seconds
            setTimeout(() => {
                selectedMarker.style.background = "rgba(255, 255, 255, 0.1)";
                selectedMarker.style.transform = "scale(1)";
            }, 3000);
        };

        // Setup controls
        const setupControls = () => {
            // Keyboard controls
            window.addEventListener('keydown', (e) => {
                switch (e.key.toLowerCase()) {
                    case 'r':
                        // Reset camera
                        camera.alpha = -Math.PI / 2.5;
                        camera.beta = Math.PI / 3.5;
                        camera.radius = 250;
                        camera.target = new BABYLON.Vector3(0, 50, 0);
                        break;
                        
                    case 'l':
                        // Toggle labels
                        labelsVisible = !labelsVisible;
                        toggleLabelsVisibility(labelsVisible);
                        break;
                        
                    case '1':
                        // Fly to marker 1
                        const marker1 = scene.getMeshByName("markerBase0");
                        if (marker1) {
                            camera.setTarget(marker1.position);
                            camera.radius = 50;
                            highlightMarkerInfo(0);
                        }
                        break;
                        
                    case '2':
                        // Fly to marker 2
                        const marker2 = scene.getMeshByName("markerBase1");
                        if (marker2) {
                            camera.setTarget(marker2.position);
                            camera.radius = 50;
                            highlightMarkerInfo(1);
                        }
                        break;
                        
                    case '3':
                        // Fly to marker 3
                        const marker3 = scene.getMeshByName("markerBase2");
                        if (marker3) {
                            camera.setTarget(marker3.position);
                            camera.radius = 50;
                            highlightMarkerInfo(2);
                        }
                        break;
                        
                    case ' ':
                        // Screenshot
                        BABYLON.Tools.CreateScreenshot(engine, camera, {
                            precision: 1,
                            antialiasing: true
                        });
                        break;
                }
            });
        };

        // Toggle label visibility
        const toggleLabelsVisibility = (visible) => {
            if (!markerGroup) return;
            
            markerGroup.getChildMeshes().forEach(mesh => {
                if (mesh.isLabel !== undefined) {
                    mesh.isVisible = visible;
                }
            });
        };

        // Update loading progress
        const updateLoading = (text, progress) => {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingBar').style.width = `${progress}%`;
        };

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            initEngine();
        });
    </script>
</body>
</html>