<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Body Gravitational System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a1a;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #canvas-container {
            position: relative;
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 280px;
            transition: opacity 0.3s ease;
        }

        .controls h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #4a9eff;
        }

        .control-item {
            margin-bottom: 12px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-label {
            color: #ccc;
        }

        .control-value {
            color: #4a9eff;
            font-weight: bold;
        }

        .body-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }

        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 8px 12px;
            background: linear-gradient(135deg, #4a9eff, #2563eb);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .mission-status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            max-width: 350px;
        }

        .mission-status h4 {
            color: #4a9eff;
            margin-bottom: 8px;
        }

        .mission-phase {
            color: #4ade80;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .mission-detail {
            color: #ccc;
            line-height: 1.4;
        }

        .fps-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: #4a9eff;
            padding: 10px 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .controls, .mission-status, .fps-counter {
            animation: fadeIn 0.5s ease-out;
        }

        .trail-toggle {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #333;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #4a9eff;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <div class="controls">
            <h3>Gravitational System</h3>
            <div class="control-item">
                <span class="control-label">
                    <span class="body-indicator" style="background: #FFD700;"></span>Sun
                </span>
                <span class="control-value" id="sunMass">1000</span>
            </div>
            <div class="control-item">
                <span class="control-label">
                    <span class="body-indicator" style="background: #4169E1;"></span>Earth
                </span>
                <span class="control-value" id="earthVel">0.0</span>
            </div>
            <div class="control-item">
                <span class="control-label">
                    <span class="body-indicator" style="background: #CD853F;"></span>Jupiter
                </span>
                <span class="control-value" id="jupiterVel">0.0</span>
            </div>
            <div class="control-item">
                <span class="control-label">
                    <span class="body-indicator" style="background: #FF6347;"></span>Spacecraft
                </span>
                <span class="control-value" id="craftPhase">Launch</span>
            </div>
            <div class="button-group">
                <button onclick="system.reset()">Reset</button>
                <button onclick="system.togglePause()">Pause</button>
                <button onclick="system.launchSpacecraft()">Launch</button>
            </div>
            <div class="trail-toggle">
                <span style="color: #ccc;">Trails:</span>
                <div class="toggle-switch active" onclick="toggleTrails()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>

        <div class="mission-status">
            <h4>Mission Status</h4>
            <div class="mission-phase" id="missionPhase">Preparing Launch</div>
            <div class="mission-detail" id="missionDetail">
                Spacecraft is docked at Earth, preparing for departure.
            </div>
        </div>

        <div class="fps-counter">
            FPS: <span id="fps">60</span>
        </div>
    </div>

    <script>
        // Celestial body class
        class CelestialBody {
            constructor(x, y, mass, radius, color, name) {
                this.pos = createVector(x, y);
                this.vel = createVector(0, 0);
                this.acc = createVector(0, 0);
                this.mass = mass;
                this.radius = radius;
                this.color = color;
                this.name = name;
                this.trail = [];
                this.maxTrailLength = 200;
            }

            applyForce(force) {
                const f = p5.Vector.div(force, this.mass);
                this.acc.add(f);
            }

            update(dt) {
                this.vel.add(p5.Vector.mult(this.acc, dt));
                this.pos.add(p5.Vector.mult(this.vel, dt));
                this.acc.mult(0);

                // Add to trail
                if (frameCount % 2 === 0) {
                    this.trail.push(createVector(this.pos.x, this.pos.y));
                    if (this.trail.length > this.maxTrailLength) {
                        this.trail.shift();
                    }
                }
            }

            draw() {
                // Draw trail
                if (showTrails && this.trail.length > 1) {
                    noFill();
                    for (let i = 1; i < this.trail.length; i++) {
                        const alpha = map(i, 0, this.trail.length, 20, 150);
                        stroke(red(this.color), green(this.color), blue(this.color), alpha);
                        strokeWeight(map(this.mass, 1, 1000, 1, 3));
                        line(this.trail[i - 1].x, this.trail[i - 1].y,
                             this.trail[i].x, this.trail[i].y);
                    }
                }

                // Draw body
                noStroke();
                fill(this.color);
                circle(this.pos.x, this.pos.y, this.radius * 2);
                
                // Add glow effect for sun
                if (this.name === 'Sun') {
                    for (let i = 3; i > 0; i--) {
                        fill(255, 215, 0, 20);
                        circle(this.pos.x, this.pos.y, this.radius * 2 * (1 + i * 0.5));
                    }
                }
            }
        }

        // Spacecraft class
        class Spacecraft {
            constructor(x, y) {
                this.pos = createVector(x, y);
                this.vel = createVector(0, 0);
                this.acc = createVector(0, 0);
                this.mass = 0.001;
                this.radius = 3;
                this.color = color(255, 99, 71);
                this.trail = [];
                this.maxTrailLength = 300;
                this.phase = 'docked'; // docked, departing, looping, transferring, arrived
                this.targetBody = null;
                this.burnTimer = 0;
            }

            applyForce(force) {
                const f = p5.Vector.div(force, this.mass);
                this.acc.add(f);
            }

            update(dt, bodies) {
                this.vel.add(p5.Vector.mult(this.acc, dt));
                this.pos.add(p5.Vector.mult(this.vel, dt));
                this.acc.mult(0);

                // Mission logic
                this.executeMission(bodies);

                // Add to trail
                if (frameCount % 1 === 0) {
                    this.trail.push(createVector(this.pos.x, this.pos.y));
                    if (this.trail.length > this.maxTrailLength) {
                        this.trail.shift();
                    }
                }
            }

            executeMission(bodies) {
                const earth = bodies.find(b => b.name === 'Earth');
                const sun = bodies.find(b => b.name === 'Sun');
                const jupiter = bodies.find(b => b.name === 'Jupiter');

                switch(this.phase) {
                    case 'docked':
                        // Stay with Earth
                        this.pos = earth.pos.copy();
                        this.vel = earth.vel.copy();
                        break;
                        
                    case 'departing':
                        // Depart Earth with escape velocity
                        if (this.burnTimer === 0) {
                            const escapeDir = p5.Vector.sub(this.pos, sun.pos).normalize();
                            const tangent = createVector(-escapeDir.y, escapeDir.x);
                            const escapeVel = 3.5;
                            this.vel = p5.Vector.add(earth.vel, p5.Vector.mult(tangent, escapeVel));
                            this.burnTimer++;
                        }
                        // Check if far enough from Earth
                        if (p5.Vector.dist(this.pos, earth.pos) > 50) {
                            this.phase = 'looping';
                            this.burnTimer = 0;
                        }
                        break;
                        
                    case 'looping':
                        // Complete loop around sun
                        const sunDist = p5.Vector.dist(this.pos, sun.pos);
                        const angle = atan2(this.pos.y - sun.pos.y, this.pos.x - sun.pos.x);
                        
                        // Check if completed loop (crossed starting angle)
                        if (this.burnTimer > 100 && abs(angle) < 0.1) {
                            this.phase = 'transferring';
                            this.burnTimer = 0;
                        }
                        this.burnTimer++;
                        break;
                        
                    case 'transferring':
                        // Transfer to Jupiter
                        if (this.burnTimer === 0) {
                            // Calculate transfer trajectory
                            const toJupiter = p5.Vector.sub(jupiter.pos, this.pos);
                            const transferTime = 200;
                            const requiredVel = p5.Vector.div(toJupiter, transferTime * 0.016);
                            
                            // Apply burn
                            this.vel = p5.Vector.mult(requiredVel, 1.2);
                            this.burnTimer++;
                        }
                        
                        // Check if near Jupiter
                        if (p5.Vector.dist(this.pos, jupiter.pos) < 30) {
                            this.phase = 'arrived';
                            this.burnTimer = 0;
                        }
                        break;
                        
                    case 'arrived':
                        // Orbit Jupiter
                        const jupiterDist = p5.Vector.dist(this.pos, jupiter.pos);
                        if (jupiterDist > 25) {
                            const toJupiter = p5.Vector.sub(jupiter.pos, this.pos).normalize();
                            const orbitalVel = sqrt(50 / jupiterDist);
                            const tangent = createVector(-toJupiter.y, toJupiter.x);
                            this.vel = p5.Vector.mult(tangent, orbitalVel);
                        }
                        break;
                }
            }

            draw() {
                // Draw trail
                if (showTrails && this.trail.length > 1) {
                    noFill();
                    for (let i = 1; i < this.trail.length; i++) {
                        const alpha = map(i, 0, this.trail.length, 30, 200);
                        stroke(255, 99, 71, alpha);
                        strokeWeight(2);
                        line(this.trail[i - 1].x, this.trail[i - 1].y,
                             this.trail[i].x, this.trail[i].y);
                    }
                }

                // Draw spacecraft
                noStroke();
                fill(this.color);
                circle(this.pos.x, this.pos.y, this.radius * 2);
                
                // Draw thrust when burning
                if (this.burnTimer > 0 && this.burnTimer < 10) {
                    fill(255, 200, 0, 150);
                    const thrustDir = p5.Vector.mult(this.vel, -1).normalize();
                    for (let i = 0; i < 3; i++) {
                        const offset = p5.Vector.mult(thrustDir, (i + 1) * 3);
                        circle(this.pos.x + offset.x, this.pos.y + offset.y, 3 - i);
                    }
                }
            }
        }

        // Gravitational system
        class GravitationalSystem {
            constructor() {
                this.bodies = [];
                this.spacecraft = null;
                this.G = 1; // Gravitational constant
                this.dt = 0.016;
                this.paused = false;
                this.init();
            }

            init() {
                this.bodies = [];
                
                // Create Sun at center
                const sun = new CelestialBody(width / 2, height / 2, 1000, 20, color(255, 215, 0), 'Sun');
                this.bodies.push(sun);

                // Create Earth in chaotic orbit
                const earthDist = 120;
                const earthAngle = random(TWO_PI);
                const earthX = width / 2 + earthDist * cos(earthAngle);
                const earthY = height / 2 + earthDist * sin(earthAngle);
                const earth = new CelestialBody(earthX, earthY, 10, 8, color(65, 105, 225), 'Earth');
                
                // Chaotic velocity for Earth
                const earthVel = sqrt(this.G * sun.mass / earthDist) * random(0.8, 1.2);
                const earthTangent = createVector(-sin(earthAngle), cos(earthAngle));
                earth.vel = p5.Vector.mult(earthTangent, earthVel);
                earth.vel.add(p5.Vector.random2D().mult(0.5));
                
                this.bodies.push(earth);

                // Create Jupiter in different chaotic orbit
                const jupiterDist = 200;
                const jupiterAngle = random(TWO_PI);
                const jupiterX = width / 2 + jupiterDist * cos(jupiterAngle);
                const jupiterY = height / 2 + jupiterDist * sin(jupiterAngle);
                const jupiter = new CelestialBody(jupiterX, jupiterY, 50, 15, color(205, 133, 63), 'Jupiter');
                
                // Chaotic velocity for Jupiter
                const jupiterVel = sqrt(this.G * sun.mass / jupiterDist) * random(0.7, 1.1);
                const jupiterTangent = createVector(-sin(jupiterAngle), cos(jupiterAngle));
                jupiter.vel = p5.Vector.mult(jupiterTangent, jupiterVel);
                jupiter.vel.add(p5.Vector.random2D().mult(0.3));
                
                this.bodies.push(jupiter);

                // Create spacecraft docked at Earth
                this.spacecraft = new Spacecraft(earthX, earthY);
            }

            calculateGravity() {
                for (let i = 0; i < this.bodies.length; i++) {
                    for (let j = i + 1; j < this.bodies.length; j++) {
                        const body1 = this.bodies[i];
                        const body2 = this.bodies[j];
                        
                        const force = p5.Vector.sub(body2.pos, body1.pos);
                        const distSq = force.magSq();
                        const dist = sqrt(distSq);
                        
                        // Prevent singularities
                        const minDist = body1.radius + body2.radius;
                        if (dist < minDist) continue;
                        
                        const strength = this.G * body1.mass * body2.mass / distSq;
                        force.setMag(strength);
                        
                        body1.applyForce(force);
                        body2.applyForce(p5.Vector.mult(force, -1));
                    }
                }

                // Apply gravity to spacecraft
                if (this.spacecraft) {
                    for (const body of this.bodies) {
                        const force = p5.Vector.sub(body.pos, this.spacecraft.pos);
                        const distSq = force.magSq();
                        const dist = sqrt(distSq);
                        
                        const minDist = body.radius + this.spacecraft.radius;
                        if (dist < minDist) continue;
                        
                        const strength = this.G * body.mass * this.spacecraft.mass / distSq;
                        force.setMag(strength);
                        this.spacecraft.applyForce(force);
                    }
                }
            }

            update() {
                if (this.paused) return;

                this.calculateGravity();

                for (const body of this.bodies) {
                    body.update(this.dt);
                }

                if (this.spacecraft) {
                    this.spacecraft.update(this.dt, this.bodies);
                }

                this.updateUI();
            }

            draw() {
                background(220);

                for (const body of this.bodies) {
                    body.draw();
                }

                if (this.spacecraft) {
                    this.spacecraft.draw();
                }
            }

            updateUI() {
                const earth = this.bodies.find(b => b.name === 'Earth');
                const jupiter = this.bodies.find(b => b.name === 'Jupiter');
                
                document.getElementById('earthVel').textContent = earth.vel.mag().toFixed(2);
                document.getElementById('jupiterVel').textContent = jupiter.vel.mag().toFixed(2);
                
                if (this.spacecraft) {
                    const phaseNames = {
                        'docked': 'Docked',
                        'departing': 'Departing',
                        'looping': 'Solar Loop',
                        'transferring': 'To Jupiter',
                        'arrived': 'At Jupiter'
                    };
                    document.getElementById('craftPhase').textContent = phaseNames[this.spacecraft.phase];
                    
                    const phaseDescriptions = {
                        'docked': 'Spacecraft is docked at Earth, preparing for departure.',
                        'departing': 'Executing departure burn from Earth orbit.',
                        'looping': 'Performing gravity assist loop around the Sun.',
                        'transferring': 'On transfer trajectory to Jupiter.',
                        'arrived': 'Successfully arrived and orbiting Jupiter.'
                    };
                    document.getElementById('missionPhase').textContent = phaseNames[this.spacecraft.phase];
                    document.getElementById('missionDetail').textContent = phaseDescriptions[this.spacecraft.phase];
                }
            }

            reset() {
                this.init();
            }

            togglePause() {
                this.paused = !this.paused;
            }

            launchSpacecraft() {
                if (this.spacecraft && this.spacecraft.phase === 'docked') {
                    this.spacecraft.phase = 'departing';
                    this.spacecraft.burnTimer = 0;
                }
            }
        }

        // Global variables
        let system;
        let showTrails = true;
        let fps = 60;
        let frameCounter = 0;

        function setup() {
            createCanvas(windowWidth, windowHeight);
            system = new GravitationalSystem();
        }

        function draw() {
            system.update();
            system.draw();

            // Update FPS counter
            frameCounter++;
            if (frameCounter % 30 === 0) {
                fps = Math.round(frameRate());
                document.getElementById('fps').textContent = fps;
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        function keyPressed() {
            if (key === ' ') {
                system.togglePause();
            } else if (key === 'r' || key === 'R') {
                system.reset();
            } else if (key === 'l' || key === 'L') {
                system.launchSpacecraft();
            } else if (key === 't' || key === 'T') {
                toggleTrails();
            }
        }

        function toggleTrails() {
            showTrails = !showTrails;
            const toggle = document.querySelector('.toggle-switch');
            toggle.classList.toggle('active');
            
            if (!showTrails) {
                for (const body of system.bodies) {
                    body.trail = [];
                }
                if (system.spacecraft) {
                    system.spacecraft.trail = [];
                }
            }
        }
    </script>
</body>
</html>