<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaotic Three-Body System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: rgb(220, 220, 220); }
        canvas { display: block; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <!-- UI Overlay -->
    <div class="absolute top-4 left-4 w-72 glass-panel rounded-xl p-5 text-slate-800 z-10 select-none">
        <h1 class="text-xl font-bold text-slate-900 mb-1">Three-Body System</h1>
        <p class="text-xs text-slate-500 mb-4">Chaotic Orbital Mechanics</p>

        <div class="space-y-2 text-xs mb-4">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                <span>Sun (Central Mass)</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                <span>Earth</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                <span>Jupiter</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-slate-800" style="clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
                <span>Spacecraft</span>
            </div>
        </div>

        <div class="flex gap-2">
            <button id="btn-reset" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded text-xs font-bold transition">Reset System</button>
            <button id="btn-pause" class="flex-1 bg-white hover:bg-slate-100 text-slate-800 border border-slate-300 py-2 rounded text-xs font-bold transition">Pause</button>
        </div>
        
        <div class="mt-3 text-[10px] text-slate-500">
            Watch for the spacecraft's gravity assist maneuvers
        </div>
    </div>

    <script>
        // --- Configuration ---
        const G = 0.5; // Gravitational constant
        const TRAIL_LENGTH = 300;
        const TIME_STEP = 0.5;

        // --- Classes ---

        class Body {
            constructor(name, x, y, vx, vy, mass, radius, color) {
                this.name = name;
                this.pos = createVector(x, y);
                this.vel = createVector(vx, vy);
                this.acc = createVector(0, 0);
                this.mass = mass;
                this.radius = radius;
                this.color = color;
                this.trail = [];
            }

            applyForce(force) {
                let f = p5.Vector.div(force, this.mass);
                this.acc.add(f);
            }

            update() {
                this.vel.add(this.acc);
                this.pos.add(p5.Vector.mult(this.vel, TIME_STEP));
                this.acc.mult(0);

                // Update trail
                this.trail.push(this.pos.copy());
                if (this.trail.length > TRAIL_LENGTH) {
                    this.trail.shift();
                }
            }

            show() {
                // Draw trail
                noFill();
                stroke(red(this.color), green(this.color), blue(this.color), 100);
                strokeWeight(2);
                beginShape();
                for (let pos of this.trail) {
                    vertex(pos.x, pos.y);
                }
                endShape();

                // Draw body
                noStroke();
                fill(this.color);
                ellipse(this.pos.x, this.pos.y, this.radius * 2);

                // Glow for Sun
                if (this.name === 'Sun') {
                    fill(255, 200, 0, 50);
                    ellipse(this.pos.x, this.pos.y, this.radius * 4);
                }
            }
        }

        class Spacecraft {
            constructor(earth) {
                this.pos = earth.pos.copy();
                // Initial velocity: Earth's velocity plus escape velocity component
                this.vel = earth.vel.copy();
                this.vel.add(p5.Vector.random2D().mult(2));
                this.acc = createVector(0, 0);
                this.trail = [];
                this.state = 'departing'; // departing, looping, transferring, arriving
                this.loopCenter = null;
                this.loopStartTime = 0;
            }

            applyForce(force) {
                this.acc.add(force);
            }

            update(bodies, time) {
                this.vel.add(this.acc);
                this.pos.add(p5.Vector.mult(this.vel, TIME_STEP));
                this.acc.mult(0);

                this.trail.push(this.pos.copy());
                if (this.trail.length > TRAIL_LENGTH * 2) {
                    this.trail.shift();
                }

                // Mission logic
                this.updateMissionState(bodies, time);
            }

            updateMissionState(bodies, time) {
                let sun = bodies[0];
                let earth = bodies[1];
                let jupiter = bodies[2];

                let distToSun = p5.Vector.dist(this.pos, sun.pos);
                let distToEarth = p5.Vector.dist(this.pos, earth.pos);
                let distToJupiter = p5.Vector.dist(this.pos, jupiter.pos);

                switch(this.state) {
                    case 'departing':
                        // Move away from Earth, start loop around Sun
                        if (distToEarth > 80 && distToSun < 150) {
                            this.state = 'looping';
                            this.loopCenter = sun.pos.copy();
                            this.loopStartTime = time;
                        }
                        break;
                    
                    case 'looping':
                        // Complete one loop around Sun
                        if (time - this.loopStartTime > 400 && distToSun > 100) {
                            this.state = 'transferring';
                        }
                        break;
                    
                    case 'transferring':
                        // Navigate toward Jupiter
                        if (distToJupiter < 100) {
                            this.state = 'arriving';
                        }
                        break;
                    
                    case 'arriving':
                        // Orbit Jupiter
                        break;
                }
            }

            show() {
                // Draw trail with fade
                noFill();
                stroke(30, 30, 30, 150);
                strokeWeight(1.5);
                beginShape();
                for (let pos of this.trail) {
                    vertex(pos.x, pos.y);
                }
                endShape();

                // Draw spacecraft
                noStroke();
                fill(30);
                
                // Triangle pointing in direction of velocity
                push();
                translate(this.pos.x, this.pos.y);
                rotate(this.vel.heading() + PI/2);
                triangle(0, -6, -4, 4, 4, 4);
                pop();

                // Mission indicator
                fill(0);
                textSize(10);
                text(this.state, this.pos.x + 10, this.pos.y - 10);
            }
        }

        // --- Simulation ---

        let bodies = [];
        let spacecraft = null;
        let isRunning = true;
        let simulationTime = 0;
        let centerOffset;

        function setup() {
            createCanvas(windowWidth, windowHeight);
            centerOffset = createVector(width/2, height/2);
            initSystem();
            setupUI();
        }

        function initSystem() {
            bodies = [];
            simulationTime = 0;

            // Chaotic but bounded configuration
            // Sun at center but with slight offset velocity for chaotic motion
            let sun = new Body('Sun', 0, 0, 0.1, -0.05, 800, 25, color(255, 200, 0));
            
            // Earth: Close orbit, high velocity, eccentric
            let earth = new Body('Earth', 120, 20, -0.8, 2.2, 15, 8, color(50, 100, 255));
            
            // Jupiter: Larger orbit, different plane inclination effect via velocity
            let jupiter = new Body('Jupiter', -180, -80, 1.2, -0.9, 120, 15, color(255, 150, 50));

            bodies = [sun, earth, jupiter];
            
            // Center the system
            recenter();

            // Create spacecraft starting at Earth
            spacecraft = new Spacecraft(earth);
        }

        function recenter() {
            // Calculate system center of mass
            let totalMass = 0;
            let com = createVector(0, 0);
            for (let b of bodies) {
                com.add(p5.Vector.mult(b.pos, b.mass));
                totalMass += b.mass;
            }
            com.div(totalMass);

            // Offset all positions to keep COM at center of screen
            let offset = p5.Vector.sub(centerOffset, com);
            for (let b of bodies) {
                b.pos.add(offset);
                // Shift trails too
                for (let pos of b.trail) {
                    pos.add(offset);
                }
            }
            if (spacecraft) {
                spacecraft.pos.add(offset);
                for (let pos of spacecraft.trail) {
                    pos.add(offset);
                }
            }
        }

        function calculateForces() {
            // N-body gravity
            for (let i = 0; i < bodies.length; i++) {
                for (let j = i + 1; j < bodies.length; j++) {
                    let b1 = bodies[i];
                    let b2 = bodies[j];
                    
                    let dir = p5.Vector.sub(b2.pos, b1.pos);
                    let dist = dir.mag();
                    dir.normalize();
                    
                    // Softening parameter to prevent singularities
                    let forceMag = (G * b1.mass * b2.mass) / (dist * dist + 100);
                    let force = p5.Vector.mult(dir, forceMag);
                    
                    b1.applyForce(force);
                    b2.applyForce(p5.Vector.mult(force, -1));
                }
            }

            // Spacecraft forces
            if (spacecraft) {
                for (let b of bodies) {
                    let dir = p5.Vector.sub(b.pos, spacecraft.pos);
                    let dist = dir.mag();
                    dir.normalize();
                    let forceMag = (G * b.mass * 0.5) / (dist * dist + 50); // Spacecraft mass = 0.5
                    let force = p5.Vector.mult(dir, forceMag);
                    spacecraft.applyForce(force);
                }
            }
        }

        function draw() {
            if (!isRunning) return;

            // Semi-transparent background for trails
            background(220, 220, 220, 30);

            calculateForces();

            // Update bodies
            for (let b of bodies) {
                b.update();
            }

            // Update spacecraft
            if (spacecraft) {
                spacecraft.update(bodies, simulationTime);
            }

            // Recenter to keep everything in view
            if (simulationTime % 10 === 0) {
                recenter();
            }

            // Draw everything
            for (let b of bodies) {
                b.show();
            }
            if (spacecraft) {
                spacecraft.show();
            }

            simulationTime++;
        }

        function setupUI() {
            document.getElementById('btn-reset').addEventListener('click', () => {
                initSystem();
            });

            document.getElementById('btn-pause').addEventListener('click', (e) => {
                isRunning = !isRunning;
                e.target.textContent = isRunning ? 'Pause' : 'Resume';
            });
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            centerOffset = createVector(width/2, height/2);
        }

    </script>
</body>
</html>