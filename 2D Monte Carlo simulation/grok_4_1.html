<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolving Ecosystem - Monte Carlo Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0a0a0f;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #e0e0ff;
        }
        
        #container {
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .ui-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(15,15,35,0.95);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(100,150,255,0.3);
            width: 340px;
            transition: transform 0.3s ease;
            z-index: 100;
        }
        
        .ui-panel.hidden {
            transform: translateX(-380px);
        }
        
        h2 {
            margin: 0 0 15px 0;
            color: #64b5f6;
            font-size: 20px;
            text-shadow: 0 0 10px rgba(100,180,255,0.5);
        }
        
        .control {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #b0c4ff;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #64b5f6;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(100,180,255,0.6);
        }
        
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }
        
        .stats {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(15,15,35,0.95);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(100,150,255,0.3);
            font-size: 12px;
            max-width: 300px;
        }
        
        .stats h4 {
            margin: 0 0 10px 0;
            color: #64b5f6;
        }
        
        .stat-line {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }
        
        .legend {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(15,15,35,0.95);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(100,150,255,0.3);
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0;
        }
        
        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        .toggle {
            position: absolute;
            top: 15px;
            left: 375px;
            background: rgba(15,15,35,0.95);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 0 12px 12px 0;
            cursor: pointer;
            font-size: 18px;
        }
        
        .toggle.shifted {
            left: 15px;
        }
        
        #chart-container {
            position: absolute;
            bottom: 15px;
            right: 15px;
            width: 380px;
            height: 180px;
            background: rgba(15,15,35,0.95);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(100,150,255,0.3);
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="ui-panel" id="ui">
            <h2>Ecosystem Evolution</h2>
            
            <div class="control">
                <label>Simulation Speed: <span id="speedVal">1.0</span>x</label>
                <input type="range" id="speed" min="0.1" max="5.0" step="0.1" value="1.0">
            </div>
            
            <div class="control">
                <label>Mutation Rate: <span id="mutationVal">0.05</span></label>
                <input type="range" id="mutation" min="0" max="0.2" step="0.01" value="0.05">
            </div>
            
            <div class="control">
                <label>Plant Growth Rate: <span id="plantGrowthVal">0.03</span></label>
                <input type="range" id="plantGrowth" min="0.001" max="0.1" step="0.001" value="0.03">
            </div>
            
            <div class="control">
                <label>Herbivore Efficiency: <span id="herbEffVal">0.6</span></label>
                <input type="range" id="herbEff" min="0.2" max="1.0" step="0.05" value="0.6">
            </div>
            
            <div class="control">
                <label>Predator Efficiency: <span id="predEffVal">0.4</span></label>
                <input type="range" id="predEff" min="0.1" max="0.8" step="0.05" value="0.4">
            </div>
            
            <div class="control">
                <label>Carrying Capacity: <span id="capacityVal">3</span></label>
                <input type="range" id="capacity" min="1" max="8" step="1" value="3">
            </div>
            
            <div class="btn-grid">
                <button onclick="eco.reset()">Reset</button>
                <button onclick="eco.togglePause()">Pause</button>
            </div>
        </div>
        
        <button class="toggle" id="toggleBtn" onclick="toggleUI()">◀</button>
        
        <div class="stats">
            <h4>Statistics</h4>
            <div class="stat-line"><span>Generation:</span> <span id="gen">0</span></div>
            <div class="stat-line"><span style="color:#4ade80">Plants:</span> <span id="plants">0</span></div>
            <div class="stat-line"><span style="color:#60a5fa">Herbivores:</span> <span id="herbs">0</span></div>
            <div class="stat-line"><span style="color:#f87171">Predators:</span> <span id="preds">0</span></div>
            <div class="stat-line"><span>Avg Speed:</span> <span id="avgSpeed">1.0</span></div>
            <div class="stat-line"><span>Avg Vision:</span> <span id="avgVision">2.0</span></div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="color-box" style="background:#1a2d0f"></div>
                <span>Empty</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background:#4ade80"></div>
                <span>Plant (size = energy)</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background:#60a5fa"></div>
                <span>Herbivore (hue = speed)</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background:#f87171"></div>
                <span>Predator (brightness = vision)</span>
            </div>
        </div>
        
        <div id="chart-container">
            <canvas id="popChart"></canvas>
        </div>
    </div>

    <script>
        class Ecosystem {
            constructor() {
                this.gridSize = 120;
                this.grid = [];
                this.agents = [];
                this.generation = 0;
                this.time = 0;
                
                // Parameters
                this.speedMult = 1.0;
                this.mutationRate = 0.05;
                this.plantGrowthRate = 0.03;
                this.herbivoreEfficiency = 0.6;
                this.predatorEfficiency = 0.4;
                this.carryingCapacity = 3;
                this.paused = false;
                
                this.init();
                this.setupChart();
            }
            
            init() {
                // Create grid
                for (let i = 0; i < this.gridSize; i++) {
                    this.grid[i] = [];
                    for (let j = 0; j < this.gridSize; j++) {
                        this.grid[i][j] = null;
                    }
                }
                
                // Create initial population
                this.agents = [];
                
                // Plants
                for (let i = 0; i < 800; i++) {
                    const x = Math.floor(Math.random() * this.gridSize);
                    const y = Math.floor(Math.random() * this.gridSize);
                    this.grid[x][y] = {
                        type: 'plant',
                        energy: Math.random() * 100 + 50
                    };
                }
                
                // Herbivores
                for (let i = 0; i < 150; i++) {
                    const x = Math.floor(Math.random() * this.gridSize);
                    const y = Math.floor(Math.random() * this.gridSize);
                    if (!this.grid[x][y]) {
                        this.agents.push({
                            x, y,
                            type: 'herbivore',
                            energy: 200,
                            speed: 1 + Math.random() * 1.5,
                            vision: 2 + Math.floor(Math.random() * 3),
                            generation: 0
                        });
                        this.grid[x][y] = this.agents[this.agents.length - 1];
                    }
                }
                
                // Predators
                for (let i = 0; i < 30; i++) {
                    const x = Math.floor(Math.random() * this.gridSize);
                    const y = Math.floor(Math.random() * this.gridSize);
                    if (!this.grid[x][y]) {
                        this.agents.push({
                            x, y,
                            type: 'predator',
                            energy: 300,
                            speed: 1.2 + Math.random() * 1.8,
                            vision: 3 + Math.floor(Math.random() * 4),
                            generation: 0
                        });
                        this.grid[x][y] = this.agents[this.agents.length - 1];
                    }
                }
            }
            
            update() {
                if (this.paused) return;
                
                this.time++;
                if (this.time % Math.floor(20 / this.speedMult) !== 0) return;
                
                // Plant growth
                if (Math.random() < this.plantGrowthRate * 20) {
                    const x = Math.floor(Math.random() * this.gridSize);
                    const y = Math.floor(Math.random() * this.gridSize);
                    
                    if (this.grid[x][y] && this.grid[x][y].type === 'plant') {
                        this.grid[x][y].energy = Math.min(200, this.grid[x][y].energy + 20);
                    } else if (!this.grid[x][y] && this.countNeighbors(x, y, 'plant') < this.carryingCapacity) {
                        this.grid[x][y] = {
                            type: 'plant',
                            energy: 80
                        };
                    }
                }
                
                // Process agents (Monte Carlo style - random order)
                const shuffled = this.agents.slice();
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                for (const agent of shuffled) {
                    if (!agent || agent.energy <= 0) continue;
                    
                    // Metabolism
                    agent.energy -= 0.5 + agent.speed * 0.3;
                    
                    // Movement
                    const candidates = this.getNeighbors(agent.x, agent.y, agent.vision);
                    let bestMove = null;
                    let bestScore = -Infinity;
                    
                    for (const [dx, dy, nx, ny] of candidates) {
                        if (nx < 0 || nx >= this.gridSize || ny < 0 || ny >= this.gridSize) continue;
                        
                        let score = 0;
                        const cell = this.grid[nx][ny];
                        
                        if (agent.type === 'herbivore') {
                            if (cell && cell.type === 'plant') {
                                score = cell.energy / 10;
                            }
                            if (cell && cell.type === 'predator') {
                                score = -1000;
                            }
                        } else if (agent.type === 'predator') {
                            if (cell && cell.type === 'herbivore') {
                                score = cell.energy / 5;
                            }
                        }
                        
                        // Avoid overcrowding
                        score -= this.countNeighbors(nx, ny, agent.type) * 10;
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestMove = [nx, ny];
                        }
                    }
                    
                    // Move if beneficial
                    if (bestMove && bestScore > -50) {
                        const [nx, ny] = bestMove;
                        if (!this.grid[nx][ny] || this.grid[nx][ny].type === 'plant') {
                            this.grid[agent.x][agent.y] = null;
                            agent.x = nx;
                            agent.y = ny;
                            this.grid[nx][ny] = agent;
                            
                            agent.energy -= agent.speed * 2;
                        }
                    }
                    
                    // Eating
                    const cell = this.grid[agent.x][agent.y];
                    if (agent.type === 'herbivore' && cell && cell.type === 'plant') {
                        const food = Math.min(cell.energy, 30);
                        agent.energy += food * this.herbivoreEfficiency;
                        cell.energy -= food;
                        if (cell.energy <= 10) {
                            this.grid[agent.x][agent.y] = agent;
                        }
                    } else if (agent.type === 'predator') {
                        const prey = this.getNeighbors(agent.x, agent.y, 1).find(([dx, dy, nx, ny]) => {
                            return this.grid[nx] && this.grid[nx][ny] && this.grid[nx][ny].type === 'herbivore';
                        });
                        if (prey) {
                            const [dx, dy, nx, ny] = prey;
                            const victim = this.grid[nx][ny];
                            agent.energy += victim.energy * this.predatorEfficiency;
                            victim.energy = 0;
                        }
                    }
                    
                    // Reproduction
                    if (agent.energy > 300 && Math.random() < 0.02) {
                        const offspring = {
                            x: agent.x,
                            y: agent.y,
                            type: agent.type,
                            energy: 150,
                            speed: agent.speed,
                            vision: agent.vision,
                            generation: agent.generation + 1
                        };
                        
                        // Mutation
                        if (Math.random() < this.mutationRate) {
                            offspring.speed = constrain(offspring.speed + (Math.random() - 0.5) * 0.5, 0.5, 3.0);
                        }
                        if (Math.random() < this.mutationRate) {
                            offspring.vision = Math.max(1, Math.min(6, offspring.vision + (Math.random() > 0.5 ? 1 : -1)));
                        }
                        
                        this.agents.push(offspring);
                        this.grid[agent.x][agent.y] = offspring;
                        agent.energy -= 150;
                        
                        if (offspring.generation > this.generation) {
                            this.generation = offspring.generation;
                        }
                    }
                    
                    // Death
                    if (agent.energy <= 0) {
                        this.grid[agent.x][agent.y] = null;
                        const index = this.agents.indexOf(agent);
                        if (index > -1) this.agents.splice(index, 1);
                    }
                }
                
                this.updateStats();
                this.updateChart();
            }
            
            getNeighbors(x, y, range) {
                const neighbors = [];
                for (let dx = -range; dx <= range; dx++) {
                    for (let dy = -range; dy <= range; dy++) {
                        if (dx === 0 && dy === 0) continue;
                        neighbors.push([dx, dy, x + dx, y + dy]);
                    }
                }
                return neighbors;
            }
            
            countNeighbors(x, y, type) {
                let count = 0;
                for (let dx = -1; dx <= 1; dx++) {
                    for (let dy = -1; dy <= 1; dy++) {
                        if (dx === 0 && dy === 0) continue;
                        const nx = x + dx;
                        const ny = y + dy;
                        if (nx >= 0 && nx < this.gridSize && ny >= 0 && ny < this.gridSize) {
                            if (this.grid[nx][ny] && this.grid[nx][ny].type === type) {
                                count++;
                            }
                        }
                    }
                }
                return count;
            }
            
            render() {
                const cellSize = width / this.gridSize;
                
                for (let i = 0; i < this.gridSize; i++) {
                    for (let j = 0; j < this.gridSize; j++) {
                        const cell = this.grid[i][j];
                        let col;
                        
                        if (!cell) {
                            col = color(10, 15, 20);
                        } else if (cell.type === 'plant') {
                            const energy = cell.energy / 200;
                            col = color(20, energy * 120 + 80, 50);
                        } else if (cell.type === 'herbivore') {
                            const speedHue = map(cell.speed, 0.5, 3.0, 180, 240);
                            col = color(speedHue, 80, 70 + cell.energy / 10);
                        } else if (cell.type === 'predator') {
                            const visionBright = map(cell.vision, 1, 7, 60, 95);
                            col = color(0, 80, visionBright + cell.energy / 15);
                        }
                        
                        fill(col);
                        noStroke();
                        rect(i * cellSize, j * cellSize, cellSize, cellSize);
                    }
                }
            }
            
            updateStats() {
                let plants = 0, herbs = 0, preds = 0;
                let totalSpeed = 0, totalVision = 0, herbCount = 0;
                
                for (let i = 0; i < this.gridSize; i++) {
                    for (let j = 0; j < this.gridSize; j++) {
                        const cell = this.grid[i][j];
                        if (cell) {
                            if (cell.type === 'plant') plants++;
                            else if (cell.type === 'herbivore') {
                                herbs++;
                                totalSpeed += cell.speed;
                                herbCount++;
                            }
                            else if (cell.type === 'predator') {
                                preds++;
                                totalVision += cell.vision;
                            }
                        }
                    }
                }
                
                document.getElementById('gen').textContent = this.generation;
                document.getElementById('plants').textContent = plants;
                document.getElementById('herbs').textContent = herbs;
                document.getElementById('preds').textContent = preds;
                document.getElementById('avgSpeed').textContent = herbCount > 0 ? (totalSpeed / herbCount).toFixed(2) : '0';
                document.getElementById('avgVision').textContent = preds > 0 ? (totalVision / preds).toFixed(1) : '0';
            }
            
            setupChart() {
                const ctx = document.getElementById('popChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Plants',
                                data: [],
                                borderColor: '#4ade80',
                                backgroundColor: 'rgba(74,222,128,0.2)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Herbivores',
                                data: [],
                                borderColor: '#60a5fa',
                                backgroundColor: 'rgba(96,165,250,0.2)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Predators',
                                data: [],
                                borderColor: '#f87171',
                                backgroundColor: 'rgba(248,113,113,0.2)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });
                
                this.chartDataPoints = 0;
            }
            
            updateChart() {
                this.chartDataPoints++;
                if (this.chartDataPoints % 10 !== 0) return;
                
                let plants = 0, herbs = 0, preds = 0;
                for (let i = 0; i < this.gridSize; i++) {
                    for (let j = 0; j < this.gridSize; j++) {
                        const cell = this.grid[i][j];
                        if (cell) {
                            if (cell.type === 'plant') plants++;
                            else if (cell.type === 'herbivore') herbs++;
                            else if (cell.type === 'predator') preds++;
                        }
                    }
                }
                
                this.chart.data.labels.push(this.chart.data.labels.length);
                this.chart.data.datasets[0].data.push(plants);
                this.chart.data.datasets[1].data.push(herbs);
                this.chart.data.datasets[2].data.push(preds);
                
                if (this.chart.data.labels.length > 100) {
                    this.chart.data.labels.shift();
                    this.chart.data.datasets.forEach(ds => ds.data.shift());
                }
                
                this.chart.update('quiet');
            }
            
            reset() {
                this.init();
                this.generation = 0;
                this.time = 0;
                this.chart.data.labels = [];
                this.chart.data.datasets.forEach(ds => ds.data = []);
                this.chartDataPoints = 0;
            }
            
            togglePause() {
                this.paused = !this.paused;
            }
        }
        
        let eco;
        
        function setup() {
            createCanvas(900, 900);
            colorMode(HSB, 360, 100, 100);
            eco = new Ecosystem();
            
            // UI Controls
            document.getElementById('speed').addEventListener('input', (e) => {
                eco.speedMult = parseFloat(e.target.value);
                document.getElementById('speedVal').textContent = e.target.value;
            });
            
            document.getElementById('mutation').addEventListener('input', (e) => {
                eco.mutationRate = parseFloat(e.target.value);
                document.getElementById('mutationVal').textContent = e.target.value;
            });
            
            document.getElementById('plantGrowth').addEventListener('input', (e) => {
                eco.plantGrowthRate = parseFloat(e.target.value);
                document.getElementById('plantGrowthVal').textContent = e.target.value;
            });
            
            document.getElementById('herbEff').addEventListener('input', (e) => {
                eco.herbivoreEfficiency = parseFloat(e.target.value);
                document.getElementById('herbEffVal').textContent = e.target.value;
            });
            
            document.getElementById('predEff').addEventListener('input', (e) => {
                eco.predatorEfficiency = parseFloat(e.target.value);
                document.getElementById('predEffVal').textContent = e.target.value;
            });
            
            document.getElementById('capacity').addEventListener('input', (e) => {
                eco.carryingCapacity = parseInt(e.target.value);
                document.getElementById('capacityVal').textContent = e.target.value;
            });
        }
        
        function draw() {
            background(10, 10, 15);
            eco.update();
            eco.render();
        }
        
        function keyPressed() {
            if (key === ' ') eco.togglePause();
            if (key === 'r' || key === 'R') eco.reset();
        }
        
        function toggleUI() {
            document.getElementById('ui').classList.toggle('hidden');
            const btn = document.getElementById('toggleBtn');
            btn.classList.toggle('shifted');
            btn.textContent = document.getElementById('ui').classList.contains('hidden') ? '▶' : '◀';
        }
    </script>
</body>
</html>