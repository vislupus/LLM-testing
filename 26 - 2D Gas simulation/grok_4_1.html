<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Gas Simulation - Statistical Mechanics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0d0d1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            color: #e0e0ff;
        }
        #container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        #canvas-container {
            flex: 1;
            position: relative;
        }
        .sidebar {
            width: 380px;
            background: rgba(15, 20, 40, 0.95);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(100, 150, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        .panel {
            background: rgba(25, 35, 70, 0.6);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
            border: 1px solid rgba(100, 150, 255, 0.2);
        }
        h2 {
            margin: 0 0 15px 0;
            color: #64b5f6;
            font-size: 18px;
            text-shadow: 0 0 10px rgba(100, 180, 255, 0.4);
        }
        .control {
            margin-bottom: 16px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #a0c4ff;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #64b5f6;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(100,180,255,0.6);
        }
        .value {
            float: right;
            font-weight: bold;
            color: #64b5f6;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102,126,234,0.4);
        }
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        .stat {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-label {
            font-size: 11px;
            color: #8ab4f8;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }
        .histogram {
            width: 100%;
            height: 120px;
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        .overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="canvas-container"></div>
        <div class="sidebar">
            <div class="panel">
                <h2>Gas Simulation</h2>
                <div class="control">
                    <label>Particles: <span class="value" id="nVal">200</span></label>
                    <input type="range" id="nParticles" min="50" max="500" value="200">
                </div>
                <div class="control">
                    <label>Temperature: <span class="value" id="tempVal">300</span> K</label>
                    <input type="range" id="temperature" min="50" max="1000" step="10" value="300">
                </div>
                <div class="control">
                    <label>Particle Radius: <span class="value" id="radiusVal">4</span></label>
                    <input type="range" id="radius" min="2" max="8" step="0.5" value="4">
                </div>
                <div class="control">
                    <label>Mass Ratio (Heavy/Light): <span class="value" id="massRatioVal">4.0</span></label>
                    <input type="range" id="massRatio" min="1" max="10" step="0.5" value="4">
                </div>
                <div class="control">
                    <label>Heavy Particle Fraction: <span class="value" id="heavyFracVal">0.2</span></label>
                    <input type="range" id="heavyFraction" min="0" max="1" step="0.05" value="0.2">
                </div>
                <button onclick="simulation.reset()">Reset Particles</button>
                <button onclick="simulation.togglePause()">Pause / Resume</button>
                <button onclick="simulation.toggleCollisions()">Collisions: <span id="collState">ON</span></button>
            </div>

            <div class="panel">
                <h2>Real-Time Statistics</h2>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Temperature</div>
                        <div class="stat-value" id="currentTemp">--</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Pressure</div>
                        <div class="stat-value" id="pressure">--</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">RMS Speed</div>
                        <div class="stat-value" id="rmsSpeed">--</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Collisions/s</div>
                        <div class="stat-value" id="collRate">--</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>Speed Distribution</h2>
                <div class="histogram" id="histogram"></div>
                <div style="margin-top:8px; font-size:12px; color:#8ab4f8;">
                    Blue = Light particles Red = Heavy particles White = Maxwell-Boltzmann fit
                </div>
            </div>
        </div>
    </div>

    <div class="overlay">
        <div>2D Ideal Gas • Elastic Collisions • Maxwell-Boltzmann Distribution</div>
        <div style="margin-top:5px; font-size:12px;">Press R to reset • Space to pause</div>
    </div>

    <script>
        class Particle {
            constructor(x, y, vx, vy, mass, radius, isHeavy = false) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.mass = mass;
                this.radius = radius;
                this.isHeavy = isHeavy;
                this.speed = Math.sqrt(vx*vx + vy*vy);
            }
        }

        class GasSimulation {
            constructor() {
                this.width = 800;
                this.height = 600;
                this.particles = [];
                this.collisionCount = 0;
                this.lastCollisionTime = 0;
                this.paused = false;
                this.collisionsEnabled = true;

                // Parameters
                this.nParticles = 200;
                this.temperature = 300;
                this.radius = 4;
                this.massRatio = 4;
                this.heavyFraction = 0.2;

                this.initParticles();
                this.setupControls();
            }

            initParticles() {
                this.particles = [];
                const lightMass = 1;
                const heavyMass = this.massRatio;
                const nHeavy = Math.floor(this.nParticles * this.heavyFraction);
                const nLight = this.nParticles - nHeavy;

                // Speed from Maxwell-Boltzmann (2D): v_rms = sqrt(2kT/m)
                const k = 1; // Boltzmann constant (normalized)
                const vrms = Math.sqrt(2 * k * this.temperature);

                for (let i = 0; i < this.nParticles; i++) {
                    const isHeavy = i < nHeavy;
                    const mass = isHeavy ? heavyMass : lightMass;
                    const speed = vrms * Math.sqrt(mass === lightMass ? 1 : lightMass/heavyMass) * random(0.8, 1.2);
                    const angle = random(TWO_PI);
                    
                    let x, y;
                    do {
                        x = random(this.radius * 2, this.width - this.radius * 2);
                        y = random(this.radius * 2, this.height - this.radius * 2);
                    } while (this.checkOverlap(x, y, this.radius * 2));

                    this.particles.push(new Particle(
                        x, y,
                        speed * cos(angle),
                        speed * sin(angle),
                        mass,
                        this.radius,
                        isHeavy
                    ));
                }
            }

            checkOverlap(x, y, minDist) {
                for (const p of this.particles) {
                    const d = dist(x, y, p.x, p.y);
                    if (d < minDist) return true;
                }
                return false;
            }

            elasticCollision(p1, p2) {
                // Vector from p1 to p2
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const d = Math.sqrt(dx*dx + dy*dy);
                
                if (d === 0 || d > p1.radius + p2.radius) return;

                // Normal and tangent vectors
                const nx = dx / d;
                const ny = dy / d;
                const tx = -ny;
                const ty = nx;

                // Relative velocity
                const dvx = p2.vx - p1.vx;
                const dvy = p2.vy - p1.vy;

                // Normal component of relative velocity
                const dvn = dvx * nx + dvy * ny;

                // Do not resolve if velocities are separating
                if (dvn > 0) return;

                // Collision response (conserving momentum and energy)
                const m1 = p1.mass;
                const m2 = p2.mass;
                const impulse = 2 * m1 * m2 / (m1 + m2) * dvn;

                // Update velocities
                p1.vx += impulse * nx / m1;
                p1.vy += impulse * ny / m1;
                p2.vx -= impulse * nx / m2;
                p2.vy -= impulse * ny / m2;

                // Separate particles to prevent sticking
                const overlap = p1.radius + p2.radius - d;
                const sepX = overlap * nx * 0.5;
                const sepY = overlap * ny * 0.5;
                p1.x -= sepX;
                p1.y -= sepY;
                p2.x += sepX;
                p2.y += sepY;

                this.collisionCount++;
            }

            update() {
                if (this.paused) return;

                const dt = deltaTime / 1000;
                const currentTime = millis();

                // Update collision rate
                if (currentTime - this.lastCollisionTime > 1000) {
                    document.getElementById('collRate').textContent = this.collisionCount;
                    this.collisionCount = 0;
                    this.lastCollisionTime = currentTime;
                }

                // Move particles
                for (const p of this.particles) {
                    p.x += p.vx * dt * 60;
                    p.y += p.vy * dt * 60;

                    // Wall collisions (perfectly elastic)
                    if (p.x - p.radius < 0 || p.x + p.radius > this.width) {
                        p.vx *= -1;
                        p.x = constrain(p.x, p.radius, this.width - p.radius);
                    }
                    if (p.y - p.radius < 0 || p.y + p.radius > this.height) {
                        p.vy *= -1;
                        p.y = constrain(p.y, p.radius, this.height - p.radius);
                    }

                    p.speed = Math.sqrt(p.vx*p.vx + p.vy*p.vy);
                }

                // Particle-particle collisions
                if (this.collisionsEnabled) {
                    for (let i = 0; i < this.particles.length; i++) {
                        for (let j = i + 1; j < this.particles.length; j++) {
                            this.elasticCollision(this.particles[i], this.particles[j]);
                        }
                    }
                }

                this.updateStats();
                this.updateHistogram();
            }

            updateStats() {
                let totalKE = 0;
                let pressureForce = 0;
                
                for (const p of this.particles) {
                    totalKE += 0.5 * p.mass * (p.vx*p.vx + p.vy*p.vy);
                    
                    // Pressure from wall hits (approximate)
                    if (abs(p.vx) > 0 && (p.x - p.radius < 10 || p.x + p.radius > this.width - 10)) {
                        pressureForce += abs(p.vx) * p.mass;
                    }
                }

                // Temperature from kinetic theory: <KE> = kT (in 2D)
                const avgKE = totalKE / this.particles.length;
                const currentTemp = avgKE * 2; // since <1/2 mv²> = kT in 2D

                // Pressure = (N/V) * <mv²> for ideal gas (2D)
                const area = this.width * this.height;
                const pressure = (this.particles.length * avgKE * 2) / area;

                const rmsSpeed = Math.sqrt(2 * avgKE);

                document.getElementById('currentTemp').textContent = currentTemp.toFixed(1) + ' K';
                document.getElementById('pressure').textContent = pressure.toFixed(4);
                document.getElementById('rmsSpeed').textContent = rmsSpeed.toFixed(1);
            }

            updateHistogram() {
                const canvas = document.getElementById('histogram');
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;

                const bins = 30;
                const maxSpeed = 800;
                const lightSpeeds = [];
                const heavySpeeds = [];

                this.particles.forEach(p => {
                    if (p.isHeavy) heavySpeeds.push(p.speed);
                    else lightSpeeds.push(p.speed);
                });

                const lightHist = new Array(bins).fill(0);
                const heavyHist = new Array(bins).fill(0);

                lightSpeeds.forEach(s => {
                    const bin = Math.min(Math.floor(s / maxSpeed * bins), bins - 1);
                    lightHist[bin]++;
                });
                heavySpeeds.forEach(s => {
                    const bin = Math.min(Math.floor(s / maxSpeed * bins), bins - 1);
                    heavyHist[bin]++;
                });

                const maxCount = Math.max(...lightHist, ...heavyHist, 1);

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw light particles (blue)
                ctx.fillStyle = '#60a5fa';
                lightHist.forEach((count, i) => {
                    const x = (i / bins) * canvas.width;
                    const h = (count / maxCount) * canvas.height * 0.9;
                    ctx.fillRect(x, canvas.height - h, canvas.width / bins, h);
                });

                // Draw heavy particles (red)
                ctx.fillStyle = '#f87171';
                heavyHist.forEach((count, i) => {
                    const x = (i / bins) * canvas.width;
                    const h = (count / maxCount) * canvas.height * 0.9;
                    ctx.fillRect(x, canvas.height - h - 2, canvas.width / bins, h);
                });

                // Draw theoretical Maxwell-Boltzmann (white line)
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i <= bins; i++) {
                    const v = (i / bins) * maxSpeed;
                    const f = v * Math.exp(-v*v / (2 * avgKE)); // 2D MB distribution
                    const x = (i / bins) * canvas.width;
                    const y = canvas.height - (f / 0.001) * canvas.height * 0.3;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            render() {
                background(13, 13, 26);
                
                // Draw container
                noFill();
                stroke(100, 180, 255);
                strokeWeight(3);
                rect(0, 0, this.width, this.height);

                // Draw particles
                for (const p of this.particles) {
                    const speedNorm = p.speed / 600;
                    const alpha = map(speedNorm, 0, 1, 150, 255);
                    
                    if (p.isHeavy) {
                        fill(248, 113, 113, alpha);
                        stroke(255, 180, 180);
                    } else {
                        fill(96, 165, 250, alpha);
                        stroke(180, 220, 255);
                    }
                    strokeWeight(2);
                    circle(p.x, p.y, p.radius * 2);

                    // Velocity vector
                    if (!this.paused) {
                        stroke(255, 255, 255, 100);
                        strokeWeight(1);
                        line(p.x, p.y, p.x + p.vx * 0.3, p.y + p.vy * 0.3);
                    }
                }
            }

            setupControls() {
                document.getElementById('nParticles').addEventListener('input', (e) => {
                    this.nParticles = parseInt(e.target.value);
                    document.getElementById('nVal').textContent = this.nParticles;
                    this.initParticles();
                });

                document.getElementById('temperature').addEventListener('input', (e) => {
                    this.temperature = parseInt(e.target.value);
                    document.getElementById('tempVal').textContent = this.temperature;
                    this.initParticles();
                });

                document.getElementById('radius').addEventListener('input', (e) => {
                    this.radius = parseFloat(e.target.value);
                    document.getElementById('radiusVal').textContent = this.radius;
                    this.initParticles();
                });

                document.getElementById('massRatio').addEventListener('input', (e) => {
                    this.massRatio = parseFloat(e.target.value);
                    document.getElementById('massRatioVal').textContent = this.massRatio;
                    this.initParticles();
                });

                document.getElementById('heavyFraction').addEventListener('input', (e) => {
                    this.heavyFraction = parseFloat(e.target.value);
                    document.getElementById('heavyFracVal').textContent = this.heavyFraction;
                    this.initParticles();
                });
            }

            togglePause() {
                this.paused = !this.paused;
            }

            toggleCollisions() {
                this.collisionsEnabled = !this.collisionsEnabled;
                document.getElementById('collState').textContent = this.collisionsEnabled ? 'ON' : 'OFF';
            }

            reset() {
                this.initParticles();
                this.collisionCount = 0;
            }
        }

        let simulation;

        function setup() {
            createCanvas(800, 600).parent('canvas-container');
            simulation = new GasSimulation();
        }

        function draw() {
            simulation.update();
            simulation.render();
        }

        function keyPressed() {
            if (key === ' ') simulation.togglePause();
            if (key === 'r' || key === 'R') simulation.reset();
        }
    </script>
</body>
</html>