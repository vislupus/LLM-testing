<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia Climate Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1a6dbb 0%, #2c5282 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .data-range {
            font-size: 0.95rem;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .controls-panel {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #2c5282;
            font-size: 0.9rem;
        }

        select, input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #f9f9f9;
            transition: border 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #2c5282;
            box-shadow: 0 0 0 2px rgba(44, 82, 130, 0.2);
        }

        .btn {
            padding: 10px 20px;
            background-color: #2c5282;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background-color: #1a6dbb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c5282;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-trend {
            font-size: 0.85rem;
            padding: 3px 10px;
            border-radius: 20px;
            margin-top: 5px;
        }

        .trend-up {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .trend-down {
            background-color: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 1.3rem;
            color: #2c5282;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2c5282;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background-color: #fee;
            color: #c00;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #c00;
            margin: 20px 0;
        }

        @media (max-width: 1200px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .controls-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-temperature-high"></i> Sofia Climate Dashboard</h1>
            <p class="subtitle">Historical temperature analysis for Sofia, Bulgaria (1952-2021)</p>
            <div class="data-range">
                <i class="fas fa-calendar-alt"></i>
                <span id="file-data-range">Loading data range...</span>
            </div>
        </header>

        <div class="controls-panel">
            <div class="control-group">
                <label for="start-year"><i class="fas fa-calendar-start"></i> Start Year</label>
                <select id="start-year">
                    <option value="1952">1952</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="end-year"><i class="fas fa-calendar-end"></i> End Year</label>
                <select id="end-year">
                    <option value="2021">2021</option>
                </select>
            </div>
            
            <div class="control-group" style="flex-grow: 1;">
                <label for="chart-type"><i class="fas fa-chart-line"></i> Chart Detail Level</label>
                <select id="chart-type">
                    <option value="annual">Annual Trends</option>
                    <option value="monthly">Monthly Details</option>
                </select>
            </div>
            
            <button id="update-btn" class="btn">
                <i class="fas fa-sync-alt"></i> Update Charts
            </button>
        </div>

        <div class="stats-grid" id="stats-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading climate data...</p>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h3 class="chart-title"><i class="fas fa-chart-line"></i> Annual Temperature Trends</h3>
                <div class="chart-wrapper">
                    <canvas id="annualChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title"><i class="fas fa-snowflake"></i> <i class="fas fa-sun"></i> Extreme Temperature Days</h3>
                <div class="chart-wrapper">
                    <canvas id="extremesChart"></canvas>
                </div>
            </div>
            
            <div class="two-column">
                <div class="chart-card">
                    <h3 class="chart-title"><i class="fas fa-calendar-alt"></i> Monthly Temperature Averages</h3>
                    <div class="chart-wrapper">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 class="chart-title"><i class="fas fa-thermometer-half"></i> Temperature Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>Sofia Climate Dashboard &copy; 2023 | Data source: temperature_Sofia_2809794_1952-01-01 - 2021-11-28.csv</p>
            <p>Temperature data converted from tenths of degrees to °C | Charts powered by Chart.js</p>
        </footer>
    </div>

    <script>
        // Global variables
        let climateData = [];
        let filteredData = [];
        let annualStats = [];
        let monthlyStats = [];
        let startYear = 1952;
        let endYear = 2021;
        
        // Chart instances
        let annualChart, extremesChart, monthlyChart, distributionChart;
        
        // DOM elements
        const startYearSelect = document.getElementById('start-year');
        const endYearSelect = document.getElementById('end-year');
        const updateBtn = document.getElementById('update-btn');
        const chartTypeSelect = document.getElementById('chart-type');
        const statsContainer = document.getElementById('stats-container');
        const fileDataRange = document.getElementById('file-data-range');
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadClimateData();
            setupEventListeners();
        });
        
        // Set up event listeners
        function setupEventListeners() {
            updateBtn.addEventListener('click', updateDashboard);
            
            // Update dashboard when year range changes
            startYearSelect.addEventListener('change', updateDashboard);
            endYearSelect.addEventListener('change', updateDashboard);
            
            // Update dashboard when chart type changes
            chartTypeSelect.addEventListener('change', updateDashboard);
        }
        
        // Load and parse the CSV file
        async function loadClimateData() {
            try {
                // Try to fetch the CSV file
                const response = await fetch('temperature_Sofia_2809794_1952-01-01 - 2021-11-28.csv');
                
                if (!response.ok) {
                    throw new Error(`Failed to load CSV file: ${response.status} ${response.statusText}`);
                }
                
                const csvText = await response.text();
                parseCSVData(csvText);
                
            } catch (error) {
                console.error('Error loading climate data:', error);
                
                // Show error message
                statsContainer.innerHTML = `
                    <div class="error">
                        <h3><i class="fas fa-exclamation-triangle"></i> Error Loading Data</h3>
                        <p>Could not load the CSV file: ${error.message}</p>
                        <p>Make sure the file "temperature_Sofia_2809794_1952-01-01 - 2021-11-28.csv" is in the same folder as this HTML file.</p>
                        <p>For demonstration, using sample data instead.</p>
                    </div>
                `;
                
                // Load sample data for demonstration
                loadSampleData();
            }
        }
        
        // Parse CSV data
        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            
            // Find column indices
            const dateIndex = headers.indexOf('DATE');
            const tavgIndex = headers.indexOf('TAVG');
            const tmaxIndex = headers.indexOf('TMAX');
            const tminIndex = headers.indexOf('TMIN');
            
            // Validate that we found the required columns
            if (dateIndex === -1 || tavgIndex === -1 || tmaxIndex === -1 || tminIndex === -1) {
                throw new Error('CSV file does not contain required columns: DATE, TAVG, TMAX, TMIN');
            }
            
            // Parse each line
            climateData = [];
            let minDate = null;
            let maxDate = null;
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',');
                
                // Extract date
                const dateStr = values[dateIndex];
                if (!dateStr) continue;
                
                const date = new Date(dateStr);
                const year = date.getFullYear();
                const month = date.getMonth() + 1; // JavaScript months are 0-indexed
                
                // Extract temperature values (convert from tenths of degrees to °C)
                const tavg = parseFloat(values[tavgIndex]) / 10;
                const tmax = parseFloat(values[tmaxIndex]) / 10;
                const tmin = parseFloat(values[tminIndex]) / 10;
                
                // Only add valid data points
                if (!isNaN(tavg) && !isNaN(tmax) && !isNaN(tmin)) {
                    const dataPoint = {
                        date: date,
                        year: year,
                        month: month,
                        day: date.getDate(),
                        tavg: tavg,
                        tmax: tmax,
                        tmin: tmin
                    };
                    
                    climateData.push(dataPoint);
                    
                    // Track date range
                    if (!minDate || date < minDate) minDate = date;
                    if (!maxDate || date > maxDate) maxDate = date;
                }
            }
            
            // Update UI with data range
            if (minDate && maxDate) {
                const minYear = minDate.getFullYear();
                const minMonth = minDate.toLocaleString('default', { month: 'short' });
                const maxYear = maxDate.getFullYear();
                const maxMonth = maxDate.toLocaleString('default', { month: 'short' });
                
                fileDataRange.textContent = `Data range: ${minMonth} ${minYear} to ${maxMonth} ${maxYear} (${climateData.length.toLocaleString()} daily records)`;
            }
            
            // Populate year selectors
            populateYearSelectors();
            
            // Process data and update dashboard
            processData();
            updateDashboard();
        }
        
        // Populate year selectors with available years
        function populateYearSelectors() {
            if (climateData.length === 0) return;
            
            // Get unique years from data
            const years = [...new Set(climateData.map(d => d.year))].sort((a, b) => a - b);
            
            // Clear existing options
            startYearSelect.innerHTML = '';
            endYearSelect.innerHTML = '';
            
            // Add options for each year
            years.forEach(year => {
                const startOption = document.createElement('option');
                startOption.value = year;
                startOption.textContent = year;
                startYearSelect.appendChild(startOption);
                
                const endOption = document.createElement('option');
                endOption.value = year;
                endOption.textContent = year;
                endYearSelect.appendChild(endOption);
            });
            
            // Set default values
            startYearSelect.value = years[0];
            endYearSelect.value = years[years.length - 1];
            
            startYear = parseInt(startYearSelect.value);
            endYear = parseInt(endYearSelect.value);
        }
        
        // Process climate data to compute statistics
        function processData() {
            if (climateData.length === 0) return;
            
            // Filter data based on selected year range
            filteredData = climateData.filter(d => d.year >= startYear && d.year <= endYear);
            
            // Compute annual statistics
            computeAnnualStats();
            
            // Compute monthly statistics
            computeMonthlyStats();
        }
        
        // Compute annual statistics
        function computeAnnualStats() {
            annualStats = [];
            
            // Group data by year
            const years = [...new Set(filteredData.map(d => d.year))].sort((a, b) => a - b);
            
            years.forEach(year => {
                const yearData = filteredData.filter(d => d.year === year);
                
                if (yearData.length === 0) return;
                
                // Calculate annual averages
                const avgTavg = yearData.reduce((sum, d) => sum + d.tavg, 0) / yearData.length;
                const avgTmax = yearData.reduce((sum, d) => sum + d.tmax, 0) / yearData.length;
                const avgTmin = yearData.reduce((sum, d) => sum + d.tmin, 0) / yearData.length;
                
                // Find extremes for the year
                const maxTmax = Math.max(...yearData.map(d => d.tmax));
                const minTmin = Math.min(...yearData.map(d => d.tmin));
                
                // Count hot and cold days
                const hotDays = yearData.filter(d => d.tmax >= 30).length;
                const coldDays = yearData.filter(d => d.tmin <= -10).length;
                const freezingDays = yearData.filter(d => d.tmin <= 0).length;
                
                annualStats.push({
                    year: year,
                    avgTavg: avgTavg,
                    avgTmax: avgTmax,
                    avgTmin: avgTmin,
                    maxTmax: maxTmax,
                    minTmin: minTmin,
                    hotDays: hotDays,
                    coldDays: coldDays,
                    freezingDays: freezingDays,
                    recordCount: yearData.length
                });
            });
        }
        
        // Compute monthly statistics
        function computeMonthlyStats() {
            monthlyStats = [];
            
            // Group by month across all years in range
            for (let month = 1; month <= 12; month++) {
                const monthData = filteredData.filter(d => d.month === month);
                
                if (monthData.length === 0) continue;
                
                // Calculate monthly averages
                const avgTavg = monthData.reduce((sum, d) => sum + d.tavg, 0) / monthData.length;
                const avgTmax = monthData.reduce((sum, d) => sum + d.tmax, 0) / monthData.length;
                const avgTmin = monthData.reduce((sum, d) => sum + d.tmin, 0) / monthData.length;
                
                // Find extremes for the month
                const maxTmax = Math.max(...monthData.map(d => d.tmax));
                const minTmin = Math.min(...monthData.map(d => d.tmin));
                
                monthlyStats.push({
                    month: month,
                    monthName: new Date(2000, month - 1, 1).toLocaleString('default', { month: 'long' }),
                    avgTavg: avgTavg,
                    avgTmax: avgTmax,
                    avgTmin: avgTmin,
                    maxTmax: maxTmax,
                    minTmin: minTmin
                });
            }
        }
        
        // Update the entire dashboard
        function updateDashboard() {
            // Update year range from selectors
            startYear = parseInt(startYearSelect.value);
            endYear = parseInt(endYearSelect.value);
            
            // Ensure start year is not greater than end year
            if (startYear > endYear) {
                // Swap values
                [startYear, endYear] = [endYear, startYear];
                startYearSelect.value = startYear;
                endYearSelect.value = endYear;
            }
            
            // Process data with new filters
            processData();
            
            // Update statistics
            updateStatistics();
            
            // Update charts
            updateCharts();
        }
        
        // Update statistics display
        function updateStatistics() {
            if (annualStats.length === 0) return;
            
            // Calculate overall statistics
            const allTemps = filteredData.map(d => d.tavg);
            const overallAvg = allTemps.reduce((sum, temp) => sum + temp, 0) / allTemps.length;
            
            // Calculate warming trend (linear regression)
            const trend = calculateWarmingTrend();
            
            // Calculate extremes
            const maxTemp = Math.max(...filteredData.map(d => d.tmax));
            const minTemp = Math.min(...filteredData.map(d => d.tmin));
            
            // Count hot and cold days
            const totalHotDays = filteredData.filter(d => d.tmax >= 30).length;
            const totalColdDays = filteredData.filter(d => d.tmin <= -10).length;
            const totalFreezingDays = filteredData.filter(d => d.tmin <= 0).length;
            
            // Find hottest and coldest years in the range
            const hottestYear = annualStats.reduce((hottest, current) => 
                current.avgTavg > hottest.avgTavg ? current : hottest
            );
            
            const coldestYear = annualStats.reduce((coldest, current) => 
                current.avgTavg < coldest.avgTavg ? current : coldest
            );
            
            // Update statistics container
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Overall Average Temperature</div>
                    <div class="stat-value">${overallAvg.toFixed(1)}°C</div>
                    <div class="stat-label">${startYear} - ${endYear}</div>
                    <div class="stat-trend ${trend.slope > 0 ? 'trend-up' : 'trend-down'}">
                        ${trend.slope > 0 ? '↑' : '↓'} ${Math.abs(trend.slope).toFixed(2)}°C/decade
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Record High Temperature</div>
                    <div class="stat-value">${maxTemp.toFixed(1)}°C</div>
                    <div class="stat-label">Maximum in ${startYear}-${endYear}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Record Low Temperature</div>
                    <div class="stat-value">${minTemp.toFixed(1)}°C</div>
                    <div class="stat-label">Minimum in ${startYear}-${endYear}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Hot Days (≥30°C)</div>
                    <div class="stat-value">${totalHotDays}</div>
                    <div class="stat-label">Average per year: ${(totalHotDays / annualStats.length).toFixed(1)}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Cold Days (≤-10°C)</div>
                    <div class="stat-value">${totalColdDays}</div>
                    <div class="stat-label">Average per year: ${(totalColdDays / annualStats.length).toFixed(1)}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Freezing Days (≤0°C)</div>
                    <div class="stat-value">${totalFreezingDays}</div>
                    <div class="stat-label">Average per year: ${(totalFreezingDays / annualStats.length).toFixed(1)}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Hottest Year</div>
                    <div class="stat-value">${hottestYear.year}</div>
                    <div class="stat-label">${hottestYear.avgTavg.toFixed(1)}°C average</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Coldest Year</div>
                    <div class="stat-value">${coldestYear.year}</div>
                    <div class="stat-label">${coldestYear.avgTavg.toFixed(1)}°C average</div>
                </div>
            `;
        }
        
        // Calculate warming trend using linear regression
        function calculateWarmingTrend() {
            if (annualStats.length < 2) return { slope: 0, r2: 0 };
            
            const years = annualStats.map(s => s.year);
            const temps = annualStats.map(s => s.avgTavg);
            
            // Calculate linear regression
            const n = years.length;
            const sumX = years.reduce((a, b) => a + b, 0);
            const sumY = temps.reduce((a, b) => a + b, 0);
            const sumXY = years.reduce((sum, year, i) => sum + year * temps[i], 0);
            const sumX2 = years.reduce((sum, year) => sum + year * year, 0);
            const sumY2 = temps.reduce((sum, temp) => sum + temp * temp, 0);
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // Calculate R-squared
            const yMean = sumY / n;
            const ssTotal = temps.reduce((sum, temp) => sum + Math.pow(temp - yMean, 2), 0);
            const ssResidual = temps.reduce((sum, temp, i) => {
                const yPred = slope * years[i] + intercept;
                return sum + Math.pow(temp - yPred, 2);
            }, 0);
            
            const r2 = ssResidual > 0 ? 1 - (ssResidual / ssTotal) : 1;
            
            // Convert slope to °C per decade
            const slopePerDecade = slope * 10;
            
            return {
                slope: slopePerDecade,
                intercept: intercept,
                r2: r2
            };
        }
        
        // Update all charts
        function updateCharts() {
            updateAnnualChart();
            updateExtremesChart();
            updateMonthlyChart();
            updateDistributionChart();
        }
        
        // Update annual temperature chart
        function updateAnnualChart() {
            const ctx = document.getElementById('annualChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (annualChart) {
                annualChart.destroy();
            }
            
            // Prepare data
            const years = annualStats.map(s => s.year);
            const avgTemps = annualStats.map(s => s.avgTavg);
            const maxTemps = annualStats.map(s => s.avgTmax);
            const minTemps = annualStats.map(s => s.avgTmin);
            
            // Calculate trend line
            const trend = calculateWarmingTrend();
            const trendLine = years.map(year => trend.slope/10 * (year - years[0]) + trend.intercept);
            
            // Determine if we're showing annual or monthly data
            const chartType = chartTypeSelect.value;
            
            if (chartType === 'monthly') {
                // For monthly view, show data for the most recent year
                const recentYear = Math.max(...annualStats.map(s => s.year));
                const recentYearData = climateData.filter(d => d.year === recentYear);
                
                // Group by month
                const monthlyData = [];
                for (let month = 1; month <= 12; month++) {
                    const monthData = recentYearData.filter(d => d.month === month);
                    if (monthData.length > 0) {
                        const avg = monthData.reduce((sum, d) => sum + d.tavg, 0) / monthData.length;
                        monthlyData.push(avg);
                    }
                }
                
                // Create monthly chart
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].slice(0, monthlyData.length);
                
                annualChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: monthNames,
                        datasets: [{
                            label: `${recentYear} Monthly Temperatures`,
                            data: monthlyData,
                            borderColor: '#2c5282',
                            backgroundColor: 'rgba(44, 82, 130, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Monthly Temperature Averages for ${recentYear}`
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}°C`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
                
            } else {
                // Create annual chart
                annualChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: 'Average Temperature',
                                data: avgTemps,
                                borderColor: '#2c5282',
                                backgroundColor: 'rgba(44, 82, 130, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.2
                            },
                            {
                                label: 'Maximum Temperature',
                                data: maxTemps,
                                borderColor: '#dc2626',
                                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.2
                            },
                            {
                                label: 'Minimum Temperature',
                                data: minTemps,
                                borderColor: '#1a6dbb',
                                backgroundColor: 'rgba(26, 109, 187, 0.1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.2
                            },
                            {
                                label: 'Warming Trend',
                                data: trendLine,
                                borderColor: '#dc2626',
                                borderWidth: 2,
                                borderDash: [3, 3],
                                pointRadius: 0,
                                fill: false,
                                tension: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Annual Temperature Trends (${startYear}-${endYear}) - Warming: ${trend.slope.toFixed(2)}°C/decade`
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}°C`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Year'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Update extremes chart (hot/cold days)
        function updateExtremesChart() {
            const ctx = document.getElementById('extremesChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (extremesChart) {
                extremesChart.destroy();
            }
            
            // Prepare data
            const years = annualStats.map(s => s.year);
            const hotDays = annualStats.map(s => s.hotDays);
            const coldDays = annualStats.map(s => s.coldDays);
            const freezingDays = annualStats.map(s => s.freezingDays);
            
            extremesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Hot Days (≥30°C)',
                            data: hotDays,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: '#dc2626',
                            borderWidth: 1
                        },
                        {
                            label: 'Cold Days (≤-10°C)',
                            data: coldDays,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: '#1d4ed8',
                            borderWidth: 1
                        },
                        {
                            label: 'Freezing Days (≤0°C)',
                            data: freezingDays,
                            backgroundColor: 'rgba(96, 165, 250, 0.5)',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            hidden: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Extreme Temperature Days per Year (${startYear}-${endYear})`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} days`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Days'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                maxTicksLimit: 15
                            }
                        }
                    }
                }
            });
        }
        
        // Update monthly averages chart
        function updateMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            // Prepare data
            const monthNames = monthlyStats.map(s => s.monthName);
            const avgTemps = monthlyStats.map(s => s.avgTavg);
            const maxTemps = monthlyStats.map(s => s.avgTmax);
            const minTemps = monthlyStats.map(s => s.avgTmin);
            
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [
                        {
                            label: 'Average Temperature',
                            data: avgTemps,
                            borderColor: '#2c5282',
                            backgroundColor: 'rgba(44, 82, 130, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Average Maximum',
                            data: maxTemps,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: 'Average Minimum',
                            data: minTemps,
                            borderColor: '#1a6dbb',
                            backgroundColor: 'rgba(26, 109, 187, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Monthly Temperature Averages (${startYear}-${endYear})`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}°C`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Temperature (°C)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        // Update temperature distribution chart
        function updateDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (distributionChart) {
                distributionChart.destroy();
            }
            
            // Prepare data - create temperature bins
            const tempBins = {};
            const binSize = 2; // 2°C bins
            
            // Initialize bins
            const minTemp = Math.floor(Math.min(...filteredData.map(d => d.tavg)) / binSize) * binSize;
            const maxTemp = Math.ceil(Math.max(...filteredData.map(d => d.tavg)) / binSize) * binSize;
            
            for (let temp = minTemp; temp <= maxTemp; temp += binSize) {
                const binLabel = `${temp}°C to ${temp + binSize}°C`;
                tempBins[binLabel] = 0;
            }
            
            // Count temperatures in each bin
            filteredData.forEach(d => {
                const binIndex = Math.floor(d.tavg / binSize) * binSize;
                const binLabel = `${binIndex}°C to ${binIndex + binSize}°C`;
                if (tempBins[binLabel] !== undefined) {
                    tempBins[binLabel]++;
                }
            });
            
            // Convert to chart data
            const binLabels = Object.keys(tempBins);
            const binCounts = Object.values(tempBins);
            
            // Calculate average temperature for color coding
            const avgTemp = filteredData.reduce((sum, d) => sum + d.tavg, 0) / filteredData.length;
            
            // Create gradient colors based on temperature
            const backgroundColors = binLabels.map(label => {
                const binTemp = parseFloat(label.split('°C')[0]);
                const normalizedTemp = (binTemp + 10) / 40; // Normalize between -10°C and 30°C
                
                // Create color gradient from blue (cold) to red (hot)
                const r = Math.min(255, Math.floor(255 * normalizedTemp));
                const b = Math.min(255, Math.floor(255 * (1 - normalizedTemp)));
                
                return `rgba(${r}, 100, ${b}, 0.7)`;
            });
            
            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'Number of Days',
                        data: binCounts,
                        backgroundColor: backgroundColors,
                        borderColor: 'rgba(44, 82, 130, 0.8)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Temperature Distribution (${startYear}-${endYear}) - Average: ${avgTemp.toFixed(1)}°C`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = (context.parsed.y / filteredData.length * 100).toFixed(1);
                                    return `${context.parsed.y} days (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Days'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Temperature Range (°C)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        // Load sample data for demonstration (if CSV file is not found)
        function loadSampleData() {
            console.log("Loading sample data for demonstration...");
            
            // Generate sample data from 1952 to 2021
            climateData = [];
            
            // Base temperatures with a warming trend
            const baseTemps = {
                1: -1.5,  // January
                2: 0.5,   // February
                3: 5.0,   // March
                4: 10.0,  // April
                5: 15.0,  // May
                6: 18.5,  // June
                7: 21.0,  // July
                8: 20.5,  // August
                9: 16.0,  // September
                10: 10.5, // October
                11: 5.0,  // November
                12: 0.0   // December
            };
            
            // Generate data for each year
            for (let year = 1952; year <= 2021; year++) {
                // Warming trend: about 0.2°C per decade
                const warming = (year - 1952) * 0.02;
                
                for (let month = 1; month <= 12; month++) {
                    // Base temperature for the month with warming trend
                    const baseTemp = baseTemps[month] + warming;
                    
                    // Generate data for each day (simplified - just a few days per month)
                    const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month-1];
                    
                    for (let day = 1; day <= 5; day++) { // Just 5 days per month for sample
                        const date = new Date(year, month-1, day);
                        
                        // Add some randomness to temperatures
                        const tavg = baseTemp + (Math.random() * 6 - 3);
                        const tmax = tavg + (Math.random() * 5 + 2);
                        const tmin = tavg - (Math.random() * 5 + 2);
                        
                        climateData.push({
                            date: date,
                            year: year,
                            month: month,
                            day: day,
                            tavg: tavg,
                            tmax: tmax,
                            tmin: tmin
                        });
                    }
                }
            }
            
            // Update UI with data range
            fileDataRange.textContent = `Data range: 1952 to 2021 (${climateData.length.toLocaleString()} sample daily records)`;
            fileDataRange.innerHTML += ' <span style="color:#f59e0b;"><i class="fas fa-exclamation-triangle"></i> Using sample data</span>';
            
            // Populate year selectors
            populateYearSelectors();
            
            // Process data and update dashboard
            processData();
            updateDashboard();
        }
    </script>
</body>
</html>