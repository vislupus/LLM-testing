<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia Climate Dashboard (1952-2021)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            color: #888;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 500;
            color: #aaa;
        }

        select, input[type="range"] {
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:hover, select:focus {
            border-color: #00d9ff;
            outline: none;
        }

        input[type="range"] {
            width: 200px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .range-display {
            min-width: 180px;
            text-align: center;
            padding: 10px 15px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 8px;
            color: #00d9ff;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.2);
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #888;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card.warming .value {
            color: #ff6b6b;
        }

        .stat-card.cold .value {
            color: #4ecdc4;
        }

        .stat-card.hot .value {
            color: #ff9f43;
        }

        .stat-card.mean .value {
            color: #00d9ff;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #00d9ff;
            font-size: 1.2em;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .data-table h3 {
            margin-bottom: 20px;
            color: #00d9ff;
            font-size: 1.2em;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        td {
            color: #ccc;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .trend-indicator.up {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .trend-indicator.down {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #888;
        }

        .loading::after {
            content: '';
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 217, 255, 0.3);
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #ff6b6b;
        }

        .file-upload {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload label {
            padding: 15px 30px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .file-upload label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 217, 255, 0.4);
        }

        .file-upload span {
            color: #888;
        }

        .hidden {
            display: none !important;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sofia Climate Dashboard</h1>
            <p>Temperature Analysis: 1952 - 2021 | Station: 2809794</p>
        </header>

        <div class="file-upload" id="uploadSection">
            <span>Upload temperature data CSV file:</span>
            <label for="csvFileInput">Choose File</label>
            <input type="file" id="csvFileInput" accept=".csv">
            <span>or use sample data</span>
            <button id="loadSampleBtn" style="padding: 15px 30px; background: linear-gradient(135deg, #00d9ff, #00ff88); border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Load Sample Data</button>
        </div>

        <div class="loading" id="loadingIndicator">Loading data...</div>

        <div class="hidden" id="dashboardContent">
            <div class="controls">
                <div class="control-group">
                    <label for="startYear">Start Year:</label>
                    <select id="startYear"></select>
                </div>
                <div class="control-group">
                    <label for="endYear">End Year:</label>
                    <select id="endYear"></select>
                </div>
                <div class="range-display" id="yearRangeDisplay">1952 - 2021</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card mean">
                    <div class="value" id="overallMean">--</div>
                    <div class="label">Overall Mean Temp (°C)</div>
                </div>
                <div class="stat-card warming">
                    <div class="value" id="warmingTrend">--</div>
                    <div class="label">Warming Trend (°C/decade)</div>
                </div>
                <div class="stat-card hot">
                    <div class="value" id="hotDaysCount">--</div>
                    <div class="label">Very Hot Days (≥30°C)</div>
                </div>
                <div class="stat-card cold">
                    <div class="value" id="coldDaysCount">--</div>
                    <div class="label">Very Cold Days (≤-10°C)</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="absMaxTemp">--</div>
                    <div class="label">Absolute Max (°C)</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="absMinTemp">--</div>
                    <div class="label">Absolute Min (°C)</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Annual Mean Temperature</h3>
                    <div class="chart-wrapper">
                        <canvas id="annualMeanChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Annual Temperature Extremes</h3>
                    <div class="chart-wrapper">
                        <canvas id="annualExtremesChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Monthly Temperature Profile</h3>
                    <div class="chart-wrapper">
                        <canvas id="monthlyMeanChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Hot & Cold Days per Year</h3>
                    <div class="chart-wrapper">
                        <canvas id="extremeDaysChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Temperature Anomaly (vs. 1952-1981 baseline)</h3>
                    <div class="chart-wrapper">
                        <canvas id="anomalyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Seasonal Temperature Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="seasonalChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-table">
                <h3>Annual Statistics Summary</h3>
                <div class="table-wrapper">
                    <table id="annualStatsTable">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Mean Temp (°C)</th>
                                <th>Max Temp (°C)</th>
                                <th>Min Temp (°C)</th>
                                <th>Hot Days (≥30°C)</th>
                                <th>Cold Days (≤-10°C)</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer>
            Data Source: NOAA/NCDC Climate Data | Station: Sofia (2809794)
        </footer>
    </div>

    <script>
        class ClimateDashboard {
            constructor() {
                this.rawData = [];
                this.processedData = {};
                this.charts = {};
                this.baselinePeriod = [1952, 1981];

                this.initEventListeners();
            }

            initEventListeners() {
                document.getElementById('csvFileInput').addEventListener('change', (e) => this.handleFileUpload(e));
                document.getElementById('loadSampleBtn').addEventListener('click', () => this.loadSampleData());
                document.getElementById('startYear').addEventListener('change', () => this.updateDashboard());
                document.getElementById('endYear').addEventListener('change', () => this.updateDashboard());
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showLoading(true);

                try {
                    const text = await file.text();
                    this.parseCSV(text);
                    this.initializeDashboard();
                } catch (error) {
                    console.error('Error loading file:', error);
                    alert('Error loading CSV file. Please check the format.');
                    this.showLoading(false);
                }
            }

            async loadSampleData() {
                this.showLoading(true);

                try {
                    const response = await fetch('temperature_Sofia_2809794_1952-01-01 - 2021-11-28.csv');
                    if (!response.ok) throw new Error('Sample data not found');
                    const text = await response.text();
                    this.parseCSV(text);
                    this.initializeDashboard();
                } catch (error) {
                    console.log('Generating sample data...');
                    this.generateSampleData();
                    this.initializeDashboard();
                }
            }

            generateSampleData() {
                this.rawData = [];
                const startYear = 1952;
                const endYear = 2021;

                const monthlyMeans = {
                    1: -1.5, 2: 0.5, 3: 5.0, 4: 10.5, 5: 15.5, 6: 19.5,
                    7: 22.0, 8: 21.5, 9: 17.0, 10: 11.5, 11: 5.5, 12: 0.5
                };

                const warmingRate = 0.025;

                for (let year = startYear; year <= endYear; year++) {
                    for (let month = 1; month <= 12; month++) {
                        const daysInMonth = new Date(year, month, 0).getDate();

                        for (let day = 1; day <= daysInMonth; day++) {
                            if (year === endYear && month === 11 && day > 28) continue;
                            if (year === endYear && month > 11) continue;

                            const date = `${year}${String(month).padStart(2, '0')}${String(day).padStart(2, '0')}`;

                            const baseTemp = monthlyMeans[month];
                            const yearOffset = (year - startYear) * warmingRate;
                            const dayOfYear = this.getDayOfYear(year, month, day);
                            const dailyVariation = Math.sin(dayOfYear * 2 * Math.PI / 365) * 5;
                            const noise = (Math.random() - 0.5) * 8;

                            const tav = Math.round((baseTemp + yearOffset + dailyVariation * 0.5 + noise) * 10) / 10;
                            const tmax = Math.round((tav + 5 + Math.random() * 3) * 10) / 10;
                            const tmin = Math.round((tav - 5 - Math.random() * 3) * 10) / 10;

                            this.rawData.push({
                                DATE: date,
                                TAVG: Math.round(tav * 10),
                                TMAX: Math.round(tmax * 10),
                                TMIN: Math.round(tmin * 10)
                            });
                        }
                    }
                }

                this.rawData.sort((a, b) => a.DATE.localeCompare(b.DATE));
            }

            getDayOfYear(year, month, day) {
                const date = new Date(year, month - 1, day);
                const start = new Date(year, 0, 0);
                const diff = date - start;
                const oneDay = 1000 * 60 * 60 * 24;
                return Math.floor(diff / oneDay);
            }

            parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

                this.rawData = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);
                    if (values.length >= 4) {
                        const record = {};
                        headers.forEach((header, index) => {
                            record[header] = values[index];
                        });

                        if (record.DATE && (record.TAVG || record.TMAX || record.TMIN)) {
                            this.rawData.push(record);
                        }
                    }
                }

                this.rawData.sort((a, b) => a.DATE.localeCompare(b.DATE));
            }

            parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim().replace(/"/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim().replace(/"/g, ''));

                return values;
            }

            convertTemperature(value) {
                if (value === undefined || value === null || value === '') return null;
                return parseFloat(value) / 10;
            }

            initializeDashboard() {
                this.processData();
                this.populateYearSelectors();
                this.createCharts();
                this.updateDashboard();

                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
            }

            processData() {
                this.processedData = {
                    byYear: {},
                    byMonth: {},
                    daily: []
                };

                for (const record of this.rawData) {
                    const year = parseInt(record.DATE.substring(0, 4));
                    const month = parseInt(record.DATE.substring(4, 6));

                    const tav = this.convertTemperature(record.TAVG);
                    const tmax = this.convertTemperature(record.TMAX);
                    const tmin = this.convertTemperature(record.TMIN);

                    if (tav === null && tmax === null && tmin === null) continue;

                    this.processedData.daily.push({
                        date: record.DATE,
                        year,
                        month,
                        tav: tav !== null ? tav : (tmax + tmin) / 2,
                        tmax,
                        tmin
                    });

                    if (!this.processedData.byYear[year]) {
                        this.processedData.byYear[year] = {
                            temps: [],
                            maxTemps: [],
                            minTemps: [],
                            hotDays: 0,
                            coldDays: 0,
                            days: 0
                        };
                    }

                    if (tav !== null) this.processedData.byYear[year].temps.push(tav);
                    if (tmax !== null) {
                        this.processedData.byYear[year].maxTemps.push(tmax);
                        if (tmax >= 30) this.processedData.byYear[year].hotDays++;
                    }
                    if (tmin !== null) {
                        this.processedData.byYear[year].minTemps.push(tmin);
                        if (tmin <= -10) this.processedData.byYear[year].coldDays++;
                    }
                    this.processedData.byYear[year].days++;

                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                    if (!this.processedData.byMonth[monthKey]) {
                        this.processedData.byMonth[monthKey] = {
                            temps: [],
                            year,
                            month
                        };
                    }
                    if (tav !== null) this.processedData.byMonth[monthKey].temps.push(tav);
                }

                for (const year in this.processedData.byYear) {
                    const data = this.processedData.byYear[year];
                    data.meanTemp = data.temps.length > 0
                        ? data.temps.reduce((a, b) => a + b, 0) / data.temps.length
                        : null;
                    data.annualMax = data.maxTemps.length > 0 ? Math.max(...data.maxTemps) : null;
                    data.annualMin = data.minTemps.length > 0 ? Math.min(...data.minTemps) : null;
                }

                for (const monthKey in this.processedData.byMonth) {
                    const data = this.processedData.byMonth[monthKey];
                    data.meanTemp = data.temps.length > 0
                        ? data.temps.reduce((a, b) => a + b, 0) / data.temps.length
                        : null;
                }
            }

            populateYearSelectors() {
                const years = Object.keys(this.processedData.byYear).map(Number).sort((a, b) => a - b);
                const startSelect = document.getElementById('startYear');
                const endSelect = document.getElementById('endYear');

                startSelect.innerHTML = '';
                endSelect.innerHTML = '';

                years.forEach(year => {
                    startSelect.add(new Option(year, year));
                    endSelect.add(new Option(year, year));
                });

                startSelect.value = years[0];
                endSelect.value = years[years.length - 1];
            }

            updateDashboard() {
                const startYear = parseInt(document.getElementById('startYear').value);
                const endYear = parseInt(document.getElementById('endYear').value);

                if (startYear > endYear) {
                    document.getElementById('endYear').value = startYear;
                    return this.updateDashboard();
                }

                document.getElementById('yearRangeDisplay').textContent = `${startYear} - ${endYear}`;

                const filteredData = this.filterByYearRange(startYear, endYear);
                this.updateStatistics(filteredData);
                this.updateCharts(filteredData);
                this.updateTable(filteredData);
            }

            filterByYearRange(startYear, endYear) {
                const yearly = {};
                const monthly = {};
                const daily = [];

                for (const year in this.processedData.byYear) {
                    if (parseInt(year) >= startYear && parseInt(year) <= endYear) {
                        yearly[year] = this.processedData.byYear[year];
                    }
                }

                for (const monthKey in this.processedData.byMonth) {
                    const [year, month] = monthKey.split('-').map(Number);
                    if (year >= startYear && year <= endYear) {
                        monthly[monthKey] = this.processedData.byMonth[monthKey];
                    }
                }

                for (const record of this.processedData.daily) {
                    if (record.year >= startYear && record.year <= endYear) {
                        daily.push(record);
                    }
                }

                return { yearly, monthly, daily };
            }

            updateStatistics(data) {
                const allTemps = [];
                data.daily.forEach(d => {
                    if (d.tav !== null) allTemps.push(d.tav);
                });
                const overallMean = allTemps.length > 0
                    ? (allTemps.reduce((a, b) => a + b, 0) / allTemps.length).toFixed(2)
                    : '--';
                document.getElementById('overallMean').textContent = overallMean;

                const trend = this.calculateWarmingTrend(data.yearly);
                document.getElementById('warmingTrend').textContent = trend !== null ? `${trend >= 0 ? '+' : ''}${trend.toFixed(3)}` : '--';

                let hotDays = 0, coldDays = 0;
                let absMax = -Infinity, absMin = Infinity;

                for (const year in data.yearly) {
                    hotDays += data.yearly[year].hotDays;
                    coldDays += data.yearly[year].coldDays;
                    if (data.yearly[year].annualMax > absMax) absMax = data.yearly[year].annualMax;
                    if (data.yearly[year].annualMin < absMin) absMin = data.yearly[year].annualMin;
                }

                document.getElementById('hotDaysCount').textContent = hotDays;
                document.getElementById('coldDaysCount').textContent = coldDays;
                document.getElementById('absMaxTemp').textContent = absMax !== -Infinity ? absMax.toFixed(1) : '--';
                document.getElementById('absMinTemp').textContent = absMin !== Infinity ? absMin.toFixed(1) : '--';
            }

            calculateWarmingTrend(yearlyData) {
                const years = Object.keys(yearlyData).map(Number).sort((a, b) => a - b);
                if (years.length < 2) return null;

                const validData = years
                    .map(year => ({ year, mean: yearlyData[year].meanTemp }))
                    .filter(d => d.mean !== null);

                if (validData.length < 2) return null;

                const n = validData.length;
                const sumX = validData.reduce((acc, d) => acc + d.year, 0);
                const sumY = validData.reduce((acc, d) => acc + d.mean, 0);
                const sumXY = validData.reduce((acc, d) => acc + d.year * d.mean, 0);
                const sumX2 = validData.reduce((acc, d) => acc + d.year * d.year, 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                return slope * 10;
            }

            createCharts() {
                this.charts.annualMean = this.createChart('annualMeanChart', {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: this.getLineChartOptions('Annual Mean Temperature (°C)')
                });

                this.charts.annualExtremes = this.createChart('annualExtremesChart', {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: this.getLineChartOptions('Temperature (°C)')
                });

                this.charts.monthlyMean = this.createChart('monthlyMeanChart', {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: this.getLineChartOptions('Monthly Mean Temperature (°C)')
                });

                this.charts.extremeDays = this.createChart('extremeDaysChart', {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: this.getBarChartOptions('Days')
                });

                this.charts.anomaly = this.createChart('anomalyChart', {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: this.getBarChartOptions('Temperature Anomaly (°C)')
                });

                this.charts.seasonal = this.createChart('seasonalChart', {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: this.getBarChartOptions('Temperature (°C)')
                });
            }

            createChart(canvasId, config) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, config);
            }

            getLineChartOptions(yLabel) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#888' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            title: {
                                display: true,
                                text: yLabel,
                                color: '#888'
                            }
                        }
                    }
                };
            }

            getBarChartOptions(yLabel) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#888' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            title: {
                                display: true,
                                text: yLabel,
                                color: '#888'
                            }
                        }
                    }
                };
            }

            updateCharts(data) {
                const years = Object.keys(data.yearly).map(Number).sort((a, b) => a - b);
                const yearlyArr = years.map(year => data.yearly[year]);

                this.charts.annualMean.data.labels = years;
                this.charts.annualMean.data.datasets = [{
                    label: 'Annual Mean',
                    data: yearlyArr.map(y => y.meanTemp),
                    borderColor: '#00d9ff',
                    backgroundColor: 'rgba(0, 217, 255, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }];
                this.charts.annualMean.update();

                this.charts.annualExtremes.data.labels = years;
                this.charts.annualExtremes.data.datasets = [
                    {
                        label: 'Annual Max',
                        data: yearlyArr.map(y => y.annualMax),
                        borderColor: '#ff6b6b',
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        pointRadius: 3
                    },
                    {
                        label: 'Annual Min',
                        data: yearlyArr.map(y => y.annualMin),
                        borderColor: '#4ecdc4',
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        pointRadius: 3
                    }
                ];
                this.charts.annualExtremes.update();

                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthlyMeans = new Array(12).fill(null);
                const monthlyCounts = new Array(12).fill(0);

                for (const monthKey in data.monthly) {
                    const dataPoint = data.monthly[monthKey];
                    if (dataPoint.meanTemp !== null) {
                        const month = dataPoint.month - 1;
                        monthlyMeans[month] = (monthlyMeans[month] || 0) + dataPoint.meanTemp;
                        monthlyCounts[month]++;
                    }
                }

                const finalMonthlyMeans = monthlyMeans.map((sum, i) =>
                    monthlyCounts[i] > 0 ? sum / monthlyCounts[i] : null
                );

                this.charts.monthlyMean.data.labels = months;
                this.charts.monthlyMean.data.datasets = [{
                    label: 'Monthly Mean',
                    data: finalMonthlyMeans,
                    borderColor: '#00ff88',
                    backgroundColor: 'rgba(0, 255, 136, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 8
                }];
                this.charts.monthlyMean.update();

                this.charts.extremeDays.data.labels = years;
                this.charts.extremeDays.data.datasets = [
                    {
                        label: 'Hot Days (≥30°C)',
                        data: yearlyArr.map(y => y.hotDays),
                        backgroundColor: 'rgba(255, 107, 107, 0.7)',
                        borderColor: '#ff6b6b',
                        borderWidth: 1
                    },
                    {
                        label: 'Cold Days (≤-10°C)',
                        data: yearlyArr.map(y => y.coldDays),
                        backgroundColor: 'rgba(78, 205, 196, 0.7)',
                        borderColor: '#4ecdc4',
                        borderWidth: 1
                    }
                ];
                this.charts.extremeDays.update();

                const baselineYears = Object.keys(this.processedData.byYear)
                    .filter(y => parseInt(y) >= this.baselinePeriod[0] && parseInt(y) <= this.baselinePeriod[1]);
                const baselineMeans = baselineYears.map(y => this.processedData.byYear[y].meanTemp).filter(m => m !== null);
                const baselineAvg = baselineMeans.length > 0
                    ? baselineMeans.reduce((a, b) => a + b, 0) / baselineMeans.length
                    : 10;

                const anomalies = yearlyArr.map(y =>
                    y.meanTemp !== null ? y.meanTemp - baselineAvg : null
                );

                const anomalyColors = anomalies.map(a => a >= 0 ? 'rgba(255, 107, 107, 0.7)' : 'rgba(78, 205, 196, 0.7)');

                this.charts.anomaly.data.labels = years;
                this.charts.anomaly.data.datasets = [{
                    label: 'Temperature Anomaly',
                    data: anomalies,
                    backgroundColor: anomalyColors,
                    borderColor: anomalyColors.map(c => c.replace('0.7', '1')),
                    borderWidth: 1
                }];
                this.charts.anomaly.update();

                const seasons = {
                    'Winter': [12, 1, 2],
                    'Spring': [3, 4, 5],
                    'Summer': [6, 7, 8],
                    'Autumn': [9, 10, 11]
                };

                const seasonalTemps = {};
                for (const season in seasons) {
                    seasonalTemps[season] = { temps: [], count: 0 };
                }

                for (const record of data.daily) {
                    if (record.tav !== null) {
                        for (const season in seasons) {
                            if (seasons[season].includes(record.month)) {
                                seasonalTemps[season].temps.push(record.tav);
                                seasonalTemps[season].count++;
                            }
                        }
                    }
                }

                const seasonLabels = Object.keys(seasons);
                const seasonMeans = seasonLabels.map(s =>
                    seasonalTemps[s].temps.length > 0
                        ? seasonalTemps[s].temps.reduce((a, b) => a + b, 0) / seasonalTemps[s].temps.length
                        : null
                );
                const seasonMaxes = seasonLabels.map(s =>
                    seasonalTemps[s].temps.length > 0 ? Math.max(...seasonalTemps[s].temps) : null
                );
                const seasonMins = seasonLabels.map(s =>
                    seasonalTemps[s].temps.length > 0 ? Math.min(...seasonalTemps[s].temps) : null
                );

                this.charts.seasonal.data.labels = seasonLabels;
                this.charts.seasonal.data.datasets = [
                    {
                        label: 'Mean',
                        data: seasonMeans,
                        backgroundColor: 'rgba(0, 217, 255, 0.7)',
                        borderColor: '#00d9ff',
                        borderWidth: 1
                    },
                    {
                        label: 'Max',
                        data: seasonMaxes,
                        backgroundColor: 'rgba(255, 107, 107, 0.7)',
                        borderColor: '#ff6b6b',
                        borderWidth: 1
                    },
                    {
                        label: 'Min',
                        data: seasonMins,
                        backgroundColor: 'rgba(78, 205, 196, 0.7)',
                        borderColor: '#4ecdc4',
                        borderWidth: 1
                    }
                ];
                this.charts.seasonal.update();
            }

            updateTable(data) {
                const tbody = document.querySelector('#annualStatsTable tbody');
                tbody.innerHTML = '';

                const years = Object.keys(data.yearly).map(Number).sort((a, b) => a - b);
                const baselineYears = Object.keys(this.processedData.byYear)
                    .filter(y => parseInt(y) >= this.baselinePeriod[0] && parseInt(y) <= this.baselinePeriod[1]);
                const baselineMeans = baselineYears.map(y => this.processedData.byYear[y].meanTemp).filter(m => m !== null);
                const baselineAvg = baselineMeans.length > 0
                    ? baselineMeans.reduce((a, b) => a + b, 0) / baselineMeans.length
                    : 10;

                years.forEach(year => {
                    const yearly = data.yearly[year];
                    const anomaly = yearly.meanTemp !== null ? yearly.meanTemp - baselineAvg : null;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${year}</td>
                        <td>${yearly.meanTemp !== null ? yearly.meanTemp.toFixed(2) : '--'}</td>
                        <td>${yearly.annualMax !== null ? yearly.annualMax.toFixed(1) : '--'}</td>
                        <td>${yearly.annualMin !== null ? yearly.annualMin.toFixed(1) : '--'}</td>
                        <td>${yearly.hotDays}</td>
                        <td>${yearly.coldDays}</td>
                        <td>${anomaly !== null
                            ? `<span class="trend-indicator ${anomaly >= 0 ? 'up' : 'down'}">
                                ${anomaly >= 0 ? '↑' : '↓'} ${Math.abs(anomaly).toFixed(2)}°C
                               </span>`
                            : '--'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            showLoading(show) {
                document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new ClimateDashboard();
        });
    </script>
</body>
</html>
