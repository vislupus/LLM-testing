<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sofia Climate Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Simple, clean styling -->
  <style>
    :root {
      --bg: #f4f4f7;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --radius: 0.75rem;
      --shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe, #f4f4f7 45%);
      color: var(--text-main);
    }

    header {
      padding: 1.5rem 1rem 0.5rem;
    }

    header .inner {
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      margin: 0;
      font-size: 1.9rem;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0.4rem 0 0;
      color: var(--text-muted);
      max-width: 40rem;
      font-size: 0.95rem;
    }

    main {
      padding: 0 1rem 2rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.25rem 1.4rem;
      max-width: 1100px;
      margin: 1rem auto 0;
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 0.65rem;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .card h2 span.badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1.5rem;
      align-items: center;
      font-size: 0.95rem;
    }

    .controls-row .field {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    label {
      font-weight: 500;
    }

    select {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 0.25rem 0.8rem;
      font-size: 0.95rem;
      background: #f9fafb;
    }

    #dataStatus {
      margin-top: 0.6rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    #dataStatus.error {
      color: #b91c1c;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 0.75rem;
      font-size: 0.9rem;
    }

    .summary-item {
      padding: 0.55rem 0.7rem;
      border-radius: 0.6rem;
      background: #f9fafb;
      border: 1px solid var(--border-subtle);
    }

    .summary-item h3 {
      margin: 0;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .summary-item p {
      margin: 0.25rem 0 0;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .summary-item small {
      display: block;
      margin-top: 0.15rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 340px;
      margin-top: 0.5rem;
    }

    .help-text {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    @media (max-width: 720px) {
      .card {
        padding: 1.1rem 1rem;
      }
      .chart-container {
        height: 260px;
      }
    }

    .spinner {
      display: inline-block;
      width: 0.9rem;
      height: 0.9rem;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.6);
      border-top-color: var(--accent);
      animation: spin 0.85s linear infinite;
      margin-right: 0.35rem;
      vertical-align: -0.1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <h1>Sofia Climate Dashboard</h1>
      <p>
        Interactive exploration of daily temperature records for Sofia
        (TAVG, TMAX, TMIN), loaded directly from a local CSV file.
        Choose a year range to update all charts and statistics.
      </p>
    </div>
  </header>

  <main>
    <!-- Controls -->
    <section class="card" aria-label="Filters">
      <h2>
        Year range
        <span class="badge">Filter</span>
      </h2>

      <div class="controls-row">
        <div class="field">
          <label for="startYear">From</label>
          <select id="startYear"></select>
        </div>

        <div class="field">
          <label for="endYear">To</label>
          <select id="endYear"></select>
        </div>
      </div>

      <div id="dataStatus">
        <span class="spinner"></span>Loading CSV data…
      </div>
    </section>

    <!-- Summary statistics -->
    <section class="card" aria-label="Summary statistics">
      <h2>
        Summary
        <span class="badge">Overview</span>
      </h2>
      <div id="summaryContent" class="summary-grid"></div>
    </section>

    <!-- Annual chart -->
    <section class="card" aria-label="Annual temperature chart">
      <h2>
        Annual temperature summary
        <span class="badge">Yearly</span>
      </h2>
      <div class="chart-container">
        <canvas id="annualChart"></canvas>
      </div>
      <p class="help-text">
        Shows annual mean temperature with yearly extremes (hottest and coldest daily values)
        for the selected range.
      </p>
    </section>

    <!-- Monthly chart -->
    <section class="card" aria-label="Monthly temperature chart">
      <h2>
        Monthly mean temperature
        <span class="badge">Monthly</span>
      </h2>
      <div class="chart-container">
        <canvas id="monthlyChart"></canvas>
      </div>
      <p class="help-text">
        Each point is the mean daily temperature for a month (YYYY-MM) within the selected year range.
      </p>
    </section>

    <!-- Hot / Cold days chart -->
    <section class="card" aria-label="Hot and cold days">
      <h2>
        Very hot &amp; very cold days
        <span class="badge">Extremes</span>
      </h2>
      <div class="chart-container">
        <canvas id="hotColdChart"></canvas>
      </div>
      <p class="help-text">
        Counts of days per year with TMAX ≥ 30&nbsp;°C (very hot) and TMIN ≤ −10&nbsp;°C (very cold),
        for the selected range.
      </p>
    </section>
  </main>

  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const CSV_FILE = 'temperature_Sofia_2809794_1952-01-01 - 2021-11-28.csv';

    let dailyData = [];
    let annualChart = null;
    let monthlyChart = null;
    let hotColdChart = null;

    document.addEventListener('DOMContentLoaded', () => {
      loadData();
    });

    async function loadData() {
      setStatus('Loading CSV data…', false, true);

      try {
        const res = await fetch(CSV_FILE);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status} (${res.statusText})`);
        }

        const text = await res.text();
        dailyData = parseCsv(text);

        if (!dailyData.length) {
          throw new Error('No valid data rows found in CSV.');
        }

        const years = Array.from(new Set(dailyData.map(d => d.year))).sort((a, b) => a - b);
        populateYearSelectors(years);

        setStatus(
          `Loaded ${dailyData.length.toLocaleString()} daily records (${years[0]}–${years[years.length - 1]}).`
        );

        updateDashboard();
      } catch (err) {
        console.error(err);
        setStatus(
          'Failed to load CSV: ' + err.message +
          ' (Tip: open this page via a local web server, not file://).',
          true
        );
      }
    }

    function setStatus(message, isError = false, showSpinner = false) {
      const el = document.getElementById('dataStatus');
      if (!el) return;
      el.classList.toggle('error', !!isError);
      el.innerHTML = '';

      if (showSpinner) {
        const span = document.createElement('span');
        span.className = 'spinner';
        el.appendChild(span);
      }
      el.append(message);
    }

    // --- CSV parsing that understands quotes and commas in fields ---

    function parseCsvLine(line) {
      // Remove potential BOM from first line
      line = line.replace(/^\uFEFF/, '');
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];

        if (ch === '"') {
          // Handle escaped double quote ("")
          if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += ch;
        }
      }
      result.push(current);
      return result;
    }

    function findColumnIndex(header, name) {
      const target = name.toUpperCase();
      return header.findIndex(col => col.toUpperCase() === target);
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) return [];

      const headerRaw = parseCsvLine(lines[0]);
      const header = headerRaw.map(h => h.trim());

      const idxDate = findColumnIndex(header, 'DATE');
      const idxTavg = findColumnIndex(header, 'TAVG');
      const idxTmax = findColumnIndex(header, 'TMAX');
      const idxTmin = findColumnIndex(header, 'TMIN');

      if (idxDate === -1) {
        throw new Error('DATE column not found in CSV header.');
      }

      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const cols = parseCsvLine(line);

        const dateStr = cols[idxDate];
        if (!dateStr) continue;

        const parts = dateStr.split('-').map(Number);
        if (parts.length !== 3) continue;

        const [year, month, day] = parts;
        if (!year || !month || !day) continue;

        const date = new Date(year, month - 1, day);

        const getVal = (idx) => {
          if (idx === -1 || idx >= cols.length) return null;
          const rawStr = cols[idx];
          if (rawStr === undefined) return null;
          const trimmed = rawStr.trim();
          if (trimmed === '') return null;
          const raw = Number(trimmed);
          if (!Number.isFinite(raw)) return null;
          if (raw <= -9000) return null; // missing sentinel
          return raw / 10.0; // tenths of °C -> °C
        };

        let tavg = getVal(idxTavg);
        const tmax = getVal(idxTmax);
        const tmin = getVal(idxTmin);

        if (tavg == null && tmax != null && tmin != null) {
          tavg = (tmax + tmin) / 2;
        }

        if (tavg == null && tmax == null && tmin == null) {
          continue;
        }

        data.push({ date, year, month, day, tavg, tmax, tmin });
      }

      data.sort((a, b) => a.date - b.date);
      return data;
    }

    function populateYearSelectors(years) {
      const startSel = document.getElementById('startYear');
      const endSel = document.getElementById('endYear');
      if (!startSel || !endSel) return;

      startSel.innerHTML = '';
      endSel.innerHTML = '';

      years.forEach(y => {
        const opt1 = document.createElement('option');
        opt1.value = y;
        opt1.textContent = y;
        startSel.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = y;
        opt2.textContent = y;
        endSel.appendChild(opt2);
      });

      startSel.value = years[0];
      endSel.value = years[years.length - 1];

      const onChange = (e) => {
        const start = parseInt(startSel.value, 10);
        const end = parseInt(endSel.value, 10);

        if (start > end) {
          // Keep the range valid by snapping the other end
          if (e && e.target === startSel) {
            endSel.value = startSel.value;
          } else {
            startSel.value = endSel.value;
          }
        }

        updateDashboard();
      };

      startSel.addEventListener('change', onChange);
      endSel.addEventListener('change', onChange);
    }

    function updateDashboard() {
      if (!dailyData.length) return;

      const startYear = parseInt(document.getElementById('startYear').value, 10);
      const endYear = parseInt(document.getElementById('endYear').value, 10);

      const rangeData = dailyData.filter(
        d => d.year >= startYear && d.year <= endYear
      );

      if (!rangeData.length) {
        return;
      }

      const aggregates = computeAggregates(rangeData);
      renderSummary(aggregates, startYear, endYear);
      renderAnnualChart(aggregates);
      renderMonthlyChart(aggregates);
      renderHotColdChart(aggregates);
    }

    function computeAggregates(rows) {
      const yearly = {};
      const monthly = {};

      let overallSumTavg = 0;
      let overallCountTavg = 0;

      let globalMax = -Infinity;
      let globalMaxDate = null;
      let globalMin = Infinity;
      let globalMinDate = null;

      for (const r of rows) {
        const { year, month, date, tavg, tmax, tmin } = r;

        if (!yearly[year]) {
          yearly[year] = {
            sumTavg: 0,
            countTavg: 0,
            maxTmax: -Infinity,
            minTmin: Infinity,
            hotDays: 0,
            coldDays: 0
          };
        }
        const yAg = yearly[year];

        if (tavg != null) {
          yAg.sumTavg += tavg;
          yAg.countTavg++;
          overallSumTavg += tavg;
          overallCountTavg++;
        }

        if (tmax != null) {
          if (tmax > yAg.maxTmax) yAg.maxTmax = tmax;
          if (tmax > globalMax) {
            globalMax = tmax;
            globalMaxDate = date;
          }
          if (tmax >= 30) yAg.hotDays++;
        }

        if (tmin != null) {
          if (tmin < yAg.minTmin) yAg.minTmin = tmin;
          if (tmin < globalMin) {
            globalMin = tmin;
            globalMinDate = date;
          }
          if (tmin <= -10) yAg.coldDays++;
        }

        const key = `${year}-${String(month).padStart(2, '0')}`;
        if (!monthly[key]) {
          monthly[key] = { sumTavg: 0, countTavg: 0 };
        }
        if (tavg != null) {
          monthly[key].sumTavg += tavg;
          monthly[key].countTavg++;
        }
      }

      const years = Object.keys(yearly).map(Number).sort((a, b) => a - b);
      const annualMeans = [];
      const annualMax = [];
      const annualMin = [];
      const hotCounts = [];
      const coldCounts = [];

      for (const y of years) {
        const yAg = yearly[y];
        annualMeans.push(
          yAg.countTavg ? yAg.sumTavg / yAg.countTavg : null
        );
        annualMax.push(
          yAg.maxTmax === -Infinity ? null : yAg.maxTmax
        );
        annualMin.push(
          yAg.minTmin === Infinity ? null : yAg.minTmin
        );
        hotCounts.push(yAg.hotDays);
        coldCounts.push(yAg.coldDays);
      }

      const monthKeys = Object.keys(monthly).sort();
      const monthLabels = [];
      const monthMeans = [];
      for (const key of monthKeys) {
        const mAg = monthly[key];
        if (!mAg.countTavg) continue;
        monthLabels.push(key);
        monthMeans.push(mAg.sumTavg / mAg.countTavg);
      }

      // Simple linear regression on annual mean vs year
      let trendPerDecade = null;
      let trendTotalChange = null;

      const xs = [];
      const ys = [];
      for (let i = 0; i < years.length; i++) {
        if (annualMeans[i] != null) {
          xs.push(years[i]);
          ys.push(annualMeans[i]);
        }
      }

      if (xs.length >= 2) {
        const n = xs.length;
        const meanX = xs.reduce((a, b) => a + b, 0) / n;
        const meanY = ys.reduce((a, b) => a + b, 0) / n;
        let num = 0;
        let den = 0;
        for (let i = 0; i < n; i++) {
          const dx = xs[i] - meanX;
          num += dx * (ys[i] - meanY);
          den += dx * dx;
        }
        if (den !== 0) {
          const slopePerYear = num / den;
          trendPerDecade = slopePerYear * 10;
          trendTotalChange = ys[ys.length - 1] - ys[0];
        }
      }

      return {
        years,
        annualMeans,
        annualMax,
        annualMin,
        monthLabels,
        monthMeans,
        hotCounts,
        coldCounts,
        overallMean: overallCountTavg ? overallSumTavg / overallCountTavg : null,
        overallHot: hotCounts.reduce((a, b) => a + b, 0),
        overallCold: coldCounts.reduce((a, b) => a + b, 0),
        globalMax,
        globalMaxDate,
        globalMin,
        globalMinDate,
        trendPerDecade,
        trendTotalChange
      };
    }

    function formatDate(date) {
      if (!(date instanceof Date)) return '';
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function renderSummary(agg, startYear, endYear) {
      const el = document.getElementById('summaryContent');
      if (!el) return;

      const items = [];

      items.push({
        title: 'Year range',
        value: `${startYear}–${endYear}`,
        detail: 'All statistics below use this subset of the record.'
      });

      if (agg.overallMean != null) {
        items.push({
          title: 'Mean temperature',
          value: `${agg.overallMean.toFixed(1)} °C`,
          detail: 'Daily average temperature over all days in the selected range.'
        });
      }

      if (Number.isFinite(agg.globalMax) && agg.globalMaxDate) {
        items.push({
          title: 'Warmest day',
          value: `${agg.globalMax.toFixed(1)} °C`,
          detail: formatDate(agg.globalMaxDate)
        });
      }

      if (Number.isFinite(agg.globalMin) && agg.globalMinDate) {
        items.push({
          title: 'Coldest day',
          value: `${agg.globalMin.toFixed(1)} °C`,
          detail: formatDate(agg.globalMinDate)
        });
      }

      items.push({
        title: 'Very hot days',
        value: agg.overallHot.toLocaleString(),
        detail: 'Days with TMAX ≥ 30 °C.'
      });

      items.push({
        title: 'Very cold days',
        value: agg.overallCold.toLocaleString(),
        detail: 'Days with TMIN ≤ −10 °C.'
      });

      if (agg.trendPerDecade != null) {
        const slope = agg.trendPerDecade;
        const total = agg.trendTotalChange != null
          ? agg.trendTotalChange.toFixed(1)
          : 'n/a';
        items.push({
          title: 'Warming trend',
          value: `${slope.toFixed(2)} °C / decade`,
          detail: `Approx. ${total} °C change from first to last year.`
        });
      } else {
        items.push({
          title: 'Warming trend',
          value: 'n/a',
          detail: 'Not enough annual data in the selected range.'
        });
      }

      el.innerHTML = items.map(it => `
        <div class="summary-item">
          <h3>${it.title}</h3>
          <p>${it.value}</p>
          ${it.detail ? `<small>${it.detail}</small>` : ''}
        </div>
      `).join('');
    }

    function renderAnnualChart(agg) {
      const ctx = document.getElementById('annualChart').getContext('2d');

      const data = {
        labels: agg.years,
        datasets: [
          {
            label: 'Mean temperature (TAVG)',
            data: agg.annualMeans,
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.15
          },
          {
            label: 'Yearly max (TMAX)',
            data: agg.annualMax,
            borderWidth: 1.5,
            pointRadius: 0,
            borderDash: [4, 3],
            tension: 0.15
          },
          {
            label: 'Yearly min (TMIN)',
            data: agg.annualMin,
            borderWidth: 1.5,
            pointRadius: 0,
            borderDash: [4, 3],
            tension: 0.15
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const v = context.parsed.y;
                if (v == null || Number.isNaN(v)) return context.dataset.label;
                return `${context.dataset.label}: ${v.toFixed(1)} °C`;
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Year'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Temperature (°C)'
            }
          }
        }
      };

      if (annualChart) {
        annualChart.data = data;
        annualChart.options = options;
        annualChart.update();
      } else {
        annualChart = new Chart(ctx, {
          type: 'line',
          data,
          options
        });
      }
    }

    function renderMonthlyChart(agg) {
      const ctx = document.getElementById('monthlyChart').getContext('2d');

      const data = {
        labels: agg.monthLabels,
        datasets: [
          {
            label: 'Monthly mean temperature',
            data: agg.monthMeans,
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.15,
            fill: false
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              title: (items) => {
                if (!items.length) return '';
                return items[0].label; // "YYYY-MM"
              },
              label: (context) => {
                const v = context.parsed.y;
                if (v == null || Number.isNaN(v)) return context.dataset.label;
                return `${context.dataset.label}: ${v.toFixed(1)} °C`;
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Year–Month'
            },
            ticks: {
              maxRotation: 0,
              autoSkip: true,
              autoSkipPadding: 16
            }
          },
          y: {
            title: {
              display: true,
              text: 'Temperature (°C)'
            }
          }
        }
      };

      if (monthlyChart) {
        monthlyChart.data = data;
        monthlyChart.options = options;
        monthlyChart.update();
      } else {
        monthlyChart = new Chart(ctx, {
          type: 'line',
          data,
          options
        });
      }
    }

    function renderHotColdChart(agg) {
      const ctx = document.getElementById('hotColdChart').getContext('2d');

      const data = {
        labels: agg.years,
        datasets: [
          {
            label: 'Very hot days (TMAX ≥ 30 °C)',
            data: agg.hotCounts
          },
          {
            label: 'Very cold days (TMIN ≤ −10 °C)',
            data: agg.coldCounts
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const v = context.parsed.y;
                if (v == null || Number.isNaN(v)) return context.dataset.label;
                return `${context.dataset.label}: ${v}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Year'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Days per year'
            },
            beginAtZero: true
          }
        }
      };

      if (hotColdChart) {
        hotColdChart.data = data;
        hotColdChart.options = options;
        hotColdChart.update();
      } else {
        hotColdChart = new Chart(ctx, {
          type: 'bar',
          data,
          options
        });
      }
    }
  </script>
</body>
</html>
