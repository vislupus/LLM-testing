<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia Climate Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #0d1b2a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(79, 195, 247, 0.1), rgba(129, 212, 250, 0.05));
            border-radius: 15px;
            border: 1px solid rgba(79, 195, 247, 0.3);
        }
        
        h1 {
            color: #4fc3f7;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
        }
        
        .subtitle {
            color: #90a4ae;
            font-size: 1.1em;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding: 20px;
            background: rgba(42, 42, 74, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        label {
            font-weight: 600;
            color: #81d4fa;
        }
        
        select {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #4fc3f7;
            background: #1a1a3e;
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        select:hover {
            background: #2a2a5e;
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.3);
        }
        
        select:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        
        .file-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: #000;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 195, 247, 0.4);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(145deg, rgba(42, 42, 74, 0.9), rgba(26, 26, 62, 0.9));
            padding: 25px 15px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(79, 195, 247, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4fc3f7, #81d4fa, #4fc3f7);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(79, 195, 247, 0.2);
            border-color: rgba(79, 195, 247, 0.5);
        }
        
        .stat-card h3 {
            color: #81d4fa;
            margin-bottom: 15px;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 2.2em;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #81d4fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-card .value.positive {
            background: linear-gradient(135deg, #ff5252, #ff8a80);
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        .stat-card .value.negative {
            background: linear-gradient(135deg, #69f0ae, #b9f6ca);
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        .stat-card .unit {
            color: #78909c;
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-wrapper {
            background: linear-gradient(145deg, rgba(42, 42, 74, 0.8), rgba(26, 26, 62, 0.8));
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .chart-wrapper:hover {
            border-color: rgba(79, 195, 247, 0.3);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        }
        
        .chart-wrapper h3 {
            color: #4fc3f7;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(79, 195, 247, 0.2);
        }
        
        .loading {
            text-align: center;
            padding: 80px 20px;
            font-size: 1.3em;
            color: #81d4fa;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(79, 195, 247, 0.2);
            border-top-color: #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: linear-gradient(135deg, rgba(255, 82, 82, 0.2), rgba(255, 82, 82, 0.1));
            border: 1px solid #ff5252;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }
        
        .error h4 {
            color: #ff8a80;
            margin-bottom: 10px;
        }
        
        .info-box {
            background: linear-gradient(135deg, rgba(79, 195, 247, 0.1), rgba(79, 195, 247, 0.05));
            border: 1px solid rgba(79, 195, 247, 0.3);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #b0bec5;
        }
        
        .info-box code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            color: #4fc3f7;
        }
        
        .data-range-info {
            text-align: center;
            color: #78909c;
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        
        .data-range-info span {
            color: #4fc3f7;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                min-width: auto;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .stat-card .value {
                font-size: 1.8em;
            }
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #546e7a;
            font-size: 0.85em;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå°Ô∏è Sofia Climate Dashboard</h1>
        <p class="subtitle">Historical Temperature Analysis & Trends</p>
    </div>
    
    <div class="info-box">
        <strong>üìÅ Data Loading:</strong> The dashboard will attempt to load the CSV file automatically. 
        If running locally, use a simple server (e.g., <code>python -m http.server</code> or VS Code Live Server), 
        or use the file selector below to manually load the CSV file.
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label for="startYear">üìÖ Start Year:</label>
            <select id="startYear" disabled>
                <option>Loading...</option>
            </select>
        </div>
        <div class="control-group">
            <label for="endYear">üìÖ End Year:</label>
            <select id="endYear" disabled>
                <option>Loading...</option>
            </select>
        </div>
        <div class="control-group">
            <div class="file-input-wrapper">
                <div class="file-btn">üìÇ Load CSV File</div>
                <input type="file" id="fileInput" accept=".csv">
            </div>
        </div>
    </div>
    
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>Loading climate data...</p>
    </div>
    
    <div id="error" class="error" style="display: none;">
        <h4>‚ö†Ô∏è Data Loading Issue</h4>
        <p id="errorMessage"></p>
    </div>
    
    <div id="dashboard" style="display: none;">
        <div id="dataRangeInfo" class="data-range-info"></div>
        
        <div class="stats-container">
            <div class="stat-card">
                <h3>üìä Overall Mean Temp</h3>
                <div class="value" id="overallMean">--</div>
                <div class="unit">¬∞C</div>
            </div>
            <div class="stat-card">
                <h3>üìà Warming Trend</h3>
                <div class="value" id="warmingTrend">--</div>
                <div class="unit">¬∞C per decade</div>
            </div>
            <div class="stat-card">
                <h3>üî• Record High</h3>
                <div class="value positive" id="highestTemp">--</div>
                <div class="unit">¬∞C</div>
            </div>
            <div class="stat-card">
                <h3>‚ùÑÔ∏è Record Low</h3>
                <div class="value negative" id="lowestTemp">--</div>
                <div class="unit">¬∞C</div>
            </div>
            <div class="stat-card">
                <h3>‚òÄÔ∏è Very Hot Days</h3>
                <div class="value positive" id="hotDays">--</div>
                <div class="unit">TMAX ‚â• 30¬∞C</div>
            </div>
            <div class="stat-card">
                <h3>ü•∂ Very Cold Days</h3>
                <div class="value negative" id="coldDays">--</div>
                <div class="unit">TMIN ‚â§ -10¬∞C</div>
            </div>
            <div class="stat-card">
                <h3>üìÜ Total Records</h3>
                <div class="value" id="totalRecords">--</div>
                <div class="unit">daily observations</div>
            </div>
            <div class="stat-card">
                <h3>üìÖ Years Covered</h3>
                <div class="value" id="yearsCovered">--</div>
                <div class="unit">years of data</div>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-wrapper">
                <h3>üìà Annual Mean Temperature with Trend</h3>
                <canvas id="yearlyMeanChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3>üå°Ô∏è Annual Temperature Extremes</h3>
                <canvas id="yearlyExtremesChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3>üìä Monthly Mean Temperature (Climatology)</h3>
                <canvas id="monthlyMeanChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3>üî•‚ùÑÔ∏è Hot & Cold Days per Year</h3>
                <canvas id="hotColdChart"></canvas>
            </div>
            <div class="chart-wrapper" style="grid-column: span 2;">
                <h3>üìâ Decadal Temperature Comparison</h3>
                <canvas id="decadalChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Data source: NOAA Climate Data | Temperature values converted from tenths of ¬∞C to ¬∞C</p>
    </div>
    
    <script>
        // Global variables
        let rawData = [];
        let charts = {};
        const CSV_FILENAME = 'temperature_Sofia_2809794_1952-01-01 - 2021-11-28.csv';
        
        // Chart.js global defaults
        Chart.defaults.color = '#b0bec5';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        
        // Initialize the dashboard
        async function init() {
            try {
                // Try to fetch the CSV file
                const response = await fetch(CSV_FILENAME);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Could not load file`);
                }
                const csvText = await response.text();
                parseCSV(csvText);
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showError(`Could not automatically load "${CSV_FILENAME}". Please use the "Load CSV File" button to manually select the data file.<br><br><small>Technical details: ${error.message}</small>`);
            }
        }
        
        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                };
                reader.onerror = function() {
                    showError('Error reading the file. Please try again.');
                };
                reader.readAsText(file);
            }
        });
        
        // Parse CSV data
        function parseCSV(csvText) {
            try {
                const lines = csvText.trim().split(/\r?\n/);
                const headers = parseCSVLine(lines[0]);
                
                // Find column indices (case-insensitive)
                const findColumn = (name) => headers.findIndex(h => 
                    h.toUpperCase().trim() === name.toUpperCase()
                );
                
                const dateIdx = findColumn('DATE');
                const tavgIdx = findColumn('TAVG');
                const tmaxIdx = findColumn('TMAX');
                const tminIdx = findColumn('TMIN');
                
                if (dateIdx === -1) {
                    throw new Error('DATE column not found in CSV. Please check the file format.');
                }
                
                rawData = [];
                let parseErrors = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = parseCSVLine(lines[i]);
                    const dateStr = values[dateIdx];
                    
                    if (!dateStr) continue;
                    
                    // Parse date - handle various formats
                    let date;
                    if (dateStr.includes('-')) {
                        date = new Date(dateStr);
                    } else if (dateStr.length === 8) {
                        // YYYYMMDD format
                        const year = dateStr.substring(0, 4);
                        const month = dateStr.substring(4, 6);
                        const day = dateStr.substring(6, 8);
                        date = new Date(`${year}-${month}-${day}`);
                    } else {
                        date = new Date(dateStr);
                    }
                    
                    if (isNaN(date.getTime())) {
                        parseErrors++;
                        continue;
                    }
                    
                    // Parse temperature values (convert from tenths of degrees to degrees)
                    const parseTemp = (idx) => {
                        if (idx === -1 || !values[idx] || values[idx].trim() === '') return null;
                        const val = parseFloat(values[idx]);
                        return isNaN(val) ? null : val / 10;
                    };
                    
                    const tavg = parseTemp(tavgIdx);
                    const tmax = parseTemp(tmaxIdx);
                    const tmin = parseTemp(tminIdx);
                    
                    // Only include records with at least some temperature data
                    if (tavg !== null || tmax !== null || tmin !== null) {
                        rawData.push({
                            date: date,
                            year: date.getFullYear(),
                            month: date.getMonth() + 1,
                            day: date.getDate(),
                            tavg: tavg,
                            tmax: tmax,
                            tmin: tmin
                        });
                    }
                }
                
                if (rawData.length === 0) {
                    throw new Error('No valid temperature data found in CSV. Please check the file format.');
                }
                
                // Sort by date
                rawData.sort((a, b) => a.date - b.date);
                
                console.log(`Parsed ${rawData.length} records with ${parseErrors} parse errors`);
                
                // Populate year selectors
                const years = [...new Set(rawData.map(d => d.year))].sort((a, b) => a - b);
                populateYearSelectors(years);
                
                // Hide loading, show dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // Destroy existing charts if any
                Object.values(charts).forEach(chart => chart.destroy());
                charts = {};
                
                // Initialize charts
                initCharts();
                
                // Update with initial data
                updateDashboard();
                
            } catch (error) {
                showError(`Error parsing CSV: ${error.message}`);
            }
        }
        
        // Parse a single CSV line (handles quoted values)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }
        
        function showError(message) {
            document.getElementById('errorMessage').innerHTML = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
        
        function populateYearSelectors(years) {
            const startSelect = document.getElementById('startYear');
            const endSelect = document.getElementById('endYear');
            
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';
            
            years.forEach(year => {
                startSelect.innerHTML += `<option value="${year}">${year}</option>`;
                endSelect.innerHTML += `<option value="${year}">${year}</option>`;
            });
            
            startSelect.value = years[0];
            endSelect.value = years[years.length - 1];
            startSelect.disabled = false;
            endSelect.disabled = false;
            
            startSelect.addEventListener('change', () => {
                // Ensure end year is not before start year
                if (parseInt(endSelect.value) < parseInt(startSelect.value)) {
                    endSelect.value = startSelect.value;
                }
                updateDashboard();
            });
            
            endSelect.addEventListener('change', () => {
                // Ensure start year is not after end year
                if (parseInt(startSelect.value) > parseInt(endSelect.value)) {
                    startSelect.value = endSelect.value;
                }
                updateDashboard();
            });
        }
        
        function getFilteredData() {
            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);
            return rawData.filter(d => d.year >= startYear && d.year <= endYear);
        }
        
        function initCharts() {
            // Yearly Mean Chart
            const yearlyMeanCtx = document.getElementById('yearlyMeanChart').getContext('2d');
            charts.yearlyMean = new Chart(yearlyMeanCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Annual Mean (¬∞C)',
                        data: [],
                        borderColor: '#4fc3f7',
                        backgroundColor: 'rgba(79, 195, 247, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }, {
                        label: 'Trend Line',
                        data: [],
                        borderColor: '#ff5252',
                        borderWidth: 2,
                        borderDash: [8, 4],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#4fc3f7',
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y?.toFixed(2) || 'N/A'}¬∞C`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            }
                        }
                    }
                }
            });
            
            // Yearly Extremes Chart
            const yearlyExtremesCtx = document.getElementById('yearlyExtremesChart').getContext('2d');
            charts.yearlyExtremes = new Chart(yearlyExtremesCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Annual Max (¬∞C)',
                        data: [],
                        borderColor: '#ff5252',
                        backgroundColor: 'rgba(255, 82, 82, 0.1)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 2
                    }, {
                        label: 'Annual Min (¬∞C)',
                        data: [],
                        borderColor: '#69f0ae',
                        backgroundColor: 'rgba(105, 240, 174, 0.1)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)'
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            }
                        }
                    }
                }
            });
            
            // Monthly Mean Chart
            const monthlyMeanCtx = document.getElementById('monthlyMeanChart').getContext('2d');
            charts.monthlyMean = new Chart(monthlyMeanCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Monthly Mean (¬∞C)',
                        data: [],
                        backgroundColor: [
                            'rgba(100, 181, 246, 0.7)',
                            'rgba(100, 181, 246, 0.7)',
                            'rgba(129, 199, 132, 0.7)',
                            'rgba(129, 199, 132, 0.7)',
                            'rgba(255, 213, 79, 0.7)',
                            'rgba(255, 138, 101, 0.7)',
                            'rgba(239, 83, 80, 0.7)',
                            'rgba(239, 83, 80, 0.7)',
                            'rgba(255, 138, 101, 0.7)',
                            'rgba(255, 213, 79, 0.7)',
                            'rgba(129, 199, 132, 0.7)',
                            'rgba(100, 181, 246, 0.7)'
                        ],
                        borderColor: [
                            '#64b5f6', '#64b5f6', '#81c784', '#81c784',
                            '#ffd54f', '#ff8a65', '#ef5350', '#ef5350',
                            '#ff8a65', '#ffd54f', '#81c784', '#64b5f6'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    return `Mean: ${context.parsed.y?.toFixed(1) || 'N/A'}¬∞C`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            }
                        }
                    }
                }
            });
            
            // Hot/Cold Days Chart
            const hotColdCtx = document.getElementById('hotColdChart').getContext('2d');
            charts.hotCold = new Chart(hotColdCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Hot Days (TMAX ‚â• 30¬∞C)',
                        data: [],
                        backgroundColor: 'rgba(255, 82, 82, 0.7)',
                        borderColor: '#ff5252',
                        borderWidth: 1
                    }, {
                        label: 'Cold Days (TMIN ‚â§ -10¬∞C)',
                        data: [],
                        backgroundColor: 'rgba(79, 195, 247, 0.7)',
                        borderColor: '#4fc3f7',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            title: {
                                display: true,
                                text: 'Number of Days'
                            }
                        }
                    }
                }
            });
            
            // Decadal Comparison Chart
            const decadalCtx = document.getElementById('decadalChart').getContext('2d');
            charts.decadal = new Chart(decadalCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Decadal Mean Temperature (¬∞C)',
                        data: [],
                        backgroundColor: [],
                        borderColor: [],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    return `Mean: ${context.parsed.y?.toFixed(2) || 'N/A'}¬∞C`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            }
                        }
                    }
                }
            });
        }
        
        function updateDashboard() {
            const data = getFilteredData();
            if (data.length === 0) return;
            
            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);
            
            // Update data range info
            document.getElementById('dataRangeInfo').innerHTML = 
                `Showing data from <span>${startYear}</span> to <span>${endYear}</span> ` +
                `(${data.length.toLocaleString()} daily records)`;
            
            // Calculate statistics
            const yearlyStats = calculateYearlyStats(data);
            const monthlyStats = calculateMonthlyStats(data);
            const decadalStats = calculateDecadalStats(data);
            const overallStats = calculateOverallStats(data, yearlyStats);
            
            // Update summary cards
            document.getElementById('overallMean').textContent = overallStats.mean.toFixed(1);
            
            const trendValue = overallStats.trend;
            const trendElement = document.getElementById('warmingTrend');
            trendElement.textContent = (trendValue > 0 ? '+' : '') + trendValue.toFixed(2);
            trendElement.className = 'value ' + (trendValue > 0 ? 'positive' : trendValue < 0 ? 'negative' : '');
            
            document.getElementById('highestTemp').textContent = overallStats.maxTemp.toFixed(1);
            document.getElementById('lowestTemp').textContent = overallStats.minTemp.toFixed(1);
            document.getElementById('hotDays').textContent = overallStats.totalHotDays.toLocaleString();
            document.getElementById('coldDays').textContent = overallStats.totalColdDays.toLocaleString();
            document.getElementById('totalRecords').textContent = data.length.toLocaleString();
            document.getElementById('yearsCovered').textContent = (endYear - startYear + 1);
            
            // Update charts
            updateYearlyMeanChart(yearlyStats);
            updateYearlyExtremesChart(yearlyStats);
            updateMonthlyMeanChart(monthlyStats);
            updateHotColdChart(yearlyStats);
            updateDecadalChart(decadalStats);
        }
        
        function calculateYearlyStats(data) {
            const yearlyData = {};
            
            data.forEach(d => {
                if (!yearlyData[d.year]) {
                    yearlyData[d.year] = {
                        tavgSum: 0, tavgCount: 0,
                        tmax: -Infinity, tmin: Infinity,
                        hotDays: 0, coldDays: 0
                    };
                }
                
                if (d.tavg !== null) {
                    yearlyData[d.year].tavgSum += d.tavg;
                    yearlyData[d.year].tavgCount++;
                }
                
                if (d.tmax !== null) {
                    yearlyData[d.year].tmax = Math.max(yearlyData[d.year].tmax, d.tmax);
                    if (d.tmax >= 30) yearlyData[d.year].hotDays++;
                }
                
                if (d.tmin !== null) {
                    yearlyData[d.year].tmin = Math.min(yearlyData[d.year].tmin, d.tmin);
                    if (d.tmin <= -10) yearlyData[d.year].coldDays++;
                }
            });
            
            return Object.keys(yearlyData)
                .map(year => parseInt(year))
                .sort((a, b) => a - b)
                .map(year => {
                    const yd = yearlyData[year];
                    return {
                        year: year,
                        mean: yd.tavgCount > 0 ? yd.tavgSum / yd.tavgCount : null,
                        max: yd.tmax === -Infinity ? null : yd.tmax,
                        min: yd.tmin === Infinity ? null : yd.tmin,
                        hotDays: yd.hotDays,
                        coldDays: yd.coldDays
                    };
                });
        }
        
        function calculateMonthlyStats(data) {
            const monthlyData = {};
            for (let m = 1; m <= 12; m++) {
                monthlyData[m] = { sum: 0, count: 0 };
            }
            
            data.forEach(d => {
                if (d.tavg !== null) {
                    monthlyData[d.month].sum += d.tavg;
                    monthlyData[d.month].count++;
                }
            });
            
            return Array.from({ length: 12 }, (_, i) => {
                const md = monthlyData[i + 1];
                return md.count > 0 ? md.sum / md.count : null;
            });
        }
        
        function calculateDecadalStats(data) {
            const decadalData = {};
            
            data.forEach(d => {
                const decade = Math.floor(d.year / 10) * 10;
                if (!decadalData[decade]) {
                    decadalData[decade] = { sum: 0, count: 0 };
                }
                if (d.tavg !== null) {
                    decadalData[decade].sum += d.tavg;
                    decadalData[decade].count++;
                }
            });
            
            return Object.keys(decadalData)
                .map(d => parseInt(d))
                .sort((a, b) => a - b)
                .map(decade => ({
                    decade: `${decade}s`,
                    mean: decadalData[decade].count > 0 
                        ? decadalData[decade].sum / decadalData[decade].count 
                        : null
                }));
        }
        
        function calculateOverallStats(data, yearlyStats) {
            let totalTavg = 0, tavgCount = 0;
            let maxTemp = -Infinity, minTemp = Infinity;
            let totalHotDays = 0, totalColdDays = 0;
            
            data.forEach(d => {
                if (d.tavg !== null) {
                    totalTavg += d.tavg;
                    tavgCount++;
                }
                if (d.tmax !== null) {
                    maxTemp = Math.max(maxTemp, d.tmax);
                    if (d.tmax >= 30) totalHotDays++;
                }
                if (d.tmin !== null) {
                    minTemp = Math.min(minTemp, d.tmin);
                    if (d.tmin <= -10) totalColdDays++;
                }
            });
            
            // Calculate warming trend using linear regression on yearly means
            const validYears = yearlyStats.filter(y => y.mean !== null);
            let trend = 0;
            
            if (validYears.length >= 2) {
                const n = validYears.length;
                let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
                
                validYears.forEach(y => {
                    sumX += y.year;
                    sumY += y.mean;
                    sumXY += y.year * y.mean;
                    sumX2 += y.year * y.year;
                });
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                trend = slope * 10; // Convert to per decade
            }
            
            return {
                mean: tavgCount > 0 ? totalTavg / tavgCount : 0,
                maxTemp: maxTemp === -Infinity ? 0 : maxTemp,
                minTemp: minTemp === Infinity ? 0 : minTemp,
                totalHotDays,
                totalColdDays,
                trend
            };
        }
        
        function updateYearlyMeanChart(yearlyStats) {
            const validData = yearlyStats.filter(y => y.mean !== null);
            const years = validData.map(y => y.year);
            const means = validData.map(y => y.mean);
            
            // Calculate trend line using linear regression
            const n = validData.length;
            if (n < 2) return;
            
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            validData.forEach(y => {
                sumX += y.year;
                sumY += y.mean;
                sumXY += y.year * y.mean;
                sumX2 += y.year * y.year;
            });
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const trendLine = years.map(year => slope * year + intercept);
            
            charts.yearlyMean.data.labels = years;
            charts.yearlyMean.data.datasets[0].data = means;
            charts.yearlyMean.data.datasets[1].data = trendLine;
            charts.yearlyMean.update();
        }
        
        function updateYearlyExtremesChart(yearlyStats) {
            const years = yearlyStats.map(y => y.year);
            const maxTemps = yearlyStats.map(y => y.max);
            const minTemps = yearlyStats.map(y => y.min);
            
            charts.yearlyExtremes.data.labels = years;
            charts.yearlyExtremes.data.datasets[0].data = maxTemps;
            charts.yearlyExtremes.data.datasets[1].data = minTemps;
            charts.yearlyExtremes.update();
        }
        
        function updateMonthlyMeanChart(monthlyStats) {
            charts.monthlyMean.data.datasets[0].data = monthlyStats;
            charts.monthlyMean.update();
        }
        
        function updateHotColdChart(yearlyStats) {
            const years = yearlyStats.map(y => y.year);
            const hotDays = yearlyStats.map(y => y.hotDays);
            const coldDays = yearlyStats.map(y => y.coldDays);
            
            charts.hotCold.data.labels = years;
            charts.hotCold.data.datasets[0].data = hotDays;
            charts.hotCold.data.datasets[1].data = coldDays;
            charts.hotCold.update();
        }
        
        function updateDecadalChart(decadalStats) {
            const labels = decadalStats.map(d => d.decade);
            const means = decadalStats.map(d => d.mean);
            
            // Color gradient from cool to warm
            const minMean = Math.min(...means.filter(m => m !== null));
            const maxMean = Math.max(...means.filter(m => m !== null));
            const range = maxMean - minMean || 1;
            
            const colors = means.map(m => {
                if (m === null) return 'rgba(128, 128, 128, 0.7)';
                const ratio = (m - minMean) / range;
                const r = Math.round(100 + ratio * 155);
                const g = Math.round(181 - ratio * 100);
                const b = Math.round(246 - ratio * 164);
                return `rgba(${r}, ${g}, ${b}, 0.7)`;
            });
            
            const borderColors = means.map(m => {
                if (m === null) return '#808080';
                const ratio = (m - minMean) / range;
                const r = Math.round(100 + ratio * 155);
                const g = Math.round(181 - ratio * 100);
                const b = Math.round(246 - ratio * 164);
                return `rgb(${r}, ${g}, ${b})`;
            });
            
            charts.decadal.data.labels = labels;
            charts.decadal.data.datasets[0].data = means;
            charts.decadal.data.datasets[0].backgroundColor = colors;
            charts.decadal.data.datasets[0].borderColor = borderColors;
            charts.decadal.update();
        }
        
        // Start the application
        init();
    </script>
</body>
</html>