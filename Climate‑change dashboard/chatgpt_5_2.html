<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sofia Climate Dashboard (1952–2021) — Single File</title>
  <style>
    :root{
      --bg:#0c0f14;
      --panel:#121826;
      --panel2:#0f1522;
      --line:#263149;
      --text:#e9eefc;
      --muted:#aebad6;
      --accent:#67b3ff;
      --good:#35d39f;
      --bad:#ff6b87;
      --warn:#ffd166;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --shadow: rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:var(--sans); }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(18,24,38,.96), rgba(12,15,20,.90));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      box-shadow: 0 10px 30px var(--shadow);
    }
    .top{
      display:flex; gap:12px; align-items:center;
      padding: 12px 14px;
      max-width: 1200px; margin:0 auto;
    }
    .brand{
      font-weight:800; letter-spacing:.2px;
      display:flex; align-items:baseline; gap:10px;
    }
    .brand small{ font-weight:600; color:var(--muted); }
    .spacer{ flex:1; }
    .pill{
      font-size:12px; color:var(--muted);
      padding: 5px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      white-space: nowrap;
    }

    main{
      max-width:1200px;
      margin: 14px auto 24px;
      padding: 0 14px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(18,24,38,.92), rgba(15,21,34,.92));
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding: 10px 12px;
      font-size: 12px;
      letter-spacing: .9px;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    .card .body{ padding: 12px; }

    .gridStats{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    @media (max-width: 520px){
      .gridStats{ grid-template-columns: 1fr; }
    }
    .stat{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      padding: 10px 10px;
      min-height: 64px;
    }
    .stat .k{ font-size: 12px; color: var(--muted); }
    .stat .v{
      margin-top: 4px;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .stat .s{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    @media (max-width: 520px){
      .controls{ grid-template-columns: 1fr; }
    }
    label{ font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    select, button, input[type="file"]{
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 10px 10px;
      outline: none;
    }
    select:focus, button:focus{
      border-color: rgba(103,179,255,.65);
      box-shadow: 0 0 0 3px rgba(103,179,255,.14);
    }
    button{
      cursor:pointer;
      font-weight: 700;
      background: rgba(103,179,255,.10);
    }
    button:hover{ background: rgba(103,179,255,.16); }

    .note{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      border-top: 1px solid var(--line);
      margin-top: 10px;
      padding-top: 10px;
    }
    .banner{
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.20);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .banner strong{ color: var(--text); }
    .ok{ color: var(--good); }
    .warn{ color: var(--warn); }
    .bad{ color: var(--bad); }

    .chartBox{
      height: 320px;
    }
    .chartBox.tall{
      height: 360px;
    }
    canvas{ width:100% !important; height:100% !important; }

    .rowBtns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    code{ font-family: var(--mono); font-size: 11px; }
  </style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand">Sofia Climate Dashboard <small>CSV → aggregates → charts</small></div>
    <div class="pill" id="filePill">File: —</div>
    <div class="pill" id="rangePill">Range: —</div>
    <div class="spacer"></div>
    <div class="pill" id="rowsPill">Rows: —</div>
  </div>
</header>

<main>
  <!-- LEFT: charts -->
  <section class="card">
    <h2>Charts</h2>
    <div class="body">
      <div class="chartBox tall"><canvas id="chartAnnual"></canvas></div>
      <div style="height:12px"></div>
      <div class="chartBox"><canvas id="chartMonthly"></canvas></div>
      <div style="height:12px"></div>
      <div class="chartBox"><canvas id="chartHotCold"></canvas></div>
      <div class="note">
        Interactivity: hover tooltips, click legend items to hide/show series, drag to scroll on touch devices.
      </div>
    </div>
  </section>

  <!-- RIGHT: controls + stats -->
  <aside class="card">
    <h2>Controls & Summary</h2>
    <div class="body">
      <div class="controls">
        <div>
          <label for="startYear">Start year</label>
          <select id="startYear"></select>
        </div>
        <div>
          <label for="endYear">End year</label>
          <select id="endYear"></select>
        </div>
      </div>

      <div class="rowBtns">
        <button id="setFull">Use full range</button>
        <button id="setLast30">Last 30 years</button>
      </div>

      <div class="banner" id="banner">
        <div><strong>Status:</strong> <span id="statusText">Loading…</span></div>
        <div id="statusDetails" style="margin-top:6px;"></div>
      </div>

      <div style="height:10px"></div>

      <div class="gridStats">
        <div class="stat">
          <div class="k">Overall mean (TAVG)</div>
          <div class="v" id="statMean">—</div>
          <div class="s" id="statMeanSub">—</div>
        </div>
        <div class="stat">
          <div class="k">Warming trend (annual mean)</div>
          <div class="v" id="statTrend">—</div>
          <div class="s" id="statTrendSub">—</div>
        </div>
        <div class="stat">
          <div class="k">Very hot days</div>
          <div class="v" id="statHot">—</div>
          <div class="s">Count of days with <code>TMAX ≥ 30°C</code> in range</div>
        </div>
        <div class="stat">
          <div class="k">Very cold days</div>
          <div class="v" id="statCold">—</div>
          <div class="s">Count of days with <code>TMIN ≤ −10°C</code> in range</div>
        </div>
        <div class="stat">
          <div class="k">Warmest day (TMAX)</div>
          <div class="v" id="statWarmest">—</div>
          <div class="s" id="statWarmestSub">—</div>
        </div>
        <div class="stat">
          <div class="k">Coldest day (TMIN)</div>
          <div class="v" id="statColdest">—</div>
          <div class="s" id="statColdestSub">—</div>
        </div>
      </div>

      <div class="note">
        This dashboard loads <code>DATE, TAVG, TMAX, TMIN</code> from the CSV, converts values from tenths of °C to °C, and recomputes all aggregates when you change the year range.
        <br><br>
        <span class="warn">If you open this HTML via <code>file://</code>, some browsers block <code>fetch()</code> to local files.</span>
        Easiest fix: run a tiny local server in this folder (examples):
        <br>
        <code>python -m http.server</code> (then open <code>http://localhost:8000</code>)
        <br>
        <code>npx serve</code>
      </div>
    </div>
  </aside>
</main>

<!-- Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
(() => {
  // ===== CONFIG =====
  const CSV_FILE = "temperature_Sofia_2809794_1952-01-01 - 2021-11-28.csv";
  const HOT_THRESHOLD = 30;    // °C (TMAX)
  const COLD_THRESHOLD = -10;  // °C (TMIN)

  // ===== DOM =====
  const el = (id) => document.getElementById(id);
  const filePill = el("filePill");
  const rangePill = el("rangePill");
  const rowsPill = el("rowsPill");

  const startYearSel = el("startYear");
  const endYearSel = el("endYear");
  const setFullBtn = el("setFull");
  const setLast30Btn = el("setLast30");

  const banner = el("banner");
  const statusText = el("statusText");
  const statusDetails = el("statusDetails");

  const statMean = el("statMean");
  const statMeanSub = el("statMeanSub");
  const statTrend = el("statTrend");
  const statTrendSub = el("statTrendSub");
  const statHot = el("statHot");
  const statCold = el("statCold");
  const statWarmest = el("statWarmest");
  const statWarmestSub = el("statWarmestSub");
  const statColdest = el("statColdest");
  const statColdestSub = el("statColdestSub");

  // ===== STATE =====
  const State = {
    records: [],  // {dateStr, year, month, tavg, tmax, tmin} values in °C or null
    years: [],
    minYear: null,
    maxYear: null,
    charts: {
      annual: null,
      monthly: null,
      hotcold: null,
    }
  };

  // ===== UTIL =====
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const fmt1 = (x) => (Number.isFinite(x) ? (Math.round(x*10)/10).toFixed(1) : "—");
  const fmt2 = (x) => (Number.isFinite(x) ? (Math.round(x*100)/100).toFixed(2) : "—");

  function setStatus(kind, title, detailsHtml = "") {
    statusText.textContent = title;
    statusDetails.innerHTML = detailsHtml;
    banner.style.borderColor =
      kind === "ok" ? "rgba(53,211,159,.45)" :
      kind === "warn" ? "rgba(255,209,102,.45)" :
      kind === "bad" ? "rgba(255,107,135,.45)" :
      "rgba(255,255,255,.20)";
    banner.style.background =
      kind === "ok" ? "rgba(53,211,159,.06)" :
      kind === "warn" ? "rgba(255,209,102,.06)" :
      kind === "bad" ? "rgba(255,107,135,.06)" :
      "rgba(255,255,255,.03)";
  }

  function parseCSV(text) {
    // Handles simple comma-separated values (no embedded commas expected in this dataset).
    const lines = text.replace(/\r/g, "").split("\n").filter(l => l.trim().length);
    if (lines.length < 2) throw new Error("CSV has no data rows.");
    const header = lines[0].split(",").map(s => s.trim());
    const idx = {
      DATE: header.indexOf("DATE"),
      TAVG: header.indexOf("TAVG"),
      TMAX: header.indexOf("TMAX"),
      TMIN: header.indexOf("TMIN"),
    };
    for (const k of Object.keys(idx)) {
      if (idx[k] < 0) throw new Error(`Missing required column: ${k}`);
    }

    const out = [];
    for (let i=1; i<lines.length; i++){
      const parts = lines[i].split(",");
      const dateStr = (parts[idx.DATE] || "").trim();
      if (!dateStr) continue;

      // DATE is expected as YYYY-MM-DD
      const year = parseInt(dateStr.slice(0,4), 10);
      const month = parseInt(dateStr.slice(5,7), 10); // 1..12

      // Values are in tenths of degrees C. Convert to °C.
      const toC = (s) => {
        const t = (s ?? "").trim();
        if (!t) return null;
        const n = Number(t);
        if (!Number.isFinite(n)) return null;
        return n / 10;
      };

      out.push({
        dateStr,
        year,
        month,
        tavg: toC(parts[idx.TAVG]),
        tmax: toC(parts[idx.TMAX]),
        tmin: toC(parts[idx.TMIN]),
      });
    }
    return out;
  }

  function uniqueSortedYears(records){
    const s = new Set(records.map(r => r.year).filter(Number.isFinite));
    return [...s].sort((a,b)=>a-b);
  }

  function computeAggregates(records, startYear, endYear){
    const inRange = records.filter(r => r.year >= startYear && r.year <= endYear);

    // Yearly aggregates
    const yMap = new Map(); // year -> {sum, count, maxTmax, minTmin, hot, cold}
    const mMap = new Map(); // month 1..12 -> {sum, count}

    let totalSum = 0, totalCount = 0;
    let hotTotal = 0, coldTotal = 0;

    let warmest = { tmax: -Infinity, dateStr: null };
    let coldest = { tmin: +Infinity, dateStr: null };

    for (const r of inRange){
      // Year init
      if (!yMap.has(r.year)){
        yMap.set(r.year, { sum:0, count:0, maxTmax:-Infinity, minTmin:+Infinity, hot:0, cold:0 });
      }
      const y = yMap.get(r.year);

      // Monthly init
      if (!mMap.has(r.month)){
        mMap.set(r.month, { sum:0, count:0 });
      }
      const m = mMap.get(r.month);

      // Mean (TAVG)
      if (Number.isFinite(r.tavg)){
        y.sum += r.tavg; y.count += 1;
        m.sum += r.tavg; m.count += 1;
        totalSum += r.tavg; totalCount += 1;
      }

      // Extremes
      if (Number.isFinite(r.tmax)){
        if (r.tmax > y.maxTmax) y.maxTmax = r.tmax;
        if (r.tmax > warmest.tmax) warmest = { tmax: r.tmax, dateStr: r.dateStr };
        if (r.tmax >= HOT_THRESHOLD){ y.hot += 1; hotTotal += 1; }
      }
      if (Number.isFinite(r.tmin)){
        if (r.tmin < y.minTmin) y.minTmin = r.tmin;
        if (r.tmin < coldest.tmin) coldest = { tmin: r.tmin, dateStr: r.dateStr };
        if (r.tmin <= COLD_THRESHOLD){ y.cold += 1; coldTotal += 1; }
      }
    }

    const years = [...yMap.keys()].sort((a,b)=>a-b);

    const annual = years.map(year => {
      const y = yMap.get(year);
      const mean = y.count ? y.sum / y.count : null;
      const maxTmax = Number.isFinite(y.maxTmax) ? y.maxTmax : null;
      const minTmin = Number.isFinite(y.minTmin) ? y.minTmin : null;
      return { year, mean, maxTmax, minTmin, hot: y.hot, cold: y.cold, countMean: y.count };
    });

    const monthly = Array.from({length:12}, (_,i)=> {
      const month = i+1;
      const m = mMap.get(month);
      const mean = (m && m.count) ? (m.sum / m.count) : null;
      return { month, mean, countMean: (m?.count ?? 0) };
    });

    const overallMean = totalCount ? (totalSum / totalCount) : null;

    // Linear regression for warming trend using annual mean (only years with mean)
    const xs = [];
    const ys = [];
    for (const a of annual){
      if (Number.isFinite(a.mean)){
        xs.push(a.year);
        ys.push(a.mean);
      }
    }
    const trend = linearRegression(xs, ys); // slope °C/year

    return {
      inRangeCount: inRange.length,
      annual,
      monthly,
      overallMean,
      hotTotal,
      coldTotal,
      warmest: (warmest.dateStr ? warmest : null),
      coldest: (coldest.dateStr ? coldest : null),
      trend,
    };
  }

  function linearRegression(xs, ys){
    const n = Math.min(xs.length, ys.length);
    if (n < 2) return { slope:null, intercept:null, r2:null };

    let sumX=0,sumY=0,sumXX=0,sumXY=0;
    for (let i=0;i<n;i++){
      const x=xs[i], y=ys[i];
      sumX += x; sumY += y;
      sumXX += x*x; sumXY += x*y;
    }
    const meanX = sumX/n, meanY = sumY/n;
    const denom = (sumXX - n*meanX*meanX);
    if (Math.abs(denom) < 1e-12) return { slope:null, intercept:null, r2:null };

    const slope = (sumXY - n*meanX*meanY) / denom;
    const intercept = meanY - slope*meanX;

    // R^2
    let ssTot=0, ssRes=0;
    for (let i=0;i<n;i++){
      const yHat = slope*xs[i] + intercept;
      ssTot += (ys[i]-meanY)**2;
      ssRes += (ys[i]-yHat)**2;
    }
    const r2 = ssTot > 0 ? (1 - ssRes/ssTot) : null;

    return { slope, intercept, r2 };
  }

  function monthName(m){
    const names = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return names[m-1] ?? String(m);
  }

  // ===== CHARTS =====
  function makeCharts(){
    const annualCtx = document.getElementById("chartAnnual");
    const monthlyCtx = document.getElementById("chartMonthly");
    const hotcoldCtx = document.getElementById("chartHotCold");

    const common = {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color: "#e9eefc" } },
        tooltip: { enabled: true }
      },
      scales: {
        x: { ticks: { color: "#aebad6" }, grid: { color: "rgba(255,255,255,.06)" } },
        y: { ticks: { color: "#aebad6" }, grid: { color: "rgba(255,255,255,.06)" } }
      }
    };

    State.charts.annual = new Chart(annualCtx, {
      type: "line",
      data: { labels: [], datasets: [
        { label:"Annual mean (TAVG)", data: [], tension: 0.25, pointRadius: 0 },
        { label:"Yearly max (TMAX)", data: [], tension: 0.25, pointRadius: 0, borderDash:[6,4] },
        { label:"Yearly min (TMIN)", data: [], tension: 0.25, pointRadius: 0, borderDash:[2,3] },
      ]},
      options: {
        ...common,
        plugins: {
          ...common.plugins,
          title: { display: true, text: "Annual temperature summary (°C)", color: "#e9eefc", font:{ weight:"700" } }
        },
        scales: {
          x: { ...common.scales.x, title: { display:true, text:"Year", color:"#aebad6" } },
          y: { ...common.scales.y, title: { display:true, text:"°C", color:"#aebad6" } }
        }
      }
    });

    State.charts.monthly = new Chart(monthlyCtx, {
      type: "line",
      data: { labels: [], datasets: [
        { label:"Monthly mean (TAVG)", data: [], tension: 0.25, pointRadius: 2 }
      ]},
      options: {
        ...common,
        plugins: {
          ...common.plugins,
          title: { display: true, text: "Monthly mean temperature (°C) over selected years", color: "#e9eefc", font:{ weight:"700" } }
        },
        scales: {
          x: { ...common.scales.x, title: { display:true, text:"Month", color:"#aebad6" } },
          y: { ...common.scales.y, title: { display:true, text:"°C", color:"#aebad6" } }
        }
      }
    });

    State.charts.hotcold = new Chart(hotcoldCtx, {
      type: "bar",
      data: { labels: [], datasets: [
        { label:`Hot days (TMAX ≥ ${HOT_THRESHOLD}°C)`, data: [] },
        { label:`Cold days (TMIN ≤ ${COLD_THRESHOLD}°C)`, data: [] },
      ]},
      options: {
        ...common,
        plugins: {
          ...common.plugins,
          title: { display: true, text: "Counts of extreme-temperature days by year", color: "#e9eefc", font:{ weight:"700" } }
        },
        scales: {
          x: { ...common.scales.x, title: { display:true, text:"Year", color:"#aebad6" } },
          y: { ...common.scales.y, title: { display:true, text:"Days", color:"#aebad6" }, beginAtZero:true }
        }
      }
    });
  }

  function updateAll(){
    const startYear = Number(startYearSel.value);
    const endYear = Number(endYearSel.value);

    // ensure start <= end
    if (startYear > endYear){
      // swap (keep UX simple)
      startYearSel.value = String(endYear);
      endYearSel.value = String(startYear);
      return updateAll();
    }

    rangePill.textContent = `Range: ${startYear}–${endYear}`;

    const A = computeAggregates(State.records, startYear, endYear);
    rowsPill.textContent = `Rows: ${A.inRangeCount.toLocaleString()}`;

    // ---- Stats
    statMean.textContent = Number.isFinite(A.overallMean) ? `${fmt1(A.overallMean)}°C` : "—";
    statMeanSub.textContent =
      `Based on ${A.annual.reduce((s,a)=>s+a.countMean,0).toLocaleString()} daily TAVG values`;

    if (Number.isFinite(A.trend.slope)){
      const perDecade = A.trend.slope * 10;
      statTrend.textContent = `${fmt2(perDecade)}°C/decade`;
      const r2 = Number.isFinite(A.trend.r2) ? fmt2(A.trend.r2) : "—";
      // Also show change from first to last year means (if available)
      const means = A.annual.filter(x => Number.isFinite(x.mean));
      let delta = null;
      if (means.length >= 2){
        delta = means[means.length-1].mean - means[0].mean;
      }
      statTrendSub.textContent =
        `Linear fit on annual mean · R² ${r2}` + (Number.isFinite(delta) ? ` · Δ≈${fmt1(delta)}°C (first→last)` : "");
    } else {
      statTrend.textContent = "—";
      statTrendSub.textContent = "Need at least 2 years with annual mean values";
    }

    statHot.textContent = A.hotTotal.toLocaleString();
    statCold.textContent = A.coldTotal.toLocaleString();

    if (A.warmest){
      statWarmest.textContent = `${fmt1(A.warmest.tmax)}°C`;
      statWarmestSub.textContent = `Date: ${A.warmest.dateStr}`;
    } else {
      statWarmest.textContent = "—";
      statWarmestSub.textContent = "No TMAX data in range";
    }

    if (A.coldest){
      statColdest.textContent = `${fmt1(A.coldest.tmin)}°C`;
      statColdestSub.textContent = `Date: ${A.coldest.dateStr}`;
    } else {
      statColdest.textContent = "—";
      statColdestSub.textContent = "No TMIN data in range";
    }

    // ---- Charts
    const annualLabels = A.annual.map(d => d.year);
    const annualMean = A.annual.map(d => Number.isFinite(d.mean) ? d.mean : null);
    const annualMax = A.annual.map(d => Number.isFinite(d.maxTmax) ? d.maxTmax : null);
    const annualMin = A.annual.map(d => Number.isFinite(d.minTmin) ? d.minTmin : null);

    State.charts.annual.data.labels = annualLabels;
    State.charts.annual.data.datasets[0].data = annualMean;
    State.charts.annual.data.datasets[1].data = annualMax;
    State.charts.annual.data.datasets[2].data = annualMin;
    State.charts.annual.update();

    const monthlyLabels = A.monthly.map(d => monthName(d.month));
    const monthlyMean = A.monthly.map(d => Number.isFinite(d.mean) ? d.mean : null);

    State.charts.monthly.data.labels = monthlyLabels;
    State.charts.monthly.data.datasets[0].data = monthlyMean;
    State.charts.monthly.update();

    const hot = A.annual.map(d => d.hot);
    const cold = A.annual.map(d => d.cold);

    State.charts.hotcold.data.labels = annualLabels;
    State.charts.hotcold.data.datasets[0].data = hot;
    State.charts.hotcold.data.datasets[1].data = cold;
    State.charts.hotcold.update();

    // status
    setStatus("ok", "Loaded and ready ✅", `
      Using years <strong>${startYear}–${endYear}</strong>. Hover charts for details; click legend items to toggle series.
    `);
  }

  // ===== UI Setup =====
  function populateYearSelects(years){
    startYearSel.innerHTML = "";
    endYearSel.innerHTML = "";
    for (const y of years){
      const o1 = document.createElement("option");
      o1.value = String(y); o1.textContent = String(y);
      startYearSel.appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = String(y); o2.textContent = String(y);
      endYearSel.appendChild(o2);
    }
  }

  function setRange(startY, endY){
    startYearSel.value = String(startY);
    endYearSel.value = String(endY);
    updateAll();
  }

  // ===== LOAD =====
  async function loadCSVFromSameFolder(){
    filePill.textContent = `File: ${CSV_FILE}`;
    setStatus("warn", "Loading CSV…", `
      Trying <code>fetch("${CSV_FILE}")</code> from the same folder as this HTML file.
    `);

    // Use encodeURI because the filename contains spaces
    const url = encodeURI(CSV_FILE);

    const res = await fetch(url);
    if (!res.ok){
      throw new Error(`Fetch failed: HTTP ${res.status}`);
    }
    return await res.text();
  }

  async function init(){
    makeCharts();

    try{
      const text = await loadCSVFromSameFolder();
      const records = parseCSV(text);

      State.records = records;
      State.years = uniqueSortedYears(records);
      State.minYear = State.years[0];
      State.maxYear = State.years[State.years.length - 1];

      filePill.textContent = `File: ${CSV_FILE}`;
      rowsPill.textContent = `Rows: ${records.length.toLocaleString()}`;

      populateYearSelects(State.years);

      // default: full range
      setRange(State.minYear, State.maxYear);

      startYearSel.addEventListener("change", updateAll);
      endYearSel.addEventListener("change", updateAll);

      setFullBtn.addEventListener("click", () => setRange(State.minYear, State.maxYear));
      setLast30Btn.addEventListener("click", () => {
        const endY = State.maxYear;
        const startY = Math.max(State.minYear, endY - 29);
        setRange(startY, endY);
      });

    } catch (err){
      console.error(err);
      setStatus("bad", "Could not load CSV ❌", `
        <div class="bad">Error: <code>${String(err.message || err)}</code></div>
        <div style="margin-top:6px;">
          Most common cause: opening via <code>file://</code> blocks <code>fetch()</code>.
          Run a local server in this folder, then refresh.
        </div>
      `);
      rangePill.textContent = "Range: —";
      rowsPill.textContent = "Rows: —";
    }
  }

  init();
})();
</script>
</body>
</html>
