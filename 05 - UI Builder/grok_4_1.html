<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ProBuilder – Advanced Drag-and-Drop UI & Flowchart Builder (Single File)</title>
    <style>
        body { margin:0; height:100vh; background:#1e1e1e; color:#fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow:hidden; }
        #app { display:flex; height:100vh; }
        #library { width:240px; background:#2d2d2d; padding:20px; overflow-y:auto; border-right:1px solid #444; }
        .category { margin:20px 0 8px; color:#888; font-size:14px; text-transform:uppercase; letter-spacing:1px; }
        .item { padding:14px; margin:6px 0; background:#3a3a3a; border-radius:8px; cursor:grab; text-align:center; user-select:none; transition:0.2s; }
        .item:hover { background:#4a4a4a; }
        .item button, .item input, .item select, .item progress { pointer-events:none; }
        #toolbar { position:sticky; top:0; left:240px; right:280px; height:60px; background:#2d2d2d; display:flex; align-items:center; padding:0 30px; gap:20px; border-bottom:1px solid #444; z-index:100; }
        #canvas-wrapper { flex:1; position:relative; overflow:auto; }
        #canvas { position:relative; width:1200px; height:900px; background:#ffffff; background-image: linear-gradient(to right, #f0f0f0 1px, transparent 1px), linear-gradient(to bottom, #f0f0f0 1px, transparent 1px); background-size:20px 20px; resize:both; overflow:hidden; box-shadow:0 0 30px rgba(0,0,0,0.5); }
        #properties { width:280px; background:#2d2d2d; padding:20px; overflow-y:auto; border-left:1px solid #444; }
        .prop-group { margin-bottom:25px; }
        .prop-group label { display:block; margin-bottom:8px; font-size:14px; }
        .prop-group input, .prop-group select { width:100%; padding:8px; background:#444; border:none; border-radius:4px; color:#fff; }
        .element { position:absolute; user-select:none; }
        .selected { outline: 3px dashed #00ddff; }
        .handle { position:absolute; width:12px; height:12px; background:#00ddff; border:2px solid #fff; box-shadow:0 0 8px #000; z-index:1000; }
        #v-guide, #h-guide { position:fixed; background:rgba(0,221,255,0.4); pointer-events:none; display:none; z-index:9999; }
        #v-guide { width:1px; height:100vh; }
        #h-guide { height:1px; width:100vw; }
        #connections { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }
    </style>
</head>
<body>

<div id="app">
    <div id="library">
        <div class="category">UI Components</div>
        <div class="item" draggable="true" data-type="text">Text Block</div>
        <div class="item" draggable="true" data-type="button"><button style="width:100%;padding:10px;">Button</button></div>
        <div class="item" draggable="true" data-type="input"><input type="text" placeholder="Text Input" style="width:100%;padding:10px;"></div>
        <div class="item" draggable="true" data-type="checkbox"><label style="display:flex;align-items:center;gap:8px;"><input type="checkbox"> Checkbox</label></div>
        <div class="item" draggable="true" data-type="dropdown"><select style="width:100%;padding:10px;"><option>Option 1</option><option>Option 2</option></select></div>
        <div class="item" draggable="true" data-type="slider"><input type="range" style="width:100%;"></div>
        <div class="item" draggable="true" data-type="stepper"><div style="display:flex;align-items:center;"><button>-</button><input type="number" value="0" style="width:70px;text-align:center;"><button>+</button></div></div>
        <div class="item" draggable="true" data-type="progress"><progress value="65" max="100" style="width:100%;height:20px;"></progress></div>

        <div class="category">Shapes</div>
        <div class="item" draggable="true" data-type="rect"><div style="width:120px;height:70px;background:#3498db;border-radius:8px;"></div></div>
        <div class="item" draggable="true" data-type="circle"><div style="width:90px;height:90px;background:#e74c3c;border-radius:50%;"></div></div>
        <div class="item" draggable="true" data-type="triangle"><div style="width:0;height:0;border-left:45px solid transparent;border-right:45px solid transparent;border-bottom:90px solid #f1c40f;"></div></div>
        <div class="item" draggable="true" data-type="line"><div style="width:180px;height:5px;background:#2c3e50;"></div></div>
    </div>

    <div id="toolbar">
        <button id="connectBtn" style="padding:10px 20px; background:#00ddff; color:#000; border:none; border-radius:6px; cursor:pointer;">Connect Mode (Quadratic)</button>
        <button id="exportBtn" style="padding:10px 20px; background:#ff4444; color:#fff; border:none; border-radius:6px; cursor:pointer;">Export as HTML</button>
        <div id="modeDisplay" style="margin-left:auto; color:#aaa;">Mode: Select</div>
    </div>

    <div id="canvas-wrapper">
        <div id="canvas">
            <svg id="connections">
                <defs>
                    <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="5" markerHeight="5" orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#333"/>
                    </marker>
                </defs>
            </svg>
        </div>
    </div>

    <div id="properties">
        <h3 style="margin-top:0;">Properties</h3>
        <div class="prop-group">
            <label>X (px)<input id="prop-x" type="number"></label>
            <label>Y (px)<input id="prop-y" type="number"></label>
            <label>Width (px)<input id="prop-w" type="number"></label>
            <label>Height (px)<input id="prop-h" type="number"></label>
        </div>
        <div class="prop-group">
            <label>Border Radius<input id="prop-radius" type="number" min="0" value="0"></label>
            <label>Box Shadow<input id="prop-shadow" type="text" placeholder="e.g. 0 10px 20px rgba(0,0,0,0.2)"></label>
            <label>Background<input id="prop-bg" type="color" value="#ffffff"></label>
            <label>Rotation (°)<input id="prop-rot" type="number" min="0" max="360" value="0"></label>
        </div>
        <div class="prop-group">
            <label>Text / Placeholder<input id="prop-text" type="text"></label>
            <button id="deleteBtn" style="margin-top:15px; padding:8px; background:#ff4444; border:none; border-radius:4px; cursor:pointer;">Delete Element</button>
        </div>
    </div>
</div>

<div id="v-guide"></div>
<div id="h-guide"></div>

<script>
const canvas = document.getElementById('canvas');
const connectionsSvg = document.getElementById('connections');
const vGuide = document.getElementById('v-guide');
const hGuide = document.getElementById('h-guide');
const propertiesPanel = document.getElementById('properties');

let selected = null;
let dragging = null;
let connecting = null;
let dragData = null;
const GRID = 10;
const SNAP_THRESHOLD = 20;
let connections = [];

const resizeObserver = new ResizeObserver(updateAllConnections);
resizeObserver.observe(canvas);
canvas.addEventListener('scroll', updateAllConnections);

function getCenter(el) {
    return {
        x: el.offsetLeft + el.offsetWidth / 2,
        y: el.offsetTop + el.offsetHeight / 2
    };
}

function updateAllConnections() {
    connections.forEach(conn => {
        if (!conn.source || !conn.target) return;
        const s = getCenter(conn.source);
        const t = getCenter(conn.target);
        let d;
        if (conn.control) {
            const c = getCenter(conn.control);
            d = `M${s.x},${s.y} Q${c.x},${c.y} ${t.x},${t.y}`;
        } else {
            d = `M${s.x},${s.y} L${t.x},${t.y}`;
        }
        conn.line.setAttribute('d', d);
    });
}

function showHandles(el) {
    document.querySelectorAll('.handle').forEach(h => h.remove());
    if (!el) return;

    const dirs = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];
    dirs.forEach(d => {
        const h = document.createElement('div');
        h.classList.add('handle');
        h.dataset.dir = d;

        let left = 0, top = 0;
        if (d.includes('e')) left = el.offsetWidth - 6;
        else if (!d.includes('w')) left = el.offsetWidth / 2 - 6;

        if (d.includes('s')) top = el.offsetHeight - 6;
        else if (!d.includes('n')) top = el.offsetHeight / 2 - 6;

        if (d.includes('w')) left = -6;

        if (d.includes('n')) top = -6;

        h.style.left = left + 'px';

        h.style.top = top + 'px';

        h.style.cursor = d.length === 1 ? (d === 'n' || d === 's' ? 'ns-resize' : 'ew-resize') : 'nwse-resize';

        canvas.appendChild(h);

        h.onmousedown = e => startDrag(e, true, d);
    });
}

function fillProperties(el) {
    document.getElementById('prop-x').value = el.offsetLeft;
    document.getElementById('prop-y').value = el.offsetTop;
    document.getElementById('prop-w').value = el.offsetWidth;
    document.getElementById('prop-h').value = el.offsetHeight;
    document.getElementById('prop-radius').value = parseInt(el.style.borderRadius || '0');

    document.getElementById('prop-shadow').value = el.style.boxShadow || '';

    const bg = window.getComputedStyle(el).backgroundColor;
    document.getElementById('prop-bg').value = bg.includes('rgb') ? rgbToHex(bg) : bg;

    const transform = window.getComputedStyle(el).transform;
    let rot = 0;
    if (transform && transform !== 'none') {

        const values = transform.split('(')[1].split(')')[0].split(',');

        rot = Math.round(Math.atan2(values[1], values[0]) * (180/Math.PI));

    }
    document.getElementById('prop-rot').value = rot;

    if (el.tagName === 'BUTTON' || el.tagName === 'DIV' && !el.classList.contains('control-point')) {

        document.getElementById('prop-text').value = el.innerText;

    } else if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {

        document.getElementById('prop-text').value = el.placeholder || '';

    } else {

        document.getElementById('prop-text').value = '';

    }
}

function rgbToHex(rgb) {
    const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
    if (!match) return '#ffffff';
    const hex = "#" +
        ("0" + parseInt(match[1], 10).toString(16)).slice(-2) +
        ("0" + parseInt(match[2], 10).toString(16)).slice(-2) +
        ("0" + parseInt(match[3], 10).toString(16)).slice(-2);
    return hex;
}

document.querySelectorAll('#properties input, #properties select').forEach(inp => {

    inp.oninput = () => {

        if (!selected) return;

        if (inp.id === 'prop-x') selected.style.left = inp.value + 'px';

        if (inp.id === 'prop-y') selected.style.top = inp.value + 'px';

        if (inp.id === 'prop-w') selected.style.width = inp.value + 'px';

        if (inp.id === 'prop-h') selected.style.height = inp.value + 'px';

        if (inp.id === 'prop-radius') selected.style.borderRadius = inp.value + 'px';

        if (inp.id === 'prop-shadow') selected.style.boxShadow = inp.value;

        if (inp.id === 'prop-bg') selected.style.backgroundColor = inp.value;

        if (inp.id === 'prop-rot') {

            selected.style.transform = `rotate(${inp.value}deg)`;

            selected.style.transformOrigin = 'center center';

        }

        if (inp.id === 'prop-text') {

            if (selected.tagName === 'BUTTON || selected.tagName === 'DIV') selected.innerText = inp.value;

            else if (selected.tagName === 'INPUT' || selected.tagName === 'SELECT') selected.placeholder = inp.value;

        }

        showHandles(selected);

        updateAllConnections();

    };

});

document.getElementById('deleteBtn').onclick = () => {

    if (selected) {

        // remove from connections

        connections = connections.filter(c => c.source !== selected && c.target !== selected && c.control !== selected);

        selected.remove();

        deselect();

        updateAllConnections();

    }

};

function deselect() {

    if (selected) selected.classList.remove('selected');

    selected = null;

    document.querySelectorAll('.handle').forEach(h => h.remove());

    propertiesPanel.style.display = 'none';

}

function select(el) {

    if (selected) selected.classList.remove('selected');

    selected = el;

    el.classList.add('selected');

    showHandles(el);

    fillProperties(el);

    propertiesPanel.style.display = 'block';

}

document.getElementById('connectBtn').onclick = () => {

    connectMode = !connectMode;

    document.getElementById('modeDisplay').innerText = connectMode ? 'Mode: Connect (Quadratic Curve)' : 'Mode: Select';

};

canvas.onclick = e => {

    if (connectMode) {

        const el = e.target.closest('.element');

        if (!el) {

            connecting = null;

            return;

        }

        if (!connecting) {

            connecting = el;

            el.style.outline = '3px dashed yellow';

        } else {

            if (connecting !== el) {

                // create quadratic with control point

                const control = document.createElement('div');

                control.classList.add('element', 'control-point');

                control.style.width = '16px';

                control.style.height = '16px';

                control.style.background = '#00ddff';

                control.style.borderRadius = '50%';

                control.style.transform = 'translate(-50%, -50%)';

                const s = getCenter(connecting);

                const t = getCenter(el);

                control.style.left = ((s.x + t.x) / 2) + 'px';

                control.style.top = ((s.y + t.y) / 2 + 100) + 'px'; // initial curve

                canvas.appendChild(control);

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

                path.setAttribute('stroke', '#333');

                path.setAttribute('stroke-width', '3');

                path.setAttribute('fill', 'none');

                path.setAttribute('marker-end', 'url(#arrow)');

                connectionsSvg.appendChild(path);

                connections.push({source: connecting, target: el, control, line: path});

                updateAllConnections();

                select(control); // select the control point for immediate adjustment

            }

            connecting.style.outline = '';

            connecting = null;

        }

        return;

    }

    const el = e.target.closest('.element');

    if (el) select(el);

    else deselect();

};

function startDrag(e, isResize = false, dir = null) {

    e.preventDefault();

    e.stopPropagation();

    const target = selected || e.target.closest('.element');

    if (!target) return;

    dragData = {

        target,

        startX: e.clientX,

        startY: e.clientY,

        startLeft: target.offsetLeft,

        startTop: target.offsetTop,

        startWidth: target.offsetWidth,

        startHeight: target.offsetHeight,

        isResize,

        dir

    };

}

canvas.onmousedown = e => {

    if (e.target.classList.contains('handle')) {

        startDrag(e, true, e.target.dataset.dir);

    } else if (!connectMode && e.target.closest('.element')) {

        select(e.target.closest('.element'));

        startDrag(e);

    }

};

document.onmousemove = e => {

    if (!dragData) return;

    let deltaX = e.clientX - dragData.startX;

    let deltaY = e.clientY - dragData.startY;

    let newLeft = dragData.startLeft + deltaX;

    let newTop = dragData.startTop + deltaY;

    let newWidth = dragData.startWidth;

    let newHeight = dragData.startHeight;

    if (dragData.isResize) {

        if (dragData.dir.includes('e')) newWidth += deltaX;

        if (dragData.dir.includes('s')) newHeight += deltaY;

        if (dragData.dir.includes('w')) {

            newWidth -= deltaX;

            newLeft += deltaX;

        }

        if (dragData.dir.includes('n')) {

            newHeight -= deltaY;

            newTop += deltaY;

        }

    }

    // alignment snap

    vGuide.style.display = 'none';

    hGuide.style.display = 'none';

    const currentRight = newLeft + newWidth;

    const currentBottom = newTop + newHeight;

    const others = Array.from(canvas.querySelectorAll('.element')).filter(el => el !== dragData.target);

    for (let other of others) {

        const o = {

            left: other.offsetLeft,

            top: other.offsetTop,

            right: other.offsetLeft + other.offsetWidth,

            bottom: other.offsetTop + other.offsetHeight

        };

        if (Math.abs(newLeft - o.left) < SNAP_THRESHOLD) {

            newLeft = o.left;

            vGuide.style.left = (o.left + canvas.getBoundingClientRect().left) + 'px';

            vGuide.style.display = 'block';

        } else if (Math.abs(currentRight - o.right) < SNAP_THRESHOLD) {

            newWidth = o.right - newLeft;

            vGuide.style.left = (o.right + canvas.getBoundingClientRect().left) + 'px';

            vGuide.style.display = 'block';

        }

        if (Math.abs(newTop - o.top) < SNAP_THRESHOLD) {

            newTop = o.top;

            hGuide.style.top = (o.top + canvas.getBoundingClientRect().top) + 'px';

            hGuide.style.display = 'block';

        } else if (Math.abs(currentBottom - o.bottom) < SNAP_THRESHOLD) {

            newHeight = o.bottom - newTop;

            hGuide.style.top = (o.bottom + canvas.getBoundingClientRect().top) + 'px';

            hGuide.style.display = 'block';

        }

    }

    if (!dragData.isResize) {

        dragData.target.style.left = newLeft + 'px';

        dragData.target.style.top = newTop + 'px';

    } else {

        dragData.target.style.left = newLeft + 'px';

        dragData.target.style.top = newTop + 'px';

        dragData.target.style.width = Math.max(20, newWidth) + 'px';

        dragData.target.style.height = Math.max(20, newHeight) + 'px';

    }

    showHandles(dragData.target);

    updateAllConnections();

};

document.onmouseup = e => {

    if (!dragData) return;

    // final snap to grid if no alignment

    if (vGuide.style.display === 'none') {

        let left = parseInt(dragData.target.style.left || 0);

        dragData.target.style.left = Math.round(left / GRID) * GRID + 'px';

    }

    if (hGuide.style.display === 'none') {

        let top = parseInt(dragData.target.style.top || 0);

        dragData.target.style.top = Math.round(top / GRID) * GRID + 'px';

    }

    vGuide.style.display = 'none';

    hGuide.style.display = 'none';

    showHandles(selected);

    updateAllConnections();

    dragData = null;

};

document.querySelectorAll('.item').forEach(item => {

    item.addEventListener('dragstart', e => {

        e.dataTransfer.setData('type', item.dataset.type);

    });

});

canvas.addEventListener('dragover', e => e.preventDefault());

canvas.addEventListener('drop', e => {

    e.preventDefault();

    const type = e.dataTransfer.getData('type');

    if (!type) return;

    const rect = canvas.getBoundingClientRect();

    let x = e.clientX - rect.left + canvas.scrollLeft;

    let y = e.clientY - rect.top + canvas.scrollTop;

    x = Math.round(x / GRID) * GRID;

    y = Math.round(y / GRID) * GRID;

    let el;

    switch(type) {

        case 'text':

            el = document.createElement('div');

            el.innerText = 'Double-click to edit';

            el.contentEditable = true;

            el.style.padding = '10px';

            el.style.background = 'rgba(255,255,255,0.9)';

            break;

        case 'button':

            el = document.createElement('button');

            el.innerText = 'Button';

            el.style.padding = '12px 24px';

            el.style.cursor = 'pointer';

            break;

        case 'input':

            el = document.createElement('input');

            el.type = 'text';

            el.placeholder = 'Enter text';

            el.style.padding = '10px';

            el.style.width = '200px';

            break;

        case 'checkbox':

            el = document.createElement('div');

            el.innerHTML = '<input type="checkbox"><span style="margin-left:8px;">Checkbox';

            break;

        case 'dropdown':

            el = document.createElement('select');

            el.innerHTML = '<option>Option 1</option><option>Option 2</option><option>Option 3</option>';

            el.style.padding = '10px';

            break;

        case 'slider':

            el = document.createElement('input');

            el.type = 'range';

            el.style.width = '200px';

            break;

        case 'stepper':

            el = document.createElement('div');

            el.style.display = 'flex';

            el.style.alignItems = 'center';

            el.innerHTML = '<button style="padding:8px;">–</button><input type="number" value="0" style="width:80px;padding:8px;text-align:center;"><button style="padding:8px;">+</button>';

            break;

        case 'progress':

            el = document.createElement('progress');

            el.value = 65;

            el.max = 100;

            el.style.width = '200px';

            el.style.height = '20px';

            break;

        case 'rect':

            el = document.createElement('div');

            el.style.width = '180px';

            el.style.height = '120px';

            el.style.backgroundColor = '#3498db';

            break;

        case 'circle':

            el = document.createElement('div');

            el.style.width = '120px';

            el.style.height = '120px';

            el.style.backgroundColor = '#e74c3c';

            el.style.borderRadius = '50%';

            break;

        case 'triangle':

            el = document.createElement('div');

            el.style.width = '0';

            el.style.height = '0';

            el.style.borderLeft = '60px solid transparent';

            el.style.borderRight = '60px solid transparent';

            el.style.borderBottom = '104px solid #f1c40f';

            break;

        case 'line':

            el = document.createElement('div');

            el.style.width = '200px';

            el.style.height = '6px';

            el.style.backgroundColor = '#2c3e50';

            break;

    }

    el.classList.add('element');

    el.style.position = 'absolute';

    el.style.left = x + 'px';

    el.style.top = y + 'px';

    canvas.appendChild(el);

    select(el);

});

document.getElementById('exportBtn').onclick = () => {

    let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exported Design</title>
    <style>
        body { margin:0; background:#f0d0d0d; display:flex; justify-content:center; align-items:center; min-height:100vh; }
        #wrapper { position:relative; width:${canvas.offsetWidth}px; height:${canvas.offsetHeight}px; background:white; box-shadow:0 0 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div id="wrapper">
`;

    canvas.querySelectorAll('.element').forEach(el => {

        html += el.outerHTML + '\n';

    });

    html += connectionsSvg.outerHTML + '\n';

    html += `
    </div>
    <script>
        // Make steppers work (in case they were added)
        document.querySelectorAll('.stepper input[type="number"]').forEach(input => {
            input.previousElementSibling.onclick = () => input.value = parseInt(input.value || 0) - 1;
            input.nextElementSibling.onclick = () => input.value = parseInt(input.value || 0) + 1;
        });
    </script>
</body>
</html>`;

    const blob = new Blob([html], {type: 'text/html;charset=utf-8'});

    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');

    a.href = url;

    a.download = 'design.html';

    a.click();

    URL.revokeObjectURL(url);

};
</script>
</body>
</html>