<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI Builder Pro - Visual Design Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }

        #app {
            display: flex;
            height: 100vh;
        }

        /* Left Panel - Components */
        #sidebar-left {
            width: 240px;
            background: #252525;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-header {
            padding: 16px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            border-bottom: 1px solid #333;
        }

        .component-section {
            padding: 12px;
        }

        .component-category {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .component-item {
            background: #2a2a2a;
            border: 1px solid #383838;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s;
            text-align: center;
            font-size: 13px;
        }

        .component-item:hover {
            background: #323232;
            border-color: #4a4a4a;
            transform: translateY(-1px);
        }

        .component-item:active {
            cursor: grabbing;
        }

        /* Center - Canvas */
        #canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        #toolbar {
            height: 48px;
            background: #252525;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
        }

        .toolbar-btn {
            background: #333;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #444;
        }

        .toolbar-btn.primary {
            background: #0066cc;
            border-color: #0066cc;
        }

        .toolbar-btn.primary:hover {
            background: #0055aa;
        }

        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: #444;
            margin: 0 4px;
        }

        .toggle-btn {
            background: transparent;
            border: 1px solid #444;
        }

        .toggle-btn.active {
            background: #0066cc;
            border-color: #0066cc;
        }

        #canvas-wrapper {
            flex: 1;
            position: relative;
            overflow: auto;
            background-image: 
                linear-gradient(#2a2a2a 1px, transparent 1px),
                linear-gradient(90deg, #2a2a2a 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: center center;
        }

        #canvas {
            width: 1200px;
            height: 800px;
            background: #ffffff;
            margin: 40px auto;
            position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        #canvas.snap-grid {
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 10px 10px;
        }

        #connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .connection-line {
            stroke: #0066cc;
            stroke-width: 2;
            fill: none;
            pointer-events: stroke;
            cursor: pointer;
        }

        .connection-line:hover {
            stroke: #ff4444;
            stroke-width: 3;
        }

        /* Elements on Canvas */
        .canvas-element {
            position: absolute;
            cursor: move;
            user-select: none;
            box-sizing: border-box;
        }

        .canvas-element.selected {
            outline: 2px solid #0066cc;
            outline-offset: 2px;
        }

        .canvas-element.connection-mode {
            cursor: crosshair;
        }

        /* Resize Handles */
        .resize-handle {
            width: 8px;
            height: 8px;
            background: #0066cc;
            position: absolute;
            border-radius: 50%;
            display: none;
            z-index: 100;
            border: 1px solid #fff;
        }

        .canvas-element.selected .resize-handle {
            display: block;
        }

        .handle-nw { top: -4px; left: -4px; cursor: nw-resize; }
        .handle-n { top: -4px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .handle-ne { top: -4px; right: -4px; cursor: ne-resize; }
        .handle-e { top: 50%; right: -4px; transform: translateY(-50%); cursor: e-resize; }
        .handle-se { bottom: -4px; right: -4px; cursor: se-resize; }
        .handle-s { bottom: -4px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .handle-sw { bottom: -4px; left: -4px; cursor: sw-resize; }
        .handle-w { top: 50%; left: -4px; transform: translateY(-50%); cursor: w-resize; }

        /* Connection Points */
        .connection-point {
            width: 12px;
            height: 12px;
            background: #0066cc;
            border: 2px solid #fff;
            border-radius: 50%;
            position: absolute;
            display: none;
            z-index: 99;
            cursor: crosshair;
        }

        .canvas-element.selected .connection-point,
        .canvas-element.connection-mode .connection-point {
            display: block;
        }

        .cp-top { top: -6px; left: 50%; transform: translateX(-50%); }
        .cp-right { top: 50%; right: -6px; transform: translateY(-50%); }
        .cp-bottom { bottom: -6px; left: 50%; transform: translateX(-50%); }
        .cp-left { top: 50%; left: -6px; transform: translateY(-50%); }

        /* Alignment Guides */
        .guide {
            position: absolute;
            background: #ff4444;
            z-index: 1000;
            display: none;
            pointer-events: none;
        }

        .guide-x {
            width: 1px;
            height: 100%;
            top: 0;
        }

        .guide-y {
            height: 1px;
            width: 100%;
            left: 0;
        }

        /* UI Components Styling */
        .ui-button {
            padding: 8px 16px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: default;
            min-width: 80px;
            text-align: center;
        }

        .ui-input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            min-width: 120px;
        }

        .ui-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #666;
            border-radius: 3px;
            background: white;
        }

        .ui-dropdown {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            min-width: 120px;
            font-size: 14px;
        }

        .ui-slider {
            width: 100px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            position: relative;
        }

        .ui-slider::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #0066cc;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .ui-stepper {
            display: flex;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            width: 100px;
        }

        .stepper-btn {
            width: 28px;
            height: 28px;
            background: #f5f5f5;
            border: none;
            cursor: default;
            font-size: 16px;
        }

        .stepper-value {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            background: white;
        }

        .ui-progress {
            width: 120px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            width: 60%;
            height: 100%;
            background: #0066cc;
        }

        .ui-text {
            font-size: 14px;
            color: #333;
            min-width: 60px;
            padding: 4px;
        }

        /* Shapes */
        .shape-rect {
            background: #e0e0e0;
            border: 2px solid #999;
        }

        .shape-circle {
            background: #e0e0e0;
            border: 2px solid #999;
            border-radius: 50%;
        }

        .shape-triangle {
            width: 0;
            height: 0;
            border-style: solid;
        }

        /* Right Panel - Properties */
        #sidebar-right {
            width: 280px;
            background: #252525;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .prop-group {
            padding: 16px;
            border-bottom: 1px solid #333;
        }

        .prop-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }

        .prop-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .prop-input {
            flex: 1;
            background: #333;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            width: 60px;
        }

        .prop-input.full {
            width: 100%;
        }

        .color-picker {
            width: 40px;
            height: 32px;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            background: none;
        }

        select.prop-input {
            width: 100%;
        }

        .prop-checkbox {
            width: 18px;
            height: 18px;
            margin-top: 2px;
        }

        /* Export Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal {
            background: #2a2a2a;
            padding: 24px;
            border-radius: 8px;
            width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-content {
            flex: 1;
            overflow: auto;
            background: #1a1a1a;
            padding: 16px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 16px;
            border: 1px solid #444;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Left Sidebar -->
        <div id="sidebar-left">
            <div class="panel-header">Components</div>
            
            <div class="component-section">
                <div class="component-category">UI Elements</div>
                <div class="component-item" draggable="true" data-type="button">Button</div>
                <div class="component-item" draggable="true" data-type="input">Input Field</div>
                <div class="component-item" draggable="true" data-type="text">Text</div>
                <div class="component-item" draggable="true" data-type="checkbox">Checkbox</div>
                <div class="component-item" draggable="true" data-type="dropdown">Dropdown</div>
                <div class="component-item" draggable="true" data-type="slider">Slider</div>
                <div class="component-item" draggable="true" data-type="stepper">Stepper</div>
                <div class="component-item" draggable="true" data-type="progress">Progress Bar</div>
            </div>

            <div class="component-section">
                <div class="component-category">Shapes</div>
                <div class="component-item" draggable="true" data-type="rectangle">Rectangle</div>
                <div class="component-item" draggable="true" data-type="circle">Circle</div>
                <div class="component-item" draggable="true" data-type="triangle">Triangle</div>
                <div class="component-item" draggable="true" data-type="line">Line</div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div id="canvas-container">
            <div id="toolbar">
                <button class="toolbar-btn primary" onclick="exportHTML()">Export HTML</button>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn" id="connectionBtn" onclick="toggleConnectionMode()">Connect Mode</button>
                <button class="toolbar-btn" onclick="clearCanvas()">Clear</button>
                <div style="flex: 1;"></div>
                <button class="toolbar-btn toggle-btn" id="gridBtn" onclick="toggleGrid()">Snap to Grid</button>
                <div class="toolbar-separator"></div>
                <span style="font-size: 12px; color: #888;">Canvas:</span>
                <input type="number" id="canvasWidth" class="toolbar-btn" value="1200" style="width: 60px; padding: 4px;" onchange="resizeCanvas()">
                <span style="color: #666;">Ã—</span>
                <input type="number" id="canvasHeight" class="toolbar-btn" value="800" style="width: 60px; padding: 4px;" onchange="resizeCanvas()">
            </div>

            <div id="canvas-wrapper">
                <div id="canvas">
                    <svg id="connections-layer"></svg>
                    <div class="guide guide-x" id="guideX"></div>
                    <div class="guide guide-y" id="guideY"></div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div id="sidebar-right">
            <div class="panel-header">Properties</div>
            <div id="properties-content">
                <div class="empty-state">Select an element to edit properties</div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">Exported HTML</div>
            <div class="modal-content" id="exportCode"></div>
            <div class="modal-actions">
                <button class="toolbar-btn" onclick="closeModal()">Close</button>
                <button class="toolbar-btn primary" onclick="copyCode()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script>
        let elements = [];
        let connections = [];
        let selectedId = null;
        let connectionMode = false;
        let connectionStart = null;
        let snapToGrid = false;
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        let resizeHandle = '';
        let elementCounter = 0;

        const canvas = document.getElementById('canvas');
        const connectionsLayer = document.getElementById('connections-layer');

        // Drag from sidebar
        document.querySelectorAll('.component-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', item.dataset.type);
            });
        });

        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            createElement(type, x, y);
        });

        function createElement(type, x, y) {
            elementCounter++;
            const id = `el-${elementCounter}`;
            
            const el = document.createElement('div');
            el.id = id;
            el.className = 'canvas-element';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.dataset.type = type;

            // Default sizes and content
            const defaults = getDefaults(type);
            el.style.width = defaults.width + 'px';
            el.style.height = defaults.height + 'px';
            el.innerHTML = defaults.html;

            // Add resize handles
            const handles = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];
            handles.forEach(h => {
                const handle = document.createElement('div');
                handle.className = `resize-handle handle-${h}`;
                handle.dataset.handle = h;
                el.appendChild(handle);
            });

            // Add connection points
            const points = ['top', 'right', 'bottom', 'left'];
            points.forEach(p => {
                const point = document.createElement('div');
                point.className = `connection-point cp-${p}`;
                point.dataset.side = p;
                point.onclick = (e) => handleConnectionClick(e, id, p);
                el.appendChild(point);
            });

            // Event listeners
            el.addEventListener('mousedown', (e) => handleElementMouseDown(e, id));
            
            canvas.appendChild(el);
            
            elements.push({
                id,
                type,
                x,
                y,
                width: defaults.width,
                height: defaults.height,
                styles: { ...defaults.styles }
            });

            selectElement(id);
        }

        function getDefaults(type) {
            switch(type) {
                case 'button':
                    return { width: 100, height: 36, html: '<div class="ui-button">Button</div>', styles: { background: '#0066cc', color: '#ffffff', borderRadius: 4 } };
                case 'input':
                    return { width: 140, height: 36, html: '<input type="text" class="ui-input" placeholder="Input...">', styles: { background: '#ffffff', border: '1px solid #cccccc', borderRadius: 4 } };
                case 'text':
                    return { width: 100, height: 30, html: '<div class="ui-text">Text Content</div>', styles: { color: '#333333', fontSize: 14 } };
                case 'checkbox':
                    return { width: 20, height: 20, html: '<div class="ui-checkbox"></div>', styles: {} };
                case 'dropdown':
                    return { width: 140, height: 36, html: '<div class="ui-dropdown">Select...</div>', styles: { background: '#ffffff', border: '1px solid #cccccc', borderRadius: 4 } };
                case 'slider':
                    return { width: 120, height: 20, html: '<div class="ui-slider"></div>', styles: {} };
                case 'stepper':
                    return { width: 100, height: 32, html: '<div class="ui-stepper"><button class="stepper-btn">-</button><div class="stepper-value">0</div><button class="stepper-btn">+</button></div>', styles: {} };
                case 'progress':
                    return { width: 120, height: 8, html: '<div class="ui-progress"><div class="progress-fill"></div></div>', styles: {} };
                case 'rectangle':
                    return { width: 100, height: 80, html: '', styles: { background: '#e0e0e0', border: '2px solid #999999' } };
                case 'circle':
                    return { width: 80, height: 80, html: '', styles: { background: '#e0e0e0', border: '2px solid #999999', borderRadius: '50%' } };
                case 'triangle':
                    return { width: 80, height: 80, html: '', styles: {} };
                case 'line':
                    return { width: 100, height: 2, html: '<div style="width: 100%; height: 100%; background: #333;"></div>', styles: { background: '#333333' } };
                default:
                    return { width: 100, height: 50, html: '', styles: {} };
            }
        }

        function handleElementMouseDown(e, id) {
            if (e.target.classList.contains('resize-handle')) {
                startResize(e, id, e.target.dataset.handle);
            } else if (e.target.classList.contains('connection-point')) {
                // Handled separately
            } else {
                startDrag(e, id);
            }
        }

        function startDrag(e, id) {
            if (connectionMode) return;
            
            selectElement(id);
            isDragging = true;
            const el = document.getElementById(id);
            const rect = el.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            
            dragOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };

            function onMouseMove(e) {
                if (!isDragging) return;
                
                let x = e.clientX - canvasRect.left - dragOffset.x;
                let y = e.clientY - canvasRect.top - dragOffset.y;

                if (snapToGrid) {
                    x = Math.round(x / 10) * 10;
                    y = Math.round(y / 10) * 10;
                }

                // Bounds checking
                x = Math.max(0, Math.min(x, canvas.offsetWidth - el.offsetWidth));
                y = Math.max(0, Math.min(y, canvas.offsetHeight - el.offsetHeight));

                el.style.left = x + 'px';
                el.style.top = y + 'px';

                updateElementData(id, { x, y });
                updateConnections();
                showAlignmentGuides(el);
            }

            function onMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                hideAlignmentGuides();
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        function startResize(e, id, handle) {
            e.stopPropagation();
            isResizing = true;
            resizeHandle = handle;
            
            const el = document.getElementById(id);
            const startX = e.clientX;
            const startY = e.clientY;
            const startWidth = el.offsetWidth;
            const startHeight = el.offsetHeight;
            const startLeft = parseInt(el.style.left);
            const startTop = parseInt(el.style.top);

            function onMouseMove(e) {
                if (!isResizing) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;

                if (resizeHandle.includes('e')) newWidth = startWidth + dx;
                if (resizeHandle.includes('w')) {
                    newWidth = startWidth - dx;
                    newLeft = startLeft + dx;
                }
                if (resizeHandle.includes('s')) newHeight = startHeight + dy;
                if (resizeHandle.includes('n')) {
                    newHeight = startHeight - dy;
                    newTop = startTop + dy;
                }

                // Minimum sizes
                newWidth = Math.max(20, newWidth);
                newHeight = Math.max(20, newHeight);

                if (resizeHandle.includes('w')) newLeft = startLeft + (startWidth - newWidth);
                if (resizeHandle.includes('n')) newTop = startTop + (startHeight - newHeight);

                el.style.width = newWidth + 'px';
                el.style.height = newHeight + 'px';
                el.style.left = newLeft + 'px';
                el.style.top = newTop + 'px';

                updateElementData(id, {
                    width: newWidth,
                    height: newHeight,
                    x: newLeft,
                    y: newTop
                });
                updateConnections();
            }

            function onMouseUp() {
                isResizing = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        function selectElement(id) {
            document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.remove('selected');
            });
            
            if (id) {
                document.getElementById(id).classList.add('selected');
                selectedId = id;
                showProperties(id);
            } else {
                selectedId = null;
                hideProperties();
            }
        }

        function showProperties(id) {
            const el = elements.find(e => e.id === id);
            if (!el) return;

            const panel = document.getElementById('properties-content');
            
            let html = `
                <div class="prop-group">
                    <div class="prop-row">
                        <div>
                            <label class="prop-label">X</label>
                            <input type="number" class="prop-input" value="${Math.round(el.x)}" onchange="updateProperty('${id}', 'x', this.value)">
                        </div>
                        <div>
                            <label class="prop-label">Y</label>
                            <input type="number" class="prop-input" value="${Math.round(el.y)}" onchange="updateProperty('${id}', 'y', this.value)">
                        </div>
                    </div>
                    <div class="prop-row">
                        <div>
                            <label class="prop-label">Width</label>
                            <input type="number" class="prop-input" value="${Math.round(el.width)}" onchange="updateProperty('${id}', 'width', this.value)">
                        </div>
                        <div>
                            <label class="prop-label">Height</label>
                            <input type="number" class="prop-input" value="${Math.round(el.height)}" onchange="updateProperty('${id}', 'height', this.value)">
                        </div>
                    </div>
                </div>
            `;

            if (el.type === 'rectangle' || el.type === 'button' || el.type === 'input' || el.type === 'dropdown') {
                html += `
                    <div class="prop-group">
                        <label class="prop-label">Background</label>
                        <div class="prop-row">
                            <input type="color" class="color-picker" value="${rgbToHex(el.styles.background) || '#ffffff'}" onchange="updateStyle('${id}', 'background', this.value)">
                            <input type="text" class="prop-input" value="${el.styles.background || ''}" onchange="updateStyle('${id}', 'background', this.value)">
                        </div>
                        
                        <label class="prop-label">Border Radius</label>
                        <input type="number" class="prop-input full" value="${parseInt(el.styles.borderRadius) || 0}" onchange="updateStyle('${id}', 'borderRadius', this.value + 'px')">
                        
                        <label class="prop-label">Box Shadow</label>
                        <input type="text" class="prop-input full" value="${el.styles.boxShadow || ''}" placeholder="0 2px 4px rgba(0,0,0,0.2)" onchange="updateStyle('${id}', 'boxShadow', this.value)">
                    </div>
                `;
            }

            if (el.type === 'text' || el.type === 'button') {
                html += `
                    <div class="prop-group">
                        <label class="prop-label">Text Content</label>
                        <input type="text" class="prop-input full" value="${document.querySelector(`#${id} .ui-text, #${id} .ui-button`)?.textContent || ''}" onchange="updateText('${id}', this.value)">
                        
                        <label class="prop-label">Color</label>
                        <input type="color" class="color-picker" value="${rgbToHex(el.styles.color) || '#000000'}" onchange="updateStyle('${id}', 'color', this.value)">
                        
                        <label class="prop-label">Font Size (px)</label>
                        <input type="number" class="prop-input full" value="${parseInt(el.styles.fontSize) || 14}" onchange="updateStyle('${id}', 'fontSize', this.value + 'px')">
                    </div>
                `;
            }

            if (el.type === 'line') {
                html += `
                    <div class="prop-group">
                        <label class="prop-label">Line Color</label>
                        <input type="color" class="color-picker" value="${rgbToHex(el.styles.background) || '#333333'}" onchange="updateStyle('${id}', 'background', this.value)">
                        
                        <label class="prop-label">Line Height</label>
                        <input type="number" class="prop-input full" value="${parseInt(el.height)}" onchange="updateProperty('${id}', 'height', this.value)">
                    </div>
                `;
            }

            html += `
                <div class="prop-group">
                    <button class="toolbar-btn" onclick="deleteElement('${id}')" style="width: 100%; background: #cc3333; border-color: #cc3333;">Delete Element</button>
                </div>
            `;

            panel.innerHTML = html;
        }

        function hideProperties() {
            document.getElementById('properties-content').innerHTML = '<div class="empty-state">Select an element to edit properties</div>';
        }

        function updateProperty(id, prop, value) {
            const el = elements.find(e => e.id === id);
            if (!el) return;
            
            value = parseInt(value);
            el[prop] = value;
            
            const domEl = document.getElementById(id);
            if (prop === 'x') domEl.style.left = value + 'px';
            if (prop === 'y') domEl.style.top = value + 'px';
            if (prop === 'width') domEl.style.width = value + 'px';
            if (prop === 'height') domEl.style.height = value + 'px';
            
            updateConnections();
        }

        function updateStyle(id, property, value) {
            const el = elements.find(e => e.id === id);
            if (!el) return;
            
            el.styles[property] = value;
            
            const domEl = document.getElementById(id);
            domEl.style[property] = value;
            
            // Update inner elements if needed
            const inner = domEl.querySelector('.ui-button, .ui-text, .ui-input');
            if (inner) inner.style[property] = value;
        }

        function updateText(id, value) {
            const el = document.getElementById(id);
            const inner = el.querySelector('.ui-text, .ui-button');
            if (inner) inner.textContent = value;
        }

        function deleteElement(id) {
            document.getElementById(id).remove();
            elements = elements.filter(e => e.id !== id);
            connections = connections.filter(c => c.from !== id && c.to !== id);
            updateConnections();
            selectElement(null);
        }

        function clearCanvas() {
            if (!confirm('Clear all elements?')) return;
            document.querySelectorAll('.canvas-element').forEach(el => el.remove());
            connectionsLayer.innerHTML = '';
            elements = [];
            connections = [];
            selectElement(null);
        }

        // Connection System
        function toggleConnectionMode() {
            connectionMode = !connectionMode;
            document.getElementById('connectionBtn').classList.toggle('active');
            document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.toggle('connection-mode', connectionMode);
            });
            
            if (!connectionMode) {
                connectionStart = null;
            }
        }

        function handleConnectionClick(e, id, side) {
            if (!connectionMode) return;
            e.stopPropagation();
            
            if (!connectionStart) {
                connectionStart = { id, side };
                document.getElementById(id).style.outline = '2px solid #00cc66';
            } else {
                if (connectionStart.id !== id) {
                    connections.push({
                        from: connectionStart.id,
                        fromSide: connectionStart.side,
                        to: id,
                        toSide: side,
                        id: 'conn-' + Date.now()
                    });
                    updateConnections();
                }
                connectionStart = null;
                document.querySelectorAll('.canvas-element').forEach(el => {
                    el.style.outline = '';
                });
            }
        }

        function updateConnections() {
            connectionsLayer.innerHTML = '';
            connections.forEach(conn => {
                const fromEl = document.getElementById(conn.from);
                const toEl = document.getElementById(conn.to);
                if (!fromEl || !toEl) return;
                
                const fromPoint = getConnectionPoint(fromEl, conn.fromSide);
                const toPoint = getConnectionPoint(toEl, conn.toSide);
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${fromPoint.x} ${fromPoint.y} L ${toPoint.x} ${toPoint.y}`);
                path.setAttribute('class', 'connection-line');
                path.setAttribute('data-id', conn.id);
                path.onclick = () => deleteConnection(conn.id);
                connectionsLayer.appendChild(path);
            });
        }

        function getConnectionPoint(el, side) {
            const rect = el.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            const x = rect.left - canvasRect.left;
            const y = rect.top - canvasRect.top;
            
            switch(side) {
                case 'top': return { x: x + rect.width/2, y: y };
                case 'right': return { x: x + rect.width, y: y + rect.height/2 };
                case 'bottom': return { x: x + rect.width/2, y: y + rect.height };
                case 'left': return { x: x, y: y + rect.height/2 };
            }
        }

        function deleteConnection(id) {
            if (!confirm('Delete connection?')) return;
            connections = connections.filter(c => c.id !== id);
            updateConnections();
        }

        // Alignment Guides
        function showAlignmentGuides(activeEl) {
            const guides = { x: [], y: [] };
            const activeRect = activeEl.getBoundingClientRect();
            const activeCenter = {
                x: activeRect.left + activeRect.width/2,
                y: activeRect.top + activeRect.height/2
            };
            
            elements.forEach(el => {
                if (el.id === activeEl.id) return;
                const rect = document.getElementById(el.id).getBoundingClientRect();
                const center = {
                    x: rect.left + rect.width/2,
                    y: rect.top + rect.height/2
                };
                
                if (Math.abs(activeCenter.x - center.x) < 5) guides.x.push(center.x);
                if (Math.abs(activeRect.left - rect.left) < 5) guides.x.push(rect.left);
                if (Math.abs(activeRect.right - rect.right) < 5) guides.x.push(rect.right);
                
                if (Math.abs(activeCenter.y - center.y) < 5) guides.y.push(center.y);
                if (Math.abs(activeRect.top - rect.top) < 5) guides.y.push(rect.top);
                if (Math.abs(activeRect.bottom - rect.bottom) < 5) guides.y.push(rect.bottom);
            });
            
            const canvasRect = canvas.getBoundingClientRect();
            
            if (guides.x.length > 0) {
                const guideX = document.getElementById('guideX');
                guideX.style.left = (guides.x[0] - canvasRect.left) + 'px';
                guideX.style.display = 'block';
            }
            if (guides.y.length > 0) {
                const guideY = document.getElementById('guideY');
                guideY.style.top = (guides.y[0] - canvasRect.top) + 'px';
                guideY.style.display = 'block';
            }
        }

        function hideAlignmentGuides() {
            document.getElementById('guideX').style.display = 'none';
            document.getElementById('guideY').style.display = 'none';
        }

        // Grid & Canvas
        function toggleGrid() {
            snapToGrid = !snapToGrid;
            document.getElementById('gridBtn').classList.toggle('active');
            canvas.classList.toggle('snap-grid', snapToGrid);
        }

        function resizeCanvas() {
            const w = parseInt(document.getElementById('canvasWidth').value);
            const h = parseInt(document.getElementById('canvasHeight').value);
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
        }

        // Export
        function exportHTML() {
            let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exported Design</title>
    <style>
        body { margin: 0; background: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #canvas { position: relative; background: white; width: ${canvas.style.width}; height: ${canvas.style.height}; box-shadow: 0 0 20px rgba(0,0,0,0.1); overflow: hidden; }
        .element { position: absolute; box-sizing: border-box; }
    </style>
</head>
<body>
    <div id="canvas">`;
            
            elements.forEach(el => {
                const domEl = document.getElementById(el.id);
                let innerHTML = domEl.innerHTML;
                
                // Remove handles and connection points
                innerHTML = innerHTML.replace(/<div class="resize-handle[^"]*"[^>]*><\/div>/g, '');
                innerHTML = innerHTML.replace(/<div class="connection-point[^"]*"[^>]*><\/div>/g, '');
                
                html += `
        <div class="element" style="
            left: ${el.x}px;
            top: ${el.y}px;
            width: ${el.width}px;
            height: ${el.height}px;
            ${Object.entries(el.styles).map(([k,v]) => `${k.replace(/[A-Z]/g, m => '-' + m.toLowerCase())}: ${v};`).join('')}
        ">${innerHTML}</div>`;
            });
            
            // Add connections as SVG
            if (connections.length > 0) {
                html += `
        <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
            ${connections.map(conn => {
                const fromEl = elements.find(e => e.id === conn.from);
                const toEl = elements.find(e => e.id === conn.to);
                if (!fromEl || !toEl) return '';
                
                const fromX = fromEl.x + (conn.fromSide === 'right' ? fromEl.width : conn.fromSide === 'left' ? 0 : fromEl.width/2);
                const fromY = fromEl.y + (conn.fromSide === 'bottom' ? fromEl.height : conn.fromSide === 'top' ? 0 : fromEl.height/2);
                const toX = toEl.x + (conn.toSide === 'right' ? toEl.width : conn.toSide === 'left' ? 0 : toEl.width/2);
                const toY = toEl.y + (conn.toSide === 'bottom' ? toEl.height : conn.toSide === 'top' ? 0 : toEl.height/2);
                
                return `<path d="M ${fromX} ${fromY} L ${toX} ${toY}" stroke="#0066cc" stroke-width="2" fill="none"/>`;
            }).join('\n            ')}
        </svg>`;
            }
            
            html += `
    </div>
</body>
</html>`;
            
            document.getElementById('exportCode').textContent = html;
            document.getElementById('exportModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function copyCode() {
            const code = document.getElementById('exportCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Copied to clipboard!');
            });
        }

        // Utils
        function rgbToHex(rgb) {
            if (!rgb || rgb.startsWith('#')) return rgb;
            const match = rgb.match(/\d+/g);
            if (!match) return '#000000';
            return '#' + match.slice(0,3).map(x => parseInt(x).toString(16).padStart(2,'0')).join('');
        }

        // Deselect on canvas click
        canvas.addEventListener('mousedown', (e) => {
            if (e.target === canvas) {
                selectElement(null);
            }
        });

        // Delete on keydown
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' && selectedId) {
                deleteElement(selectedId);
            }
        });
    </script>
</body>
</html>