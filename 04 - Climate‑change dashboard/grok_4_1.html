<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia Climate Dashboard (1952–2021)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f8f8; color: #333; }
        h1, h2 { text-align: center; }
        .controls { text-align: center; margin: 20px 0; font-size: 18px; }
        .controls select { font-size: 18px; padding: 5px; margin: 0 10px; }
        background: white; }
        #summary { text-align: center; font-size: 20px; margin: 30px; padding: 15px; background: #eef; border-radius: 8px; }
        canvas { max-width: 1100px; margin: 40px auto; display: block; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<h1>Sofia, Bulgaria – Climate Dashboard (1952–2021)</h1>

<div class="controls">
    <label for="startYear">Start year:</label>
    <select id="startYear"></select>
    
    <label for="endYear">End year:</label>
    <select id="endYear"></select>
</div>

<div id="summary">Loading data…</div>

<h2>Annual Mean, Max and Min Temperatures + Trend Line</h2>
<canvas id="annualChart"></canvas>

<h2>Average Monthly Temperature (climatology for selected period)</h2>
<canvas id="monthlyChart"></canvas>

<h2>Extreme Temperature Days per Year (≥30°C | ≤−10°C)</h2>
<canvas id="extremesChart"></canvas>

<script>
let rawData = [];
let annualChart = null;
let monthlyChart = null;
let extremesChart = null;

function linearRegression(years, temps) {
    const n = years.length;
    if (n < 2) return {slope: 0, intercept: 0};
    let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
    for (let i = 0; i < n; i++) {
        sumX += years[i];
        sumY += temps[i];
        sumXY += years[i] * temps[i];
        sumXX += years[i] * years[i];
    }
    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    return {slope, intercept};
}

function updateDashboard() {
    const startYear = parseInt(document.getElementById('startYear').value);
    const endYear = parseInt(document.getElementById('endYear').value);
    
    if (startYear > endYear) {
        alert("Start year cannot be greater than end year");
        return;
    }

    const filtered = rawData.filter(r => r.year >= startYear && r.year <= endYear);

    // ---------- Yearly aggregates ----------
    const yearly = {};
    let totalSum = 0;
    let totalDays = 0;

    filtered.forEach(r => {
        if (!yearly[r.year]) {
            yearly[r.year] = {
                tavgSum: 0,
                tavgCount: 0,
                tmaxMax: -Infinity,
                tminMin: +Infinity,
                hotDays: 0,
                coldDays: 0
            };
        }
        const y = yearly[r.year];
        if (r.tavg !== null && r.tavg !== undefined) {
            y.tavgSum += r.tavg;
            y.tavgCount++;
        }
        if (r.tmax !== null) {
            y.tmaxMax = Math.max(y.tmaxMax, r.tmax);
            if (r.tmax >= 30) y.hotDays++;
        }
        if (r.tmin !== null) {
            y.tminMin = Math.min(y.tminMin, r.tmin);
            if (r.tmin <= -10) y.coldDays++;
        }
    });

    // Build arrays for charts
    const yearsList = [];
    const annualMeans = [];
    const annualMaxT = [];
    const annualMinT = [];
    const hotDayCounts = [];
    const coldDayCounts = [];

    let weightedSum = 0;
    let weightedDays = 0;

    for (let y = startYear; y <= endYear; y++) {
        if (yearly[y] && yearly[y].tavgCount > 0) {
            yearsList.push(y);
            const mean = yearly[y].tavgSum / yearly[y].tavgCount;
            annualMeans.push(mean);
            weightedSum += yearly[y].tavgSum;
            weightedDays += yearly[y].tavgCount;
            annualMaxT.push(yearly[y].tmaxMax === -Infinity ? null : yearly[y].tmaxMax);
            annualMinT.push(yearly[y].tminMin === +Infinity ? null : yearly[y].tminMin);
            hotDayCounts.push(yearly[y].hotDays);
            coldDayCounts.push(yearly[y].coldDays);
        }
    }

    const overallMean = weightedDays > 0 ? weightedSum / weightedDays : NaN;

    const regression = linearRegression(yearsList, annualMeans);
    const trendPerDecade = regression.slope * 10;

    // Trend line data
    const trendLine = yearsList.map(y => regression.intercept + regression.slope * y);

    // Summary text
    document.getElementById('summary').innerHTML = `
        Selected period: ${startYear} – ${endYear} (${yearsList.length} years)<br>
        Overall mean temperature: <strong>${overallMean.toFixed(2)} °C</strong><br>
        Estimated warming trend: <strong>${trendPerDecade.toFixed(3)} °C/decade</strong>
    `;

    // ---------- Monthly climatology ----------
    const monthSums = Array(12).fill(0);
    const monthCounts = Array(12).fill(0);

    filtered.forEach(r => {
        if (r.tavg !== null && r.tavg !== undefined) {
            monthSums[r.month] += r.tavg;
            monthCounts[r.month]++;
        }
    });

    const monthlyMeans = monthSums.map((s, i) => monthCounts[i] > 0 ? s / monthCounts[i] : null);

    // ---------- Destroy old charts ----------
    if (annualChart) annualChart.destroy();
    if (monthlyChart) monthlyChart.destroy();
    if (extremesChart) extremesChart.destroy();

    // ---------- Annual chart ----------
    annualChart = new Chart(document.getElementById('annualChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: yearsList,
            datasets: [
                { label: 'Mean Temperature (°C)', data: annualMeans, borderColor: '#0066cc', backgroundColor: 'rgba(0,102,204,0.1)', fill: false, tension: 0.1 },
                { label: 'Absolute Max (°C)', data: annualMaxT, borderColor: '#ff3333', fill: false, pointRadius: 2 },
                { label: 'Absolute Min (°C)', data: annualMinT, borderColor: '#33cc33', fill: false, pointRadius: 2 },
                { label: 'Linear Trend', data: trendLine, borderColor: '#000', borderDash: [8,4], fill: false, pointRadius: 0 }
            ]
        },
        options: {
            plugins: { title: { display: true, text: 'Annual Temperatures and Linear Trend' } },
            scales: { y: { title: { display: true, text: 'Temperature (°C)' } } }
        }
    });

    // ---------- Monthly chart ----------
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    monthlyChart = new Chart(document.getElementById('monthlyChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: monthNames,
            datasets: [{
                label: 'Monthly Mean Temperature (°C)',
                data: monthlyMeans,
                backgroundColor: 'rgba(54,162,235,0.6)',
                borderColor: 'rgba(54,162,235,1)',
                borderWidth: 1
            }]
        },
        options: {
            plugins: { title: { display: true, text: `Average Monthly Temperature (${startYear}–${endYear})` } },
            scales: { y: { title: { display: true, text: 'Temperature (°C)' } } }
        }
    });

    // ---------- Extremes chart ----------
    extremesChart = new Chart(document.getElementById('extremesChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: yearsList,
            datasets: [
                { label: 'Very Hot Days (Tmax ≥ 30°C)', data: hotDayCounts, backgroundColor: '#ff5555' },
                { label: 'Very Cold Days (Tmin ≤ −10°C)', data: coldDayCounts, backgroundColor: '#5599ff' }
            ]
        },
        options: {
            plugins: { title: { display: true, text: 'Extreme Temperature Days per Year' } },
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Days' } } }
        }
    });
}

// Load and parse CSV
fetch('temperature_Sofia_2809794_1952-01-01 - 2021-11-28.csv')
    .then(r => r.text())
    .then(text => {
        const results = Papa.parse(text, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true
        });

        rawData = results.data.map(row => {
            if (!row.DATE) return null;
            const [y, m, d] = row.DATE.split('-');
            const tavg = row.TAVG ? parseFloat(row.TAVG) / 10 : 
                          (row.TMAX && row.TMIN ? (parseFloat(row.TMAX) + parseFloat(row.TMIN)) / 20 : null);
            return {
                year: parseInt(y),
                month: parseInt(m) - 1, // 0-11
                day: parseInt(d),
                tavg,
                tmax: row.TMAX ? parseFloat(row.TMAX) / 10 : null,
                tmin: row.TMIN ? parseFloat(row.TMIN) / 10 : null
            };
        }).filter(Boolean);

        // Populate year selects
        const years = [...new Set(rawData.map(r => r.year))].sort((a,b)=>a-b);
        const startSel = document.getElementById('startYear');
        const endSel = document.getElementById('endYear');

        years.forEach(y => {
            const o1 = new Option(y, y);
            const o2 = o1.cloneNode();
            startSel.appendChild(o1);
            endSel.appendChild(o2);
        });

        startSel.value = Math.min(...years);
        endSel.value = Math.max(...years);

        startSel.onchange = endSel.onchange = updateDashboard;

        updateDashboard();
    })
    .catch(err => {
        document.body.innerHTML += '<p style="color:red; text-align:center;">Error loading CSV file: ' + err.message + '</p>';
    });
</script>
</body>
</html>