<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecosystem Monte Carlo Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            padding: 15px;
            color: #fff;
        }
        
        h1 {
            color: #4ade80;
            margin-bottom: 12px;
            font-weight: 500;
            text-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
            font-size: 24px;
        }
        
        #main-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        #canvas-wrapper {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(74, 222, 128, 0.3);
        }
        
        #side-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 320px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .panel h3 {
            color: #4ade80;
            font-size: 12px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }
        
        .control-row {
            margin-bottom: 10px;
        }
        
        .control-row label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 11px;
            color: #aaa;
        }
        
        .control-row label span {
            color: #f472b6;
            font-weight: 600;
            font-family: 'Consolas', monospace;
        }
        
        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(74, 222, 128, 0.4);
        }
        
        .button-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: 60px;
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        
        .btn-green {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #000;
        }
        
        .btn-blue {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: #fff;
        }
        
        .btn-red {
            background: linear-gradient(135deg, #f87171, #ef4444);
            color: #fff;
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #c084fc, #a855f7);
            color: #fff;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 6px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 16px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
        }
        
        .stat-box .label {
            font-size: 8px;
            color: #888;
            text-transform: uppercase;
            margin-top: 3px;
        }
        
        .stat-box.plants .value { color: #4ade80; }
        .stat-box.herbivores .value { color: #60a5fa; }
        .stat-box.predators .value { color: #f87171; }
        
        .legend {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .trait-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            font-size: 10px;
            font-family: 'Consolas', monospace;
        }
        
        .trait-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            color: #aaa;
        }
        
        .trait-row span:last-child {
            color: #4ade80;
        }
        
        #graphCanvas {
            width: 100%;
            height: 100px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .info-text {
            font-size: 10px;
            color: #666;
            line-height: 1.5;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <h1>ðŸŒ¿ Ecosystem Evolution Simulation</h1>
    
    <div id="main-container">
        <div id="canvas-wrapper"></div>
        
        <div id="side-panel">
            <div class="panel">
                <h3>Population</h3>
                <div class="stats-grid">
                    <div class="stat-box plants">
                        <div class="value" id="plantCount">0</div>
                        <div class="label">Plants</div>
                    </div>
                    <div class="stat-box herbivores">
                        <div class="value" id="herbivoreCount">0</div>
                        <div class="label">Herbivores</div>
                    </div>
                    <div class="stat-box predators">
                        <div class="value" id="predatorCount">0</div>
                        <div class="label">Predators</div>
                    </div>
                </div>
                <canvas id="graphCanvas"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #4ade80;"></div>
                        <span>Plants</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #60a5fa;"></div>
                        <span>Herbivores</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #f87171;"></div>
                        <span>Predators</span>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>Average Traits</h3>
                <div class="trait-display">
                    <div style="color: #60a5fa; margin-bottom: 6px;">Herbivores:</div>
                    <div class="trait-row"><span>Speed:</span><span id="herbSpeed">0</span></div>
                    <div class="trait-row"><span>Vision:</span><span id="herbVision">0</span></div>
                    <div class="trait-row"><span>Size:</span><span id="herbSize">0</span></div>
                    <div style="color: #f87171; margin-top: 8px; margin-bottom: 6px;">Predators:</div>
                    <div class="trait-row"><span>Speed:</span><span id="predSpeed">0</span></div>
                    <div class="trait-row"><span>Vision:</span><span id="predVision">0</span></div>
                    <div class="trait-row"><span>Size:</span><span id="predSize">0</span></div>
                </div>
            </div>
            
            <div class="panel">
                <h3>Environment</h3>
                <div class="control-row">
                    <label>Plant Growth Rate: <span id="plantGrowthVal">0.02</span></label>
                    <input type="range" id="plantGrowth" min="0.001" max="0.1" step="0.001" value="0.02">
                </div>
                <div class="control-row">
                    <label>Carrying Capacity: <span id="carryingVal">500</span></label>
                    <input type="range" id="carrying" min="100" max="2000" step="50" value="500">
                </div>
                <div class="control-row">
                    <label>Mutation Rate: <span id="mutationVal">0.1</span></label>
                    <input type="range" id="mutation" min="0" max="0.5" step="0.01" value="0.1">
                </div>
                <div class="control-row">
                    <label>Mutation Strength: <span id="mutStrengthVal">0.2</span></label>
                    <input type="range" id="mutStrength" min="0.01" max="0.5" step="0.01" value="0.2">
                </div>
            </div>
            
            <div class="panel">
                <h3>Simulation</h3>
                <div class="control-row">
                    <label>Speed: <span id="speedVal">1</span>x</label>
                    <input type="range" id="simSpeed" min="1" max="10" step="1" value="1">
                </div>
                <div class="button-row">
                    <button class="btn-green" onclick="resetSimulation()">Reset</button>
                    <button class="btn-blue" onclick="togglePause()">Pause</button>
                    <button class="btn-purple" onclick="addEntities()">Add Life</button>
                </div>
                <div class="button-row" style="margin-top: 6px;">
                    <button class="btn-red" onclick="extinction('predators')">Kill Preds</button>
                    <button class="btn-red" onclick="extinction('herbivores')">Kill Herbs</button>
                </div>
                <div class="info-text">
                    Gen: <span id="generation">0</span> | 
                    Time: <span id="simTime">0</span> |
                    FPS: <span id="fps">60</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Grid and simulation settings
        const CELL_SIZE = 4;
        let GRID_WIDTH, GRID_HEIGHT;
        let canvasWidth, canvasHeight;
        
        // Entity arrays
        let plants = [];
        let herbivores = [];
        let predators = [];
        
        // Simulation parameters
        let plantGrowthRate = 0.02;
        let carryingCapacity = 500;
        let mutationRate = 0.1;
        let mutationStrength = 0.2;
        let simSpeed = 1;
        let paused = false;
        let generation = 0;
        let simTime = 0;
        
        // Population history for graphs
        let populationHistory = {
            plants: [],
            herbivores: [],
            predators: []
        };
        const MAX_HISTORY = 300;
        
        // Graph canvas
        let graphCanvas, graphCtx;
        
        // Entity classes
        class Plant {
            constructor(x, y, energy = 50) {
                this.x = x;
                this.y = y;
                this.energy = energy;
                this.maxEnergy = 100;
                this.age = 0;
            }
            
            update() {
                this.age++;
                if (this.energy < this.maxEnergy) {
                    this.energy += 0.5;
                }
                // Death by old age
                if (this.age > 500 && random() < 0.01) {
                    return false;
                }
                return true;
            }
        }
        
        class Animal {
            constructor(x, y, traits = null) {
                this.x = x;
                this.y = y;
                this.energy = 100;
                this.age = 0;
                this.generation = generation;
                
                if (traits) {
                    this.speed = traits.speed;
                    this.vision = traits.vision;
                    this.size = traits.size;
                    this.efficiency = traits.efficiency;
                    this.reproThreshold = traits.reproThreshold;
                } else {
                    this.speed = 1 + random() * 2;
                    this.vision = 3 + random() * 5;
                    this.size = 0.8 + random() * 0.4;
                    this.efficiency = 0.7 + random() * 0.3;
                    this.reproThreshold = 150 + random() * 100;
                }
                
                this.maxEnergy = 200 * this.size;
                this.moveEnergyCost = 0.5 * this.speed * this.size;
                this.baseEnergyCost = 0.2 * this.size;
            }
            
            mutate() {
                if (random() < mutationRate) {
                    this.speed = max(0.5, this.speed + (random() - 0.5) * mutationStrength * 2);
                }
                if (random() < mutationRate) {
                    this.vision = max(1, this.vision + (random() - 0.5) * mutationStrength * 4);
                }
                if (random() < mutationRate) {
                    this.size = constrain(this.size + (random() - 0.5) * mutationStrength, 0.3, 2);
                }
                if (random() < mutationRate) {
                    this.efficiency = constrain(this.efficiency + (random() - 0.5) * mutationStrength * 0.3, 0.3, 1);
                }
                if (random() < mutationRate) {
                    this.reproThreshold = max(100, this.reproThreshold + (random() - 0.5) * mutationStrength * 50);
                }
                
                this.maxEnergy = 200 * this.size;
                this.moveEnergyCost = 0.5 * this.speed * this.size;
                this.baseEnergyCost = 0.2 * this.size;
            }
            
            getTraits() {
                return {
                    speed: this.speed,
                    vision: this.vision,
                    size: this.size,
                    efficiency: this.efficiency,
                    reproThreshold: this.reproThreshold
                };
            }
            
            move(dx, dy) {
                this.x = constrain(this.x + dx, 0, GRID_WIDTH - 1);
                this.y = constrain(this.y + dy, 0, GRID_HEIGHT - 1);
                this.energy -= this.moveEnergyCost;
            }
            
            randomMove() {
                const angle = random(TWO_PI);
                const dist = random(this.speed);
                this.move(cos(angle) * dist, sin(angle) * dist);
            }
        }
        
        class Herbivore extends Animal {
            constructor(x, y, traits = null) {
                super(x, y, traits);
                this.type = 'herbivore';
            }
            
            update(plantsGrid) {
                this.age++;
                this.energy -= this.baseEnergyCost;
                
                // Death conditions
                if (this.energy <= 0) return null;
                if (this.age > 1000 && random() < 0.02) return null;
                
                // Find nearby plants
                let nearestPlant = null;
                let minDist = this.vision;
                
                for (let plant of plants) {
                    const d = dist(this.x, this.y, plant.x, plant.y);
                    if (d < minDist) {
                        minDist = d;
                        nearestPlant = plant;
                    }
                }
                
                if (nearestPlant && minDist < 1) {
                    // Eat plant
                    const energyGain = nearestPlant.energy * this.efficiency;
                    this.energy = min(this.maxEnergy, this.energy + energyGain);
                    plants.splice(plants.indexOf(nearestPlant), 1);
                } else if (nearestPlant) {
                    // Move towards plant
                    const angle = atan2(nearestPlant.y - this.y, nearestPlant.x - this.x);
                    this.move(cos(angle) * this.speed, sin(angle) * this.speed);
                } else {
                    // Random movement
                    this.randomMove();
                }
                
                // Reproduction
                if (this.energy > this.reproThreshold && random() < 0.05) {
                    return this.reproduce();
                }
                
                return this;
            }
            
            reproduce() {
                this.energy *= 0.5;
                const offspring = new Herbivore(
                    this.x + random(-2, 2),
                    this.y + random(-2, 2),
                    this.getTraits()
                );
                offspring.energy = this.energy * 0.4;
                offspring.generation = generation;
                offspring.mutate();
                return offspring;
            }
        }
        
        class Predator extends Animal {
            constructor(x, y, traits = null) {
                super(x, y, traits);
                this.type = 'predator';
                this.speed = traits ? traits.speed : 1.5 + random() * 2;
                this.vision = traits ? traits.vision : 5 + random() * 7;
                this.moveEnergyCost = 0.8 * this.speed * this.size;
                this.baseEnergyCost = 0.4 * this.size;
            }
            
            update() {
                this.age++;
                this.energy -= this.baseEnergyCost;
                
                // Death conditions
                if (this.energy <= 0) return null;
                if (this.age > 800 && random() < 0.02) return null;
                
                // Find nearby herbivores
                let nearestPrey = null;
                let minDist = this.vision;
                
                for (let herb of herbivores) {
                    const d = dist(this.x, this.y, herb.x, herb.y);
                    if (d < minDist) {
                        minDist = d;
                        nearestPrey = herb;
                    }
                }
                
                if (nearestPrey && minDist < 1.5) {
                    // Catch probability based on relative speed/size
                    const catchProb = 0.5 + (this.speed - nearestPrey.speed) * 0.1 + (this.size - nearestPrey.size) * 0.2;
                    if (random() < catchProb) {
                        // Eat herbivore
                        const energyGain = nearestPrey.energy * 0.8 * this.efficiency;
                        this.energy = min(this.maxEnergy, this.energy + energyGain);
                        herbivores.splice(herbivores.indexOf(nearestPrey), 1);
                    }
                } else if (nearestPrey) {
                    // Chase prey
                    const angle = atan2(nearestPrey.y - this.y, nearestPrey.x - this.x);
                    this.move(cos(angle) * this.speed, sin(angle) * this.speed);
                } else {
                    // Random movement
                    this.randomMove();
                }
                
                // Reproduction
                if (this.energy > this.reproThreshold * 1.2 && random() < 0.03) {
                    return this.reproduce();
                }
                
                return this;
            }
            
            reproduce() {
                this.energy *= 0.5;
                const offspring = new Predator(
                    this.x + random(-2, 2),
                    this.y + random(-2, 2),
                    this.getTraits()
                );
                offspring.energy = this.energy * 0.4;
                offspring.generation = generation;
                offspring.mutate();
                return offspring;
            }
        }
        
        function setup() {
            canvasWidth = min(600, windowWidth - 380);
            canvasHeight = min(600, windowHeight - 100);
            canvasWidth = max(400, canvasWidth);
            canvasHeight = canvasWidth;
            
            GRID_WIDTH = floor(canvasWidth / CELL_SIZE);
            GRID_HEIGHT = floor(canvasHeight / CELL_SIZE);
            
            const canvas = createCanvas(canvasWidth, canvasHeight);
            canvas.parent('canvas-wrapper');
            
            graphCanvas = document.getElementById('graphCanvas');
            graphCanvas.width = graphCanvas.offsetWidth * 2;
            graphCanvas.height = graphCanvas.offsetHeight * 2;
            graphCtx = graphCanvas.getContext('2d');
            
            setupControls();
            resetSimulation();
        }
        
        function setupControls() {
            document.getElementById('plantGrowth').addEventListener('input', function() {
                plantGrowthRate = parseFloat(this.value);
                document.getElementById('plantGrowthVal').textContent = plantGrowthRate.toFixed(3);
            });
            
            document.getElementById('carrying').addEventListener('input', function() {
                carryingCapacity = parseInt(this.value);
                document.getElementById('carryingVal').textContent = carryingCapacity;
            });
            
            document.getElementById('mutation').addEventListener('input', function() {
                mutationRate = parseFloat(this.value);
                document.getElementById('mutationVal').textContent = mutationRate.toFixed(2);
            });
            
            document.getElementById('mutStrength').addEventListener('input', function() {
                mutationStrength = parseFloat(this.value);
                document.getElementById('mutStrengthVal').textContent = mutationStrength.toFixed(2);
            });
            
            document.getElementById('simSpeed').addEventListener('input', function() {
                simSpeed = parseInt(this.value);
                document.getElementById('speedVal').textContent = simSpeed;
            });
        }
        
        function resetSimulation() {
            plants = [];
            herbivores = [];
            predators = [];
            generation = 0;
            simTime = 0;
            populationHistory = { plants: [], herbivores: [], predators: [] };
            
            // Initial plants
            for (let i = 0; i < 300; i++) {
                plants.push(new Plant(
                    random(GRID_WIDTH),
                    random(GRID_HEIGHT),
                    50 + random(50)
                ));
            }
            
            // Initial herbivores
            for (let i = 0; i < 50; i++) {
                herbivores.push(new Herbivore(
                    random(GRID_WIDTH),
                    random(GRID_HEIGHT)
                ));
            }
            
            // Initial predators
            for (let i = 0; i < 15; i++) {
                predators.push(new Predator(
                    random(GRID_WIDTH),
                    random(GRID_HEIGHT)
                ));
            }
        }
        
        function updateSimulation() {
            simTime++;
            
            // Grow new plants
            const plantDensity = plants.length / carryingCapacity;
            if (random() < plantGrowthRate * (1 - plantDensity)) {
                plants.push(new Plant(
                    random(GRID_WIDTH),
                    random(GRID_HEIGHT)
                ));
            }
            
            // Spread plants from existing ones
            for (let plant of plants) {
                if (plant.energy > 80 && random() < 0.01 * (1 - plantDensity)) {
                    plants.push(new Plant(
                        plant.x + random(-5, 5),
                        plant.y + random(-5, 5),
                        30
                    ));
                    plant.energy -= 30;
                }
            }
            
            // Update plants
            plants = plants.filter(p => p.update());
            
            // Update herbivores
            const newHerbivores = [];
            herbivores = herbivores.filter(h => {
                const result = h.update(plants);
                if (result === null) return false;
                if (result !== h) {
                    newHerbivores.push(result);
                }
                return true;
            });
            herbivores.push(...newHerbivores);
            
            // Update predators
            const newPredators = [];
            predators = predators.filter(p => {
                const result = p.update();
                if (result === null) return false;
                if (result !== p) {
                    newPredators.push(result);
                }
                return true;
            });
            predators.push(...newPredators);
            
            // Update generation counter
            if (newHerbivores.length > 0 || newPredators.length > 0) {
                generation++;
            }
            
            // Record history
            if (simTime % 5 === 0) {
                populationHistory.plants.push(plants.length);
                populationHistory.herbivores.push(herbivores.length);
                populationHistory.predators.push(predators.length);
                
                if (populationHistory.plants.length > MAX_HISTORY) {
                    populationHistory.plants.shift();
                    populationHistory.herbivores.shift();
                    populationHistory.predators.shift();
                }
            }
        }
        
        function draw() {
            background(20, 28, 20);
            
            if (!paused) {
                for (let i = 0; i < simSpeed; i++) {
                    updateSimulation();
                }
            }
            
            // Draw plants
            noStroke();
            for (let plant of plants) {
                const brightness = map(plant.energy, 0, plant.maxEnergy, 100, 255);
                fill(74, brightness, 80);
                const size = map(plant.energy, 0, plant.maxEnergy, 2, 4);
                rect(plant.x * CELL_SIZE, plant.y * CELL_SIZE, size, size);
            }
            
            // Draw herbivores
            for (let herb of herbivores) {
                // Color based on traits
                const hue = map(herb.speed, 0.5, 4, 180, 240);
                const sat = map(herb.vision, 1, 15, 50, 100);
                const brightness = map(herb.energy, 0, herb.maxEnergy, 50, 100);
                
                colorMode(HSB);
                fill(hue, sat, brightness);
                colorMode(RGB);
                
                const size = herb.size * CELL_SIZE * 1.5;
                ellipse(herb.x * CELL_SIZE, herb.y * CELL_SIZE, size, size);
            }
            
            // Draw predators
            for (let pred of predators) {
                // Color based on traits
                const hue = map(pred.speed, 0.5, 5, 0, 30);
                const sat = map(pred.vision, 1, 15, 60, 100);
                const brightness = map(pred.energy, 0, pred.maxEnergy, 50, 100);
                
                colorMode(HSB);
                fill(hue, sat, brightness);
                colorMode(RGB);
                
                const size = pred.size * CELL_SIZE * 2;
                // Triangle for predators
                push();
                translate(pred.x * CELL_SIZE, pred.y * CELL_SIZE);
                triangle(-size/2, size/2, size/2, size/2, 0, -size/2);
                pop();
            }
            
            // Update UI
            updateUI();
            
            // Draw graph
            if (frameCount % 10 === 0) {
                drawGraph();
            }
        }
        
        function updateUI() {
            document.getElementById('plantCount').textContent = plants.length;
            document.getElementById('herbivoreCount').textContent = herbivores.length;
            document.getElementById('predatorCount').textContent = predators.length;
            document.getElementById('generation').textContent = generation;
            document.getElementById('simTime').textContent = simTime;
            
            if (frameCount % 10 === 0) {
                document.getElementById('fps').textContent = floor(frameRate());
            }
            
            // Calculate average traits
            if (herbivores.length > 0) {
                const avgHerbSpeed = herbivores.reduce((s, h) => s + h.speed, 0) / herbivores.length;
                const avgHerbVision = herbivores.reduce((s, h) => s + h.vision, 0) / herbivores.length;
                const avgHerbSize = herbivores.reduce((s, h) => s + h.size, 0) / herbivores.length;
                
                document.getElementById('herbSpeed').textContent = avgHerbSpeed.toFixed(2);
                document.getElementById('herbVision').textContent = avgHerbVision.toFixed(2);
                document.getElementById('herbSize').textContent = avgHerbSize.toFixed(2);
            }
            
            if (predators.length > 0) {
                const avgPredSpeed = predators.reduce((s, p) => s + p.speed, 0) / predators.length;
                const avgPredVision = predators.reduce((s, p) => s + p.vision, 0) / predators.length;
                const avgPredSize = predators.reduce((s, p) => s + p.size, 0) / predators.length;
                
                document.getElementById('predSpeed').textContent = avgPredSpeed.toFixed(2);
                document.getElementById('predVision').textContent = avgPredVision.toFixed(2);
                document.getElementById('predSize').textContent = avgPredSize.toFixed(2);
            }
        }
        
        function drawGraph() {
            const w = graphCanvas.width;
            const h = graphCanvas.height;
            
            graphCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            graphCtx.fillRect(0, 0, w, h);
            
            if (populationHistory.plants.length < 2) return;
            
            const maxPop = Math.max(
                Math.max(...populationHistory.plants),
                Math.max(...populationHistory.herbivores) * 3,
                Math.max(...populationHistory.predators) * 10,
                100
            );
            
            // Draw lines
            const drawLine = (data, color, scale = 1) => {
                graphCtx.strokeStyle = color;
                graphCtx.lineWidth = 2;
                graphCtx.beginPath();
                
                for (let i = 0; i < data.length; i++) {
                    const x = (i / (MAX_HISTORY - 1)) * w;
                    const y = h - (data[i] * scale / maxPop) * h * 0.9;
                    
                    if (i === 0) graphCtx.moveTo(x, y);
                    else graphCtx.lineTo(x, y);
                }
                graphCtx.stroke();
            };
            
            drawLine(populationHistory.plants, '#4ade80', 1);
            drawLine(populationHistory.herbivores, '#60a5fa', 3);
            drawLine(populationHistory.predators, '#f87171', 10);
        }
        
        function togglePause() {
            paused = !paused;
            document.querySelector('.btn-blue').textContent = paused ? 'Resume' : 'Pause';
        }
        
        function addEntities() {
            // Add some herbivores and predators
            for (let i = 0; i < 10; i++) {
                herbivores.push(new Herbivore(
                    random(GRID_WIDTH),
                    random(GRID_HEIGHT)
                ));
            }
            for (let i = 0; i < 3; i++) {
                predators.push(new Predator(
                    random(GRID_WIDTH),
                    random(GRID_HEIGHT)
                ));
            }
        }
        
        function extinction(type) {
            if (type === 'predators') {
                predators = predators.filter(() => random() > 0.9);
            } else if (type === 'herbivores') {
                herbivores = herbivores.filter(() => random() > 0.9);
            }
        }
        
        function keyPressed() {
            if (key === ' ') {
                togglePause();
                return false;
            }
            if (key === 'r' || key === 'R') {
                resetSimulation();
            }
            if (key === 'a' || key === 'A') {
                addEntities();
            }
        }
    </script>
</body>
</html>