<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecosystem Evolution Simulation - Monte Carlo Model</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.dom.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
            color: #e0e1dd;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            text-align: center;
            padding: 25px;
            background: rgba(13, 27, 42, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(46, 213, 115, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #2ed573;
            margin-bottom: 15px;
            font-size: 2.8rem;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            color: #a8d2ff;
            font-size: 1.2rem;
            max-width: 1000px;
            margin: 0 auto 15px;
            line-height: 1.6;
        }

        .ecosystem-explanation {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .species {
            background: rgba(33, 52, 73, 0.6);
            padding: 15px 25px;
            border-radius: 12px;
            border: 1px solid;
            text-align: center;
            min-width: 180px;
        }

        .species.plants {
            border-color: #2ed573;
        }

        .species.herbivores {
            border-color: #409cff;
        }

        .species.predators {
            border-color: #ff4757;
        }

        .species h3 {
            margin-bottom: 8px;
            font-size: 1.2rem;
        }

        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .simulation-area {
            flex: 3;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #ecosystem-canvas {
            width: 100%;
            height: 600px;
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            background: rgba(5, 15, 25, 0.9);
            border: 1px solid rgba(46, 213, 115, 0.15);
        }

        .canvas-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(23, 42, 58, 0.7);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(46, 213, 115, 0.15);
        }

        .fps-counter {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
            padding: 8px 15px;
            border-radius: 8px;
        }

        .time-counter {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #409cff;
            background: rgba(64, 156, 255, 0.1);
            padding: 8px 15px;
            border-radius: 8px;
        }

        .stats-area {
            flex: 2;
            min-width: 300px;
            background: rgba(23, 42, 58, 0.7);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(46, 213, 115, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 25px;
            max-height: 800px;
            overflow-y: auto;
        }

        .stats-section {
            background: rgba(33, 52, 73, 0.6);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid;
        }

        .population-section {
            border-left-color: #2ed573;
        }

        .traits-section {
            border-left-color: #409cff;
        }

        .controls-section {
            border-left-color: #ff7b00;
        }

        h2 {
            color: #7bc8ff;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h2 i {
            font-size: 1.3rem;
        }

        .population-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(13, 27, 42, 0.6);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(64, 156, 255, 0.1);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0 5px;
            font-family: 'Courier New', monospace;
        }

        .plants-stat .stat-value {
            color: #2ed573;
        }

        .herbivores-stat .stat-value {
            color: #409cff;
        }

        .predators-stat .stat-value {
            color: #ff4757;
        }

        .stat-label {
            font-size: 1rem;
            color: #a8d2ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            height: 150px;
            background: rgba(13, 27, 42, 0.6);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }

        .trait-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .trait-item {
            background: rgba(13, 27, 42, 0.6);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(64, 156, 255, 0.1);
        }

        .trait-name {
            color: #a8d2ff;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .trait-bar {
            height: 10px;
            background: rgba(64, 156, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .trait-fill {
            height: 100%;
            border-radius: 5px;
        }

        .herbivore-trait {
            background: linear-gradient(to right, #409cff, #2a7de0);
        }

        .predator-trait {
            background: linear-gradient(to right, #ff4757, #ff3742);
        }

        .trait-value {
            font-size: 0.9rem;
            color: #e0e1dd;
            font-family: 'Courier New', monospace;
            text-align: right;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #a8d2ff;
            font-weight: 500;
            font-size: 1.05rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="range"] {
            flex: 1;
            height: 10px;
            -webkit-appearance: none;
            border-radius: 5px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 12px rgba(64, 156, 255, 0.8);
            border: 2px solid white;
        }

        .plants-slider {
            background: linear-gradient(to right, #1b5e20, #2ed573);
        }

        .plants-slider::-webkit-slider-thumb {
            background: #2ed573;
        }

        .herbivores-slider {
            background: linear-gradient(to right, #0d47a1, #409cff);
        }

        .herbivores-slider::-webkit-slider-thumb {
            background: #409cff;
        }

        .predators-slider {
            background: linear-gradient(to right, #b71c1c, #ff4757);
        }

        .predators-slider::-webkit-slider-thumb {
            background: #ff4757;
        }

        .general-slider {
            background: linear-gradient(to right, #1a3a5f, #409cff);
        }

        .general-slider::-webkit-slider-thumb {
            background: #409cff;
        }

        .value-display {
            min-width: 70px;
            text-align: center;
            background: rgba(10, 15, 35, 0.6);
            padding: 8px 12px;
            border-radius: 8px;
            color: #a8d2ff;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            border: 1px solid rgba(64, 156, 255, 0.2);
        }

        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(10, 15, 35, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(64, 156, 255, 0.1);
            transition: all 0.3s;
        }

        .toggle-group:hover {
            background: rgba(64, 156, 255, 0.1);
        }

        .toggle-label {
            color: #a8d2ff;
            font-weight: 500;
            margin: 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(64, 156, 255, 0.2);
            transition: .4s;
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #409cff;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        button {
            background: linear-gradient(to right, #2ed573, #1fab58);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            font-size: 1.05rem;
        }

        button:hover {
            background: linear-gradient(to right, #1fab58, #18944c);
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
        }

        button:active {
            transform: translateY(0);
        }

        .danger-button {
            background: linear-gradient(to right, #ff4757, #ff3742);
        }

        .danger-button:hover {
            background: linear-gradient(to right, #ff3742, #ff2b36);
        }

        .button-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 10px;
        }

        .preset-button {
            background: rgba(25, 30, 60, 0.8);
            padding: 12px;
            font-size: 0.95rem;
        }

        .keyboard-hint {
            font-size: 0.9rem;
            color: #8ab4f8;
            margin-top: 15px;
            text-align: center;
            font-style: italic;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #8ab4f8;
            font-size: 0.95rem;
            background: rgba(13, 27, 42, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(46, 213, 115, 0.2);
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .content {
                flex-direction: column;
            }
            
            .simulation-area, .stats-area {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            .stats-area {
                padding: 15px;
            }
            
            .population-stats, .trait-display {
                grid-template-columns: 1fr;
            }
            
            .ecosystem-explanation {
                flex-direction: column;
                align-items: center;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            #ecosystem-canvas {
                height: 450px;
            }
            
            .button-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ecosystem Evolution Simulation</h1>
            <p class="subtitle">A Monte Carlo simulation of evolutionary dynamics with plants, herbivores, and predators. Watch emergent patterns like predator-prey cycles, extinction events, and adaptation through genetic mutation.</p>
            
            <div class="ecosystem-explanation">
                <div class="species plants">
                    <h3 style="color: #2ed573;">üå± Plants</h3>
                    <p>Grow based on local density<br>Energy source for herbivores</p>
                </div>
                <div class="species herbivores">
                    <h3 style="color: #409cff;">ü¶å Herbivores</h3>
                    <p>Eat plants to gain energy<br>Evolve speed, vision, reproduction</p>
                </div>
                <div class="species predators">
                    <h3 style="color: #ff4757;">üê∫ Predators</h3>
                    <p>Hunt herbivores for energy<br>Evolve hunting traits</p>
                </div>
            </div>
        </header>
        
        <div class="content">
            <div class="simulation-area">
                <div id="ecosystem-canvas"></div>
                <div class="canvas-info">
                    <div class="fps-counter">FPS: 60</div>
                    <div class="time-counter">Generation: 0</div>
                    <div class="value-display" id="simulation-speed">1.0x</div>
                </div>
            </div>
            
            <div class="stats-area">
                <div class="stats-section population-section">
                    <h2>Population Statistics</h2>
                    
                    <div class="population-stats">
                        <div class="stat-item plants-stat">
                            <div class="stat-label">Plants</div>
                            <div class="stat-value" id="plant-count">0</div>
                            <div class="stat-label">Density: <span id="plant-density">0.0</span></div>
                        </div>
                        
                        <div class="stat-item herbivores-stat">
                            <div class="stat-label">Herbivores</div>
                            <div class="stat-value" id="herbivore-count">0</div>
                            <div class="stat-label">Avg Energy: <span id="herbivore-energy">0</span></div>
                        </div>
                        
                        <div class="stat-item predators-stat">
                            <div class="stat-label">Predators</div>
                            <div class="stat-value" id="predator-count">0</div>
                            <div class="stat-label">Avg Energy: <span id="predator-energy">0</span></div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-label">Total Interactions</div>
                            <div class="stat-value" id="total-interactions">0</div>
                            <div class="stat-label">Per Second</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="population-chart"></canvas>
                    </div>
                </div>
                
                <div class="stats-section traits-section">
                    <h2>Evolutionary Traits</h2>
                    
                    <div class="trait-display">
                        <div class="trait-item">
                            <div class="trait-name">Herbivore Speed</div>
                            <div class="trait-bar">
                                <div class="trait-fill herbivore-trait" id="herbivore-speed-bar" style="width: 50%"></div>
                            </div>
                            <div class="trait-value" id="herbivore-speed-value">0.50</div>
                        </div>
                        
                        <div class="trait-item">
                            <div class="trait-name">Herbivore Vision</div>
                            <div class="trait-bar">
                                <div class="trait-fill herbivore-trait" id="herbivore-vision-bar" style="width: 50%"></div>
                            </div>
                            <div class="trait-value" id="herbivore-vision-value">0.50</div>
                        </div>
                        
                        <div class="trait-item">
                            <div class="trait-name">Predator Speed</div>
                            <div class="trait-bar">
                                <div class="trait-fill predator-trait" id="predator-speed-bar" style="width: 50%"></div>
                            </div>
                            <div class="trait-value" id="predator-speed-value">0.50</div>
                        </div>
                        
                        <div class="trait-item">
                            <div class="trait-name">Predator Vision</div>
                            <div class="trait-bar">
                                <div class="trait-fill predator-trait" id="predator-vision-bar" style="width: 50%"></div>
                            </div>
                            <div class="trait-value" id="predator-vision-value">0.50</div>
                        </div>
                    </div>
                    
                    <div class="keyboard-hint">
                        Traits evolve through mutation during reproduction. Faster, sharper-eyed individuals survive longer.
                    </div>
                </div>
                
                <div class="stats-section controls-section">
                    <h2>Simulation Controls</h2>
                    
                    <div class="control-group">
                        <label>Simulation Speed: <span id="speed-value">1.0</span>x</label>
                        <div class="slider-container">
                            <input type="range" id="sim-speed" class="general-slider" min="0.1" max="5" value="1.0" step="0.1">
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <div class="toggle-group">
                            <span class="toggle-label">Pause Simulation</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="pause-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-group">
                            <span class="toggle-label">Show Grid</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="grid-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="button-row">
                        <button id="reset-button">
                            <span>üîÑ</span>
                            <span>Reset Simulation</span>
                        </button>
                        <button id="randomize-button" class="danger-button">
                            <span>üé≤</span>
                            <span>Randomize Parameters</span>
                        </button>
                    </div>
                    
                    <div class="keyboard-hint">
                        Keyboard: SPACE = Pause, R = Reset, 1-3 = Adjust Speed, G = Toggle Grid
                    </div>
                </div>
                
                <div class="stats-section controls-section">
                    <h2>Ecosystem Parameters</h2>
                    
                    <div class="control-group">
                        <label>Plant Growth Rate: <span id="plant-growth-value">0.05</span></label>
                        <div class="slider-container">
                            <input type="range" id="plant-growth" class="plants-slider" min="0.01" max="0.2" value="0.05" step="0.01">
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>Herbivore Reproduction: <span id="herbivore-repro-value">0.02</span></label>
                        <div class="slider-container">
                            <input type="range" id="herbivore-repro" class="herbivores-slider" min="0.005" max="0.05" value="0.02" step="0.005">
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>Predator Reproduction: <span id="predator-repro-value">0.01</span></label>
                        <div class="slider-container">
                            <input type="range" id="predator-repro" class="predators-slider" min="0.002" max="0.03" value="0.01" step="0.002">
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>Mutation Rate: <span id="mutation-value">0.1</span></label>
                        <div class="slider-container">
                            <input type="range" id="mutation-rate" class="general-slider" min="0" max="0.5" value="0.1" step="0.05">
                        </div>
                    </div>
                    
                    <div class="preset-buttons">
                        <button class="preset-button" id="preset-balanced">Balanced</button>
                        <button class="preset-button" id="preset-predator-dominant">Predator Dominant</button>
                        <button class="preset-button" id="preset-herbivore-dominant">Herbivore Dominant</button>
                        <button class="preset-button" id="preset-high-mutation">High Mutation</button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Monte Carlo Ecosystem Simulation | Evolutionary Dynamics | Emergent Patterns in Complex Systems</p>
        </footer>
    </div>

    <script>
// Ecosystem Simulation Class
class EcosystemSimulation {
    constructor() {
        // Grid dimensions
        this.gridWidth = 80;
        this.gridHeight = 60;
        this.cellSize = 10;
        
        // Grid arrays
        this.plants = []; // 2D array of plant energy (0 = no plant)
        this.herbivores = []; // Array of herbivore objects
        this.predators = []; // Array of predator objects
        
        // Simulation parameters
        this.params = {
            // Plant parameters
            plantGrowthRate: 0.05,
            plantMaxEnergy: 1.0,
            plantCarryingCapacity: 0.8, // Max density
            plantSpreadProb: 0.01,
            
            // Herbivore parameters
            herbivoreInitialEnergy: 50,
            herbivoreEnergyGain: 15,
            herbivoreEnergyLoss: 1,
            herbivoreReproEnergy: 30,
            herbivoreReproProb: 0.02,
            herbivoreMutationRate: 0.1,
            
            // Predator parameters
            predatorInitialEnergy: 60,
            predatorEnergyGain: 25,
            predatorEnergyLoss: 2,
            predatorReproEnergy: 40,
            predatorReproProb: 0.01,
            predatorMutationRate: 0.1,
            
            // General parameters
            maxPopulationDensity: 0.2, // Max agents per cell
            simulationSpeed: 1.0,
            showGrid: true
        };
        
        // Statistics
        this.stats = {
            plantCount: 0,
            herbivoreCount: 0,
            predatorCount: 0,
            generation: 0,
            totalInteractions: 0,
            herbivoreAvgSpeed: 0.5,
            herbivoreAvgVision: 0.5,
            predatorAvgSpeed: 0.5,
            predatorAvgVision: 0.5,
            herbivoreAvgEnergy: 0,
            predatorAvgEnergy: 0,
            plantDensity: 0
        };
        
        // History for charts
        this.history = {
            plants: [],
            herbivores: [],
            predators: [],
            time: []
        };
        
        // Control state
        this.isPaused = false;
        this.lastUpdateTime = 0;
        this.fps = 60;
        
        // Initialize the grid
        this.initGrid();
        
        // Set up UI controls
        this.setupControls();
        
        // Initialize chart
        this.initChart();
    }
    
    // Initialize the grid with plants and creatures
    initGrid() {
        // Initialize plants grid
        this.plants = [];
        for (let x = 0; x < this.gridWidth; x++) {
            this.plants[x] = [];
            for (let y = 0; y < this.gridHeight; y++) {
                // Random initial plants
                this.plants[x][y] = Math.random() < 0.3 ? Math.random() * this.params.plantMaxEnergy : 0;
            }
        }
        
        // Clear creatures
        this.herbivores = [];
        this.predators = [];
        
        // Add initial herbivores
        for (let i = 0; i < 50; i++) {
            this.addHerbivore(
                Math.floor(Math.random() * this.gridWidth),
                Math.floor(Math.random() * this.gridHeight)
            );
        }
        
        // Add initial predators
        for (let i = 0; i < 15; i++) {
            this.addPredator(
                Math.floor(Math.random() * this.gridWidth),
                Math.floor(Math.random() * this.gridHeight)
            );
        }
        
        // Reset stats
        this.stats.generation = 0;
        this.stats.totalInteractions = 0;
        this.updateStats();
    }
    
    // Add a herbivore to the simulation
    addHerbivore(x, y, parent = null) {
        const herbivore = {
            x: x,
            y: y,
            energy: this.params.herbivoreInitialEnergy,
            speed: parent ? this.mutateTrait(parent.speed) : 0.3 + Math.random() * 0.4,
            vision: parent ? this.mutateTrait(parent.vision) : 0.3 + Math.random() * 0.4,
            reproductionCount: 0,
            age: 0,
            id: Math.random().toString(36).substr(2, 9)
        };
        
        // Ensure values are within bounds
        herbivore.speed = Math.max(0.1, Math.min(1.0, herbivore.speed));
        herbivore.vision = Math.max(0.1, Math.min(1.0, herbivore.vision));
        
        this.herbivores.push(herbivore);
        return herbivore;
    }
    
    // Add a predator to the simulation
    addPredator(x, y, parent = null) {
        const predator = {
            x: x,
            y: y,
            energy: this.params.predatorInitialEnergy,
            speed: parent ? this.mutateTrait(parent.speed) : 0.4 + Math.random() * 0.4,
            vision: parent ? this.mutateTrait(parent.vision) : 0.4 + Math.random() * 0.4,
            reproductionCount: 0,
            age: 0,
            id: Math.random().toString(36).substr(2, 9)
        };
        
        // Ensure values are within bounds
        predator.speed = Math.max(0.1, Math.min(1.0, predator.speed));
        predator.vision = Math.max(0.1, Math.min(1.0, predator.vision));
        
        this.predators.push(predator);
        return predator;
    }
    
    // Mutate a trait value
    mutateTrait(value) {
        if (Math.random() < this.params.herbivoreMutationRate) {
            // Gaussian mutation with small standard deviation
            const mutation = (Math.random() - 0.5) * 0.2;
            return value + mutation;
        }
        return value;
    }
    
    // Update the entire simulation (Monte Carlo step)
    update() {
        if (this.isPaused) return;
        
        // Update plants
        this.updatePlants();
        
        // Update herbivores
        this.updateHerbivores();
        
        // Update predators
        this.updatePredators();
        
        // Remove dead creatures
        this.cleanupCreatures();
        
        // Update statistics
        this.updateStats();
        this.recordHistory();
        
        this.stats.generation++;
    }
    
    // Update plant growth and spread
    updatePlants() {
        // Update existing plants
        for (let x = 0; x < this.gridWidth; x++) {
            for (let y = 0; y < this.gridHeight; y++) {
                if (this.plants[x][y] > 0) {
                    // Plants grow based on density
                    const localDensity = this.getPlantDensity(x, y, 2);
                    const growthFactor = 1 - (localDensity / this.params.plantCarryingCapacity);
                    
                    if (growthFactor > 0) {
                        this.plants[x][y] += this.params.plantGrowthRate * growthFactor;
                        this.plants[x][y] = Math.min(this.plants[x][y], this.params.plantMaxEnergy);
                    }
                } else {
                    // Chance for new plant to grow
                    if (Math.random() < this.params.plantSpreadProb) {
                        const localDensity = this.getPlantDensity(x, y, 2);
                        if (localDensity > 0 && localDensity < this.params.plantCarryingCapacity) {
                            this.plants[x][y] = 0.1;
                        }
                    }
                }
            }
        }
    }
    
    // Get plant density in an area
    getPlantDensity(x, y, radius) {
        let count = 0;
        let total = 0;
        
        for (let dx = -radius; dx <= radius; dx++) {
            for (let dy = -radius; dy <= radius; dy++) {
                const nx = (x + dx + this.gridWidth) % this.gridWidth;
                const ny = (y + dy + this.gridHeight) % this.gridHeight;
                
                if (this.plants[nx][ny] > 0) {
                    count++;
                }
                total++;
            }
        }
        
        return count / total;
    }
    
    // Update herbivores (movement, feeding, reproduction)
    updateHerbivores() {
        // Shuffle herbivores for random order (Monte Carlo)
        this.shuffleArray(this.herbivores);
        
        for (const herbivore of this.herbivores) {
            // Age and energy loss
            herbivore.age++;
            herbivore.energy -= this.params.herbivoreEnergyLoss;
            
            // Skip if dead
            if (herbivore.energy <= 0) continue;
            
            // Movement
            this.moveHerbivore(herbivore);
            
            // Feeding
            this.feedHerbivore(herbivore);
            
            // Reproduction
            this.reproduceHerbivore(herbivore);
            
            // Random death chance (old age, disease, etc.)
            if (Math.random() < 0.001) {
                herbivore.energy = 0;
            }
        }
    }
    
    // Move a herbivore
    moveHerbivore(herbivore) {
        // Calculate movement based on speed
        const moveDist = Math.floor(herbivore.speed * 3) + 1;
        
        // Look for plants in vision range
        const visionRadius = Math.floor(herbivore.vision * 5) + 1;
        let bestPlant = null;
        let bestDist = Infinity;
        
        for (let dx = -visionRadius; dx <= visionRadius; dx++) {
            for (let dy = -visionRadius; dy <= visionRadius; dy++) {
                const nx = (herbivore.x + dx + this.gridWidth) % this.gridWidth;
                const ny = (herbivore.y + dy + this.gridHeight) % this.gridHeight;
                
                if (this.plants[nx][ny] > 0) {
                    const dist = Math.abs(dx) + Math.abs(dy);
                    if (dist < bestDist) {
                        bestDist = dist;
                        bestPlant = { x: nx, y: ny };
                    }
                }
            }
        }
        
        // Move towards plant if found, otherwise random
        if (bestPlant) {
            // Move towards the plant
            const dx = bestPlant.x - herbivore.x;
            const dy = bestPlant.y - herbivore.y;
            
            // Handle toroidal wrapping
            const wrappedDx = this.wrapDistance(dx, this.gridWidth);
            const wrappedDy = this.wrapDistance(dy, this.gridHeight);
            
            // Move in the direction of the plant
            if (Math.abs(wrappedDx) > 0 && Math.random() < 0.7) {
                herbivore.x = (herbivore.x + Math.sign(wrappedDx) + this.gridWidth) % this.gridWidth;
            }
            if (Math.abs(wrappedDy) > 0 && Math.random() < 0.7) {
                herbivore.y = (herbivore.y + Math.sign(wrappedDy) + this.gridHeight) % this.gridHeight;
            }
        } else {
            // Random movement
            for (let i = 0; i < moveDist; i++) {
                if (Math.random() < 0.5) {
                    herbivore.x = (herbivore.x + (Math.random() < 0.5 ? 1 : -1) + this.gridWidth) % this.gridWidth;
                } else {
                    herbivore.y = (herbivore.y + (Math.random() < 0.5 ? 1 : -1) + this.gridHeight) % this.gridHeight;
                }
            }
        }
    }
    
    // Feed a herbivore
    feedHerbivore(herbivore) {
        // Check if there's a plant at current location
        if (this.plants[herbivore.x][herbivore.y] > 0) {
            // Eat the plant
            const energyGained = Math.min(this.plants[herbivore.x][herbivore.y], this.params.herbivoreEnergyGain);
            herbivore.energy += energyGained;
            this.plants[herbivore.x][herbivore.y] -= energyGained;
            
            // Track interaction
            this.stats.totalInteractions++;
        }
    }
    
    // Herbivore reproduction
    reproduceHerbivore(herbivore) {
        // Check if enough energy for reproduction
        if (herbivore.energy >= this.params.herbivoreReproEnergy && 
            Math.random() < this.params.herbivoreReproProb) {
            
            // Check population density
            const localDensity = this.getCreatureDensity(herbivore.x, herbivore.y, 2);
            if (localDensity < this.params.maxPopulationDensity) {
                // Create offspring
                const offspring = this.addHerbivore(
                    herbivore.x,
                    herbivore.y,
                    herbivore
                );
                
                // Transfer some energy to offspring
                const energyTransfer = herbivore.energy * 0.3;
                offspring.energy = energyTransfer;
                herbivore.energy -= energyTransfer;
                
                herbivore.reproductionCount++;
                
                // Track interaction
                this.stats.totalInteractions++;
            }
        }
    }
    
    // Update predators (movement, hunting, reproduction)
    updatePredators() {
        // Shuffle predators for random order
        this.shuffleArray(this.predators);
        
        for (const predator of this.predators) {
            // Age and energy loss
            predator.age++;
            predator.energy -= this.params.predatorEnergyLoss;
            
            // Skip if dead
            if (predator.energy <= 0) continue;
            
            // Movement
            this.movePredator(predator);
            
            // Hunting
            this.huntPredator(predator);
            
            // Reproduction
            this.reproducePredator(predator);
            
            // Random death chance
            if (Math.random() < 0.001) {
                predator.energy = 0;
            }
        }
    }
    
    // Move a predator
    movePredator(predator) {
        // Calculate movement based on speed
        const moveDist = Math.floor(predator.speed * 3) + 1;
        
        // Look for herbivores in vision range
        const visionRadius = Math.floor(predator.vision * 5) + 1;
        let bestHerbivore = null;
        let bestDist = Infinity;
        
        for (const herbivore of this.herbivores) {
            if (herbivore.energy <= 0) continue;
            
            const dx = herbivore.x - predator.x;
            const dy = herbivore.y - predator.y;
            
            // Handle toroidal wrapping
            const wrappedDx = this.wrapDistance(dx, this.gridWidth);
            const wrappedDy = this.wrapDistance(dy, this.gridHeight);
            
            const dist = Math.abs(wrappedDx) + Math.abs(wrappedDy);
            if (dist <= visionRadius && dist < bestDist) {
                bestDist = dist;
                bestHerbivore = herbivore;
            }
        }
        
        // Move towards herbivore if found, otherwise random
        if (bestHerbivore) {
            // Move towards the herbivore
            const dx = bestHerbivore.x - predator.x;
            const dy = bestHerbivore.y - predator.y;
            
            // Handle toroidal wrapping
            const wrappedDx = this.wrapDistance(dx, this.gridWidth);
            const wrappedDy = this.wrapDistance(dy, this.gridHeight);
            
            // Move in the direction of the herbivore
            if (Math.abs(wrappedDx) > 0 && Math.random() < 0.7) {
                predator.x = (predator.x + Math.sign(wrappedDx) + this.gridWidth) % this.gridWidth;
            }
            if (Math.abs(wrappedDy) > 0 && Math.random() < 0.7) {
                predator.y = (predator.y + Math.sign(wrappedDy) + this.gridHeight) % this.gridHeight;
            }
        } else {
            // Random movement
            for (let i = 0; i < moveDist; i++) {
                if (Math.random() < 0.5) {
                    predator.x = (predator.x + (Math.random() < 0.5 ? 1 : -1) + this.gridWidth) % this.gridWidth;
                } else {
                    predator.y = (predator.y + (Math.random() < 0.5 ? 1 : -1) + this.gridHeight) % this.gridHeight;
                }
            }
        }
    }
    
    // Predator hunting
    huntPredator(predator) {
        // Check if there's a herbivore at current location
        for (const herbivore of this.herbivores) {
            if (herbivore.energy <= 0) continue;
            
            if (herbivore.x === predator.x && herbivore.y === predator.y) {
                // Hunt the herbivore
                predator.energy += this.params.predatorEnergyGain;
                herbivore.energy = 0; // Kill the herbivore
                
                // Track interaction
                this.stats.totalInteractions++;
                break;
            }
        }
    }
    
    // Predator reproduction
    reproducePredator(predator) {
        // Check if enough energy for reproduction
        if (predator.energy >= this.params.predatorReproEnergy && 
            Math.random() < this.params.predatorReproProb) {
            
            // Check population density
            const localDensity = this.getCreatureDensity(predator.x, predator.y, 2);
            if (localDensity < this.params.maxPopulationDensity) {
                // Create offspring
                const offspring = this.addPredator(
                    predator.x,
                    predator.y,
                    predator
                );
                
                // Transfer some energy to offspring
                const energyTransfer = predator.energy * 0.3;
                offspring.energy = energyTransfer;
                predator.energy -= energyTransfer;
                
                predator.reproductionCount++;
                
                // Track interaction
                this.stats.totalInteractions++;
            }
        }
    }
    
    // Get creature density in an area
    getCreatureDensity(x, y, radius) {
        let count = 0;
        
        // Count herbivores
        for (const herbivore of this.herbivores) {
            if (herbivore.energy <= 0) continue;
            
            const dx = herbivore.x - x;
            const dy = herbivore.y - y;
            
            // Handle toroidal wrapping
            const wrappedDx = this.wrapDistance(dx, this.gridWidth);
            const wrappedDy = this.wrapDistance(dy, this.gridHeight);
            
            if (Math.abs(wrappedDx) <= radius && Math.abs(wrappedDy) <= radius) {
                count++;
            }
        }
        
        // Count predators
        for (const predator of this.predators) {
            if (predator.energy <= 0) continue;
            
            const dx = predator.x - x;
            const dy = predator.y - y;
            
            // Handle toroidal wrapping
            const wrappedDx = this.wrapDistance(dx, this.gridWidth);
            const wrappedDy = this.wrapDistance(dy, this.gridHeight);
            
            if (Math.abs(wrappedDx) <= radius && Math.abs(wrappedDy) <= radius) {
                count++;
            }
        }
        
        const area = (radius * 2 + 1) * (radius * 2 + 1);
        return count / area;
    }
    
    // Calculate wrapped distance for toroidal grid
    wrapDistance(d, size) {
        if (d > size / 2) return d - size;
        if (d < -size / 2) return d + size;
        return d;
    }
    
    // Remove dead creatures
    cleanupCreatures() {
        // Remove dead herbivores
        this.herbivores = this.herbivores.filter(h => h.energy > 0);
        
        // Remove dead predators
        this.predators = this.predators.filter(p => p.energy > 0);
        
        // Remove dead plants (energy too low)
        for (let x = 0; x < this.gridWidth; x++) {
            for (let y = 0; y < this.gridHeight; y++) {
                if (this.plants[x][y] < 0.05) {
                    this.plants[x][y] = 0;
                }
            }
        }
    }
    
    // Update statistics
    updateStats() {
        // Count plants
        let plantCount = 0;
        for (let x = 0; x < this.gridWidth; x++) {
            for (let y = 0; y < this.gridHeight; y++) {
                if (this.plants[x][y] > 0) plantCount++;
            }
        }
        this.stats.plantCount = plantCount;
        this.stats.plantDensity = plantCount / (this.gridWidth * this.gridHeight);
        
        // Herbivore stats
        this.stats.herbivoreCount = this.herbivores.length;
        let herbivoreEnergySum = 0;
        let herbivoreSpeedSum = 0;
        let herbivoreVisionSum = 0;
        
        for (const herbivore of this.herbivores) {
            herbivoreEnergySum += herbivore.energy;
            herbivoreSpeedSum += herbivore.speed;
            herbivoreVisionSum += herbivore.vision;
        }
        
        this.stats.herbivoreAvgEnergy = this.herbivores.length > 0 ? 
            Math.round(herbivoreEnergySum / this.herbivores.length) : 0;
        this.stats.herbivoreAvgSpeed = this.herbivores.length > 0 ? 
            herbivoreSpeedSum / this.herbivores.length : 0.5;
        this.stats.herbivoreAvgVision = this.herbivores.length > 0 ? 
            herbivoreVisionSum / this.herbivores.length : 0.5;
        
        // Predator stats
        this.stats.predatorCount = this.predators.length;
        let predatorEnergySum = 0;
        let predatorSpeedSum = 0;
        let predatorVisionSum = 0;
        
        for (const predator of this.predators) {
            predatorEnergySum += predator.energy;
            predatorSpeedSum += predator.speed;
            predatorVisionSum += predator.vision;
        }
        
        this.stats.predatorAvgEnergy = this.predators.length > 0 ? 
            Math.round(predatorEnergySum / this.predators.length) : 0;
        this.stats.predatorAvgSpeed = this.predators.length > 0 ? 
            predatorSpeedSum / this.predators.length : 0.5;
        this.stats.predatorAvgVision = this.predators.length > 0 ? 
            predatorVisionSum / this.predators.length : 0.5;
    }
    
    // Record history for charts
    recordHistory() {
        // Only record every 10 generations to keep history manageable
        if (this.stats.generation % 10 === 0) {
            this.history.plants.push(this.stats.plantCount);
            this.history.herbivores.push(this.stats.herbivoreCount);
            this.history.predators.push(this.stats.predatorCount);
            this.history.time.push(this.stats.generation);
            
            // Limit history size
            const maxHistory = 100;
            if (this.history.plants.length > maxHistory) {
                this.history.plants.shift();
                this.history.herbivores.shift();
                this.history.predators.shift();
                this.history.time.shift();
            }
        }
    }
    
    // Shuffle array (for Monte Carlo randomness)
    shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }
    
    // Draw the ecosystem
    draw(canvas) {
        // Clear with slight transparency for motion blur effect
        canvas.clear();
        
        // Draw grid background
        if (this.params.showGrid) {
            canvas.strokeWeight(0.5);
            canvas.stroke(30, 40, 70, 30);
            
            for (let x = 0; x < this.gridWidth; x++) {
                const screenX = x * this.cellSize;
                canvas.line(screenX, 0, screenX, canvas.height);
            }
            for (let y = 0; y < this.gridHeight; y++) {
                const screenY = y * this.cellSize;
                canvas.line(0, screenY, canvas.width, screenY);
            }
        }
        
        // Draw plants
        for (let x = 0; x < this.gridWidth; x++) {
            for (let y = 0; y < this.gridHeight; y++) {
                if (this.plants[x][y] > 0) {
                    const energy = this.plants[x][y];
                    const screenX = x * this.cellSize;
                    const screenY = y * this.cellSize;
                    
                    // Color based on energy
                    const greenValue = 100 + Math.floor(155 * (energy / this.params.plantMaxEnergy));
                    canvas.fill(0, greenValue, 0, 150);
                    canvas.noStroke();
                    canvas.rect(screenX, screenY, this.cellSize, this.cellSize);
                }
            }
        }
        
        // Draw herbivores
        canvas.noStroke();
        for (const herbivore of this.herbivores) {
            const screenX = herbivore.x * this.cellSize + this.cellSize / 2;
            const screenY = herbivore.y * this.cellSize + this.cellSize / 2;
            
            // Size based on energy
            const size = 3 + (herbivore.energy / this.params.herbivoreInitialEnergy) * 4;
            
            // Color based on speed (blue gradient)
            const blueValue = 150 + Math.floor(105 * herbivore.speed);
            canvas.fill(100, 150, blueValue, 200);
            canvas.circle(screenX, screenY, size);
            
            // Draw vision range indicator
            if (herbivore.vision > 0.7) {
                canvas.noFill();
                canvas.stroke(100, 150, blueValue, 50);
                canvas.strokeWeight(1);
                const visionRadius = herbivore.vision * 20;
                canvas.circle(screenX, screenY, visionRadius);
            }
        }
        
        // Draw predators
        for (const predator of this.predators) {
            const screenX = predator.x * this.cellSize + this.cellSize / 2;
            const screenY = predator.y * this.cellSize + this.cellSize / 2;
            
            // Size based on energy
            const size = 4 + (predator.energy / this.params.predatorInitialEnergy) * 5;
            
            // Color based on speed (red gradient)
            const redValue = 150 + Math.floor(105 * predator.speed);
            canvas.fill(redValue, 50, 50, 200);
            canvas.circle(screenX, screenY, size);
            
            // Draw vision range indicator
            if (predator.vision > 0.7) {
                canvas.noFill();
                canvas.stroke(redValue, 50, 50, 50);
                canvas.strokeWeight(1);
                const visionRadius = predator.vision * 20;
                canvas.circle(screenX, screenY, visionRadius);
            }
        }
        
        // Update UI displays
        this.updateUI();
    }
    
    // Update UI elements with current stats
    updateUI() {
        // Update population counts
        document.getElementById('plant-count').textContent = this.stats.plantCount;
        document.getElementById('plant-density').textContent = this.stats.plantDensity.toFixed(2);
        document.getElementById('herbivore-count').textContent = this.stats.herbivoreCount;
        document.getElementById('herbivore-energy').textContent = this.stats.herbivoreAvgEnergy;
        document.getElementById('predator-count').textContent = this.stats.predatorCount;
        document.getElementById('predator-energy').textContent = this.stats.predatorAvgEnergy;
        document.getElementById('total-interactions').textContent = this.stats.totalInteractions;
        
        // Update trait displays
        document.getElementById('herbivore-speed-value').textContent = this.stats.herbivoreAvgSpeed.toFixed(2);
        document.getElementById('herbivore-vision-value').textContent = this.stats.herbivoreAvgVision.toFixed(2);
        document.getElementById('predator-speed-value').textContent = this.stats.predatorAvgSpeed.toFixed(2);
        document.getElementById('predator-vision-value').textContent = this.stats.predatorAvgVision.toFixed(2);
        
        // Update trait bars
        document.getElementById('herbivore-speed-bar').style.width = `${this.stats.herbivoreAvgSpeed * 100}%`;
        document.getElementById('herbivore-vision-bar').style.width = `${this.stats.herbivoreAvgVision * 100}%`;
        document.getElementById('predator-speed-bar').style.width = `${this.stats.predatorAvgSpeed * 100}%`;
        document.getElementById('predator-vision-bar').style.width = `${this.stats.predatorAvgVision * 100}%`;
        
        // Update generation counter
        document.querySelector('.time-counter').textContent = `Generation: ${this.stats.generation}`;
        
        // Update chart
        this.updateChart();
    }
    
    // Initialize the population chart
    initChart() {
        const canvas = document.getElementById('population-chart');
        if (!canvas) return;
        
        this.chartCanvas = canvas;
        this.chartContext = canvas.getContext('2d');
        
        // Set canvas size
        this.chartCanvas.width = canvas.offsetWidth;
        this.chartCanvas.height = canvas.offsetHeight;
    }
    
    // Update the population chart
    updateChart() {
        if (!this.chartContext || this.history.time.length < 2) return;
        
        const ctx = this.chartContext;
        const width = this.chartCanvas.width;
        const height = this.chartCanvas.height;
        
        // Clear chart
        ctx.clearRect(0, 0, width, height);
        
        // Find max population for scaling
        const maxPlants = Math.max(...this.history.plants);
        const maxHerbivores = Math.max(...this.history.herbivores);
        const maxPredators = Math.max(...this.history.predators);
        const maxPopulation = Math.max(maxPlants, maxHerbivores, maxPredators, 1);
        
        // Draw grid
        ctx.strokeStyle = 'rgba(64, 156, 255, 0.1)';
        ctx.lineWidth = 1;
        
        // Horizontal lines
        for (let i = 0; i <= 5; i++) {
            const y = height - (i * height / 5);
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
        }
        
        // Draw lines
        const timePoints = this.history.time.length;
        
        // Plants line (green)
        ctx.beginPath();
        ctx.strokeStyle = '#2ed573';
        ctx.lineWidth = 2;
        for (let i = 0; i < timePoints; i++) {
            const x = (i / (timePoints - 1)) * width;
            const y = height - (this.history.plants[i] / maxPopulation) * height;
            
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();
        
        // Herbivores line (blue)
        ctx.beginPath();
        ctx.strokeStyle = '#409cff';
        ctx.lineWidth = 2;
        for (let i = 0; i < timePoints; i++) {
            const x = (i / (timePoints - 1)) * width;
            const y = height - (this.history.herbivores[i] / maxPopulation) * height;
            
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();
        
        // Predators line (red)
        ctx.beginPath();
        ctx.strokeStyle = '#ff4757';
        ctx.lineWidth = 2;
        for (let i = 0; i < timePoints; i++) {
            const x = (i / (timePoints - 1)) * width;
            const y = height - (this.history.predators[i] / maxPopulation) * height;
            
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();
    }
    
    // Setup UI controls
    setupControls() {
        // Simulation speed slider
        const speedSlider = document.getElementById('sim-speed');
        const speedValue = document.getElementById('speed-value');
        
        speedSlider.addEventListener('input', () => {
            this.params.simulationSpeed = parseFloat(speedSlider.value);
            speedValue.textContent = this.params.simulationSpeed.toFixed(1);
            document.getElementById('simulation-speed').textContent = `${this.params.simulationSpeed.toFixed(1)}x`;
        });
        
        // Plant growth slider
        const plantGrowthSlider = document.getElementById('plant-growth');
        const plantGrowthValue = document.getElementById('plant-growth-value');
        
        plantGrowthSlider.addEventListener('input', () => {
            this.params.plantGrowthRate = parseFloat(plantGrowthSlider.value);
            plantGrowthValue.textContent = this.params.plantGrowthRate.toFixed(2);
        });
        
        // Herbivore reproduction slider
        const herbivoreReproSlider = document.getElementById('herbivore-repro');
        const herbivoreReproValue = document.getElementById('herbivore-repro-value');
        
        herbivoreReproSlider.addEventListener('input', () => {
            this.params.herbivoreReproProb = parseFloat(herbivoreReproSlider.value);
            herbivoreReproValue.textContent = this.params.herbivoreReproProb.toFixed(3);
        });
        
        // Predator reproduction slider
        const predatorReproSlider = document.getElementById('predator-repro');
        const predatorReproValue = document.getElementById('predator-repro-value');
        
        predatorReproSlider.addEventListener('input', () => {
            this.params.predatorReproProb = parseFloat(predatorReproSlider.value);
            predatorReproValue.textContent = this.params.predatorReproProb.toFixed(3);
        });
        
        // Mutation rate slider
        const mutationSlider = document.getElementById('mutation-rate');
        const mutationValue = document.getElementById('mutation-value');
        
        mutationSlider.addEventListener('input', () => {
            const mutationRate = parseFloat(mutationSlider.value);
            this.params.herbivoreMutationRate = mutationRate;
            this.params.predatorMutationRate = mutationRate;
            mutationValue.textContent = mutationRate.toFixed(2);
        });
        
        // Pause toggle
        const pauseToggle = document.getElementById('pause-toggle');
        pauseToggle.addEventListener('change', () => {
            this.isPaused = pauseToggle.checked;
        });
        
        // Grid toggle
        const gridToggle = document.getElementById('grid-toggle');
        gridToggle.addEventListener('change', () => {
            this.params.showGrid = gridToggle.checked;
        });
        
        // Reset button
        document.getElementById('reset-button').addEventListener('click', () => {
            this.initGrid();
            // Reset history
            this.history = {
                plants: [],
                herbivores: [],
                predators: [],
                time: []
            };
            this.updateChart();
        });
        
        // Randomize button
        document.getElementById('randomize-button').addEventListener('click', () => {
            // Randomize parameters
            this.params.plantGrowthRate = 0.02 + Math.random() * 0.1;
            this.params.herbivoreReproProb = 0.01 + Math.random() * 0.03;
            this.params.predatorReproProb = 0.005 + Math.random() * 0.02;
            this.params.herbivoreMutationRate = 0.05 + Math.random() * 0.2;
            this.params.predatorMutationRate = this.params.herbivoreMutationRate;
            
            // Update sliders
            plantGrowthSlider.value = this.params.plantGrowthRate;
            plantGrowthValue.textContent = this.params.plantGrowthRate.toFixed(2);
            herbivoreReproSlider.value = this.params.herbivoreReproProb;
            herbivoreReproValue.textContent = this.params.herbivoreReproProb.toFixed(3);
            predatorReproSlider.value = this.params.predatorReproProb;
            predatorReproValue.textContent = this.params.predatorReproProb.toFixed(3);
            mutationSlider.value = this.params.herbivoreMutationRate;
            mutationValue.textContent = this.params.herbivoreMutationRate.toFixed(2);
            
            // Reinitialize grid with new parameters
            this.initGrid();
        });
        
        // Preset buttons
        document.getElementById('preset-balanced').addEventListener('click', () => {
            this.params.plantGrowthRate = 0.05;
            this.params.herbivoreReproProb = 0.02;
            this.params.predatorReproProb = 0.01;
            this.params.herbivoreMutationRate = 0.1;
            this.params.predatorMutationRate = 0.1;
            
            plantGrowthSlider.value = 0.05;
            plantGrowthValue.textContent = '0.05';
            herbivoreReproSlider.value = 0.02;
            herbivoreReproValue.textContent = '0.020';
            predatorReproSlider.value = 0.01;
            predatorReproValue.textContent = '0.010';
            mutationSlider.value = 0.1;
            mutationValue.textContent = '0.10';
            
            this.initGrid();
        });
        
        document.getElementById('preset-predator-dominant').addEventListener('click', () => {
            this.params.plantGrowthRate = 0.08;
            this.params.herbivoreReproProb = 0.03;
            this.params.predatorReproProb = 0.005;
            this.params.herbivoreMutationRate = 0.15;
            this.params.predatorMutationRate = 0.15;
            
            plantGrowthSlider.value = 0.08;
            plantGrowthValue.textContent = '0.08';
            herbivoreReproSlider.value = 0.03;
            herbivoreReproValue.textContent = '0.030';
            predatorReproSlider.value = 0.005;
            predatorReproValue.textContent = '0.005';
            mutationSlider.value = 0.15;
            mutationValue.textContent = '0.15';
            
            this.initGrid();
        });
        
        document.getElementById('preset-herbivore-dominant').addEventListener('click', () => {
            this.params.plantGrowthRate = 0.1;
            this.params.herbivoreReproProb = 0.04;
            this.params.predatorReproProb = 0.02;
            this.params.herbivoreMutationRate = 0.2;
            this.params.predatorMutationRate = 0.2;
            
            plantGrowthSlider.value = 0.1;
            plantGrowthValue.textContent = '0.10';
            herbivoreReproSlider.value = 0.04;
            herbivoreReproValue.textContent = '0.040';
            predatorReproSlider.value = 0.02;
            predatorReproValue.textContent = '0.020';
            mutationSlider.value = 0.2;
            mutationValue.textContent = '0.20';
            
            this.initGrid();
        });
        
        document.getElementById('preset-high-mutation').addEventListener('click', () => {
            this.params.plantGrowthRate = 0.06;
            this.params.herbivoreReproProb = 0.025;
            this.params.predatorReproProb = 0.015;
            this.params.herbivoreMutationRate = 0.4;
            this.params.predatorMutationRate = 0.4;
            
            plantGrowthSlider.value = 0.06;
            plantGrowthValue.textContent = '0.06';
            herbivoreReproSlider.value = 0.025;
            herbivoreReproValue.textContent = '0.025';
            predatorReproSlider.value = 0.015;
            predatorReproValue.textContent = '0.015';
            mutationSlider.value = 0.4;
            mutationValue.textContent = '0.40';
            
            this.initGrid();
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case ' ':
                    // Space to toggle pause
                    this.isPaused = !this.isPaused;
                    pauseToggle.checked = this.isPaused;
                    break;
                    
                case 'r':
                case 'R':
                    // R to reset
                    this.initGrid();
                    this.history = {
                        plants: [],
                        herbivores: [],
                        predators: [],
                        time: []
                    };
                    this.updateChart();
                    break;
                    
                case 'g':
                case 'G':
                    // G to toggle grid
                    this.params.showGrid = !this.params.showGrid;
                    gridToggle.checked = this.params.showGrid;
                    break;
                    
                case '1':
                    this.params.simulationSpeed = 0.5;
                    speedSlider.value = 0.5;
                    speedValue.textContent = '0.5';
                    break;
                    
                case '2':
                    this.params.simulationSpeed = 1.0;
                    speedSlider.value = 1.0;
                    speedValue.textContent = '1.0';
                    break;
                    
                case '3':
                    this.params.simulationSpeed = 2.0;
                    speedSlider.value = 2.0;
                    speedValue.textContent = '2.0';
                    break;
            }
        });
        
        // Handle window resize for chart
        window.addEventListener('resize', () => {
            if (this.chartCanvas) {
                this.chartCanvas.width = this.chartCanvas.offsetWidth;
                this.chartCanvas.height = this.chartCanvas.offsetHeight;
                this.updateChart();
            }
        });
    }
}

// p5.js Sketch
let ecosystemSim;

function setup() {
    const canvasContainer = document.getElementById('ecosystem-canvas');
    const canvasWidth = canvasContainer.offsetWidth;
    const canvasHeight = canvasContainer.offsetHeight;
    
    // Create canvas
    const canvas = createCanvas(canvasWidth, canvasHeight);
    canvas.parent('ecosystem-canvas');
    
    // Initialize ecosystem simulation
    ecosystemSim = new EcosystemSimulation();
    
    // Initialize chart
    ecosystemSim.initChart();
}

function draw() {
    // Calculate FPS
    const fps = Math.round(frameRate());
    document.querySelector('.fps-counter').textContent = `FPS: ${fps}`;
    
    // Update simulation multiple times per frame based on speed
    const updatesPerFrame = ecosystemSim.params.simulationSpeed;
    for (let i = 0; i < updatesPerFrame; i++) {
        ecosystemSim.update();
    }
    
    // Draw the ecosystem
    ecosystemSim.draw(canvas);
}

function windowResized() {
    const canvasContainer = document.getElementById('ecosystem-canvas');
    const canvasWidth = canvasContainer.offsetWidth;
    const canvasHeight = canvasContainer.offsetHeight;
    resizeCanvas(canvasWidth, canvasHeight);
    
    // Update chart
    if (ecosystemSim.chartCanvas) {
        ecosystemSim.chartCanvas.width = ecosystemSim.chartCanvas.offsetWidth;
        ecosystemSim.chartCanvas.height = ecosystemSim.chartCanvas.offsetHeight;
        ecosystemSim.updateChart();
    }
}

// Initialize the simulation when the page loads
window.addEventListener('DOMContentLoaded', () => {
    // p5.js will call setup() and draw() automatically
});
    </script>
</body>
</html>