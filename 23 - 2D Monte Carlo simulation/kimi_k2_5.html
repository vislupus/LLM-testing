<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>EcoSim: Evolutionary Monte Carlo</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
   <style>
       body { margin: 0; overflow: hidden; background-color: #0f172a; font-family: 'Segoe UI', sans-serif; }
       canvas { display: block; }
       .glass-panel {
           background: rgba(15, 23, 42, 0.85);
           backdrop-filter: blur(10px);
           border: 1px solid rgba(255, 255, 255, 0.1);
       }
       /* Custom scrollbar */
       ::-webkit-scrollbar { width: 6px; }
       ::-webkit-scrollbar-track { background: #1e293b; }
       ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
   </style>
</head>
<body>

   <!-- UI Overlay -->
   <div class="absolute top-0 left-0 h-full w-80 glass-panel z-10 text-gray-200 flex flex-col p-4 shadow-2xl">
       <h1 class="text-2xl font-bold text-emerald-400 mb-1 tracking-tight">EcoSim <span class="text-xs text-gray-500 font-normal">v2.0</span></h1>
       <p class="text-xs text-gray-400 mb-4">Monte Carlo Evolutionary Dynamics</p>

       <!-- Stats Chart -->
       <div class="bg-slate-900/50 rounded-lg p-2 mb-4 h-40 border border-slate-700">
           <canvas id="popChart"></canvas>
       </div>

       <!-- Live Stats -->
       <div class="grid grid-cols-2 gap-2 mb-4 text-xs">
           <div class="bg-slate-800 p-2 rounded border border-slate-700">
               <div class="text-green-400 font-bold text-lg" id="stat-plants">0</div>
               <div class="text-gray-500">Plants</div>
           </div>
           <div class="bg-slate-800 p-2 rounded border border-slate-700">
               <div class="text-blue-400 font-bold text-lg" id="stat-prey">0</div>
               <div class="text-gray-500">Herbivores</div>
           </div>
           <div class="bg-slate-800 p-2 rounded border border-slate-700">
               <div class="text-red-400 font-bold text-lg" id="stat-pred">0</div>
               <div class="text-gray-500">Predators</div>
           </div>
           <div class="bg-slate-800 p-2 rounded border border-slate-700">
               <div class="text-yellow-400 font-bold text-lg" id="stat-gen">0</div>
               <div class="text-gray-500">Time</div>
           </div>
       </div>

       <!-- Controls -->
       <div class="flex-grow overflow-y-auto space-y-4 pr-1">
           
           <div class="flex gap-2 mb-2">
               <button id="btn-pause" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-1 px-3 rounded text-sm font-bold transition">Pause</button>
               <button id="btn-reset" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-1 px-3 rounded text-sm font-bold transition">Reset</button>
           </div>

           <div class="space-y-3">
               <div>
                   <div class="flex justify-between text-xs mb-1">
                       <span>Mutation Rate</span>
                       <span id="val-mut" class="text-emerald-400">5%</span>
                   </div>
                   <input type="range" id="slider-mut" min="0" max="20" value="5" class="w-full accent-emerald-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
               </div>

               <div>
                   <div class="flex justify-between text-xs mb-1">
                       <span>Plant Growth</span>
                       <span id="val-growth" class="text-emerald-400">High</span>
                   </div>
                   <input type="range" id="slider-growth" min="1" max="10" value="5" class="w-full accent-emerald-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
               </div>

               <div>
                   <div class="flex justify-between text-xs mb-1">
                       <span>Metabolism Cost</span>
                       <span id="val-cost" class="text-emerald-400">Med</span>
                   </div>
                   <input type="range" id="slider-cost" min="1" max="5" value="2" class="w-full accent-emerald-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
               </div>
               
               <div>
                   <div class="flex justify-between text-xs mb-1">
                       <span>Sim Speed</span>
                       <span id="val-speed" class="text-emerald-400">1x</span>
                   </div>
                   <input type="range" id="slider-speed" min="1" max="10" value="1" class="w-full accent-emerald-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
               </div>
           </div>

           <div class="mt-4 p-3 bg-slate-800/50 rounded border border-slate-700 text-xs space-y-1">
               <div class="font-bold text-gray-400 mb-1">Trait Visualization</div>
               <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-500"></div> <span>Size = Speed</span></div>
               <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full border-2 border-blue-300"></div> <span>Radius = Vision</span></div>
               <div class="text-gray-500 mt-2 italic">Click map to add energy</div>
           </div>
       </div>
   </div>

   <script>
       // --- Configuration ---
       const CONFIG = {
           gridW: 120,
           gridH: 80,
           cellSize: 10, // Will be calculated dynamically
           maxPlants: 800,
           initialPrey: 100,
           initialPred: 20
       };

       // --- Global State ---
       let grid = [];
       let agents = [];
       let plants = [];
       let time = 0;
       let isRunning = true;
       let chart;
       
       // Parameters
       let params = {
           mutationRate: 0.05,
           plantGrowth: 0.05, // Probability per cell per frame
           metabolismCost: 0.2,
           simSpeed: 1
       };

       // --- Classes ---

       class Plant {
           constructor(x, y) {
               this.x = x;
               this.y = y;
               this.energy = 15;
               this.color = color(34, 197, 94); // Tailwind green-500
           }
           draw() {
               noStroke();
               fill(this.color);
               rect(this.x * cs, this.y * cs, cs - 1, cs - 1);
           }
       }

       class Agent {
           constructor(x, y, type, parent = null) {
               this.x = x;
               this.y = y;
               this.type = type; // 0 = Prey, 1 = Predator
               this.energy = 50;
               this.age = 0;
               
               // Traits (Heritable)
               if (parent) {
                   // Mutation
                   let mutate = (val) => {
                       if (random() < params.mutationRate) {
                           return constrain(val + random(-0.5, 0.5), 0.5, 3.0);
                       }
                       return val;
                   };
                   
                   this.speed = mutate(parent.speed);
                   this.vision = mutate(parent.vision);
                   this.efficiency = mutate(parent.efficiency);
               } else {
                   // Initial random traits
                   this.speed = random(0.8, 1.5);
                   this.vision = random(2, 5);
                   this.efficiency = random(0.5, 1.5); // Energy conversion rate
               }
           }

           update() {
               this.age++;
               this.energy -= params.metabolismCost * (this.speed * 0.5); // Faster = hungrier
               
               if (this.energy <= 0) return false; // Death

               // Movement Logic (Monte Carlo choice)
               let moveProb = this.speed * 0.2; // Chance to move this frame
               if (random() < moveProb) {
                   this.move();
               }

               // Reproduction
               if (this.energy > 80 && random() < 0.05 * this.efficiency) {
                   this.reproduce();
               }

               return true; // Survived
           }

           move() {
               // Sense environment
               let target = this.sense();
               
               let dx = 0, dy = 0;
               
               if (target) {
                   // Move towards target
                   dx = Math.sign(target.x - this.x);
                   dy = Math.sign(target.y - this.y);
               } else {
                   // Random walk
                   dx = floor(random(-1, 2));
                   dy = floor(random(-1, 2));
               }

               // Bounds check
               let nx = constrain(this.x + dx, 0, CONFIG.gridW - 1);
               let ny = constrain(this.y + dy, 0, CONFIG.gridH - 1);

               // Interaction at new spot
               if (this.type === 0) { // Prey
                   // Check for plants at new spot
                   let plantIndex = plants.findIndex(p => p.x === nx && p.y === ny);
                   if (plantIndex !== -1) {
                       this.energy += plants[plantIndex].energy * this.efficiency;
                       plants.splice(plantIndex, 1); // Eat plant
                   }
               } else { // Predator
                   // Check for prey at new spot
                   let preyIndex = agents.findIndex(a => a.type === 0 && a.x === nx && a.y === ny);
                   if (preyIndex !== -1) {
                       this.energy += agents[preyIndex].energy * 0.8 * this.efficiency; // Gain energy
                       agents.splice(preyIndex, 1); // Kill prey
                   }
               }

               this.x = nx;
               this.y = ny;
           }

           sense() {
               // Look in vision radius
               let closest = null;
               let recordDist = Infinity;
               
               let searchList = (this.type === 0) ? plants : agents.filter(a => a.type === 0);
               
               for (let other of searchList) {
                   let d = dist(this.x, this.y, other.x, other.y);
                   if (d < this.vision && d < recordDist) {
                       recordDist = d;
                       closest = other;
                   }
               }
               return closest;
           }

           reproduce() {
               this.energy *= 0.5; // Split energy
               let child = new Agent(this.x, this.y, this.type, this);
               
               // Mutate color slightly based on traits for visualization
               agents.push(child);
           }

           draw() {
               let cx = this.x * cs + cs/2;
               let cy = this.y * cs + cs/2;
               
               if (this.type === 0) { // Prey
                   fill(59, 130, 246); // Blue
                   // Size based on speed
                   let r = cs * 0.4 * (this.speed * 0.6);
                   ellipse(cx, cy, r, r);
                   
                   // Vision ring
                   noFill();
                   stroke(59, 130, 246, 50);
                   ellipse(cx, cy, this.vision * cs * 2, this.vision * cs * 2);
                   noStroke();
               } else { // Predator
                   fill(239, 68, 68); // Red
                   let r = cs * 0.5 * (this.speed * 0.6);
                   // Triangle shape for predator
                   triangle(cx, cy - r, cx - r, cy + r, cx + r, cy + r);
                   
                   noFill();
                   stroke(239, 68, 68, 50);
                   ellipse(cx, cy, this.vision * cs * 2, this.vision * cs * 2);
                   noStroke();
               }
           }
       }

       // --- P5.js Functions ---

       let cs; // Cell Size calculated

       function setup() {
           let canvas = createCanvas(windowWidth, windowHeight);
           canvas.parent(document.body);
           
           // Calculate cell size to fit grid to screen initially (or fixed size)
           // Let's fix cell size and let user scroll if needed, or just fit to window
           // Fitting:
           cs = min(width / CONFIG.gridW, height / CONFIG.gridH);
           
           initSimulation();
           initChart();
           setupUI();
       }

       function windowResized() {
           resizeCanvas(windowWidth, windowHeight);
           cs = min(width / CONFIG.gridW, height / CONFIG.gridH);
       }

       function initSimulation() {
           grid = [];
           agents = [];
           plants = [];
           time = 0;
           
           // Init Plants
           for(let i=0; i<CONFIG.maxPlants; i++) {
               spawnPlant();
           }
           
           // Init Agents
           for(let i=0; i<CONFIG.initialPrey; i++) {
               agents.push(new Agent(floor(random(CONFIG.gridW)), floor(random(CONFIG.gridH)), 0));
           }
           for(let i=0; i<CONFIG.initialPred; i++) {
               agents.push(new Agent(floor(random(CONFIG.gridW)), floor(random(CONFIG.gridH)), 1));
           }
       }

       function spawnPlant() {
           let x = floor(random(CONFIG.gridW));
           let y = floor(random(CONFIG.gridH));
           // Simple collision check (optional, skipping for speed)
           plants.push(new Plant(x, y));
       }

       function draw() {
           background(15, 23, 42); // Slate-900
           
           // Run simulation steps based on speed slider
           if(isRunning) {
               let steps = floor(params.simSpeed);
               for(let s=0; s<steps; s++) {
                   stepSimulation();
               }
               if(frameCount % 10 === 0) updateStats();
           }

           // Draw Plants
           for(let p of plants) p.draw();
           
           // Draw Agents
           for(let a of agents) a.draw();
           
           // Draw Grid (Subtle)
           stroke(30, 41, 59);
           strokeWeight(1);
           for(let x=0; x<=CONFIG.gridW; x++) line(x*cs, 0, x*cs, CONFIG.gridH*cs);
           for(let y=0; y<=CONFIG.gridH; y++) line(0, y*cs, CONFIG.gridW*cs, y*cs);
       }

       function stepSimulation() {
           time++;
           
           // 1. Plant Growth (Monte Carlo)
           // Probability based on slider
           if(plants.length < CONFIG.maxPlants && random() < params.plantGrowth) {
               spawnPlant();
           }

           // 2. Agent Updates
           // Shuffle agents for fair processing order
           shuffleArray(agents);
           
           for (let i = agents.length - 1; i >= 0; i--) {
               let survived = agents[i].update();
               if (!survived) {
                   agents.splice(i, 1);
               }
           }
       }

       function mouseDragged() {
           // Add energy/entities on drag
           if(mouseX > 320) { // Avoid UI
               let gx = floor(mouseX / cs);
               let gy = floor(mouseY / cs);
               if(gx >= 0 && gx < CONFIG.gridW && gy >=0 && gy < CONFIG.gridH) {
                   if(random() < 0.1) plants.push(new Plant(gx, gy));
               }
           }
       }
       
       function mousePressed() {
            if(mouseX > 320 && mouseButton === LEFT) {
               let gx = floor(mouseX / cs);
               let gy = floor(mouseY / cs);
               if(gx >= 0 && gx < CONFIG.gridW && gy >=0 && gy < CONFIG.gridH) {
                   agents.push(new Agent(gx, gy, 0)); // Add prey
               }
           }
       }

       // --- Utilities ---

       function shuffleArray(array) {
           for (let i = array.length - 1; i > 0; i--) {
               const j = Math.floor(Math.random() * (i + 1));
               [array[i], array[j]] = [array[j], array[i]];
           }
       }

       // --- UI & Stats ---

       function setupUI() {
           document.getElementById('btn-pause').addEventListener('click', () => {
               isRunning = !isRunning;
               document.getElementById('btn-pause').innerText = isRunning ? "Pause" : "Resume";
           });
           
           document.getElementById('btn-reset').addEventListener('click', () => {
               initSimulation();
           });

           // Sliders
           const bindSlider = (id, param, displayId, scale=1, suffix='') => {
               document.getElementById(id).addEventListener('input', (e) => {
                   let val = parseFloat(e.target.value) * scale;
                   params[param] = val;
                   if(displayId) {
                       let displayVal = (param === 'plantGrowth') ? (val * 100).toFixed(0) + '%' : val;
                       document.getElementById(displayId).innerText = displayVal;
                   }
               });
           };

           bindSlider('slider-mut', 'mutationRate', 'val-mut', 0.01);
           bindSlider('slider-growth', 'plantGrowth', 'val-growth', 0.01);
           bindSlider('slider-cost', 'metabolismCost', 'val-cost', 0.1);
           bindSlider('slider-speed', 'simSpeed', 'val-speed', 1);
       }

       function initChart() {
           const ctx = document.getElementById('popChart').getContext('2d');
           chart = new Chart(ctx, {
               type: 'line',
               data: {
                   labels: [],
                   datasets: [
                       { label: 'Plants', data: [], borderColor: '#34d399', tension: 0.4, pointRadius: 0, borderWidth: 2 },
                       { label: 'Prey', data: [], borderColor: '#3b82f6', tension: 0.4, pointRadius: 0, borderWidth: 2 },
                       { label: 'Pred', data: [], borderColor: '#ef4444', tension: 0.4, pointRadius: 0, borderWidth: 2 }
                   ]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   animation: false,
                   plugins: { legend: { labels: { color: '#94a3b8', font: { size: 10 }, boxWidth: 10 } } },
                   scales: {
                       x: { display: false },
                       y: { 
                           grid: { color: '#334155' },
                           ticks: { color: '#64748b', font: { size: 10 } },
                           beginAtZero: true
                       }
                   }
               }
           });
       }

       function updateStats() {
           document.getElementById('stat-plants').innerText = plants.length;
           document.getElementById('stat-prey').innerText = agents.filter(a => a.type === 0).length;
           document.getElementById('stat-pred').innerText = agents.filter(a => a.type === 1).length;
           document.getElementById('stat-gen').innerText = time;

           // Update Chart
           if(chart.data.labels.length > 50) {
               chart.data.labels.shift();
               chart.data.datasets.forEach(d => d.data.shift());
           }
           chart.data.labels.push(time);
           chart.data.datasets[0].data.push(plants.length);
           chart.data.datasets[1].data.push(agents.filter(a => a.type === 0).length);
           chart.data.datasets[2].data.push(agents.filter(a => a.type === 1).length);
           chart.update();
       }

   </script>
</body>
</html>