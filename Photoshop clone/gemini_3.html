<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoEditor Lite - Web Clone</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --bg-header: #333333;
            --accent: #007fd4;
            --text-main: #cccccc;
            --text-muted: #858585;
            --border: #3e3e42;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- MENU BAR --- */
        .menubar {
            height: 30px;
            background-color: var(--bg-header);
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            border-bottom: 1px solid #000;
        }
        .menu-item { margin-right: 15px; cursor: pointer; }
        .menu-item:hover { color: white; }

        /* --- MAIN LAYOUT --- */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* --- TOOLBAR (LEFT) --- */
        .toolbar {
            width: 40px;
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
        }

        .tool-btn {
            width: 30px;
            height: 30px;
            margin-bottom: 5px;
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: var(--text-main);
            font-size: 14px;
            transition: 0.2s;
            position: relative;
        }
        .tool-btn:hover { background-color: #3e3e42; }
        .tool-btn.active { background-color: var(--accent); color: white; }
        
        .color-picker-wrapper {
            margin-top: 10px;
            width: 28px;
            height: 28px;
            border: 1px solid #fff;
            overflow: hidden;
            border-radius: 50%;
        }
        input[type="color"] {
            width: 150%; height: 150%;
            margin: -25%;
            cursor: pointer;
            border: none;
        }

        /* --- CANVAS AREA (CENTER) --- */
        .canvas-area {
            flex: 1;
            background-color: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            position: relative;
        }
        
        #editor-canvas {
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #ccc 75%), 
                              linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            cursor: crosshair;
        }

        /* --- PANELS (RIGHT) --- */
        .panels {
            width: 260px;
            background-color: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .panel-section {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid var(--border);
            max-height: 50%;
        }

        .panel-header {
            background: #333;
            padding: 8px 10px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
        }

        .panel-content {
            padding: 10px;
            overflow-y: auto;
        }

        /* Properties Controls */
        .prop-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .prop-row label { width: 70px; }
        .prop-row input[type="range"] { flex: 1; }
        .prop-row select { width: 100%; background: #444; color: white; border: 1px solid #555; padding: 2px; }
        .prop-btn {
            background: #444; border: 1px solid #555; color: white;
            padding: 4px 8px; width: 100%; cursor: pointer; font-size: 11px; margin-bottom: 5px;
        }
        .prop-btn:hover { background: #555; }

        /* Layers List */
        .layer-list { list-style: none; padding: 0; margin: 0; }
        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #333;
            border-bottom: 1px solid #444;
            cursor: pointer;
            font-size: 12px;
        }
        .layer-item.active { background: #4a4a4a; }
        .layer-vis { width: 20px; text-align: center; cursor: pointer; color: #888; margin-right: 5px; }
        .layer-vis.visible { color: var(--text-main); }
        .layer-thumb { width: 30px; height: 30px; background: white; margin-right: 10px; border: 1px solid #555; }
        .layer-name { flex: 1; }
        .layer-actions { display: flex; gap: 5px; padding: 5px; background: #2a2a2a; }

        /* History */
        .history-item { padding: 4px 8px; font-size: 11px; cursor: pointer; color: #aaa; }
        .history-item:hover { background: #333; color: white; }

        /* Dialogs */
        .modal-overlay {
            position: fixed; top:0; left:0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal { background: #333; padding: 20px; border: 1px solid #555; width: 300px; }
        .modal h3 { margin-top: 0; font-size: 14px; }
    </style>
    <!-- Simple Icons using unicode/emoji to avoid external dependencies -->
</head>
<body>

    <div class="menubar">
        <div class="menu-item" onclick="createNew()">File > New</div>
        <div class="menu-item" onclick="downloadImage()">File > Export PNG</div>
        <div class="menu-item" onclick="undo()">Edit > Undo (Ctrl+Z)</div>
        <div class="menu-item" onclick="alert('This is a client-side HTML5 clone. All processing happens in your browser.')">Help</div>
    </div>

    <div class="workspace">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="tool-btn active" id="tool-brush" onclick="setTool('brush')" title="Brush (B)">üñåÔ∏è</div>
            <div class="tool-btn" id="tool-eraser" onclick="setTool('eraser')" title="Eraser (E)">üßπ</div>
            <div class="tool-btn" id="tool-move" onclick="setTool('move')" title="Move Layer (V)">‚úã</div>
            <div class="tool-btn" id="tool-bucket" onclick="fillLayer()" title="Fill Layer">ü™£</div>
            
            <div class="color-picker-wrapper" title="Color Picker">
                <input type="color" id="colorPicker" value="#000000" onchange="updateBrush()">
            </div>
        </div>

        <!-- Canvas -->
        <div class="canvas-area">
            <canvas id="editor-canvas" width="800" height="600"></canvas>
        </div>

        <!-- Right Panels -->
        <div class="panels">
            
            <!-- Tool Properties -->
            <div class="panel-section">
                <div class="panel-header">Properties</div>
                <div class="panel-content">
                    <div class="prop-row">
                        <label>Size</label>
                        <input type="range" id="brushSize" min="1" max="100" value="10" oninput="updateBrush()">
                        <span id="brushSizeDisplay" style="width: 20px; text-align:right;">10</span>
                    </div>
                    <div class="prop-row">
                        <label>Opacity</label>
                        <input type="range" id="brushOpacity" min="1" max="100" value="100" oninput="updateBrush()">
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="panel-section">
                <div class="panel-header">Filters / Adjustments</div>
                <div class="panel-content">
                    <button class="prop-btn" onclick="applyFilter('invert')">Invert Colors</button>
                    <button class="prop-btn" onclick="applyFilter('grayscale')">Grayscale</button>
                    <button class="prop-btn" onclick="applyFilter('sepia')">Sepia</button>
                    <button class="prop-btn" onclick="applyFilter('brightness')">Brightness (+20)</button>
                    <button class="prop-btn" onclick="applyFilter('contrast')">Contrast (+20)</button>
                    <button class="prop-btn" onclick="applyFilter('blur')">Blur (3px)</button>
                </div>
            </div>

            <!-- Layers -->
            <div class="panel-section" style="flex: 1;">
                <div class="panel-header">
                    <span>Layers</span>
                    <span style="cursor: pointer" onclick="addLayer()">+ New</span>
                </div>
                <div class="panel-content" style="padding: 0;">
                    <div class="prop-row" style="padding: 5px;">
                        <select id="blendMode" onchange="updateLayerProps()">
                            <option value="source-over">Normal</option>
                            <option value="multiply">Multiply</option>
                            <option value="screen">Screen</option>
                            <option value="overlay">Overlay</option>
                            <option value="darken">Darken</option>
                            <option value="lighten">Lighten</option>
                            <option value="difference">Difference</option>
                        </select>
                    </div>
                    <div class="prop-row" style="padding: 0 5px;">
                        <label style="width: 40px">Opac:</label>
                        <input type="range" id="layerOpacity" min="0" max="100" value="100" oninput="updateLayerProps()">
                    </div>
                    <ul class="layer-list" id="layersList">
                        <!-- Layers injected here -->
                    </ul>
                </div>
                <div class="layer-actions">
                    <button class="prop-btn" onclick="deleteLayer()">Delete Layer</button>
                    <button class="prop-btn" onclick="mergeDown()">Merge Down</button>
                </div>
            </div>

            <!-- History -->
            <div class="panel-section" style="height: 150px;">
                <div class="panel-header">History</div>
                <div class="panel-content" id="historyList">
                    <div class="history-item">New Document</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        /**
         * CORE STATE
         */
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 600;
        const mainCanvas = document.getElementById('editor-canvas');
        const mainCtx = mainCanvas.getContext('2d');
        
        let layers = []; // Array of Layer Objects
        let activeLayerId = null;
        let historyStack = [];
        let historyStep = -1;
        
        // Tool State
        let currentTool = 'brush'; // brush, eraser, move
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let brushSize = 10;
        let brushColor = '#000000';
        let brushOpacity = 1.0;

        /**
         * LAYER CLASS
         */
        class Layer {
            constructor(id, name) {
                this.id = id;
                this.name = name;
                this.visible = true;
                this.blendMode = 'source-over';
                this.opacity = 1.0;
                this.x = 0; // For move tool
                this.y = 0; // For move tool
                
                // Off-screen canvas for this layer
                this.canvas = document.createElement('canvas');
                this.canvas.width = CANVAS_WIDTH;
                this.canvas.height = CANVAS_HEIGHT;
                this.ctx = this.canvas.getContext('2d');
            }
        }

        /**
         * INITIALIZATION
         */
        function init() {
            // Create Background Layer
            addLayer('Background');
            
            // Fill background with white
            const bgLayer = layers[0];
            bgLayer.ctx.fillStyle = '#ffffff';
            bgLayer.ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            renderCanvas();
            saveHistory('New Document');
            setupEvents();
        }

        /**
         * CANVAS RENDERING SYSTEM
         * Composites all layers onto the main visible canvas
         */
        function renderCanvas() {
            // Clear main display
            mainCtx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Loop through layers bottom to top
            // Note: Our array is Top->Bottom (for UI), so we render reverse order
            for (let i = layers.length - 1; i >= 0; i--) {
                const layer = layers[i];
                if (!layer.visible) continue;

                mainCtx.save();
                mainCtx.globalAlpha = layer.opacity;
                mainCtx.globalCompositeOperation = layer.blendMode;
                mainCtx.drawImage(layer.canvas, layer.x, layer.y);
                mainCtx.restore();
            }
            
            // UI Outline for Move Tool (optional visual feedback)
            if(currentTool === 'move' && activeLayerId !== null) {
                const layer = getActiveLayer();
                if(layer) {
                    mainCtx.strokeStyle = '#007fd4';
                    mainCtx.lineWidth = 1;
                    mainCtx.strokeRect(layer.x, layer.y, CANVAS_WIDTH, CANVAS_HEIGHT);
                }
            }
        }

        /**
         * LAYER MANAGEMENT
         */
        function addLayer(name = null) {
            const id = Date.now();
            const newName = name || `Layer ${layers.length + 1}`;
            const newLayer = new Layer(id, newName);
            
            // Add to top of stack
            layers.unshift(newLayer);
            activeLayerId = id;
            updateLayerListUI();
            saveHistory('Add Layer');
            return newLayer;
        }

        function deleteLayer() {
            if (layers.length <= 1) return; // Don't delete last layer
            layers = layers.filter(l => l.id !== activeLayerId);
            activeLayerId = layers[0].id;
            updateLayerListUI();
            renderCanvas();
            saveHistory('Delete Layer');
        }

        function getActiveLayer() {
            return layers.find(l => l.id === activeLayerId);
        }

        function updateLayerListUI() {
            const list = document.getElementById('layersList');
            list.innerHTML = '';

            layers.forEach(layer => {
                const li = document.createElement('li');
                li.className = `layer-item ${layer.id === activeLayerId ? 'active' : ''}`;
                li.onclick = () => { activeLayerId = layer.id; updateLayerListUI(); updateUIControls(); renderCanvas(); };

                // Visibility Eye
                const eye = document.createElement('span');
                eye.className = `layer-vis ${layer.visible ? 'visible' : ''}`;
                eye.innerHTML = 'üëÅ';
                eye.onclick = (e) => {
                    e.stopPropagation();
                    layer.visible = !layer.visible;
                    renderCanvas();
                    updateLayerListUI();
                };

                const name = document.createElement('span');
                name.className = 'layer-name';
                name.innerText = layer.name;

                li.appendChild(eye);
                li.appendChild(name);
                list.appendChild(li);
            });
            updateUIControls();
        }

        function updateUIControls() {
            const layer = getActiveLayer();
            if(!layer) return;
            document.getElementById('blendMode').value = layer.blendMode;
            document.getElementById('layerOpacity').value = layer.opacity * 100;
        }

        function updateLayerProps() {
            const layer = getActiveLayer();
            if (!layer) return;
            
            layer.blendMode = document.getElementById('blendMode').value;
            layer.opacity = document.getElementById('layerOpacity').value / 100;
            renderCanvas();
        }

        function mergeDown() {
            const index = layers.findIndex(l => l.id === activeLayerId);
            if (index >= layers.length - 1) return; // Bottom layer

            const topLayer = layers[index];
            const bottomLayer = layers[index + 1];

            // Draw top onto bottom
            bottomLayer.ctx.save();
            bottomLayer.ctx.globalAlpha = topLayer.opacity;
            bottomLayer.ctx.globalCompositeOperation = topLayer.blendMode;
            bottomLayer.ctx.drawImage(topLayer.canvas, topLayer.x - bottomLayer.x, topLayer.y - bottomLayer.y);
            bottomLayer.ctx.restore();

            // Remove top layer
            layers.splice(index, 1);
            activeLayerId = bottomLayer.id;
            
            updateLayerListUI();
            renderCanvas();
            saveHistory('Merge Down');
        }

        /**
         * TOOLS & DRAWING
         */
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tool-${tool}`).classList.add('active');
            
            // Cursor update
            if (tool === 'move') mainCanvas.style.cursor = 'move';
            else mainCanvas.style.cursor = 'crosshair';
            
            renderCanvas(); // Redraw to show/hide move tool selection box
        }

        function updateBrush() {
            brushSize = document.getElementById('brushSize').value;
            brushColor = document.getElementById('colorPicker').value;
            brushOpacity = document.getElementById('brushOpacity').value / 100;
            document.getElementById('brushSizeDisplay').innerText = brushSize;
        }

        function fillLayer() {
            const layer = getActiveLayer();
            if(!layer) return;
            
            saveHistory('Fill Layer');
            layer.ctx.fillStyle = brushColor;
            layer.ctx.globalCompositeOperation = 'source-over';
            layer.ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            renderCanvas();
        }

        function setupEvents() {
            mainCanvas.addEventListener('mousedown', startDraw);
            window.addEventListener('mouseup', stopDraw);
            window.addEventListener('mousemove', draw);
            
            // Keyboard shortcuts
            window.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'z') undo();
                if (e.key === 'b') setTool('brush');
                if (e.key === 'e') setTool('eraser');
                if (e.key === 'v') setTool('move');
                if (e.key === '[' && brushSize > 1) { document.getElementById('brushSize').value--; updateBrush(); }
                if (e.key === ']' && brushSize < 100) { document.getElementById('brushSize').value++; updateBrush(); }
            });
        }

        function startDraw(e) {
            isDrawing = true;
            const pos = getMousePos(e);
            lastX = pos.x;
            lastY = pos.y;
            
            if (currentTool === 'brush' || currentTool === 'eraser') {
                saveHistory('Paint'); // Save before stroke
                draw(e); // Draw single dot
            } else if (currentTool === 'move') {
                saveHistory('Move');
            }
        }

        function stopDraw() {
            isDrawing = false;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const layer = getActiveLayer();
            if (!layer || !layer.visible) return;

            const pos = getMousePos(e);

            if (currentTool === 'move') {
                const dx = pos.x - lastX;
                const dy = pos.y - lastY;
                layer.x += dx;
                layer.y += dy;
                lastX = pos.x;
                lastY = pos.y;
                renderCanvas();
                return;
            }

            // Brush / Eraser Logic
            const ctx = layer.ctx;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = brushSize;
            
            if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.strokeStyle = `rgba(0,0,0,${brushOpacity})`; // Color doesn't matter for erase
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = brushColor;
                ctx.globalAlpha = brushOpacity;
            }

            // Correction for layer offset when painting
            const lx = lastX - layer.x;
            const ly = lastY - layer.y;
            const cx = pos.x - layer.x;
            const cy = pos.y - layer.y;

            ctx.beginPath();
            ctx.moveTo(lx, ly);
            ctx.lineTo(cx, cy);
            ctx.stroke();

            // Reset alpha
            ctx.globalAlpha = 1.0;

            lastX = pos.x;
            lastY = pos.y;
            
            renderCanvas();
        }

        function getMousePos(e) {
            const rect = mainCanvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        /**
         * FILTERS & IMAGE PROCESSING
         */
        function applyFilter(type) {
            const layer = getActiveLayer();
            if (!layer) return;
            
            saveHistory(`Filter: ${type}`);
            
            // For Blur, we use canvas filter API (easier/faster)
            if (type === 'blur') {
                // We need to apply blur to the existing content
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = CANVAS_WIDTH;
                tempCanvas.height = CANVAS_HEIGHT;
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCtx.filter = 'blur(3px)';
                tempCtx.drawImage(layer.canvas, 0, 0);
                
                layer.ctx.clearRect(0,0, CANVAS_WIDTH, CANVAS_HEIGHT);
                layer.ctx.drawImage(tempCanvas, 0, 0);
                renderCanvas();
                return;
            }

            // For Pixel Manipulation
            const imgData = layer.ctx.getImageData(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            const data = imgData.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i+1];
                const b = data[i+2];

                if (type === 'invert') {
                    data[i] = 255 - r;
                    data[i+1] = 255 - g;
                    data[i+2] = 255 - b;
                }
                else if (type === 'grayscale') {
                    const avg = (r + g + b) / 3;
                    data[i] = avg;
                    data[i+1] = avg;
                    data[i+2] = avg;
                }
                else if (type === 'sepia') {
                    data[i] = (r * .393) + (g * .769) + (b * .189);
                    data[i+1] = (r * .349) + (g * .686) + (b * .168);
                    data[i+2] = (r * .272) + (g * .534) + (b * .131);
                }
                else if (type === 'brightness') {
                    data[i] += 20;
                    data[i+1] += 20;
                    data[i+2] += 20;
                }
                else if (type === 'contrast') {
                    const factor = (259 * (20 + 255)) / (255 * (259 - 20));
                    data[i] = factor * (r - 128) + 128;
                    data[i+1] = factor * (g - 128) + 128;
                    data[i+2] = factor * (b - 128) + 128;
                }
            }

            layer.ctx.putImageData(imgData, 0, 0);
            renderCanvas();
        }

        /**
         * HISTORY SYSTEM
         * Saves snapshots of the entire layer stack.
         * Optimization: In a real app we'd only save diffs, but for this clone
         * we serialize the layer structure and image data.
         */
        function saveHistory(actionName) {
            // Remove redo steps
            if (historyStep < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyStep + 1);
            }

            // Create Snapshot
            const snapshot = layers.map(layer => {
                return {
                    id: layer.id,
                    name: layer.name,
                    visible: layer.visible,
                    blendMode: layer.blendMode,
                    opacity: layer.opacity,
                    x: layer.x,
                    y: layer.y,
                    imageData: layer.ctx.getImageData(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT)
                };
            });

            historyStack.push({ name: actionName, data: snapshot, activeId: activeLayerId });
            historyStep++;
            
            // Limit history
            if(historyStack.length > 20) {
                historyStack.shift();
                historyStep--;
            }

            updateHistoryUI();
        }

        function undo() {
            if (historyStep <= 0) return; // Keep initial state
            historyStep--;
            restoreState(historyStack[historyStep]);
            updateHistoryUI();
        }

        function restoreState(state) {
            layers = [];
            activeLayerId = state.activeId;

            state.data.forEach(lData => {
                const newLayer = new Layer(lData.id, lData.name);
                newLayer.visible = lData.visible;
                newLayer.blendMode = lData.blendMode;
                newLayer.opacity = lData.opacity;
                newLayer.x = lData.x;
                newLayer.y = lData.y;
                newLayer.ctx.putImageData(lData.imageData, 0, 0);
                layers.push(newLayer);
            });

            updateLayerListUI();
            renderCanvas();
        }

        function updateHistoryUI() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            historyStack.forEach((h, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                if(index === historyStep) div.style.color = 'white';
                div.innerText = h.name;
                div.onclick = () => {
                    historyStep = index;
                    restoreState(historyStack[index]);
                    updateHistoryUI();
                };
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight;
        }

        /**
         * FILE OPERATIONS
         */
        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'image-edited.png';
            link.href = mainCanvas.toDataURL();
            link.click();
        }

        function createNew() {
            if(confirm("Discard changes and create new?")) {
                layers = [];
                historyStack = [];
                historyStep = -1;
                init();
            }
        }

        // Start App
        init();

    </script>
</body>
</html>