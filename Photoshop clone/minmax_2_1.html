<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoEdit - Photoshop Clone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #2d2d2d;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Menu Bar */
        .menu-bar {
            background-color: #3d3d3d;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #4a4a4a;
        }

        .menu-bar .menu-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .menu-bar .menu-item:hover {
            background-color: #4a4a4a;
        }

        .menu-bar .menu-item.active {
            background-color: #4a4a4a;
        }

        .menu-bar .menu-separator {
            width: 1px;
            height: 20px;
            background-color: #4a4a4a;
            margin: 0 4px;
        }

        .menu-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .menu-btn {
            background: linear-gradient(180deg, #4a9eff 0%, #2176d6 100%);
            border: none;
            color: white;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .menu-btn:hover {
            background: linear-gradient(180deg, #6eb0ff 0%, #3187e7 100%);
        }

        .menu-btn.secondary {
            background: linear-gradient(180deg, #5a5a5a 0%, #3d3d3d 100%);
        }

        .menu-btn.secondary:hover {
            background: linear-gradient(180deg, #6a6a6a 0%, #4d4d4d 100%);
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            width: 48px;
            background-color: #3d3d3d;
            border-right: 1px solid #4a4a4a;
            display: flex;
            flex-direction: column;
            padding: 8px 4px;
            gap: 2px;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .tool-btn:hover {
            background-color: #4a4a4a;
        }

        .tool-btn.active {
            background-color: #4a9eff;
            color: white;
        }

        .tool-btn svg {
            width: 20px;
            height: 20px;
        }

        .tool-separator {
            height: 1px;
            background-color: #4a4a4a;
            margin: 8px 4px;
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
            overflow: hidden;
        }

        .canvas-tabs {
            background-color: #3d3d3d;
            padding: 8px 16px 0;
            display: flex;
            gap: 4px;
            border-bottom: 1px solid #4a4a4a;
        }

        .canvas-tab {
            background-color: #4a4a4a;
            border: none;
            color: #e0e0e0;
            padding: 8px 16px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .canvas-tab.active {
            background-color: #2d2d2d;
        }

        .canvas-tab .close-btn {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: background 0.15s;
        }

        .canvas-tab .close-btn:hover {
            background-color: #666;
        }

        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: auto;
        }

        .canvas-wrapper {
            background-color: #808080;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .canvas {
            cursor: crosshair;
        }

        /* Right Panel */
        .right-panel {
            width: 280px;
            background-color: #3d3d3d;
            border-left: 1px solid #4a4a4a;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-section {
            border-bottom: 1px solid #4a4a4a;
        }

        .panel-header {
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #aaa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header .expand-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            padding: 2px;
        }

        .panel-content {
            padding: 12px;
        }

        /* Layers Panel */
        .layers-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-height: 200px;
            overflow-y: auto;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            background-color: #4a4a4a;
            border-radius: 4px;
            cursor: pointer;
            gap: 8px;
            transition: background 0.15s;
        }

        .layer-item:hover {
            background-color: #525252;
        }

        .layer-item.active {
            background-color: #4a9eff;
        }

        .layer-preview {
            width: 32px;
            height: 32px;
            background-color: #808080;
            border-radius: 2px;
            overflow: hidden;
        }

        .layer-preview canvas {
            width: 100%;
            height: 100%;
        }

        .layer-info {
            flex: 1;
            min-width: 0;
        }

        .layer-name {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .layer-type {
            font-size: 10px;
            color: #888;
        }

        .layer-actions {
            display: flex;
            gap: 2px;
        }

        .layer-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #aaa;
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .layer-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .add-layer-btn {
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            border: 1px dashed #4a4a4a;
            background: transparent;
            color: #888;
            cursor: pointer;
            border-radius: 4px;
            font-size: 11px;
            transition: all 0.15s;
        }

        .add-layer-btn:hover {
            border-color: #4a9eff;
            color: #4a9eff;
        }

        /* History Panel */
        .history-list {
            display: flex;
            flex-direction: column;
        }

        .history-item {
            padding: 8px 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .history-item:hover {
            background-color: #4a4a4a;
        }

        .history-item.active {
            background-color: rgba(74, 158, 255, 0.2);
        }

        .history-item svg {
            width: 14px;
            height: 14px;
            color: #888;
        }

        /* Color Picker */
        .color-picker-section {
            display: flex;
            gap: 8px;
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            border: 2px solid #4a4a4a;
            cursor: pointer;
            overflow: hidden;
        }

        .color-preview input[type="color"] {
            width: 150%;
            height: 150%;
            margin: -25%;
            cursor: pointer;
        }

        .color-values {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .color-input-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .color-input-row label {
            font-size: 10px;
            color: #888;
            width: 16px;
        }

        .color-input-row input {
            flex: 1;
            background-color: #2d2d2d;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            padding: 4px 6px;
            border-radius: 2px;
            font-size: 11px;
        }

        /* Blending Options */
        .blend-mode-select {
            width: 100%;
            padding: 6px 8px;
            background-color: #2d2d2d;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .opacity-slider {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .opacity-slider label {
            font-size: 11px;
            color: #888;
            width: 50px;
        }

        .opacity-slider input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #4a4a4a;
            border-radius: 2px;
        }

        .opacity-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #4a9eff;
            border-radius: 50%;
            cursor: pointer;
        }

        .opacity-value {
            font-size: 11px;
            width: 35px;
            text-align: right;
        }

        /* Filters Panel */
        .filter-section {
            margin-bottom: 12px;
        }

        .filter-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }

        .filter-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-control input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #4a4a4a;
            border-radius: 2px;
        }

        .filter-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #4a9eff;
            border-radius: 50%;
            cursor: pointer;
        }

        .filter-value {
            font-size: 10px;
            width: 35px;
            text-align: right;
            color: #aaa;
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
        }

        .filter-toggle label {
            font-size: 11px;
            flex: 1;
        }

        .filter-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .apply-filter-btn {
            width: 100%;
            padding: 8px;
            background-color: #4a9eff;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-top: 8px;
            transition: background 0.15s;
        }

        .apply-filter-btn:hover {
            background-color: #6eb0ff;
        }

        /* Brush Settings */
        .brush-preview {
            width: 100%;
            height: 60px;
            background-color: #2d2d2d;
            border-radius: 4px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brush-preview canvas {
            border-radius: 4px;
        }

        .brush-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .brush-option-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brush-option-row label {
            font-size: 11px;
            color: #888;
            width: 50px;
        }

        .brush-option-row input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #4a4a4a;
            border-radius: 2px;
        }

        .brush-option-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #4a9eff;
            border-radius: 50%;
            cursor: pointer;
        }

        .brush-option-row input[type="number"] {
            width: 60px;
            background-color: #2d2d2d;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            padding: 4px 6px;
            border-radius: 2px;
            font-size: 11px;
        }

        .value-display {
            font-size: 10px;
            width: 35px;
            text-align: right;
            color: #aaa;
        }

        /* Tool Options */
        .tool-options-panel {
            padding: 12px;
            background-color: #3d3d3d;
            border-top: 1px solid #4a4a4a;
        }

        .tool-options-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .tool-options-content {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .option-group label {
            font-size: 11px;
            color: #888;
        }

        .option-select {
            padding: 4px 8px;
            background-color: #2d2d2d;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            border-radius: 2px;
            font-size: 11px;
            cursor: pointer;
        }

        /* Status Bar */
        .status-bar {
            background-color: #3d3d3d;
            padding: 4px 12px;
            font-size: 11px;
            color: #888;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #4a4a4a;
        }

        .status-bar span {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background-color: #3d3d3d;
            border-radius: 8px;
            padding: 20px;
            min-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
        }

        .modal-close:hover {
            color: #e0e0e0;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.15s;
        }

        .modal-btn.primary {
            background-color: #4a9eff;
            color: white;
        }

        .modal-btn.primary:hover {
            background-color: #6eb0ff;
        }

        .modal-btn.secondary {
            background-color: #4a4a4a;
            color: #e0e0e0;
        }

        .modal-btn.secondary:hover {
            background-color: #5a5a5a;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            background-color: #2d2d2d;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a9eff;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background-color: #3d3d3d;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            padding: 4px 0;
            min-width: 160px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        }

        .context-menu.hidden {
            display: none;
        }

        .context-menu-item {
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
        }

        .context-menu-item:hover {
            background-color: #4a4a4a;
        }

        .context-menu-item.disabled {
            color: #666;
            cursor: default;
        }

        .context-menu-item.disabled:hover {
            background-color: transparent;
        }

        .context-menu-separator {
            height: 1px;
            background-color: #4a4a4a;
            margin: 4px 0;
        }

        /* Zoom Controls */
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .zoom-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            border-radius: 2px;
            font-size: 14px;
        }

        .zoom-btn:hover {
            background-color: #4a4a4a;
            color: #e0e0e0;
        }

        .zoom-value {
            font-size: 11px;
            color: #888;
            min-width: 45px;
            text-align: center;
        }

        /* Selection indicators */
        .cursor-position {
            font-family: monospace;
            font-size: 10px;
        }

        /* Shape tools */
        .shape-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .shape-option {
            padding: 4px 8px;
            background-color: #2d2d2d;
            border: 1px solid #4a4a4a;
            color: #888;
            cursor: pointer;
            border-radius: 2px;
            font-size: 11px;
        }

        .shape-option.active {
            background-color: #4a9eff;
            border-color: #4a9eff;
            color: white;
        }

        /* Fill options */
        .fill-type-options {
            display: flex;
            gap: 4px;
        }

        .fill-type-option {
            flex: 1;
            padding: 8px;
            background-color: #2d2d2d;
            border: 1px solid #4a4a4a;
            color: #888;
            cursor: pointer;
            border-radius: 2px;
            font-size: 11px;
            text-align: center;
        }

        .fill-type-option.active {
            background-color: #4a9eff;
            border-color: #4a9eff;
            color: white;
        }

        /* Gradient preview */
        .gradient-preview {
            height: 24px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .gradient-stops {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .gradient-stop {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #4a4a4a;
            cursor: pointer;
        }

        .gradient-stop.active {
            border-color: #4a9eff;
        }
    </style>
</head>
<body>
    <!-- Menu Bar -->
    <div class="menu-bar">
        <div class="menu-item">File</div>
        <div class="menu-item">Edit</div>
        <div class="menu-item">Image</div>
        <div class="menu-item">Layer</div>
        <div class="menu-item">Select</div>
        <div class="menu-item">Filter</div>
        <div class="menu-separator"></div>
        <div class="menu-actions">
            <button class="menu-btn secondary" id="undoBtn" title="Undo (Ctrl+Z)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 10h10a5 5 0 0 1 5 5v2"/>
                    <polyline points="3 10 8 5"/>
                    <polyline points="3 10 8 15"/>
                </svg>
            </button>
            <button class="menu-btn secondary" id="redoBtn" title="Redo (Ctrl+Y)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10H11a5 5 0 0 0-5 5v2"/>
                    <polyline points="21 10 16 5"/>
                    <polyline points="21 10 16 15"/>
                </svg>
            </button>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomOutBtn">−</button>
                <span class="zoom-value" id="zoomValue">100%</span>
                <button class="zoom-btn" id="zoomInBtn">+</button>
            </div>
            <button class="menu-btn" id="exportBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Toolbar -->
        <div class="toolbar">
            <button class="tool-btn active" id="moveTool" title="Move Tool (V)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/>
                </svg>
            </button>
            <button class="tool-btn" id="marqueeTool" title="Marquee Selection (M)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
            </button>
            <button class="tool-btn" id="lassoTool" title="Lasso Tool (L)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M7 3a5 5 0 0 0 0 10c2 0 4-3 6-3s4 3 6 3a5 5 0 0 0 0-10"/>
                    <path d="M7 13a5 5 0 0 0 0 10c2 0 4-3 6-3s4 3 6 3"/>
                </svg>
            </button>
            <button class="tool-btn" id="magicWandTool" title="Magic Wand (W)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 4V2M15 4v8M15 4h8M9 12H3M9 12V3M9 12h10M15 20v8M15 20H9M21 12h-8M21 12v-4"/>
                </svg>
            </button>

            <div class="tool-separator"></div>

            <button class="tool-btn" id="brushTool" title="Brush Tool (B)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9.06 11.9l8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/>
                    <path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.02 3.02 0 0 0-3-3.02z"/>
                </svg>
            </button>
            <button class="tool-btn" id="pencilTool" title="Pencil Tool (N)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                </svg>
            </button>
            <button class="tool-btn" id="eraserTool" title="Eraser Tool (E)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 20H7L3 16c-1.5-1.5-1.5-3 0-4.5l10-10c1.5-1.5 3-1.5 4.5 0l5 5c1.5 1.5 1.5 3 0 4.5L11 19"/>
                </svg>
            </button>
            <button class="tool-btn" id="gradientTool" title="Gradient Tool (G)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <defs>
                        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ff6b6b"/>
                            <stop offset="100%" style="stop-color:#4ecdc4"/>
                        </linearGradient>
                    </defs>
                    <rect x="3" y="8" width="18" height="8" fill="url(#grad1)"/>
                </svg>
            </button>
            <button class="tool-btn" id="fillTool" title="Paint Bucket (G)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 11l-8-8-8.6 8.6a2 2 0 0 0 0 2.8l5.2 5.2c.8.8 2 .8 2.8 0L19 11z"/>
                    <path d="M5 2l5 5"/>
                    <path d="M2 13h15"/>
                    <path d="M22 21a2 2 0 1 1-4 0c0-1.1 4-3 4-3s4 1.9 4 3z"/>
                </svg>
            </button>

            <div class="tool-separator"></div>

            <button class="tool-btn" id="lineTool" title="Line Tool (U)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="19" x2="19" y2="5"/>
                </svg>
            </button>
            <button class="tool-btn" id="rectangleTool" title="Rectangle Tool (U)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
            </button>
            <button class="tool-btn" id="ellipseTool" title="Ellipse Tool (U)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <ellipse cx="12" cy="12" rx="9" ry="9"/>
                </svg>
            </button>

            <div class="tool-separator"></div>

            <button class="tool-btn" id="textTool" title="Text Tool (T)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 7 4 4 20 4 20 7"/>
                    <line x1="9" y1="20" x2="15" y2="20"/>
                    <line x1="12" y1="4" x2="12" y2="20"/>
                </svg>
            </button>
            <button class="tool-btn" id="handTool" title="Hand Tool (H)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/>
                    <path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/>
                    <path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/>
                    <path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/>
                </svg>
            </button>
            <button class="tool-btn" id="eyedropperTool" title="Eyedropper (I)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 3l-4 4-4-4 4-4 4 4zM7 14a5 5 0 0 1-5 5h12a5 5 0 0 1-5-5l-1 1-1-1z"/>
                </svg>
            </button>

            <div style="flex: 1;"></div>

            <button class="tool-btn" id="foregroundColorBtn" title="Foreground Color" style="background: linear-gradient(135deg, #ff6b6b, #4ecdc4); border-radius: 4px;"></button>
            <button class="tool-btn" id="backgroundColorBtn" title="Background Color" style="background: #808080; border-radius: 4px; border: 2px solid #666;"></button>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-tabs">
                <button class="canvas-tab active" id="newDocTab">
                    Untitled-1
                    <span class="close-btn">×</span>
                </button>
                <button class="canvas-tab" id="addDocBtn" style="padding: 8px 12px;">+</button>
            </div>
            <div class="canvas-area">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <canvas class="canvas" id="mainCanvas"></canvas>
                </div>
            </div>
            <div class="tool-options-panel" id="toolOptionsPanel">
                <div class="tool-options-title">Brush Tool Options</div>
                <div class="tool-options-content" id="toolOptionsContent">
                    <!-- Dynamic content based on selected tool -->
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <!-- Layers Panel -->
            <div class="panel-section">
                <div class="panel-header">
                    Layers
                    <button class="expand-btn">▼</button>
                </div>
                <div class="panel-content">
                    <div class="layers-list" id="layersList">
                        <!-- Layers will be added here -->
                    </div>
                    <button class="add-layer-btn" id="addLayerBtn">+ New Layer</button>
                </div>
            </div>

            <!-- History Panel -->
            <div class="panel-section">
                <div class="panel-header">
                    History
                    <button class="expand-btn">▼</button>
                </div>
                <div class="panel-content">
                    <div class="history-list" id="historyList">
                        <!-- History items will be added here -->
                    </div>
                </div>
            </div>

            <!-- Color Panel -->
            <div class="panel-section">
                <div class="panel-header">Color</div>
                <div class="panel-content">
                    <div class="color-picker-section">
                        <div class="color-preview" id="foregroundColorPreview">
                            <input type="color" id="foregroundColor" value="#ff6b6b">
                        </div>
                        <div class="color-preview" id="backgroundColorPreview">
                            <input type="color" id="backgroundColor" value="#808080">
                        </div>
                    </div>
                    <div class="color-values" style="margin-top: 12px;">
                        <div class="color-input-row">
                            <label>R</label>
                            <input type="number" id="colorR" min="0" max="255" value="255">
                        </div>
                        <div class="color-input-row">
                            <label>G</label>
                            <input type="number" id="colorG" min="0" max="255" value="107">
                        </div>
                        <div class="color-input-row">
                            <label>B</label>
                            <input type="number" id="colorB" min="0" max="255" value="107">
                        </div>
                        <div class="color-input-row">
                            <label>#</label>
                            <input type="text" id="colorHex" value="#ff6b6b">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blending Options Panel -->
            <div class="panel-section">
                <div class="panel-header">Blending</div>
                <div class="panel-content">
                    <select class="blend-mode-select" id="blendMode">
                        <option value="normal">Normal</option>
                        <option value="multiply">Multiply</option>
                        <option value="screen">Screen</option>
                        <option value="overlay">Overlay</option>
                        <option value="darken">Darken</option>
                        <option value="lighten">Lighten</option>
                        <option value="color-dodge">Color Dodge</option>
                        <option value="color-burn">Color Burn</option>
                        <option value="soft-light">Soft Light</option>
                        <option value="hard-light">Hard Light</option>
                        <option value="difference">Difference</option>
                        <option value="exclusion">Exclusion</option>
                    </select>
                    <div class="opacity-slider">
                        <label>Opacity</label>
                        <input type="range" id="layerOpacity" min="0" max="100" value="100">
                        <span class="opacity-value" id="opacityValue">100%</span>
                    </div>
                </div>
            </div>

            <!-- Filters Panel -->
            <div class="panel-section">
                <div class="panel-header">Filters</div>
                <div class="panel-content">
                    <div class="filter-section">
                        <div class="filter-label">Brightness</div>
                        <div class="filter-control">
                            <input type="range" id="filterBrightness" min="-100" max="100" value="0">
                            <span class="filter-value" id="brightnessValue">0</span>
                        </div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-label">Contrast</div>
                        <div class="filter-control">
                            <input type="range" id="filterContrast" min="-100" max="100" value="0">
                            <span class="filter-value" id="contrastValue">0</span>
                        </div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-label">Saturation</div>
                        <div class="filter-control">
                            <input type="range" id="filterSaturation" min="-100" max="100" value="0">
                            <span class="filter-value" id="saturationValue">0</span>
                        </div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-label">Blur</div>
                        <div class="filter-control">
                            <input type="range" id="filterBlur" min="0" max="20" value="0">
                            <span class="filter-value" id="blurValue">0</span>
                        </div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-label">Sharpness</div>
                        <div class="filter-control">
                            <input type="range" id="filterSharpen" min="0" max="100" value="0">
                            <span class="filter-value" id="sharpenValue">0</span>
                        </div>
                    </div>
                    <div class="filter-toggle">
                        <label>Grayscale</label>
                        <input type="checkbox" id="filterGrayscale">
                    </div>
                    <div class="filter-toggle">
                        <label>Sepia</label>
                        <input type="checkbox" id="filterSepia">
                    </div>
                    <div class="filter-toggle">
                        <label>Invert</label>
                        <input type="checkbox" id="filterInvert">
                    </div>
                    <button class="apply-filter-btn" id="applyFiltersBtn">Apply to Layer</button>
                </div>
            </div>

            <!-- Brush Settings Panel -->
            <div class="panel-section">
                <div class="panel-header">Brush Settings</div>
                <div class="panel-content">
                    <div class="brush-preview">
                        <canvas id="brushPreview" width="80" height="50"></canvas>
                    </div>
                    <div class="brush-options">
                        <div class="brush-option-row">
                            <label>Size</label>
                            <input type="range" id="brushSize" min="1" max="100" value="20">
                            <span class="value-display" id="brushSizeValue">20px</span>
                        </div>
                        <div class="brush-option-row">
                            <label>Hardness</label>
                            <input type="range" id="brushHardness" min="0" max="100" value="100">
                            <span class="value-display" id="brushHardnessValue">100%</span>
                        </div>
                        <div class="brush-option-row">
                            <label>Opacity</label>
                            <input type="range" id="brushOpacity" min="1" max="100" value="100">
                            <span class="value-display" id="brushOpacityValue">100%</span>
                        </div>
                        <div class="brush-option-row">
                            <label>Spacing</label>
                            <input type="range" id="brushSpacing" min="1" max="100" value="10">
                            <span class="value-display" id="brushSpacingValue">10%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span id="toolStatus">Move Tool</span>
        <span id="cursorPosition">0, 0</span>
        <span id="imageSize">800 × 600 px</span>
        <span id="layerCount">1 Layer, 0 Channels</span>
    </div>

    <!-- Context Menu -->
    <div class="context-menu hidden" id="contextMenu">
        <div class="context-menu-item" data-action="undo">Undo</div>
        <div class="context-menu-item" data-action="redo">Redo</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="cut">Cut</div>
        <div class="context-menu-item" data-action="copy">Copy</div>
        <div class="context-menu-item" data-action="paste">Paste</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="selectAll">Select All</div>
        <div class="context-menu-item" data-action="deselect">Deselect</div>
    </div>

    <script>
        // PhotoEdit - Photoshop Clone
        class PhotoEdit {
            constructor() {
                this.canvas = document.getElementById('mainCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvasWrapper = document.getElementById('canvasWrapper');

                // Canvas settings
                this.canvasWidth = 800;
                this.canvasHeight = 600;
                this.canvas.style.width = this.canvasWidth + 'px';
                this.canvas.style.height = this.canvasHeight + 'px';
                this.canvas.width = this.canvasWidth;
                this.canvas.height = this.canvasHeight;

                // Layers
                this.layers = [];
                this.activeLayerIndex = 0;
                this.layerIdCounter = 0;

                // History
                this.history = [];
                this.historyIndex = -1;
                this.maxHistoryStates = 50;

                // Tool state
                this.activeTool = 'move';
                this.isDrawing = false;
                this.lastX = 0;
                this.lastY = 0;
                this.startX = 0;
                this.startY = 0;

                // Brush settings
                this.brushSize = 20;
                this.brushHardness = 100;
                this.brushOpacity = 100;
                this.brushSpacing = 10;

                // Colors
                this.foregroundColor = '#ff6b6b';
                this.backgroundColor = '#808080';

                // Selection
                this.selection = null;
                this.selectionStart = null;

                // Zoom
                this.zoom = 1;

                // Shape tool
                this.shapeType = null;

                // Initialize
                this.init();
            }

            init() {
                // Add initial layer
                this.addLayer('Background', true);
                this.layers[0].canvas.width = this.canvasWidth;
                this.layers[0].canvas.height = this.canvasHeight;
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(0, 0, this.canvasWidth, this.canvasHeight);

                // Save initial state
                this.saveState('New Document');

                // Setup event listeners
                this.setupEventListeners();
                this.updateBrushPreview();
                this.updateLayersPanel();
                this.updateHistoryPanel();
                this.updateToolOptions();
            }

            addLayer(name = 'Layer', isBackground = false) {
                const layerCanvas = document.createElement('canvas');
                layerCanvas.width = this.canvasWidth;
                layerCanvas.height = this.canvasHeight;

                const layer = {
                    id: this.layerIdCounter++,
                    name: name,
                    canvas: layerCanvas,
                    ctx: layerCanvas.getContext('2d'),
                    visible: true,
                    opacity: 100,
                    blendMode: 'normal',
                    isBackground: isBackground,
                    locked: isBackground
                };

                this.layers.push(layer);
                this.activeLayerIndex = this.layers.length - 1;

                this.render();
                this.updateLayersPanel();
                this.updateLayerCount();

                return layer;
            }

            duplicateLayer() {
                const activeLayer = this.getActiveLayer();
                if (!activeLayer) return;

                const newLayer = this.addLayer(activeLayer.name + ' Copy');
                const ctx = newLayer.canvas.getContext('2d');
                ctx.drawImage(activeLayer.canvas, 0, 0);

                this.saveState('Duplicate Layer');
                return newLayer;
            }

            deleteLayer() {
                if (this.layers.length <= 1) return;

                this.layers.splice(this.activeLayerIndex, 1);
                this.activeLayerIndex = Math.min(this.activeLayerIndex, this.layers.length - 1);

                this.render();
                this.updateLayersPanel();
                this.updateLayerCount();
                this.saveState('Delete Layer');
            }

            getActiveLayer() {
                return this.layers[this.activeLayerIndex];
            }

            render() {
                // Clear main canvas
                this.ctx.clearRect(0, 0, this.canvasWidth, this.canvasHeight);

                // Draw each visible layer
                for (const layer of this.layers) {
                    if (layer.visible) {
                        this.ctx.globalAlpha = layer.opacity / 100;
                        this.ctx.globalCompositeOperation = layer.blendMode;
                        this.ctx.drawImage(layer.canvas, 0, 0);
                    }
                }

                // Reset context
                this.ctx.globalAlpha = 1;
                this.ctx.globalCompositeOperation = 'source-over';

                // Draw selection overlay
                if (this.selection) {
                    this.ctx.strokeStyle = 'rgba(74, 158, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                    this.ctx.setLineDash([5, 5]);
                    this.ctx.strokeRect(this.selection.x, this.selection.y, this.selection.width, this.selection.height);
                    this.ctx.setLineDash([]);

                    // Selection handles
                    const handleSize = 8;
                    this.ctx.fillStyle = 'rgba(74, 158, 255, 0.3)';
                    this.ctx.fillRect(this.selection.x, this.selection.y, this.selection.width, this.selection.height);

                    // Draw handles at corners and edges
                    const handles = [
                        [this.selection.x, this.selection.y],
                        [this.selection.x + this.selection.width, this.selection.y],
                        [this.selection.x, this.selection.y + this.selection.height],
                        [this.selection.x + this.selection.width, this.selection.y + this.selection.height]
                    ];

                    this.ctx.fillStyle = '#ffffff';
                    this.ctx.strokeStyle = '#4a9eff';
                    this.ctx.lineWidth = 1;

                    for (const [x, y] of handles) {
                        this.ctx.fillRect(x - handleSize/2, y - handleSize/2, handleSize, handleSize);
                        this.ctx.strokeRect(x - handleSize/2, y - handleSize/2, handleSize, handleSize);
                    }
                }
            }

            saveState(action) {
                // Remove any future states if we're not at the end
                if (this.historyIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.historyIndex + 1);
                }

                // Create snapshot
                const snapshot = {
                    action: action,
                    timestamp: new Date().toLocaleTimeString(),
                    layers: this.layers.map(layer => ({
                        name: layer.name,
                        visible: layer.visible,
                        opacity: layer.opacity,
                        blendMode: layer.blendMode,
                        data: layer.canvas.toDataURL()
                    }))
                };

                this.history.push(snapshot);
                this.historyIndex++;

                // Limit history
                if (this.history.length > this.maxHistoryStates) {
                    this.history.shift();
                    this.historyIndex--;
                }

                this.updateHistoryPanel();
            }

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.restoreState(this.history[this.historyIndex]);
                    this.updateHistoryPanel();
                }
            }

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.restoreState(this.history[this.historyIndex]);
                    this.updateHistoryPanel();
                }
            }

            restoreState(state) {
                // Clear layers
                this.layers = [];

                // Restore each layer
                for (const layerData of state.layers) {
                    const layerCanvas = document.createElement('canvas');
                    layerCanvas.width = this.canvasWidth;
                    layerCanvas.height = this.canvasHeight;

                    const layer = {
                        id: this.layerIdCounter++,
                        name: layerData.name,
                        canvas: layerCanvas,
                        ctx: layerCanvas.getContext('2d'),
                        visible: layerData.visible,
                        opacity: layerData.opacity,
                        blendMode: layerData.blendMode,
                        isBackground: layerData.name === 'Background',
                        locked: layerData.name === 'Background'
                    };

                    const img = new Image();
                    img.onload = () => {
                        layer.ctx.drawImage(img, 0, 0);
                        this.render();
                    };
                    img.src = layerData.data;

                    this.layers.push(layer);
                }

                this.activeLayerIndex = this.layers.length - 1;
                this.updateLayersPanel();
                this.updateLayerCount();
                this.render();
            }

            updateLayersPanel() {
                const layersList = document.getElementById('layersList');
                layersList.innerHTML = '';

                // Reverse to show top layer first
                const reversedLayers = [...this.layers].reverse();

                for (let i = reversedLayers.length - 1; i >= 0; i--) {
                    const layer = reversedLayers[i];
                    const actualIndex = this.layers.indexOf(layer);
                    const isActive = actualIndex === this.activeLayerIndex;

                    const layerItem = document.createElement('div');
                    layerItem.className = `layer-item${isActive ? ' active' : ''}`;
                    layerItem.innerHTML = `
                        <div class="layer-preview">
                            <canvas width="32" height="32"></canvas>
                        </div>
                        <div class="layer-info">
                            <div class="layer-name">${layer.name}</div>
                            <div class="layer-type">${layer.locked ? 'Locked' : 'Normal'}</div>
                        </div>
                        <div class="layer-actions">
                            <button class="layer-action-btn visibility-btn" title="Toggle Visibility">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    ${layer.visible
                                        ? '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'
                                        : '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>'
                                    }
                                </svg>
                            </button>
                            <button class="layer-action-btn lock-btn" title="Lock/Unlock" ${layer.isBackground ? 'disabled' : ''}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    ${layer.locked
                                        ? '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>'
                                        : '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>'
                                    }
                                </svg>
                            </button>
                        </div>
                    `;

                    // Preview
                    const previewCanvas = layerItem.querySelector('canvas');
                    const previewCtx = previewCanvas.getContext('2d');
                    previewCtx.drawImage(layer.canvas, 0, 0, 32, 32);

                    // Click to select
                    layerItem.addEventListener('click', () => {
                        this.activeLayerIndex = actualIndex;
                        this.updateLayersPanel();
                        this.updateBlendingUI();
                        this.updateOpacityUI();
                    });

                    // Visibility toggle
                    const visibilityBtn = layerItem.querySelector('.visibility-btn');
                    visibilityBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        layer.visible = !layer.visible;
                        this.render();
                        this.updateLayersPanel();
                    });

                    // Lock toggle
                    const lockBtn = layerItem.querySelector('.lock-btn');
                    if (!layer.isBackground) {
                        lockBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            layer.locked = !layer.locked;
                            this.updateLayersPanel();
                        });
                    }

                    layersList.appendChild(layerItem);
                }
            }

            updateHistoryPanel() {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';

                // Show recent history items
                const recentHistory = this.history.slice(-20);

                for (let i = 0; i < recentHistory.length; i++) {
                    const actualIndex = this.history.length - recentHistory.length + i;
                    const item = recentHistory[i];
                    const isActive = actualIndex === this.historyIndex;

                    const historyItem = document.createElement('div');
                    historyItem.className = `history-item${isActive ? ' active' : ''}`;
                    historyItem.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span>${item.action}</span>
                    `;

                    historyItem.addEventListener('click', () => {
                        while (this.historyIndex > actualIndex) {
                            this.undo();
                        }
                        while (this.historyIndex < actualIndex) {
                            this.redo();
                        }
                    });

                    historyList.appendChild(historyItem);
                }
            }

            updateBrushPreview() {
                const previewCanvas = document.getElementById('brushPreview');
                const ctx = previewCanvas.getContext('2d');

                ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

                const centerX = previewCanvas.width / 2;
                const centerY = previewCanvas.height / 2;
                const size = this.brushSize / 4;

                // Create gradient for brush preview
                const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, size);
                gradient.addColorStop(0, this.foregroundColor);
                gradient.addColorStop(this.brushHardness / 100, this.foregroundColor);
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(centerX, centerY, size, 0, Math.PI * 2);
                ctx.fill();
            }

            updateToolOptions() {
                const content = document.getElementById('toolOptionsContent');

                switch (this.activeTool) {
                    case 'brush':
                    case 'pencil':
                    case 'eraser':
                        content.innerHTML = `
                            <div class="option-group">
                                <label>Mode:</label>
                                <select class="option-select" id="brushMode">
                                    <option value="normal">Normal</option>
                                    <option value="multiply">Multiply</option>
                                    <option value="screen">Screen</option>
                                    <option value="overlay">Overlay</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label>Sample:</label>
                                <select class="option-select" id="brushSample">
                                    <option value="all">All Layers</option>
                                    <option value="current">Current Layer</option>
                                </select>
                            </div>
                        `;
                        break;

                    case 'marquee':
                        content.innerHTML = `
                            <div class="option-group">
                                <label>Style:</label>
                                <select class="option-select" id="marqueeStyle">
                                    <option value="normal">Normal</option>
                                    <option value="fixed">Fixed Size</option>
                                    <option value="ratio">Fixed Aspect Ratio</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label>Feather:</label>
                                <input type="number" class="option-select" id="marqueeFeather" value="0" min="0" style="width: 50px;">
                            </div>
                        `;
                        break;

                    case 'line':
                    case 'rectangle':
                    case 'ellipse':
                        content.innerHTML = `
                            <div class="shape-options">
                                <button class="shape-option active" data-fill="stroke">Stroke</button>
                                <button class="shape-option" data-fill="fill">Fill</button>
                                <button class="shape-option" data-fill="both">Both</button>
                            </div>
                            <div class="option-group" style="margin-top: 8px;">
                                <label>Width:</label>
                                <input type="number" class="option-select" id="shapeWidth" value="2" min="1" style="width: 50px;">
                            </div>
                        `;

                        // Add event listeners for shape options
                        content.querySelectorAll('.shape-option').forEach(btn => {
                            btn.addEventListener('click', () => {
                                content.querySelectorAll('.shape-option').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                            });
                        });
                        break;

                    case 'gradient':
                        content.innerHTML = `
                            <div class="gradient-preview" id="gradientPreview" style="background: linear-gradient(90deg, #ff6b6b, #4ecdc4);"></div>
                            <div class="gradient-stops">
                                <div class="gradient-stop active" style="background: #ff6b6b;"></div>
                                <div class="gradient-stop" style="background: #4ecdc4;"></div>
                            </div>
                            <div class="fill-type-options" style="margin-top: 8px;">
                                <button class="fill-type-option active">Linear</button>
                                <button class="fill-type-option">Radial</button>
                            </div>
                        `;
                        break;

                    case 'text':
                        content.innerHTML = `
                            <div class="option-group">
                                <label>Font:</label>
                                <select class="option-select" id="textFont">
                                    <option value="Arial">Arial</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Courier New">Courier New</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Verdana">Verdana</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label>Size:</label>
                                <input type="number" class="option-select" id="textSize" value="24" min="8" style="width: 50px;">
                            </div>
                        `;
                        break;

                    default:
                        content.innerHTML = '<span style="color: #888; font-size: 11px;">No options available</span>';
                }
            }

            applyFilters() {
                const activeLayer = this.getActiveLayer();
                if (!activeLayer || activeLayer.locked) return;

                const brightness = parseInt(document.getElementById('filterBrightness').value);
                const contrast = parseInt(document.getElementById('filterContrast').value);
                const saturation = parseInt(document.getElementById('filterSaturation').value);
                const blur = parseInt(document.getElementById('filterBlur').value);
                const sharpen = parseInt(document.getElementById('filterSharpen').value);
                const grayscale = document.getElementById('filterGrayscale').checked;
                const sepia = document.getElementById('filterSepia').checked;
                const invert = document.getElementById('filterInvert').checked;

                // Get image data
                const imageData = activeLayer.ctx.getImageData(0, 0, activeLayer.canvas.width, activeLayer.canvas.height);
                const data = imageData.data;

                // Apply filters
                for (let i = 0; i < data.length; i += 4) {
                    let r = data[i];
                    let g = data[i + 1];
                    let b = data[i + 2];

                    // Brightness
                    r = Math.max(0, Math.min(255, r + brightness));
                    g = Math.max(0, Math.min(255, g + brightness));
                    b = Math.max(0, Math.min(255, b + brightness));

                    // Contrast
                    const contrastFactor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                    r = Math.max(0, Math.min(255, contrastFactor * (r - 128) + 128));
                    g = Math.max(0, Math.min(255, contrastFactor * (g - 128) + 128));
                    b = Math.max(0, Math.min(255, contrastFactor * (b - 128) + 128));

                    // Saturation
                    const gray = 0.2989 * r + 0.5870 * g + 0.1140 * b;
                    const satFactor = 1 + saturation / 100;
                    r = Math.max(0, Math.min(255, gray + satFactor * (r - gray)));
                    g = Math.max(0, Math.min(255, gray + satFactor * (g - gray)));
                    b = Math.max(0, Math.min(255, gray + satFactor * (b - gray)));

                    // Grayscale
                    if (grayscale) {
                        const gray = 0.2989 * r + 0.5870 * g + 0.1140 * b;
                        r = g = b = gray;
                    }

                    // Sepia
                    if (sepia) {
                        const newR = 0.393 * r + 0.769 * g + 0.189 * b;
                        const newG = 0.349 * r + 0.686 * g + 0.168 * b;
                        const newB = 0.272 * r + 0.534 * g + 0.131 * b;
                        r = Math.min(255, newR);
                        g = Math.min(255, newG);
                        b = Math.min(255, newB);
                    }

                    // Invert
                    if (invert) {
                        r = 255 - r;
                        g = 255 - g;
                        b = 255 - b;
                    }

                    data[i] = r;
                    data[i + 1] = g;
                    data[i + 2] = b;
                }

                activeLayer.ctx.putImageData(imageData, 0, 0);

                // Apply blur using canvas filter
                if (blur > 0) {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = activeLayer.canvas.width;
                    tempCanvas.height = activeLayer.canvas.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.filter = `blur(${blur}px)`;
                    tempCtx.drawImage(activeLayer.canvas, 0, 0);

                    // Blend with original
                    activeLayer.ctx.globalCompositeOperation = 'source-over';
                    activeLayer.ctx.globalAlpha = 0.5;
                    activeLayer.ctx.drawImage(tempCanvas, 0, 0);
                    activeLayer.ctx.globalAlpha = 1;
                }

                // Apply sharpen (simplified)
                if (sharpen > 0) {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = activeLayer.canvas.width;
                    tempCanvas.height = activeLayer.canvas.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.filter = `sharpen(${sharpen / 10})`;
                    tempCtx.drawImage(activeLayer.canvas, 0, 0);
                    activeLayer.ctx.drawImage(tempCanvas, 0, 0);
                }

                this.render();
                this.saveState('Apply Filters');
            }

            setActiveTool(tool) {
                this.activeTool = tool;

                // Update UI
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(tool + 'Tool')?.classList.add('active');

                // Update cursor
                if (tool === 'move' || tool === 'hand') {
                    this.canvas.style.cursor = 'grab';
                } else if (tool === 'text') {
                    this.canvas.style.cursor = 'text';
                } else {
                    this.canvas.style.cursor = 'crosshair';
                }

                // Update status
                const toolNames = {
                    move: 'Move Tool',
                    marquee: 'Marquee Selection',
                    lasso: 'Lasso Tool',
                    magicWand: 'Magic Wand',
                    brush: 'Brush Tool',
                    pencil: 'Pencil Tool',
                    eraser: 'Eraser Tool',
                    gradient: 'Gradient Tool',
                    fill: 'Paint Bucket',
                    line: 'Line Tool',
                    rectangle: 'Rectangle Tool',
                    ellipse: 'Ellipse Tool',
                    text: 'Text Tool',
                    hand: 'Hand Tool',
                    eyedropper: 'Eyedropper'
                };
                document.getElementById('toolStatus').textContent = toolNames[tool] || 'Tool';

                this.updateToolOptions();
            }

            draw(x, y) {
                const activeLayer = this.getActiveLayer();
                if (!activeLayer || activeLayer.locked) return;

                const ctx = activeLayer.ctx;
                const isEraser = this.activeTool === 'eraser';

                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = this.brushSize;
                ctx.strokeStyle = isEraser ? 'rgba(255, 255, 255, 1)' : this.foregroundColor;
                ctx.globalAlpha = this.brushOpacity / 100;

                // Apply hardness
                if (this.brushHardness < 100) {
                    // Create a temporary canvas for the brush stroke
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = this.canvasWidth;
                    tempCanvas.height = this.canvasHeight;
                    const tempCtx = tempCanvas.getContext('2d');

                    tempCtx.lineCap = 'round';
                    tempCtx.lineJoin = 'round';
                    tempCtx.lineWidth = this.brushSize;
                    tempCtx.strokeStyle = this.foregroundColor;
                    tempCtx.globalAlpha = this.brushOpacity / 100;
                    tempCtx.beginPath();
                    tempCtx.moveTo(this.lastX, this.lastY);
                    tempCtx.lineTo(x, y);
                    tempCtx.stroke();

                    // Apply hardness by creating a gradient mask
                    const hardnessRatio = this.brushHardness / 100;
                    const maskData = tempCtx.getImageData(0, 0, tempCanvas.width, temp for (let i = 0; i < maskData.data.length; i += 4) {
                        maskData.data[i + 3] *=Canvas.height);
                    hardnessRatio;
                    }
                    tempCtx.putImageData(maskData, 0, 0);

                    if (isEraser) {
                        ctx.globalCompositeOperation = 'destination-out';
                    } else {
                        ctx.globalCompositeOperation = 'source-over';
                    }
                    ctx.drawImage(tempCanvas, 0, 0);
                } else {
                    ctx.beginPath();
                    ctx.moveTo(this.lastX, this.lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();

                    if (isEraser) {
                        ctx.globalCompositeOperation = 'destination-out';
                    }
                }

                ctx.globalAlpha = 1;
                ctx.globalCompositeOperation = 'source-over';

                this.render();
            }

            setupEventListeners() {
                // Canvas events
                this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
                this.canvas.addEventListener('mouseup', (e) => this.onMouseUp(e));
                this.canvas.addEventListener('mouseleave', (e) => this.onMouseUp(e));
                this.canvas.addEventListener('contextmenu', (e) => this.onContextMenu(e));

                // Tool buttons
                document.getElementById('moveTool').addEventListener('click', () => this.setActiveTool('move'));
                document.getElementById('marqueeTool').addEventListener('click', () => this.setActiveTool('marquee'));
                document.getElementById('lassoTool').addEventListener('click', () => this.setActiveTool('lasso'));
                document.getElementById('magicWandTool').addEventListener('click', () => this.setActiveTool('magicWand'));
                document.getElementById('brushTool').addEventListener('click', () => this.setActiveTool('brush'));
                document.getElementById('pencilTool').addEventListener('click', () => this.setActiveTool('pencil'));
                document.getElementById('eraserTool').addEventListener('click', () => this.setActiveTool('eraser'));
                document.getElementById('gradientTool').addEventListener('click', () => this.setActiveTool('gradient'));
                document.getElementById('fillTool').addEventListener('click', () => this.setActiveTool('fill'));
                document.getElementById('lineTool').addEventListener('click', () => this.setActiveTool('line'));
                document.getElementById('rectangleTool').addEventListener('click', () => this.setActiveTool('rectangle'));
                document.getElementById('ellipseTool').addEventListener('click', () => this.setActiveTool('ellipse'));
                document.getElementById('textTool').addEventListener('click', () => this.setActiveTool('text'));
                document.getElementById('handTool').addEventListener('click', () => this.setActiveTool('hand'));
                document.getElementById('eyedropperTool').addEventListener('click', () => this.setActiveTool('eyedropper'));

                // Brush settings
                document.getElementById('brushSize').addEventListener('input', (e) => {
                    this.brushSize = parseInt(e.target.value);
                    document.getElementById('brushSizeValue').textContent = this.brushSize + 'px';
                    this.updateBrushPreview();
                });

                document.getElementById('brushHardness').addEventListener('input', (e) => {
                    this.brushHardness = parseInt(e.target.value);
                    document.getElementById('brushHardnessValue').textContent = this.brushHardness + '%';
                    this.updateBrushPreview();
                });

                document.getElementById('brushOpacity').addEventListener('input', (e) => {
                    this.brushOpacity = parseInt(e.target.value);
                    document.getElementById('brushOpacityValue').textContent = this.brushOpacity + '%';
                });

                document.getElementById('brushSpacing').addEventListener('input', (e) => {
                    this.brushSpacing = parseInt(e.target.value);
                    document.getElementById('brushSpacingValue').textContent = this.brushSpacing + '%';
                });

                // Color picker
                document.getElementById('foregroundColor').addEventListener('input', (e) => {
                    this.foregroundColor = e.target.value;
                    document.getElementById('colorR').value = parseInt(this.foregroundColor.slice(1, 3), 16);
                    document.getElementById('colorG').value = parseInt(this.foregroundColor.slice(3, 5), 16);
                    document.getElementById('colorB').value = parseInt(this.foregroundColor.slice(5, 7), 16);
                    document.getElementById('colorHex').value = this.foregroundColor;
                    this.updateBrushPreview();
                });

                document.getElementById('backgroundColor').addEventListener('input', (e) => {
                    this.backgroundColor = e.target.value;
                });

                // RGB inputs
                const updateColorFromRGB = () => {
                    const r = parseInt(document.getElementById('colorR').value) || 0;
                    const g = parseInt(document.getElementById('colorG').value) || 0;
                    const b = parseInt(document.getElementById('colorB').value) || 0;
                    this.foregroundColor = '#' + [r, g, b].map(x => {
                        const hex = Math.max(0, Math.min(255, x)).toString(16);
                        return hex.length === 1 ? '0' + hex : hex;
                    }).join('');
                    document.getElementById('foregroundColor').value = this.foregroundColor;
                    document.getElementById('colorHex').value = this.foregroundColor;
                    this.updateBrushPreview();
                };

                document.getElementById('colorR').addEventListener('input', updateColorFromRGB);
                document.getElementById('colorG').addEventListener('input', updateColorFromRGB);
                document.getElementById('colorB').addEventListener('input', updateColorFromRGB);

                document.getElementById('colorHex').addEventListener('input', (e) => {
                    const hex = e.target.value;
                    if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
                        this.foregroundColor = hex;
                        document.getElementById('foregroundColor').value = hex;
                        document.getElementById('colorR').value = parseInt(hex.slice(1, 3), 16);
                        document.getElementById('colorG').value = parseInt(hex.slice(3, 5), 16);
                        document.getElementById('colorB').value = parseInt(hex.slice(5, 7), 16);
                        this.updateBrushPreview();
                    }
                });

                // Blending options
                document.getElementById('blendMode').addEventListener('change', (e) => {
                    const activeLayer = this.getActiveLayer();
                    if (activeLayer) {
                        activeLayer.blendMode = e.target.value;
                        this.render();
                    }
                });

                document.getElementById('layerOpacity').addEventListener('input', (e) => {
                    const activeLayer = this.getActiveLayer();
                    if (activeLayer) {
                        activeLayer.opacity = parseInt(e.target.value);
                        document.getElementById('opacityValue').textContent = activeLayer.opacity + '%';
                        this.render();
                    }
                });

                // Filter sliders
                const filterInputs = ['filterBrightness', 'filterContrast', 'filterSaturation', 'filterBlur', 'filterSharpen'];
                filterInputs.forEach(id => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        const valueEl = document.getElementById(id.replace('filter', '') + 'Value');
                        if (valueEl) valueEl.textContent = e.target.value;
                    });
                });

                document.getElementById('applyFiltersBtn').addEventListener('click', () => {
                    this.applyFilters();
                });

                // Layer actions
                document.getElementById('addLayerBtn').addEventListener('click', () => {
                    this.addLayer();
                    this.saveState('New Layer');
                });

                // Undo/Redo
                document.getElementById('undoBtn').addEventListener('click', () => this.undo());
                document.getElementById('redoBtn').addEventListener('click', () => this.redo());

                // Zoom
                document.getElementById('zoomInBtn').addEventListener('click', () => {
                    this.zoom = Math.min(4, this.zoom + 0.25);
                    this.canvas.style.transform = `scale(${this.zoom})`;
                    document.getElementById('zoomValue').textContent = Math.round(this.zoom * 100) + '%';
                });

                document.getElementById('zoomOutBtn').addEventListener('click', () => {
                    this.zoom = Math.max(0.25, this.zoom - 0.25);
                    this.canvas.style.transform = `scale(${this.zoom})`;
                    document.getElementById('zoomValue').textContent = Math.round(this.zoom * 100) + '%';
                });

                // Export
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportImage();
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') {
                            e.preventDefault();
                            if (e.shiftKey) {
                                this.redo();
                            } else {
                                this.undo();
                            }
                        } else if (e.key === 'y') {
                            e.preventDefault();
                            this.redo();
                        } else if (e.key === 's') {
                            e.preventDefault();
                            this.exportImage();
                        }
                    } else {
                        // Tool shortcuts
                        const toolShortcuts = {
                            'v': 'move',
                            'm': 'marquee',
                            'l': 'lasso',
                            'w': 'magicWand',
                            'b': 'brush',
                            'n': 'pencil',
                            'e': 'eraser',
                            'g': 'fill',
                            'u': 'line',
                            't': 'text',
                            'h': 'hand',
                            'i': 'eyedropper'
                        };
                        if (toolShortcuts[e.key.toLowerCase()]) {
                            this.setActiveTool(toolShortcuts[e.key.toLowerCase()]);
                        }
                    }
                });

                // Context menu
                document.addEventListener('click', () => {
                    document.getElementById('contextMenu').classList.add('hidden');
                });

                document.getElementById('contextMenu').addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    if (action === 'undo') this.undo();
                    else if (action === 'redo') this.redo();
                });
            }

            onMouseDown(e) {
                const rect = this.canvas.getBoundingClientRect();
                this.startX = this.lastX = (e.clientX - rect.left) / this.zoom;
                this.startY = this.lastY = (e.clientY - rect.top) / this.zoom;
                this.isDrawing = true;

                if (this.activeTool === 'brush' || this.activeTool === 'pencil' || this.activeTool === 'eraser') {
                    this.draw(this.startX, this.startY);
                } else if (this.activeTool === 'eyedropper') {
                    this.pickColor(this.startX, this.startY);
                } else if (this.activeTool === 'text') {
                    this.addText(this.startX, this.startY);
                }
            }

            onMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / this.zoom;
                const y = (e.clientY - rect.top) / this.zoom;

                // Update cursor position display
                document.getElementById('cursorPosition').textContent = `${Math.round(x)}, ${Math.round(y)}`;

                if (this.isDrawing) {
                    if (this.activeTool === 'brush' || this.activeTool === 'pencil' || this.activeTool === 'eraser') {
                        this.draw(x, y);
                    } else if (this.activeTool === 'marquee' || this.activeTool === 'lasso') {
                        this.updateSelection(x, y);
                    } else if (this.activeTool === 'move') {
                        // Pan canvas
                        const dx = x - this.lastX;
                        const dy = y - this.lastY;
                        this.canvasWrapper.scrollLeft -= dx * this.zoom;
                        this.canvasWrapper.scrollTop -= dy * this.zoom;
                    } else if (this.activeTool === 'line' || this.activeTool === 'rectangle' || this.activeTool === 'ellipse') {
                        this.drawShapePreview(x, y);
                    } else if (this.activeTool === 'gradient') {
                        this.drawGradientPreview(x, y);
                    }
                }

                this.lastX = x;
                this.lastY = y;
            }

            onMouseUp(e) {
                if (this.isDrawing) {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / this.zoom;
                    const y = (e.clientY - rect.top) / this.zoom;

                    if (this.activeTool === 'line' || this.activeTool === 'rectangle' || this.activeTool === 'ellipse') {
                        this.drawShape(x, y);
                    } else if (this.activeTool === 'marquee') {
                        this.finalizeSelection(x, y);
                    }

                    if (['brush', 'pencil', 'eraser'].includes(this.activeTool)) {
                        this.saveState(this.activeTool === 'eraser' ? 'Erase' : 'Paint');
                    }
                }

                this.isDrawing = false;
            }

            onContextMenu(e) {
                e.preventDefault();
                const menu = document.getElementById('contextMenu');
                menu.style.left = e.clientX + 'px';
                menu.style.top = e.clientY + 'px';
                menu.classList.remove('hidden');
            }

            pickColor(x, y) {
                const activeLayer = this.getActiveLayer();
                if (!activeLayer) return;

                const imageData = activeLayer.ctx.getImageData(x, y, 1, 1);
                const [r, g, b] = imageData.data;

                this.foregroundColor = '#' + [r, g, b].map(x => {
                    const hex = x.toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');

                document.getElementById('foregroundColor').value = this.foregroundColor;
                document.getElementById('colorR').value = r;
                document.getElementById('colorG').value = g;
                document.getElementById('colorB').value = b;
                document.getElementById('colorHex').value = this.foregroundColor;
                this.updateBrushPreview();
            }

            updateSelection(x, y) {
                const activeLayer = this.getActiveLayer();
                if (!activeLayer) return;

                this.selection = {
                    x: Math.min(this.startX, x),
                    y: Math.min(this.startY, y),
                    width: Math.abs(x - this.startX),
                    height: Math.abs(y - this.startY)
                };

                this.render();
            }

            finalizeSelection(x, y) {
                if (this.selection && this.selection.width > 5 && this.selection.height > 5) {
                    this.selectionStart = { ...this.selection };
                } else {
                    this.selection = null;
                    this.render();
                }
            }

            drawShapePreview(x, y) {
                // Redraw to clear previous preview
                this.render();

                const activeLayer = this.getActiveLayer();
                if (!activeLayer) return;

                const ctx = activeLayer.ctx;
                const startX = this.startX;
                const startY = this.startY;

                ctx.strokeStyle = this.foregroundColor;
                ctx.fillStyle = this.foregroundColor;
                ctx.lineWidth = parseInt(document.getElementById('shapeWidth')?.value || 2);

                if (this.activeTool === 'line') {
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                } else if (this.activeTool === 'rectangle') {
                    const width = x - startX;
                    const height = y - startY;
                    ctx.strokeRect(startX, startY, width, height);
                } else if (this.activeTool === 'ellipse') {
                    const centerX = (startX + x) / 2;
                    const centerY = (startY + y) / 2;
                    const radiusX = Math.abs(x - startX) / 2;
                    const radiusY = Math.abs(y - startY) / 2;
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);
                    ctx.stroke();
                }

                this.render();
            }

            drawShape(x, y) {
                // Clear and redraw from history
                this.render();

                const activeLayer = this.getActiveLayer();
                if (!activeLayer) return;

                const ctx = activeLayer.ctx;
                const startX = this.startX;
                const startY = this.startY;
                const width = x - startX;
                const height = y - startY;

                ctx.strokeStyle = this.foregroundColor;
                ctx.fillStyle = this.foregroundColor;
                ctx.lineWidth = parseInt(document.getElementById('shapeWidth')?.value || 2);

                if (this.activeTool === 'line') {
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                } else if (this.activeTool === 'rectangle') {
                    ctx.strokeRect(startX, startY, width, height);
                } else if (this.activeTool === 'ellipse') {
                    const centerX = (startX + x) / 2;
                    const centerY = (startY + y) / 2;
                    const radiusX = Math.abs(width) / 2;
                    const radiusY = Math.abs(height) / 2;
                    ctx.beginPath();
                    ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);
                    ctx.stroke();
                }

                this.render();
                this.saveState('Draw Shape');
            }

            drawGradientPreview(x, y) {
                this.render();
            }

            addText(x, y) {
                const text = prompt('Enter text:');
                if (text) {
                    const activeLayer = this.getActiveLayer();
                    if (!activeLayer || activeLayer.locked) return;

                    const fontSize = parseInt(document.getElementById('textSize')?.value || 24);
                    const fontFamily = document.getElementById('textFont')?.value || 'Arial';

                    activeLayer.ctx.font = `${fontSize}px ${fontFamily}`;
                    activeLayer.ctx.fillStyle = this.foregroundColor;
                    activeLayer.ctx.fillText(text, x, y);

                    this.render();
                    this.saveState('Add Text');
                }
            }

            updateBlendingUI() {
                const activeLayer = this.getActiveLayer();
                if (activeLayer) {
                    document.getElementById('blendMode').value = activeLayer.blendMode;
                }
            }

            updateOpacityUI() {
                const activeLayer = this.getActiveLayer();
                if (activeLayer) {
                    document.getElementById('layerOpacity').value = activeLayer.opacity;
                    document.getElementById('opacityValue').textContent = activeLayer.opacity + '%';
                }
            }

            updateLayerCount() {
                document.getElementById('layerCount').textContent = `${this.layers.length} Layer${this.layers.length !== 1 ? 's' : ''}, 0 Channels`;
            }

            exportImage() {
                // Create a temporary canvas with only visible layers
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.canvasWidth;
                tempCanvas.height = this.canvasHeight;
                const tempCtx = tempCanvas.getContext('2d');

                for (const layer of this.layers) {
                    if (layer.visible) {
                        tempCtx.globalAlpha = layer.opacity / 100;
                        tempCtx.globalCompositeOperation = layer.blendMode;
                        tempCtx.drawImage(layer.canvas, 0, 0);
                    }
                }

                // Download
                const link = document.createElement('a');
                link.download = 'photoedit-export.png';
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            new PhotoEdit();
        });
    </script>

<script>
/**
 * Iframe 元素高亮注入脚本
 * 需要在目标网站中引入此脚本来支持跨域 iframe 高亮功能
 *
 * 使用方法：
 * 1. 将此脚本添加到目标网站的 HTML 中
 * 2. 或通过浏览器扩展、用户脚本等方式注入
 */

(function () {
  "use strict";

  // 检查是否在 iframe 中
  if (window.self === window.top) {
    return; // 不在 iframe 中，不执行
  }

  // 检查是否已经初始化过
  if (window.__iframeHighlightInitialized) {
    return;
  }
  window.__iframeHighlightInitialized = true;
  console.log("Iframe 高亮脚本已加载");

  // 创建高亮覆盖层
  var overlay = document.createElement("div");
  overlay.id = "iframe-highlight-overlay";
  overlay.style.cssText = "\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    pointer-events: none;\n    z-index: 999999;\n    overflow: hidden;\n  ";

  // 创建悬停高亮框（虚线边框）
  var highlightBox = document.createElement("div");
  highlightBox.id = "iframe-highlight-box";
  highlightBox.style.cssText = "\n    position: absolute;\n    border: 2px dashed #007AFF;\n    background: rgba(0, 122, 255, 0.08);\n    pointer-events: none;\n    display: none;\n    transition: all 0.1s ease;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8);\n    border-radius: 2px;\n  ";

  // 创建选中节点的常驻高亮框（实线边框）
  var selectedBox = document.createElement("div");
  selectedBox.id = "iframe-selected-box";
  selectedBox.style.cssText = "\n    position: absolute;\n    border: 2px solid #007AFF;\n    pointer-events: none;\n    display: none;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.9), 0 0 8px rgba(255, 107, 53, 0.4);\n    border-radius: 2px;\n    z-index: 1000000;\n  ";

  // 创建悬停标签显示
  var tagLabel = document.createElement("div");
  tagLabel.id = "iframe-tag-label";
  tagLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 2px 6px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 2px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000001;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n    font-weight: 500;\n  ";

  // 创建选中节点标签
  var selectedLabel = document.createElement("div");
  selectedLabel.id = "iframe-selected-label";
  selectedLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 3px 8px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 3px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000002;\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);\n    font-weight: 600;\n  ";
  overlay.appendChild(highlightBox);
  overlay.appendChild(selectedBox);
  overlay.appendChild(tagLabel);
  overlay.appendChild(selectedLabel);
  document.body.appendChild(overlay);

  // 存储当前选中的元素
  var selectedElement = null;
  var highlightEnabled = false;

  // 更新选中元素的高亮显示
  function updateSelectedHighlight(element) {
    console.log("updateSelectedHighlight called with:", element);
    if (!element) {
      selectedBox.style.display = "none";
      selectedLabel.style.display = "none";
      selectedElement = null;
      console.log("Cleared selected highlight");
      return;
    }
    selectedElement = element;
    var rect = element.getBoundingClientRect();
    console.log("Selected element rect:", rect);

    // 更新选中高亮框位置
    selectedBox.style.display = "block";
    selectedBox.style.left = "".concat(rect.left - 2, "px");
    selectedBox.style.top = "".concat(rect.top - 2, "px");
    selectedBox.style.width = "".concat(rect.width + 4, "px");
    selectedBox.style.height = "".concat(rect.height + 4, "px");

    // 更新选中标签位置和内容
    selectedLabel.style.display = "block";
    selectedLabel.textContent = "\u2713 <".concat(element.tagName.toLowerCase(), ">");

    // 计算标签位置，确保不超出视窗
    var labelTop = rect.top - 28;
    var labelLeft = rect.left;

    // 如果标签会超出顶部，显示在元素下方
    if (labelTop < 5) {
      labelTop = rect.bottom + 5;
    }

    // 如果标签会超出右侧，向左调整
    var labelWidth = selectedLabel.offsetWidth || 100; // 预估宽度
    if (labelLeft + labelWidth > window.innerWidth - 10) {
      labelLeft = window.innerWidth - labelWidth - 10;
    }
    selectedLabel.style.left = "".concat(Math.max(5, labelLeft), "px");
    selectedLabel.style.top = "".concat(labelTop, "px");
    console.log("Selected highlight positioned at:", {
      left: selectedBox.style.left,
      top: selectedBox.style.top,
      width: selectedBox.style.width,
      height: selectedBox.style.height
    });
  }
  function getElementSelector(element) {
    if (!(element instanceof Element)) throw new Error('Argument must be a DOM element');
    var segments = [];
    var current = element;
    while (current !== document.documentElement) {
      var selector = '';
      // 优先检查唯一ID
      if (current.id && document.querySelectorAll("#".concat(current.id)).length === 1) {
        segments.unshift("#".concat(current.id));
        break; // ID唯一，无需继续向上
      }

      // 生成类名选择器（取第一个有效类名）
      var classes = Array.from(current.classList).filter(function (c) {
        return !c.startsWith('js-');
      });
      var className = classes.length > 0 ? ".".concat(classes[0]) : '';

      // 生成位置索引（nth-child）
      var tag = current.tagName.toLowerCase();
      if (!className) {
        var siblings = Array.from(current.parentNode.children);
        var index = siblings.findIndex(function (el) {
          return el === current;
        }) + 1;
        selector = "".concat(tag, ":nth-child(").concat(index, ")");
      } else {
        selector = className;
      }
      segments.unshift(selector);
      current = current.parentElement;
    }

    // 处理根元素
    if (current === document.documentElement) {
      segments.unshift('html');
    }
    return segments.join(' > ');
  }

  // 获取元素文本内容
  function getElementText(element) {
    var _element$textContent;
    if (element.tagName === "INPUT") {
      return element.value || element.placeholder || "";
    }
    if (element.tagName === "TEXTAREA") {
      return element.value || element.placeholder || "";
    }
    var text = ((_element$textContent = element.textContent) === null || _element$textContent === void 0 ? void 0 : _element$textContent.trim()) || "";
    return text.length > 50 ? text.substring(0, 50) + "..." : text;
  }

  // 获取元素属性信息
  function getElementAttributes(element) {
    var attrs = {};
    for (var i = 0; i < element.attributes.length; i++) {
      var attr = element.attributes[i];
      attrs[attr.name] = attr.value;
    }
    return attrs;
  }

  // 鼠标悬停事件处理
  function handleMouseOver(e) {
    if (!highlightEnabled) return;
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // 避免高亮 html 和 body 元素
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // 如果是已选中的元素，不显示悬停高亮
    if (target === selectedElement) {
      highlightBox.style.display = "none";
      tagLabel.style.display = "none";
      return;
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);

    // 更新悬停高亮框位置
    highlightBox.style.display = "block";
    highlightBox.style.left = "".concat(rect.left - 2, "px");
    highlightBox.style.top = "".concat(rect.top - 2, "px");
    highlightBox.style.width = "".concat(rect.width + 4, "px");
    highlightBox.style.height = "".concat(rect.height + 4, "px");

    // 更新标签位置和内容
    tagLabel.style.display = "block";
    tagLabel.textContent = "<".concat(target.tagName.toLowerCase(), ">");

    // 计算标签位置，确保不超出视窗
    var labelTop = rect.top - 22;
    var labelLeft = rect.left;

    // 如果标签会超出顶部，显示在元素下方
    if (labelTop < 0) {
      labelTop = rect.bottom + 5;
    }

    // 如果标签会超出右侧，向左调整
    if (labelLeft + tagLabel.offsetWidth > window.innerWidth) {
      labelLeft = window.innerWidth - tagLabel.offsetWidth - 5;
    }
    tagLabel.style.left = "".concat(Math.max(0, labelLeft), "px");
    tagLabel.style.top = "".concat(labelTop, "px");

    // 发送消息到父窗口
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 鼠标离开事件处理
  function handleMouseOut(e) {
    if (!highlightEnabled) return;
    var relatedTarget = e.relatedTarget;

    // 如果鼠标移动到高亮相关元素上，不隐藏高亮
    if (relatedTarget && (relatedTarget === highlightBox || relatedTarget === tagLabel || relatedTarget === overlay || relatedTarget === selectedBox || relatedTarget === selectedLabel)) {
      return;
    }
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: null,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 点击事件处理
  function handleClick(e) {
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // 避免处理 html 和 body 元素
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // 检查是否是交互元素，这些元素需要保留默认行为
    var isInteractiveElement = ['input', 'textarea', 'select', 'button', 'a'].includes(target.tagName.toLowerCase());

    // 如果高亮功能启用，对于非交互元素阻止默认行为和事件传播
    if (highlightEnabled) {
      e.preventDefault();
      e.stopPropagation();
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);
    console.log("Element clicked:", {
      tagName: target.tagName,
      selector: selector,
      rect: rect
    });

    // 立即更新选中高亮
    updateSelectedHighlight(target);

    // 隐藏悬停高亮，因为现在是选中状态
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-click",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 监听来自父窗口的消息
  function handleParentMessage(event) {
    console.log("Received message from parent:", event.data);
    if (event.data.type === "iframe-highlight-toggle") {
      var enabled = event.data.enabled;
      console.log("Highlight toggle:", enabled);
      if (enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "enable-iframe-highlight") {
      console.log("Enable iframe highlight");
      enableHighlight();
    } else if (event.data.type === "disable-iframe-highlight") {
      console.log("Disable iframe highlight");
      disableHighlight();
    } else if (event.data.type === "toggle-iframe-highlight") {
      var _enabled = event.data.enabled !== undefined ? event.data.enabled : !highlightEnabled;
      console.log("Toggle iframe highlight to:", _enabled);
      if (_enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "update-selected-element") {
      var selector = event.data.selector;
      console.log("Update selected element with selector:", selector);
      if (selector) {
        try {
          var element = document.querySelector(selector);
          console.log("Found element by selector:", element);
          updateSelectedHighlight(element);
        } catch (error) {
          console.warn("Failed to select element:", error);
          updateSelectedHighlight(null);
        }
      } else {
        updateSelectedHighlight(null);
      }
    } else if (event.data.type === "clear-selected-element") {
      console.log("Clear selected element");
      updateSelectedHighlight(null);
    }
  }

  // 启用高亮功能
  function enableHighlight() {
    console.log("Enabling highlight");
    document.addEventListener("mouseover", handleMouseOver, true);
    document.addEventListener("mouseout", handleMouseOut, true);
    document.addEventListener("click", handleClick, true);
    highlightEnabled = true;
    overlay.style.display = "block";
  }

  // 禁用高亮功能
  function disableHighlight() {
    console.log("Disabling highlight");
    highlightEnabled = false;
    // 保持事件监听器，但通过 highlightEnabled 变量控制行为
    // 这样可以保留选中状态的显示
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    // 不隐藏 selectedBox 和 selectedLabel，保留选中状态
  }

  // 完全禁用高亮功能（移除所有监听器）
  function fullyDisableHighlight() {
    console.log("Fully disabling highlight");
    highlightEnabled = false;
    document.removeEventListener("mouseover", handleMouseOver, true);
    document.removeEventListener("mouseout", handleMouseOut, true);
    document.removeEventListener("click", handleClick, true);
    overlay.style.display = "none";
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    selectedBox.style.display = "none";
    selectedLabel.style.display = "none";
  }

  // 添加事件监听
  enableHighlight();
  window.addEventListener("message", handleParentMessage);

  // 暴露全局函数供外部调用
  window.__iframeHighlightControl = {
    enable: enableHighlight,
    disable: disableHighlight,
    fullyDisable: fullyDisableHighlight,
    isEnabled: function isEnabled() {
      return highlightEnabled;
    },
    getSelectedElement: function getSelectedElement() {
      return selectedElement;
    },
    updateSelected: updateSelectedHighlight,
    // 通过消息发送开关控制
    sendToggleMessage: function sendToggleMessage(enabled) {
      window.parent.postMessage({
        type: 'iframe-highlight-status',
        enabled: enabled || highlightEnabled,
        source: 'iframe-highlight-injector'
      }, '*');
    }
  };

  // 通知父窗口脚本已加载
  try {
    window.parent.postMessage({
      type: "iframe-highlight-ready",
      data: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now()
      },
      source: "iframe-highlight-injector"
    }, "*");
  } catch (error) {
    console.warn("无法发送就绪消息到父窗口:", error);
  }

  // 清理函数
  window.__iframeHighlightCleanup = function () {
    fullyDisableHighlight();
    window.removeEventListener("message", handleParentMessage);
    if (overlay.parentElement) {
      overlay.parentElement.removeChild(overlay);
    }
    delete window.__iframeHighlightInitialized;
    delete window.__iframeHighlightCleanup;
  };
})();

</script>
</body>
</html>
