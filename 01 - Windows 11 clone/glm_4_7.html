<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 11 Web Clone</title>
    <!-- Remix Icon for UI Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f3f3f3;
            --taskbar-bg: rgba(243, 243, 243, 0.85);
            --window-bg: #ffffff;
            --hover-bg: rgba(255, 255, 255, 0.5);
            --active-border: rgba(0, 0, 0, 0.1);
            --glass-border: rgba(255, 255, 255, 0.4);
            --dark-text: #1a1a1a;
            --light-text: #ffffff;
            --accent-color: #0067c0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.25);
            --mica: rgba(255, 255, 255, 0.7);
        }

        * {
            box-sizing: border-box;
            user-select: none; /* Desktop feel */
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Windows 11 Bloom Wallpaper */
            background: url('https://images.idgesg.net/images/article/2021/01/windows-11-wallpaper-100877205-large.jpg') no-repeat center center fixed;
            background-size: cover;
            color: var(--dark-text);
        }

        /* --- Desktop Icons --- */
        #desktop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 48px; /* Taskbar height */
            padding: 10px;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 5px;
            z-index: 1;
        }

        .desktop-icon {
            width: 74px;
            height: 86px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 5px;
            border-radius: 4px;
            cursor: default;
            transition: background 0.1s;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .desktop-icon.selected {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .desktop-icon img, .desktop-icon i {
            width: 48px;
            height: 48px;
            margin-bottom: 5px;
            font-size: 48px; /* For RemixIcon fallback */
        }

        .desktop-icon span {
            font-size: 12px;
            text-align: center;
            line-height: 1.2;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Custom SVG Icons styling */
        .app-svg {
            width: 48px;
            height: 48px;
        }

        /* --- Taskbar --- */
        #taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: var(--taskbar-bg);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            border-top: 1px solid var(--glass-border);
        }

        .taskbar-icons {
            display: flex;
            gap: 4px;
            height: 40px;
            align-items: center;
        }

        .taskbar-icon {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.2s, transform 0.1s;
            cursor: pointer;
            position: relative;
        }

        .taskbar-icon:hover {
            background: rgba(255,255,255,0.5);
        }

        .taskbar-icon:active {
            transform: scale(0.95);
        }

        .taskbar-icon.open::after {
            content: '';
            position: absolute;
            bottom: 2px;
            width: 6px;
            height: 3px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        .taskbar-icon img {
            width: 24px;
            height: 24px;
        }

        /* Start Button Special Styling */
        #start-btn {
            color: #0078d4;
        }

        /* System Tray */
        #system-tray {
            position: absolute;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
            padding-right: 15px;
            gap: 15px;
            font-size: 12px;
        }

        .tray-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            cursor: default;
        }

        .tray-icons {
            display: flex;
            gap: 10px;
            font-size: 16px;
        }

        /* --- Windows --- */
        #window-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 48px);
            pointer-events: none; /* Let clicks pass through to desktop */
            z-index: 10;
        }

        .window {
            position: absolute;
            background: var(--window-bg);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            pointer-events: auto;
            border: 1px solid rgba(0,0,0,0.1);
            min-width: 300px;
            min-height: 200px;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.15s, transform 0.15s, width 0.05s, height 0.05s, top 0.05s, left 0.05s;
        }

        .window.open {
            opacity: 1;
            transform: scale(1);
        }

        .window.minimized {
            opacity: 0;
            transform: scale(0.8) translateY(200px);
            pointer-events: none;
        }

        .window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: calc(100% - 48px) !important;
            border-radius: 0;
        }

        .title-bar {
            height: 32px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 0 0 10px;
            user-select: none;
        }

        .title-bar-text {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .window-controls {
            display: flex;
            height: 100%;
        }

        .control-btn {
            width: 46px;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            transition: 0.2s;
            cursor: default;
        }

        .control-btn:hover { background: #e0e0e0; }
        .control-btn.close:hover { background: #e81123; color: white; }

        .window-content {
            flex: 1;
            overflow: auto;
            position: relative;
            background: #fff;
        }

        /* --- App Specific Styles --- */
        
        /* Calculator */
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            height: 100%;
            gap: 2px;
            background: #f3f3f3;
            padding: 2px;
        }
        .calc-display {
            grid-column: span 4;
            background: #fff;
            text-align: right;
            padding: 15px;
            font-size: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            border: 1px solid #ddd;
        }
        .calc-btn {
            background: #fff;
            border: 1px solid transparent;
            font-size: 1.1rem;
            cursor: pointer;
        }
        .calc-btn:hover { background: #f0f0f0; }
        .calc-btn.accent { background: #e0e0e0; }
        .calc-btn.equals { background: #0078d4; color: white; }

        /* Notepad */
        .notepad-area {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            padding: 10px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            outline: none;
        }
        .menu-bar {
            display: flex;
            gap: 15px;
            padding: 5px 10px;
            font-size: 12px;
            border-bottom: 1px solid #eee;
        }

        /* Paint */
        .paint-toolbar {
            padding: 5px;
            background: #f3f3f3;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .color-picker {
            width: 20px;
            height: 20px;
            border: 1px solid #999;
            cursor: pointer;
        }
        #paint-canvas {
            background: white;
            cursor: crosshair;
            display: block;
        }

        /* Word */
        .word-toolbar {
            padding: 8px;
            background: #f3f3f3;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 5px;
        }
        .tool-btn {
            padding: 4px 8px;
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 14px;
        }
        .tool-btn:hover { background: #ddd; }
        .word-content {
            width: 100%;
            height: 100%;
            padding: 40px;
            outline: none;
            overflow-y: auto;
        }
        
        /* Explorer */
        .explorer-layout {
            display: flex;
            height: 100%;
        }
        .explorer-sidebar {
            width: 150px;
            background: #f3f3f3;
            padding: 10px;
            font-size: 13px;
            border-right: 1px solid #ddd;
        }
        .explorer-sidebar div {
            padding: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .explorer-sidebar div:hover { background: #e0e0e0; }
        .explorer-main {
            flex: 1;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            grid-auto-rows: 90px;
            gap: 10px;
            background: white;
        }
        .file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
        }
        .file-item:hover { background: #e5f3ff; border: 1px solid #cce8ff; border-radius: 4px; }
        .file-item i { font-size: 32px; color: #ffd700; margin-bottom: 5px; }

        /* Chrome */
        .chrome-chrome {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #fff;
        }
        .chrome-bar {
            display: flex;
            padding: 8px;
            gap: 10px;
            background: #f3f3f3;
            border-bottom: 1px solid #ddd;
        }
        .url-input {
            flex: 1;
            border-radius: 15px;
            border: 1px solid #ccc;
            padding: 4px 15px;
            background: #fff;
            outline: none;
            font-size: 13px;
        }
        .chrome-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            color: #333;
        }
        .chrome-logo-large {
            font-size: 80px;
            margin-bottom: 20px;
        }
        .google-search {
            width: 60%;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            font-size: 16px;
        }

        /* SVG Definitions for Icons */
        .svg-icon { width: 100%; height: 100%; display: block; }

        /* Start Menu (Simplified) */
        #start-menu {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            width: 600px;
            height: 400px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: var(--shadow-lg);
            display: none;
            flex-direction: column;
            padding: 20px;
            z-index: 9999;
            opacity: 0;
            transition: 0.2s;
        }
        #start-menu.show {
            display: flex;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .start-search {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            background: #fff;
        }
        .pinned-apps {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
        }
        .start-app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            cursor: pointer;
        }
        .start-app-item:hover { background: rgba(0,0,0,0.05); border-radius: 4px; }
        .start-app-item div { width: 32px; height: 32px; }

    </style>
</head>
<body>

    <!-- Desktop Icons -->
    <div id="desktop">
        <!-- Icons injected by JS -->
    </div>

    <!-- Window Area -->
    <div id="window-area"></div>

    <!-- Start Menu -->
    <div id="start-menu">
        <input type="text" class="start-search" placeholder="Type here to search">
        <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">Pinned</div>
        <div class="pinned-apps">
            <!-- Pinned items will be duplicated here visually -->
        </div>
        <div style="margin-top: auto; padding-top: 10px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
            <div style="display: flex; gap: 15px; align-items: center;">
                <div style="width: 24px; height: 24px; background: #0078d4; border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center;">U</div>
                <span>User</span>
            </div>
            <i class="ri-shut-down-line" style="font-size: 18px;"></i>
        </div>
    </div>

    <!-- Taskbar -->
    <div id="taskbar">
        <div class="taskbar-icons">
            <div class="taskbar-icon" id="start-btn" onclick="toggleStartMenu()">
                <i class="ri-windows-fill" style="font-size: 24px; color: #0078d4;"></i>
            </div>
            <!-- App icons added by JS -->
        </div>
        <div id="system-tray">
            <div class="tray-icons">
                <i class="ri-wifi-line"></i>
                <i class="ri-volume-up-line"></i>
                <i class="ri-battery-charge-line"></i>
            </div>
            <div class="tray-item">
                <div id="clock-time" style="font-weight: 600;">12:00 PM</div>
                <div id="clock-date" style="font-size: 11px;">10/25/2023</div>
            </div>
            <div style="width: 5px;"></div>
        </div>
    </div>

    <!-- Hidden Templates for Apps -->
    <template id="tpl-calc">
        <div class="calc-grid">
            <div class="calc-display">
                <span style="font-size: 14px; color: #666;">Standard</span>
                <span id="calc-out">0</span>
            </div>
            <button class="calc-btn accent" onclick="calcInput('C')">C</button>
            <button class="calc-btn accent" onclick="calcInput('CE')">CE</button>
            <button class="calc-btn accent" onclick="calcInput('BS')">âŒ«</button>
            <button class="calc-btn accent" onclick="calcInput('/')">Ã·</button>
            <button class="calc-btn" onclick="calcInput('7')">7</button>
            <button class="calc-btn" onclick="calcInput('8')">8</button>
            <button class="calc-btn" onclick="calcInput('9')">9</button>
            <button class="calc-btn accent" onclick="calcInput('*')">Ã—</button>
            <button class="calc-btn" onclick="calcInput('4')">4</button>
            <button class="calc-btn" onclick="calcInput('5')">5</button>
            <button class="calc-btn" onclick="calcInput('6')">6</button>
            <button class="calc-btn accent" onclick="calcInput('-')">âˆ’</button>
            <button class="calc-btn" onclick="calcInput('1')">1</button>
            <button class="calc-btn" onclick="calcInput('2')">2</button>
            <button class="calc-btn" onclick="calcInput('3')">3</button>
            <button class="calc-btn accent" onclick="calcInput('+')">+</button>
            <button class="calc-btn" onclick="calcInput('neg')">Â±</button>
            <button class="calc-btn" onclick="calcInput('0')">0</button>
            <button class="calc-btn" onclick="calcInput('.')">.</button>
            <button class="calc-btn equals" onclick="calcInput('=')">=</button>
        </div>
    </template>

    <template id="tpl-notepad">
        <div style="display: flex; flex-direction: column; height: 100%;">
            <div class="menu-bar">
                <span>File</span><span>Edit</span><span>Format</span><span>View</span><span>Help</span>
            </div>
            <textarea class="notepad-area" spellcheck="false"></textarea>
        </div>
    </template>

    <template id="tpl-word">
        <div style="display: flex; flex-direction: column; height: 100%;">
            <div class="menu-bar">
                <span>File</span><span>Home</span><span>Insert</span><span>Layout</span><span>References</span>
            </div>
            <div class="word-toolbar">
                <button class="tool-btn" onclick="formatDoc('bold')" style="font-weight: bold;">B</button>
                <button class="tool-btn" onclick="formatDoc('italic')" style="font-style: italic;">I</button>
                <button class="tool-btn" onclick="formatDoc('underline')" style="text-decoration: underline;">U</button>
                <div style="width: 1px; background: #ccc; margin: 0 5px;"></div>
                <button class="tool-btn" onclick="formatDoc('justifyLeft')"><i class="ri-align-left"></i></button>
                <button class="tool-btn" onclick="formatDoc('justifyCenter')"><i class="ri-align-center"></i></button>
                <button class="tool-btn" onclick="formatDoc('justifyRight')"><i class="ri-align-right"></i></button>
                <div style="width: 1px; background: #ccc; margin: 0 5px;"></div>
                <select onchange="formatDoc('fontSize', this.value)" class="tool-btn">
                    <option value="3">Normal</option>
                    <option value="1">Small</option>
                    <option value="5">Large</option>
                    <option value="7">Huge</option>
                </select>
            </div>
            <div class="word-content" contenteditable="true"></div>
        </div>
    </template>

    <template id="tpl-paint">
        <div style="display: flex; flex-direction: column; height: 100%;">
            <div class="paint-toolbar">
                <span>Tools:</span>
                <button class="tool-btn" onclick="setPaintColor('#000000')">âš«</button>
                <button class="tool-btn" onclick="setPaintColor('#ff0000')">ðŸ”´</button>
                <button class="tool-btn" onclick="setPaintColor('#0000ff')">ðŸ”µ</button>
                <button class="tool-btn" onclick="setPaintColor('#00ff00')">ðŸŸ¢</button>
                <button class="tool-btn" onclick="setPaintColor('#ffff00')">ðŸŸ¡</button>
                <button class="tool-btn" onclick="setPaintColor('#ffffff')">â¬œ (Eraser)</button>
                <span style="margin-left: 10px;">Size:</span>
                <input type="range" min="1" max="20" value="5" onchange="setLineWidth(this.value)">
                <button class="tool-btn" style="margin-left: auto;" onclick="clearCanvas()">Clear</button>
            </div>
            <div style="flex: 1; overflow: hidden; position: relative; background: #ccc;" id="paint-container">
                <canvas id="paint-canvas"></canvas>
            </div>
        </div>
    </template>

    <template id="tpl-explorer">
        <div class="explorer-layout">
            <div class="explorer-sidebar">
                <div><i class="ri-computer-line"></i> This PC</div>
                <div><i class="ri-download-cloud-line"></i> Downloads</div>
                <div><i class="ri-file-text-line"></i> Documents</div>
                <div><i class="ri-image-line"></i> Pictures</div>
            </div>
            <div class="explorer-main">
                <div class="file-item"><i class="ri-folder-fill" style="color: #fce100;"></i><span>Documents</span></div>
                <div class="file-item"><i class="ri-folder-fill" style="color: #fce100;"></i><span>Downloads</span></div>
                <div class="file-item"><i class="ri-folder-fill" style="color: #fce100;"></i><span>Pictures</span></div>
                <div class="file-item"><i class="ri-folder-fill" style="color: #fce100;"></i><span>Music</span></div>
                <div class="file-item"><i class="ri-file-text-line" style="color: #ccc;"></i><span>readme.txt</span></div>
                <div class="file-item"><i class="ri-image-2-line" style="color: #ccc;"></i><span>photo.jpg</span></div>
            </div>
        </div>
    </template>

    <template id="tpl-chrome">
        <div class="chrome-chrome">
            <div class="chrome-bar">
                <i class="ri-arrow-left-s-line"></i>
                <i class="ri-arrow-right-s-line"></i>
                <i class="ri-refresh-line"></i>
                <input type="text" class="url-input" value="https://www.google.com" onkeydown="if(event.key==='Enter') alert('This is a simulated browser for the demo!')">
                <i class="ri-more-fill"></i>
            </div>
            <div class="chrome-content">
                <div class="chrome-logo-large">G</div>
                <input type="text" class="google-search" placeholder="Search Google or type a URL">
            </div>
        </div>
    </template>

    <script>
        /* --- Icon Definitions (SVGs) --- */
        const icons = {
            word: `<svg viewBox="0 0 48 48" class="app-svg"><rect width="48" height="48" fill="#2B579A" rx="8"/><text x="50%" y="55%" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold" font-size="28">W</text></svg>`,
            paint: `<svg viewBox="0 0 48 48" class="app-svg"><rect width="48" height="48" fill="#F25022" rx="8"/><path d="M12 36c0 2.2 1.8 4 4 4h16c2.2 0 4-1.8 4-4V20h-24v16z" fill="#fff"/><circle cx="30" cy="14" r="8" fill="#7FBA00"/></svg>`,
            calc: `<svg viewBox="0 0 48 48" class="app-svg"><rect width="48" height="48" fill="#0078D4" rx="8"/><rect x="10" y="8" width="28" height="10" fill="#fff"/><rect x="10" y="22" width="8" height="6" fill="#fff"/><rect x="20" y="22" width="8" height="6" fill="#fff"/><rect x="30" y="22" width="8" height="6" fill="#fff"/><rect x="10" y="32" width="8" height="6" fill="#fff"/><rect x="20" y="32" width="8" height="6" fill="#fff"/><rect x="30" y="32" width="8" height="6" fill="#fff"/></svg>`,
            notepad: `<svg viewBox="0 0 48 48" class="app-svg"><rect width="48" height="48" fill="#4CC2FF" rx="8"/><rect x="12" y="8" width="24" height="32" fill="#fff"/><line x1="16" y1="16" x2="32" y2="16" stroke="#4CC2FF" stroke-width="2"/><line x1="16" y1="24" x2="32" y2="24" stroke="#4CC2FF" stroke-width="2"/><line x1="16" y1="32" x2="28" y2="32" stroke="#4CC2FF" stroke-width="2"/></svg>`,
            explorer: `<svg viewBox="0 0 48 48" class="app-svg"><rect width="48" height="48" fill="#E8B931" rx="8"/><path d="M4 14h40v26a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4V14z" fill="#FFE680"/><path d="M4 14h40V8a4 4 0 0 0-4-4H20L16 8H8a4 4 0 0 0-4 4v2z" fill="#FFD54F"/></svg>`,
            chrome: `<svg viewBox="0 0 48 48" class="app-svg"><circle cx="24" cy="24" r="22" fill="#fff"/><circle cx="24" cy="24" r="10" fill="#4285F4"/><path d="M24 4a20 20 0 0 1 16.5 31.5H7.5A20 20 0 0 1 24 4z" fill="#EA4335"/><path d="M40.5 35.5A20 20 0 0 1 13 44l13.5-13.5z" fill="#34A853"/><path d="M7.5 12.5A20 20 0 0 1 44 24L24 24z" fill="#FBBC05"/></svg>`
        };

        /* --- App Definitions --- */
        const apps = [
            { id: 'explorer', name: 'File Explorer', icon: icons.explorer, template: 'tpl-explorer', w: 600, h: 400 },
            { id: 'word', name: 'MS Word', icon: icons.word, template: 'tpl-word', w: 600, h: 500 },
            { id: 'paint', name: 'Paint', icon: icons.paint, template: 'tpl-paint', w: 600, h: 450 },
            { id: 'calc', name: 'Calculator', icon: icons.calc, template: 'tpl-calc', w: 300, h: 400 },
            { id: 'notepad', name: 'Notepad', icon: icons.notepad, template: 'tpl-notepad', w: 400, h: 300 },
            { id: 'chrome', name: 'Chrome', icon: icons.chrome, template: 'tpl-chrome', w: 700, h: 500 },
        ];

        let zIndexCounter = 100;
        const windows = {}; // Store window instances

        /* --- Initialization --- */
        function init() {
            // Setup Desktop Icons
            const desktop = document.getElementById('desktop');
            const startMenuApps = document.querySelector('.pinned-apps');

            apps.forEach(app => {
                // Desktop Icon
                const el = document.createElement('div');
                el.className = 'desktop-icon';
                el.innerHTML = `${app.icon}<span>${app.name}</span>`;
                el.ondblclick = () => openWindow(app.id);
                el.onclick = (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
                    el.classList.add('selected');
                };
                desktop.appendChild(el);

                // Taskbar Icon
                const tbIcon = document.createElement('div');
                tbIcon.className = 'taskbar-icon';
                tbIcon.id = `tb-${app.id}`;
                tbIcon.innerHTML = app.icon;
                tbIcon.onclick = () => toggleWindow(app.id);
                document.querySelector('.taskbar-icons').appendChild(tbIcon);

                // Start Menu Icon
                const smItem = document.createElement('div');
                smItem.className = 'start-app-item';
                smItem.innerHTML = `<div>${app.icon}</div><span>${app.name}</span>`;
                smItem.onclick = () => {
                    openWindow(app.id);
                    toggleStartMenu();
                };
                startMenuApps.appendChild(smItem);
            });

            // Deselect icons on desktop click
            document.getElementById('desktop').onclick = () => {
                document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
            };

            // Clock
            updateClock();
            setInterval(updateClock, 1000);
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock-date').innerText = now.toLocaleDateString();
        }

        /* --- Window Management --- */
        function openWindow(appId) {
            const app = apps.find(a => a.id === appId);
            
            // If already open, just bring to front
            if (windows[appId]) {
                focusWindow(appId);
                if (windows[appId].classList.contains('minimized')) {
                    restoreWindow(appId);
                }
                return;
            }

            // Create Window
            const win = document.createElement('div');
            win.className = 'window';
            win.id = `win-${appId}`;
            win.style.width = app.w + 'px';
            win.style.height = app.h + 'px';
            win.style.left = (100 + Object.keys(windows).length * 30) + 'px';
            win.style.top = (50 + Object.keys(windows).length * 30) + 'px';
            win.style.zIndex = ++zIndexCounter;

            // Content
            const tpl = document.getElementById(app.template).innerHTML;
            win.innerHTML = `
                <div class="title-bar" onmousedown="startDrag(event, '${appId}')">
                    <div class="title-bar-text">${app.icon} ${app.name}</div>
                    <div class="window-controls">
                        <div class="control-btn" onclick="minimizeWindow('${appId}')"><i class="ri-subtract-line"></i></div>
                        <div class="control-btn" onclick="maximizeWindow('${appId}')"><i class="ri-checkbox-blank-line"></i></div>
                        <div class="control-btn close" onclick="closeWindow('${appId}')"><i class="ri-close-line"></i></div>
                    </div>
                </div>
                <div class="window-content" onclick="focusWindow('${appId}')">${tpl}</div>
            `;

            win.onmousedown = () => focusWindow(appId);
            document.getElementById('window-area').appendChild(win);
            
            // Animate open
            requestAnimationFrame(() => win.classList.add('open'));
            
            // Register
            windows[appId] = win;
            document.getElementById(`tb-${appId}`).classList.add('open');

            // Initialize App Logic if needed
            if (appId === 'paint') initPaint();
        }

        function closeWindow(appId) {
            const win = windows[appId];
            if (!win) return;
            win.classList.remove('open');
            setTimeout(() => {
                if(win.parentNode) win.parentNode.removeChild(win);
                delete windows[appId];
                document.getElementById(`tb-${appId}`).classList.remove('open');
            }, 200);
        }

        function minimizeWindow(appId) {
            const win = windows[appId];
            win.classList.add('minimized');
            document.getElementById(`tb-${appId}`).classList.remove('active'); // Visual cue only
        }

        function restoreWindow(appId) {
            const win = windows[appId];
            win.classList.remove('minimized');
            focusWindow(appId);
        }

        function toggleWindow(appId) {
            if (!windows[appId]) {
                openWindow(appId);
            } else {
                if (windows[appId].classList.contains('minimized')) {
                    restoreWindow(appId);
                } else if (windows[appId].style.zIndex == zIndexCounter) {
                    minimizeWindow(appId);
                } else {
                    focusWindow(appId);
                }
            }
        }

        function maximizeWindow(appId) {
            const win = windows[appId];
            win.classList.toggle('maximized');
        }

        function focusWindow(appId) {
            const win = windows[appId];
            if (win) {
                win.style.zIndex = ++zIndexCounter;
            }
        }

        /* --- Dragging Logic --- */
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let currentDragWin = null;

        function startDrag(e, appId) {
            if (e.target.closest('.window-controls')) return; // Don't drag if clicking buttons
            
            const win = windows[appId];
            if(win.classList.contains('maximized')) return; // Can't drag maximized

            isDragging = true;
            currentDragWin = win;
            const rect = win.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            focusWindow(appId);
        }

        window.addEventListener('mousemove', (e) => {
            if (!isDragging || !currentDragWin) return;
            e.preventDefault();
            const x = e.clientX - dragOffset.x;
            const y = e.clientY - dragOffset.y;
            
            // Simple boundaries
            currentDragWin.style.left = `${Math.max(0, x)}px`;
            currentDragWin.style.top = `${Math.max(0, y)}px`;
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            currentDragWin = null;
        });

        /* --- Start Menu --- */
        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            menu.classList.toggle('show');
        }

        // Close start menu on desktop click
        document.getElementById('desktop').addEventListener('click', () => {
             document.getElementById('start-menu').classList.remove('show');
        });

        /* --- App Specific Logic --- */

        // Calculator
        let calcVal = '0';
        function calcInput(v) {
            const display = document.getElementById('calc-out');
            if (!display) return;

            if (v === 'C') calcVal = '0';
            else if (v === 'CE') calcVal = '0';
            else if (v === 'BS') calcVal = calcVal.length > 1 ? calcVal.slice(0, -1) : '0';
            else if (v === '=') {
                try { calcVal = eval(calcVal).toString(); } catch { calcVal = 'Error'; }
            }
            else if (v === 'neg') calcVal = (parseFloat(calcVal) * -1).toString();
            else {
                if (calcVal === '0' && 
!['.','/','*','+','-'].includes(v)
) calcVal = v;
                else calcVal += v;
            }
            display.innerText = calcVal;
        }

        // Word
        function formatDoc(cmd, value = null) {
            document.execCommand(cmd, false, value);
        }

        // Paint
        let painting = false;
        let ctx = null;
        let color = '#000000';
        let lineWidth = 5;

        function initPaint() {
            // Need a slight delay to ensure DOM is ready
            setTimeout(() => {
                const canvas = document.getElementById('paint-canvas');
                if(!canvas) return;
                const container = document.getElementById('paint-container');
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                ctx = canvas.getContext('2d');
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;

                canvas.addEventListener('mousedown', startPaint);
                canvas.addEventListener('mousemove', drawPaint);
                canvas.addEventListener('mouseup', stopPaint);
                canvas.addEventListener('mouseleave', stopPaint);
            }, 100);
        }

        function startPaint(e) {
            painting = true;
            drawPaint(e);
        }

        function drawPaint(e) {
            if (!painting) return;
            const canvas = document.getElementById('paint-canvas');
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function stopPaint() {
            painting = false;
            ctx.beginPath();
        }

        function setPaintColor(c) {
            color = c;
            if(ctx) ctx.strokeStyle = c;
        }

        function setLineWidth(w) {
            lineWidth = w;
            if(ctx) ctx.lineWidth = w;
        }
        
        function clearCanvas() {
            const canvas = document.getElementById('paint-canvas');
            if(ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Run Init
        init();

    </script>
</body>
</html>