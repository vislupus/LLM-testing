<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSpreadsheet Pro</title>
    <!-- Google Fonts for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --border-color: #d4d4d4;
            --header-bg: #f8f9fa;
            --header-hover: #e1e1e1;
            --selection-border: #217346;
            --selection-bg: rgba(33, 115, 70, 0.1);
            --accent-color: #107c41;
            --text-color: #222;
            --cell-height: 25px;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            font-size: 13px;
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fff;
        }

        /* --- Toolbar --- */
        .toolbar {
            padding: 8px 12px;
            background: #f3f2f1;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .tool-btn {
            background: transparent;
            border: 1px solid transparent;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            font-weight: 600;
            color: #444;
        }

        .tool-btn:hover { background: #e1dfdd; }
        .tool-btn.active { background: #d2e3fc; color: #107c41; }
        .tool-divider { width: 1px; height: 20px; background: #ccc; margin: 0 5px; }

        input[type="color"] {
            width: 24px; height: 24px; padding: 0; border: none; background: none; cursor: pointer;
        }

        /* --- Formula Bar --- */
        .formula-bar-container {
            display: flex;
            align-items: center;
            padding: 6px;
            border-bottom: 1px solid var(--border-color);
            gap: 10px;
        }

        .address-box {
            width: 50px;
            text-align: center;
            font-weight: 600;
            color: #666;
            border: 1px solid transparent;
            padding: 2px;
        }

        .fx-icon { color: #999; font-style: italic; font-family: serif; font-weight: bold; }

        .formula-input {
            flex: 1;
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            font-family: 'Segoe UI', sans-serif;
            font-size: 13px;
            border-radius: 2px;
        }
        .formula-input:focus { border-color: var(--accent-color); }

        /* --- Grid Area --- */
        .spreadsheet-container {
            flex: 1;
            overflow: auto;
            position: relative;
            display: flex;
        }

        /* Row Headers (1, 2, 3...) */
        .row-headers {
            width: 40px;
            flex-shrink: 0;
            background: var(--header-bg);
            border-right: 1px solid var(--border-color);
            user-select: none;
            z-index: 10;
        }
        
        .row-header-cell {
            height: var(--cell-height);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            border-bottom: 1px solid var(--border-color);
            font-size: 11px;
        }

        /* Main Grid */
        .grid-wrapper {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        table {
            border-collapse: collapse;
            table-layout: fixed;
            min-width: 100%;
        }

        th, td {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            height: var(--cell-height);
            padding: 0 4px;
            white-space: nowrap;
            overflow: hidden;
            position: relative;
        }

        /* Column Headers (A, B, C...) */
        thead th {
            background: var(--header-bg);
            color: #666;
            font-weight: normal;
            text-align: center;
            user-select: none;
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        
        thead th:hover { background: var(--header-hover); cursor: s-resize; }
        thead th.resizing { background: #d0d0d0; }

        /* Cells */
        tbody td {
            font-family: 'Segoe UI', sans-serif;
            cursor: cell;
            user-select: none; /* Prevent text selection while navigating */
        }

        tbody td.active {
            border: 2px solid var(--accent-color);
            z-index: 5; /* Bring above neighbors */
        }

        tbody td.selected-range {
            background: var(--selection-bg);
        }

        /* Specific Cell Styling */
        .cell-bold { font-weight: bold; }
        .cell-italic { font-style: italic; }
        
        /* Editing Input */
        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            font-family: inherit;
            font-size: inherit;
            padding: 0;
            margin: 0;
            background: white;
            position: absolute;
            top: 0; left: 0;
            z-index: 10;
            display: none;
        }
        td.editing .cell-input { display: block; }
        td.editing span { visibility: hidden; }

        /* Sheet Tabs */
        .sheet-tabs {
            background: #fff;
            border-top: 1px solid var(--border-color);
            padding: 4px 10px 0 10px;
            display: flex;
            gap: 2px;
            user-select: none;
            min-height: 32px;
        }

        .sheet-tab {
            padding: 4px 15px;
            background: #f3f2f1;
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            font-size: 12px;
            color: #444;
            cursor: pointer;
            position: relative;
            top: 1px;
        }

        .sheet-tab.active {
            background: #fff;
            color: var(--accent-color);
            font-weight: 600;
            border-bottom: 1px solid #fff;
            z-index: 2;
        }

        .sheet-tab:hover:not(.active) { background: #e1dfdd; }

        .sheet-actions {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 5px;
        }

        /* Status Bar */
        .status-bar {
            height: 28px;
            background: var(--header-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 11px;
            color: #666;
            justify-content: space-between;
        }

        /* Utilities */
        .hidden-file { display: none; }
        .resizer-handle {
            position: absolute;
            right: 0; top: 0; bottom: 0; width: 5px;
            cursor: col-resize;
            z-index: 30;
        }
    </style>
</head>
<body>

    <!-- Toolbar -->
    <div class="toolbar">
        <button class="tool-btn" onclick="downloadCSV()" title="Download CSV"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
        <button class="tool-btn" onclick="document.getElementById('csv-upload').click()" title="Upload CSV"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button>
        <input type="file" id="csv-upload" class="hidden-file" accept=".csv" onchange="uploadCSV(this)">
        
        <div class="tool-divider"></div>

        <button class="tool-btn" id="btn-bold" onclick="toggleStyle('bold')" title="Bold"><b>B</b></button>
        <button class="tool-btn" id="btn-italic" onclick="toggleStyle('italic')" title="Italic"><i>I</i></button>
        
        <div class="tool-divider"></div>
        
        <div title="Background Color">
            <input type="color" id="bg-color-picker" value="#ffffff" onchange="toggleStyle('bg', this.value)">
        </div>

        <div class="tool-divider"></div>

        <button class="tool-btn" onclick="clearSelection()" title="Clear Contents">Clear</button>
    </div>

    <!-- Formula Bar -->
    <div class="formula-bar-container">
        <div class="address-box" id="address-display">A1</div>
        <div class="fx-icon">fx</div>
        <input type="text" class="formula-input" id="formula-input" placeholder="Enter value or formula (e.g., =SUM(A1:B2))">
    </div>

    <!-- Spreadsheet Container -->
    <div class="spreadsheet-container" id="main-container">
        <div class="row-headers" id="row-headers">
            <!-- Generated by JS -->
        </div>
        <div class="grid-wrapper">
            <table id="grid">
                <thead>
                    <tr id="header-row">
                        <th style="width:40px; background:#f3f2f1; border-bottom:1px solid #d4d4d4; border-right:1px solid #d4d4d4; z-index:25; left:0; position:sticky;"></th>
                        <!-- Generated by JS -->
                    </tr>
                </thead>
                <tbody id="grid-body">
                    <!-- Generated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Sheet Tabs -->
    <div class="sheet-tabs" id="sheet-tabs">
        <!-- Generated by JS -->
        <div class="sheet-actions">
            <button class="tool-btn" onclick="addSheet()" title="Add Sheet">+</button>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span id="status-msg">Ready</span>
        <div style="display:flex; gap:15px;">
            <span id="sum-display"></span>
            <span id="avg-display"></span>
            <span id="count-display"></span>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const ROWS = 100;
        const COLS = 26; // A-Z
        const DEFAULT_COL_WIDTH = 100;

        // --- State Management ---
        let sheets = {
            'Sheet1': {
                data: {}, // { 'A1': { value: 10, formula: '' } }
                styles: {}, // { 'A1': { bold: true, bg: '#fff' } }
                colWidths: {}
            }
        };
        let currentSheet = 'Sheet1';
        let activeCell = { r: 0, c: 0 }; // 0-indexed
        let selection = { start: { r: 0, c: 0 }, end: { r: 0, c: 0 } }; // Range
        let isDragging = false;
        let isResizing = false;
        let formulaMode = false; // Is user currently editing formula bar?

        // --- DOM Elements ---
        const gridBody = document.getElementById('grid-body');
        const headerRow = document.getElementById('header-row');
        const rowHeaders = document.getElementById('row-headers');
        const formulaInput = document.getElementById('formula-input');
        const addressDisplay = document.getElementById('address-display');
        const sheetTabsContainer = document.getElementById('sheet-tabs');

        // --- Initialization ---
        function init() {
            renderGrid();
            renderTabs();
            selectCell(0, 0);
            updateStatusBar();
            
            // Global listeners
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('keydown', handleKeyDown);
            
            formulaInput.addEventListener('focus', () => { formulaMode = true; });
            formulaInput.addEventListener('blur', () => { formulaMode = false; });
            formulaInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') commitFormulaChange();
            });
        }

        // --- Rendering ---
        function renderGrid() {
            // Render Headers
            headerRow.innerHTML = '<th style="width:40px; background:#f3f2f1; border-bottom:1px solid #d4d4d4; border-right:1px solid #d4d4d4; z-index:25; left:0; position:sticky;"></th>';
            for (let c = 0; c < COLS; c++) {
                const th = document.createElement('th');
                const colName = getColName(c);
                th.innerText = colName;
                const w = getColWidth(c);
                th.style.width = w + 'px';
                th.dataset.col = c;
                th.innerHTML += `<div class="resizer-handle" onmousedown="startResize(event, ${c})"></div>`;
                headerRow.appendChild(th);
            }

            // Render Body
            gridBody.innerHTML = '';
            rowHeaders.innerHTML = '';

            for (let r = 0; r < ROWS; r++) {
                // Row Header
                const rh = document.createElement('div');
                rh.className = 'row-header-cell';
                rh.innerText = r + 1;
                rh.dataset.row = r;
                rowHeaders.appendChild(rh);

                // Row Cells
                const tr = document.createElement('tr');
                for (let c = 0; c < COLS; c++) {
                    const td = document.createElement('td');
                    td.dataset.r = r;
                    td.dataset.c = c;
                    td.onclick = (e) => handleCellClick(e, r, c);
                    td.ondblclick = (e) => editCell(r, c);
                    
                    // Inner content
                    const span = document.createElement('span');
                    span.className = 'cell-content';
                    const input = document.createElement('input');
                    input.className = 'cell-input';
                    
                    td.appendChild(span);
                    td.appendChild(input);
                    tr.appendChild(td);
                }
                gridBody.appendChild(tr);
            }
            
            refreshCells();
        }

        function refreshCells() {
            // Sync DOM with Data
            const data = sheets[currentSheet].data;
            const styles = sheets[currentSheet].styles;
            
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const id = getCellId(r, c);
                    const td = getCellEl(r, c);
                    const span = td.querySelector('.cell-content');
                    
                    // Value
                    const cellData = data[id];
                    span.innerText = cellData ? (cellData.error ? cellData.error : cellData.value) : '';

                    // Styles
                    td.className = ''; // Reset
                    const style = styles[id];
                    if (style) {
                        if (style.bold) span.classList.add('cell-bold');
                        if (style.italic) span.classList.add('cell-italic');
                        td.style.backgroundColor = style.bg || '';
                    }
                }
            }
            highlightSelection();
        }

        // --- Interaction Logic ---
        function handleCellClick(e, r, c) {
            if (isResizing) return;
            startDrag(e, r, c);
        }

        function startDrag(e, r, c) {
            // If formula mode is active, we are selecting references, not just UI selecting
            if (formulaMode) {
                // Logic handled in handleMouseMove
            }
            
            isDragging = true;
            selection.start = { r, c };
            selection.end = { r, c };
            selectCell(r, c); // Update active single cell
            highlightSelection();
        }

        function handleMouseMove(e) {
            if (!isDragging) return;

            // Find cell under mouse
            const el = document.elementFromPoint(e.clientX, e.clientY);
            if (el && (el.tagName === 'TD' || el.parentElement.tagName === 'TD')) {
                const td = el.tagName === 'TD' ? el : el.parentElement;
                const r = parseInt(td.dataset.r);
                const c = parseInt(td.dataset.c);

                if (r >= 0 && r < ROWS && c >= 0 && c < COLS) {
                    selection.end = { r, c };
                    highlightSelection();
                    
                    if (formulaMode) {
                        updateFormulaBarWithRange();
                    }
                }
            }
        }

        function stopDrag() {
            isDragging = false;
        }

        function selectCell(r, c) {
            // Remove active class from old
            if (activeCell) {
                const old = getCellEl(activeCell.r, activeCell.c);
                if (old) old.classList.remove('active');
            }
            activeCell = { r, c };
            const td = getCellEl(r, c);
            if (td) td.classList.add('active');

            addressDisplay.innerText = getCellId(r, c);
            
            // Sync formula bar
            const data = sheets[currentSheet].data[getCellId(r, c)];
            formulaInput.value = data && data.formula ? data.formula : (data ? data.value : '');
        }

        function highlightSelection() {
            // Clear previous
            document.querySelectorAll('.selected-range').forEach(el => el.classList.remove('selected-range'));
            
            const r1 = Math.min(selection.start.r, selection.end.r);
            const r2 = Math.max(selection.start.r, selection.end.r);
            const c1 = Math.min(selection.start.c, selection.end.c);
            const c2 = Math.max(selection.start.c, selection.end.c);

            for (let r = r1; r <= r2; r++) {
                for (let c = c1; c <= c2; c++) {
                    const td = getCellEl(r, c);
                    if (td && !(r === activeCell.r && c === activeCell.c)) {
                        td.classList.add('selected-range');
                    }
                }
            }
            updateStatusBar();
        }

        // --- Editing Logic ---
        function editCell(r, c) {
            const td = getCellEl(r, c);
            const input = td.querySelector('.cell-input');
            const span = td.querySelector('.cell-content');
            
            td.classList.add('editing');
            input.value = span.innerText;
            input.focus();

            const finishEdit = () => {
                td.classList.remove('editing');
                const val = input.value;
                setCellValue(r, c, val);
                input.removeEventListener('blur', finishEdit);
            };

            input.addEventListener('blur', finishEdit);
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    finishEdit();
                    navigateGrid(1, 0); // Move down
                }
            };
        }

        function handleKeyDown(e) {
            // Keyboard Navigation
            if (!formulaMode && !document.querySelector('.editing')) {
                if (e.key === 'ArrowUp') navigateGrid(-1, 0);
                else if (e.key === 'ArrowDown') navigateGrid(1, 0);
                else if (e.key === 'ArrowLeft') navigateGrid(0, -1);
                else if (e.key === 'ArrowRight') navigateGrid(0, 1);
                else if (e.key === 'Enter') navigateGrid(1, 0);
                else if (e.key === 'Tab') navigateGrid(0, 1);
                else if (e.key === 'Backspace' || e.key === 'Delete') clearSelection();
                else if (e.key.length === 1 && !e.ctrlKey && !e.altKey) {
                    // Start typing in cell
                    editCell(activeCell.r, activeCell.c);
                    // Note: The editCell logic captures keystrokes, but we might need to 
                    // pre-fill the input. For simplicity, standard flow works.
                }
            }
        }

        function navigateGrid(dr, dc) {
            let nr = activeCell.r + dr;
            let nc = activeCell.c + dc;
            if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
                selection.start = { r: nr, c: nc };
                selection.end = { r: nr, c: nc };
                selectCell(nr, nc);
                highlightSelection();
            }
        }

        function commitFormulaChange() {
            const val = formulaInput.value;
            setCellValue(activeCell.r, activeCell.c, val);
            document.activeElement.blur(); // Remove focus from formula bar
        }

        function setCellValue(r, c, inputVal) {
            const id = getCellId(r, c);
            const sheet = sheets[currentSheet];
            
            if (!inputVal) {
                delete sheet.data[id];
            } else if (inputVal.startsWith('=')) {
                sheet.data[id] = { formula: inputVal, value: calculateFormula(inputVal) };
            } else {
                // Try parsing number
                const num = parseFloat(inputVal);
                sheet.data[id] = { formula: '', value: isNaN(num) ? inputVal : num };
            }

            recalculateAll(); // Reactivity: naive full recalculation
            refreshCells();
        }

        // --- Formula Engine ---
        function calculateFormula(formula) {
            try {
                // 1. Remove '='
                let expr = formula.substring(1).toUpperCase();

                // 2. Handle Functions: SUM, AVG, MIN, MAX
                // Regex to find FUNC(RANGE)
                const funcRegex = /(SUM|AVERAGE|MIN|MAX)\(([A-Z]+[0-9]+):([A-Z]+[0-9]+)\)/g;
                
                expr = expr.replace(funcRegex, (match, func, startId, endId) => {
                    const values = getRangeValues(startId, endId);
                    if (func === 'SUM') return values.reduce((a, b) => a + b, 0);
                    if (func === 'AVERAGE') return values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                    if (func === 'MIN') return Math.min(...values);
                    if (func === 'MAX') return Math.max(...values);
                    return 0;
                });

                // 3. Handle Ranges directly in arithmetic (e.g. A1:A5 + 10) -> treats range as sum implicitly or error?
                // Standard Excel doesn't allow A1:A5 + 5 without a wrapper function.
                // For simplicity, we only replace single cell references.
                
                // 4. Replace Single Cell References (e.g., A1)
                const cellRegex = /([A-Z]+[0-9]+)/g;
                expr = expr.replace(cellRegex, (match) => {
                    const val = getCellValue(match);
                    return isNaN(val) ? 0 : val;
                });

                // 5. Safe Eval
                // Note: 'Function' is safer than 'eval' but still powerful. 
                // We restrict it to basic math by the replacement logic above.
                return new Function('return ' + expr)();
            } catch (e) {
                return '#ERR';
            }
        }

        function getRangeValues(startId, endId) {
            const start = getCellCoords(startId);
            const end = getCellCoords(endId);
            const vals = [];
            
            const r1 = Math.min(start.r, end.r);
            const r2 = Math.max(start.r, end.r);
            const c1 = Math.min(start.c, end.c);
            const c2 = Math.max(start.c, end.c);

            for(let r=r1; r<=r2; r++){
                for(let c=c1; c<=c2; c++){
                    const val = getCellValue(getCellId(r, c));
                    if (!isNaN(val)) vals.push(val);
                }
            }
            return vals;
        }

        function getCellValue(id) {
            const cell = sheets[currentSheet].data[id];
            if (!cell) return 0;
            if (cell.error) return 0;
            if (typeof cell.value === 'number') return cell.value;
            return 0; // Treat text as 0 in math
        }

        function recalculateAll() {
            const data = sheets[currentSheet].data;
            let changed = true;
            // Iterative approach to resolve dependencies (simple version)
            // In a real app, use a dependency graph. Here we just iterate a few times
            // to propagate changes.
            for (let i = 0; i < 5; i++) {
                changed = false;
                for (let id in data) {
                    if (data[id].formula) {
                        const newVal = calculateFormula(data[id].formula);
                        if (newVal !== data[id].value) {
                            data[id].value = newVal;
                            changed = true;
                        }
                    }
                }
                if (!changed) break;
            }
        }

        // --- Helpers ---
        function getCellId(r, c) {
            return getColName(c) + (r + 1);
        }

        function getCellCoords(id) {
            const colMatch = id.match(/[A-Z]+/);
            const rowMatch = id.match(/[0-9]+/);
            const c = colNameToIndex(colMatch[0]);
            const r = parseInt(rowMatch[0]) - 1;
            return { r, c };
        }

        function getColName(index) {
            let name = '';
            while (index >= 0) {
                name = String.fromCharCode((index % 26) + 65) + name;
                index = Math.floor(index / 26) - 1;
            }
            return name;
        }

        function colNameToIndex(name) {
            let idx = 0;
            for (let i = 0; i < name.length; i++) {
                idx = idx * 26 + (name.charCodeAt(i) - 64);
            }
            return idx - 1;
        }

        function getCellEl(r, c) {
            // Use querySelector with dataset attributes for speed/simplicity
            return document.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
        }

        function getColWidth(c) {
            return sheets[currentSheet].colWidths[c] || DEFAULT_COL_WIDTH;
        }

        // --- Features: Toolbar, Resize, Sheets, CSV ---

        function toggleStyle(type, val) {
            const start = selection.start;
            const end = selection.end;
            const r1 = Math.min(start.r, end.r), r2 = Math.max(start.r, end.r);
            const c1 = Math.min(start.c, end.c), c2 = Math.max(start.c, end.c);
            const styles = sheets[currentSheet].styles;

            for (let r = r1; r <= r2; r++) {
                for (let c = c1; c <= c2; c++) {
                    const id = getCellId(r, c);
                    if (!styles[id]) styles[id] = {};
                    if (type === 'bg') styles[id].bg = val;
                    else styles[id][type] = !styles[id][type]; // Toggle Bold/Italic
                }
            }
            refreshCells();
        }

        function clearSelection() {
            const start = selection.start;
            const end = selection.end;
            const r1 = Math.min(start.r, end.r), r2 = Math.max(start.r, end.r);
            const c1 = Math.min(start.c, end.c), c2 = Math.max(start.c, end.c);
            const data = sheets[currentSheet].data;

            for (let r = r1; r <= r2; r++) {
                for (let c = c1; c <= c2; c++) {
                    delete data[getCellId(r, c)];
                }
            }
            refreshCells();
            formulaInput.value = '';
        }

        // Column Resizing
        function startResize(e, c) {
            isResizing = true;
            e.stopPropagation();
            const startX = e.clientX;
            const th = e.target.parentElement;
            const startWidth = th.offsetWidth;

            const doResize = (ev) => {
                const diff = ev.clientX - startX;
                const newWidth = Math.max(20, startWidth + diff);
                sheets[currentSheet].colWidths[c] = newWidth;
                th.style.width = newWidth + 'px';
                // Adjust cells
                const tds = document.querySelectorAll(`td[data-c="${c}"]`);
                tds.forEach(td => td.style.width = newWidth + 'px');
            };

            const stopResize = () => {
                isResizing = false;
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
            };

            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }

        // Formula Bar Range Insertion
        function updateFormulaBarWithRange() {
            if (!formulaMode) return;
            const id1 = getCellId(selection.start.r, selection.start.c);
            const id2 = getCellId(selection.end.r, selection.end.c);
            const range = id1 === id2 ? id1 : `${id1}:${id2}`;
            
            // If user just clicked one cell, replace selection or append?
            // Simple logic: Append
            formulaInput.value += range;
        }

        // Sheet Management
        function renderTabs() {
            sheetTabsContainer.innerHTML = '';
            Object.keys(sheets).forEach(name => {
                const tab = document.createElement('div');
                tab.className = `sheet-tab ${name === currentSheet ? 'active' : ''}`;
                tab.innerText = name;
                tab.onclick = () => switchSheet(name);
                tab.oncontextmenu = (e) => {
                    e.preventDefault();
                    if(confirm(`Delete sheet "${name}"?`)) {
                        delete sheets[name];
                        if(Object.keys(sheets).length === 0) addSheet();
                        else if(currentSheet === name) switchSheet(Object.keys(sheets)[0]);
                        renderTabs();
                    }
                };
                sheetTabsContainer.insertBefore(tab, sheetTabsContainer.lastElementChild);
            });
        }

        function switchSheet(name) {
            currentSheet = name;
            renderTabs();
            refreshCells();
            selectCell(0,0);
        }

        function addSheet() {
            let idx = Object.keys(sheets).length + 1;
            let name = `Sheet${idx}`;
            while(sheets[name]) { idx++; name = `Sheet${idx}`; }
            sheets[name] = { data: {}, styles: {}, colWidths: {} };
            renderTabs();
            switchSheet(name);
        }

        // CSV Import/Export
        function downloadCSV() {
            const data = sheets[currentSheet].data;
            let csvContent = "data:text/csv;charset=utf-8,";
            
            for(let r=0; r<ROWS; r++) {
                let row = [];
                for(let c=0; c<COLS; c++) {
                    const id = getCellId(r, c);
                    let val = data[id] ? data[id].value : "";
                    val = val.toString().replace(/"/g, '""'); // Escape quotes
                    if(val.includes(",") || val.includes('"')) val = `"${val}"`;
                    row.push(val);
                }
                // Trim empty rows at end? For simplicity, export all.
                csvContent += row.join(",") + "\r\n";
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentSheet}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function uploadCSV(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split(/\r\n|\n/);
                const data = {};
                
                rows.forEach((rowStr, rIdx) => {
                    if (rIdx >= ROWS) return;
                    const cols = rowStr.split(",");
                    cols.forEach((val, cIdx) => {
                        if (cIdx >= COLS) return;
                        // Basic CSV parse (doesn't handle complex quoted commas perfectly but good for demo)
                        let cleanVal = val.trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                        if(cleanVal) {
                            const id = getCellId(rIdx, cIdx);
                            const num = parseFloat(cleanVal);
                            data[id] = { formula: '', value: isNaN(num) ? cleanVal : num };
                        }
                    });
                });
                
                sheets[currentSheet].data = data;
                refreshCells();
                input.value = ''; // Reset
            };
            reader.readAsText(file);
        }

        function updateStatusBar() {
            const r1 = Math.min(selection.start.r, selection.end.r);
            const r2 = Math.max(selection.start.r, selection.end.r);
            const c1 = Math.min(selection.start.c, selection.end.c);
            const c2 = Math.max(selection.start.c, selection.end.c);
            
            let sum = 0, count = 0;
            const values = [];
            
            for(let r=r1; r<=r2; r++){
                for(let c=c1; c<=c2; c++){
                    const id = getCellId(r, c);
                    const val = getCellValue(id);
                    if(!isNaN(val) && typeof val === 'number') {
                        sum += val;
                        values.push(val);
                        count++;
                    }
                }
            }
            
            const avg = count ? (sum / count).toFixed(2) : 0;
            
            document.getElementById('sum-display').innerText = `Sum: ${sum}`;
            document.getElementById('avg-display').innerText = `Avg: ${avg}`;
            document.getElementById('count-display').innerText = `Count: ${count}`;
            document.getElementById('status-msg').innerText = `${(r2-r1+1)*(c2-c1+1)} cells selected`;
        }

        // Run
        init();

    </script>
</body>
</html>