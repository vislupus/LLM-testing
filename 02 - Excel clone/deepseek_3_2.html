<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Clone - Browser Spreadsheet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: #f3f4f6;
            color: #1f2937;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .app-header {
            background-color: #2563eb;
            color: white;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 600;
        }

        .logo i {
            font-size: 26px;
        }

        .version {
            font-size: 12px;
            opacity: 0.8;
            margin-left: 8px;
        }

        /* Toolbar */
        .toolbar {
            background-color: #f8fafc;
            padding: 8px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            border-right: 1px solid #d1d5db;
            padding-right: 12px;
            margin-right: 8px;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 10px;
            margin: 0 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }

        .toolbar-btn.active {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }

        .toolbar-btn i {
            font-size: 16px;
        }

        .color-picker {
            width: 30px;
            height: 30px;
            padding: 2px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
        }

        .separator {
            width: 1px;
            height: 20px;
            background-color: #d1d5db;
            margin: 0 8px;
        }

        /* Formula Bar */
        .formula-bar {
            background-color: white;
            padding: 8px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
        }

        .cell-address {
            width: 80px;
            padding: 6px 8px;
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 10px;
        }

        .formula-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .formula-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Sheet Tabs */
        .sheet-tabs {
            background-color: #f8fafc;
            padding: 4px 16px 0;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            overflow-x: auto;
        }

        .sheet-tab {
            padding: 8px 16px;
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            margin-right: 4px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sheet-tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            z-index: 1;
        }

        .add-sheet-btn {
            padding: 8px 12px;
            background: none;
            border: 1px dashed #9ca3af;
            border-radius: 4px;
            margin-left: 8px;
            cursor: pointer;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .add-sheet-btn:hover {
            background-color: #f3f4f6;
        }

        .tab-rename-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            padding: 8px 16px;
            border-radius: 6px 6px 0 0;
            outline: none;
            font-size: 14px;
        }

        /* Spreadsheet Container */
        .spreadsheet-container {
            flex: 1;
            overflow: auto;
            position: relative;
            background-color: white;
        }

        /* Spreadsheet Grid */
        .spreadsheet-grid {
            border-collapse: collapse;
            position: absolute;
            top: 0;
            left: 0;
        }

        .column-headers, .row-headers {
            background-color: #f9fafb;
            position: absolute;
            z-index: 10;
        }

        .column-headers {
            top: 0;
            left: 40px;
            height: 30px;
            display: flex;
        }

        .row-headers {
            top: 30px;
            left: 0;
            width: 40px;
        }

        .column-header, .row-header {
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
        }

        .column-header {
            width: 100px;
            height: 30px;
            position: relative;
        }

        .row-header {
            width: 40px;
            height: 24px;
        }

        .resize-handle {
            position: absolute;
            right: -3px;
            top: 0;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            z-index: 20;
        }

        .cells-container {
            position: absolute;
            top: 30px;
            left: 40px;
            overflow: hidden;
        }

        .cell-row {
            display: flex;
        }

        .cell {
            width: 100px;
            height: 24px;
            border: 1px solid #e5e7eb;
            padding: 0 4px;
            outline: none;
            font-size: 14px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            background-color: white;
            position: relative;
        }

        .cell.selected {
            border: 2px solid #2563eb;
            z-index: 5;
        }

        .cell.selected.top {
            border-top: 2px solid #2563eb;
        }

        .cell.selected.bottom {
            border-bottom: 2px solid #2563eb;
        }

        .cell.selected.left {
            border-left: 2px solid #2563eb;
        }

        .cell.selected.right {
            border-right: 2px solid #2563eb;
        }

        .cell.editing {
            z-index: 100;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
        }

        .cell.formula {
            color: #1d4ed8;
            font-style: italic;
        }

        /* Formula Helper */
        .formula-helper {
            position: absolute;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 8px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
            display: none;
        }

        /* CSV Upload/Download */
        .csv-actions {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 8px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Status Bar */
        .status-bar {
            background-color: #f8fafc;
            padding: 6px 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6b7280;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1f2937;
        }

        .modal-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .modal-btn.primary {
            background-color: #2563eb;
            color: white;
            border: none;
        }

        .modal-btn.secondary {
            background-color: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .toolbar {
                padding: 6px 8px;
            }
            
            .toolbar-btn span {
                display: none;
            }
            
            .formula-bar {
                padding: 6px 8px;
            }
            
            .cell-address {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- App Header -->
    <header class="app-header">
        <div class="logo">
            <i class="fas fa-table"></i>
            <span>Excel Clone</span>
            <span class="version">v1.0</span>
        </div>
        <div class="csv-actions">
            <button class="toolbar-btn" id="downloadBtn">
                <i class="fas fa-download"></i>
                <span>Download CSV</span>
            </button>
            <div class="file-input-wrapper">
                <button class="toolbar-btn">
                    <i class="fas fa-upload"></i>
                    <span>Upload CSV</span>
                </button>
                <input type="file" id="uploadCsv" accept=".csv">
            </div>
        </div>
    </header>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-group">
            <button class="toolbar-btn" id="boldBtn" title="Bold">
                <i class="fas fa-bold"></i>
            </button>
            <button class="toolbar-btn" id="italicBtn" title="Italic">
                <i class="fas fa-italic"></i>
            </button>
        </div>
        
        <div class="separator"></div>
        
        <div class="toolbar-group">
            <input type="color" class="color-picker" id="bgColorPicker" title="Cell Background Color" value="#ffffff">
        </div>
        
        <div class="separator"></div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" id="clearBtn" title="Clear Contents">
                <i class="fas fa-eraser"></i>
                <span>Clear</span>
            </button>
        </div>
    </div>

    <!-- Formula Bar -->
    <div class="formula-bar">
        <div class="cell-address" id="cellAddress">A1</div>
        <input type="text" class="formula-input" id="formulaInput" placeholder="Enter a formula or value">
    </div>

    <!-- Sheet Tabs -->
    <div class="sheet-tabs" id="sheetTabs">
        <!-- Sheet tabs will be generated here -->
    </div>

    <!-- Spreadsheet Container -->
    <div class="spreadsheet-container" id="spreadsheetContainer">
        <!-- Grid will be generated here -->
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-info" id="statusInfo">Ready</div>
        <div class="cell-count" id="cellCount">Cells: 0</div>
    </div>

    <!-- Formula Helper -->
    <div class="formula-helper" id="formulaHelper">
        <div>Click on a cell or drag to select a range to insert its reference into the formula.</div>
    </div>

    <!-- Modal for Sheet Actions -->
    <div class="modal" id="sheetModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">New Sheet</div>
            <input type="text" class="modal-input" id="modalInput" placeholder="Enter sheet name">
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="modalCancel">Cancel</button>
                <button class="modal-btn primary" id="modalConfirm">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Main Spreadsheet Application
        class SpreadsheetApp {
            constructor() {
                // Spreadsheet data structure
                this.sheets = [{
                    id: 1,
                    name: 'Sheet1',
                    data: {},
                    styles: {},
                    columnWidths: {},
                    formulas: {}
                }];
                
                this.activeSheetIndex = 0;
                this.selectedCell = { row: 1, col: 1 };
                this.selectedRange = null;
                this.isSelectingRange = false;
                this.isResizingColumn = false;
                this.formulaMode = false;
                this.currentSheetId = 1;
                
                // UI Elements
                this.elements = {
                    spreadsheetContainer: document.getElementById('spreadsheetContainer'),
                    sheetTabs: document.getElementById('sheetTabs'),
                    cellAddress: document.getElementById('cellAddress'),
                    formulaInput: document.getElementById('formulaInput'),
                    formulaHelper: document.getElementById('formulaHelper'),
                    statusInfo: document.getElementById('statusInfo'),
                    cellCount: document.getElementById('cellCount'),
                    sheetModal: document.getElementById('sheetModal'),
                    modalTitle: document.getElementById('modalTitle'),
                    modalInput: document.getElementById('modalInput'),
                    modalCancel: document.getElementById('modalCancel'),
                    modalConfirm: document.getElementById('modalConfirm')
                };
                
                // Initialize the app
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.renderSheetTabs();
                this.renderGrid();
                this.updateFormulaBar();
                this.updateStatus();
                
                // Set initial focus
                this.focusSelectedCell();
            }
            
            setupEventListeners() {
                // Toolbar buttons
                document.getElementById('boldBtn').addEventListener('click', () => this.toggleStyle('fontWeight', 'bold'));
                document.getElementById('italicBtn').addEventListener('click', () => this.toggleStyle('fontStyle', 'italic'));
                document.getElementById('bgColorPicker').addEventListener('input', (e) => this.setStyle('backgroundColor', e.target.value));
                document.getElementById('clearBtn').addEventListener('click', () => this.clearCellContents());
                
                // CSV actions
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadCSV());
                document.getElementById('uploadCsv').addEventListener('change', (e) => this.uploadCSV(e));
                
                // Formula bar
                this.elements.formulaInput.addEventListener('focus', () => this.enterFormulaMode());
                this.elements.formulaInput.addEventListener('blur', () => this.exitFormulaMode());
                this.elements.formulaInput.addEventListener('input', () => this.handleFormulaInput());
                this.elements.formulaInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.commitFormula();
                        this.focusSelectedCell();
                    } else if (e.key === 'Escape') {
                        this.elements.formulaInput.value = this.getCellFormula(this.selectedCell.row, this.selectedCell.col) || '';
                        this.exitFormulaMode();
                        this.focusSelectedCell();
                    }
                });
                
                // Keyboard navigation
                document.addEventListener('keydown', (e) => this.handleKeydown(e));
                
                // Modal buttons
                this.elements.modalCancel.addEventListener('click', () => this.hideModal());
                this.elements.modalConfirm.addEventListener('click', () => this.handleModalConfirm());
                
                // Window events
                window.addEventListener('resize', () => this.renderGrid());
                document.addEventListener('mouseup', () => {
                    this.isSelectingRange = false;
                    this.isResizingColumn = false;
                });
            }
            
            // Sheet Management
            renderSheetTabs() {
                this.elements.sheetTabs.innerHTML = '';
                
                this.sheets.forEach((sheet, index) => {
                    const tab = document.createElement('div');
                    tab.className = `sheet-tab ${index === this.activeSheetIndex ? 'active' : ''}`;
                    tab.dataset.sheetId = sheet.id;
                    tab.dataset.index = index;
                    
                    tab.innerHTML = `
                        <span class="tab-name">${sheet.name}</span>
                        ${this.sheets.length > 1 ? '<i class="fas fa-times tab-close"></i>' : ''}
                    `;
                    
                    // Tab click event
                    tab.addEventListener('click', (e) => {
                        if (e.target.classList.contains('tab-close')) {
                            this.deleteSheet(index);
                            return;
                        }
                        
                        this.activateSheet(index);
                    });
                    
                    // Double click to rename
                    tab.addEventListener('dblclick', (e) => {
                        if (!e.target.classList.contains('tab-close')) {
                            this.renameSheet(index);
                        }
                    });
                    
                    this.elements.sheetTabs.appendChild(tab);
                });
                
                // Add sheet button
                const addBtn = document.createElement('button');
                addBtn.className = 'add-sheet-btn';
                addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addBtn.title = 'Add new sheet';
                addBtn.addEventListener('click', () => this.showModal('newSheet'));
                
                this.elements.sheetTabs.appendChild(addBtn);
            }
            
            activateSheet(index) {
                this.activeSheetIndex = index;
                this.currentSheetId = this.sheets[index].id;
                this.selectedCell = { row: 1, col: 1 };
                this.selectedRange = null;
                this.renderGrid();
                this.updateFormulaBar();
                this.renderSheetTabs();
            }
            
            addSheet(name = `Sheet${this.sheets.length + 1}`) {
                const newSheet = {
                    id: Date.now(),
                    name: name,
                    data: {},
                    styles: {},
                    columnWidths: {},
                    formulas: {}
                };
                
                this.sheets.push(newSheet);
                this.activateSheet(this.sheets.length - 1);
            }
            
            renameSheet(index) {
                this.showModal('renameSheet', index);
            }
            
            deleteSheet(index) {
                if (this.sheets.length <= 1) {
                    alert('Cannot delete the last sheet');
                    return;
                }
                
                if (confirm(`Delete sheet "${this.sheets[index].name}"?`)) {
                    this.sheets.splice(index, 1);
                    
                    if (this.activeSheetIndex >= index && this.activeSheetIndex > 0) {
                        this.activeSheetIndex--;
                    }
                    
                    this.activateSheet(this.activeSheetIndex);
                }
            }
            
            // Grid Rendering
            renderGrid() {
                const container = this.elements.spreadsheetContainer;
                container.innerHTML = '';
                
                // Column headers (A, B, C, ...)
                const columnHeaders = document.createElement('div');
                columnHeaders.className = 'column-headers';
                columnHeaders.id = 'columnHeaders';
                
                // Row headers (1, 2, 3, ...)
                const rowHeaders = document.createElement('div');
                rowHeaders.className = 'row-headers';
                rowHeaders.id = 'rowHeaders';
                
                // Cells container
                const cellsContainer = document.createElement('div');
                cellsContainer.className = 'cells-container';
                cellsContainer.id = 'cellsContainer';
                
                // Generate headers and cells
                for (let col = 1; col <= 26; col++) {
                    const colHeader = document.createElement('div');
                    colHeader.className = 'column-header';
                    colHeader.textContent = this.numberToColumn(col);
                    colHeader.dataset.col = col;
                    
                    // Add resize handle
                    const resizeHandle = document.createElement('div');
                    resizeHandle.className = 'resize-handle';
                    resizeHandle.addEventListener('mousedown', (e) => this.startColumnResize(e, col));
                    colHeader.appendChild(resizeHandle);
                    
                    columnHeaders.appendChild(colHeader);
                }
                
                for (let row = 1; row <= 50; row++) {
                    // Row header
                    const rowHeader = document.createElement('div');
                    rowHeader.className = 'row-header';
                    rowHeader.textContent = row;
                    rowHeader.dataset.row = row;
                    rowHeaders.appendChild(rowHeader);
                    
                    // Row of cells
                    const cellRow = document.createElement('div');
                    cellRow.className = 'cell-row';
                    cellRow.dataset.row = row;
                    
                    for (let col = 1; col <= 26; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        cell.contentEditable = true;
                        
                        // Set cell content
                        const cellValue = this.getCellValue(row, col);
                        cell.textContent = cellValue !== null && cellValue !== undefined ? cellValue : '';
                        
                        // Apply styles
                        this.applyCellStyles(cell, row, col);
                        
                        // Check if cell is in selected range
                        if (this.isCellSelected(row, col)) {
                            this.updateCellSelectionClass(cell, row, col);
                        }
                        
                        // Cell events
                        cell.addEventListener('focus', (e) => this.onCellFocus(e, row, col));
                        cell.addEventListener('blur', (e) => this.onCellBlur(e, row, col));
                        cell.addEventListener('mousedown', (e) => this.onCellMouseDown(e, row, col));
                        cell.addEventListener('mouseover', (e) => this.onCellMouseOver(e, row, col));
                        cell.addEventListener('dblclick', (e) => this.onCellDoubleClick(e, row, col));
                        cell.addEventListener('keydown', (e) => this.onCellKeydown(e, row, col));
                        cell.addEventListener('input', (e) => this.onCellInput(e, row, col));
                        
                        cellRow.appendChild(cell);
                    }
                    
                    cellsContainer.appendChild(cellRow);
                }
                
                container.appendChild(columnHeaders);
                container.appendChild(rowHeaders);
                container.appendChild(cellsContainer);
                
                // Update cell count
                this.updateCellCount();
            }
            
            // Cell Operations
            getCellValue(row, col) {
                const sheet = this.sheets[this.activeSheetIndex];
                const key = `${row},${col}`;
                
                // Check if cell has a formula
                if (sheet.formulas[key]) {
                    try {
                        return this.evaluateFormula(sheet.formulas[key], row, col);
                    } catch (error) {
                        console.error('Formula error:', error);
                        return '#ERROR!';
                    }
                }
                
                // Return raw value
                return sheet.data[key] !== undefined ? sheet.data[key] : '';
            }
            
            getCellFormula(row, col) {
                const sheet = this.sheets[this.activeSheetIndex];
                const key = `${row},${col}`;
                return sheet.formulas[key] || '';
            }
            
            setCellValue(row, col, value) {
                const sheet = this.sheets[this.activeSheetIndex];
                const key = `${row},${col}`;
                
                // Check if value is a formula
                if (typeof value === 'string' && value.startsWith('=')) {
                    sheet.formulas[key] = value;
                    delete sheet.data[key];
                } else {
                    sheet.data[key] = value;
                    delete sheet.formulas[key];
                }
                
                // Recalculate dependent cells
                this.recalculateDependents(row, col);
                
                // Update UI
                this.updateCellDisplay(row, col);
                this.updateFormulaBar();
                this.updateCellCount();
            }
            
            evaluateFormula(formula, row, col) {
                // Remove the leading '='
                let expression = formula.substring(1).toUpperCase();
                
                // Handle cell references (e.g., A1, B2)
                expression = expression.replace(/([A-Z]+)([0-9]+)/g, (match, colLetters, rowNum) => {
                    const refCol = this.columnToNumber(colLetters);
                    const refRow = parseInt(rowNum);
                    const refValue = this.getCellValue(refRow, refCol);
                    
                    // Convert to number if possible
                    const numValue = parseFloat(refValue);
                    return !isNaN(numValue) ? numValue : 0;
                });
                
                // Handle ranges (e.g., A1:A10)
                expression = expression.replace(/([A-Z]+)([0-9]+):([A-Z]+)([0-9]+)/g, (match, startColLetters, startRow, endColLetters, endRow) => {
                    const startCol = this.columnToNumber(startColLetters);
                    const endCol = this.columnToNumber(endColLetters);
                    const startRowNum = parseInt(startRow);
                    const endRowNum = parseInt(endRow);
                    
                    // Collect values from the range
                    const values = [];
                    for (let r = startRowNum; r <= endRowNum; r++) {
                        for (let c = startCol; c <= endCol; c++) {
                            const val = this.getCellValue(r, c);
                            const numVal = parseFloat(val);
                            if (!isNaN(numVal)) {
                                values.push(numVal);
                            }
                        }
                    }
                    
                    // For now, just sum the range (we'll handle functions separately)
                    return values.reduce((sum, val) => sum + val, 0);
                });
                
                // Handle functions (SUM, AVERAGE, MIN, MAX)
                const functions = {
                    'SUM': (args) => args.reduce((sum, val) => sum + val, 0),
                    'AVERAGE': (args) => args.reduce((sum, val) => sum + val, 0) / args.length,
                    'MIN': (args) => Math.min(...args),
                    'MAX': (args) => Math.max(...args)
                };
                
                for (const [funcName, func] of Object.entries(functions)) {
                    const regex = new RegExp(`${funcName}\\(([^)]+)\\)`, 'gi');
                    expression = expression.replace(regex, (match, argsStr) => {
                        // Parse arguments (could be numbers, cell references, or ranges)
                        const args = [];
                        const argParts = argsStr.split(',');
                        
                        for (const arg of argParts) {
                            const trimmed = arg.trim();
                            
                            // Check if it's a number
                            const num = parseFloat(trimmed);
                            if (!isNaN(num)) {
                                args.push(num);
                            }
                            // Check if it's a range (already replaced with sum)
                            else if (!isNaN(trimmed)) {
                                args.push(parseFloat(trimmed));
                            } else {
                                // Default to 0 for unrecognized arguments
                                args.push(0);
                            }
                        }
                        
                        return func(args);
                    });
                }
                
                // Evaluate arithmetic expression
                try {
                    // Use Function constructor for safe evaluation
                    const result = new Function('return ' + expression)();
                    
                    // Format result
                    if (typeof result === 'number') {
                        // Check if it's an integer
                        return result % 1 === 0 ? result.toString() : result.toFixed(2);
                    }
                    
                    return result.toString();
                } catch (error) {
                    console.error('Error evaluating formula:', error);
                    return '#ERROR!';
                }
            }
            
            recalculateDependents(row, col) {
                // For simplicity, we'll recalculate all formulas in the sheet
                // In a more advanced implementation, we would track dependencies
                const sheet = this.sheets[this.activeSheetIndex];
                
                for (const key in sheet.formulas) {
                    const [r, c] = key.split(',').map(Number);
                    this.updateCellDisplay(r, c);
                }
            }
            
            updateCellDisplay(row, col) {
                const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                if (cell) {
                    const cellValue = this.getCellValue(row, col);
                    cell.textContent = cellValue !== null && cellValue !== undefined ? cellValue : '';
                    
                    // Update formula class
                    const formula = this.getCellFormula(row, col);
                    if (formula) {
                        cell.classList.add('formula');
                    } else {
                        cell.classList.remove('formula');
                    }
                }
            }
            
            applyCellStyles(cell, row, col) {
                const sheet = this.sheets[this.activeSheetIndex];
                const key = `${row},${col}`;
                const styles = sheet.styles[key] || {};
                
                // Apply styles
                if (styles.fontWeight === 'bold') {
                    cell.style.fontWeight = 'bold';
                }
                
                if (styles.fontStyle === 'italic') {
                    cell.style.fontStyle = 'italic';
                }
                
                if (styles.backgroundColor) {
                    cell.style.backgroundColor = styles.backgroundColor;
                }
                
                // Apply column width
                const colLetter = this.numberToColumn(col);
                const colWidth = sheet.columnWidths[colLetter];
                if (colWidth) {
                    cell.style.width = `${colWidth}px`;
                }
            }
            
            // Selection Management
            isCellSelected(row, col) {
                if (!this.selectedRange && this.selectedCell.row === row && this.selectedCell.col === col) {
                    return true;
                }
                
                if (this.selectedRange) {
                    const { startRow, startCol, endRow, endCol } = this.selectedRange;
                    const minRow = Math.min(startRow, endRow);
                    const maxRow = Math.max(startRow, endRow);
                    const minCol = Math.min(startCol, endCol);
                    const maxCol = Math.max(startCol, endCol);
                    
                    return row >= minRow && row <= maxRow && col >= minCol && col <= maxCol;
                }
                
                return false;
            }
            
            updateCellSelectionClass(cell, row, col) {
                // Remove all selection classes
                cell.classList.remove('selected', 'top', 'bottom', 'left', 'right');
                
                if (!this.selectedRange) {
                    // Single cell selection
                    cell.classList.add('selected');
                    return;
                }
                
                // Range selection - determine border classes
                const { startRow, startCol, endRow, endCol } = this.selectedRange;
                const minRow = Math.min(startRow, endRow);
                const maxRow = Math.max(startRow, endRow);
                const minCol = Math.min(startCol, endCol);
                const maxCol = Math.max(startCol, endCol);
                
                // Check if cell is on the edge of the selection
                if (row === minRow) cell.classList.add('top');
                if (row === maxRow) cell.classList.add('bottom');
                if (col === minCol) cell.classList.add('left');
                if (col === maxCol) cell.classList.add('right');
                
                cell.classList.add('selected');
            }
            
            selectCell(row, col, extendSelection = false) {
                if (!extendSelection || !this.selectedRange) {
                    this.selectedCell = { row, col };
                    this.selectedRange = null;
                } else {
                    // Extend the selection range
                    this.selectedRange.endRow = row;
                    this.selectedRange.endCol = col;
                }
                
                this.updateFormulaBar();
                this.renderGrid();
            }
            
            selectRange(startRow, startCol, endRow, endCol) {
                this.selectedRange = { startRow, startCol, endRow, endCol };
                this.selectedCell = { row: startRow, col: startCol };
                this.updateFormulaBar();
                this.renderGrid();
            }
            
            // Formula Bar
            updateFormulaBar() {
                const { row, col } = this.selectedCell;
                this.elements.cellAddress.textContent = `${this.numberToColumn(col)}${row}`;
                
                const formula = this.getCellFormula(row, col);
                if (formula) {
                    this.elements.formulaInput.value = formula;
                } else {
                    const value = this.getCellValue(row, col);
                    this.elements.formulaInput.value = value || '';
                }
            }
            
            enterFormulaMode() {
                this.formulaMode = true;
                this.elements.formulaHelper.style.display = 'block';
                this.positionFormulaHelper();
                
                // Update formula bar with the formula if available
                const formula = this.getCellFormula(this.selectedCell.row, this.selectedCell.col);
                if (formula) {
                    this.elements.formulaInput.value = formula;
                }
            }
            
            exitFormulaMode() {
                this.formulaMode = false;
                this.elements.formulaHelper.style.display = 'none';
            }
            
            positionFormulaHelper() {
                const inputRect = this.elements.formulaInput.getBoundingClientRect();
                this.elements.formulaHelper.style.top = `${inputRect.bottom + 5}px`;
                this.elements.formulaHelper.style.left = `${inputRect.left}px`;
            }
            
            handleFormulaInput() {
                // If user is typing a formula and clicks on a cell, insert the reference
                if (this.formulaMode && this.isSelectingRange) {
                    const { row, col } = this.selectedCell;
                    const cellRef = `${this.numberToColumn(col)}${row}`;
                    
                    // Insert at cursor position
                    const input = this.elements.formulaInput;
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    
                    input.value = input.value.substring(0, start) + cellRef + input.value.substring(end);
                    input.selectionStart = input.selectionEnd = start + cellRef.length;
                    
                    this.isSelectingRange = false;
                }
            }
            
            commitFormula() {
                const formula = this.elements.formulaInput.value.trim();
                this.setCellValue(this.selectedCell.row, this.selectedCell.col, formula);
                this.exitFormulaMode();
            }
            
            // Styling
            toggleStyle(styleProperty, styleValue) {
                const sheet = this.sheets[this.activeSheetIndex];
                
                if (this.selectedRange) {
                    // Apply to all cells in range
                    const { startRow, startCol, endRow, endCol } = this.selectedRange;
                    const minRow = Math.min(startRow, endRow);
                    const maxRow = Math.max(startRow, endRow);
                    const minCol = Math.min(startCol, endCol);
                    const maxCol = Math.max(startCol, endCol);
                    
                    for (let row = minRow; row <= maxRow; row++) {
                        for (let col = minCol; col <= maxCol; col++) {
                            const key = `${row},${col}`;
                            if (!sheet.styles[key]) sheet.styles[key] = {};
                            
                            // Toggle the style
                            if (sheet.styles[key][styleProperty] === styleValue) {
                                delete sheet.styles[key][styleProperty];
                            } else {
                                sheet.styles[key][styleProperty] = styleValue;
                            }
                        }
                    }
                } else {
                    // Apply to single cell
                    const key = `${this.selectedCell.row},${this.selectedCell.col}`;
                    if (!sheet.styles[key]) sheet.styles[key] = {};
                    
                    // Toggle the style
                    if (sheet.styles[key][styleProperty] === styleValue) {
                        delete sheet.styles[key][styleProperty];
                    } else {
                        sheet.styles[key][styleProperty] = styleValue;
                    }
                }
                
                this.renderGrid();
            }
            
            setStyle(styleProperty, value) {
                const sheet = this.sheets[this.activeSheetIndex];
                
                if (this.selectedRange) {
                    // Apply to all cells in range
                    const { startRow, startCol, endRow, endCol } = this.selectedRange;
                    const minRow = Math.min(startRow, endRow);
                    const maxRow = Math.max(startRow, endRow);
                    const minCol = Math.min(startCol, endCol);
                    const maxCol = Math.max(startCol, endCol);
                    
                    for (let row = minRow; row <= maxRow; row++) {
                        for (let col = minCol; col <= maxCol; col++) {
                            const key = `${row},${col}`;
                            if (!sheet.styles[key]) sheet.styles[key] = {};
                            sheet.styles[key][styleProperty] = value;
                        }
                    }
                } else {
                    // Apply to single cell
                    const key = `${this.selectedCell.row},${this.selectedCell.col}`;
                    if (!sheet.styles[key]) sheet.styles[key] = {};
                    sheet.styles[key][styleProperty] = value;
                }
                
                this.renderGrid();
            }
            
            clearCellContents() {
                const sheet = this.sheets[this.activeSheetIndex];
                
                if (this.selectedRange) {
                    // Clear all cells in range
                    const { startRow, startCol, endRow, endCol } = this.selectedRange;
                    const minRow = Math.min(startRow, endRow);
                    const maxRow = Math.max(startRow, endRow);
                    const minCol = Math.min(startCol, endCol);
                    const maxCol = Math.max(startCol, endCol);
                    
                    for (let row = minRow; row <= maxRow; row++) {
                        for (let col = minCol; col <= maxCol; col++) {
                            const key = `${row},${col}`;
                            delete sheet.data[key];
                            delete sheet.formulas[key];
                        }
                    }
                } else {
                    // Clear single cell
                    const key = `${this.selectedCell.row},${this.selectedCell.col}`;
                    delete sheet.data[key];
                    delete sheet.formulas[key];
                }
                
                this.renderGrid();
                this.updateFormulaBar();
            }
            
            // CSV Operations
            downloadCSV() {
                const sheet = this.sheets[this.activeSheetIndex];
                const rows = 50;
                const cols = 26;
                
                let csvContent = "";
                
                for (let row = 1; row <= rows; row++) {
                    const rowValues = [];
                    
                    for (let col = 1; col <= cols; col++) {
                        const value = this.getCellValue(row, col);
                        // Escape quotes and wrap in quotes if contains comma
                        const escapedValue = value !== null && value !== undefined ? 
                            (value.includes(',') || value.includes('"') || value.includes('\n') ? 
                                `"${value.replace(/"/g, '""')}"` : value) : '';
                        rowValues.push(escapedValue);
                    }
                    
                    csvContent += rowValues.join(',') + '\n';
                }
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `${sheet.name}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.updateStatus(`Downloaded ${sheet.name}.csv`);
            }
            
            uploadCSV(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const rows = content.split('\n');
                    
                    // Clear current sheet data
                    const sheet = this.sheets[this.activeSheetIndex];
                    sheet.data = {};
                    sheet.formulas = {};
                    
                    // Parse CSV
                    for (let rowIndex = 0; rowIndex < Math.min(rows.length, 50); rowIndex++) {
                        const row = rows[rowIndex];
                        const cols = this.parseCSVRow(row);
                        
                        for (let colIndex = 0; colIndex < Math.min(cols.length, 26); colIndex++) {
                            const value = cols[colIndex];
                            if (value) {
                                const key = `${rowIndex + 1},${colIndex + 1}`;
                                sheet.data[key] = value;
                            }
                        }
                    }
                    
                    // Reset file input
                    event.target.value = '';
                    
                    // Update UI
                    this.renderGrid();
                    this.updateStatus(`Loaded ${file.name}`);
                };
                
                reader.readAsText(file);
            }
            
            parseCSVRow(row) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < row.length; i++) {
                    const char = row[i];
                    
                    if (char === '"' && (i === 0 || row[i-1] !== '\\')) {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current);
                return result;
            }
            
            // Column Operations
            startColumnResize(e, col) {
                e.preventDefault();
                e.stopPropagation();
                
                this.isResizingColumn = true;
                const columnHeader = e.target.parentElement;
                const startX = e.clientX;
                const startWidth = columnHeader.offsetWidth;
                const colLetter = this.numberToColumn(col);
                
                const onMouseMove = (moveEvent) => {
                    if (!this.isResizingColumn) return;
                    
                    const delta = moveEvent.clientX - startX;
                    const newWidth = Math.max(50, startWidth + delta);
                    
                    // Update all cells in this column
                    const cells = document.querySelectorAll(`.cell[data-col="${col}"]`);
                    cells.forEach(cell => {
                        cell.style.width = `${newWidth}px`;
                    });
                    
                    // Update column header
                    columnHeader.style.width = `${newWidth}px`;
                    
                    // Save width
                    const sheet = this.sheets[this.activeSheetIndex];
                    sheet.columnWidths[colLetter] = newWidth;
                };
                
                const onMouseUp = () => {
                    this.isResizingColumn = false;
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }
            
            // Event Handlers
            onCellFocus(e, row, col) {
                this.selectCell(row, col);
                e.target.classList.add('editing');
            }
            
            onCellBlur(e, row, col) {
                e.target.classList.remove('editing');
                
                // Save cell value
                const value = e.target.textContent.trim();
                this.setCellValue(row, col, value);
            }
            
            onCellMouseDown(e, row, col) {
                // Handle formula mode
                if (this.formulaMode) {
                    e.preventDefault();
                    this.isSelectingRange = true;
                    this.selectCell(row, col, e.shiftKey);
                    return;
                }
                
                // Regular selection
                if (e.shiftKey && this.selectedCell) {
                    this.selectRange(this.selectedCell.row, this.selectedCell.col, row, col);
                } else {
                    this.selectCell(row, col);
                    this.isSelectingRange = true;
                }
                
                // Focus the cell
                e.target.focus();
            }
            
            onCellMouseOver(e, row, col) {
                if (this.isSelectingRange) {
                    this.selectRange(this.selectedCell.row, this.selectedCell.col, row, col);
                }
            }
            
            onCellDoubleClick(e, row, col) {
                // Enable editing
                e.target.focus();
                
                // Select all text
                const range = document.createRange();
                range.selectNodeContents(e.target);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }
            
            onCellKeydown(e, row, col) {
                // Handle arrow keys for navigation
                if (!e.altKey && !e.ctrlKey && !e.metaKey) {
                    switch (e.key) {
                        case 'ArrowUp':
                            e.preventDefault();
                            if (row > 1) this.selectCell(row - 1, col);
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            if (row < 50) this.selectCell(row + 1, col);
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            if (col > 1) this.selectCell(row, col - 1);
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            if (col < 26) this.selectCell(row, col + 1);
                            break;
                        case 'Enter':
                            e.preventDefault();
                            if (row < 50) this.selectCell(row + 1, col);
                            break;
                        case 'Tab':
                            e.preventDefault();
                            if (!e.shiftKey && col < 26) {
                                this.selectCell(row, col + 1);
                            } else if (e.shiftKey && col > 1) {
                                this.selectCell(row, col - 1);
                            }
                            break;
                    }
                }
                
                // Focus formula bar on F2
                if (e.key === 'F2') {
                    e.preventDefault();
                    this.elements.formulaInput.focus();
                    this.elements.formulaInput.select();
                }
            }
            
            onCellInput(e, row, col) {
                // Auto-resize column if needed
                const contentWidth = e.target.scrollWidth;
                const cellWidth = e.target.offsetWidth;
                
                if (contentWidth > cellWidth) {
                    const newWidth = Math.min(300, contentWidth + 20);
                    const colLetter = this.numberToColumn(col);
                    
                    // Update all cells in this column
                    const cells = document.querySelectorAll(`.cell[data-col="${col}"]`);
                    cells.forEach(cell => {
                        cell.style.width = `${newWidth}px`;
                    });
                    
                    // Update column header
                    const columnHeader = document.querySelector(`.column-header[data-col="${col}"]`);
                    if (columnHeader) {
                        columnHeader.style.width = `${newWidth}px`;
                    }
                    
                    // Save width
                    const sheet = this.sheets[this.activeSheetIndex];
                    sheet.columnWidths[colLetter] = newWidth;
                }
            }
            
            handleKeydown(e) {
                // Global keyboard shortcuts
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key.toLowerCase()) {
                        case 'b':
                            e.preventDefault();
                            this.toggleStyle('fontWeight', 'bold');
                            break;
                        case 'i':
                            e.preventDefault();
                            this.toggleStyle('fontStyle', 'italic');
                            break;
                        case 'd':
                            e.preventDefault();
                            this.downloadCSV();
                            break;
                    }
                }
                
                // Escape key
                if (e.key === 'Escape') {
                    if (this.formulaMode) {
                        this.exitFormulaMode();
                        this.focusSelectedCell();
                    }
                }
            }
            
            // Modal
            showModal(type, data = null) {
                this.modalType = type;
                this.modalData = data;
                
                if (type === 'newSheet') {
                    this.elements.modalTitle.textContent = 'New Sheet';
                    this.elements.modalInput.value = `Sheet${this.sheets.length + 1}`;
                } else if (type === 'renameSheet') {
                    this.elements.modalTitle.textContent = 'Rename Sheet';
                    this.elements.modalInput.value = this.sheets[data].name;
                }
                
                this.elements.sheetModal.style.display = 'flex';
                this.elements.modalInput.focus();
                this.elements.modalInput.select();
            }
            
            hideModal() {
                this.elements.sheetModal.style.display = 'none';
                this.modalType = null;
                this.modalData = null;
            }
            
            handleModalConfirm() {
                const value = this.elements.modalInput.value.trim();
                
                if (!value) {
                    alert('Please enter a name');
                    return;
                }
                
                if (this.modalType === 'newSheet') {
                    this.addSheet(value);
                } else if (this.modalType === 'renameSheet') {
                    this.sheets[this.modalData].name = value;
                    this.renderSheetTabs();
                }
                
                this.hideModal();
            }
            
            // Utility Functions
            numberToColumn(num) {
                let result = '';
                while (num > 0) {
                    const remainder = (num - 1) % 26;
                    result = String.fromCharCode(65 + remainder) + result;
                    num = Math.floor((num - 1) / 26);
                }
                return result;
            }
            
            columnToNumber(letters) {
                let result = 0;
                for (let i = 0; i < letters.length; i++) {
                    result = result * 26 + (letters.charCodeAt(i) - 64);
                }
                return result;
            }
            
            focusSelectedCell() {
                const { row, col } = this.selectedCell;
                const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                if (cell) {
                    cell.focus();
                }
            }
            
            updateStatus(message = null) {
                if (message) {
                    this.elements.statusInfo.textContent = message;
                    // Clear message after 3 seconds
                    setTimeout(() => {
                        this.elements.statusInfo.textContent = 'Ready';
                    }, 3000);
                } else {
                    this.elements.statusInfo.textContent = 'Ready';
                }
            }
            
            updateCellCount() {
                const sheet = this.sheets[this.activeSheetIndex];
                const cellCount = Object.keys(sheet.data).length + Object.keys(sheet.formulas).length;
                this.elements.cellCount.textContent = `Cells: ${cellCount}`;
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.spreadsheetApp = new SpreadsheetApp();
        });
    </script>
</body>
</html>