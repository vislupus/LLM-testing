<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Gas Simulation - Statistical Mechanics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            padding: 15px;
            color: #fff;
        }
        
        h1 {
            color: #4fc3f7;
            margin-bottom: 12px;
            font-weight: 400;
            font-size: 24px;
            text-shadow: 0 0 20px rgba(79, 195, 247, 0.3);
        }
        
        #main-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        #canvas-wrapper {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(79, 195, 247, 0.3);
        }
        
        #side-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 320px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel h3 {
            color: #4fc3f7;
            font-size: 12px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }
        
        .control-row {
            margin-bottom: 12px;
        }
        
        .control-row label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 11px;
            color: #aaa;
        }
        
        .control-row label span {
            color: #f472b6;
            font-family: 'Consolas', monospace;
            font-weight: 600;
        }
        
        input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            cursor: pointer;
        }
        
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .toggle-row span {
            font-size: 12px;
            color: #aaa;
        }
        
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 22px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            position: absolute;
            z-index: 1;
        }
        
        .toggle-switch .slider {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 22px;
            transition: 0.3s;
            pointer-events: none;
        }
        
        .toggle-switch .slider::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            left: 3px;
            bottom: 3px;
            background: #888;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        .toggle-switch input:checked + .slider {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
        }
        
        .toggle-switch input:checked + .slider::before {
            transform: translateX(22px);
            background: #fff;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 16px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
            color: #4fc3f7;
        }
        
        .stat-box .label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
            margin-top: 3px;
        }
        
        .button-row {
            display: flex;
            gap: 8px;
        }
        
        button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        
        .btn-blue {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: #000;
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #ce93d8, #ab47bc);
            color: #fff;
        }
        
        .btn-green {
            background: linear-gradient(135deg, #81c784, #66bb6a);
            color: #000;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        #histogram {
            width: 100%;
            height: 120px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .legend {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            font-size: 10px;
            color: #888;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .info-text {
            font-size: 10px;
            color: #666;
            line-height: 1.5;
            margin-top: 8px;
        }
        
        .info-text kbd {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Consolas', monospace;
        }
    </style>
</head>
<body>
    <h1>üî¨ 2D Ideal Gas Simulation</h1>
    
    <div id="main-container">
        <div id="canvas-wrapper"></div>
        
        <div id="side-panel">
            <div class="panel">
                <h3>üìä Thermodynamic Properties</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="tempDisplay">0</div>
                        <div class="label">Temperature (T)</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="pressureDisplay">0</div>
                        <div class="label">Pressure (P)</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="keDisplay">0</div>
                        <div class="label">Total KE</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="particleDisplay">0</div>
                        <div class="label">Particles (N)</div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>‚ö° Speed Distribution</h3>
                <canvas id="histogram"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #4fc3f7;"></div>
                        <span>Measured</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #f472b6;"></div>
                        <span>Maxwell-Boltzmann</span>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>‚öôÔ∏è Simulation Parameters</h3>
                <div class="control-row">
                    <label>Number of Particles: <span id="numVal">200</span></label>
                    <input type="range" id="numParticles" min="20" max="500" step="10" value="200">
                </div>
                <div class="control-row">
                    <label>Initial Temperature: <span id="initTempVal">300</span></label>
                    <input type="range" id="initTemp" min="50" max="1000" step="10" value="300">
                </div>
                <div class="control-row">
                    <label>Particle Radius: <span id="radiusVal">3</span></label>
                    <input type="range" id="particleRadius" min="2" max="8" step="0.5" value="3">
                </div>
                <div class="toggle-row">
                    <span>Collisions Enabled</span>
                    <div class="toggle-switch">
                        <input type="checkbox" id="collisionsEnabled" checked>
                        <div class="slider"></div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>üß™ Two-Species Mixture</h3>
                <div class="control-row">
                    <label>Species Ratio (A:B): <span id="ratioVal">50%</span></label>
                    <input type="range" id="speciesRatio" min="0" max="100" step="5" value="50">
                </div>
                <div class="control-row">
                    <label>Mass Ratio (B/A): <span id="massRatioVal">4.0</span></label>
                    <input type="range" id="massRatio" min="1" max="10" step="0.5" value="4">
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #4fc3f7;"></div>
                        <span>Species A (light)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #f472b6;"></div>
                        <span>Species B (heavy)</span>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>üéÆ Controls</h3>
                <div class="button-row">
                    <button class="btn-blue" onclick="resetSimulation()">Reset</button>
                    <button class="btn-purple" onclick="togglePause()">Pause</button>
                    <button class="btn-green" onclick="thermalize()">Thermalize</button>
                </div>
                <div class="info-text">
                    <kbd>Space</kbd> Pause/Resume | <kbd>R</kbd> Reset<br>
                    <kbd>T</kbd> Thermalize | <kbd>C</kbd> Toggle Collisions
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simulation parameters
        const WIDTH = 600;
        const HEIGHT = 500;
        const kB = 1; // Boltzmann constant in simulation units
        
        let particles = [];
        let numParticles = 200;
        let particleRadius = 3;
        let initialTemp = 300;
        let massA = 1;
        let massB = 4;
        let speciesRatio = 0.5;
        let collisionsEnabled = true;
        let paused = false;
        
        // Statistics
        let temperature = 0;
        let pressure = 0;
        let totalKE = 0;
        let momentumTransfer = 0;
        let lastPressureUpdate = 0;
        const pressureWindow = 60; // frames
        
        // Speed histogram
        let speedHistogram = new Array(30).fill(0);
        let histogramMax = 0;
        let histCanvas, histCtx;
        
        class Particle {
            constructor(x, y, vx, vy, mass, radius, species) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.mass = mass;
                this.radius = radius;
                this.species = species;
            }
            
            kineticEnergy() {
                return 0.5 * this.mass * (this.vx * this.vx + this.vy * this.vy);
            }
            
            speed() {
                return Math.sqrt(this.vx * this.vx + this.vy * this.vy);
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
            }
        }
        
        function setup() {
            const canvas = createCanvas(WIDTH, HEIGHT);
            canvas.parent('canvas-wrapper');
            
            histCanvas = document.getElementById('histogram');
            histCanvas.width = histCanvas.offsetWidth * 2;
            histCanvas.height = histCanvas.offsetHeight * 2;
            histCtx = histCanvas.getContext('2d');
            
            setupControls();
            initParticles();
        }
        
        function setupControls() {
            document.getElementById('numParticles').addEventListener('input', function() {
                numParticles = parseInt(this.value);
                document.getElementById('numVal').textContent = numParticles;
            });
            
            document.getElementById('initTemp').addEventListener('input', function() {
                initialTemp = parseFloat(this.value);
                document.getElementById('initTempVal').textContent = initialTemp;
            });
            
            document.getElementById('particleRadius').addEventListener('input', function() {
                particleRadius = parseFloat(this.value);
                document.getElementById('radiusVal').textContent = particleRadius;
                particles.forEach(p => p.radius = particleRadius);
            });
            
            document.getElementById('collisionsEnabled').addEventListener('change', function() {
                collisionsEnabled = this.checked;
            });
            
            document.getElementById('speciesRatio').addEventListener('input', function() {
                speciesRatio = parseInt(this.value) / 100;
                document.getElementById('ratioVal').textContent = Math.round(speciesRatio * 100) + '%';
            });
            
            document.getElementById('massRatio').addEventListener('input', function() {
                massB = parseFloat(this.value);
                document.getElementById('massRatioVal').textContent = massB.toFixed(1);
                // Update existing particles
                particles.forEach(p => {
                    if (p.species === 1) p.mass = massB;
                });
            });
        }
        
        function initParticles() {
            particles = [];
            momentumTransfer = 0;
            
            for (let i = 0; i < numParticles; i++) {
                const species = (i / numParticles < speciesRatio) ? 0 : 1;
                const mass = species === 0 ? massA : massB;
                
                // Maxwell-Boltzmann velocity distribution
                // For 2D, each velocity component follows Gaussian with variance = kT/m
                const sigma = Math.sqrt(kB * initialTemp / mass);
                const vx = randomGaussian(0, sigma);
                const vy = randomGaussian(0, sigma);
                
                // Random position avoiding overlap
                let x, y;
                let attempts = 0;
                do {
                    x = particleRadius + Math.random() * (WIDTH - 2 * particleRadius);
                    y = particleRadius + Math.random() * (HEIGHT - 2 * particleRadius);
                    attempts++;
                } while (checkOverlap(x, y, particleRadius) && attempts < 100);
                
                particles.push(new Particle(x, y, vx, vy, mass, particleRadius, species));
            }
            
            // Remove net momentum (center of mass stationary)
            let totalMass = 0, totalPx = 0, totalPy = 0;
            particles.forEach(p => {
                totalMass += p.mass;
                totalPx += p.mass * p.vx;
                totalPy += p.mass * p.vy;
            });
            const vcmx = totalPx / totalMass;
            const vcmy = totalPy / totalMass;
            particles.forEach(p => {
                p.vx -= vcmx;
                p.vy -= vcmy;
            });
        }
        
        function checkOverlap(x, y, r) {
            for (let p of particles) {
                const dx = p.x - x;
                const dy = p.y - y;
                if (dx * dx + dy * dy < (r + p.radius) * (r + p.radius)) {
                    return true;
                }
            }
            return false;
        }
        
        function randomGaussian(mean, std) {
            // Box-Muller transform
            const u1 = Math.random();
            const u2 = Math.random();
            return mean + std * Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        }
        
        function collideWalls(p) {
            // Left wall
            if (p.x - p.radius < 0) {
                p.x = p.radius;
                momentumTransfer += 2 * p.mass * Math.abs(p.vx);
                p.vx = Math.abs(p.vx);
            }
            // Right wall
            if (p.x + p.radius > WIDTH) {
                p.x = WIDTH - p.radius;
                momentumTransfer += 2 * p.mass * Math.abs(p.vx);
                p.vx = -Math.abs(p.vx);
            }
            // Top wall
            if (p.y - p.radius < 0) {
                p.y = p.radius;
                momentumTransfer += 2 * p.mass * Math.abs(p.vy);
                p.vy = Math.abs(p.vy);
            }
            // Bottom wall
            if (p.y + p.radius > HEIGHT) {
                p.y = HEIGHT - p.radius;
                momentumTransfer += 2 * p.mass * Math.abs(p.vy);
                p.vy = -Math.abs(p.vy);
            }
        }
        
        function collideParticles(p1, p2) {
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            const distSq = dx * dx + dy * dy;
            const minDist = p1.radius + p2.radius;
            
            if (distSq >= minDist * minDist) return;
            if (distSq === 0) return;
            
            const dist = Math.sqrt(distSq);
            
            // Normal vector
            const nx = dx / dist;
            const ny = dy / dist;
            
            // Relative velocity
            const dvx = p1.vx - p2.vx;
            const dvy = p1.vy - p2.vy;
            
            // Relative velocity along normal
            const dvn = dvx * nx + dvy * ny;
            
            // Only collide if approaching
            if (dvn > 0) return;
            
            // Elastic collision impulse
            const m1 = p1.mass;
            const m2 = p2.mass;
            const impulse = 2 * dvn / (1/m1 + 1/m2);
            
            // Update velocities
            p1.vx -= (impulse / m1) * nx;
            p1.vy -= (impulse / m1) * ny;
            p2.vx += (impulse / m2) * nx;
            p2.vy += (impulse / m2) * ny;
            
            // Separate particles
            const overlap = (minDist - dist) / 2 + 0.1;
            p1.x -= overlap * nx;
            p1.y -= overlap * ny;
            p2.x += overlap * nx;
            p2.y += overlap * ny;
        }
        
        function updatePhysics() {
            // Update positions
            particles.forEach(p => p.update());
            
            // Wall collisions
            particles.forEach(p => collideWalls(p));
            
            // Particle-particle collisions
            if (collisionsEnabled) {
                for (let i = 0; i < particles.length; i++) {
                    for (let j = i + 1; j < particles.length; j++) {
                        collideParticles(particles[i], particles[j]);
                    }
                }
            }
        }
        
        function computeStatistics() {
            // Total kinetic energy and temperature
            totalKE = 0;
            particles.forEach(p => totalKE += p.kineticEnergy());
            
            // Temperature: <KE> = N * kB * T in 2D (2 degrees of freedom per particle)
            temperature = totalKE / (particles.length * kB);
            
            // Pressure (force per unit length on walls)
            // P = momentum transfer rate / perimeter
            if (frameCount - lastPressureUpdate >= pressureWindow) {
                const perimeter = 2 * (WIDTH + HEIGHT);
                pressure = momentumTransfer / (pressureWindow * perimeter);
                momentumTransfer = 0;
                lastPressureUpdate = frameCount;
            }
            
            // Speed histogram
            speedHistogram.fill(0);
            const maxSpeed = 30;
            const binWidth = maxSpeed / speedHistogram.length;
            
            particles.forEach(p => {
                const speed = p.speed();
                const bin = Math.min(Math.floor(speed / binWidth), speedHistogram.length - 1);
                speedHistogram[bin]++;
            });
            
            histogramMax = Math.max(...speedHistogram, 1);
        }
        
        function drawHistogram() {
            const w = histCanvas.width;
            const h = histCanvas.height;
            
            histCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            histCtx.fillRect(0, 0, w, h);
            
            const barWidth = w / speedHistogram.length;
            const maxSpeed = 30;
            const binWidth = maxSpeed / speedHistogram.length;
            
            // Draw histogram bars
            histCtx.fillStyle = 'rgba(79, 195, 247, 0.7)';
            for (let i = 0; i < speedHistogram.length; i++) {
                const barHeight = (speedHistogram[i] / histogramMax) * h * 0.85;
                histCtx.fillRect(i * barWidth + 1, h - barHeight, barWidth - 2, barHeight);
            }
            
            // Draw Maxwell-Boltzmann curve for comparison
            if (temperature > 0 && particles.length > 0) {
                histCtx.strokeStyle = '#f472b6';
                histCtx.lineWidth = 3;
                histCtx.beginPath();
                
                // Calculate average mass for the MB distribution
                let totalMass = 0;
                particles.forEach(p => totalMass += p.mass);
                const avgMass = totalMass / particles.length;
                
                // 2D Maxwell-Boltzmann (Rayleigh distribution): f(v) = (m*v / kT) * exp(-m*v¬≤/(2*kT))
                // Normalize to match histogram
                const T = temperature;
                const m = avgMass;
                const norm = particles.length * binWidth;
                
                for (let i = 0; i <= speedHistogram.length; i++) {
                    const v = i * binWidth + binWidth / 2;
                    const mb = (m * v / (kB * T)) * Math.exp(-m * v * v / (2 * kB * T));
                    const expected = mb * norm;
                    const barHeight = (expected / histogramMax) * h * 0.85;
                    
                    const x = i * barWidth + barWidth / 2;
                    const y = h - barHeight;
                    
                    if (i === 0) histCtx.moveTo(x, y);
                    else histCtx.lineTo(x, y);
                }
                histCtx.stroke();
            }
            
            // Axis labels
            histCtx.fillStyle = '#888';
            histCtx.font = '18px Consolas';
            histCtx.fillText('Speed ‚Üí', w - 80, h - 10);
        }
        
        function draw() {
            // Dark background with gradient
            background(10, 15, 30);
            
            // Draw boundary
            stroke(79, 195, 247, 100);
            strokeWeight(2);
            noFill();
            rect(0, 0, WIDTH, HEIGHT);
            
            if (!paused) {
                updatePhysics();
                computeStatistics();
            }
            
            // Draw particles
            noStroke();
            particles.forEach(p => {
                if (p.species === 0) {
                    // Species A - cyan
                    fill(79, 195, 247);
                } else {
                    // Species B - pink (larger due to higher mass)
                    fill(244, 114, 182);
                }
                
                // Size slightly varies with mass for visual distinction
                const displayRadius = p.radius * (0.8 + 0.2 * Math.sqrt(p.mass));
                ellipse(p.x, p.y, displayRadius * 2, displayRadius * 2);
            });
            
            // Update UI
            if (frameCount % 5 === 0) {
                document.getElementById('tempDisplay').textContent = temperature.toFixed(1);
                document.getElementById('pressureDisplay').textContent = pressure.toFixed(3);
                document.getElementById('keDisplay').textContent = totalKE.toFixed(0);
                document.getElementById('particleDisplay').textContent = particles.length;
                
                drawHistogram();
            }
        }
        
        function resetSimulation() {
            paused = false;
            document.querySelector('.btn-purple').textContent = 'Pause';
            initParticles();
        }
        
        function togglePause() {
            paused = !paused;
            document.querySelector('.btn-purple').textContent = paused ? 'Resume' : 'Pause';
        }
        
        function thermalize() {
            // Reinitialize velocities to Maxwell-Boltzmann at current temperature
            particles.forEach(p => {
                const sigma = Math.sqrt(kB * temperature / p.mass);
                p.vx = randomGaussian(0, sigma);
                p.vy = randomGaussian(0, sigma);
            });
            
            // Remove net momentum
            let totalMass = 0, totalPx = 0, totalPy = 0;
            particles.forEach(p => {
                totalMass += p.mass;
                totalPx += p.mass * p.vx;
                totalPy += p.mass * p.vy;
            });
            const vcmx = totalPx / totalMass;
            const vcmy = totalPy / totalMass;
            particles.forEach(p => {
                p.vx -= vcmx;
                p.vy -= vcmy;
            });
        }
        
        function keyPressed() {
            if (key === ' ') {
                togglePause();
                return false;
            }
            if (key === 'r' || key === 'R') {
                resetSimulation();
            }
            if (key === 't' || key === 'T') {
                thermalize();
            }
            if (key === 'c' || key === 'C') {
                collisionsEnabled = !collisionsEnabled;
                document.getElementById('collisionsEnabled').checked = collisionsEnabled;
            }
        }
    </script>
</body>
</html>