<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Starfall Vanguard ‚Äî Space Shooter (single file)</title>
  <style>
    :root{
      --bg:#050713;
      --ink:#eaf1ff;
      --muted:rgba(234,241,255,.70);
      --panel:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.18);
      --accent:#67b3ff;
      --good:#35d39f;
      --bad:#ff6b87;
      --warn:#ffd166;
    }
    html,body{height:100%;margin:0;background:var(--bg);overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    canvas{width:100%;height:100%;display:block}
    .hud{
      position:fixed;inset:14px 14px auto 14px;
      display:none;gap:10px;align-items:center;flex-wrap:wrap;
      color:var(--ink);text-shadow:0 1px 0 rgba(0,0,0,.45);
      font-weight:900;font-size:13px;pointer-events:none;
    }
    .chip{
      padding:7px 10px;border-radius:14px;
      background:var(--panel);border:1px solid var(--stroke);
      backdrop-filter:blur(6px);
    }
    .kbd{
      display:inline-block;padding:2px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-weight:900;
      color:rgba(234,241,255,.86);
    }
    .overlay{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      color:var(--ink);
      background:radial-gradient(1200px 700px at 50% 40%, rgba(103,179,255,.18), rgba(0,0,0,.62));
    }
    .card{
      width:min(820px,92vw);
      border-radius:20px;border:1px solid rgba(255,255,255,.18);
      background:rgba(9,13,28,.72);
      box-shadow:0 20px 80px rgba(0,0,0,.55);
      padding:18px 18px 14px 18px;
    }
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    p{margin:10px 0;color:var(--muted);line-height:1.35;font-weight:650}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btns{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      pointer-events:auto;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(255,255,255,.10);
      color:var(--ink);font-weight:900;
      padding:10px 14px;border-radius:14px;cursor:pointer;
    }
    button:hover{background:rgba(255,255,255,.14)}
    .primary{background:rgba(103,179,255,.22);border-color:rgba(103,179,255,.35)}
    .primary:hover{background:rgba(103,179,255,.28)}
    .tog{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:14px;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);
      pointer-events:auto;user-select:none;
    }
    .tiny{font-size:12px;color:rgba(234,241,255,.65)}
  </style>
</head>
<body>
  <canvas id="c"></canvas>

  <div class="hud" id="hud">
    <div class="chip" id="hudScore">Score: 0</div>
    <div class="chip" id="hudLives">Lives: 3</div>
    <div class="chip" id="hudWave">Wave: 1</div>
    <div class="chip" id="hudPower">Power: ‚Äî</div>
    <div class="chip">Move: <span class="kbd">WASD</span>/<span class="kbd">Arrows</span> ‚Ä¢ Fire: <span class="kbd">Space</span> ‚Ä¢ Pause: <span class="kbd">P</span> ‚Ä¢ Restart: <span class="kbd">R</span></div>
  </div>

  <div class="overlay" id="overlay">
    <div class="card">
      <div class="row">
        <h1>üöÄ Starfall Vanguard</h1>
        <div class="btns">
          <label class="tog"><input id="togSound" type="checkbox" checked> Sound (synth)</label>
          <label class="tog"><input id="togShake" type="checkbox" checked> Screen shake</label>
          <button id="btnHow">–ö–∞–∫ —Å–µ –∏–≥—Ä–∞–µ</button>
          <button class="primary" id="btnStart">–°—Ç–∞—Ä—Ç</button>
        </div>
      </div>

      <p>
        –õ–µ—Ç–∏ –ø—Ä–µ–∑ –∞—Å—Ç–µ—Ä–æ–∏–¥–∏, –∏–∑–±—è–≥–≤–∞–π –æ—Ç–ª–æ–º–∫–∏ –∏ —Å–≤–∞–ª—è–π –∏–∑–≤—ä–Ω–∑–µ–º–Ω–∏ —Å –ª–∞–∑–µ—Ä–∏.
        –í–∑–µ–º–∞–π ‚≠ê Rapid (–ø–æ-–±—ä—Ä–∑–∞/–ø–æ-—à–∏—Ä–æ–∫–∞ —Å—Ç—Ä–µ–ª–±–∞) –∏ üõ°Ô∏è Shield.
      </p>

      <p class="tiny" id="status">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏‚Ä¶</p>
      <p class="tiny" id="how" style="display:none">
        ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <span class="kbd">WASD</span>/<span class="kbd">—Å—Ç—Ä–µ–ª–∫–∏</span><br/>
        ‚Ä¢ –°—Ç—Ä–µ–ª–±–∞: <span class="kbd">Space</span> (–∏–ª–∏ –∑–∞–¥—ä—Ä–∂–∞–Ω–µ –Ω–∞ –º–∏—à–∫–∞—Ç–∞/—Ç—ä—á)<br/>
        ‚Ä¢ –ü–∞—É–∑–∞: <span class="kbd">P</span> ‚Ä¢ –†–µ—Å—Ç–∞—Ä—Ç: <span class="kbd">R</span><br/>
        ‚Ä¢ –¢—ä—á/–º–∏—à–∫–∞: –º–µ—Å—Ç–∏—à –∫–æ—Ä–∞–±–∞ –∫—ä–º –∫—É—Ä—Å–æ—Ä–∞; –∑–∞–¥—ä—Ä–∂–∞–Ω–µ = —Å—Ç—Ä–µ–ª–±–∞
      </p>

      <p class="tiny">
        Assets: Kenney ‚ÄúSpace Shooter Redux‚Äù (CC0) –ø—Ä–µ–∑ jsDelivr. (–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –µ –Ω—É–∂–µ–Ω –∑–∞ –ø—ä—Ä–≤–æ—Ç–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ.)
      </p>
    </div>
  </div>

<script>
(() => {
  // ==============================
  // 1) –õ–∏–Ω–∫–æ–≤–µ –∫—ä–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ (CC0)
  // ==============================
  const BASE = "https://cdn.jsdelivr.net/gh/kefik/kenney@master/Shooter/";

  const ASSET_URLS = {
    ship:              BASE + "playerShip1_blue.png",
    enemy:             BASE + "enemies/enemyRed2.png",

    laser_player:      BASE + "lasers/laserBlue02.png",
    laser_enemy:       BASE + "lasers/laserRed02.png",

    meteor_big:        BASE + "meteors/meteorGrey_big2.png",
    meteor_med:        BASE + "meteors/meteorGrey_med1.png",
    meteor_small:      BASE + "meteors/meteorGrey_small1.png",

    pickup_star:       BASE + "powerups/powerupBlue_star.png",
    pickup_shield:     BASE + "powerups/powerupBlue_shield.png",

    fire00:            BASE + "effects/fire00.png",
    fire01:            BASE + "effects/fire01.png",
    fire02:            BASE + "effects/fire02.png",
    fire03:            BASE + "effects/fire03.png",
    fire04:            BASE + "effects/fire04.png",
    fire05:            BASE + "effects/fire05.png",
  };

  const Assets = { img: {} };

  function loadImage(url){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous"; // jsDelivr –ø–æ–¥–¥—ä—Ä–∂–∞ CORS
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error("–ù–µ —É—Å–ø—è—Ö –¥–∞ –∑–∞—Ä–µ–¥—è: " + url));
      img.src = url;
    });
  }

  async function loadAllImages(){
    const entries = Object.entries(ASSET_URLS);
    await Promise.all(entries.map(async ([k, url]) => {
      Assets.img[k] = await loadImage(url);
    }));
  }

  // ==============================
  // 2) Canvas / Viewport
  // ==============================
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha: false });

  const DESIGN_W = 960, DESIGN_H = 640;
  let DPR = 1;
  const view = { scale: 1, ox: 0, oy: 0 };

  function resize(){
    DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
    const cw = window.innerWidth, ch = window.innerHeight;
    canvas.width  = Math.floor(cw * DPR);
    canvas.height = Math.floor(ch * DPR);
    canvas.style.width = cw + "px";
    canvas.style.height = ch + "px";

    const sx = cw / DESIGN_W;
    const sy = ch / DESIGN_H;
    view.scale = Math.min(sx, sy);
    view.ox = (cw - DESIGN_W * view.scale) / 2;
    view.oy = (ch - DESIGN_H * view.scale) / 2;
  }
  window.addEventListener("resize", resize);

  function screenToWorld(px, py){
    return {
      x: (px - view.ox) / view.scale,
      y: (py - view.oy) / view.scale
    };
  }

  // ==============================
  // 3) –ú–∞–ª–∫–∏ –ø–æ–º–æ—â–Ω–∏
  // ==============================
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rand  = (a,b)=>a+Math.random()*(b-a);

  function withWorld(draw){
    ctx.save();
    ctx.setTransform(DPR,0,0,DPR,0,0);
    ctx.translate(view.ox, view.oy);
    ctx.scale(view.scale, view.scale);
    if (shakeOn && Game.shake > 0) ctx.translate(rand(-Game.shake, Game.shake), rand(-Game.shake, Game.shake));
    draw();
    ctx.restore();
  }

  function drawSprite(img, x, y, w, h, rot=0, alpha=1){
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(rot);
    ctx.globalAlpha = alpha;
    ctx.drawImage(img, -w/2, -h/2, w, h);
    ctx.restore();
  }

  function glowCircle(x,y,r,color,a){
    ctx.save();
    ctx.globalAlpha = a;
    const g = ctx.createRadialGradient(x,y,0,x,y,r);
    g.addColorStop(0, color);
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function hit(ax,ay,ar,bx,by,br){
    const dx = ax-bx, dy = ay-by;
    const rr = ar+br;
    return dx*dx + dy*dy <= rr*rr;
  }

  // ==============================
  // 4) Synth SFX (–±–µ–∑ –≤—ä–Ω—à–Ω–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤–µ)
  // ==============================
  let soundOn = true;
  let audioCtx = null;

  function ensureAudio(){
    if (!soundOn) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state !== "running") audioCtx.resume().catch(()=>{});
  }

  function sfxLaser(){
    if (!soundOn) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    o.type = "sawtooth";
    o.frequency.setValueAtTime(880, t0);
    o.frequency.exponentialRampToValueAtTime(1400, t0 + 0.06);

    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.18, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.09);

    o.connect(g).connect(audioCtx.destination);
    o.start(t0);
    o.stop(t0 + 0.10);
  }

  function sfxHit(){
    if (!soundOn) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(220, t0);
    o.frequency.exponentialRampToValueAtTime(90, t0 + 0.08);

    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.22, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.10);

    o.connect(g).connect(audioCtx.destination);
    o.start(t0);
    o.stop(t0 + 0.12);
  }

  function sfxBoom(){
    if (!soundOn) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;

    // —à—É–º (explosion)
    const bufferSize = Math.floor(audioCtx.sampleRate * 0.25);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i=0;i<bufferSize;i++){
      const x = i/bufferSize;
      data[i] = (Math.random()*2-1) * (1 - x) * (1 - x);
    }
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;

    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.40, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.25);

    src.connect(g).connect(audioCtx.destination);
    src.start(t0);
    src.stop(t0 + 0.26);
  }

  function sfxPower(){
    if (!soundOn) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "triangle";
    o.frequency.setValueAtTime(440, t0);
    o.frequency.exponentialRampToValueAtTime(880, t0 + 0.14);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.22, t0 + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.20);
    o.connect(g).connect(audioCtx.destination);
    o.start(t0); o.stop(t0 + 0.21);
  }

  function sfxLose(){
    if (!soundOn) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(220, t0);
    o.frequency.exponentialRampToValueAtTime(90, t0 + 0.40);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.25, t0 + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.45);
    o.connect(g).connect(audioCtx.destination);
    o.start(t0); o.stop(t0 + 0.46);
  }

  // ==============================
  // 5) UI / Input
  // ==============================
  const overlay = document.getElementById("overlay");
  const statusEl = document.getElementById("status");
  const howEl = document.getElementById("how");
  const hudEl = document.getElementById("hud");

  const hudScore = document.getElementById("hudScore");
  const hudLives = document.getElementById("hudLives");
  const hudWave  = document.getElementById("hudWave");
  const hudPower = document.getElementById("hudPower");

  document.getElementById("btnHow").addEventListener("click", () => {
    howEl.style.display = (howEl.style.display === "none" ? "block" : "none");
  });

  const togSound = document.getElementById("togSound");
  togSound.addEventListener("change", e => {
    soundOn = e.target.checked;
    if (soundOn) ensureAudio();
  });

  let shakeOn = true;
  document.getElementById("togShake").addEventListener("change", e => shakeOn = e.target.checked);

  const keys = new Set();
  window.addEventListener("keydown", (e) => {
    if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," ","Shift","p","P","r","R"].includes(e.key)) e.preventDefault();
    keys.add(e.key);
  });
  window.addEventListener("keyup", (e) => keys.delete(e.key));

  const pointer = { active:false, down:false, x:DESIGN_W/2, y:DESIGN_H*0.8 };
  window.addEventListener("pointerdown", (e)=>{
    const w = screenToWorld(e.clientX, e.clientY);
    pointer.active = true; pointer.down = true;
    pointer.x = w.x; pointer.y = w.y;
  });
  window.addEventListener("pointermove", (e)=>{
    if (!pointer.active) return;
    const w = screenToWorld(e.clientX, e.clientY);
    pointer.x = w.x; pointer.y = w.y;
  });
  window.addEventListener("pointerup", ()=> pointer.down = false);

  // ==============================
  // 6) Game state / Entities
  // ==============================
  const bullets=[], enemies=[], asteroids=[], particles=[], rings=[], pickups=[];

  const Game = {
    score:0, lives:3, wave:1, time:0,
    nextWaveAt:5, spawnAstAt:0.12, spawnEnemyAt:1.1,
    shake:0, flash:0,
    running:false, paused:false, gameOver:false
  };

  const ship = {
    x:DESIGN_W/2, y:DESIGN_H*0.78, vx:0, vy:0, r:18,
    fireCd:0, fireRate:0.14,
    rapidT:0, spreadT:0,
    shieldT:0, invulnT:0,
    flameT:0
  };

  function resetAll(){
    bullets.length=0; enemies.length=0; asteroids.length=0; particles.length=0; rings.length=0; pickups.length=0;
  }

  // ==============================
  // 7) FX
  // ==============================
  function explode(x,y, c1="rgba(255,170,70,0.9)", c2="rgba(103,179,255,0.8)", power=1){
    Game.flash = Math.min(1, Game.flash + 0.35*power);
    Game.shake = Math.min(18, Game.shake + 9*power);
    rings.push({x,y,r:10,v:520*power,life:0.45,a:0.55});
    const count = Math.floor(60*power);
    for (let i=0;i<count;i++){
      const ang = Math.random()*Math.PI*2;
      const sp = rand(80,520)*power;
      particles.push({
        x,y,
        vx: Math.cos(ang)*sp + rand(-40,40),
        vy: Math.sin(ang)*sp + rand(-40,40),
        life: rand(0.35,0.95),
        r: rand(1.5,4.5)*power,
        color: Math.random()<0.55 ? c1 : c2
      });
    }
  }

  function spark(x,y,n=16){
    for (let i=0;i<n;i++){
      const ang = Math.random()*Math.PI*2;
      const sp = rand(60,260);
      particles.push({x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:rand(0.18,0.42),r:rand(1.0,2.6),color:"rgba(255,255,255,0.85)"});
    }
  }

  // ==============================
  // 8) Spawns
  // ==============================
  function spawnAsteroid(size=2, x=rand(60,DESIGN_W-60), y=-80){
    const speed = rand(80,220) + Game.wave*6;
    const vx = rand(-45,45), vy = speed;
    const rot = rand(0,Math.PI*2), spin = rand(-1.6,1.6);
    const imgKey = size===2 ? "meteor_big" : (size===1 ? "meteor_med" : "meteor_small");
    const r = size===2?34:(size===1?24:16);
    asteroids.push({x,y,vx,vy,rot,spin,size,r,hp:size===2?4:(size===1?2:1),imgKey});
  }

  function spawnEnemy(){
    const x = rand(60,DESIGN_W-60), y = -70;
    const amp = rand(40,120), sp = rand(70,110) + Game.wave*4, phase = rand(0,Math.PI*2);
    enemies.push({x,y,vy:sp,r:22,hp:3+Math.floor(Game.wave*0.25),t:0,amp,phase,shootCd:rand(0.6,1.3)});
  }

  function spawnPickup(x,y,kind){
    pickups.push({x,y,vy:140,kind,t:0,r:18});
  }

  // ==============================
  // 9) Shooting
  // ==============================
  function fireLaser(fromEnemy=false, x=ship.x, y=ship.y, ang=-Math.PI/2, speed=900){
    bullets.push({x,y,vx:Math.cos(ang)*speed,vy:Math.sin(ang)*speed,fromEnemy,r:fromEnemy?10:9,life:2.2});
    sfxLaser();
  }

  function fireShip(){
    if (ship.fireCd>0) return;
    ship.fireCd = ship.fireRate;

    const triple = ship.spreadT > 0;

    if (!triple){
      fireLaser(false, ship.x, ship.y-24, -Math.PI/2, 980);
    } else {
      fireLaser(false, ship.x, ship.y-26, -Math.PI/2-0.12, 980);
      fireLaser(false, ship.x, ship.y-28, -Math.PI/2,       1020);
      fireLaser(false, ship.x, ship.y-26, -Math.PI/2+0.12, 980);
    }
    spark(ship.x, ship.y-34, 10);
  }

  function fireEnemy(e){
    const ang = Math.atan2(ship.y-e.y, ship.x-e.x);
    fireLaser(true, e.x, e.y+18, ang, 520 + Game.wave*8);
  }

  // ==============================
  // 10) Damage
  // ==============================
  function addScore(p){ Game.score += p; }

  function damageShip(){
    if (ship.invulnT>0) return;

    if (ship.shieldT>0){
      ship.shieldT = Math.max(0, ship.shieldT - 2.2);
      ship.invulnT = 0.9;
      sfxHit();
      spark(ship.x, ship.y, 26);
      Game.shake = Math.min(16, Game.shake + 8);
      return;
    }

    Game.lives -= 1;
    ship.invulnT = 1.6;
    explode(ship.x, ship.y, "rgba(255,107,135,0.9)", "rgba(255,209,102,0.8)", 1.0);
    sfxLose();

    if (Game.lives<=0){
      Game.gameOver = true;
      Game.running = false;
      overlay.style.display = "flex";
      overlay.querySelector("h1").textContent = "Game Over";
      overlay.querySelector("p").textContent = "–ù–∞—Ç–∏—Å–Ω–∏ R –∑–∞ —Ä–µ—Å—Ç–∞—Ä—Ç.";
      statusEl.style.display = "none";
      howEl.style.display = "none";
    }
  }

  // ==============================
  // 11) Update
  // ==============================
  function update(dt){
    Game.time += dt;

    if (keys.has("p") || keys.has("P")){ keys.delete("p"); keys.delete("P"); Game.paused = !Game.paused; }
    if (keys.has("r") || keys.has("R")){ keys.delete("r"); keys.delete("R"); startGame(true); return; }
    if (Game.paused) return;

    // Movement
    const ax = (keys.has("ArrowLeft")||keys.has("a")||keys.has("A")?-1:0) + (keys.has("ArrowRight")||keys.has("d")||keys.has("D")?1:0);
    const ay = (keys.has("ArrowUp")||keys.has("w")||keys.has("W")?-1:0) + (keys.has("ArrowDown")||keys.has("s")||keys.has("S")?1:0);
    const slow = keys.has("Shift") ? 0.55 : 1;

    if (pointer.active){
      const dx = pointer.x - ship.x, dy = pointer.y - ship.y;
      ship.vx += clamp(dx, -240, 240) * dt * 3.6;
      ship.vy += clamp(dy, -240, 240) * dt * 3.6;
      if (pointer.down) fireShip();
    }

    const accel = 900 * slow;
    ship.vx += ax * accel * dt;
    ship.vy += ay * accel * dt;

    const damp = Math.pow(0.0015, dt);
    ship.vx *= damp; ship.vy *= damp;

    ship.x += ship.vx*dt;
    ship.y += ship.vy*dt;

    ship.x = clamp(ship.x, 40, DESIGN_W-40);
    ship.y = clamp(ship.y, 60, DESIGN_H-40);

    // Timers
    ship.fireCd   = Math.max(0, ship.fireCd - dt);
    ship.rapidT   = Math.max(0, ship.rapidT - dt);
    ship.spreadT  = Math.max(0, ship.spreadT - dt);
    ship.shieldT  = Math.max(0, ship.shieldT - dt);
    ship.invulnT  = Math.max(0, ship.invulnT - dt);
    ship.flameT  += dt * 12;

    ship.fireRate = (ship.rapidT>0) ? 0.085 : 0.14;

    if (keys.has(" ")) fireShip();

    // Spawning
    Game.spawnAstAt -= dt;
    if (Game.spawnAstAt<=0){
      Game.spawnAstAt = rand(0.08,0.22)/(1+Game.wave*0.06);
      const s = Math.random()<0.55 ? 1 : 2;
      spawnAsteroid(s, rand(40,DESIGN_W-40), -100);
      if (Math.random()<0.18) spawnAsteroid(0, rand(40,DESIGN_W-40), -120);
    }

    Game.spawnEnemyAt -= dt;
    if (Game.spawnEnemyAt<=0){
      Game.spawnEnemyAt = rand(1.0,1.8)/(1+Game.wave*0.05);
      const burst = (Math.random()<0.25) ? 2 : 1;
      for (let i=0;i<burst;i++) spawnEnemy();
    }

    Game.nextWaveAt -= dt;
    if (Game.nextWaveAt<=0){
      Game.wave += 1;
      Game.nextWaveAt = 11 + Math.min(12, Game.wave*0.6);
      explode(DESIGN_W/2, 120, "rgba(103,179,255,0.85)", "rgba(255,209,102,0.85)", 0.8);
      sfxPower();
    }

    // Asteroids
    for (let i=asteroids.length-1;i>=0;i--){
      const a = asteroids[i];
      a.x += a.vx*dt; a.y += a.vy*dt; a.rot += a.spin*dt;
      if (a.x<-80) a.x=DESIGN_W+80;
      if (a.x>DESIGN_W+80) a.x=-80;
      if (a.y>DESIGN_H+120) asteroids.splice(i,1);

      if (!Game.gameOver && hit(a.x,a.y,a.r, ship.x,ship.y, ship.r)){
        explode(a.x,a.y,"rgba(255,170,70,0.9)","rgba(255,107,135,0.8)",0.9);
        sfxBoom();
        damageShip();
        a.vy *= -0.2;
        a.vx += rand(-120,120);
      }
    }

    // Enemies
    for (let i=enemies.length-1;i>=0;i--){
      const e = enemies[i];
      e.t += dt;
      e.y += e.vy*dt;
      e.x += Math.sin(e.t*1.4 + e.phase) * (e.amp*dt*0.9);
      e.x = clamp(e.x, 50, DESIGN_W-50);

      e.shootCd -= dt;
      if (e.shootCd<=0 && e.y>30 && e.y<DESIGN_H*0.78){
        e.shootCd = rand(0.7,1.35)/(1+Game.wave*0.04);
        fireEnemy(e);
      }

      if (!Game.gameOver && hit(e.x,e.y,e.r, ship.x,ship.y, ship.r)){
        explode(e.x,e.y,"rgba(103,179,255,0.85)","rgba(255,107,135,0.85)",1.2);
        sfxBoom();
        damageShip();
        e.hp = 0;
      }

      if (e.y>DESIGN_H+120) enemies.splice(i,1);
      else if (e.hp<=0){
        enemies.splice(i,1);
        addScore(90 + Game.wave*5);
        explode(e.x,e.y,"rgba(103,179,255,0.85)","rgba(255,209,102,0.85)",1.1);
        sfxBoom();
        const drop = Math.random();
        if (drop<0.14) spawnPickup(e.x,e.y,"rapid");
        else if (drop<0.22) spawnPickup(e.x,e.y,"shield");
      }
    }

    // Bullets
    for (let i=bullets.length-1;i>=0;i--){
      const b = bullets[i];
      b.x += b.vx*dt; b.y += b.vy*dt; b.life -= dt;
      if (b.life<=0 || b.y<-140 || b.y>DESIGN_H+140 || b.x<-200 || b.x>DESIGN_W+200){
        bullets.splice(i,1); continue;
      }

      if (b.fromEnemy){
        if (!Game.gameOver && hit(b.x,b.y,b.r, ship.x,ship.y, ship.r-2)){
          bullets.splice(i,1); spark(b.x,b.y,18); sfxHit(); damageShip();
        }
        continue;
      }

      // hit asteroid
      let did=false;
      for (let j=asteroids.length-1;j>=0 && !did;j--){
        const a = asteroids[j];
        if (hit(b.x,b.y,b.r, a.x,a.y,a.r-4)){
          bullets.splice(i,1);
          a.hp -= 1;
          spark(b.x,b.y,14);
          sfxHit();
          did=true;
          if (a.hp<=0){
            explode(a.x,a.y,"rgba(255,170,70,0.9)","rgba(103,179,255,0.7)",0.9);
            sfxBoom();
            addScore(20 + (2-a.size)*10);
            if (a.size===2){
              spawnAsteroid(1,a.x+rand(-10,10),a.y);
              spawnAsteroid(1,a.x+rand(-10,10),a.y);
            }else if (a.size===1){
              spawnAsteroid(0,a.x+rand(-10,10),a.y);
              if (Math.random()<0.7) spawnAsteroid(0,a.x+rand(-10,10),a.y);
            }
            asteroids.splice(j,1);
          }
        }
      }
      if (did) continue;

      // hit enemy
      for (let j=enemies.length-1;j>=0;j--){
        const e = enemies[j];
        if (hit(b.x,b.y,b.r, e.x,e.y,e.r-6)){
          bullets.splice(i,1);
          e.hp -= 1;
          spark(b.x,b.y,16);
          sfxHit();
          break;
        }
      }
    }

    // Pickups
    for (let i=pickups.length-1;i>=0;i--){
      const p = pickups[i];
      p.t += dt;
      p.y += p.vy*dt;
      p.x += Math.sin(p.t*4.2)*10*dt;

      if (p.y>DESIGN_H+80){ pickups.splice(i,1); continue; }

      if (hit(p.x,p.y,p.r, ship.x,ship.y, ship.r+4)){
        pickups.splice(i,1);
        sfxPower();
        explode(p.x,p.y,"rgba(53,211,159,0.85)","rgba(103,179,255,0.7)",0.65);
        if (p.kind==="rapid"){ ship.rapidT=6.0; ship.spreadT=Math.max(ship.spreadT, 6.0); }
        if (p.kind==="shield"){ ship.shieldT=Math.min(10, ship.shieldT + 6.0); }
        addScore(80);
      }
    }

    // Particles / rings
    for (let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx*dt; p.y += p.vy*dt;
      p.vx *= Math.pow(0.06, dt); p.vy *= Math.pow(0.06, dt);
      p.life -= dt;
      if (p.life<=0) particles.splice(i,1);
    }

    for (let i=rings.length-1;i>=0;i--){
      const r = rings[i];
      r.r += r.v*dt; r.a *= Math.pow(0.02, dt); r.life -= dt;
      if (r.life<=0) rings.splice(i,1);
    }

    Game.shake *= Math.pow(0.001, dt);
    Game.flash *= Math.pow(0.01, dt);

    // HUD
    hudScore.textContent = "Score: " + Game.score;
    hudLives.textContent = "Lives: " + Game.lives;
    hudWave.textContent  = "Wave: " + Game.wave;

    let ptxt = "‚Äî";
    if (ship.rapidT>0) ptxt = "‚≠ê Rapid (" + ship.rapidT.toFixed(0) + "s)";
    if (ship.shieldT>0) ptxt += (ptxt==="‚Äî" ? "" : " ‚Ä¢ ") + "üõ°Ô∏è Shield";
    hudPower.textContent = "Power: " + ptxt;
  }

  // ==============================
  // 12) Draw
  // ==============================
  function drawFrame(){
    withWorld(() => {
      // Background
      ctx.fillStyle = "#050713";
      ctx.fillRect(0,0,DESIGN_W,DESIGN_H);

      // Procedural star streaks (–≤–∏–∑—É–∞–ª–Ω–æ "stunning", –±–µ–∑ —Ñ–æ–Ω PNG)
      ctx.save();
      ctx.globalAlpha = 0.35;
      for (let i=0;i<130;i++){
        const x = (i*127.3 + (Game.time*60)) % DESIGN_W;
        const y = (i*67.7  + (Game.time*140)) % DESIGN_H;
        ctx.fillStyle = "rgba(255,255,255,0.75)";
        ctx.fillRect(x, y, 1.5, 7);
      }
      ctx.restore();

      // Rings
      ctx.save();
      ctx.globalCompositeOperation = "lighter";
      for (const r of rings){
        glowCircle(r.x,r.y,r.r*0.75,"rgba(255,255,255,0.35)",r.a*0.7);
        ctx.strokeStyle = "rgba(255,255,255," + (r.a*0.55) + ")";
        ctx.lineWidth = 2.5;
        ctx.beginPath(); ctx.arc(r.x,r.y,r.r,0,Math.PI*2); ctx.stroke();
      }
      ctx.restore();

      // Asteroids
      for (const a of asteroids){
        drawSprite(Assets.img[a.imgKey], a.x,a.y, a.r*2.2,a.r*2.2, a.rot, 1);
      }

      // Enemies
      for (const e of enemies){
        ctx.save(); ctx.globalCompositeOperation = "lighter";
        glowCircle(e.x,e.y,38,"rgba(103,179,255,0.35)",0.35);
        ctx.restore();
        drawSprite(Assets.img.enemy, e.x,e.y, 56,56, Math.sin(e.t*2.4)*0.06, 1);
      }

      // Pickups
      for (const p of pickups){
        const img = Assets.img[p.kind==="rapid" ? "pickup_star" : "pickup_shield"];
        ctx.save(); ctx.globalCompositeOperation = "lighter";
        glowCircle(p.x,p.y,36, p.kind==="rapid" ? "rgba(255,209,102,0.45)" : "rgba(103,179,255,0.45)", 0.45);
        ctx.restore();
        drawSprite(img, p.x,p.y, 44,44, Math.sin(p.t*5)*0.2, 1);
      }

      // Bullets
      for (const b of bullets){
        const img = Assets.img[b.fromEnemy ? "laser_enemy" : "laser_player"];
        const ang = Math.atan2(b.vy,b.vx) + Math.PI/2;
        ctx.save(); ctx.globalCompositeOperation = "lighter";
        glowCircle(b.x,b.y,22, b.fromEnemy ? "rgba(255,107,135,0.55)" : "rgba(103,179,255,0.55)", 0.5);
        ctx.restore();
        drawSprite(img, b.x,b.y, 18,46, ang, 1);
      }

      // Particles
      ctx.save();
      ctx.globalCompositeOperation = "lighter";
      for (const p of particles){
        const a = clamp(p.life/0.9, 0, 1);
        glowCircle(p.x,p.y,p.r*10,p.color,0.18*a);
        ctx.fillStyle = p.color;
        ctx.globalAlpha = 0.85*a;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r*2.2,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();

      // Ship
      const tilt = clamp(ship.vx*0.0006,-0.35,0.35);
      const invA = ship.invulnT>0 ? (Math.sin(Game.time*30)>0 ? 0.55 : 0.95) : 1.0;

      // Flame animation (0..5)
      const flameIdx = Math.floor(ship.flameT)%6;
      drawSprite(Assets.img["fire0" + flameIdx], ship.x, ship.y+30, 26,38, 0, 0.95*invA);

      // Shield glow
      if (ship.shieldT>0){
        ctx.save(); ctx.globalCompositeOperation="lighter";
        const pulse = 0.55 + 0.25*Math.sin(Game.time*6);
        glowCircle(ship.x,ship.y,46,"rgba(103,179,255,0.55)",0.45*pulse);
        ctx.strokeStyle="rgba(103,179,255,"+(0.35*pulse)+")";
        ctx.lineWidth=2.2;
        ctx.beginPath(); ctx.arc(ship.x,ship.y,38,0,Math.PI*2); ctx.stroke();
        ctx.restore();
      }

      drawSprite(Assets.img.ship, ship.x, ship.y, 64,64, tilt, invA);

      // Flash
      if (Game.flash>0.01){
        ctx.save();
        ctx.globalAlpha = Game.flash;
        ctx.fillStyle = "rgba(255,255,255,0.85)";
        ctx.fillRect(0,0,DESIGN_W,DESIGN_H);
        ctx.restore();
      }

      // Pause overlay
      if (Game.paused){
        ctx.save();
        ctx.fillStyle="rgba(0,0,0,0.45)";
        ctx.fillRect(0,0,DESIGN_W,DESIGN_H);
        ctx.fillStyle="rgba(255,255,255,0.92)";
        ctx.font="900 28px system-ui";
        ctx.textAlign="center";
        ctx.fillText("Paused", DESIGN_W/2, DESIGN_H/2 - 8);
        ctx.font="700 14px system-ui";
        ctx.fillText("Press P to resume", DESIGN_W/2, DESIGN_H/2 + 22);
        ctx.restore();
      }
    });
  }

  // ==============================
  // 13) Loop / Start
  // ==============================
  let lastT = 0;
  function loop(t){
    const sec = t/1000;
    const dt = Math.min(0.033, (sec - lastT) || 0.016);
    lastT = sec;
    if (Game.running && !Game.gameOver) update(dt);
    drawFrame();
    requestAnimationFrame(loop);
  }

  function startGame(){
    ensureAudio();

    Game.score=0; Game.lives=3; Game.wave=1; Game.time=0;
    Game.nextWaveAt=5.5; Game.spawnAstAt=0.12; Game.spawnEnemyAt=1.1;
    Game.shake=0; Game.flash=0;
    Game.gameOver=false; Game.paused=false; Game.running=true;

    ship.x=DESIGN_W/2; ship.y=DESIGN_H*0.78;
    ship.vx=0; ship.vy=0; ship.fireCd=0;
    ship.fireRate=0.14; ship.rapidT=0; ship.spreadT=0;
    ship.shieldT=1.2; ship.invulnT=1.2; ship.flameT=0;

    resetAll();
    for (let i=0;i<8;i++){
      spawnAsteroid(Math.random()<0.6?1:2, rand(40,DESIGN_W-40), rand(-DESIGN_H, DESIGN_H*0.6));
    }

    overlay.style.display = "none";
    hudEl.style.display = "flex";
    statusEl.style.display = "none";
    howEl.style.display = "none";
  }

  document.getElementById("btnStart").addEventListener("click", () => startGame());

  // ==============================
  // 14) Boot
  // ==============================
  resize();
  statusEl.textContent = "–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏‚Ä¶";
  loadAllImages()
    .then(() => {
      statusEl.textContent = "–ì–æ—Ç–æ–≤–æ! –ù–∞—Ç–∏—Å–Ω–∏ –°—Ç–∞—Ä—Ç.";
    })
    .catch(err => {
      console.error(err);
      statusEl.textContent = "–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ assets. –ü—Ä–æ–≤–µ—Ä–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ CORS –±–ª–æ–∫–∏—Ä–∞–Ω–µ.";
    });

  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
