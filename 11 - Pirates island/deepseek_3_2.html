<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pirate Island Defense</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(to bottom, #0a2a43, #163a5f);
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }

        /* UI Overlay */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .ui-container {
            pointer-events: all;
            padding: 20px;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
            border: 2px solid #d4af37;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
        }

        .resource-icon {
            width: 30px;
            height: 30px;
            background: gold;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .wave-info {
            text-align: center;
        }

        .wave-title {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .wave-number {
            font-size: 28px;
            color: #ffcc00;
            font-weight: bold;
        }

        .island-health {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-bar {
            width: 200px;
            height: 20px;
            background: rgba(255, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #fff;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(to right, #ff3333, #33ff33);
            width: 100%;
            transition: width 0.3s;
        }

        /* Ship Selection */
        .ship-selection {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            border: 2px solid #d4af37;
        }

        .ship-card {
            width: 120px;
            height: 150px;
            background: rgba(30, 60, 114, 0.8);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .ship-card:hover {
            transform: translateY(-5px);
            background: rgba(40, 80, 144, 0.9);
        }

        .ship-card.selected {
            border-color: #ffcc00;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.5);
        }

        .ship-icon {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .ship-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .ship-stats {
            font-size: 12px;
            color: #ccc;
            text-align: center;
        }

        .ship-key {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        /* Upgrade Panel */
        .upgrade-panel {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            min-width: 250px;
            border: 2px solid #d4af37;
            backdrop-filter: blur(5px);
            display: none;
        }

        .upgrade-panel.active {
            display: block;
        }

        .upgrade-title {
            text-align: center;
            font-size: 22px;
            color: #ffcc00;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #d4af37;
        }

        .upgrade-option {
            background: rgba(30, 60, 114, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .upgrade-option:hover {
            background: rgba(40, 80, 144, 0.9);
            border-color: #ffcc00;
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .upgrade-name {
            font-size: 16px;
            font-weight: bold;
        }

        .upgrade-cost {
            color: gold;
            font-weight: bold;
            font-size: 14px;
        }

        .upgrade-desc {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .upgrade-level {
            font-size: 12px;
            color: #aaa;
        }

        /* Game Messages */
        .game-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 50px;
            border-radius: 15px;
            text-align: center;
            border: 3px solid #d4af37;
            display: none;
            z-index: 100;
        }

        .game-message.active {
            display: block;
        }

        .message-title {
            font-size: 36px;
            color: #ffcc00;
            margin-bottom: 20px;
        }

        .message-text {
            font-size: 18px;
            margin-bottom: 25px;
        }

        .message-button {
            background: linear-gradient(to bottom, #d4af37, #b8941f);
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            color: #000;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .message-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.7);
        }

        /* Controls Info */
        .controls-info {
            position: absolute;
            bottom: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 300px;
            border: 1px solid #666;
        }

        .controls-title {
            color: #ffcc00;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .ship-card {
                width: 100px;
                height: 130px;
                padding: 10px;
            }
            
            .ship-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .upgrade-panel {
                right: 10px;
                min-width: 220px;
            }
        }
    </style>
</head>
<body>
    <!-- Game Canvas -->
    <canvas id="renderCanvas"></canvas>

    <!-- UI Overlay -->
    <div class="ui-overlay">
        <!-- Top Bar -->
        <div class="ui-container">
            <div class="top-bar">
                <div class="resource">
                    <div class="resource-icon">ðŸ’°</div>
                    <div id="goldValue">100</div>
                </div>
                
                <div class="wave-info">
                    <div class="wave-title">WAVE</div>
                    <div id="waveNumber" class="wave-number">1</div>
                </div>
                
                <div class="island-health">
                    <div>Island Health:</div>
                    <div class="health-bar">
                        <div id="healthFill" class="health-fill" style="width: 100%"></div>
                    </div>
                    <div id="healthValue">100/100</div>
                </div>
            </div>
        </div>

        <!-- Ship Selection -->
        <div class="ship-selection">
            <div class="ship-card" id="ship1" data-ship="0">
                <div class="ship-key">1</div>
                <div class="ship-icon">âš“</div>
                <div class="ship-name">Sea Wolf</div>
                <div class="ship-stats" id="ship1Stats">DMG: 10<br>SPD: 5</div>
            </div>
            
            <div class="ship-card" id="ship2" data-ship="1">
                <div class="ship-key">2</div>
                <div class="ship-icon">âš“</div>
                <div class="ship-name">Golden Tide</div>
                <div class="ship-stats" id="ship2Stats">DMG: 10<br>SPD: 5</div>
            </div>
            
            <div class="ship-card" id="ship3" data-ship="2">
                <div class="ship-key">3</div>
                <div class="ship-icon">âš“</div>
                <div class="ship-name">Crimson Sail</div>
                <div class="ship-stats" id="ship3Stats">DMG: 10<br>SPD: 5</div>
            </div>
        </div>

        <!-- Upgrade Panel -->
        <div class="upgrade-panel" id="upgradePanel">
            <div class="upgrade-title">SHIP UPGRADES</div>
            
            <div class="upgrade-option" data-upgrade="damage">
                <div class="upgrade-header">
                    <div class="upgrade-name">Cannon Damage</div>
                    <div class="upgrade-cost">50g</div>
                </div>
                <div class="upgrade-desc">Increase cannon damage by 5</div>
                <div class="upgrade-level">Level: <span id="damageLevel">1</span></div>
            </div>
            
            <div class="upgrade-option" data-upgrade="firerate">
                <div class="upgrade-header">
                    <div class="upgrade-name">Fire Rate</div>
                    <div class="upgrade-cost">40g</div>
                </div>
                <div class="upgrade-desc">Increase firing speed by 20%</div>
                <div class="upgrade-level">Level: <span id="firerateLevel">1</span></div>
            </div>
            
            <div class="upgrade-option" data-upgrade="speed">
                <div class="upgrade-header">
                    <div class="upgrade-name">Ship Speed</div>
                    <div class="upgrade-cost">30g</div>
                </div>
                <div class="upgrade-desc">Increase movement speed by 15%</div>
                <div class="upgrade-level">Level: <span id="speedLevel">1</span></div>
            </div>
        </div>

        <!-- Controls Info -->
        <div class="controls-info">
            <div class="controls-title">CONTROLS</div>
            <div class="control-item">
                <span>Select Ship 1-3:</span>
                <span>1, 2, 3</span>
            </div>
            <div class="control-item">
                <span>Move Selected Ship:</span>
                <span>WASD / Click</span>
            </div>
            <div class="control-item">
                <span>Camera Orbit:</span>
                <span>Mouse Drag</span>
            </div>
            <div class="control-item">
                <span>Camera Zoom:</span>
                <span>Mouse Wheel</span>
            </div>
            <div class="control-item">
                <span>Upgrade Panel:</span>
                <span>U Key</span>
            </div>
        </div>

        <!-- Game Messages -->
        <div class="game-message" id="waveCompleteMessage">
            <div class="message-title">WAVE COMPLETE!</div>
            <div class="message-text">Enemies defeated! Upgrade your ships before the next wave.</div>
            <button class="message-button" id="nextWaveButton">START NEXT WAVE</button>
        </div>
        
        <div class="game-message" id="gameOverMessage">
            <div class="message-title">GAME OVER</div>
            <div class="message-text">The island has been destroyed!</div>
            <button class="message-button" id="restartButton">RESTART GAME</button>
        </div>
    </div>

    <script>
        // Game Variables
        let game = {
            gold: 100,
            wave: 1,
            islandHealth: 100,
            maxIslandHealth: 100,
            selectedShip: 0,
            gameState: 'playing', // playing, waveComplete, gameOver
            enemies: [],
            enemySpawnTimer: 0,
            enemySpawnInterval: 3000, // ms
            enemiesPerWave: 5,
            enemiesDefeated: 0
        };

        // Ship Data
        let ships = [
            {
                name: "Sea Wolf",
                mesh: null,
                position: { x: -15, z: -15 },
                damage: 10,
                firerate: 1, // shots per second
                speed: 5,
                damageLevel: 1,
                firerateLevel: 1,
                speedLevel: 1,
                target: null,
                lastShot: 0,
                health: 100
            },
            {
                name: "Golden Tide",
                mesh: null,
                position: { x: 0, z: -20 },
                damage: 10,
                firerate: 1,
                speed: 5,
                damageLevel: 1,
                firerateLevel: 1,
                speedLevel: 1,
                target: null,
                lastShot: 0,
                health: 100
            },
            {
                name: "Crimson Sail",
                mesh: null,
                position: { x: 15, z: -15 },
                damage: 10,
                firerate: 1,
                speed: 5,
                damageLevel: 1,
                firerateLevel: 1,
                speedLevel: 1,
                target: null,
                lastShot: 0,
                health: 100
            }
        ];

        // Upgrade Costs
        let upgradeCosts = {
            damage: 50,
            firerate: 40,
            speed: 30
        };

        // Babylon.js Variables
        let canvas, engine, scene, camera, light;
        let water, island, skybox;
        let cannonballMaterial, enemyMaterial, shipMaterials = [];

        // Initialize Babylon.js
        const initEngine = () => {
            canvas = document.getElementById('renderCanvas');
            engine = new BABYLON.Engine(canvas, true);
            scene = new BABYLON.Scene(engine);
            
            // Camera
            camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 3, 80, 
                new BABYLON.Vector3(0, 0, 0), scene);
            camera.attachControl(canvas, true);
            camera.lowerRadiusLimit = 30;
            camera.upperRadiusLimit = 150;
            camera.wheelPrecision = 50;
            
            // Light
            light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.8;
            
            // Add directional light for shadows
            const sun = new BABYLON.DirectionalLight("sun", new BABYLON.Vector3(-1, -2, -1), scene);
            sun.position = new BABYLON.Vector3(20, 40, 20);
            sun.intensity = 0.6;
            
            // Create ocean water
            createWater();
            
            // Create island
            createIsland();
            
            // Create ships
            createShips();
            
            // Create skybox
            createSkybox();
            
            // Create materials
            createMaterials();
            
            // Setup event handlers
            setupEventHandlers();
            
            // Start game loop
            scene.onBeforeRenderObservable.add(gameLoop);
            
            // Render loop
            engine.runRenderLoop(() => {
                scene.render();
            });
            
            // Handle resize
            window.addEventListener('resize', () => {
                engine.resize();
            });
        };

        // Create ocean water
        const createWater = () => {
            // Water material
            const waterMaterial = new BABYLON.StandardMaterial("waterMat", scene);
            waterMaterial.diffuseColor = new BABYLON.Color3(0.1, 0.3, 0.6);
            waterMaterial.alpha = 0.8;
            waterMaterial.specularPower = 64;
            
            // Create water plane
            water = BABYLON.MeshBuilder.CreateGround("water", { width: 200, height: 200 }, scene);
            water.material = waterMaterial;
            water.position.y = -0.5;
            
            // Add waves with a shader material for simple animation
            scene.registerBeforeRender(() => {
                water.rotation.x = Math.sin(Date.now() * 0.001) * 0.01;
                water.rotation.z = Math.cos(Date.now() * 0.001) * 0.01;
            });
        };

        // Create island
        const createIsland = () => {
            // Island base
            island = BABYLON.MeshBuilder.CreateCylinder("island", { 
                diameter: 20, 
                height: 3 
            }, scene);
            
            const islandMat = new BABYLON.StandardMaterial("islandMat", scene);
            islandMat.diffuseColor = new BABYLON.Color3(0.2, 0.6, 0.2);
            islandMat.specularColor = new BABYLON.Color3(0.1, 0.1, 0.1);
            island.material = islandMat;
            island.position.y = 1.5;
            
            // Island top (grassy area)
            const islandTop = BABYLON.MeshBuilder.CreateCylinder("islandTop", { 
                diameter: 18, 
                height: 1 
            }, scene);
            
            const topMat = new BABYLON.StandardMaterial("topMat", scene);
            topMat.diffuseColor = new BABYLON.Color3(0.3, 0.8, 0.3);
            islandTop.material = topMat;
            islandTop.position.y = 3;
            
            // Add palm trees
            for (let i = 0; i < 5; i++) {
                createPalmTree(
                    Math.cos(i * Math.PI * 0.4) * 7,
                    Math.sin(i * Math.PI * 0.4) * 7
                );
            }
            
            // Add rocks around the island
            for (let i = 0; i < 8; i++) {
                createRock(
                    Math.cos(i * Math.PI * 0.25) * 12,
                    Math.sin(i * Math.PI * 0.25) * 12
                );
            }
        };

        // Create a palm tree
        const createPalmTree = (x, z) => {
            // Trunk
            const trunk = BABYLON.MeshBuilder.CreateCylinder("trunk", { 
                diameter: 0.5, 
                height: 4 
            }, scene);
            
            const trunkMat = new BABYLON.StandardMaterial("trunkMat", scene);
            trunkMat.diffuseColor = new BABYLON.Color3(0.4, 0.3, 0.2);
            trunk.material = trunkMat;
            trunk.position.set(x, 3.5, z);
            
            // Leaves
            for (let i = 0; i < 6; i++) {
                const angle = (i / 6) * Math.PI * 2;
                const leaf = BABYLON.MeshBuilder.CreateCylinder("leaf", { 
                    diameterBottom: 0.1, 
                    diameterTop: 0, 
                    height: 3 
                }, scene);
                
                const leafMat = new BABYLON.StandardMaterial("leafMat", scene);
                leafMat.diffuseColor = new BABYLON.Color3(0.1, 0.5, 0.1);
                leaf.material = leafMat;
                
                leaf.position.set(
                    x + Math.cos(angle) * 0.5,
                    6,
                    z + Math.sin(angle) * 0.5
                );
                
                leaf.rotation.x = Math.PI / 2;
                leaf.rotation.z = angle;
            }
        };

        // Create a rock
        const createRock = (x, z) => {
            const rock = BABYLON.MeshBuilder.CreateSphere("rock", { 
                diameter: 1 + Math.random() * 2 
            }, scene);
            
            const rockMat = new BABYLON.StandardMaterial("rockMat", scene);
            rockMat.diffuseColor = new BABYLON.Color3(0.3, 0.3, 0.3);
            rock.material = rockMat;
            
            rock.position.set(x, 0.5 + Math.random(), z);
            rock.scaling.y = 0.5 + Math.random() * 0.5;
        };

        // Create pirate ships
        const createShips = () => {
            const shipColors = [
                new BABYLON.Color3(0.6, 0.4, 0.2), // Brown
                new BABYLON.Color3(0.9, 0.8, 0.1), // Gold
                new BABYLON.Color3(0.8, 0.2, 0.2)  // Red
            ];
            
            ships.forEach((shipData, index) => {
                // Ship hull
                const hull = BABYLON.MeshBuilder.CreateBox("hull" + index, { 
                    width: 4, 
                    height: 2, 
                    depth: 8 
                }, scene);
                
                // Ship mast
                const mast = BABYLON.MeshBuilder.CreateCylinder("mast" + index, { 
                    diameter: 0.3, 
                    height: 6 
                }, scene);
                
                // Sail
                const sail = BABYLON.MeshBuilder.CreateBox("sail" + index, { 
                    width: 0.1, 
                    height: 4, 
                    depth: 3 
                }, scene);
                
                // Create ship parent container
                const ship = new BABYLON.Mesh("ship" + index, scene);
                hull.parent = ship;
                mast.parent = ship;
                sail.parent = ship;
                
                // Position components
                hull.position.y = 1;
                mast.position.y = 4;
                sail.position.y = 4;
                sail.position.z = 0.5;
                
                // Create materials
                const hullMat = new BABYLON.StandardMaterial("hullMat" + index, scene);
                hullMat.diffuseColor = shipColors[index];
                hull.material = hullMat;
                
                const mastMat = new BABYLON.StandardMaterial("mastMat" + index, scene);
                mastMat.diffuseColor = new BABYLON.Color3(0.5, 0.4, 0.3);
                mast.material = mastMat;
                
                const sailMat = new BABYLON.StandardMaterial("sailMat" + index, scene);
                sailMat.diffuseColor = new BABYLON.Color3(0.95, 0.95, 0.9);
                sail.material = sailMat;
                
                // Position ship
                ship.position.set(shipData.position.x, 0, shipData.position.z);
                ship.rotation.y = Math.PI / 2;
                
                // Store reference
                shipData.mesh = ship;
                shipMaterials.push(hullMat);
                
                // Add ship selection indicator
                const indicator = BABYLON.MeshBuilder.CreateSphere("indicator" + index, { 
                    diameter: 6,
                    segments: 16
                }, scene);
                
                indicator.parent = ship;
                indicator.position.y = 0.5;
                
                const indicatorMat = new BABYLON.StandardMaterial("indicatorMat" + index, scene);
                indicatorMat.diffuseColor = new BABYLON.Color3(1, 1, 0);
                indicatorMat.alpha = 0.3;
                indicator.material = indicatorMat;
                indicator.isVisible = false;
                
                shipData.indicator = indicator;
            });
            
            // Select first ship by default
            selectShip(0);
        };

        // Create materials
        const createMaterials = () => {
            // Cannonball material
            cannonballMaterial = new BABYLON.StandardMaterial("cannonballMat", scene);
            cannonballMaterial.diffuseColor = new BABYLON.Color3(0.1, 0.1, 0.1);
            cannonballMaterial.specularColor = new BABYLON.Color3(0.2, 0.2, 0.2);
            
            // Enemy ship material
            enemyMaterial = new BABYLON.StandardMaterial("enemyMat", scene);
            enemyMaterial.diffuseColor = new BABYLON.Color3(0.8, 0.1, 0.1);
        };

        // Create skybox
        const createSkybox = () => {
            const skybox = BABYLON.MeshBuilder.CreateBox("skyBox", { size: 1000 }, scene);
            const skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture(
                "https://assets.babylonjs.com/textures/skybox/TropicalSunnyDay", scene
            );
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skybox.material = skyboxMaterial;
        };

        // Setup event handlers
        const setupEventHandlers = () => {
            // Ship selection
            document.querySelectorAll('.ship-card').forEach(card => {
                card.addEventListener('click', () => {
                    const shipIndex = parseInt(card.getAttribute('data-ship'));
                    selectShip(shipIndex);
                });
            });
            
            // Upgrade options
            document.querySelectorAll('.upgrade-option').forEach(option => {
                option.addEventListener('click', () => {
                    const upgradeType = option.getAttribute('data-upgrade');
                    purchaseUpgrade(upgradeType);
                });
            });
            
            // Next wave button
            document.getElementById('nextWaveButton').addEventListener('click', startNextWave);
            
            // Restart button
            document.getElementById('restartButton').addEventListener('click', restartGame);
            
            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                // Ship selection (1-3)
                if (e.key >= '1' && e.key <= '3') {
                    const shipIndex = parseInt(e.key) - 1;
                    selectShip(shipIndex);
                }
                
                // Upgrade panel toggle
                if (e.key === 'u' || e.key === 'U') {
                    toggleUpgradePanel();
                }
                
                // Ship movement (WASD)
                if (game.gameState === 'playing') {
                    const ship = ships[game.selectedShip];
                    const speed = ship.speed * 0.1;
                    
                    switch (e.key.toLowerCase()) {
                        case 'w':
                            ship.mesh.position.z -= speed;
                            break;
                        case 's':
                            ship.mesh.position.z += speed;
                            break;
                        case 'a':
                            ship.mesh.position.x -= speed;
                            break;
                        case 'd':
                            ship.mesh.position.x += speed;
                            break;
                    }
                    
                    // Keep ships within bounds
                    const maxDistance = 60;
                    const distance = Math.sqrt(
                        ship.mesh.position.x * ship.mesh.position.x + 
                        ship.mesh.position.z * ship.mesh.position.z
                    );
                    
                    if (distance > maxDistance) {
                        const scale = maxDistance / distance;
                        ship.mesh.position.x *= scale;
                        ship.mesh.position.z *= scale;
                    }
                }
            });
            
            // Mouse click to move selected ship
            canvas.addEventListener('click', (e) => {
                if (game.gameState !== 'playing') return;
                
                // Raycast to ground plane
                const pickInfo = scene.pick(
                    e.clientX / window.innerWidth * canvas.width,
                    e.clientY / window.innerHeight * canvas.height,
                    (mesh) => mesh === water
                );
                
                if (pickInfo.hit) {
                    const ship = ships[game.selectedShip];
                    const targetPos = pickInfo.pickedPoint;
                    
                    // Animate ship movement
                    const distance = BABYLON.Vector3.Distance(
                        ship.mesh.position,
                        new BABYLON.Vector3(targetPos.x, 0, targetPos.z)
                    );
                    
                    const duration = distance / (ship.speed * 0.05);
                    
                    new BABYLON.Animation(
                        "shipMove", "position", 30,
                        BABYLON.Animation.ANIMATIONTYPE_VECTOR3,
                        BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT
                    );
                    
                    const keys = [
                        { frame: 0, value: ship.mesh.position.clone() },
                        { frame: duration, value: new BABYLON.Vector3(targetPos.x, 0, targetPos.z) }
                    ];
                    
                    const anim = new BABYLON.Animation("shipMove", "position", 30, 
                        BABYLON.Animation.ANIMATIONTYPE_VECTOR3);
                    anim.setKeys(keys);
                    
                    ship.mesh.animations = [anim];
                    scene.beginAnimation(ship.mesh, 0, duration, false);
                }
            });
        };

        // Select a ship
        const selectShip = (index) => {
            game.selectedShip = index;
            
            // Update UI
            document.querySelectorAll('.ship-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`ship${index + 1}`).classList.add('selected');
            
            // Update ship indicators
            ships.forEach((ship, i) => {
                ship.indicator.isVisible = (i === index);
            });
            
            // Focus camera on selected ship
            const shipPos = ships[index].mesh.position;
            camera.setTarget(new BABYLON.Vector3(shipPos.x, 0, shipPos.z));
        };

        // Game loop
        const gameLoop = () => {
            if (game.gameState !== 'playing') return;
            
            const currentTime = Date.now();
            
            // Spawn enemies
            game.enemySpawnTimer += engine.getDeltaTime();
            if (game.enemySpawnTimer >= game.enemySpawnInterval && 
                game.enemies.length < game.enemiesPerWave) {
                spawnEnemy();
                game.enemySpawnTimer = 0;
            }
            
            // Update ships
            ships.forEach(ship => {
                // Find closest enemy for auto-targeting
                let closestEnemy = null;
                let closestDistance = Infinity;
                
                game.enemies.forEach(enemy => {
                    const distance = BABYLON.Vector3.Distance(
                        ship.mesh.position,
                        enemy.mesh.position
                    );
                    
                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestEnemy = enemy;
                    }
                });
                
                // Auto-fire at enemies in range
                if (closestEnemy && closestDistance < 40) {
                    ship.target = closestEnemy;
                    
                    // Check if ready to fire
                    if (currentTime - ship.lastShot > 1000 / ship.firerate) {
                        fireCannonball(ship, closestEnemy);
                        ship.lastShot = currentTime;
                    }
                } else {
                    ship.target = null;
                }
            });
            
            // Update enemies
            for (let i = game.enemies.length - 1; i >= 0; i--) {
                const enemy = game.enemies[i];
                
                // Move toward island
                const direction = new BABYLON.Vector3(
                    -enemy.mesh.position.x,
                    0,
                    -enemy.mesh.position.z
                ).normalize();
                
                enemy.mesh.position.addInPlace(direction.scale(0.05));
                
                // Check if enemy reached island
                const distanceToIsland = BABYLON.Vector3.Distance(
                    enemy.mesh.position,
                    BABYLON.Vector3.Zero()
                );
                
                if (distanceToIsland < 15) {
                    // Damage island
                    game.islandHealth -= 5;
                    updateUI();
                    
                    // Remove enemy
                    enemy.mesh.dispose();
                    game.enemies.splice(i, 1);
                    
                    // Check game over
                    if (game.islandHealth <= 0) {
                        game.islandHealth = 0;
                        gameOver();
                    }
                }
            }
            
            // Check wave completion
            if (game.enemiesDefeated >= game.enemiesPerWave && game.enemies.length === 0) {
                completeWave();
            }
        };

        // Spawn an enemy ship
        const spawnEnemy = () => {
            // Random position on horizon
            const angle = Math.random() * Math.PI * 2;
            const distance = 80 + Math.random() * 20;
            const x = Math.cos(angle) * distance;
            const z = Math.sin(angle) * distance;
            
            // Create enemy ship
            const hull = BABYLON.MeshBuilder.CreateBox("enemyHull", { 
                width: 3, 
                height: 1.5, 
                depth: 6 
            }, scene);
            
            const mast = BABYLON.MeshBuilder.CreateCylinder("enemyMast", { 
                diameter: 0.2, 
                height: 5 
            }, scene);
            
            const sail = BABYLON.MeshBuilder.CreateBox("enemySail", { 
                width: 0.1, 
                height: 3, 
                depth: 2 
            }, scene);
            
            // Create enemy parent container
            const enemy = new BABYLON.Mesh("enemy", scene);
            hull.parent = enemy;
            mast.parent = enemy;
            sail.parent = enemy;
            
            // Position components
            hull.position.y = 0.75;
            mast.position.y = 3;
            sail.position.y = 3;
            sail.position.z = 0.5;
            
            // Apply materials
            hull.material = enemyMaterial;
            
            const mastMat = new BABYLON.StandardMaterial("enemyMastMat", scene);
            mastMat.diffuseColor = new BABYLON.Color3(0.3, 0.2, 0.1);
            mast.material = mastMat;
            
            const sailMat = new BABYLON.StandardMaterial("enemySailMat", scene);
            sailMat.diffuseColor = new BABYLON.Color3(0.2, 0.2, 0.2);
            sail.material = sailMat;
            
            // Position enemy
            enemy.position.set(x, 0, z);
            enemy.rotation.y = Math.atan2(-x, -z);
            
            // Store enemy data
            const enemyData = {
                mesh: enemy,
                health: 20 + game.wave * 5,
                speed: 1 + game.wave * 0.1
            };
            
            game.enemies.push(enemyData);
        };

        // Fire a cannonball from ship to target
        const fireCannonball = (ship, target) => {
            // Create cannonball
            const cannonball = BABYLON.MeshBuilder.CreateSphere("cannonball", { 
                diameter: 0.5 
            }, scene);
            
            cannonball.material = cannonballMaterial;
            cannonball.position = ship.mesh.position.clone();
            cannonball.position.y = 2;
            
            // Calculate trajectory
            const targetPos = target.mesh.position.clone();
            targetPos.y = 2;
            
            // Animate cannonball
            const distance = BABYLON.Vector3.Distance(
                cannonball.position,
                targetPos
            );
            
            const duration = distance * 5;
            
            // Create animation
            const anim = new BABYLON.Animation(
                "cannonballAnim", "position", 30,
                BABYLON.Animation.ANIMATIONTYPE_VECTOR3,
                BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT
            );
            
            const keys = [
                { frame: 0, value: cannonball.position.clone() },
                { frame: duration, value: targetPos }
            ];
            
            anim.setKeys(keys);
            cannonball.animations = [anim];
            
            scene.beginAnimation(cannonball, 0, duration, false, 1, () => {
                // Hit target
                cannonball.dispose();
                
                // Find enemy index
                const enemyIndex = game.enemies.findIndex(e => e === target);
                if (enemyIndex !== -1) {
                    // Damage enemy
                    target.health -= ship.damage;
                    
                    if (target.health <= 0) {
                        // Enemy defeated
                        target.mesh.dispose();
                        game.enemies.splice(enemyIndex, 1);
                        game.enemiesDefeated++;
                        game.gold += 10 + game.wave * 2;
                        updateUI();
                        
                        // Show gold particles
                        showGoldParticles(target.mesh.position);
                    }
                }
            });
            
            // Add smoke trail effect
            const particleSystem = new BABYLON.ParticleSystem("particles", 20, scene);
            particleSystem.particleTexture = new BABYLON.Texture("https://www.babylonjs-playground.com/textures/flare.png", scene);
            particleSystem.emitter = cannonball;
            particleSystem.minSize = 0.1;
            particleSystem.maxSize = 0.3;
            particleSystem.minLifeTime = 0.3;
            particleSystem.maxLifeTime = 0.5;
            particleSystem.emitRate = 20;
            particleSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE;
            particleSystem.gravity = new BABYLON.Vector3(0, -9.81, 0);
            particleSystem.direction1 = new BABYLON.Vector3(-0.5, -0.5, -0.5);
            particleSystem.direction2 = new BABYLON.Vector3(0.5, 0.5, 0.5);
            particleSystem.minAngularSpeed = 0;
            particleSystem.maxAngularSpeed = Math.PI;
            particleSystem.start();
            
            // Stop particles after animation
            setTimeout(() => {
                particleSystem.stop();
                setTimeout(() => particleSystem.dispose(), 1000);
            }, duration * 15); // Convert frames to ms
        };

        // Show gold particles
        const showGoldParticles = (position) => {
            const particleSystem = new BABYLON.ParticleSystem("goldParticles", 100, scene);
            particleSystem.particleTexture = new BABYLON.Texture("https://www.babylonjs-playground.com/textures/flare.png", scene);
            particleSystem.emitter = position.clone();
            particleSystem.emitter.y = 5;
            particleSystem.minSize = 0.1;
            particleSystem.maxSize = 0.3;
            particleSystem.minLifeTime = 0.5;
            particleSystem.maxLifeTime = 1.5;
            particleSystem.emitRate = 100;
            particleSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE;
            particleSystem.minEmitPower = 1;
            particleSystem.maxEmitPower = 3;
            particleSystem.updateSpeed = 0.01;
            particleSystem.gravity = new BABYLON.Vector3(0, -9.81, 0);
            particleSystem.direction1 = new BABYLON.Vector3(-1, 1, -1);
            particleSystem.direction2 = new BABYLON.Vector3(1, 2, 1);
            particleSystem.minAngularSpeed = 0;
            particleSystem.maxAngularSpeed = Math.PI;
            particleSystem.color1 = new BABYLON.Color4(1, 0.8, 0, 1);
            particleSystem.color2 = new BABYLON.Color4(1, 1, 0, 1);
            particleSystem.start();
            
            setTimeout(() => {
                particleSystem.stop();
                setTimeout(() => particleSystem.dispose(), 2000);
            }, 300);
        };

        // Complete current wave
        const completeWave = () => {
            game.gameState = 'waveComplete';
            document.getElementById('waveCompleteMessage').classList.add('active');
            
            // Reward gold
            game.gold += 50 + game.wave * 10;
            updateUI();
        };

        // Start next wave
        const startNextWave = () => {
            game.wave++;
            game.enemiesDefeated = 0;
            game.enemiesPerWave = 5 + game.wave * 2;
            game.enemySpawnInterval = Math.max(1000, 3000 - game.wave * 200);
            game.gameState = 'playing';
            
            document.getElementById('waveCompleteMessage').classList.remove('active');
            updateUI();
        };

        // Game over
        const gameOver = () => {
            game.gameState = 'gameOver';
            document.getElementById('gameOverMessage').classList.add('active');
        };

        // Restart game
        const restartGame = () => {
            // Reset game state
            game = {
                gold: 100,
                wave: 1,
                islandHealth: 100,
                maxIslandHealth: 100,
                selectedShip: 0,
                gameState: 'playing',
                enemies: [],
                enemySpawnTimer: 0,
                enemySpawnInterval: 3000,
                enemiesPerWave: 5,
                enemiesDefeated: 0
            };
            
            // Reset ships
            ships.forEach((ship, index) => {
                ship.damage = 10;
                ship.firerate = 1;
                ship.speed = 5;
                ship.damageLevel = 1;
                ship.firerateLevel = 1;
                ship.speedLevel = 1;
                ship.health = 100;
                
                // Reset position
                ship.mesh.position.set(ship.position.x, 0, ship.position.z);
            });
            
            // Clear enemies
            game.enemies.forEach(enemy => enemy.mesh.dispose());
            game.enemies = [];
            
            // Update UI
            updateUI();
            
            // Hide game over message
            document.getElementById('gameOverMessage').classList.remove('active');
            
            // Select first ship
            selectShip(0);
        };

        // Toggle upgrade panel
        const toggleUpgradePanel = () => {
            const panel = document.getElementById('upgradePanel');
            panel.classList.toggle('active');
        };

        // Purchase upgrade
        const purchaseUpgrade = (type) => {
            const ship = ships[game.selectedShip];
            const cost = upgradeCosts[type];
            
            if (game.gold >= cost) {
                game.gold -= cost;
                
                switch (type) {
                    case 'damage':
                        ship.damage += 5;
                        ship.damageLevel++;
                        document.getElementById('damageLevel').textContent = ship.damageLevel;
                        upgradeCosts.damage = Math.floor(upgradeCosts.damage * 1.5);
                        break;
                        
                    case 'firerate':
                        ship.firerate *= 1.2;
                        ship.firerateLevel++;
                        document.getElementById('firerateLevel').textContent = ship.firerateLevel;
                        upgradeCosts.firerate = Math.floor(upgradeCosts.firerate * 1.5);
                        break;
                        
                    case 'speed':
                        ship.speed *= 1.15;
                        ship.speedLevel++;
                        document.getElementById('speedLevel').textContent = ship.speedLevel;
                        upgradeCosts.speed = Math.floor(upgradeCosts.speed * 1.5);
                        break;
                }
                
                // Update UI
                updateUI();
                updateShipStats();
                
                // Update upgrade costs
                document.querySelectorAll('.upgrade-option').forEach(option => {
                    const upgradeType = option.getAttribute('data-upgrade');
                    option.querySelector('.upgrade-cost').textContent = 
                        upgradeCosts[upgradeType] + 'g';
                });
            }
        };

        // Update ship stats display
        const updateShipStats = () => {
            ships.forEach((ship, index) => {
                document.getElementById(`ship${index + 1}Stats`).textContent = 
                    `DMG: ${Math.round(ship.damage)}\nSPD: ${ship.speed.toFixed(1)}`;
            });
        };

        // Update UI
        const updateUI = () => {
            // Gold
            document.getElementById('goldValue').textContent = game.gold;
            
            // Wave
            document.getElementById('waveNumber').textContent = game.wave;
            
            // Health
            const healthPercent = (game.islandHealth / game.maxIslandHealth) * 100;
            document.getElementById('healthFill').style.width = `${healthPercent}%`;
            document.getElementById('healthValue').textContent = 
                `${game.islandHealth}/${game.maxIslandHealth}`;
        };

        // Initialize the game when page loads
        window.addEventListener('DOMContentLoaded', () => {
            initEngine();
            updateUI();
            updateShipStats();
        });
    </script>
</body>
</html>